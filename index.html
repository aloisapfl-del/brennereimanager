<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Brennereimanager</title>
    <style>
        /* =====================================================
   üé® DESTILLATIONSAPP ‚Äì DESIGN: KUPFER & EDELSTAHL
   ===================================================== */

        /* === GRUNDEINSTELLUNGEN === */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: "Segoe UI", sans-serif;
            color: #2c2c2c;
            line-height: 1.6;
        }

        /* === Edelstahl-Hintergrund, ruhiger Verlauf === */
        body {
            display: flex;
            justify-content: center;
            /* horizontal zentriert */
            align-items: flex-start;
            /* oben ausgerichtet */
            background: linear-gradient(180deg, #f9f8f7 0%, #e3e1de 100%);
            background-attachment: fixed;
        }

        /* Feine ‚Äûgeb√ºrstete‚Äú Struktur */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: repeating-linear-gradient(90deg,
                    rgba(255, 255, 255, 0.04) 0px,
                    rgba(0, 0, 0, 0.03) 0.5px,
                    rgba(255, 255, 255, 0.04) 1px);
            opacity: 0.25;
            z-index: -1;
        }

        /* === ZENTRIERTER APP-CONTAINER === */
        #appContainer {
            width: 95%;
            max-width: 1100px;
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(6px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            padding: 25px 35px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
            margin: 40px auto;
        }

        /* === HEADER === */
        header {
            background: linear-gradient(180deg, #dcdcdc, #bfbfbf);
            border-bottom: 4px solid #b87333;
            text-align: center;
            padding: 20px 10px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            border-radius: 8px 8px 0 0;
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
            letter-spacing: 1px;
            color: #7a3b10;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.7);
        }

        /* === NAVIGATION === */
        #mainNav {
            background: linear-gradient(180deg, #d9d9d9, #bfbfbf 50%, #d9d9d9);
            border-bottom: 3px solid #b87333;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            padding: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        #mainNav button {
            background: linear-gradient(145deg, #b87333, #d4a373);
            color: #fff;
            border: 1px solid #8c5523;
            border-radius: 6px;
            padding: 8px 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.25);
            transition: all 0.25s ease-in-out;
        }

        #mainNav button:hover {
            background: linear-gradient(145deg, #d4a373, #b87333);
            filter: brightness(1.1);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.35);
        }

        #mainNav button.active {
            background: linear-gradient(145deg, #e0a96d, #b87333);
            border: 1px solid #9a6329;
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
        }


        #batchBarrelList {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px;
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        #batchBarrelList strong {
            color: #333;
        }

        #batchBarrelList input[type=checkbox] {
            transform: scale(0.9);
        }


        /* === TITEL & ABSCHNITTE === */
        h2,
        h3 {
            color: #8c5523;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.6);
            border-bottom: 2px solid #b87333;
            padding-bottom: 4px;
            margin-top: 25px;
        }

        /* === TABELLE & FORM === */
        table {
            border-collapse: collapse;
            width: 100%;
            background: rgba(255, 255, 255, 0.9);
            font-size: 0.9em;
        }

        td,
        th {
            border: 1px solid #bcbcbc;
            padding: 6px;
        }

        th {
            background: linear-gradient(180deg, #d1d1d1, #c2c2c2);
            color: #2c2c2c;
            text-transform: uppercase;
        }

        /* === EINGABEN === */
        input,
        select,
        textarea {
            border: 1px solid #aaa;
            border-radius: 6px;
            padding: 6px;
            width: 100%;
            background: #f9f9f9;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: #b87333;
            outline: none;
            box-shadow: 0 0 4px rgba(184, 115, 51, 0.5);
        }

        /* === KUPFER-BUTTONS === */
        button {
            background: linear-gradient(145deg, #b87333, #d4a373);
            color: #fff;
            border: 1px solid #8c5523;
            border-radius: 8px;
            padding: 8px 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25);
            transition: all 0.2s ease-in-out;
        }

        button:hover {
            background: linear-gradient(145deg, #d4a373, #b87333);
            filter: brightness(1.1);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        button.secondary {
            background: linear-gradient(145deg, #9c9c9c, #b0b0b0);
            color: #222;
            border: 1px solid #aaa;
        }

        button.small {
            padding: 4px 10px;
            font-size: 0.9em;
        }

        /* === FOOTER === */
        footer {
            margin-top: 40px;
            background: linear-gradient(180deg, #d8d8d8 0%, #bcbcbc 100%);
            border-top: 1px solid rgba(255, 255, 255, 0.6);
            color: #333;
            text-align: center;
            padding: 15px 10px;
            font-size: 0.9em;
            font-weight: 500;
            letter-spacing: 0.2px;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.15);
            border-radius: 0 0 8px 8px;
            max-width: 1100px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
            overflow: hidden;
        }

        /* Glanzeffekt im Footer */
        footer::before {
            content: "";
            position: absolute;
            top: 0;
            left: -50%;
            width: 200%;
            height: 100%;
            background: linear-gradient(120deg,
                    rgba(255, 255, 255, 0.25) 0%,
                    rgba(255, 255, 255, 0.05) 40%,
                    rgba(255, 255, 255, 0.25) 100%);
            transform: skewX(-20deg);
            opacity: 0.4;
        }

        footer:hover::before {
            opacity: 0.7;
            transition: opacity 0.4s ease;
        }

        footer .version {
            color: #b87333;
            font-weight: 600;
            margin-top: 5px;
        }


        #batchBarrelList {
            padding: 4px;
        }

        .batch-barrel-group-title {
            font-weight: bold;
            margin-top: 6px;
            margin-bottom: 2px;
            color: #444;
            font-size: 0.9em;
        }

        .batch-barrel-line {
            display: block;
            padding: 4px 2px;
            font-size: 0.9em;
            line-height: 1.2;
            cursor: pointer;
        }

        .batch-barrel-line input[type="checkbox"] {
            margin-right: 6px;
        }

        .batch-barrel-line span {
            display: inline-block;
            vertical-align: middle;
        }




        /* === FORMULAR- & AKTIONSBUTTONS SAUBER AUSRICHTEN === */

        /* Nur normale Buttons innerhalb der Seiteninhalte (nicht Navigation) */
        main button,
        #appContainer button {
            display: block;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            margin: 8px 0;
            text-align: center;
        }

        /* Einheitliche H√∂he und Schrift */
        button {
            min-height: 40px;
            font-size: 1em;
        }

        /* Navigation oben bleibt nebeneinander */
        #mainNav {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }

        #mainNav button {
            width: auto;
            /* nicht voll breit */
            display: inline-block;
            min-width: 120px;
        }

        /* === FORMULARBUTTONS: Zentriert & gleich breit === */
        #appContainer button {
            display: block;
            width: 100%;
            /* gleiche Breite f√ºr alle Buttons */
            margin: 10px auto;
            /* automatisch zentrieren */
            text-align: center;
            min-height: 42px;
            font-size: 1em;
        }

        /* üîπ Navigation bleibt unver√§ndert nebeneinander */
        #mainNav button {
            display: inline-block;
            width: auto;
            min-width: 120px;
            margin: 5px;
        }

        /* === EINHEITLICHE BREITE UND ZENTRIERUNG F√úR ALLE SEITENBEREICHE === */

        /* 1Ô∏è‚É£ Hauptinhalt & Formularfelder */
        #appContainer main,
        #appContainer section,
        #appContainer div,
        #appContainer form {
            max-width: 800px;
            /* angenehme Lesebreite */
            margin-left: auto;
            margin-right: auto;
        }

        /* 2Ô∏è‚É£ Eingabefelder */
        #appContainer input,
        #appContainer select,
        #appContainer textarea {
            display: block;
            width: 100%;
            /* etwas schmaler als der Container */
            margin: 6px auto 12px auto;
            /* zentriert */
        }

        /* 3Ô∏è‚É£ Tabellen */
        #appContainer table {
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            border-radius: 10px;
            width: 100%;
        }

        /* Tabellen√ºberschriften mittig ausrichten */
        #appContainer h3 {
            text-align: center;
        }


        /* 4Ô∏è‚É£ Kopf- & Fu√üzeile auf Containerbreite begrenzen */
        header,
        footer {
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            border-radius: 10px;
            width: 100%;
        }

        /* 5Ô∏è‚É£ Footer etwas schlanker & edler */
        footer {
            font-size: 0.9em;
            padding: 12px 20px;
            background: linear-gradient(180deg, #dcdcdc 0%, #bcbcbc 100%);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.4), 0 -2px 6px rgba(0, 0, 0, 0.15);
            border-top: 2px solid #b87333;
        }

        /* 6Ô∏è‚É£ √úberschriften leicht einger√ºckt */
        #appContainer h2,
        #appContainer h3 {
            text-align: center;
            margin-top: 55px;
            margin-bottom: 10px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
        }


        /* Zentrierte Labels */
        label {
            display: block;
            text-align: center;
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 5px;
        }

        /* üßÆ Tabellen zentrieren und Breite begrenzen */
        table {
            width: 100% !important;
            /* √ºberschreibt vorherige 100%-Regel */
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
        }

        table th {
            background: linear-gradient(180deg, #d4a373, #b87333);
            color: #fff;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* === üí∞ Auswertungsbereich (Einnahmen / Ausgaben / Bilanz) zentrieren === */
        #pageBalance,
        #pageFinance,
        #pageSales {
            text-align: center;
            /* zentriert Texte und √úberschriften */
        }

        /* Tabellen selbst zentriert und schmaler */
        #pageBalance table,
        #pageFinance table,
        #pageSales table {
            width: 100% !important;
            /* keine volle Seitenbreite */
            margin: 0 auto 25px auto;
            /* zentriert horizontal */
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            border-collapse: collapse;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Tabellen√ºberschriften (Einnahmen / Ausgaben) mittig */
        #pageBalance h3,
        #pageFinance h3,
        #pageSales h3 {
            text-align: center;
            color: #8c5523;
            /* Kupferfarbener Akzent */
            margin-top: 15px;
            margin-bottom: 10px;
        }

        /* === üéõÔ∏è Lagerhaltung: Rahmen um Beh√§lterdaten verfeinern === */
        #storageDetails,
        #storageContents {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 15px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            max-width: 100%;
            margin-left: auto;
            margin-right: auto;
            /* ‚Üí zentriert den Block in der Mitte */
        }

        /* Tabellen in der Lagerhaltung etwas schmaler */
        #storageContents table {
            width: 90%;
            margin: 0 auto;
        }

        /* Optional: √úberschrift "Inhalt des Beh√§lters" mittig */
        #storageContents h3 {
            text-align: center;
            color: #8c5523;
        }

        /* === üéØ Kopf- und Fu√üzeile perfekt zentrieren === */

        /* Kopfzeile */
        header {
            max-width: 800px;
            /* gleiche Breite wie der Inhalt */
            margin: 0 auto 20px auto;
            /* zentriert horizontal */
            text-align: center;
            /* Text zentrieren */
            background: linear-gradient(180deg, #dcdcdc, #bfbfbf);
            border-bottom: 3px solid #b87333;
            border-radius: 8px;
            padding: 20px 10px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        }

        /* Kopfzeilen-Titel sch√∂ner darstellen */
        header h1 {
            margin: 0;
            font-size: 1.8em;
            color: #7a3b10;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.7);
        }

        /* Fu√üzeile */
        footer {
            max-width: 800px;
            /* gleiche Breite wie header & Inhalt */
            margin: 30px auto 10px auto;
            /* zentriert */
            text-align: center;
            background: linear-gradient(180deg, #d8d8d8 0%, #bcbcbc 100%);
            border-top: 2px solid #b87333;
            border-radius: 8px;
            color: #333;
            padding: 12px 10px;
            font-size: 0.9em;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        /* Glanzreflex im Footer */
        footer::before {
            content: "";
            position: absolute;
            top: 0;
            left: -50%;
            width: 200%;
            height: 100%;
            background: linear-gradient(120deg,
                    rgba(255, 255, 255, 0.25) 0%,
                    rgba(255, 255, 255, 0.05) 40%,
                    rgba(255, 255, 255, 0.25) 100%);
            transform: skewX(-20deg);
            opacity: 0.4;
        }

        /* Beim Hover dezenter Glanz-Effekt */
        footer:hover::before {
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        /* === üçè APP-LOGO EINBINDUNG === */
        .app-logo {
            width: 60px;
            height: auto;
            vertical-align: middle;
            margin-right: 10px;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
        }

        header h1 {
            display: flex;
            align-items: center;
            justify-content: center;
            /* Text + Logo zentrieren */
            gap: 12px;
            font-size: 1.8em;
            color: #7a3b10;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.7);
            margin: 0;
        }

        /* === Globale Layout-Korrektur === */
        html,
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            /* verhindert horizontales Scrollen */
            width: 100%;
        }

        /* Hauptcontainer */
        #appContainer {
            max-width: 800px;
            /* begrenzt die Breite */
            width: 100%;
            /* passt sich an kleinere Ger√§te an */
            margin: 0 auto;
            /* zentriert auf Desktop */
            box-sizing: border-box;
            /* ber√ºcksichtigt Padding */
            padding: 20px;
        }

        /* Header & Footer zentrieren */
        header,
        footer {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
            box-sizing: border-box;
        }

        /* Tabellen, Eingaben, Buttons nicht breiter als Container */
        table,
        input,
        select,
        textarea,
        button {
            max-width: 100%;
            box-sizing: border-box;
        }

        /* --- Mobile Fix NUR f√ºr den Rezeptbereich --- */
        @media (max-width: 768px) {

            /* Nur der Rezept-Editor bekommt eigenes Scrollverhalten */
            #recipeEditorColumn {
                max-height: 80vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 200px;
                /* Platz f√ºr Tastatur */
            }

            /* Eingaben im Rezept-Editor sollen sichtbar bleiben */
            #recipeEditorColumn input:focus,
            #recipeEditorColumn select:focus,
            #recipeEditorColumn textarea:focus {
                scroll-margin-top: 100px;
                scroll-margin-bottom: 250px;
            }

            /* GLOBAL: Fokusverhalten NUR auf Mobil deaktivieren */
            body input:focus,
            body select:focus,
            body textarea:focus {
                scroll-margin: 0 !important;
            }
        }
    </style>

    <style>
        .autocomplete-list {
            position: absolute;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .autocomplete-list div {
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.95em;
        }

        .autocomplete-list div:hover {
            background: #eee;
        }
    </style>

    <style>
        .info-icon {
            cursor: pointer;
            margin-left: 6px;
            font-weight: bold;
            color: #444;
        }

        .metric-help {
            display: none;
            margin: 6px 0 10px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f9fafb;
            font-size: 0.85em;
            color: #333;
        }
    </style>


    <style>
        /* =========================================================
   Mobile-freundliche Tabellen
   ========================================================= */

        .table-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            /* iOS smooth scroll */
            width: 100%;
        }

        .table-scroll table {
            min-width: 600px;
            /* verhindert Zusammendr√ºcken */
            border-collapse: collapse;
        }

        /* Optional: dezenter Scroll-Hinweis auf Mobile */
        @media (max-width: 768px) {
            .table-scroll::after {
                content: "‚ÜîÔ∏è seitlich scrollen";
                display: block;
                font-size: 0.75em;
                color: #666;
                margin-top: 4px;
                text-align: right;
            }
        }
    </style>


    <style>
        /* ============================================
   MOBILE OPTIMIERUNG F√úR REZEPTSEITE
   ============================================ */
        @media (max-width: 680px) {

            /* Editor oben, Liste einklappbar */
            #recipeList {
                display: none;
            }

            #toggleRecipeListBtn {
                display: block;
                width: 100%;
                padding: 10px;
                margin-bottom: 15px;
                background: #ddd;
                border: 1px solid #aaa;
                border-radius: 6px;
                font-size: 1em;
            }

            /* Zutaten-Tabelle */
            #recipeIngredients table,
            #recipeIngredientsBody tr {
                width: 100%;
            }

            #recipeIngredientsBody td {
                padding: 4px;
                vertical-align: middle;
            }

            /* Spaltenbreiten */
            #recipeIngredientsBody td:nth-child(1) {
                /* Zutat */
                width: 65%;
            }

            #recipeIngredientsBody td:nth-child(2) {
                /* Anteil */
                width: 25%;
                text-align: right;
            }

            #recipeIngredientsBody td:nth-child(3),
            #recipeIngredientsBody td:nth-child(4) {
                /* Aktion */
                width: 10%;
                text-align: center;
            }

            /* Input-Felder gr√∂√üer */
            #recipeIngredientsBody input[type="number"],
            #recipeIngredientsBody input[type="text"],
            #recipeIngredientsBody select {
                font-size: 1.1em;
                padding: 6px;
            }

            /* Buttons 100% Breite */
            #recipeEditor button {
                width: 100%;
                margin-top: 6px;
            }

            /* Karten optisch kompakter */
            #recipeEditor.card,
            #recipeList.card {
                padding: 12px;
            }
        }
    </style>


    <style>
        .accordion-group {
            border-bottom: 1px solid #ddd;
            margin-bottom: 6px;
        }

        .accordion-header {
            cursor: pointer;
            padding: 6px 4px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .accordion-header:hover {
            background: #f6f6f6;
        }

        .accordion-content {
            display: none;
            padding-left: 8px;
        }
    </style>

    <style>
        .liq-pair {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px 14px;
            align-items: end;
        }

        .liq-pair label {
            font-weight: 600;
        }

        .liq-pair input {
            width: 100%;
        }
    </style>



    <style>
        #materialEditModal {
            position: fixed;
            inset: 0;
            display: none;
            background: rgba(0, 0, 0, .4);
            backdrop-filter: blur(3px);
        }

        #materialEditBox {
            all: unset;
            position: fixed;
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            z-index: 10000;
        }
    </style>



</head>


<body>
    <div id="appContainer">
        <header>
            <h1>
                Brennereimanager
            </h1>
            <p>Tradition & Pr√§zision ‚Äì digital vereint</p>
        </header>


        <nav>
            <button onclick="showPage('sellerProfile')">üè∑Ô∏è Verk√§ufer</button>
            <button onclick="showPage('customers')">üë• Kunden</button>
            <button data-page="theory" onclick="showPage('theory')">üìê Theoretische Ausbeute und Steuer</button>
            <button data-page="correction" onclick="showPage('correction')">üå°Ô∏è Alkoholkorrektur</button>
            <button data-page="practice" onclick="showPage('practice')">üç∏ Tats√§chliche
                Destillatwerte/Wasserzugabe</button>
            <button data-page="barrels" onclick="showPage('barrels')">üõ¢Ô∏è Maischef√§sser und G√§rprotokolle</button>
            <button data-page="calc" onclick="showPage('calc')">üìä Fass-Kalkulation</button>
            <button data-page="batchCalc" onclick="showPage('batchCalc')">‚öóÔ∏è Chargen-Kalkulation</button>
            <!--<button data-page="barrelCalc" onclick="showPage('barrelCalc')">üßÆ Maischevolumen errechnen</button> -->
            <button data-page="archive" onclick="showPage('archive')">üì¶ Archiv</button>
            <button data-page="storage" onclick="showPage('storage')">üè∫ Lagerverwaltung</button>
            <button data-page="recipes" onclick="showPage('recipes')">üß™ Rezepte / Mischungen</button>
            <button data-page="liqueur" onclick="showPage('liqueur')">üçí Lik√∂rberechnung</button>
            <button onclick="showPage('production')">üåø Aroma- & Kr√§uterproduktion</button>
            <button onclick="showPage('batches')">üç∫Getreide- & Malzmaischen (Whisky | Korn)</button>
            <button onclick="showPage('runSheets')">üìÑ Laufzettel</button>
            <button onclick="showPage('casks')">üõ¢ Reifef√§sser</button>
            <button data-page="sales" onclick="showPage('sales')">üí∂ Abf√ºllung</button>
            <button onclick="showPage('bottlings')" class="menuButton">üçæ Flaschenlager</button>
            <button data-page="sellBottlings" onclick="showPage('sellBottlings')">üõí Verkauf (Kasse)</button>
            <button onclick="showPage('salesList')">üì¶ Verk√§ufe (Archiv)</button>
            <button onclick="showPage('invoices')">üßæ Rechnungen</button>
            <button onclick="showPage('expenses')">üìâ Ausgaben</button>
            <button onclick="showPage('finance')">üìä Finanz√ºbersicht</button>
            <button onclick="showPage('vatOverview')">üìä Umsatzsteuer</button>
            <button onclick="showPage('profitAnalysis')">üìä Gewinn-Analyse</button>
            <button onclick="showPage('legal')"> ‚Ñπ Rechtliches</button>
            <button onclick="showPage('manual')">üìò Bedienungsanleitung</button>

        </nav>


        <main>
            <!-- ===== Seite 1: Theorie ===== -->
            <div id="pageTheory" style="display:none;">
                <label>Rohstofftyp:</label>
                <select id="type" onchange="updateFruits()"></select>

                <label>Rohstoff:</label>
                <select id="fruit"></select>

                <label id="amountLabel">Maischemenge (Liter oder kg):</label>
                <input type="number" id="amount" placeholder="z. B. 30" oninput="calculateExpectedAlcoholTheory()">

                <div id="oechsleRow">
                    <label>Mostgewicht (¬∞Oechsle):</label>
                    <input type="number" id="theoryOechsle" placeholder="z. B. 85"
                        oninput="calculateExpectedAlcoholTheory()">
                </div>


                <div id="expectedAlcoholOutput" style="
                        margin-top:10px;
                        padding:10px;
                        background:#fff8f0;
                        border:1px solid #d9a066;
                        border-radius:8px;
                        display:none;">
                </div>

                <label>Gew√ºnschte Trinkst√§rke (% Vol):</label>
                <input type="number" id="strength" placeholder="z. B. 38">

                <button onclick="calculate()">Berechnen</button>
                <div class="result" id="output" style="overflow-x:auto; width:100%;"></div>


                <div id="comparisonOutput" style="
                    margin-top:15px;
                    padding:12px;
                    background:#f4f9ff;
                    border:1px solid #4682b4;
                    border-radius:8px;
                    display:none;">
                </div>
            </div>


            <!-- ===== Seite 2: Praxis ===== -->
            <div id="pagePractice" style="display:none;">
                <label>Destillatmenge vor Verd√ºnnung (Liter):</label>
                <input type="number" id="diluteVolume" placeholder="z. B. 5.2">

                <label>Alkoholgehalt vor Verd√ºnnung (% Vol):</label>
                <input type="number" id="diluteStrength" placeholder="z. B. 65">

                <label>Gew√ºnschte Trinkst√§rke (% Vol):</label>
                <input type="number" id="diluteTarget" placeholder="z. B. 38">

                <button onclick="calculateDilution()">Wasserzugabe berechnen</button>
                <div class="practical" id="dilutionOutput"></div>
            </div>




            <!-- ===== Seite 3: Fassverwaltung ===== -->
            <div id="pageBarrels" style="display:none;">

                <label>Gespeicherte Maischef√§sser:</label>
                <select id="barrelSelectDropdown" onchange="selectBarrelFromDropdown()">
                    <option value="">‚Äî Fass w√§hlen ‚Äî</option>
                </select>

                <h3>üõ¢Ô∏è Fassverwaltung</h3>
                <p class="muted">
                    Hier kannst du neue Maischef√§sser anlegen oder vorhandene bearbeiten.
                    Klicke auf <strong>‚ÄûNeues Fass anlegen‚Äú</strong>, um die Felder zu leeren,
                    gib dann die Daten ein und speichere mit <strong>‚ÄûFass speichern‚Äú</strong>.
                </p>

                <hr>

                <button class="secondary small" onclick="resetBarrelForm()">‚ûï Neues Fass anlegen</button>


                <div style="display:flex; gap:10px; align-items:flex-end;">
                    <div>
                        <label>Maischefassnummer:</label>
                        <input type="text" id="barrelNumber" placeholder="z. B. A23 oder 12" oninput="loadBarrelData()">
                    </div>
                    <div>

                        <label>Maischeart:</label>
                        <select id="barrelFruit"></select>
                    </div>
                </div>

                <div style="display:flex; gap:10px; align-items:flex-end;">
                    <div>
                        <label>Einmaischdatum:</label>
                        <input type="date" id="barrelStart">
                    </div>
                    <div>
                        <label>G√§rdauer (Tage):</label>
                        <input type="number" id="barrelDays" placeholder="z. B. 12">
                    </div>
                </div>

                <button onclick="saveBarrel()">Speichern</button>

                <hr>
                <h3>üìä Fassdaten (zus√§tzlich)</h3>
                <div style="display:flex; gap:10px; align-items:flex-end;">
                    <div>
                        <label>Maischemenge (Liter) ‚Äî direkte Eingabe:</label>
                        <input type="number" id="barrelVolumeFixed" placeholder="z. B. 30"
                            oninput="calculateExpectedAlcohol()">
                    </div>
                    <div>
                        <label>Oechsle (¬∞Oe):</label>
                        <input type="number" id="barrelOechsle" placeholder="z. B. 85"
                            oninput="calculateExpectedAlcohol()">
                    </div>
                </div>

                <!-- üîΩ Ausgabe UNTERHALB der Flexbox -->
                <div id="barrelExpectedAlcoholOutputWrapper" style="flex:1; min-width:180px; margin-top:8px;">
                    <div id="barrelExpectedAlcoholOutput" style="padding:8px; background:#eef7ff; border:1px solid #bcd; border-radius:6px;
                                font-size:0.9em; color:#000; min-height:80px;">
                    </div>
                </div>



                <!-- ==============================
                    üî• GEMESSENE ROHDATEN
                    ============================== -->
                <h3>Brenndaten</h3>
                <div style="display:flex; gap:10px; align-items:flex-end;">
                    <div>
                        <label>Brenndatum:</label>
                        <input type="date" id="barrelBurnDate">
                    </div>
                    <div>
                        <label>Brand-Nr.:</label>
                        <input type="number" id="barrelBurnNumber" style="width:70px;" placeholder="1" min="1">
                    </div>
                    <div>
                        <label>Brenndauer (Stunden):</label>
                        <input type="number" id="barrelBurnTime" step="0.1" placeholder="z. B. 3.5">
                    </div>
                </div>
                <hr style="margin:15px 0;">

                <h3>Gemessene Werte</h3>
                <div style="display:flex; gap:10px; align-items:flex-end;">
                    <div>
                        <label>Gemessene Destillatmenge (L):</label>
                        <input id="measuredVolume" type="number" step="0.01" oninput="autoCorrectMeasuredValues()">
                    </div>
                    <div>
                        <label>Gemessene Alkoholst√§rke (%vol):</label>
                        <input id="measuredStrength" type="number" step="0.1" oninput="autoCorrectMeasuredValues()">
                    </div>
                    <div>
                        <label>Gemessene Temperatur (¬∞C):</label>
                        <input id="measuredTemp" type="number" step="0.1" oninput="autoCorrectMeasuredValues()">
                    </div>
                </div>
                <hr style="margin:15px 0;">

                <h2>Korrigierte Werte</h2>
                <div style="display:flex; gap:10px; align-items:flex-end;">
                    <div>
                        <label>Korrigierte Destillatmenge (L @ 20 ¬∞C):</label>
                        <input type="number" id="barrelActualAlcohol" placeholder="z. B. 4.2">
                    </div>
                    <div>
                        <label>Korrigierte Destillatst√§rke (%vol @ 20 ¬∞C):</label>
                        <input type="number" id="barrelActualStrength" placeholder="z. B. 42">
                    </div>
                </div>
                <button onclick="saveBarrel()">Alle Daten speichern</button>
                <hr>


                <div class="barrel" id="barrelList"></div>

                <div id="barrelDetails" style="display:none;" class="barrel">
                    <h4>üìñ G√§rprotokoll f√ºr <span id="detailFassName"></span></h4>

                    <label>Datum des Eintrags:</label>
                    <input type="date" id="entryDate">

                    <label>G√§rstatus:</label>
                    <select id="fermentationStatus">
                        <option value="aktiv">Aktiv</option>
                        <option value="nicht gestartet">Nicht gestartet</option>
                        <option value="abgeklungen">Abgeklungen</option>
                        <option value="gestoppt">Gestoppt</option>
                    </select>

                    <label>Temperaturverlauf:</label>
                    <textarea id="temperatureLog" rows="2"></textarea>

                    <label>pH-Wert Verlauf:</label>
                    <textarea id="phLog" rows="2"></textarea>

                    <label>Geruch / Beobachtung:</label>
                    <textarea id="observationLog" rows="2"></textarea>

                    <label>Notizen:</label>
                    <textarea id="noteLog" rows="3"></textarea>

                    <button onclick="saveProtocolEntry()">‚ûï Neuen Eintrag speichern</button>

                    <h4>Laufende Eintr√§ge:</h4>
                    <div id="protocolEntries"></div>
                </div>

                <h4>üìÇ Backup</h4>
                <button class="backup-btn" onclick="exportBackup()">üíæ Backup exportieren (Datei)</button>
                <input type="file" id="importFile" style="margin-top:10px;" onchange="importBackup(event)">
                <button class="backup-btn" onclick="exportBackupAsText()">üìã Backup als Text anzeigen</button>
            </div>

            <!-- ===================== -->
            <!-- üì¶ Archiv-Seite -->
            <!-- ===================== -->
            <div id="pageArchive" style="display:none;">
                <h3>üì¶ Archivierte Maischef√§sser</h3>
                <p>Hier findest du alle archivierten Maischef√§sser mit Protokollen.</p>

                <div class="table-scroll">
                    <div id="archiveList"></div>
                </div>
            </div>




            <!-- ===== Seite 4: Fass-Kalkulation ===== -->
            <div id="pageCalc" style="display:none;">
                <h3>üìä Fass-Kalkulation</h3>
                <div id="barrelStorageCheckBox" style="display:none;
                    background:#f5f9ff;
                    border:1px solid #cfe2ff;
                    border-radius:10px;
                    padding:12px;
                    margin-bottom:12px;
                    font-size:0.95em;
                    line-height:1.5;">

                    <strong>‚ÑπÔ∏è Lagerhinweis</strong><br>
                    Damit dieses Produkt sp√§ter eingelagert werden kann,
                    wird ein geeigneter Lagerbeh√§lter ben√∂tigt.<br><br>

                    <strong>Ist bereits ein passender Beh√§lter angelegt?</strong><br><br>

                    <button onclick="confirmStorageCheck(true)">Ja ‚Äì weiter zur Kalkulation</button>
                    <button onclick="confirmStorageCheck(false)">Nein ‚Äì Lagerbeh√§lter anlegen</button>
                </div>


                <label>Fass ausw√§hlen:</label>
                <select id="calcBarrelSelect" onchange="loadCalcFromBarrel()"></select>
                <div class="barrel" id="calcBarrelInfo"></div>

                <h4>üßÆ Basisdaten & Verd√ºnnung</h4>
                <label>Ziel-Trinkst√§rke (% Vol):</label>
                <input type="number" id="calcTargetAbv" value="40" oninput="calculateCalc()">
                <div class="result" id="calcDilutionResult"></div>

                <!-- üíß Tats√§chliche Ausbringung (optional) -->
                <h4>üíß Tats√§chliche Ausbringung (muss beim Maischefass hinterlegt sein)</h4>
                <label>Tats√§chliche Destillatmenge (L):</label>
                <input type="number" id="calcActualVolumeL" placeholder="z. B. 8.0" oninput="calculateCalc()">
                <label>Tats√§chliche Destillatst√§rke (% Vol):</label>
                <input type="number" id="calcActualAbv" placeholder="z. B. 65" oninput="calculateCalc()">
                <div class="barrel subtle" id="calcActualYieldResult"></div>
                <div class="practical" id="calcActualBottleResult"></div>

                <h4>üçè Rohstoffkosten</h4>
                <label>Dichte der Maische (kg/L):</label>
                <input type="number" id="calcDensity" step="0.01" value="1.0" oninput="calculateCalc()">
                <label>Rohstoffpreis (‚Ç¨/kg):</label>
                <input type="number" id="calcRawPricePerKg" step="0.01" value="2.00" oninput="calculateCalc()">
                <div class="barrel" id="calcRawCostResult"></div>

                <h4>‚ö° Energie & üë∑ Arbeit</h4>
                <label>Brenndauer (Stunden):</label>
                <input type="number" id="calcHours" step="0.1" value="3.5" oninput="calculateCalc()">
                <label>Leistungsaufnahme (kW):</label>
                <input type="number" id="calcPowerKw" step="0.1" value="16.0" oninput="calculateCalc()">
                <label>Strompreis (‚Ç¨/kWh):</label>
                <input type="number" id="calcPriceKwh" step="0.01" value="0.35" oninput="calculateCalc()">
                <label>Arbeitszeit (Stunden):</label>
                <input type="number" id="calcLaborHours" step="0.1" value="14" oninput="calculateCalc()">
                <label>Stundenlohn (‚Ç¨/h):</label>
                <input type="number" id="calcLaborRate" step="0.5" value="20" oninput="calculateCalc()">
                <div class="barrel" id="calcEnergyLaborResult"></div>

                <h4>üè≠ Fixkosten (Destille/Anteil)</h4>
                <label>Anschaffungspreis Destille (‚Ç¨):</label>
                <input type="number" id="calcStillPrice" step="10" value="15500" oninput="calculateCalc()">
                <label>Nutzungsdauer (Jahre):</label>
                <input type="number" id="calcStillYears" value="10" oninput="calculateCalc()">
                <label>Br√§nde pro Jahr:</label>
                <input type="number" id="calcBatchesPerYear" value="20" oninput="calculateCalc()">
                <div class="barrel" id="calcFixedCostResult"></div>

                <h4>üçæ Flaschen (Einkauf & Verkauf)</h4>
                <div class="entry">
                    <strong>0,5 L</strong>
                    <label>Einkaufspreis / Flasche (‚Ç¨):</label>
                    <input type="number" id="calcBottle05Cost" step="0.01" value="0.60" oninput="calculateCalc()">
                    <label>Verkaufspreis / Flasche (‚Ç¨):</label>
                    <input type="number" id="calcBottle05Price" step="0.10" value="27.00" oninput="calculateCalc()">
                    <div id="literPrice05" class="small-inline"></div>
                </div>
                <div class="entry">
                    <strong>0,7 L</strong>
                    <label>Einkaufspreis / Flasche (‚Ç¨):</label>
                    <input type="number" id="calcBottle07Cost" step="0.01" value="0.70" oninput="calculateCalc()">
                    <label>Verkaufspreis / Flasche (‚Ç¨):</label>
                    <input type="number" id="calcBottle07Price" step="0.10" value="35.00" oninput="calculateCalc()">
                    <div id="literPrice07" class="small-inline"></div>
                </div>
                <div class="entry">
                    <strong>1,0 L</strong>
                    <label>Einkaufspreis / Flasche (‚Ç¨):</label>
                    <input type="number" id="calcBottle10Cost" step="0.01" value="0.80" oninput="calculateCalc()">
                    <label>Verkaufspreis / Flasche (‚Ç¨):</label>
                    <input type="number" id="calcBottle10Price" step="0.10" value="48.00" oninput="calculateCalc()">
                    <div id="literPrice10" class="small-inline"></div>
                </div>

                <h4>üì¶ Verpackung / Verschl√ºsse / Etiketten / Versand (‚Ç¨/Flasche, einheitlich)</h4>
                <label>Verpackungskosten (‚Ç¨ / Fl.):</label>
                <input type="number" id="calcPackaging" step="0.01" value="0.40" oninput="calculateCalc()">
                <label>Verschlusskosten (‚Ç¨ / Fl.):</label>
                <input type="number" id="calcClosures" step="0.01" value="0.30" oninput="calculateCalc()">
                <label>Etikettenkosten (‚Ç¨ / Fl.):</label>
                <input type="number" id="calcLabels" step="0.01" value="0.20" oninput="calculateCalc()">
                <label>Versandkosten (‚Ç¨ / Fl.):</label>
                <input type="number" id="calcShipping" step="0.01" value="0.00" oninput="calculateCalc()">

                <h4>üí∞ Alkoholsteuer</h4>
                <label>Steuersatz (‚Ç¨/L AA):</label>
                <input type="number" id="calcTaxRate" step="0.01" value="10.22" oninput="calculateCalc()"
                    style="max-width:180px;">
                <div id="calcTaxResult"></div>


                <h4>üì¶/üçæ Flaschenkalkulation (0,5 L als Beispiel)</h4>
                <div class="practical" id="calcBottlesResult"></div>

                <h4>üìà Ergebnis</h4>
                <div class="result" id="calcSummary"></div>


                <hr>
                <div style="font-size:0.85em; color:#555;">
                    <strong>‚ÑπÔ∏è Hinweis zur Flaschenpreis-Logik</strong><br>
                    Die <strong>1,0&nbsp;L-Flasche</strong> sollte als Basis dienen (meist niedrigster ‚Ç¨‚Äâ/‚ÄâL).<br>
                    <strong>0,7&nbsp;L</strong> und <strong>0,5&nbsp;L</strong> m√ºssen pro Liter teurer sein,
                    da Verpackung, Steuer und Handling pro Liter h√∂her ausfallen.<br>
                    Ein negativer Wert bei 0,5&nbsp;L bedeutet daher oft:<br>
                    <em>Die kleinere Flasche ist g√ºnstiger kalkuliert als die gr√∂√üere.</em>
                </div>



                <!-- Ober-Button -->
                <button id="barrelShowProductOptions" onclick="toggleBarrelProductOptions()" style="margin-right:10px;">
                    üíæ Produkt speichern
                </button>

                <!-- Unter-Optionen (anfangs versteckt) -->
                <div id="barrelProductOptions" style="display:none; margin-top:10px;">

                    <div id="barrelProductInfo" style="font-size:0.9em; margin-bottom:10px; color:#666;">
                        <!-- Wird per JS gef√ºllt -->
                    </div>

                    <button onclick="saveBarrelAsProduct('raw')" style="width:100%; margin-bottom:10px;">
                        üî• Unverd√ºnnt speichern
                    </button>

                    <button onclick="saveBarrelAsProduct('diluted')" style="width:100%; margin-bottom:10px;">
                        üíß Verd√ºnnt speichern
                    </button>

                </div>


                <button onclick="openBarrelStorageDialog()">‚û°Ô∏è Direkt ins Lager einbuchen</button>
            </div>


            <!-- Dialog: Fass direkt ins Lager einbuchen -->
            <div id="barrelStorageDialog" class="dialog" style="display:none;">
                <div class="dialog-content">
                    <h3>Fass ins Lager einbuchen</h3>

                    <div id="barrelStorageInfo" style="margin-bottom:15px; font-size:0.9em;">
                        <!-- Wird per JS automatisch gef√ºllt -->
                    </div>

                    <label for="barrelStorageSelect">Lagerbeh√§lter:</label>
                    <select id="barrelStorageSelect" style="width:100%; margin-bottom:15px;">
                        <option value="">‚Äî Beh√§lter w√§hlen ‚Äî</option>
                    </select>

                    <button onclick="saveBarrelToStorage('raw')" style="width:100%; margin-bottom:10px;">
                        üî• Unverd√ºnnt einlagern
                    </button>

                    <button onclick="saveBarrelToStorage('diluted')" style="width:100%; margin-bottom:10px;">
                        üíß Verd√ºnnt einlagern
                    </button>

                    <button onclick="closeBarrelStorageDialog()" style="width:100%; background:#ccc;">
                        Abbrechen
                    </button>
                </div>
            </div>















            <!-- ===== Seite 5: ‚öóÔ∏è Chargen-Kalkulation ===== -->
            <div id="pageBatchCalc" style="display:none;">
                <h3>‚öóÔ∏è Chargen-Kalkulation</h3>
                <div id="batchStorageCheckBox" style="display:none;
                    background:#f5f9ff;
                    border:1px solid #cfe2ff;
                    border-radius:10px;
                    padding:12px;
                    margin-bottom:12px;
                    font-size:0.95em;
                    line-height:1.5;">

                    <strong>‚ÑπÔ∏è Lagerhinweis</strong><br>
                    Damit dieses Produkt sp√§ter eingelagert werden kann,
                    wird ein geeigneter Lagerbeh√§lter ben√∂tigt.<br><br>

                    <strong>Ist bereits ein passender Beh√§lter angelegt?</strong><br><br>

                    <button onclick="confirmStorageCheck(true)">Ja ‚Äì weiter zur Kalkulation</button>
                    <button onclick="confirmStorageCheck(false)">Nein ‚Äì Lagerbeh√§lter anlegen</button>
                </div>


                <h4>üõ¢Ô∏è F√§sser f√ºr die Charge ausw√§hlen</h4>
                <div id="batchBarrelList" class="barrel-list"></div>
                <div class="muted">Hinweis: Es k√∂nnen reale und archivierte F√§sser kombiniert werden.</div>
                <hr>

                <h4>üîÅ Berechnungsmodus</h4>
                <div class="inline">
                    <label><input type="radio" name="batchMode" value="yield" checked onchange="renderBatchMode()">
                        Nach
                        Ausbeutesatz</label>
                    <label><input type="radio" name="batchMode" value="measured" onchange="renderBatchMode()"> Nach
                        gemessenem
                        Reinalkohol</label>
                </div>

                <div id="batchModeYieldBox">
                    <h4>ü•£ Eingaben (Ausbeutesatz)</h4>
                    <label>Rohstoff:</label>
                    <select id="batchFruit"></select>
                    <div class="muted">Hinweis: F√ºr kg-basierte Rohstoffe (z. B. Getreide) ist ohne kg‚ÜíL-Umrechnung
                        keine
                        saubere
                        Steuerberechnung m√∂glich.</div>

                    <label>Maischemenge (Liter):</label>
                    <input type="number" id="batchMashLiters" placeholder="z. B. 100" oninput="calculateBatchCalc()">
                </div>

                <div id="batchModeMeasuredBox" style="display:none;">
                    <h4>üß™ Eingaben (gemessen)</h4>
                    <label>Reinalkohol (L, 100 % vol):</label>
                    <input type="number" id="batchPureAlcohol" placeholder="z. B. 7.5" oninput="calculateBatchCalc()">
                    <div class="muted">Hinweis: Steuer wird in diesem Modus auf Basis des gemessenen Reinalkohols
                        berechnet,
                        sofern
                        keine ‚ÄûTats√§chliche Ausbringung‚Äú eingetragen ist.</div>
                </div>

                <h4>üéØ Ziel</h4>
                <label>Ziel-Trinkst√§rke (% Vol):</label>
                <input type="number" id="batchTargetAbv" value="40" oninput="calculateBatchCalc()">
                <div class="result" id="batchDilutionResult"></div>
                <div class="practical" id="batchDilutionPlanned"></div>


                <!-- üíß Tats√§chliche Ausbringung (erforderliche Eingabe) -->
                <h4>üíß Tats√§chliche Ausbringung (bitte messen und eingeben)</h4>
                <label>Tats√§chliche Destillatmenge (L):</label>
                <input type="number" id="batchActualVolumeL" placeholder="z. B. 8.0" oninput="calculateBatchCalc()">
                <label>Tats√§chliche Destillatst√§rke (% Vol):</label>
                <input type="number" id="batchActualAbv" placeholder="z. B. 65" oninput="calculateBatchCalc()">
                <div class="barrel subtle" id="batchActualYieldResult"></div>
                <div class="practical" id="batchActualBottleResult"></div>

                <h4>üçè Rohstoffkosten</h4>
                <label>Dichte der Maische (kg/L):</label>
                <input type="number" id="batchDensity" step="0.01" value="1.0" oninput="calculateBatchCalc()">
                <label>Rohstoffpreis (‚Ç¨/kg):</label>
                <input type="number" id="batchRawPricePerKg" step="0.01" value="2.00" oninput="calculateBatchCalc()">
                <div class="barrel" id="batchRawCostResult"></div>

                <h4>‚ö° Energie & üë∑ Arbeit</h4>
                <label>Brenndauer (Stunden):</label>
                <input type="number" id="batchHours" step="0.1" value="3.5"
                    oninput="isBatchHoursUserModified = true; calculateBatchCalc();">
                <label>Leistungsaufnahme (kW):</label>
                <input type="number" id="batchPowerKw" step="0.1" value="16.0" oninput="calculateBatchCalc()">
                <label>Strompreis (‚Ç¨/kWh):</label>
                <input type="number" id="batchPriceKwh" step="0.01" value="0.35" oninput="calculateBatchCalc()">
                <label>Arbeitszeit (Stunden):</label>
                <input type="number" id="batchLaborHours" step="0.1" value="14" oninput="calculateBatchCalc()">
                <label>Stundenlohn (‚Ç¨/h):</label>
                <input type="number" id="batchLaborRate" step="0.5" value="20" oninput="calculateBatchCalc()">
                <div class="barrel" id="batchEnergyLaborResult"></div>

                <h4>üè≠ Fixkosten (Destille/Anteil)</h4>
                <label>Anschaffungspreis Destille (‚Ç¨):</label>
                <input type="number" id="batchStillPrice" step="10" value="15500" oninput="calculateBatchCalc()">
                <label>Nutzungsdauer (Jahre):</label>
                <input type="number" id="batchStillYears" value="10" oninput="calculateBatchCalc()">
                <label>Br√§nde pro Jahr:</label>
                <input type="number" id="batchBatchesPerYear" value="20" oninput="calculateBatchCalc()">
                <div class="barrel" id="batchFixedCostResult"></div>

                <h4>üçæ Flaschen (Einkauf & Verkauf)</h4>
                <div class="entry">
                    <strong>0,5 L</strong>
                    <label>Einkaufspreis / Flasche (‚Ç¨):</label>
                    <input type="number" id="batchBottle05Cost" step="0.01" value="0.60" oninput="calculateBatchCalc()">
                    <label>Verkaufspreis / Flasche (‚Ç¨):</label>
                    <input type="number" id="batchBottle05Price" step="0.10" value="27.00"
                        oninput="calculateBatchCalc()">
                    <div id="batchLiterPrice05" class="small-inline"></div>
                </div>
                <div class="entry">
                    <strong>0,7 L</strong>
                    <label>Einkaufspreis / Flasche (‚Ç¨):</label>
                    <input type="number" id="batchBottle07Cost" step="0.01" value="0.70" oninput="calculateBatchCalc()">
                    <label>Verkaufspreis / Flasche (‚Ç¨):</label>
                    <input type="number" id="batchBottle07Price" step="0.10" value="35.00"
                        oninput="calculateBatchCalc()">
                    <div id="batchLiterPrice07" class="small-inline"></div>
                </div>
                <div class="entry">
                    <strong>1,0 L</strong>
                    <label>Einkaufspreis / Flasche (‚Ç¨):</label>
                    <input type="number" id="batchBottle10Cost" step="0.01" value="0.80" oninput="calculateBatchCalc()">
                    <label>Verkaufspreis / Flasche (‚Ç¨):</label>
                    <input type="number" id="batchBottle10Price" step="0.10" value="48.00"
                        oninput="calculateBatchCalc()">
                    <div id="batchLiterPrice10" class="small-inline"></div>
                </div>

                <h4>üì¶ Verpackung / Verschl√ºsse / Etiketten / Versand (‚Ç¨/Flasche, einheitlich)</h4>
                <label>Verpackungskosten (‚Ç¨ / Fl.):</label>
                <input type="number" id="batchPackaging" step="0.01" value="0.40" oninput="calculateBatchCalc()">
                <label>Verschlusskosten (‚Ç¨ / Fl.):</label>
                <input type="number" id="batchClosures" step="0.01" value="0.30" oninput="calculateBatchCalc()">
                <label>Etikettenkosten (‚Ç¨ / Fl.):</label>
                <input type="number" id="batchLabels" step="0.01" value="0.20" oninput="calculateBatchCalc()">
                <label>Versandkosten (‚Ç¨ / Fl.):</label>
                <input type="number" id="batchShipping" step="0.01" value="0.00" oninput="calculateBatchCalc()">

                <h4>üí∞ Alkoholsteuer (Branntweinsteuer)</h4>
                <div class="inline">
                    <label>Steuersatz (‚Ç¨/L AA):</label>
                    <input type="number" id="batchTaxRate" step="0.01" value="10.22" oninput="calculateBatchCalc()"
                        style="max-width:180px;">
                    <div id="batchTaxResult" class="barrel"></div>
                </div>
                <div class="practical" id="batchTaxResult"></div>

                <h4>üì¶/üçæ Flaschenkalkulation (0,5 L als Beispiel)</h4>
                <div class="practical" id="batchBottlesResult"></div>

                <h4>üìà Ergebnis</h4>
                <div class="result" id="batchSummary"></div>


                <div id="batchPricingHint"
                    style="margin-top:8px; font-size:0.9em; color:#555; background:#f8f8f8; padding:6px; border-radius:6px;">
                </div>





                <div style="margin-top:20px; margin-bottom:20px;">

                    <!-- Ober-Button -->
                    <button id="batchShowProductOptions" onclick="toggleBatchProductOptions()"
                        style="margin-right:10px;">
                        üíæ Charge als Produkt speichern
                    </button>

                    <!-- Unter-Buttons (zun√§chst versteckt) -->
                    <div id="batchProductOptions" style="display:none; margin-top:10px;">

                        <div id="batchProductInfo" style="font-size:0.9em; margin-bottom:10px; color:#666;">
                            <!-- Wird per JS gef√ºllt -->
                        </div>

                        <button onclick="saveBatchAsProduct('raw')" style="width:100%; margin-bottom:10px;">
                            üî• Unverd√ºnnt speichern
                        </button>

                        <button onclick="saveBatchAsProduct('diluted')" style="width:100%; margin-bottom:10px;">
                            üíß Verd√ºnnt speichern
                        </button>

                    </div>

                    <button id="batchStoreRawBtn" onclick="openBatchStorageDialog('raw')" style="margin-right:10px;">
                        üî• Unverd√ºnnt direkt ins Lager
                    </button>

                    <button id="batchStoreDilutedBtn" onclick="openBatchStorageDialog('diluted')">
                        üíß Verd√ºnnt direkt ins Lager
                    </button>

                </div>


                <!-- Platzhalter f√ºr den Lagerdialog -->
                <div id="batchStorageDialog" class="dialog" style="display:none;">
                    <div class="dialog-content">
                        <h3>Charge ins Lager einbuchen</h3>

                        <div id="batchStorageInfo" style="margin-bottom:12px; font-size:0.9em;"></div>

                        <label>Ziel-Lagerbeh√§lter:</label>
                        <select id="batchStorageSelect" style="width:100%; margin-bottom:12px;">
                            <option value="">‚Äî Beh√§lter w√§hlen ‚Äî</option>
                        </select>

                        <button onclick="saveBatchToStorage()" style="width:100%; margin-bottom:10px;">
                            ‚û°Ô∏è Einlagern
                        </button>

                        <button onclick="closeBatchStorageDialog()" style="width:100%; background:#ccc;">
                            Abbrechen
                        </button>
                    </div>
                </div>





            </div>





            <!-- Seite 6: Lik√∂rrechner (NEU, zus√§tzlich) -->
            <div id="pageLiqueur" style="display:none;">
                <h3>üçí Lik√∂rrechner</h3>

                <div id="storageCheckBox" style="display:none;
                        background:#f5f9ff;
                        border:1px solid #cfe2ff;
                        border-radius:10px;
                        padding:12px;
                        margin-bottom:12px;
                        font-size:0.95em;
                        line-height:1.5;">

                    <strong>‚ÑπÔ∏è Lagerhinweis</strong><br>
                    Damit dieses Produkt sp√§ter eingelagert werden kann,
                    wird ein geeigneter Lagerbeh√§lter ben√∂tigt.<br><br>

                    <strong>Ist bereits ein passender Beh√§lter angelegt?</strong><br><br>

                    <button onclick="confirmStorageCheck(true)">Ja ‚Äì weiter zur Kalkulation</button>
                    <button onclick="confirmStorageCheck(false)">Nein ‚Äì Lagerbeh√§lter anlegen</button>

                </div>


                <div class="liq-row two">
                    <div>
                        <label>L√∂sungsmodus:</label>
                        <select id="liqSolveMode" oninput="liqr_calc()">
                            <option value="auto">Automatik (Wasser + Zucker)</option>
                            <option value="water">Nur Wasser (treffe Ziel-%Vol)</option>
                            <option value="sugar">Nur Zucker (treffe Ziel g/L)</option>
                            <option value="juice">Nur Saft (treffe Ziel-%Vol)</option>
                            <option value="alcohol">Nur Alkohol (treffe Ziel-%Vol)</option>
                        </select>
                    </div>
                </div>

                <div
                    style="background:#f8fbff;border:1px solid #cfe2ff;border-radius:8px;padding:12px;margin-top:10px;font-size:0.95em;line-height:1.5;">
                    <strong>‚ÑπÔ∏è Hinweis zum L√∂sungsmodus:</strong><br>
                    Dieser Rechner kann Alkohol, Wasser, Saft und Zucker so berechnen,
                    dass Ihr gew√ºnschter Lik√∂r genau die Zielwerte erreicht.
                    W√§hlen Sie bitte, <strong>welche Gr√∂√üe automatisch berechnet werden soll</strong>:

                    <ul style="margin-top:8px;">
                        <li><strong>Automatik (Wasser + Zucker)</strong> ‚Äì beide Zielwerte werden erf√ºllt.
                            Alkohol- und Saftmenge bleiben unver√§ndert.</li>

                        <li><strong>Nur Wasser (treffe Ziel-%Vol)</strong> ‚Äì
                            nur die Wassermenge wird so berechnet, dass die Alkoholst√§rke stimmt.</li>

                        <li><strong>Nur Zucker (treffe Ziel-g/L)</strong> ‚Äì
                            nur die Zuckermenge wird so berechnet, dass der gew√ºnschte Zuckergehalt erreicht wird.
                        </li>

                        <li><strong>Nur Saft (treffe Ziel-%Vol)</strong> ‚Äì
                            nur die Saftmenge wird angepasst, um die gew√ºnschte Alkoholst√§rke zu erreichen.</li>

                        <li><strong>Nur Alkohol (treffe Ziel-%Vol)</strong> ‚Äì
                            nur die Alkoholmenge wird so berechnet, dass die gew√ºnschte St√§rke erreicht wird.</li>
                    </ul>

                    <div style="color:#555;margin-top:6px;">
                        Tipp: Wenn Sie unsicher sind, verwenden Sie
                        <strong>‚ÄûAutomatik (Wasser + Zucker)‚Äù</strong>.
                    </div>
                </div>

                <h4>üßÆ Eingaben</h4>

                <div class="liq-pair">

                    <!-- Alkohol -->
                    <div>
                        <label>Alkoholmenge (L):</label>
                        <input type="number" id="liqAlcL" step="0.01" value="2.00" onblur="liqr_inputChanged()">
                    </div>

                    <div>
                        <label>Kosten / Liter Alkohol (‚Ç¨):</label>
                        <input type="number" id="liqCostAlcohol" step="0.01" placeholder="z. B. 15.00"
                            onblur="liqr_calc()">
                    </div>


                    <!-- Saft -->
                    <div>
                        <label>Saftmenge (L):</label>
                        <input type="number" id="liqJuiceL" step="0.01" value="3.00" onblur="liqr_inputChanged()">
                    </div>

                    <div>
                        <label>Kosten / Liter Saft (‚Ç¨):</label>
                        <input type="number" id="liqCostJuice" step="0.01" placeholder="z. B. 2.50"
                            onblur="liqr_calc()">
                    </div>


                    <!-- Zucker -->
                    <div>
                        <label>Zuckermenge (kg):</label>
                        <input type="number" id="liqSugarKg" step="0.01" value="1.00" onblur="liqr_inputChanged()">
                    </div>

                    <div>
                        <label>Kosten / kg Zucker (‚Ç¨):</label>
                        <input type="number" id="liqCostSugar" step="0.01" placeholder="z. B. 1.80"
                            onblur="liqr_calc()">
                    </div>


                    <!-- Wasser (ohne Kostenfeld) -->
                    <div>
                        <label>Alkoholst√§rke (% Vol):</label>
                        <input type="number" id="liqAlcAbv" step="0.1" value="65" onblur="liqr_inputChanged()">
                    </div>

                    <div>
                        <label>Wasserzugabe (L):</label>
                        <input type="number" id="liqWaterL" step="0.01" value="0.00" onblur="liqr_inputChanged()">
                    </div>


                </div>


                <small style="color:#555;">
                    Kostenfelder sind optional. Bleiben sie leer, wird 0 ‚Ç¨ angenommen.
                </small>




                <h4>üéØ Ziele & Parameter</h4>
                <div class="liq-row three">
                    <div>
                        <label>Ziel-Alkoholst√§rke (% Vol):</label>
                        <input type="number" id="liqTargetAbv" step="0.1" value="25" onblur="liqr_calc()">
                    </div>
                    <div>
                        <label>Ziel-Zucker (g/L) ‚Äì optional:</label>
                        <input type="number" id="liqTargetSugar" step="1" value="136" onblur="liqr_calc()">
                    </div>
                    <div>
                        <label>Volumenfaktor Zucker (L/kg):</label>
                        <input type="number" id="liqSugarVolPerKg" step="0.01" value="0.62" onblur="liqr_calc()">
                    </div>
                </div>

                <div style="margin-top:10px;">
                    <label>
                        <input type="checkbox" id="liqInvertMode" checked onchange="liqr_calc()">
                        Zucker ist bereits in Fl√ºssigkeit gel√∂st (Sirup / Invertzucker) ‚Äì kein zus√§tzliches Volumen
                        berechnen
                    </label>
                </div>

                <div
                    style="background:#fff7e6;border:1px solid #ffd699;border-radius:8px;padding:10px;margin-top:8px;font-size:0.95em;line-height:1.5;">
                    <strong>‚ÑπÔ∏è Zucker-Volumen:</strong><br>
                    Wenn Zucker bereits in Fl√ºssigkeit gel√∂st ist (z.&nbsp;B. Sirup oder Invertzucker),
                    erh√∂ht er das Lik√∂rvolumen nicht.
                    <br><br>
                    <strong>Haken setzen bei:</strong> Sirup ¬∑ Invertzucker ¬∑ Honig-Ausz√ºgen<br>
                    <strong>Haken nicht setzen bei:</strong> normalem Kristallzucker
                    <br><br>
                    Ohne Haken wird Zucker mit <strong>0,62&nbsp;L&nbsp;pro&nbsp;kg</strong> zum Volumen addiert.
                </div>





                <h4>üìä Ergebnis</h4>
                <div class="liq-card">
                    <div id="liqNumbers" class="liq-num" style="margin-bottom:10px;"></div>
                    <div class="liq-bar" aria-label="Volumenanteile">
                        <div class="liq-seg alc" id="segAlc" style="width:0%"></div>
                        <div class="liq-seg juice" id="segJuice" style="width:0%"></div>
                        <div class="liq-seg water" id="segWater" style="width:0%"></div>
                        <div class="liq-seg sugar" id="segSugar" style="width:0%"></div>
                    </div>
                    <div class="liq-legend">
                        <span><span class="dot" style="background:#7db3ff"></span>Alkohol</span>
                        <span><span class="dot" style="background:#9be7a3"></span>Saft</span>
                        <span><span class="dot" style="background:#bfc7d9"></span>Wasser</span>
                        <span><span class="dot" style="background:#ffc37d"></span>Zucker (Vol.)</span>
                    </div>

                    <div id="liqMini" class="liq-mini"></div>
                    <div id="liqWarn" class="liq-note"></div>
                    <div id="liqSummary" class="liq-summary"></div>
                    <div id="liqDetails" class="barrel"></div>

                </div>
                <!-- Ausgabe-Ergebnisse -->
                <div id="liqResult" class="result"></div>


                <h4>Mindestpreis (Materialkosten)</h4>

                <div id="liqMinCostInfo" class="barrel" style="padding:10px;">
                    Mindestpreis pro Liter:
                    <strong id="liqMinPerL">‚Äì</strong>
                </div>


                <h4>Preis√ºbersicht</h4>

                <style>
                    .priceRow {
                        display: flex;
                        flex-direction: row;
                        align-items: center;
                        gap: 10px;
                        margin-bottom: 8px;
                    }

                    .priceRow label {
                        width: 60px;
                        font-weight: bold;
                    }

                    .priceRow input {
                        flex: 1;
                        padding: 6px;
                    }

                    .priceRow input[disabled] {
                        background: #f5f5f5;
                        color: #555;
                    }

                    .profitInfo {
                        width: 120px;
                        font-size: 0.9em;
                        text-align: right;
                    }

                    /* Mobile Optimierung */
                    @media (max-width:600px) {
                        .priceRow {
                            flex-wrap: wrap;
                        }

                        .priceRow label {
                            width: 100%;
                        }

                        .profitInfo {
                            width: 100%;
                            text-align: left;
                            padding-left: 4px;
                        }
                    }
                </style>


                <div class="priceRow">
                    <label>0,5 L</label>
                    <input id="liqMin05" disabled>
                    <input id="liqPrice05" type="number" step="0.01" placeholder="Verkaufspreis (‚Ç¨)"
                        oninput="liqr_calc()">
                    <div id="liqProfit05" class="profitInfo"></div>
                </div>

                <div class="priceRow">
                    <label>0,7 L</label>
                    <input id="liqMin07" disabled>
                    <input id="liqPrice07" type="number" step="0.01" placeholder="Verkaufspreis (‚Ç¨)"
                        oninput="liqr_calc()">
                    <div id="liqProfit07" class="profitInfo"></div>
                </div>

                <div class="priceRow">
                    <label>1,0 L</label>
                    <input id="liqMin10" disabled>
                    <input id="liqPrice10" type="number" step="0.01" placeholder="Verkaufspreis (‚Ç¨)"
                        oninput="liqr_calc()">
                    <div id="liqProfit10" class="profitInfo"></div>
                </div>

                <small style="color:#555;">
                    Links: Mindestpreis aus Materialkosten &nbsp;¬∑&nbsp;
                    Rechts: Gib bitte Deine gew√ºnschten Verkaufspreise ein
                </small>


                <div id="liqSaveWrap" style="display:none; margin-top:15px;">
                    <button onclick="liq_saveProduct()" class="primary">
                        üíæ Lik√∂r als Produkt speichern
                    </button>

                    <button onclick="liq_saveAndStore()" class="primary">
                        üì¶ Lik√∂r speichern & einlagern
                    </button>
                </div>

            </div>



            <div id="liqStoreModal" style="display:none;
    position:fixed; top:50%; left:50%;
    transform:translate(-50%, -50%);
    background:#fff; padding:18px;
    border-radius:12px; width:320px;
    box-shadow:0 4px 12px rgba(0,0,0,0.25);
    z-index:3000;">

                <h3>Lik√∂r ins Lager einbuchen</h3>

                <p>
                    Gesamtmenge:
                    <strong id="liqStoreVolume"></strong><br>
                    Alkoholst√§rke:
                    <strong id="liqStoreAbv"></strong> %vol
                </p>

                <label>Lagerbeh√§lter:</label>
                <select id="liqStoreSelect" style="width:100%; margin-bottom:12px;"></select>

                <button onclick="liq_confirmStore()" class="primary">
                    üç∂ Einlagern
                </button>

                <button onclick="liq_closeStoreModal()" style="width:100%; margin-top:6px;">
                    Abbrechen
                </button>
            </div>

            <div id="liqStoreOverlay" style="display:none; position:fixed;
     inset:0; background:rgba(0,0,0,0.35);
     z-index:2500;">
            </div>















            <!-- Seite 7: Alkoholkorrektur -->
            <div id="pageCorrection" style="display:none;">
                <label>Gemessener Alkoholwert (% Vol):</label>
                <input type="number" id="corrMeasuredAlc" placeholder=" z. B. 42.5">

                <label>Gemessene Temperatur (¬∞C):</label>
                <input type="number" id="corrMeasuredTemp" placeholder="z. B. 26">

                <label>Menge (Liter, optional):</label><br>
                <input type="number" id="corrMeasuredVol" step="0.01"><br><br>

                <button onclick="calculateCorrection()">Temperaturkorrektur berechnen</button>
                <div class="result" id="correctionOutput"></div>
            </div>

            <!--Seite 8: Maischevolumen Berechnung-->
            <div id="pageBarrelCalc" style="display:none;">
                <h3>üßÆ Fassvolumen berechnen</h3>
                <label>Fass-Typ:</label>
                <select id="calcBarrelType" onchange="calcBarrelVolume()">
                    <option value="blau">Blau Graf Weithalsfass 130 Liter</option>
                    <option value="wei√ü">Wei√ü Speidelfass 130 Liter</option>
                </select>

                <label>Gemessene Maischeh√∂he (cm):</label>
                <input type="number" id="calcBarrelHeight" placeholder="z. B. 35" oninput="calcBarrelVolume()">

                <div class="barrel" id="calcBarrelOutput"></div>
            </div>

            <!--Seite 9: Lagerhaltung-->
            <div id="pageStorage" style="display:none;">
                <h2>Verwaltung der Br√§nde</h2>
                <button onclick="openAddStorageModal()" style="margin-bottom:10px;">+ Neuen Beh√§lter
                    hinzuf√ºgen</button>

                <!-- üß± Zentrales Overlay f√ºr alle Modalfenster -->
                <div id="modalOverlay" onclick="cancelAddDistillate()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.4); z-index:1999;">
                </div>


                <div id="addStorageModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
            background:#fff; border-radius:12px; padding:20px; width:320px;
            box-shadow:0 4px 12px rgba(0,0,0,0.3); z-index:2000;">

                    <h3>Neuen Beh√§lter anlegen</h3>

                    <label>Name:</label>
                    <input id="newStorageName" type="text" style="width:100%; margin-bottom:8px;">

                    <label>Kapazit√§t (L):</label>
                    <input id="newStorageCapacity" type="number" step="0.1" style="width:100%; margin-bottom:8px;">

                    <label>Standort:</label>
                    <input id="newStorageLocation" type="text" style="width:100%; margin-bottom:12px;">

                    <div style="text-align:right;">
                        <button onclick="saveAndAddAnother()">+ Weiteren Beh√§lter anlegen</button>
                        <button onclick="saveAndCloseModal()">‚úÖ Schlie√üen & Speichern</button>
                    </div>

                </div>




                <!-- Dropdown f√ºr vorhandene Beh√§lter -->
                <label for="storageSelect">Vorhandene Beh√§lter:</label>
                <select id="storageSelect" onchange="loadStorageDetails()" style="width:100%; margin-bottom:10px;">
                    <option value="">‚Äî Beh√§lter w√§hlen ‚Äî</option>
                </select>

                <!-- Formular zur Anzeige / Bearbeitung -->
                <div id="storageForm" style="border:1px solid #ccc; padding:10px; border-radius:8px;">
                    <h3>Beh√§lterdaten</h3>
                    <label>Name:</label>
                    <input type="text" id="storageName" style="width:100%; margin-bottom:5px;">

                    <label>Gr√∂√üe (Liter):</label>
                    <input type="number" id="storageCapacity" style="width:100%; margin-bottom:5px;">

                    <label>Lagerplatz:</label>
                    <input type="text" id="storageLocation" style="width:100%; margin-bottom:10px;">

                    <button onclick="saveStorage()">üíæ Speichern</button>
                    <button onclick="deleteStorage()">üóëÔ∏è L√∂schen</button>
                </div>

                <!-- Bereich f√ºr enthaltene Destillate -->
                <div id="storageContents" style="margin-top:15px;">
                    <h3>Inhalt des Beh√§lters</h3>
                    <div id="storageContentsList"></div>


                    <!-- Produktdetails der gew√§hlten Lager-Position -->
                    <div id="storageItemDetails" style="display:none;
                                margin-top:8px;
                                padding:8px;
                                background:#f7f7f7;
                                border:1px solid #ccc;
                                border-radius:6px;
                                font-size:0.85em;
                                line-height:1.3;">
                    </div>

                    <div id="storageSummary" style="margin-top:10px; font-weight:bold;"></div>
                    <!--Preisinformation -->
                    <div id="storagePricingInfo" class="result" style="margin-top:10px; font-size:0.9em; color:#333;">
                    </div>

                    <button onclick="openAddDistillateModal()">+ Destillat hinzuf√ºgen</button>
                </div>

                <button onclick="openWaterModal()">üíß Trinkst√§rke berechnen</button>


                <!-- Bereich: Umsch√ºtten -->
                <div id="transferSection" style="margin-top:20px; border-top:1px solid #ccc; padding-top:10px;">
                    <h3>Umsch√ºtten zwischen Beh√§ltern</h3>
                    <label>Quelle (aktuell gew√§hlt):</label>
                    <div id="transferSource" style="margin-bottom:8px; font-weight:bold;">‚Äì</div>

                    <label for="transferTarget">Zielbeh√§lter:</label>
                    <select id="transferTarget" style="width:100%; margin-bottom:8px;"></select>

                    <label>Menge (Liter):</label>
                    <input type="number" id="transferVolume" style="width:100%; margin-bottom:8px;"
                        placeholder="z. B. 10">

                    <button onclick="transferVolume()">‚û°Ô∏è Umsch√ºtten</button>
                </div>
            </div>





            <!-- Fenster selbst -->
            <div id="addDistillateModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
           background:#fff; border-radius:10px; padding:20px; width:320px;
           box-shadow:0 4px 12px rgba(0,0,0,0.3); z-index:2000;">
                <h4>Destillat hinzuf√ºgen</h4>

                <label for="archiveSelect">Archiviertes Destillat:</label>
                <select id="archiveSelect" style="width:100%; margin-bottom:8px;"></select>

                <label>Menge (Liter):</label>
                <input type="number" id="addVolume" style="width:100%; margin-bottom:8px;" placeholder="z. B. 15.0">

                <label>St√§rke (% vol):</label>
                <input type="number" id="addStrength" style="width:100%; margin-bottom:8px;" placeholder="z. B. 62">

                <div style="text-align:right;">
                    <button onclick="confirmAddDistillate()">Hinzuf√ºgen</button>
                    <button onclick="cancelAddDistillate()">Abbrechen</button>
                </div>
            </div>



            <!-- Abf√ºllseite -->
            <div id="pageSales" style="display:none;">
                <h2>üçæ Abf√ºllung</h2>

                <!-- ========================= -->
                <!-- Beh√§lterauswahl -->
                <!-- ========================= -->
                <label for="saleStorage">Beh√§lter w√§hlen:</label>
                <select id="saleStorage" style="width:100%; margin-bottom:10px;" onchange="updateSaleSource();">
                </select>

                <!-- ========================= -->
                <!-- Info: Lager & Kalkulation -->
                <!-- ========================= -->
                <div id="bottlingInfoBox" style="margin-bottom:12px;
                padding:10px;
                border:1px solid #ccc;
                border-radius:8px;
                background:#f9f9f9;
                font-size:0.95em;">
                    <!-- wird per JS bef√ºllt -->
                </div>


                <!-- ========================= -->
                <!-- Abf√ºllparameter -->
                <!-- ========================= -->
                <h3>üß¥ Abf√ºllung</h3>

                <label>Menge aus Lager (L):</label>
                <input id="saleVolume" type="number" step="0.01" style="width:100%; margin-bottom:8px;">

                <label>Flaschengr√∂√üe (L):</label>
                <input id="bottleSizeInput" type="number" step="0.01" value="0.2"
                    style="width:100%; margin-bottom:8px;">

                <label>Flaschen-Lagerort:</label>
                <input id="bottlingLocation" type="text" placeholder="z. B. Regal A, Keller links"
                    style="width:100%; margin-bottom:12px;">

                <!-- ========================= -->
                <!-- Aktionen -->
                <!-- ========================= -->
                <button onclick="previewBottling()" style="width:100%; font-size:1.05em; margin-bottom:8px;">
                    üîç Abf√ºllung berechnen
                </button>

                <div id="bottlingPreview" style="margin-bottom:12px;">
                </div>

                <button onclick="saveBottling()" style="width:100%; font-size:1.1em;">
                    üçæ Abf√ºllung speichern
                </button>
            </div>



            <!-- ===== Seite: Ausgaben ===== -->
            <div id="pageExpenses" style="display:none;">
                <h2 id="expensesTitle">Ausgabenverwaltung:</h2>

                <label for="expenseDate">Datum:</label>
                <input type="date" id="expenseDate" style="width:100%; margin-bottom:8px;">

                <label for="expenseCategory">Kategorie:</label>
                <select id="expenseCategory" style="width:100%; margin-bottom:8px;">
                    <option value="">‚Äî Kategorie w√§hlen ‚Äî</option>
                    <option>Rohstoffe</option>
                    <option>Energie</option>
                    <option>Verpackung</option>
                    <option>Betriebsmittel</option>
                    <option>Wartung</option>
                    <option>Investition</option>
                    <option>Sonstiges</option>
                </select>

                <label for="expenseDesc">Beschreibung:</label>

                <!-- Textfeld (Standard) -->
                <input type="text" id="expenseDesc" placeholder="Beschreibung" style="width: 100%; margin-bottom:8px;">

                <!-- Dropdown f√ºr Rohstoffe -->
                <select id="expenseMaterialSelect" style="width:100%; margin-bottom:8px; display:none;">
                </select>

                <!-- Neue Rohstoff-Eingabe (nur sichtbar bei __new) -->
                <div id="newMaterialFields" style="display:none; margin-bottom:10px;">

                    <input id="newMatName" style="width:100%; margin-bottom:6px;" placeholder="Neuer Rohstoffname">

                    <select id="newMatCategory" style="width:100%; margin-bottom:6px;">
                        <option value="malz">Malz / Getreide</option>
                        <option value="kraeuter">Kr√§uter / Botanicals</option>
                        <option value="hefe">Hefe</option>
                        <option value="zucker">Zucker</option>
                        <option value="frucht">Fr√ºchte / S√§fte</option>
                        <option value="sonstiges">Sonstiges</option>
                    </select>

                    <select id="newMatUnit" style="width:100%; margin-bottom:6px;">
                        <option value="kg">kg</option>
                        <option value="g">g</option>
                        <option value="l">Liter</option>
                        <option value="stk">St√ºck</option>
                    </select>

                    <label style="display:flex; align-items:center; gap:6px; font-size:0.9em;">
                        <input type="checkbox" id="newMatIsBaseAlcohol">
                        Basisalkohol (z. B. Neutralalkohol, Basisbrand)
                    </label>
                    <input id="newMatStrength" type="number" step="0.1" placeholder="Alkoholst√§rke (% Vol)"
                        style="width:100%; margin-top:6px;">

                </div>



                <label for="expenseAmount">Betrag (‚Ç¨):</label>
                <input type="number" id="expenseAmount" step="0.01" style="width:100%; margin-bottom:12px;">

                <div style="text-align:right;">
                    <button id="btnSaveExpense" onclick="saveExpense()">Ausgabe speichern</button>
                </div>

                <hr style="margin:15px 0;">

                <h3>Gefilterte Ausgaben</h3>
                <label>Monat:</label>
                <select id="filterMonth" style="width:48%;" onchange="updateExpenseList()"></select>
                <label>Jahr:</label>
                <select id="filterYear" style="width:48%;" onchange="updateExpenseList()"></select>

                <div id="expenseList" style="margin-top:10px;"></div>

                <hr style="margin:15px 0;">

                <!-- =========================================== -->
                <!-- Rohstofflager -->
                <!-- =========================================== -->
                <div class="card" style="margin-top:20px; padding:10px; border:1px solid #ccc; border-radius:8px;">
                    <h3 style="cursor:pointer;" onclick="toggleMaterialList()">
                        üì¶ Rohstofflager
                        <span id="materialToggleIcon">‚ñº</span>
                    </h3>


                    <p style="font-size:0.85em; color:#555;">
                        Hier verwaltest du Rohstoffe wie Malze, Kr√§uter, Hefe oder sonstige Zutaten.
                        Best√§nde werden sp√§ter automatisch beim Start einer Charge abgebucht.
                    </p>


                    <!-- Lager√ºbersicht -->
                    <div id="materialList" style="margin-top:15px; font-size:0.9em; display:none;">
                        <em>Noch keine Rohstoffe angelegt.</em>
                    </div>
                </div>


                <div style="text-align:right;">
                    <button onclick="deleteExpenses()">üóëÔ∏è Ausgaben l√∂schen</button>
                    <button onclick="exportExpensesToExcel()">üì§ Als Excel exportieren</button>
                </div>




            </div>



            <!-- üìä Finanz√ºbersicht -->
            <div id="pageFinance" style="display:none;">
                <h2>üìä Finanz√ºbersicht</h2>

                <label for="financeMonth">Monat:</label>
                <select id="financeMonth"></select>

                <label for="financeYear">Jahr:</label>
                <select id="financeYear"></select>

                <button onclick="updateFinanceOverview()">üîÑ Aktualisieren</button>
                <button onclick="exportFinanceToExcel()">üì§ Excel-Export</button>

                <hr>
                <div id="financeSummary" style="font-weight:bold; margin-bottom:10px;"></div>
                <div id="financeTable"></div>

                <button onclick="showPage('vatOverview')">
                    üìä Umsatzsteuer-Auswertung
                </button>


                <hr>
                <h3>Datensicherung</h3>
                <button onclick="exportBackup()">üì§ Backup exportieren</button>
                <input type="file" id="backupFileInput" style="display:none;" accept=".json"
                    onchange="importBackup(event)">
                <button onclick="document.getElementById('backupFileInput').click()">üì• Backup importieren</button>
            </div>



            <style>
                /* Container f√ºr 2 Spalten */
                #recipeFlexContainer {
                    display: flex;
                    gap: 20px;
                }

                /* Linke Spalte = Editor */
                #recipeEditorColumn {
                    flex: 1;
                    min-width: 300px;
                }

                /* Rechte Spalte = Rezeptliste */
                #recipeListColumn {
                    flex: 1;
                    min-width: 300px;
                }

                /* --- Handy-Layout --- */
                @media (max-width: 900px) {
                    #recipeFlexContainer {
                        flex-direction: column;
                    }
                }
            </style>



            <!-- ===== Seite: Rezepte / Mischungen ===== -->
            <style>
                /* --- Flex-Layout f√ºr Rezepte-Seite --- */
                #recipeFlexContainer {
                    display: flex;
                    gap: 20px;
                    align-items: flex-start;
                }

                /* Spalte: Editor */
                #recipeEditorColumn {
                    flex: 1;
                    min-width: 320px;
                }

                /* Spalte: Liste */
                #recipeListColumn {
                    flex: 1;
                    min-width: 320px;
                }

                /* Handy: automatisch untereinander */
                @media (max-width: 900px) {
                    #recipeFlexContainer {
                        flex-direction: column;
                    }
                }
            </style>

            <style>
                /* === FIX f√ºr mobile Darstellung im Rezept-Editor === */
                @media (max-width: 768px) {

                    /* Der linke Editorbereich muss scrollbar sein */
                    #recipeEditorColumn {
                        max-height: 80vh;
                        /* begrenzt H√∂he */
                        overflow-y: auto;
                        /* macht Eingabefelder sichtbar */
                        padding-bottom: 200px;
                        /* Platz f√ºr Tastatur */
                        -webkit-overflow-scrolling: touch;
                    }

                    /* Dropdowns und Inputs sollen automatisch ins Sichtfeld springen */
                    #recipeEditorColumn input:focus,
                    #recipeEditorColumn select:focus,
                    #recipeEditorColumn textarea:focus {
                        scroll-margin-top: 100px;
                        scroll-margin-bottom: 250px;
                    }
                }
            </style>




            <div id="pageRecipes" style="display:none;">

                <h2>Rezepte / Mischungen</h2>



                <div id="recipeFlexContainer">

                    <!-- ======================= LINKER BEREICH ‚Äì EDITOR ======================= -->
                    <div id="recipeEditorColumn">

                        <button id="toggleRecipeListBtn" onclick="toggleRecipeList()">
                            üìö Gespeicherte Rezepte anzeigen
                        </button>

                        <div id="recipeEditor" class="card"
                            style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">

                            <h3>Rezept bearbeiten / anlegen</h3>

                            <input type="hidden" id="recipeId">
                            <input type="hidden" id="recipeVersion">

                            <label>Rezeptname:</label>
                            <input type="text" id="recipeName" style="width:100%; margin-bottom:6px;"
                                placeholder="z. B. Obstler Hausmischung">

                            <label>Beschreibung (optional):</label>
                            <textarea id="recipeDescription" style="width:100%; min-height:60px; margin-bottom:6px;"
                                placeholder="Kurze Beschreibung des Rezepts..."></textarea>

                            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:6px;">
                                <div style="flex:1; min-width:150px;">
                                    <label>Rezept-Typ:</label>
                                    <select id="recipeType" style="width:100%;"
                                        onchange="recipeUpdateMashWaterVisibility()">
                                        <option value="percent">Prozent-Rezept (Summe = 100 %)</option>
                                        <option value="aroma">Aroma-/Gewichtungsrezept (Gin, Kr√§uter ...)</option>
                                        <option value="mash">Maischerezept (Malz / Whisky / Bier)</option>
                                    </select>
                                </div>

                                <!-- Wird nur bei Mash-Rezepten angezeigt -->
                                <div id="mashWaterRow" style="display:none; margin-bottom:6px; padding:8px;
                                        border-radius:6px; background:#fff7ed; border:1px solid #fed7aa;">
                                    <strong>Maischerezept-Einstellungen:</strong><br>
                                    <label>Wasser-Malz-Verh√§ltnis (L pro kg Sch√ºttung):</label>
                                    <input type="number" id="recipeMashWaterRatio" style="width:100%;"
                                        placeholder="z. B. 3.0">
                                    <div style="font-size:0.85em; color:#92400e; margin-top:4px;">
                                        Beispiel: 3.0 L/kg ‚áí bei 40 kg Malz ‚âà 120 L Wasser.
                                    </div>
                                    <label>Sparge-Water-Verh√§ltnis (% der ersten Wassergabe):</label>
                                    <input type="number" id="recipeSpargeRatio" placeholder="z. B. 60 f√ºr 60%">
                                </div>


                                <div style="flex:1; min-width:120px;">
                                    <label>Zielmenge (L, optional):</label>
                                    <input type="number" id="recipeTargetVolume" style="width:100%;"
                                        placeholder="z. B. 20">
                                </div>
                                <div id="recipeTargetUnitHint" style="font-size:0.85em; color:#666; margin-top:4px;">
                                    Menge in Liter (Prozent-Rezept)
                                </div>

                                <div style="flex:1; min-width:120px;">
                                    <label>Zielst√§rke (% Vol, optional):</label>
                                    <input type="number" id="recipeTargetStrength" style="width:100%;"
                                        placeholder="z. B. 40">
                                </div>
                            </div>




                            <h4>Zutaten</h4>
                            <table style="width:100%; border-collapse:collapse; margin-bottom:6px;"
                                id="recipeIngredients">
                                <thead>
                                    <tr style="background:#eee;">
                                        <th style="padding:4px; text-align:left; width:55%;">Zutat / Destillat</th>
                                        <th style="padding:4px; text-align:right; width:25%;">Anteil</th>
                                        <th style="padding:4px; text-align:center; width:20%;">Aktion</th>
                                    </tr>
                                </thead>
                                <tbody id="recipeIngredientsBody">
                                    <!-- Zeilen werden per JS eingef√ºgt -->
                                </tbody>
                            </table>

                            <button type="button" onclick="recipeAddIngredientRow()">+ Zutat hinzuf√ºgen</button>
                            <div id="recipeTypeInfo" style="margin-top:12px; font-size:0.85em; color:#444; 
                                        background:#f0f0f0; padding:10px; border-radius:6px;">
                            </div>



                            <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:10px;">
                                <button type="button" onclick="recipeSave()" style="flex:1; min-width:150px;">üíæ
                                    Rezept speichern</button>

                                <button type="button" onclick="recipeResetForm()" style="flex:1; min-width:150px;">üßπ
                                    Formular leeren</button>
                            </div>

                            <div id="recipeValidationMessage" style="margin-top:8px; font-size:0.9em; color:#b45309;">
                            </div>

                            <hr style="margin:12px 0;">

                            <h4>Batch-Report (Anwendung dieses Rezepts)</h4>
                            <div id="recipeApplyBox"
                                style="background:#f9fafb; border:1px solid #ddd; border-radius:6px; padding:8px; margin-bottom:6px; display:none;">
                                <div style="font-size:0.9em; margin-bottom:6px;">
                                    Dieses Modul erstellt einen <strong>theoretischen Batch-Report</strong> aus dem
                                    Rezept.
                                    Es werden <em>keine Lagerbewegungen</em> ausgel√∂st.
                                </div>

                                <div><strong>Aktives Rezept:</strong> <span id="applyRecipeName">‚Äì</span> (<span
                                        id="applyRecipeVersion">‚Äì</span>)</div>

                                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;">
                                    <div style="flex:1; min-width:140px;">
                                        <label>Geplante Gesamtmenge (L):</label>
                                        <input type="number" id="applyTotalVolume" style="width:100%;"
                                            placeholder="z. B. 20">
                                    </div>
                                    <div style="flex:1; min-width:140px;">
                                        <label>Ergebnis-St√§rke (% Vol, optional):</label>
                                        <input type="number" id="applyResultStrength" style="width:100%;"
                                            placeholder="z. B. 40">
                                    </div>
                                </div>

                                <button type="button" onclick="recipeComputeBatch()"
                                    style="margin-top:8px; width:100%;">üìä
                                    Batch berechnen & speichern</button>

                                <div id="applyBatchResult" style="margin-top:8px; font-size:0.9em;"></div>
                            </div>

                            <div id="recipeTypeHint"
                                style="display:none; margin-top:10px; font-size:0.9em; color:#555;">
                            </div>


                            <div id="applyStoragePlan" style="margin-top:8px; font-size:0.9em;"></div>
                            <div id="runSheetBox"
                                style="margin-top:20px; padding:15px; border:1px solid #888; display:none;">
                            </div>


                            <div id="recipeBatchHistory" style="font-size:0.9em; margin-top:8px;">
                                <!-- Batches zum aktiven Rezept -->
                            </div>
                        </div>

                    </div>

                    <!-- ======================= RECHTER BEREICH ‚Äì LISTE ======================= -->
                    <div id="recipeListColumn">
                        <div id="recipeList" class="card"
                            style="padding:10px; border:1px solid #ccc; border-radius:8px;">
                            <div
                                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <h3 style="margin:0;">Gespeicherte Rezepte</h3>
                                <button type="button" onclick="recipeResetForm();">‚ûï Neues Rezept</button>
                            </div>
                            <div id="recipeListContainer">
                                <!-- Rezept-Karten kommen hier rein -->
                            </div>
                        </div>

                        <!--<button onclick="deleteRunSheet()" style="margin-top:10px;">
                            ‚úîÔ∏è Laufzettel erledigt ‚Äì l√∂schen
                        </button>-->

                    </div>

                </div>
            </div>



            <!-- ===== Seite: Aromaproduktion ===== -->
            <div id="pageProduction" style="display:none;">

                <h2>Aroma / Kr√§uter Produktion</h2>
                <div id="storageAromaCheckBox" style="display:none;
                        background:#f5f9ff;
                        border:1px solid #cfe2ff;
                        border-radius:10px;
                        padding:12px;
                        margin-bottom:12px;
                        font-size:0.95em;
                        line-height:1.5;">

                    <strong>‚ÑπÔ∏è Lagerhinweis</strong><br>
                    Damit dieses Produkt sp√§ter eingelagert werden kann,
                    wird ein geeigneter Lagerbeh√§lter ben√∂tigt.<br><br>

                    <strong>Ist bereits ein passender Beh√§lter angelegt?</strong><br><br>

                    <button onclick="confirmStorageCheck(true)">Ja ‚Äì weiter zur Kalkulation</button>
                    <button onclick="confirmStorageCheck(false)">Nein ‚Äì Lagerbeh√§lter anlegen</button>

                </div>

                <!-- üîπ 1. Rezept w√§hlen -->
                <div class="card" style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">
                    <h3>Rezept ausw√§hlen</h3>

                    <p style="font-size:0.85em; color:#555;">
                        W√§hle ein Rezept aus der Liste. Die Rezeptdaten kommen aus der Seite
                        <strong>‚ÄûRezepte / Mischungen‚Äú</strong>.
                    </p>

                    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
                        <select id="prodRecipeSelect" style="flex:1; min-width:180px; padding:4px;"
                            onchange="prodLoadSelectedRecipe()">
                            <option value="">‚Äî Rezept w√§hlen ‚Äî</option>
                        </select>
                    </div>

                    <div id="prodRecipeInfo" style="font-size:0.9em; color:#444; background:#f9fafb; border:1px solid #ddd;
                border-radius:6px; padding:8px; min-height:40px;">
                        <em>Noch kein Rezept ausgew√§hlt.</em>
                    </div>
                </div>



                <!-- ============================================
                    AROMA / GIN: MAZERATIONS-INFO (optional)
                    Wird per JavaScript nur bei Aroma-Rezepten angezeigt
                    ============================================ -->
                <div id="prodMacerationBlock"
                    style="display:none; margin-top:20px; padding:10px; border:1px solid #ccc; border-radius:6px; background:#faf7f0;">
                    <h3 style="margin-top:0;">üåø Mazeration</h3>

                    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
                        <div style="flex:1 1 180px;">
                            <label for="prodMacStart">Beginn:</label><br>
                            <input type="datetime-local" id="prodMacStart" style="width:100%;">
                        </div>

                        <div style="flex:1 1 180px;">
                            <label for="prodMacEnd">Ende:</label><br>
                            <input type="datetime-local" id="prodMacEnd" style="width:100%;">
                        </div>
                    </div>

                    <div style="margin-top:10px;">
                        <label for="prodMacNotes">Notizen zur Mazeration:</label><br>
                        <textarea id="prodMacNotes" style="width:100%; height:70px;"></textarea>
                    </div>
                </div>



                <!----Ob gebrannt wird oder nicht---->
                <div id="prodAromaProcessBlock"
                    style="display:none; margin-top:20px; padding:10px; border:1px solid #ccc; border-radius:6px; background:#eef9ff;">

                    <h3>Herstellungsart</h3>

                    <label>
                        <input type="radio" name="aromaProcess" value="distill" checked>
                        Mazeration ‚Üí Destillation (klassischer Gin / Kr√§uterschnaps)
                    </label><br>

                    <label>
                        <input type="radio" name="aromaProcess" value="noDistill">
                        Mazeration ‚Üí NICHT destillieren (z. B. Cold Compound Gin)
                    </label>

                </div>





                <!-- ============================================
                    AROMA / GIN: BASISALKOHOL + KOSTEN
                    ============================================ -->
                <div id="prodBaseAlcoholBlock"
                    style="display:none; margin-top:20px; padding:10px; border:1px solid #ccc; border-radius:6px; background:#f3f8ff;">
                    <h3 style="margin-top:0;">üç∂ Eingesetzter Basisalkohol</h3>

                    <label>Basisalkohol:</label>
                    <select id="prodBaseAlcoholSelect" style="width:100%; margin-bottom:6px;">
                        <option value="">‚Äî Basisalkohol w√§hlen ‚Äî</option>
                    </select>


                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <div style="flex:1 1 120px;">
                            <label for="prodBaseAlcLiters">Menge (L):</label><br>
                            <input type="number" id="prodBaseAlcLiters" step="0.01" style="width:100%;"
                                placeholder="z. B. 25">
                        </div>

                        <div style="flex:1 1 120px;">
                            <label for="prodBaseAlcStrength">St√§rke (% Vol):</label><br>
                            <input type="number" id="prodBaseAlcStrength" step="0.1" style="width:100%;" value="96">
                        </div>

                        <div style="flex:1 1 120px;">
                            <label for="prodBaseAlcPrice">Preis pro Liter (‚Ç¨):</label><br>
                            <input type="number" id="prodBaseAlcPrice" step="0.01" style="width:100%;"
                                placeholder="z. B. 3.20">
                        </div>
                    </div>

                    <div id="prodBaseAlcInfo" style="margin-top:6px; font-size:0.9em; color:#444;">
                        <em>Optional: Menge und Preis eintragen, um die Alkoholkosten zu sehen.</em>
                    </div>
                </div>


                <!-- ============================================
                    AROMA / GIN: BOTANICAL-BERECHNUNG
                ============================================ -->
                <div id="prodAromaBotCalcBlock"
                    style="display:none; margin-top:20px; padding:10px; border:1px solid #ccc; border-radius:6px; background:#fdfdf5;">

                    <h3>Botanical-Berechnung</h3>

                    <label><strong>Wie m√∂chtest du die Botanicals berechnen?</strong></label><br>
                    <label><input type="radio" name="botCalcMode" value="total" checked> Gesamtmenge Botanicals (g oder
                        kg)</label><br>
                    <label><input type="radio" name="botCalcMode" value="perliter"> Botanicals pro Liter Basisalkohol
                        (g/L)</label>

                    <div id="botCalcTotalBox" style="margin-top:10px;">
                        <label>Gesamtmenge Botanicals:</label><br>
                        <input type="number" id="prodBotTotal" step="1" style="width:200px;"
                            placeholder="z. B. 400 (g)">
                    </div>

                    <div id="botCalcPerLiterBox" style="margin-top:10px; display:none;">
                        <label>Botanicals pro Liter Alkohol (g/L):</label><br>
                        <input type="number" id="prodBotPerLiter" step="0.1" style="width:200px;"
                            placeholder="z. B. 40">
                    </div>

                </div>


                <!-- ============================================
                    AROMA / GIN: BOTANICAL-KOSTEN-√úBERSICHT
                    ============================================ -->
                <div id="prodBotanicalCostBlock"
                    style="display:none; margin-top:20px; padding:10px; border:1px solid #ccc; border-radius:6px; background:#f7f7f7;">
                    <h3 style="margin-top:0;">üí∞ Botanicals ‚Äì Kosten√ºbersicht</h3>
                    <div id="prodBotanicalCostTable">
                        <em>Die Tabelle wird angezeigt, wenn eine geplante Menge eingegeben ist.</em>
                    </div>
                </div>


                <!-- ============================================================
                        MATERIAL CHECK DIALOG ‚Äì Einheitlich f√ºr Mash & Aroma
                    ============================================================ -->
                <div id="materialCheckDialog" class="dialog" style="display:none;">
                    <div class="dialog-content" style="
                            background:#fff;
                            padding:20px;
                            border-radius:10px;
                            width:90%;
                            max-width:600px;
                            box-shadow:0 0 20px rgba(0,0,0,0.3);
                        ">

                        <h3 style="margin-top:0;">Rohstoffpr√ºfung</h3>

                        <p style="font-size:0.9em; color:#555;">
                            Bitte pr√ºfe die ben√∂tigten Rohstoffe. Wenn du ‚ÄûJa‚Äú w√§hlst,
                            werden die Best√§nde automatisch abgebucht.
                        </p>

                        <div id="materialCheckTable" style="max-height:300px; overflow-y:auto; margin-top:10px;">
                            <!-- Tabelle wird per JavaScript erzeugt -->
                        </div>

                        <div style="display:flex; gap:10px; margin-top:20px;">

                            <button id="matCheckYesBtn"
                                style="flex:1; background:#4caf50; color:white; padding:10px; border-radius:6px; border:none;">
                                ‚úî Ja ‚Äì Rohstoffe abbuchen
                            </button>

                            <button id="matCheckNoBtn"
                                style="flex:1; background:#f0ad4e; color:white; padding:10px; border-radius:6px; border:none;">
                                ‚úñ Nein ‚Äì nur Laufzettel erstellen
                            </button>

                            <button id="matCheckCancelBtn"
                                style="flex:1; background:#d9534f; color:white; padding:10px; border-radius:6px; border:none;">
                                ‚õî Abbrechen
                            </button>

                        </div>

                    </div>
                </div>

                <!-- üîπ 3. Tats√§chlicher Brand & Lagerbuchung -->
                <div id="prodActualDistillBlock" class="card"
                    style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">

                    <div class="card"
                        style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">
                        <h3>Tats√§chlicher Brand & Lager</h3>

                        <p style="font-size:0.85em; color:#555;">
                            Hier tr√§gst du die <strong>tats√§chliche Destillatmenge</strong> ein,
                            die du aus diesem Rezept gebrannt hast. Optional berechnet dir das
                            System, wie viel Wasser du f√ºr eine gew√ºnschte Trinkst√§rke
                            zugeben m√ºsstest. Das Destillat wird dann direkt in einen
                            ausgew√§hlten <strong>Lagerbeh√§lter</strong> eingebucht.
                        </p>

                        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:8px;">
                            <div style="flex:1; min-width:140px;">
                                <label>Tats√§chliches Destillat (L):</label>
                                <input type="number" id="prodActualVolume" style="width:100%;" placeholder="z. B. 7.8"
                                    oninput="prodUpdateWaterInfo()">
                            </div>
                            <div style="flex:1; min-width:140px;">
                                <label>Tats√§chliche St√§rke (% Vol):</label>
                                <input type="number" id="prodActualStrength" style="width:100%;" placeholder="z. B. 78"
                                    oninput="prodUpdateWaterInfo()">
                            </div>
                            <div style="flex:1; min-width:140px;">
                                <label>Gew√ºnschte Trinkst√§rke (% Vol):</label>
                                <input type="number" id="prodDrinkStrength" style="width:100%;" placeholder="z. B. 40"
                                    oninput="prodUpdateWaterInfo()">
                            </div>
                        </div>

                        <div id="prodWaterInfo" style="font-size:0.9em; margin-bottom:8px; color:#444;">
                            <em>Hinweis: Trage tats√§chliches Volumen, tats√§chliche St√§rke
                                und gew√ºnschte Trink-/Fassst√§rke ein. Die Wassermenge wird berechnet
                                und beim Buchen ins Lager ber√ºcksichtigt.</em>
                        </div>


                        <!-- üîπ KOSTENBLOCK F√úR AROMA-DESTILLATION -->
                        <div id="prodAromaCostBlock"
                            style="margin:12px 0; padding:10px; border:1px solid #ddd; border-radius:8px; background:#fdf9f2;">

                            <h3 style="margin-top:0;">Kosten & Ergebnis (Aroma-Destillation)</h3>

                            <p style="font-size:0.85em; color:#555;">
                                Dieser Block berechnet die Produktionskosten <strong>ab dem Brennen</strong> ‚Äì
                                zus√§tzlich zu Basisalkohol und Botanicals.
                                Die Werte sind Vorschl√§ge und k√∂nnen f√ºr jede Charge angepasst werden.
                            </p>

                            <!-- Brenndaten + Arbeit -->
                            <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:6px;">
                                <div style="flex:1 1 120px;">
                                    <label>Brenndauer (h):</label><br>
                                    <input type="number" id="prodAromaBurnHours" step="0.1" style="width:100%;"
                                        value="3.5">
                                </div>
                                <div style="flex:1 1 120px;">
                                    <label>Leistung (kW):</label><br>
                                    <input type="number" id="prodAromaPowerKw" step="0.1" style="width:100%;"
                                        value="16">
                                </div>
                                <div style="flex:1 1 120px;">
                                    <label>Strompreis (‚Ç¨/kWh):</label><br>
                                    <input type="number" id="prodAromaEnergyPrice" step="0.01" style="width:100%;"
                                        value="0.35">
                                </div>
                            </div>

                            <!-- Fixkosten (Destille) -->
                            <div style="margin-top:8px; padding-top:6px; border-top:1px dashed #ddd;">
                                <div style="font-weight:bold; margin-bottom:4px;">Fixkosten (Destille)</div>

                                <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:4px;">
                                    <div style="flex:1 1 150px;">
                                        <label>Anschaffungspreis Destille (‚Ç¨):</label><br>
                                        <input type="number" id="prodAromaStillPrice" step="1" style="width:100%;"
                                            value="12500">
                                    </div>
                                    <div style="flex:1 1 120px;">
                                        <label>Nutzungsdauer (Jahre):</label><br>
                                        <input type="number" id="prodAromaStillYears" step="1" style="width:100%;"
                                            value="10">
                                    </div>
                                    <div style="flex:1 1 120px;">
                                        <label>Br√§nde pro Jahr:</label><br>
                                        <input type="number" id="prodAromaRunsPerYear" step="1" style="width:100%;"
                                            value="20">
                                    </div>
                                </div>

                                <div id="prodAromaFixedInfo" style="font-size:0.85em; color:#555;">
                                    Fixkostenanteil: wird aus den obigen Werten berechnet.
                                </div>
                            </div>


                            <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:6px;">
                                <div style="flex:1 1 120px;">
                                    <label>Arbeitszeit (h):</label><br>
                                    <input type="number" id="prodAromaWorkHours" step="0.1" style="width:100%;"
                                        value="4">
                                </div>
                                <div style="flex:1 1 120px;">
                                    <label>Stundenlohn (‚Ç¨/h):</label><br>
                                    <input type="number" id="prodAromaWage" step="0.01" style="width:100%;" value="25">
                                </div>
                            </div>

                            <!-- Steuer -->
                            <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:8px;">
                                <div style="flex:1 1 150px;">
                                    <label>Steuersatz (‚Ç¨/L reiner Alkohol):</label><br>
                                    <input type="number" id="prodAromaTaxPerLAA" step="0.01" style="width:100%;"
                                        value="10.22">
                                </div>
                            </div>

                            <!-- Zusammenfassung -->
                            <div id="prodAromaCostSummary"
                                style="font-size:0.9em; background:#fff; border:1px solid #eee; border-radius:6px; padding:8px;">
                                <em>Die Kosten werden berechnet, sobald Destillatmenge, St√§rke
                                    und ggf. Zielst√§rke eingetragen sind.</em>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- ============================================
                    AROMA ‚Äì ZIELST√ÑRKE & WASSERBERECHNUNG
                    (nutzt prodBaseAlcLiters + prodBaseAlcStrength)
                =============================================== -->
                <div id="prodAromaTargetStrengthBlock" style="display:none; margin-top:20px; padding:10px; border:1px solid #ccc;
                            border-radius:8px; background:#fffdf4;">

                    <h3>üéØ Endst√§rke einstellen</h3>

                    <p style="font-size:0.85em; color:#555;">
                        Die Zielst√§rke bestimmt das endg√ºltige Volumen und die ben√∂tigte Wassermenge.
                        Sie basiert auf dem weiter oben eingegebenen Basisalkohol.
                    </p>

                    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
                        <div style="flex:1 1 140px;">
                            <label>Endst√§rke (% Vol):</label><br>
                            <input type="number" id="prodAromaFinalStrength" step="0.1" placeholder="z. B. 40"
                                style="width:100%;" oninput="prodUpdateAromaFinalCalc()">
                        </div>

                        <div style="flex:2 1 220px; font-size:0.9em; color:#444;">
                            <div id="prodAromaFinalInfo">
                                <em>Bitte Zielst√§rke eingeben.</em>
                            </div>
                        </div>
                    </div>
                </div>


                <!--Laufzettelblock-->
                <div id="prodAromaRunSheetBlock"
                    style="display:none; margin-top:20px; padding:10px; border:1px solid #ccc; border-radius:8px; background:#fffbe7;">

                    <h3>üìÑ Laufzettel erstellen</h3>

                    <p style="font-size:0.85em; color:#555;">
                        Der Laufzettel listet die skalierten Botanicals und die ben√∂tigten Mengen
                        f√ºr die Mazeration auf. Ideal, um loszulaufen und alles bereitzulegen.
                    </p>

                    <button onclick="prodCreateAromaRunSheet()" style="padding:10px 20px; font-weight:bold;">
                        üìÑ Laufzettel erzeugen
                    </button>
                </div>




                <!-- ============================================
                    AROMA ‚Äì FLASCHEN & VERKAUFSPREISE
                =============================================== -->
                <div id="prodAromaBottleBlock"
                    style="display:block; margin-top:20px; padding:10px; border:1px solid #ccc; border-radius:8px; background:#f7faff;">

                    <h3>üì¶ Flaschenkalkulation & Verkaufspreise</h3>

                    <!-- MATERIALKOSTEN -->
                    <h4>Materialkosten je Flasche</h4>

                    <div style="display:flex; gap:10px; flex-wrap:wrap;">

                        <div style="flex:1 1 120px;">
                            <label>Flasche 0.5 L (‚Ç¨):</label>
                            <input id="botMatBottle05" type="number" step="0.01" style="width:100%;" value="0.60"
                                oninput="prodUpdateAromaBottleCalc()">
                        </div>

                        <div style="flex:1 1 120px;">
                            <label>Flasche 0.7 L (‚Ç¨):</label>
                            <input id="botMatBottle07" type="number" step="0.01" style="width:100%;" value="0.70"
                                oninput="prodUpdateAromaBottleCalc()">
                        </div>

                        <div style="flex:1 1 120px;">
                            <label>Flasche 1.0 L (‚Ç¨):</label>
                            <input id="botMatBottle10" type="number" step="0.01" style="width:100%;" value="0.90"
                                oninput="prodUpdateAromaBottleCalc()">
                        </div>

                        <div style="flex:1 1 120px;">
                            <label>Verschluss (‚Ç¨):</label>
                            <input id="botMatClosure" type="number" step="0.01" style="width:100%;" value="0.15"
                                oninput="prodUpdateAromaBottleCalc()">
                        </div>

                        <div style="flex:1 1 120px;">
                            <label>Etikett (‚Ç¨):</label>
                            <input id="botMatLabel" type="number" step="0.01" style="width:100%;" value="0.10"
                                oninput="prodUpdateAromaBottleCalc()">
                        </div>

                        <div style="flex:1 1 120px;">
                            <label>Verpackung (‚Ç¨):</label>
                            <input id="botMatPackage" type="number" step="0.01" style="width:100%;" value="0.20"
                                oninput="prodUpdateAromaBottleCalc()">
                        </div>

                        <div style="flex:1 1 120px;">
                            <label>Versand (‚Ç¨):</label>
                            <input id="botMatShipping" type="number" step="0.01" style="width:100%;" value="0.00"
                                oninput="prodUpdateAromaBottleCalc()">
                        </div>
                    </div>

                    <!-- VERKAUFSPREISE -->
                    <h4 style="margin-top:15px;">Verkaufspreise</h4>

                    <div class="table-scroll">
                        <table id="prodBottlePriceTable" style="width:100%; border-collapse:collapse; font-size:0.9em;">

                            <thead>
                                <tr style="background:#eee;">
                                    <th style="padding:4px; text-align:left;">Gr√∂√üe</th>
                                    <th style="padding:4px; text-align:center;">VK-Preis (‚Ç¨)</th>
                                    <th style="padding:4px; text-align:right;">Mindestpreis (‚Ç¨)</th>
                                    <th style="padding:4px; text-align:right;">Gewinn/Flasche (‚Ç¨)</th>
                                    <th style="padding:4px; text-align:right;">Gesamt-Gewinn (‚Ç¨)</th>
                                    <th style="padding:4px; text-align:right;">Anzahl</th>
                                    <th style="padding:4px; text-align:right;">Restvol (L)</th>
                                </tr>
                            </thead>

                            <tbody>
                                <tr>
                                    <td>0.5 L</td>
                                    <td><input id="botPrice05" type="number" step="0.01" style="width:80px;"
                                            oninput="prodUpdateAromaBottleCalc()"></td>
                                    <td id="botMin05" style="text-align:right;">‚Äì</td>
                                    <td id="botGain05" style="text-align:right;">‚Äì</td>
                                    <td id="botTotalGain05" style="text-align:right;">‚Äì</td>
                                    <td id="botCountL05" style="text-align:right;">‚Äì</td>
                                    <td id="botRestL05" style="text-align:right;">‚Äì</td>
                                </tr>

                                <tr>
                                    <td>0.7 L</td>
                                    <td><input id="botPrice07" type="number" step="0.01" style="width:80px;"
                                            oninput="prodUpdateAromaBottleCalc()"></td>
                                    <td id="botMin07" style="text-align:right;">‚Äì</td>
                                    <td id="botGain07" style="text-align:right;">‚Äì</td>
                                    <td id="botTotalGain07" style="text-align:right;">‚Äì</td>
                                    <td id="botCountL07" style="text-align:right;">‚Äì</td>
                                    <td id="botRestL07" style="text-align:right;">‚Äì</td>
                                </tr>

                                <tr>
                                    <td>1.0 L</td>
                                    <td><input id="botPrice10" type="number" step="0.01" style="width:80px;"
                                            oninput="prodUpdateAromaBottleCalc()"></td>
                                    <td id="botMin10" style="text-align:right;">‚Äì</td>
                                    <td id="botGain10" style="text-align:right;">‚Äì</td>
                                    <td id="botTotalGain10" style="text-align:right;">‚Äì</td>
                                    <td id="botCountL10" style="text-align:right;">‚Äì</td>
                                    <td id="botRestL10" style="text-align:right;">‚Äì</td>
                                </tr>
                            </tbody>

                        </table>
                    </div>


                </div>


                <!-- ============================================
                    Block um fertiges Aroma-Produkt zu erzeugen
                    ============================================ -->
                <div id="prodAromaCreateBlock"
                    style="display:none; margin-top:25px; padding:12px; border:2px dashed #bbb; border-radius:8px; background:#f8fff8;">

                    <h3>‚úî Fertiges Produkt erzeugen</h3>

                    <p style="font-size:0.9em; color:#444;">
                        Hier wird dein fertiges Aroma-Produkt (Gin, Kr√§uter, Mazerat) gespeichert.
                        Alle Informationen wie Basisalkohol-Kosten, Botanicals, Mazeration und St√§rke
                        werden √ºbernommen.
                    </p>


                    <!-- div style="margin-bottom:10px;">
                        <label>Endst√§rke (% Vol):</label><br>
                        <input type="number" id="prodAromaFinalStrength" style="width:200px;" placeholder="z. B. 40">
                    </div -->

                    <button onclick="prodCreateAromaProduct()" style="padding:10px 20px; font-weight:bold;">
                        üì¶ Produkt erzeugen & speichern
                    </button>
                </div>


                <div id="prodAromaStoreBlock" style="display:none; margin-top:20px; padding:10px; border:1px solid #ccc;
                            border-radius:8px; background:#eef6ff;">

                    <h3>Aroma-Charge einlagern</h3>

                    <p style="font-size:0.85em; color:#555;">
                        W√§hle, ob die Charge verd√ºnnt werden soll.
                        Die Einlagerung erzeugt automatisch ein Produkt,
                        das sp√§ter verkauft werden kann.
                    </p>

                    <div style="margin:10px 0;">
                        <label>Ziel-Lagerbeh√§lter:</label><br>
                        <select id="prodStorageSelect" style="width:100%; padding:4px;">
                            <option value="">‚Äî Beh√§lter w√§hlen ‚Äî</option>
                        </select>
                    </div>

                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button onclick="prodStoreAromaToStorage('raw')" style="flex:1; padding:10px;">
                            üì¶ Unverd√ºnnt einlagern
                        </button>

                        <button onclick="prodStoreAromaToStorage('diluted')"
                            style="flex:1; padding:10px; background:#4caf50; color:white;">
                            üíß Verd√ºnnt einlagern
                        </button>
                    </div>
                </div>

            </div>





            <!-- Dialog: Detailansicht eines Lager-Eintrags -->
            <div id="storageItemDialog" class="dialog" style="display:none;">
                <div class="dialog-content">
                    <h3>Details zum Lagereintrag</h3>

                    <div id="storageItemDetails" style="font-size:0.9em; margin-bottom:15px;">
                        <!-- Wird per JS gef√ºllt -->
                    </div>

                    <button onclick="closeStorageItemDialog()" style="width:100%; background:#ccc;">
                        Schlie√üen
                    </button>
                </div>
            </div>





            <!-- ===== Seite: Whiskyroduktion (neu) ===== -->
            <div id="pageBatches" style="display:none;">

                <h2>Herstellung (Whisky & Maische)</h2>

                <p style="font-size:0.9em; color:#555; max-width:800px;">
                    In diesem Bereich kannst du eine <strong>Charge</strong> anlegen, die Rohstoffe
                    aus einem <strong>Misch- / Maischerezept</strong> √ºbernehmen, die Maische
                    auf mehrere G√§rbeh√§lter verteilen und sp√§ter den Brand &amp; die Kosten
                    dokumentieren. Schritt f√ºr Schritt ‚Äì ohne Zwang, alles auszuf√ºllen.
                </p>

                <!-- üîπ 1. Charge & Rezept ausw√§hlen -->
                <div class="card" style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">
                    <!-- üîπ 0. Bestehende Charge laden -->
                    <div class="card"
                        style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">
                        <h3>Bestehende Charge laden</h3>

                        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
                            <select id="batchSelectExisting" style="flex:1; min-width:220px; padding:4px;"
                                onchange="batchLoadSelected()">
                                <option value="">‚Äî Charge ausw√§hlen ‚Äî</option>
                            </select>
                        </div>

                        <div id="batchLoadInfo" style="font-size:0.9em; color:#444; background:#f9fafb; 
                            border:1px solid #ddd; border-radius:6px; padding:8px;">
                            <em>Keine Charge ausgew√§hlt.</em>
                        </div>
                    </div>




                    <h3>Neue Charge starten</h3>

                    <p style="font-size:0.85em; color:#555;">
                        W√§hle ein <strong>Mash-Rezept</strong> (z.&nbsp;B. Whisky, Korn, Rum) aus.
                        Die Rohstoffe werden automatisch aus dem Rezept √ºbernommen. Sp√§ter kannst
                        du G√§rung, Brand und Kosten erg√§nzen.
                    </p>

                    <!-- Rezeptauswahl nur f√ºr Mash -->
                    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
                        <select id="batchRecipeSelect" style="flex:1; min-width:220px; padding:4px;">
                            <option value="">‚Äî Mash-Rezept w√§hlen ‚Äî</option>
                        </select>

                        <!-- Button: Startet komplette Whisky-/Mash-Logik -->
                        <button type="button" id="batchStartBtn" onclick="startMashBatch()">
                            ‚ûï Charge anlegen
                        </button>
                    </div>

                    <div id="batchInfoBox" style="font-size:0.9em; color:#444; background:#f9fafb; border:1px solid #ddd;
                            border-radius:6px; padding:8px; min-height:40px;">
                        <em>Noch keine Charge gestartet.</em>
                    </div>
                </div>



                <button type="button" onclick="openWhiskyRunSheet()">
                    üìÑ Laufzettel anzeigen / drucken
                </button>




                <!-- üîπ 3. Maische & G√§rbeh√§lter (Platzhalter) -->
                <div class="card" style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">
                    <h3>Maische &amp; G√§rbeh√§lter</h3>

                    <p style="font-size:0.85em; color:#555;">
                        In diesem Abschnitt kannst du das <strong>Gesamtvolumen der Maische</strong> und einfache
                        G√§rdaten zu dieser Charge festhalten. Sp√§ter k√∂nnen wir die Verteilung auf einzelne
                        G√§rbeh√§lter erg√§nzen.
                    </p>

                    <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px;">
                        <div style="flex:1; min-width:140px;">
                            <label>G√§rbeginn:</label>
                            <input type="date" id="batchFermentStart" style="width:100%;">
                        </div>
                        <div style="flex:1; min-width:140px;">
                            <label>G√§rende (optional):</label>
                            <input type="date" id="batchFermentEnd" style="width:100%;">
                        </div>
                        <div style="flex:1; min-width:140px;">
                            <label>Gesamtvolumen der Maische (L):</label>
                            <input type="number" id="batchFermentVolume" style="width:100%;" placeholder="z. B. 120">
                        </div>
                    </div>

                    <div style="margin-bottom:8px;">
                        <label>G√§r-Notizen (Temperatur, Hefe, Besonderheiten):</label>
                        <textarea id="batchFermentNotes" style="width:100%; min-height:60px;"
                            placeholder="z. B. 20‚Äì22 ¬∞C, Hefe XY, st√ºrmische G√§rung ..."></textarea>
                    </div>

                    <div style="text-align:right;">
                        <button type="button" onclick="batchSaveFermentation()">üíæ G√§rdaten f√ºr diese Charge
                            speichern</button>
                    </div>

                    <div id="batchFermentSummary" style="margin-top:8px; font-size:0.9em; color:#444;">
                        <em>Noch keine G√§rdaten gespeichert.</em>
                    </div>

                </div>

                <!-- üîπ 4. Brand & Lager (aus dieser Charge) -->
                <div class="card" style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">
                    <h3>Brand &amp; Lager (aus dieser Charge)</h3>

                    <p style="font-size:0.85em; color:#555;">
                        Erfasse hier den tats√§chlichen Endbrand dieser Charge.
                        Die Alkoholkorrektur erfolgt automatisch wie auf der Seite
                        <strong>‚ÄûAlkoholkorrektur‚Äú</strong>.
                        Bei <strong>Doppelbrand</strong> wird ausschlie√ülich der Feinbrand (Endbrand) erfasst.
                        Bei <strong>Kolonnenbrand</strong> entspricht der Endbrand dem einzigen Brand.
                    </p>

                    <!-- Brennverfahren + Datum + Dauer -->
                    <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px;">
                        <div style="flex:1; min-width:140px;">
                            <label>Brennverfahren:</label>
                            <select id="batchDistillMethod" style="width:100%;">
                                <option value="double">Doppelbrand (Roh + Fein)</option>
                                <option value="column">Kolonnenbrand (ein Brand)</option>
                            </select>
                        </div>
                        <div style="flex:1; min-width:140px;">
                            <label>Branddatum:</label>
                            <input type="date" id="mashDistillDate" style="width:100%;">
                        </div>
                        <div style="flex:1; min-width:140px;">
                            <label>Brenndauer (Stunden, gesamt):</label>
                            <input type="number" step="0.1" id="mashDistillDurationHours" style="width:100%;"
                                placeholder="z. B. 5.5">
                        </div>
                    </div>


                    <!-- FEINBRAND / ENDBRAND-BLOCK -->
                    <div style="border:1px solid #ddd; border-radius:6px; padding:8px; margin-bottom:10px;">
                        <h4 style="margin-top:0;">Feinbrand / Endbrand</h4>

                        <div style="font-size:0.85em; color:#555; margin-bottom:4px;">
                            <strong>Gemessene Werte</strong>
                        </div>
                        <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:6px;">
                            <div style="flex:1; min-width:120px;">
                                <label>Gemessene Menge (L):</label>
                                <input type="number" step="0.01" id="fineMeasVolume" style="width:100%;">
                            </div>
                            <div style="flex:1; min-width:120px;">
                                <label>Gemessene St√§rke (%vol):</label>
                                <input type="number" step="0.1" id="fineMeasStrength" style="width:100%;">
                            </div>
                            <div style="flex:1; min-width:120px;">
                                <label>Gemessene Temperatur (¬∞C):</label>
                                <input type="number" step="0.1" id="fineMeasTemp" style="width:100%;">
                            </div>
                        </div>

                        <div style="font-size:0.85em; color:#555; margin-bottom:4px;">
                            <strong>Korrigierte Werte (@ 20&nbsp;¬∞C)</strong>
                        </div>
                        <div style="display:flex; flex-wrap:wrap; gap:8px;">
                            <div style="flex:1; min-width:120px;">
                                <label>Korrigierte Menge (L):</label>
                                <input type="number" step="0.01" id="fineCorrVolume" style="width:100%;">
                            </div>
                            <div style="flex:1; min-width:120px;">
                                <label>Korrigierte St√§rke (%vol):</label>
                                <input type="number" step="0.1" id="fineCorrStrength" style="width:100%;">
                            </div>
                        </div>
                    </div>




                    <!-- Notizen + Speichern -->
                    <div style="margin-bottom:8px;">
                        <label>Notizen (optional):</label>
                        <textarea id="batchDistillNotes" style="width:100%; min-height:60px;"
                            placeholder="z. B. sehr sauberer Lauf, Cut etwas fr√ºher, ..."></textarea>
                    </div>



                    <div id="batchDistillSummary" style="margin-top:8px; font-size:0.9em; color:#444;">
                        <em>Noch keine Branddaten gespeichert.</em>
                    </div>
                </div>


                <!-- üîπ 5. Kosten√ºbersicht (Platzhalter) -->
                <div class="card" style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">
                    <h3>Kosten dieser Charge</h3>

                    <!-- Rohstoffkosten -->
                    <div style="margin-bottom:10px;">
                        <strong>Rohstoffe</strong>
                        <div id="batchMaterialCostSummary" style="font-size:0.9em; color:#444;">
                            <em>Rohstoffkosten werden automatisch berechnet.</em>
                        </div>
                    </div>

                    <!-- Energie -->
                    <div style="display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap;">
                        <div style="flex:1; min-width:160px;">
                            <label>Energiekosten pro Brennstunde (‚Ç¨):</label>
                            <input type="number" step="0.01" id="mashEnergyRate" style="width:100%;"
                                placeholder="z. B. 8.50">
                        </div>
                    </div>

                    <!-- Arbeit -->
                    <div style="display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap;">
                        <div style="flex:1; min-width:160px;">
                            <label>Arbeitszeit gesamt (h):</label>
                            <input type="number" step="0.1" id="mashLaborHours" style="width:100%;">
                        </div>
                        <div style="flex:1; min-width:160px;">
                            <label>Stundenlohn (‚Ç¨):</label>
                            <input type="number" step="0.01" id="mashLaborRate" style="width:100%;"
                                placeholder="z. B. 22.00">
                        </div>
                    </div>


                    <!-- Zusammenfassung -->
                    <div id="batchCostBox" style="margin-top:10px; font-size:0.9em; background:#fff;
                                border:1px solid #ddd; border-radius:6px; padding:10px;">
                        <em>Noch keine Kostendaten berechnet.</em>
                    </div>

                    <div style="text-align:right;">
                        <button type="button" onclick="batchSaveDistillation()">üíæ Branddaten speichern</button>
                    </div>

                </div>

                <hr>

                <div class="card" style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">
                    <p>
                        Wenn deine Charge bereit f√ºr die Reifung ist, kannst du sie hier in ein Reifefass einlagern:
                    </p>

                    <button onclick="showPage('casks')">üõ¢ ‚û°Ô∏è Zu den Reifef√§ssern</button><br>
                </div>


            </div>






            <!-- ===== Seite: Reifef√§sser ===== -->
            <div id="pageCasks" style="display:none;">

                <h2>üõ¢ Reifef√§sser verwalten</h2>

                <!-- üîπ Fass-Stammdaten -->
                <div class="card" style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">
                    <h3>Fass anlegen / bearbeiten</h3>
                    <div id="caskStatusDisplay" style="margin-bottom:6px; font-size:0.9em;"></div>
                    <input type="hidden" id="caskId">

                    <div style="display:flex; flex-wrap:wrap; gap:8px;">
                        <div style="flex:1; min-width:160px;">
                            <label>Bezeichnung / Name:</label>
                            <input id="caskName" style="width:100%;" placeholder="z. B. Sherry Oloroso Butt">
                        </div>

                        <div style="flex:1; min-width:120px;">
                            <label>Volumen (L):</label>
                            <input id="caskVolume" type="number" style="width:100%;" placeholder="z. B. 500">
                        </div>

                        <!-- Holzart -->
                        <div style="flex:1; min-width:140px;">
                            <label>Holzart:</label>
                            <input id="caskWood" list="woodList" style="width:100%;"
                                placeholder="z. B. Amerikanische Eiche">
                            <datalist id="woodList">
                                <option value="Amerikanische Eiche">
                                <option value="Europ√§ische Eiche">
                                <option value="Franz√∂sische Eiche">
                                <option value="Kastanie">
                                <option value="Anderes Holz">
                            </datalist>
                        </div>




                        <!-- Toasting -->
                        <div style="flex:1; min-width:140px;">
                            <label>Toasting:</label>
                            <input id="caskToast" list="toastList" style="width:100%;" placeholder="z. B. Medium Toast">
                            <datalist id="toastList">
                                <option value="Light Toast">
                                <option value="Medium Toast">
                                <option value="Heavy Toast">
                                <option value="Char 1">
                                <option value="Char 2">
                                <option value="Char 3">
                                <option value="Char 4">
                                <option value="Sondertoast">
                            </datalist>
                        </div>

                    </div>

                    <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;">
                        <div style="flex:1; min-width:160px;">
                            <label>Vorbelegung:</label>
                            <input id="caskPreviousFill" style="width:100%;" placeholder="z. B. Oloroso Sherry">
                        </div>

                        <div style="flex:1; min-width:160px;">
                            <label>K√ºferei / Herkunft:</label>
                            <input id="caskCooperage" style="width:100%;" placeholder="z. B. Speyside Cooperage">
                        </div>

                        <div style="flex:1; min-width:140px;">
                            <label>Kaufdatum:</label>
                            <input id="caskDatePurchased" type="date" style="width:100%;">
                        </div>

                        <div style="flex:1; min-width:140px;">
                            <label>Kaufpreis (‚Ç¨):</label>
                            <input id="caskPurchaseCost" type="number" step="0.01" style="width:100%;"
                                placeholder="z. B. 350">
                        </div>
                    </div>

                    <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; align-items:flex-end;">
                        <div style="flex:1; min-width:140px;">
                            <label>Status:</label>
                            <select id="caskStatus" style="width:100%;">
                                <option value="empty">Leer</option>
                                <option value="in_use">In Verwendung</option>
                                <option value="aging">Reifung</option>
                                <option value="archived">Archiviert</option>
                            </select>

                        </div>

                        <div style="flex:3; min-width:200px;">
                            <label>Notizen:</label>
                            <input id="caskNotes" style="width:100%;"
                                placeholder="z. B. kleine Undichtigkeit, repariert 2025‚Ä¶">
                        </div>

                        <div style="text-align:right; min-width:120px;">
                            <button onclick="caskSaveFromForm()" style="margin-top:4px;">üíæ Fass speichern</button><br>
                            <button onclick="caskResetForm()" style="margin-top:4px;">üßπ Neu / leeren</button>
                        </div>
                    </div>

                    <div id="caskFormMessage" style="margin-top:6px; font-size:0.85em; color:#b00;"></div>
                </div>

                <!-- üîπ Fassliste -->
                <div class="card" style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">
                    <h3>Fassliste</h3>
                    <div id="caskList">
                        <em>Noch keine F√§sser angelegt.</em>
                    </div>
                </div>


                <!-- üîπ Batch in Fass f√ºllen -->
                <div class="card" style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">
                    <h3>‚öóÔ∏è Charge in dieses Fass einf√ºllen</h3>

                    <div id="caskFillWrapper" style="display:none;">

                        <div style="font-size:0.85em; color:#555; margin-bottom:6px;">
                            <em>Bitte Charge ausw√§hlen und Einf√ºllmenge angeben.</em>
                        </div>

                        <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px;">
                            <div style="flex:1; min-width:200px;">
                                <label>Charge ausw√§hlen:</label>
                                <select id="caskFillBatchSelect" style="width:100%;"
                                    onchange="caskOnBatchSelected()"></select>

                            </div>

                            <div style="flex:1; min-width:120px;">
                                <label>Volumen (L):</label>
                                <input id="caskFillVolume" type="number" step="0.01" style="width:100%;"
                                    placeholder="z. B. 40">
                            </div>

                            <div style="flex:1; min-width:120px;">
                                <label>St√§rke (% Vol):</label>
                                <input id="caskFillStrength" type="number" step="0.1" style="width:100%;"
                                    placeholder="z. B. 65">
                            </div>
                        </div>

                        <label>Notizen (optional):</label>
                        <textarea id="caskFillNotes" style="width:100%; min-height:60px; margin-bottom:8px;"
                            placeholder="z. B. New Make, Vorverd√ºnnt auf 63%, leichte Tr√ºbung ‚Ä¶"></textarea>

                        <div style="text-align:right;">
                            <button onclick="caskFillBatch()">üõ¢ Charge einf√ºllen</button>
                        </div>

                        <div id="caskFillMessage" style="margin-top:6px; font-size:0.85em; color:#b00;"></div>

                        <!-- üîπ NEU: F√ºllhistorie-Box -->
                        <div id="caskFillHistoryBox" style="margin-top:10px; font-size:0.9em;"></div>

                        <button onclick="caskAddAngelsShare()">ü™Ω Angel's Share eintragen</button>


                        <div
                            style="margin-top:15px; padding:10px; background:#f9f9f9; border:1px solid #ccc; border-radius:6px;">

                            <div style="font-weight:bold; margin-bottom:6px;">
                                üéØ Zielfassst√§rke einstellen
                            </div>

                            <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
                                <input id="caskTargetStrength" type="number" step="0.1" value="63.5"
                                    style="width:90px;">

                                <button onclick="caskAdjustToCaskStrength()">
                                    Auf Fassst√§rke einstellen
                                </button>
                            </div>

                            <div id="caskAdjustMessage" style="font-size:0.85em; color:#555; margin-top:5px;"></div>
                        </div>

                    </div>

                    <div class="card"
                        style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">
                        <h3>üîÅ Umsch√ºtten in ein anderes Fass</h3>

                        <div id="caskTransferWrapper" style="display:none;">

                            <div style="margin-bottom:6px; font-size:0.85em; color:#555;">
                                <em>W√§hle Ziel-Fass und Menge, die du umsch√ºtten m√∂chtest.</em>
                            </div>

                            <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px;">
                                <div style="flex:1; min-width:200px;">
                                    <label>Ziel-Fass:</label>
                                    <select id="caskTransferTarget" style="width:100%;"></select>
                                </div>

                                <div style="flex:1; min-width:120px;">
                                    <label>Menge (L):</label>
                                    <input id="caskTransferVolume" type="number" step="0.01" style="width:100%;"
                                        placeholder="z. B. 20">
                                </div>
                            </div>

                            <label>Notizen (optional):</label>
                            <textarea id="caskTransferNotes" style="width:100%; min-height:60px; margin-bottom:8px;"
                                placeholder="z. B. Re-Racking in Sherry Cask f√ºr sekund√§re Reifung ‚Ä¶"></textarea>

                            <div style="text-align:right;">
                                <button onclick="caskTransfer()">üîÅ Umsch√ºtten</button>
                            </div>

                            <div id="caskTransferMessage" style="margin-top:6px; font-size:0.85em; color:#b00;"></div>

                        </div>
                    </div>




                </div>




                <!-- üîπ Sensorik / Tasting f√ºr ausgew√§hltes Fass -->
                <div class="card" style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">
                    <h3>Sensorik / Fassproben</h3>
                    <p style="font-size:0.9em; color:#555;">
                        Sensorik beschreibt, wie die Fassprobe riecht, schmeckt und wirkt.
                        Es gibt kein Richtig oder Falsch ‚Äì schreib einfach deine Eindr√ºcke auf.
                    </p>

                    <div style="margin-bottom:8px;">
                        <a href="javascript:void(0)" onclick="toggleSensorikHelp()" style="font-size:0.9em;">
                            üîΩ Sensorik-Hilfe f√ºr Brenner anzeigen
                        </a>
                    </div>

                    <div id="sensorikHelp"
                        style="display:none; font-size:0.9em; background:#f8f8f8; border:1px solid #ddd; border-radius:8px; padding:10px; margin-bottom:10px;">

                        <strong>üëÉ Nase ‚Äì Was rieche ich?</strong><br>
                        Halte das Glas unter die Nase und rieche langsam.<br>
                        Wenn dir kein Wort einf√§llt, hilft es, an <strong>Alltagsdinge</strong> zu denken:<br><br>

                        <strong>Typische Eindr√ºcke:</strong>
                        <ul style="margin-top:4px;">
                            <li><strong>S√º√ü:</strong> Vanille, Honig, Karamell</li>
                            <li><strong>Fruchtig:</strong> Apfel, Birne, Pflaume, Trockenfr√ºchte</li>
                            <li><strong>Malzig / Nussig:</strong> Brot, M√ºsli, N√ºsse</li>
                            <li><strong>W√ºrzig:</strong> Pfeffer, Zimt, Nelke</li>
                            <li><strong>Holz / Sherry:</strong> Eiche, Kork</li>
                            <li><strong>Rauchig:</strong> Lagerfeuer, Holzrauch</li>
                            <li><strong>Frisch:</strong> Gras, Kr√§uter</li>
                            <li><strong>Fehlnoten:</strong> Klebstoff, L√∂sungsmittel, Essig, Schwefel</li>
                        </ul>

                        üëâ <em>2‚Äì4 Begriffe reichen v√∂llig.</em><br><br>


                        <strong>üëÑ Gaumen ‚Äì Wie schmeckt es?</strong><br>
                        Jetzt einen kleinen üòÑ Schluck nehmen<br><br>

                        <strong>Du kannst beschreiben:</strong>
                        <ul>
                            <li><strong>Intensit√§t:</strong> mild ‚Äì rund ‚Äì kr√§ftig ‚Äì scharf</li>
                            <li><strong>Mundgef√ºhl:</strong> weich ‚Äì √∂lig ‚Äì cremig ‚Äì d√ºnn</li>
                            <li><strong>Was f√§llt auf?</strong> S√º√üe ¬∑ W√ºrze ¬∑ Eiche ¬∑ Frucht</li>
                        </ul>

                        <strong>Beispiel:</strong><br>
                        <em>‚Äûweich, Honig und Malz, leichte W√ºrze, angenehme Eiche‚Äú</em><br><br>


                        <strong>üå¨ Finish ‚Äì Abgang</strong><br>
                        Achte darauf, <strong>wie lange der Geschmack bleibt:</strong>
                        <ul>
                            <li><strong>kurz</strong> ‚Äì schnell weg</li>
                            <li><strong>mittel</strong> ‚Äì bleibt noch sp√ºrbar</li>
                            <li><strong>lang</strong> ‚Äì deutlich anhaltend</li>
                        </ul>
                        Und dann z. B.: s√º√ü? warm? trocken? w√ºrzig?<br><br>


                        <strong>‚≠ê Bewertung (0‚Äì100)</strong>
                        <ul>
                            <li>70‚Äì75 = ok</li>
                            <li>76‚Äì80 = gut</li>
                            <li>81‚Äì85 = sehr gut</li>
                            <li>86‚Äì90 = ausgezeichnet</li>
                            <li>91+ = Spitzenklasse</li>
                        </ul>
                        <em>Dein Gef√ºhl z√§hlt.</em><br><br>


                        <strong>üìù Notizen</strong><br>
                        Hier kannst du z. B. festhalten:
                        <ul>
                            <li><strong>Entwicklung:</strong> wird runder? trockener? bitterer?</li>
                            <li><strong>Einsch√§tzung:</strong> noch Zeit im Fass? trinkreif?</li>
                            <li><strong>Fehlnoten:</strong> falls vorhanden</li>
                            <li><strong>Ideen:</strong> ‚ÄûVerd√ºnnen? Umf√ºllen?‚Äú</li>
                        </ul>

                        <strong>Beispiel:</strong><br>
                        <em>‚ÄûSehr harmonisch. Eiche noch jung. Noch 6‚Äì12 Monate reifen lassen.‚Äú</em><br><br>

                        <em>‚ù§Ô∏è Wichtigster Grundsatz: Du kannst nichts falsch machen üôÇ</em>

                    </div>


                    <div id="caskTastingCurrent" style="font-size:0.85em; color:#555; margin-bottom:6px;">
                        <em>Bitte zuerst ein Fass in der Liste ausw√§hlen.</em>
                    </div>

                    <div id="caskTastingFormWrapper" style="display:none;">
                        <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px;">
                            <div style="flex:1; min-width:140px;">
                                <label>Datum:</label>
                                <input id="tastDate" type="date" style="width:100%;">
                            </div>

                            <div style="flex:1; min-width:120px;">
                                <label>% Vol der Probe:</label>
                                <input id="tastStrength" type="number" step="0.1" style="width:100%;"
                                    placeholder="z. B. 62.5">
                            </div>

                            <div style="flex:1; min-width:140px;">
                                <label>Farbe:</label>
                                <select id="tastColor" style="width:100%;">
                                    <option value="">‚Äî w√§hlen ‚Äî</option>
                                    <option value="Helles Stroh">Helles Stroh</option>
                                    <option value="Goldgelb">Goldgelb</option>
                                    <option value="Bernstein">Bernstein</option>
                                    <option value="Dunkler Bernstein">Dunkler Bernstein</option>
                                    <option value="Mahagoni">Mahagoni</option>
                                    <option value="Rubinrot">Rubinrot</option>
                                    <option value="Dunkelbraun">Dunkelbraun</option>
                                </select>
                            </div>

                            <div style="flex:1; min-width:120px;">
                                <label>
                                    Bewertung (0‚Äì100)
                                    <span onclick="toggleFieldHelp('scoreHelp')" style="cursor:pointer;"> ‚ÑπÔ∏è</span>
                                </label>
                                <div id="scoreHelp"
                                    style="display:none; font-size:0.8em; color:#555; margin-bottom:4px;">
                                    70‚Äì75 = ok ¬∑ 76‚Äì80 = gut ¬∑ 81‚Äì85 = sehr gut ¬∑ 86‚Äì90 = top
                                </div>

                                <input id="tastScore" type="number" min="0" max="100" style="width:100%;"
                                    placeholder="z. B. 86">
                            </div>
                        </div>

                        <!-- Aromafelder -->
                        <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px;">

                            <div style="flex:1; min-width:180px;">
                                <label>
                                    Nase (Aromen + Freitext)
                                    <span onclick="toggleFieldHelp('noseHelp')" style="cursor:pointer;"> ‚ÑπÔ∏è</span>
                                </label>
                                <div id="noseHelp"
                                    style="display:none; font-size:0.8em; color:#555; margin-bottom:4px;">
                                    Beispiele: Vanille, Honig, Trockenfr√ºchte, Eiche, Gew√ºrze, Rauch
                                </div>
                                <input id="tastNose" style="width:100%;"
                                    placeholder="z. B. Vanille, Trockenfr√ºchte, Nuss">
                            </div>


                            <div style="flex:1; min-width:180px;">
                                <label>
                                    Gaumen / Geschmack
                                    <span onclick="toggleFieldHelp('palateHelp')" style="cursor:pointer;"> ‚ÑπÔ∏è</span>
                                </label>
                                <div id="palateHelp"
                                    style="display:none; font-size:0.8em; color:#555; margin-bottom:4px;">
                                    mild ¬∑ kr√§ftig ¬∑ weich ¬∑ √∂lig ¬∑ cremig ¬∑ s√º√ü ¬∑ w√ºrzig ¬∑ fruchtig ¬∑ Eiche
                                </div>

                                <input id="tastPalate" style="width:100%;"
                                    placeholder="z. B. Honig, Malz, leichte Eiche">
                            </div>


                            <div style="flex:1; min-width:180px;">
                                <label>
                                    Finish
                                    <span onclick="toggleFieldHelp('finishHelp')" style="cursor:pointer;"> ‚ÑπÔ∏è</span>
                                </label>
                                <div id="finishHelp"
                                    style="display:none; font-size:0.8em; color:#555; margin-bottom:4px;">
                                    kurz ¬∑ mittel ¬∑ lang ‚Äì z. B. warm, trocken, w√ºrzig
                                </div>

                                <input id="tastFinish" style="width:100%;"
                                    placeholder="z. B. mittellang, w√ºrzig, trocken">
                            </div>
                        </div>

                        <div style="margin-bottom:8px;">
                            <label>
                                Notizen
                                <span onclick="toggleFieldHelp('notesHelp')" style="cursor:pointer;"> ‚ÑπÔ∏è</span>
                            </label>
                            <div id="notesHelp" style="display:none; font-size:0.8em; color:#555; margin-bottom:4px;">
                                z. B. Eindruck, Entwicklung, Reifesch√§tzung (‚Äûnoch 6‚Äì12 Monate‚Äú)
                            </div>

                            <textarea id="tastNotes" style="width:100%; min-height:60px;"
                                placeholder="Eindruck, Entwicklung, Empfehlung (z. B. 'noch 6 Monate', 'perfekt', ... )"></textarea>
                        </div>

                        <div style="text-align:right;">
                            <button onclick="caskAddTasting()">üß™ Fassprobe speichern</button>
                        </div>

                        <button onclick="printCaskTastings()" style="margin-top:10px; width:100%;" class="btnPrimary">
                            üñ®Ô∏è Fassproben drucken
                        </button>

                    </div>

                    <div id="caskTastingList" style="margin-top:10px; font-size:0.9em;">
                        <!-- Liste der Tastings f√ºr ausgew√§hltes Fass -->
                    </div>
                </div>

            </div>


            <!-- ========================================================= -->
            <!-- Seite: Mash-Charge starten (pageMashBatch)                -->
            <!-- ========================================================= -->
            <div id="pageMashBatch" style="display:none; padding-bottom:30px;">

                <h2>üç∫ Mash / Charge starten</h2>

                <div id="mashBatchRecipeBox"
                    style="padding:10px; border:1px solid #ccc; border-radius:8px; margin-bottom:15px;">
                    <em>Noch kein Rezept geladen‚Ä¶</em>
                </div>

                <div id="mashBatchIngredients"
                    style="padding:10px; border:1px solid #ccc; border-radius:8px; margin-bottom:15px;">
                    <strong>Zutaten:</strong>
                    <div id="mashBatchIngredientsTable" style="margin-top:8px;">
                        <em>Noch keine Zutaten geladen‚Ä¶</em>
                    </div>
                </div>

                <div id="mashBatchActions"
                    style="padding:10px; border:1px solid #ccc; border-radius:8px; margin-bottom:15px;">

                    <button onclick="mashBatchEnterWeight()">
                        ‚ûï Sch√ºttungsmenge eingeben
                    </button>

                    <div id="mashBatchWaterBox" style="margin-top:10px;">
                        <em>Noch keine Wasserberechnung.</em>
                    </div>
                </div>

                <div id="mashBatchFinishBox" style="padding:10px; border:1px solid #ccc; border-radius:8px;">
                    <em>Noch keine Charge gestartet.</em>
                </div>

            </div>






            <!-- ===== Seite: Laufzettel-Archiv ===== -->
            <div id="pageRunSheets" style="display:none; padding:15px;">

                <h2>üìÑ Laufzettel-Archiv</h2>

                <p style="font-size:0.85em; color:#555;">
                    Hier siehst du alle gespeicherten Laufzettel ‚Äì Whisky, Aroma und Prozent.
                    Du kannst sie jederzeit erneut √∂ffnen.
                </p>

                <div id="runSheetList">
                    <em>Die Laufzettel werden beim √ñffnen dieser Seite geladen.</em>
                </div>

            </div>



            <!-- Flaschenlager -->
            <div id="pageBottlings" style="display:none;">
                <h2>üçæ Flaschenlager</h2>

                <div style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                        <thead>
                            <tr style="border-bottom:2px solid #ccc;">
                                <th align="left">Produkt</th>
                                <th>Lagerort</th>
                                <th>Flasche</th>
                                <th>St√§rke</th>
                                <th>Bestand</th>
                                <th>Min ‚Ç¨</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="bottlingsTableBody">
                            <!-- renderBottlingsTable() -->
                        </tbody>
                    </table>
                </div>
            </div>



            <!-- Verkauf aus Abf√ºllung -->
            <div id="pageSellBottlings" style="display:none;">
                <h2>üí∞ Flaschen verkaufen</h2>

                <!-- Abf√ºllung ausw√§hlen (nur wenn keine vorausgew√§hlt ist) -->
                <div id="sellBottlingSelectBlock" style="margin-bottom:10px;">
                    <label>Abf√ºllung ausw√§hlen:</label>
                    <select id="sellBottlingSelect" style="width:100%;" onchange="onSellBottlingSelectChange()">
                        <!-- wird per JS bef√ºllt -->
                    </select>
                </div>


                <div id="sellBottlingInfo"
                    style="padding:10px; border:1px solid #ccc; border-radius:6px; margin-bottom:10px;">
                </div>

                <label>Anzahl Flaschen:</label>
                <input type="number" id="sellBottleCount" min="1" step="1" oninput="updateSellProfitPreview()"
                    style="width:100%; margin-bottom:10px;">



                <label>Geplanter Verkaufspreis je Flasche (‚Ç¨):</label>
                <input type="number" id="sellPricePerBottle" step="0.01" oninput="updateSellProfitPreview()"
                    style="width:100%; margin-bottom:10px;">


                <label>Zusatzkosten (Verpackung / Versand) (‚Ç¨):</label>
                <input type="number" id="sellExtraCosts" step="0.01" oninput="updateSellProfitPreview()"
                    style="width:100%; margin-bottom:10px;">


                <div id="sellProfitPreview" style="margin:10px 0; font-weight:bold;">
                </div>

                <button onclick="addDraftToCart()">‚ûï Zum Warenkorb hinzuf√ºgen</button>

                <h3>üõí Warenkorb</h3>

                <table>
                    <thead>
                        <tr>
                            <th>Produkt</th>
                            <th>Lagerort</th>
                            <th>Menge</th>
                            <th>Preis / Fl.</th>
                            <th>Umsatz</th>
                            <th>Gewinn</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="salesDraftCartBody">
                        <!-- wird per JS gef√ºllt -->
                    </tbody>
                </table>


                <button onclick="finalizeCartWithInvoice()">
                    üü¢ Verkaufen & Rechnung erstellen
                </button>

                <button onclick="finalizeCartWithoutInvoice()">
                    üîµ Nur verkaufen (ohne Rechnung)
                </button>


            </div>



            <!-- Verkaufsliste -->
            <div id="pageSalesList" style="display:none;">
                <h2>üìÑ Verkaufsliste</h2>



                <div style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                        <thead>
                            <tr style="border-bottom:2px solid #ccc;">
                                <th>Datum</th>
                                <th>Produkt</th>
                                <th>Lagerort</th>
                                <th>Menge</th>
                                <th>Preis / Fl.</th>
                                <th>Umsatz</th>
                                <th>Gewinn</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody">
                            <!-- wird per JS bef√ºllt -->
                        </tbody>
                    </table>
                </div>

            </div>




            <!-- Rechnung erstellen -->
            <div id="pageCreateInvoice" style="display:none;">
                <h2>üßæ Rechnung erstellen</h2>

                <div id="invoiceSaleInfo"
                    style="padding:10px; border:1px solid #ccc; border-radius:6px; margin-bottom:10px;">
                    <!-- Verkaufsinfo -->
                </div>


                <h3>K√§ufer</h3>

                <label>Kunde suchen:</label>
                <input id="invoiceCustomerSearch" oninput="filterInvoiceCustomers()"
                    placeholder="Name oder Ort eingeben‚Ä¶" style="width:100%; margin-bottom:6px;">


                <label>Kunde ausw√§hlen:</label>
                <select id="invoiceCustomerSelect" onchange="onInvoiceCustomerSelect()"
                    onclick="onInvoiceCustomerSelect()" style="width:100%; margin-bottom:10px;">
                    <option value="">‚Äì Kunde ausw√§hlen ‚Äì</option>
                </select>



                <label>Name:</label>
                <input id="invBuyerName" style="width:100%; margin-bottom:8px;">

                <label>Stra√üe:</label>
                <input id="invBuyerStreet" style="width:100%; margin-bottom:8px;">

                <label>PLZ:</label>
                <input id="invBuyerZip" style="width:100%; margin-bottom:8px;">

                <label>Ort:</label>
                <input id="invBuyerCity" style="width:100%; margin-bottom:8px;">

                <label>Land:</label>
                <input id="invBuyerCountry" value="Deutschland" style="width:100%; margin-bottom:12px;">

                <label>Telefon</label>
                <input id="invBuyerPhone" style="width:100%; margin-bottom:8px;">

                <label>E-Mail</label>
                <input id="invBuyerEmail" style="width:100%; margin-bottom:8px;">

                <button onclick="saveCustomerFromInvoice()" style="margin-top:10px;">
                    ‚ûï Als neuen Kunden speichern
                </button>



                <h3>Positionen auf dieser Rechnung</h3>

                <div id="invoiceDraftList"
                    style="padding:10px; border:1px solid #ccc; border-radius:6px; margin-bottom:12px;">
                    <em>Noch keine Verk√§ufe ausgew√§hlt.</em>
                </div>


                <button onclick="saveInvoice()">üíæ Rechnung speichern</button>
                <button onclick="printCurrentInvoice()">üñ®Ô∏è Drucken</button>


            </div>




            <!-- Rechnungen -->
            <div id="pageInvoices" style="display:none;">
                <h2>üßæ Rechnungen</h2>

                <div style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                        <thead>
                            <tr style="border-bottom:2px solid #ccc;">
                                <th>Nr.</th>
                                <th>Datum</th>
                                <th>K√§ufer</th>
                                <th>Betrag</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTableBody">
                            <!-- wird per JS gef√ºllt -->
                        </tbody>
                    </table>
                </div>
            </div>



            <!-- Rechnung anzeigen -->
            <div id="pageInvoiceView" style="display:none;">
                <h2>üßæ Rechnung</h2>

                <div id="invoiceViewContent" style="padding:12px; border:1px solid #ccc; border-radius:6px;">
                </div>

                <button onclick="printCurrentInvoice()">üñ®Ô∏è Drucken</button>
                <button onclick="downloadCurrentInvoicePDF()">üìÑ PDF erzeugen</button>
                <button onclick="cancelCurrentInvoice()">‚ùå Rechnung stornieren</button>
                <button onclick="showPage('invoices')">‚¨ÖÔ∏è Zur√ºck zur Liste</button>

            </div>


            <!-- Verk√§uferprofil -->
            <div id="pageSellerProfile" style="display:none;">
                <h2>üè∑Ô∏è Verk√§ufer / Brennerei</h2>

                <label>Name / Betrieb:</label>
                <input id="sellerName" style="width:100%; margin-bottom:8px;">

                <label>Stra√üe:</label>
                <input id="sellerStreet" style="width:100%; margin-bottom:8px;">

                <label>PLZ:</label>
                <input id="sellerZip" style="width:100%; margin-bottom:8px;">

                <label>Ort:</label>
                <input id="sellerCity" style="width:100%; margin-bottom:8px;">

                <label>Land:</label>
                <input id="sellerCountry" value="Deutschland" style="width:100%; margin-bottom:8px;">

                <label>USt-IdNr. (optional):</label>
                <input id="sellerVatId" style="width:100%; margin-bottom:8px;">

                <label>Bankverbindung (IBAN / BIC):</label>
                <textarea id="sellerBank" style="width:100%; margin-bottom:10px;"></textarea>

                <label>Umsatzsteuer:</label>
                <select id="sellerVatMode">
                    <option value="none">Kleinunternehmer (¬ß19 UStG)</option>
                    <option value="gross">Regelbesteuerung (Preise inkl. MwSt)</option>
                    <option value="net">Regelbesteuerung (Preise zzgl. MwSt)</option>
                </select>

                <label>Umsatzsteuersatz:</label>
                <input type="number" id="sellerVatRate" step="0.01" value="0.19">

                <button onclick="saveSellerProfile()">üíæ Verk√§ufer speichern</button>

                <hr>

                <div style="font-size:0.85em; color:#555; margin-top:10px;">
                    <strong>Hinweis:</strong><br>
                    Diese App ersetzt keine Buchhaltungs- oder Steuersoftware.
                    Alle Berechnungen und Auswertungen (z. B. Umsatzsteuer, Einnahmen/Ausgaben) dienen ausschlie√ülich
                    der internen Dokumentation und Vorbereitung f√ºr die Steuerberatung.
                    F√ºr die steuerliche und rechtliche Richtigkeit der Angaben bleibt der Nutzer selbst verantwortlich.
                    Eine Gew√§hr f√ºr Vollst√§ndigkeit und Richtigkeit der Ergebnisse wird nicht √ºbernommen.
                    Eine Haftung besteht nur bei Vorsatz oder grober Fahrl√§ssigkeit.
                </div>


            </div>



            <!-- Kunden -->
            <div id="pageCustomers" style="display:none;">
                <h2>üë• Kunden</h2>

                <label>Name: (bitte Nachname zuerst)</label>
                <input id="custName" style="width:100%; margin-bottom:6px;">

                <label>Stra√üe:</label>
                <input id="custStreet" style="width:100%; margin-bottom:6px;">

                <label>PLZ:</label>
                <input id="custZip" style="width:100%; margin-bottom:6px;">

                <label>Ort:</label>
                <input id="custCity" style="width:100%; margin-bottom:6px;">

                <label>Land:</label>
                <input id="custCountry" value="Deutschland" style="width:100%; margin-bottom:10px;">

                <label>Telefon:</label>
                <input id="custPhone" style="width:100%; margin-bottom:10px;">

                <label>E-Mail:</label>
                <input id="custEmail" style="width:100%; margin-bottom:10px;">

                <button onclick="saveCustomer()">üíæ Kunde speichern</button>

                <hr>

                <input type="search" placeholder="Kunden suchen‚Ä¶" oninput="renderCustomersList(this.value)"
                    style="width:100%; margin-bottom:10px;">


                <div id="customersList"></div>
            </div>



            <!-- Rechnung Druckansicht -->
            <style>
                /* =========================
            DRUCKANSICHT
            ========================= */
                @media print {

                    /* Alles ausblenden */
                    body * {
                        visibility: hidden;
                    }

                    /* NUR die Rechnung sichtbar machen */
                    #pageInvoicePrint,
                    #pageInvoicePrint * {
                        visibility: visible;
                    }

                    /* Rechnung sauber positionieren */
                    #pageInvoicePrint {
                        position: absolute;
                        left: 0;
                        top: 0;
                        width: 100%;
                    }

                    /* Buttons sicher ausblenden */
                    button,
                    .no-print {
                        display: none !important;
                    }
                }
            </style>


            <div id="pageInvoicePrint" style="display:none; max-width:800px; margin:auto;">

                <h2>Rechnung</h2>

                <div id="invoicePrintHeader"></div>
                <hr>

                <div id="invoicePrintBuyer"></div>
                <br>

                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="border-bottom:1px solid #000;">
                            <th align="left">Produkt</th>
                            <th align="right">Menge</th>
                            <th align="right">Einzelpreis</th>
                            <th align="right">Gesamt</th>
                        </tr>
                    </thead>
                    <tbody id="invoicePrintItems"></tbody>
                </table>

                <hr>

                <div id="invoicePrintTotals"></div>

                <div style="margin-top:20px; font-size:0.8em; color:#666;">
                    Hinweis: Diese Rechnung wurde mit einer Verwaltungssoftware erstellt.
                    Sie ersetzt keine Buchhaltungssoftware.
                    Die steuerliche Verarbeitung erfolgt eigenverantwortlich.
                </div>


            </div>



            <!-- Umsatzsteuer -->
            <div id="pageVatOverview" style="display:none;">
                <h2>üìä Umsatzsteuer-Auswertung</h2>

                <label>Jahr:</label>
                <select id="vatYearSelect" onchange="renderVatOverview()"></select>

                <div id="vatHint" style="margin:10px 0; color:#555;"></div>

                <div style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                        <thead>
                            <tr style="border-bottom:2px solid #ccc;">
                                <th>Monat</th>
                                <th>MwSt-Satz</th>
                                <th align="right">Netto (‚Ç¨)</th>
                                <th align="right">MwSt (‚Ç¨)</th>
                                <th align="right">Brutto (‚Ç¨)</th>
                            </tr>
                        </thead>
                        <tbody id="vatOverviewBody">
                            <!-- wird per JS gef√ºllt -->
                        </tbody>
                    </table>
                </div>
                <button onclick="exportVatOverviewToExcel()">
                    üì§ Umsatzsteuer als Excel exportieren
                </button>

            </div>



            <!--Gewinnanalyse -->
            <div id="pageProfitAnalysis" class="page" style="display:none;">

                <h2>üçØ Produkt-Gewinnanalyse</h2>

                <div style="margin-top:10px; padding:8px; background:#f4f4f4; border-radius:6px;">
                    Zeitraum w√§hlen:
                    <input type="date" id="gaDateFrom">
                    ‚Äì
                    <input type="date" id="gaDateTo">

                    &nbsp; Produkt:
                    <select id="gaProductFilter"></select>

                    &nbsp; Flaschengr√∂√üe:
                    <select id="gaSizeFilter">
                        <option value="">Alle</option>
                        <option value="0.2">200 ml</option>
                        <option value="0.35">350 ml</option>
                        <option value="0.5">500 ml</option>
                        <option value="0.7">700 ml</option>
                        <option value="1.0">1 Liter</option>
                    </select>

                    &nbsp; Lagerort:
                    <select id="gaLocationFilter"></select>

                    <button onclick="gaRunAnalysis()">üîç Auswerten</button>

                    <div id="gaResult" style="margin-top:15px;"></div>

                    <div style="font-size:0.8em; color:#666; margin-top:10px;">
                        Die Auswertung basiert auf allen erfassten Verk√§ufen.
                        Kosten enthalten Herstellung, Steuer, Flasche & Zusatzkosten.
                    </div>
                </div>

            </div>



            <!--Impressum -->
            <div id="pageLegal" style="display:none; padding:12px; line-height:1.5;">

                <h2>üìÑ Rechtliche Hinweise & Lizenz</h2>

                <h3>Impressum</h3>

                <p>
                    <strong>Verantwortlich f√ºr diese Software:</strong><br>
                    Alois Apfl<br>
                    Schulstra√üe 7<br>
                    94330 Salching<br>
                    Deutschland<br><br>

                    E-Mail: brennereimanager@gmail.com<br>
                </p>

                <hr>

                <h3>Datenschutz</h3>

                <p>
                    Diese App speichert und verarbeitet alle Daten ausschlie√ülich lokal auf Ihrem Ger√§t.
                    Es findet keine √úbertragung an Server oder Dritte statt.
                    Es erfolgt keine Analyse, Weitergabe oder Cloud-Synchronisation.
                </p>

                <p>Insbesondere werden <strong>nicht</strong> erhoben oder √ºbermittelt:</p>

                <ul>
                    <li>personenbezogene Kundendaten</li>
                    <li>Verkaufs- und Produktionsdaten</li>
                    <li>Standort- oder Nutzungsdaten</li>
                    <li>Steuerdaten</li>
                </ul>

                <p>
                    Der Nutzer ist selbst f√ºr Datensicherung, Export und Archivierung verantwortlich.
                </p>

                <hr>

                <hr>

                <h3>Pers√∂nliches Wort des Entwicklers</h3>

                <p>
                    Diese App ist aus der Praxis entstanden ‚Äì mit dem Wunsch,
                    Brennerinnen und Brennern die t√§gliche Arbeit ein St√ºck einfacher
                    zu machen. Sie soll unterst√ºtzen, entlasten und auch Freude bereiten ‚Äì
                    ohne komplizierte Technik und ohne gro√üen Aufwand.
                </p>

                <p>
                    Ich entwickle diese Software mit viel Sorgfalt und Herzblut.
                    Trotzdem kann es vorkommen, dass etwas noch nicht perfekt funktioniert
                    oder verbessert werden kann.
                </p>

                <p>
                    Wenn Sie Feedback, Verbesserungsvorschl√§ge oder W√ºnsche haben,
                    freue ich mich sehr √ºber eine R√ºckmeldung:
                </p>

                <p>
                    üìß <strong>brennereimanager@gmail.com</strong>
                </p>

                <p>
                    So kann die App Schritt f√ºr Schritt weiter wachsen ‚Äì
                    aus der Praxis, f√ºr die Praxis.
                </p>

                <p>
                    Vielen Dank f√ºr Ihr Vertrauen und viel Freude mit dem Brennereimanager!
                    <br><br>
                    ‚Äî <strong>Alois Apfl</strong>
                </p>

                <hr>


                <h3>Nutzungsbedingungen / Lizenz</h3>

                <p>
                    Die App darf ausschlie√ülich durch den Lizenznehmer genutzt werden.
                    Eine Weitergabe, Vervielf√§ltigung oder der Verkauf an Dritte ist nicht gestattet.
                </p>

                <p>
                    Die Software wird ‚Äûwie gesehen‚Äú bereitgestellt. Es besteht kein Anspruch auf
                    bestimmte Funktionen, dauerhafte Verf√ºgbarkeit oder technische Fehlerfreiheit.
                </p>

                <p>
                    Der Nutzer ist verpflichtet, alle steuer- und betriebsrechtlichen Vorgaben
                    eigenst√§ndig zu erf√ºllen und zu pr√ºfen.
                </p>

                <hr>

                <h3>Haftungsausschluss</h3>

                <p>
                    Diese App ersetzt keine Buchhaltungssoftware und keine Steuerberatung.
                    Alle Berechnungen und Auswertungen dienen ausschlie√ülich der internen Unterst√ºtzung.
                </p>

                <p>
                    F√ºr steuerliche Korrektheit, Datenrichtigkeit sowie rechtliche Pflichten
                    bleibt allein der Nutzer verantwortlich.
                </p>

                <p>
                    Eine Haftung des Entwicklers ist ausgeschlossen, insbesondere f√ºr:
                </p>

                <ul>
                    <li>Steuer- und Abgabenforderungen</li>
                    <li>Bu√ügelder</li>
                    <li>Datenverlust</li>
                    <li>technische Fehler oder Fehlfunktionen</li>
                    <li>falsche Dateneingaben</li>
                    <li>Folgesch√§den</li>
                </ul>

                <p>
                    Ausgenommen sind Sch√§den aus Vorsatz oder Personensch√§den,
                    soweit gesetzlich zwingend.
                </p>

                <hr>

                <h3>Abonnement</h3>

                <p>
                    Die Nutzung der App erfolgt im Rahmen eines zeitlich befristeten Nutzungsrechts
                    (Abonnement). Nach Ablauf des Nutzungszeitraums kann die Funktionalit√§t
                    eingeschr√§nkt werden, sofern keine Verl√§ngerung erfolgt.
                </p>

                <p>
                    Bereits gespeicherte Daten bleiben lokal auf dem Ger√§t bestehen.
                </p>

                <hr>

                <h3>Updates</h3>

                <p>
                    Updates k√∂nnen Funktionen erg√§nzen, ver√§ndern oder entfernen.
                    Ein Anspruch auf bestimmte Funktionen besteht nicht.
                </p>

                <hr>

                <h3>Widerrufshinweis (falls Privatkunden)</h3>

                <p>
                    Sofern gesetzlich vorgesehen, besteht f√ºr Verbraucher ein 14-t√§giges Widerrufsrecht
                    ab dem Kaufdatum. Die genauen Regelungen richten sich nach den gesetzlichen Bestimmungen.
                </p>


                <hr>

                <p style="font-size:0.9em; color:#555;">
                    Stand: <span id="legalDate"></span>
                </p>

            </div>

            <script>
                // Kleines Datum unten automatisch setzen
                const el = document.getElementById("legalDate");
                if (el) el.innerText = new Date().toLocaleDateString();
            </script>



            <!--Hilfeseite-->
            <div id="pageManual" style="display:none; padding:12px; line-height:1.5;">
                <h3>üçá Maische & Protokollierung</h3>

                <p>
                    Diese App unterst√ºtzt dich dabei, deine Maische sauber zu dokumentieren ‚Äì
                    so wie es in der Praxis sinnvoll ist und im Zweifel auch nachvollziehbar bleibt.
                </p>

                <p>
                    Eine Maische ist in der App immer der Ausgangspunkt.
                    Du kannst hier festhalten:
                </p>

                <ul>
                    <li>Obstsorte / Mischung</li>
                    <li>Erntedatum bzw. Einmaischen</li>
                    <li>Menge / Fassungsvolumen</li>
                    <li>Oechsle / G√§rverlauf (optional)</li>
                    <li>Brenndatum</li>
                    <li>Ausbeute</li>
                    <li>Destillatst√§rke (tats√§chlich (20 ¬∞C) oder errechnen)</li>
                </ul>

                <p>
                    Wenn du die Fassdaten gespeichert hast kannst du weiter unten das Fass ausw√§hlen <br>
                    und dann jederzeit Protokollentr√§ge vornehmen<br>
                    So entsteht nach und nach ein vollst√§ndiges Brennprotokoll ‚Äì ohne Papier.
                </p>

                <hr>

                <h4>üìö Archivieren ‚Äì damit nichts verloren geht</h4>

                <p>
                    Du kannst jede Maische nach Abschluss <strong>archivieren</strong>, <br>
                    indem du auf "Fass leeren" klickst, der Brand also vollzogen ist<br>
                    Das ist besonders hilfreich:
                </p>

                <ul>
                    <li>wenn etwas schiefging ‚Äì damit man es sp√§ter versteht</li>
                    <li>wenn es besonders gut gelungen ist ‚Äì damit man es wiederholen kann</li>
                    <li>wenn man seine Arbeit langfristig dokumentieren m√∂chte</li>
                </ul>

                <p>
                    Archivierte Maischen bleiben vollst√§ndig erhalten und sind jederzeit abrufbar.
                </p>

                <hr>

                <h3>üìè Kalkulation ‚Äì zwei Wege, ein Ziel</h3>

                <p>
                    Die App bietet dir zwei grunds√§tzliche M√∂glichkeiten,
                    die Kosten und Preise zu berechnen:
                </p>

                <ol>
                    <li><strong>Fass-Kalkulation</strong> ‚Äì f√ºr einen einzelnen Brand</li>
                    <li><strong>Chargen-Kalkulation</strong> ‚Äì f√ºr Mischungen / mehrere Komponenten</li>
                </ol>

                <p>
                    Beides ist m√∂glich ‚Äì du entscheidest, was zu deinem Betrieb passt.
                </p>

                <hr>

                <h4>ü•É 1Ô∏è‚É£ Fass-Kalkulation</h4>

                <p>
                    Diese Methode nutzt du, wenn ein Brand f√ºr sich alleine steht,
                    z. B.:
                </p>

                <ul>
                    <li>Williams</li>
                    <li>Zwetschge</li>
                    <li>Himbeergeist</li>
                </ul>

                <p>
                    √úbernommen aus den Maischef√§ssern wird bereits:
                </p>

                <ul>
                    <li>Maischemenge</li>
                    <li>Destillatmenge</li>
                    <li>Alkoholgehalt</li>
                    <li>Brenndauer</li>
                </ul>

                <p>
                    Eingeben kannst du dann:
                </p>

                <ul>
                    <li>gew√ºnschte Trinkst√§rke</li>
                    <li>Fixkosten</li>
                    <li>Steuer</li>
                    <li>Materialkosten</li>
                    <li>Flaschenkosten</li>
                    <li>deinen Wunschverkaufspreis</li>
                </ul>

                <p>
                    Die App berechnet daraus automatisch:
                </p>

                <ul>
                    <li>Kosten pro Liter Trinkst√§rke</li>
                    <li>Mindestpreis pro Flasche</li>
                    <li>Deckungsbeitrag</li>
                </ul>

                <p>
                    Diese Werte werden sp√§ter bei Verkauf & Gewinnanalyse verwendet.
                </p>

                <hr>

                <h4>üß™ 2Ô∏è‚É£ Chargen-Kalkulation</h4>

                <p>
                    Diese Methode eignet sich,
                    wenn du mehrere Br√§nde mischst.
                </p>

                <p>
                    Du kannst verschiedene Maischef√§sser w√§hlen,
                    oder archivierte F√§sser
                </p>

                <ul>

                    <li>alles andere ist analog zu der Fasskalkulation</li>
                </ul>


                <p>
                    F√ºr <strong>beide</strong> Arten gilt:
                </p>
                <ul>

                    <li>du kannst die Kalkulation als:</li>
                    <li>Produkt (verd√ºnnt / unverd√ºnnt) speichern</li>
                    <li>direkt in einen Lagerbeh√§lter (verd√ºnnt / unverd√ºnnt) speichern</li>
                    <li>(Lagerbeh√§lter vorher bitte anlegen)</li>
                </ul>

                <p>
                    Die App errechnet:
                </p>

                <ul>
                    <li>Durchschnittskosten</li>
                    <li>Mindestpreise pro Flasche</li>
                    <li>Kalkulatorischen Verkaufspreis</li>
                </ul>

                <p>
                    Damit beh√§ltst du auch bei Mischungen die Kontrolle √ºber die Wirtschaftlichkeit.
                </p>

                <hr>

                <h3>üè∑ Lagerverwaltung & sinnvolle Namen</h3>

                <p>
                    Es ist empfehlenswert,
                    die Lagerbeh√§lter <strong>vor</strong> der Einlagerung der Destillate in der App anzulegen.
                </p>

                <p>
                    Am besten gibst du ihnen dabei
                    einen Namen, der dem Inhalt entspricht, z. B.:
                </p>

                <ul>
                    <li>‚ÄûWilliams 2025‚Äú</li>
                    <li>‚ÄûZwetschge Fass Nr. 3‚Äú</li>
                    <li>‚ÄûObstler Tank 500 L‚Äú</li>
                </ul>

                <p>
                    Das hat zwei Vorteile:
                </p>

                <ul>
                    <li>du findest dein Produkt sp√§ter schneller</li>
                    <li>der Name kann automatisch f√ºr Verk√§ufe & Rechnungen genutzt werden</li>
                </ul>

                <p>
                    Also: klare Bezeichnungen = klare √úbersicht ‚úî
                </p>

                <p>
                    Wenn du vorher lediglich ein Produkt erzeugt hast, kannst du hier <br>
                    in einen Lagerbeh√§lter ein solches Produkt hinzuf√ºgen.<br>
                    Du kannst hier auch:
                </p>

                <ul>
                    <li>von einem Beh√§lter in einen anderen umsch√ºtten</li>
                    <li>aus mehreren Beh√§ltern in einen zusammensch√ºtten</li>
                    <li>auf Trinkst√§rke setzen (erforderliche Wassermenge wird angezeigt)</li>
                </ul>

                <hr>

                <h3>üì¶ Vom Fass zur Flasche</h3>

                <p>
                    Wenn du Trinkst√§rke abf√ºllst,
                    merkt sich die App:
                </p>

                <ul>
                    <li>welches Produkt</li>
                    <li>welche Flaschengr√∂√üe</li>
                    <li>wie viele St√ºck</li>
                    <li>welcher Lagerort</li>
                    <li>Mindest- & Verkaufspreis</li>
                </ul>

                <p>
                    Der Bestand wird automatisch gef√ºhrt.
                    Bei Verkauf reduziert er sich.
                </p>

                <p>
                    Du kannst also jederzeit nachsehen:
                </p>

                <ul>
                    <li>Was ist wo?</li>
                    <li>Wie viele Flaschen habe ich noch?</li>
                    <li>Zu welchem Mindestpreis?</li>
                </ul>

                <hr>

                <h3>üß™ Rezepte / Mischungen</h3>

                <p>
                    Auf dieser Seite kannst du 3 Rezepttypen erstellen<br>
                    In der linken Spalte tr√§gst du den Rezeptnamen ein und w√§hlst den Rezepttyp aus<br>
                    In der rechten Spalte kannst du die Rezepte nach Rezepttyp ausw√§hlen, bearteiten usw.<br>
                </p>
                <h4>üìå Prozent-Rezept (f√ºr Obstler)</h4>
                <p>
                    Hier mischst du Destillate, die du bereits hast, in Prozentanteilen.<br>
                    Also z. B. <strong>anteilig:</strong><br>
                    20 % Zwetschenbrand; 60 % Birnenbrand; 40 % Apfelbrand<br>
                    Die Summe muss 100 % ergeben.
                </p>

                <h4>üåø Aroma / Gewichtungsrezept (f√ºr Gin oder Kr√§uter)</h4>
                <p>
                    Bei diesem Rezepttyp vergibst du Gewichts- bzw. Aroma-Anteile
                    zu verschiedenen Zutaten. Es geht also nur um die Mischungsverh√§ltnisse.<br>
                    Wichtig: Die Summe der Anteile muss <strong>nicht</strong> 100 % ergeben ‚Äì
                    entscheidend ist nur das Verh√§ltnis der Zutaten zueinander.<br>
                    Beispiel:<br>
                    5 Anteile Wacholder; 1 Anteil Zimt; 2 Anteile Orangenschale usw.
                </p>
                <p>
                    Hinweis:<br>
                    Wenn du die Zutaten vorab √ºber die Ausgaben-Seite erfasst hast,
                    werden sie bei der sp√§teren Produktion automatisch vom Lagerbestand
                    abgezogen. So beh√§ltst du jederzeit einen aktuellen √úberblick √ºber dein Lager.
                    Zus√§tzlich kannst du bei Aroma- und Maischerezepten direkt aus der rechten Spalte
                    zur Produktionsseite wechseln.
                </p>


                <h4>üåæ Maischerezept (Malz / Whisky)</h4>
                <p>
                    Hier verwaltest du Getreide- und Malzanteile zueinander. √Ñhnlich wie bei den Aromarezepten.<br>
                    Beispiel:<br>
                    5 Anteile Pilsner Malz; 3 Anteil Wiener Malz; 2 Anteile M√ºnchner Malz
                </p>
                <p>
                    Hinweis:<br>
                    Auch hier gilt: Wenn du die Zutaten vorab √ºber die Ausgaben-Seite erfasst hast,
                    werden sie bei der sp√§teren Produktion automatisch vom Lagerbestand
                    abgezogen. So beh√§ltst du jederzeit einen aktuellen √úberblick √ºber dein Lager.
                    Zus√§tzlich kannst du bei Aroma- und Maischerezepten direkt aus der rechten Spalte
                    zur Produktionsseite wechseln.
                </p>


                <h3>üìí Warum Dokumentation sinnvoll ist</h3>

                <p>
                    Die App hilft dir,
                    die Abl√§ufe in deiner Brennerei transparent zu machen:
                </p>

                <ul>
                    <li>Nachvollziehbarkeit</li>
                    <li>Kostenbewusstsein</li>
                    <li>Vergleichbarkeit zwischen Jahren</li>
                    <li>Sicherheit bei Nachfragen</li>
                </ul>

                <p>
                    Und ganz ehrlich:
                    Ordnung schafft Ruhe üòä
                </p>
            </div>




























        </main>

        <footer>
            <p>¬© <span id="year"></span> Brennereimanager ‚Äî Handwerk trifft Pr√§zision</p>
            <p class="version">Version 1.6 ‚Ä¢ Kupfer & Edelstahl Edition</p>
        </footer>

        <script>
            // aktuelles Jahr automatisch einf√ºgen
            document.getElementById("year").textContent = new Date().getFullYear();
        </script>


        <footer>
            ‚ÄûIm Geist des Feuers, mit Wasser gez√§hmt ‚Äì so wird der Brand zur Freude.‚Äú
        </footer>

        <!-- jsPDF -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <!-- Tabellen-Plugin -->
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
        <!-- FileSaver -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
        <!-- Excel-Export (SheetJS) -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>



        <script>
            // ===============================================
            // Deutsche Status-Texte & Farben
            // ===============================================
            const CASK_STATUS_MAP = {
                "empty": { text: "Leer", color: "#b33" },  // Rot
                "in_use": { text: "In Verwendung", color: "#3a7" },  // Gr√ºn
                "aging": { text: "Reifung", color: "#e8a600" }, // Gold / Bernstein
                "archived": { text: "Archiviert", color: "#777" },  // Grau
                "finished": { text: "Abgeschlossen", color: "#555" }   // Dunkelgrau
            };


            // Automatische Korrektur nur starten,
            // wenn der Benutzer in MESSWERT-FELDERN tippt (Volume / Strength / Temp)
            ["raw", "fine"].forEach(prefix => {

                // MESSFELDER ‚Üí starten automatische Berechnung
                ["MeasVolume", "MeasStrength", "MeasTemp"].forEach(field => {
                    const el = document.getElementById(prefix + field);
                    if (el) {
                        el.addEventListener("input", () => {
                            distillUpdateCorrection(prefix);
                        });
                    }
                });

                // KORRIGIERTE FELDER ‚Üí d√ºrfen NICHT √ºberschrieben werden
                ["CorrVolume", "CorrStrength"].forEach(field => {
                    const el = document.getElementById(prefix + field);
                    if (el) {
                        el.addEventListener("input", () => {
                            // Wenn Benutzer hier schreibt: Automatik ignorieren!
                            // Wir tun NICHTS. Wichtig ist nur, dass keine andere Logik l√§uft.
                        });
                    }
                });

            });


            // Globale Statusflags f√ºr Aroma-Rohstofflogik
            window.aromaMaterialCheckDone = false;     // Wurde die Pr√ºfung schon durchgef√ºhrt?
            window.aromaMaterialsConsumed = false;     // Wurden dabei automatisch abgebucht?


            // ==============================
            // üîπ GLOBALE ZUST√ÑNDE
            // ==============================

            window.currentSaleBottlingId = null;

            // üßæ Aktuelle Rechnungs-Sammelliste (Warenkorb)
            window.currentInvoiceDraft = {
                saleIds: []
            };



            window.i18n = {
                de: {
                    expenses: {
                        title: "üìâ Ausgabenverwaltung",
                        save: "üíæ Ausgabe speichern",
                        delete: "üóëÔ∏è Ausgaben l√∂schen",
                        export: "üì§ Als Excel exportieren",
                        materials: "üì¶ Rohstofflager",
                        noMaterials: "Noch keine Rohstoffe angelegt."
                    },
                    common: {
                        save: "üíæ Speichern",
                        cancel: "Abbrechen",
                        delete: "L√∂schen"
                    }
                },

                en: {
                    expenses: {
                        title: "üìâ Expense management",
                        save: "üíæ Save expense",
                        delete: "üóëÔ∏è Delete expenses",
                        export: "üì§ Export to Excel",
                        materials: "üì¶ Material stock",
                        noMaterials: "No materials created yet."
                    },
                    common: {
                        save: "üíæ Save",
                        cancel: "Cancel",
                        delete: "Delete"
                    }
                }
            };

            window.currentLang = localStorage.getItem("lang") || "de";


            function t(key) {
                const parts = key.split(".");
                let obj = window.i18n[window.currentLang];

                for (const p of parts) {
                    if (!obj || typeof obj !== "object") return key;
                    obj = obj[p];
                }

                return obj || key;
            }




            // Aktueller Modus f√ºr Chargen-Lagerung: "raw" oder "diluted"
            let currentBatchStorageMode = "raw";
            // Kontext f√ºr "Rezept auf Lager anwenden" (Schritt 1 -> Schritt 2)
            window.currentRecipeApplyCtx = null;

            // üõí Aktueller Warenkorb (Verkaufs-Entw√ºrfe)
            window.currentSalesDraft = [];





            window.showPage = function (page) {
                const inv = document.getElementById("pageInvoiceView");
                if (inv) inv.style.display = "none";

                closeInvoiceView();
                // Alle bekannten Seiten
                const pages = [
                    "pageTheory",
                    "pagePractice",
                    "pageBarrels",
                    "pageCalc",
                    "pageBatchCalc",
                    "pageLiqueur",
                    "pageCorrection",
                    "pageBarrelCalc",
                    "pageArchive",
                    "pageStorage",
                    "pageSales",
                    "pageExpenses",
                    "pageFinance",
                    "pageRecipes",
                    "pageProduction",
                    "pageBatches",
                    "pageCasks",
                    "pageRunSheets",
                    "pageBottlings",
                    "pageSellBottlings",
                    "pageSalesList",
                    "pageCreateInvoice",
                    "pageInvoices",
                    "pageInvoiceView",
                    "pageSellerProfile",
                    "pageCustomers",
                    "pageCreateInvoice",
                    "pageVatOverview",
                    "pageInvoicePrint",
                    "pageProfitAnalysis",
                    "pageLegal",
                    "pageManual"
                ];



                // üîπ Zuerst alle Seiten ausblenden
                pages.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = "none";
                });


                const dlg = document.getElementById("barrelStorageDialog");
                if (dlg) dlg.style.display = "none";


                // üîπ Die gew√§hlte Seite anzeigen
                const targetId = "page" + page.charAt(0).toUpperCase() + page.slice(1);
                const target = document.getElementById(targetId);
                if (target) target.style.display = "block";

                // Welches Feld soll beim √ñffnen welcher Seite fokussiert werden?
                const pageFocusMap = {
                    theory: "type",
                    practice: "diluteVolume",
                    barrels: "barrelSelectDropdown",
                    calc: "calcBarrelSelect",
                    batchCalc: "batchBarrelList",
                    liqueur: "liqSolveMode",
                    barrelCalc: "calcBarrelType",
                    archive: null,            // kein Eingabefeld auf dieser Seite
                    storage: "storageSelect",
                    recipes: "recipeName",
                    production: "prodRecipeSelect",
                    batches: "batchRecipeSelect",
                    sales: "saleStorage",
                    expenses: "expenseDate",
                    correction: "corrMeasuredAlc",
                    finance: "financeMonth",
                    createInvoice: "invoiceCustomerSearch",
                    profitAnalysis: "gaDateFrom"
                };


                // ‚≠ê Sicheres Auto-Scroll + Fokus setzen
                setTimeout(() => {

                    // -----------------------
                    // Scrollbereich pr√ºfen
                    // -----------------------
                    if (target && typeof target.scrollIntoView === "function") {
                        try {
                            target.scrollIntoView({ behavior: "smooth", block: "start" });
                        } catch (e) {
                            console.warn("ScrollIntoView fehlgeschlagen:", e);
                        }
                    }

                    // -----------------------
                    // Fokus setzen
                    // -----------------------
                    const focusId = pageFocusMap[page];
                    if (focusId) {
                        const el = document.getElementById(focusId);
                        if (el) el.focus();
                    }

                }, 80);



                // üîπ Seiten-spezifische Initialisierungen
                switch (page) {
                    case "barrels":
                        loadBarrelData();
                        break;

                    case "calc":
                        initCalcPage();
                        break;

                    case "batchCalc":
                        initBatchPage();
                        fillBatchBarrelList();
                        break;

                    case "liqueur":
                        liqr_calc();
                        break;

                    case "storage":
                        updateStorageDropdown();
                        updateArchiveDropdown();
                        break;

                    case "sales":
                        updateSaleDropdown();

                        loadSaleSources();
                        break;

                    case "archive":
                        loadArchiveList();
                        break;

                    case "expenses":
                        initExpenseFilters();   // Filter-Dropdowns bef√ºllen
                        updateExpenseList();    // üí° Liste direkt anzeigen
                        materialAutoImportFromRecipes();
                        renderMaterialList();
                        break;


                    case "finance":
                        initFinanceFilters();
                        updateFinanceOverview();
                        break;

                    case "recipes":
                        initRecipeModule();
                        break;

                    case "production":
                        initProductionPage();
                        break;

                    case "batches":
                        initBatchProductionPage(); // üëà richtige Funktion
                        batchFillDropdown();
                        updateBatchStartButton();
                        break;

                    case "casks":
                        initCaskPage();
                        break;

                    case "mashBatch":
                        initMashBatchPage();
                        break;

                    case "runSheets":
                        loadRunSheetList();   // ‚≠ê Tabelle aufbauen
                        break;

                    case "bottlings":
                        renderBottlingsTable();
                        break;

                    case "sellBottlings":
                        loadSellBottling();
                        break;

                    case "salesList":
                        renderSalesList();
                        break;

                    case "createInvoice":
                        // Anzeige der aktuellen Rechnungspositionen
                        renderInvoiceDraftList();
                        break;


                    case "invoices":
                        renderInvoicesList();
                        break;

                    case "sellerProfile":
                        loadSellerProfile();
                        break;

                    case "customers":
                        renderCustomersList();
                        break;

                    case "vatOverview":
                        populateVatYearSelect();
                        renderVatOverview();
                        break;

                    case "expenses":
                        document.getElementById("expensesTitle").textContent =
                            t("expenses.title");
                        document.getElementById("btnSaveExpense").textContent =
                            t("expenses.save");
                        break;

                    case "profitAnalysis":
                        gaInitFilters();   // Filter (Dropdowns + Datum) setzen
                        break;

                    default:
                        // keine spezielle Aktion n√∂tig
                        break;
                }

                // Lik√∂rseite
                if (page === "liqueur")
                    showStorageCheckBox("pageLiqueur");

                // Fasskalkulation
                if (page === "calc")
                    showStorageCheckBox("pageCalc");

                // Chargenkalkulation
                if (page === "batchCalc")
                    showStorageCheckBox("pageBatchCalc");

                if (page === "production")
                    showStorageCheckBox("pageProduction");

            };






            // --- Erweiterung: Automatischer Fokus f√ºr bestimmte Seiten ---
            function afterShowPage(pageId) {
                if (pageId === "calc") {
                    setTimeout(() => {
                        const page = document.getElementById("pageCalc");
                        if (page) {
                            page.scrollIntoView({ behavior: "smooth", block: "start" });
                        }

                        const firstField = document.getElementById("calcBarrelSelect");
                        if (firstField) {
                            firstField.focus();
                        }
                    }, 50);
                }
            }




            // Flags oben im Skript platzieren:
            let isBatchActualVolUserModified = false;
            let isBatchActualAbvUserModified = false;

            document.getElementById("batchActualVolumeL").addEventListener("input", () => {
                isBatchActualVolUserModified = true;
            });
            document.getElementById("batchActualAbv").addEventListener("input", () => {
                isBatchActualAbvUserModified = true;
            });

            let isBatchHoursUserModified = false;
            document.getElementById("batchHours").addEventListener("input", () => {
                isBatchHoursUserModified = true;
            });




            const TAX_RATE = 10.22; // Anzeige & Kalkulation in Fass-Kalkulation

            const fruits = {
                liter: {
                    "√Ñpfel (3,6)": 3.6,
                    "Apfelmost/-saft (3,6)": 3.6,
                    "Apfel-Verarbeitungsr√ºckst√§nde (1,5)": 1.5,
                    "Apfelwein (3,6)": 3.6,
                    "Apfelweinhefe (2,5)": 2.5,
                    "Aprikosen (einschlie√ülich Mirakosen) (3,5)": 3.5,
                    "Aprikosenmost/-saft (5)": 5,
                    "Aroniabeeren (3)": 3,
                    "Aroniabeerensaft/-most (3)": 3,
                    "Aroniabeereweinr√ºckst√§nde (einschlie√ülich Trester) (3)": 3,
                    "Aroniabeerenwein (3)": 3,
                    "Aroniabeerenweinhefe (3)": 3,
                    "Birnen (3,6)": 3.6,
                    "Birnenmost/-saft (3,6)": 3.6,
                    "Birnen-Verarbeitungsr√ºckst√§nde (1,5)": 1.5,
                    "Birnenwein (3,6)": 3.6,
                    "Birnenweinhefe (2,5)": 2.5,
                    "Brombeeren (2)": 2,
                    "Brombeermost/-saft (4)": 4,
                    "Brombeerwein (4)": 4,
                    "Brombeerweinhefe (2)": 2,
                    "Brombeerweinr√ºckst√§nde (einschlie√ülich Trester) (2)": 2,
                    "Erdbeeren (2)": 2,
                    "Erdbeermost/-saft (4)": 4,
                    "Erdbeerwein (4)": 4,
                    "Erdbeerweinhefe (2)": 2,
                    "Erdbeerweinr√ºckst√§nde (einschlie√ülich Trester) (2)": 2,
                    "Feigen (3,3)": 3.3,
                    "Feuerdorn (3,6)": 3.6,
                    "Haferschlehen (3,5)": 3.5,
                    "Hagebutten (2)": 2,
                    "Hagebuttenwein (4)": 4,
                    "Hagebuttenweinhefe (2)": 2,
                    "Hagebuttenweinr√ºckst√§nde (einschlie√ülich Trester) (2)": 2,
                    "Heidelbeeren (einschlie√ülich Preiselbeeren) (2)": 2,
                    "Heidelbeermost/-saft (4)": 4,
                    "Heidelbeerwein (4)": 4,
                    "Heidelbeerweinhefe (2)": 2,
                    "Heidelbeerweinr√ºckst√§nde (einschlie√ülich Trester) (2)": 2,
                    "Himbeeren (2)": 2,
                    "Himbeermost/-saft (4)": 4,
                    "Himbeerwein (4)": 4,
                    "Himbeerweinhefe (2)": 2,
                    "Himbeerweinr√ºckst√§nde (einschlie√ülich Trester) (2)": 2,
                    "Holunder (2)": 2,
                    "Holundermost/-saft (4)": 4,
                    "Holunderwein (4)": 4,
                    "Holunderweinhefe (2)": 2,
                    "Holunderweinr√ºckst√§nde (einschlie√ülich Trester) (2)": 2,
                    "Johannisbeeren (einschlie√ülich Stachelbeere und Jostabeere) (2)": 2,
                    "Johannisbeermost/-saft (4)": 4,
                    "Johannisbeerwein (4)": 4,
                    "Johannisbeerweinhefe (2)": 2,
                    "Johannisbeerweinr√ºckst√§nde (einschlie√ülich Trester) (2)": 2,
                    "Kirschen (au√üer Sauerkirschen und Traubenkirschen) (5)": 5,
                    "Kirschmost/-saft (5)": 5,
                    "Kirschwein (5)": 5,
                    "Kirschweinhefe (3)": 3,
                    "Kirschweinr√ºckst√§nde (einschlie√ülich Trester) (3)": 3,
                    "Kirschpflaumen (3,5)": 3.5,
                    "Kiwis (3)": 3,
                    "Kornelkirschen (3,5)": 3.5,
                    "Maulbeeren (2)": 2,
                    "Mehlbeeren (einschlie√ülich Vogelbeere und Speierling) (2)": 2,
                    "Mehlbeermost/-saft (4)": 4,
                    "Mehlbeerwein (4)": 4,
                    "Mehlbeerweinhefe (2)": 2,
                    "Mehlbeerweinr√ºckst√§nde (einschlie√ülich Trester) (2)": 2,
                    "Mirabellen (4,8)": 4.8,
                    "Mirabellenmost/-saft (5)": 5,
                    "Mirabellenwein (5)": 5,
                    "Mirabellenweinr√ºckst√§nde (einschlie√ülich Trester) (3)": 3,
                    "Mispeln (2,6)": 2.6,
                    "Pfirsiche (einschl. Nektarinen) (3,5)": 3.5,
                    "Pfirsichmost/-saft (5)": 5,
                    "Pfirsichwein (5)": 5,
                    "Pfirsichweinhefe (3)": 3,
                    "Pfirsichweinr√ºckst√§nde (einschl. Trester) (3)": 3,
                    "Pflaumen (einschlie√ülich Renekloden, au√üer Mirabellen und Zwetschgen) (3,9)": 3.9,
                    "Pflaumenmost/-saft (5)": 5,
                    "Pflaumenwein (5)": 5,
                    "Pflaumenweinhefe (3)": 3,
                    "Pflaumenweinr√ºckst√§nde (einschlie√ülich Trester) (3)": 3,
                    "Physalis (3,5)": 3.5,
                    "Quitten (2,6)": 2.6,
                    "Quittenmost/-saft (2,6)": 2.6,
                    "Quitten-Verarbeitungsr√ºckst√§nde (1,5)": 1.5,
                    "Quittenwein (2,6)": 2.6,
                    "Quittenweinhefe (2,5)": 2.5,
                    "Rotdorn (3,6)": 3.6,
                    "Sanddorn (2)": 2,
                    "Sauerkirschen (3,5)": 3.5,
                    "Sauerkirschmost/-saft (5)": 5,
                    "Sauerkirschwein (5)": 5,
                    "Sauerkirschweinhefe (3)": 3,
                    "Sauerkirschweinr√ºckst√§nde (einschlie√ülich Trester) (3)": 3,
                    "Scharlachdorn (3,6)": 3.6,
                    "Schlehen (au√üer Haferschlehen) (2)": 2,
                    "Schlehenmost/-saft (5)": 5,
                    "Traubenkirschen (3,5)": 3.5,
                    "Trauben, Weintrauben (5)": 5,
                    "Traubenmost/-saft (6)": 6,
                    "Traubenwein (6)": 6,
                    "Traubenweinhefe (Trub) (6)": 6,
                    "Traubenweinr√ºckst√§nde (Trester), h√∂chstzul√§ssig ausgepresst (2)": 2,
                    "Gemisch Trester und Traubenweinhefe 80/20 (2,8)": 2.8,
                    "Wacholderbeeren (2)": 2,
                    "Wacholderbeermost/-saft (4)": 4,
                    "Wacholderbeerwein (4)": 4,
                    "Wacholderbeerweinhefe (2)": 2,
                    "Wacholderbeerweinr√ºckst√§nde (einschlie√ülich Trester) (2)": 2,
                    "Wei√üdorn (3,6)": 3.6,
                    "Zibarten (3,5)": 3.5,
                    "Zibartenmost/-saft (5)": 5,
                    "Zwetschgen (4,6)": 4.6,
                    "Zwetschgenmost/-saft (5)": 5,
                    "Enzianwurzeln (2)": 2,
                    "Ingwerwurzeln (2)": 2,
                    "Kalmuswurzeln (2)": 2,
                    "S√º√ükartoffel (3)": 3,
                    "Topinambur (4,6)": 4.6,
                    "Honig mit Ursprung in der EU i.S.d. Anlage 1 HonigV  (9,3)": 9.3,
                    "Bier bis einschlie√ülich 13 Grad Plato (4)": 4,
                    "Bier von √ºber 13 Grad Plato bis einschlie√ülich 20 Grad Plato (5)": 5,
                    "Bier √ºber 20 Grad Plato (7,5)": 7.5,
                    "Bierr√ºckst√§nde (einschlie√ülich Bierhefe) (2)": 2,
                },
                kg: {
                    "Buchweizen (26)": 26,
                    "Dinkel (26)": 26,
                    "Einkorn (26)": 26,
                    "Emmer (26)": 26,
                    "Gerste (26)": 26,
                    "Hafer (26)": 26,
                    "Hirse (26)": 26,
                    "Mais (26)": 26,
                    "Malz, zur Verzuckerung der Maische 3) (¬ß 24 Abs. 3 AlkStV) (26)": 26,
                    "Roggen (26)": 26,
                    "Triticale (26)": 26,
                    "Weizen (26)": 26,
                    "W√ºrze aus gem√§lztem Getreide 3) bis einschlie√ülich 13 Grad Plato (4)": 4,
                    "W√ºrze aus gem√§lztem Getreide 3) von √ºber 13 Grad Plato bis einschlie√ülich 20 Grad Plato (5)": 5,
                    "W√ºrze aus gem√§lztem Getreide 3) √ºber 20 Grad Plato (7,5)": 7.5,
                    "Kartoffeln, nicht getrocknet (7)": 7,

                }
            };



            function storageGetCurrentVolume(storage) {
                if (!storage || !Array.isArray(storage.contents)) return 0;
                return storage.contents.reduce((sum, c) => sum + (parseFloat(c.volume) || 0), 0);
            }




            // ===== Theorie =====
            function updateFruits() {
                const type = document.getElementById("type").value;
                const fruitSelect = document.getElementById("fruit");
                fruitSelect.innerHTML = "";
                for (const name in fruits[type]) {
                    const opt = document.createElement("option");
                    opt.value = fruits[type][name];
                    opt.text = name;
                    fruitSelect.appendChild(opt);
                }
            }

            function calculate() {
                const type = document.getElementById("type").value;
                const yieldVal = parseFloat(document.getElementById("fruit").value);
                const amount = parseFloat(document.getElementById("amount").value);
                const strength = parseFloat(document.getElementById("strength").value);
                if (isNaN(yieldVal) || isNaN(amount) || isNaN(strength)) {
                    document.getElementById("output").innerHTML = "Bitte alle Felder korrekt ausf√ºllen."; return;
                }
                const pureAlcohol = amount * (yieldVal / 100);
                const tax = pureAlcohol * TAX_RATE;
                const finalVolume = pureAlcohol / (strength / 100);
                const water = finalVolume - pureAlcohol;
                document.getElementById("output").innerHTML =
                    `Reinalkohol: <strong>${pureAlcohol.toFixed(2)} L</strong><br>
                    Alkoholsteuer: <strong>${tax.toFixed(2)} ‚Ç¨</strong><br>
                    Wasserzugabe: <strong>${water.toFixed(2)} L</strong><br>
                    Endmenge bei ${strength}%: <strong>${finalVolume.toFixed(2)} L</strong>`;
                // ‚ùó Oechsle-Vergleich NUR anzeigen, wenn Obst (Liter) ausgew√§hlt ist
                if (type === "liter") {
                    showComparison();
                } else {
                    // Wenn mehlige Stoffe ‚Üí Vergleich ausblenden
                    const cmp = document.getElementById("comparisonOutput");
                    if (cmp) cmp.style.display = "none";
                }
            }

            // ===== Oechsle -> Erwarteter Alkohol (f√ºr Theorie-Seite) =====
            function calculateExpectedAlcoholTheory() {
                const oechsleInput = parseFloat(document.getElementById("theoryOechsle").value);
                const volumeInput = parseFloat(document.getElementById("amount").value);
                const output = document.getElementById("expectedAlcoholOutput");

                if (!output) return;

                if (isNaN(oechsleInput) || isNaN(volumeInput) || oechsleInput <= 0 || volumeInput <= 0) {
                    output.style.display = "none";
                    return;
                }

                // Berechnung wie bei G√§rf√§ssern
                const density = 1 + oechsleInput / 1000;
                const sugar = oechsleInput * 2.6;
                const alcPercent = oechsleInput * 0.129; // empirisch erprobt
                const alcPure = (alcPercent / 100) * volumeInput;

                output.style.display = "block";
                output.innerHTML = `
                    <strong>Berechnung aus ${oechsleInput.toFixed(0)} ¬∞Oe</strong><br>
                    Zucker: ${sugar.toFixed(0)} g/L<br>
                    Alkoholpotenzial: ${alcPercent.toFixed(1)} % Vol.<br>
                    Reinalkohol (theoretisch): <strong>${alcPure.toFixed(2)} L</strong>
                `;
                showComparison();
            }



            function calculateDilution() {
                const volume = parseFloat(document.getElementById("diluteVolume").value);
                const strength = parseFloat(document.getElementById("diluteStrength").value);
                const target = parseFloat(document.getElementById("diluteTarget").value);
                if (isNaN(volume) || isNaN(strength) || isNaN(target)) {
                    document.getElementById("dilutionOutput").innerHTML = "Bitte alle Felder korrekt ausf√ºllen."; return;
                }
                if (target >= strength) {
                    document.getElementById("dilutionOutput").innerHTML = "Die gew√ºnschte Trinkst√§rke muss niedriger sein."; return;
                }
                const pureAlcohol = volume * (strength / 100);
                const finalVolume = pureAlcohol / (target / 100);
                const waterToAdd = finalVolume - volume;
                document.getElementById("dilutionOutput").innerHTML =
                    `Wasserzugabe: <strong>${waterToAdd.toFixed(2)} L</strong><br>
                    Endmenge bei ${target}%: <strong>${finalVolume.toFixed(2)} L</strong>`;
            }

            // ===== cm -> Liter =====
            function interpolate(height, table) {
                for (let i = 0; i < table.length - 1; i++) {
                    if (height >= table[i] && height <= table[i + 1]) {
                        const ratio = (height - table[i]) / (table[i + 1] - table[i]);
                        return litersTbl[i] + ratio * (litersTbl[i + 1] - litersTbl[i]);
                    }
                }
                return null;
            }

            // ===== Oechsle -> Erwartung =====
            function calculateExpectedAlcohol() {
                const oechsleInput = document.getElementById("barrelOechsle");
                const volumeInput = document.getElementById("barrelVolumeFixed");
                const output = document.getElementById("barrelExpectedAlcoholOutput");

                if (!oechsleInput || !volumeInput || !output) return;

                // Werte auslesen
                const oechsle = parseFloat(oechsleInput.value);
                const volume = parseFloat(volumeInput.value);

                // Wenn keine g√ºltigen Zahlen da sind ‚Üí Feld leeren
                if (isNaN(oechsle) || isNaN(volume)) {
                    output.innerHTML = "<em>Bitte Werte eingeben‚Ä¶</em>";
                    return;
                }

                // Dichte aus Oechsle (100 ¬∞Oe = 1.100 g/ml)
                const density = 1 + oechsle / 1000;

                // Zucker in g/L (Faustformel)
                const sugar = oechsle * 2.6;

                // Alkoholpotenzial (empirische Formel ‚Äì sehr praxistauglich)
                const alcPercent = oechsle * 0.129;

                // Reinalkohol
                const alcPure = (alcPercent / 100) * volume;

                // Ausgabe
                output.innerHTML = `
                    <div>
                        <strong>Berechnung aus ${oechsle.toFixed(0)} ¬∞Oe</strong><br>
                        Zucker: ${sugar.toFixed(0)} g/L<br>
                        Alkoholpotenzial: ${alcPercent.toFixed(1)} %vol<br>
                        Reinalkohol (berechnet): <strong>${alcPure.toFixed(2)} L AA</strong>
                    </div>
                `;
            }


            // ===== Vergleich: Zoll-Ausbeute vs. Oechsle-Berechnung =====
            function showComparison() {
                const type = document.getElementById("type").value;

                // ‚ùó Bei mehligen Stoffen Vergleich abschalten
                if (type === "kg") {
                    const out = document.getElementById("comparisonOutput");
                    if (out) out.style.display = "none";
                    return;
                }

                const targetAbv = parseFloat(document.getElementById("strength").value);
                const amount = parseFloat(document.getElementById("amount").value);
                const oechsle = parseFloat(document.getElementById("theoryOechsle").value);
                const fruitSelect = document.getElementById("fruit");
                const fruitName = fruitSelect ? fruitSelect.options[fruitSelect.selectedIndex].text : "";
                const output = document.getElementById("comparisonOutput");

                if (!output || isNaN(amount) || amount <= 0 || isNaN(targetAbv) || targetAbv <= 0) {
                    output.style.display = "none";
                    return;
                }

                // üîπ Zoll-Ertrag (Liter RA je 100 L Maische)
                let yieldLiter = null;
                for (const cat of Object.values(fruits)) {
                    if (fruitName && fruitName in cat) {
                        yieldLiter = cat[fruitName];
                        break;
                    }
                }

                if (!yieldLiter) {
                    output.style.display = "none";
                    return;
                }

                // üî∏ Reinalkohol laut Zoll
                const alcZoll = (amount / 100) * yieldLiter;

                // üî∏ Reinalkohol aus Oechsle (theoretisch)
                const alcOechsle = !isNaN(oechsle)
                    ? (oechsle * 0.129 / 100) * amount
                    : null;

                // üî∏ Umrechnung auf Trinkst√§rke (REINALKOHOL-WELT)
                function calcDilution(alcLiters, targetAbv) {
                    if (!alcLiters || alcLiters <= 0) return { endVol: 0, water: 0 };
                    const endVol = alcLiters / (targetAbv / 100);
                    const water = endVol - alcLiters;
                    return { endVol, water };
                }

                const zollData = calcDilution(alcZoll, targetAbv);
                const oechsleData = calcDilution(alcOechsle, targetAbv);

                // üî∏ Ausgabe formatieren
                let html = `
        <h4>üìä Vergleich: Zoll vs. Oechsle</h4>
        <table style="width:100%; border-collapse:collapse; text-align:center;">
            <tr style="background:#eef;">
                <th>Quelle</th>
                <th>Reinalkohol (L)</th>
                <th>Wasser (L)</th>
                <th>Endmenge bei ${targetAbv}%</th>
            </tr>
            <tr>
                <td><strong>Zoll-Ausbeute</strong></td>
                <td>${alcZoll.toFixed(2)}</td>
                <td>${zollData.water.toFixed(2)}</td>
                <td>${zollData.endVol.toFixed(2)}</td>
            </tr>
            <tr>
                <td><strong>Oechsle-Berechnung</strong></td>
                <td>${isNaN(alcOechsle) ? "‚Äì" : alcOechsle.toFixed(2)}</td>
                <td>${isNaN(oechsleData.water) ? "‚Äì" : oechsleData.water.toFixed(2)}</td>
                <td>${isNaN(oechsleData.endVol) ? "‚Äì" : oechsleData.endVol.toFixed(2)}</td>
            </tr>
        </table>
    `;

                output.innerHTML = html + `
        <p style="
            margin-top:10px;
            font-size:0.9em;
            color:#444;
            background:#fffdf5;
            border-left:4px solid #b87333;
            padding:8px 10px;
            border-radius:6px;
        ">
            üí° <strong>Hinweis:</strong> Diese Tabelle arbeitet mit
            Reinalkohol (100&nbsp;%). Die Oechsle-Berechnung zeigt den
            theoretisch m√∂glichen Alkoholgehalt. Die Zoll-Ausbeute entspricht
            dem amtlich anerkannten Ertrag f√ºr die Steuerberechnung.
        </p>
    `;

                output.style.display = "block";
            }



            // ===== Fassverwaltung =====
            function initBarrelPage() {
                const fruitSelect = document.getElementById("barrelFruit");
                const allFruits = { ...fruits.liter, ...fruits.kg };
                fruitSelect.innerHTML = "";
                for (const name in allFruits) {
                    const opt = document.createElement("option");
                    opt.value = name;
                    opt.text = name;
                    fruitSelect.appendChild(opt);
                }
                loadBarrelList();
                loadBarrelData();
                updateBarrelDropdown();
            }

            // ---- F√§sser speichern / laden ----
            function saveBarrel() {
                const id = document.getElementById("barrelNumber").value.trim();
                if (!id) {
                    alert("Bitte eine Fassnummer eingeben!");
                    return;
                }

                const fruit = document.getElementById("barrelFruit").value.trim();
                const start = document.getElementById("barrelStart").value;

                // Nur Frucht & Startdatum sind Pflicht
                if (!fruit || !start) {
                    alert("Bitte Frucht und Startdatum eingeben.");
                    return;
                }

                // G√§rdauer optional
                const daysInput = document.getElementById("barrelDays").value;
                const days = daysInput ? parseInt(daysInput) : null;

                let endDate = "";
                if (!isNaN(days) && days > 0) {
                    const tmpDate = new Date(start);
                    tmpDate.setDate(tmpDate.getDate() + days);
                    endDate = tmpDate.toISOString().split("T")[0];
                }

                const volume = parseFloat(document.getElementById("barrelVolumeFixed").value) || null;
                const oechsle = parseFloat(document.getElementById("barrelOechsle").value) || null;
                const actualAlcohol = parseFloat(document.getElementById("barrelActualAlcohol").value) || null;
                const actualStrength = parseFloat(document.getElementById("barrelActualStrength").value) || null;
                // üîπ Burn-Date sicher auslesen
                let burnDate = null;
                const burnDateEl = document.getElementById("barrelBurnDate");
                if (burnDateEl && burnDateEl.value) {
                    burnDate = burnDateEl.value;
                }

                // üîπ Burn-Number sicher auslesen
                let burnNumber = null;
                const burnNumberEl = document.getElementById("barrelBurnNumber");
                if (burnNumberEl && burnNumberEl.value) {
                    burnNumber = parseFloat(burnNumberEl.value) || null;
                }

                // üîπ Brenndauer sicher auslesen
                let burnTimeHours = null;
                const burnTimeEl = document.getElementById("barrelBurnTime");
                if (burnTimeEl && burnTimeEl.value) {
                    burnTimeHours = parseFloat(burnTimeEl.value) || null;
                }

                const barrelData = {
                    fruit,
                    start,
                    days: days || "",
                    end: endDate,
                    volume,
                    oechsle,
                    actualAlcohol,
                    actualStrength,

                    burnTimeHours,
                    burnDate,
                    burnNumber
                };

                localStorage.setItem("barrel_" + id, JSON.stringify(barrelData));
                loadBarrelList();
                updateBarrelDropdown();
                loadBarrelData();

                alert(`‚úÖ Fass "${id}" gespeichert${days ? ` (G√§rdauer: ${days} Tage)` : ""}.`);
            }

            //die Anzeigefelder bei den Maischef√§ssern werden geleert 
            //wenn man den Button dr√ºckt, dass man ein neues Fass anlegen will
            function resetBarrelForm() {
                document.getElementById("barrelNumber").value = "";
                document.getElementById("barrelFruit").value = "";
                document.getElementById("barrelStart").value = "";
                document.getElementById("barrelDays").value = "";
                document.getElementById("barrelVolumeFixed").value = "";
                document.getElementById("barrelOechsle").value = "";
                document.getElementById("barrelActualAlcohol").value = "";
                document.getElementById("barrelActualStrength").value = "";
                document.getElementById("barrelDetails").style.display = "block";

                alert("üÜï Neues Fass kann angelegt werden. Bitte Daten eingeben und speichern.");
            }


            // =======================
            // Fass-√úbersicht erzeugen
            // =======================
            // üß± √úberarbeitete Fass√ºbersicht mit Dropdown-Auswahl
            function loadBarrelList() {
                const list = document.getElementById("barrelList");
                list.innerHTML = `
                    <h3>üìã Fass√ºbersicht</h3>
                    <p style="font-size:0.9em; color:#555;">
                        W√§hle ein gespeichertes Fass, um die Details anzuzeigen.
                    </p>
                `;
                list.innerHTML = `
                    <h3>üìã Fass√ºbersicht</h3>
                    <p style="font-size:0.9em; color:#555;">
                        W√§hle ein gespeichertes Fass, um die Details anzuzeigen.
                    </p>
                    <div style="background:#fff7ef; border:1px dashed #b87333; padding:10px; border-radius:8px; margin-bottom:10px;">
                        <strong>üìñ Hinweis:</strong> Sobald du ein Fass ausw√§hlst, erscheint <em>darunter</em> automatisch das zugeh√∂rige <strong>G√§rprotokoll</strong> mit allen Details.
                    </div>
                    `;


                // üîπ Alle gespeicherten F√§sser holen
                const keys = Object.keys(localStorage)
                    .filter(k => typeof k === "string" && k.startsWith("barrel_"))
                    .sort();

                if (keys.length === 0) {
                    list.innerHTML += "<em>Noch keine F√§sser gespeichert.</em>";
                    return;
                }

                // üîπ Dropdown f√ºr Auswahl
                const select = document.createElement("select");
                select.id = "barrelSelect";
                select.style.width = "100%";
                select.style.marginBottom = "12px";
                select.style.padding = "6px";
                select.style.borderRadius = "6px";
                select.style.border = "1px solid #ccc";
                select.style.fontSize = "1em";

                const defaultOpt = document.createElement("option");
                defaultOpt.value = "";
                defaultOpt.textContent = "‚Äî Fass ausw√§hlen ‚Äî";
                select.appendChild(defaultOpt);

                keys.forEach(key => {
                    const id = key.replace("barrel_", "");
                    const data = JSON.parse(localStorage.getItem(key) || "{}");
                    const opt = document.createElement("option");
                    opt.value = id;
                    opt.textContent = `Fass ${id} ‚Äî ${data.fruit || "?"}`;
                    select.appendChild(opt);
                });

                list.appendChild(select);

                // üîπ Detailbereich
                const detailBox = document.createElement("div");
                detailBox.id = "barrelDetailsBox";
                detailBox.style.marginTop = "10px";
                detailBox.style.padding = "10px";
                detailBox.style.border = "1px solid #ddd";
                detailBox.style.borderRadius = "8px";
                detailBox.style.background = "#fafafa";
                detailBox.style.minHeight = "100px";
                list.appendChild(detailBox);

                select.addEventListener("change", (e) => showBarrelDetails(e.target.value));
            }

            // üßæ Zeigt das ausgew√§hlte Fass an
            function showBarrelDetails(id) {
                const box = document.getElementById("barrelDetailsBox");
                if (!id) {
                    box.innerHTML = "<em>Bitte ein Fass ausw√§hlen.</em>";
                    return;
                }

                const data = JSON.parse(localStorage.getItem("barrel_" + id) || "{}");
                if (!data || !data.fruit) {
                    box.innerHTML = "<em>Keine Daten gefunden.</em>";
                    return;
                }

                const detailsHTML = `
                    <div style="margin-bottom:8px;">
                        <strong>Fass ${id}</strong><br>
                        <span style="color:#555;">Maische:</span> ${data.fruit || "-"}<br>
                        <span style="color:#555;">Beginn:</span> ${data.start || "-"}<br>
                        <span style="color:#555;">Ende:</span> ${data.end || "-"}<br>
                        ${data.volume ? `<span style="color:#555;">Volumen:</span> ${data.volume} L<br>` : ""}
                        ${data.oechsle ? `<span style="color:#555;">Oechsle:</span> ${data.oechsle} ¬∞Oe<br>` : ""}
                        ${data.actualAlcohol ? `<span style="color:#555;">Reinalkohol:</span> ${data.actualAlcohol} L<br>` : ""}
                        ${data.actualStrength ? `<span style="color:#555;">St√§rke:</span> ${data.actualStrength} % Vol<br>` : ""}
                        ${data.burnTimeHours ? `<span style="color:#555;">Brenndauer:</span> ${data.burnTimeHours} h<br>` : ""}    
                        </div>
                `;

                box.innerHTML = detailsHTML;

                // üîπ Buttons in moderner Optik
                const buttonContainer = document.createElement("div");
                buttonContainer.style.display = "flex";
                buttonContainer.style.gap = "8px";
                buttonContainer.style.flexWrap = "wrap";
                buttonContainer.style.marginTop = "10px";

                const createButton = (text, color, action) => {
                    const btn = document.createElement("button");
                    btn.textContent = text;
                    btn.style.flex = "1";
                    btn.style.padding = "8px 10px";
                    btn.style.border = "none";
                    btn.style.borderRadius = "6px";
                    btn.style.color = "#fff";
                    btn.style.cursor = "pointer";
                    btn.style.fontWeight = "bold";
                    btn.style.background = color;
                    btn.addEventListener("click", action);
                    return btn;
                };

                const protoBtn = createButton("üìñ Protokoll", "#2563eb", () => showProtocol(id, data.fruit));
                const emptyBtn = createButton("üßπ Fass leeren", "#d97706", () => emptyBarrel(id));
                const delBtn = createButton("üóëÔ∏è L√∂schen", "#dc2626", () => {
                    if (confirm(`Soll Fass ${id} wirklich gel√∂scht werden?`)) {
                        deleteBarrel(id);
                        updateBarrelDropdown();
                        loadBarrelList();
                    }
                });

                buttonContainer.appendChild(protoBtn);
                buttonContainer.appendChild(emptyBtn);
                buttonContainer.appendChild(delBtn);
                box.appendChild(buttonContainer);
            }







            // Dropdown mit allen gespeicherten F√§ssern f√ºllen
            // =======================
            // Dropdown-Liste bef√ºllen
            // =======================
            function updateBarrelDropdown() {
                const sel = document.getElementById("barrelSelectDropdown");
                if (!sel) return;

                // Vorherige Optionen l√∂schen
                sel.innerHTML = '<option value="">‚Äî Fass w√§hlen ‚Äî</option>';

                // Alle F√§sser aus localStorage holen
                const keys = Object.keys(localStorage)
                    .filter(k => typeof k === "string" && k.startsWith("barrel_"))
                    .sort();

                // Wenn keine F√§sser vorhanden ‚Üí Platzhalter
                if (keys.length === 0) {
                    const opt = document.createElement("option");
                    opt.value = "";
                    opt.textContent = "Keine F√§sser gespeichert";
                    sel.appendChild(opt);
                    return;
                }

                // F√ºr jedes Fass eine Option erzeugen
                keys.forEach(key => {
                    try {
                        const id = key.replace("barrel_", "");
                        const data = localStorage.getItem(key);
                        if (!data) return;
                        const b = JSON.parse(data);
                        //console.log(id);
                        const opt = document.createElement("option");
                        opt.value = id;
                        opt.textContent = `Fass ${id}${b.fruit ? " (" + b.fruit + ")" : ""}`;
                        sel.appendChild(opt);
                    } catch (err) {
                        console.warn("‚ö†Ô∏è Fehler beim Verarbeiten von", key, err);
                    }
                });
            }

            function emptyBarrel(id) {

                // üîπ Fass laden
                const raw = localStorage.getItem("barrel_" + id);
                const b = raw ? JSON.parse(raw) : null;

                if (!b) {
                    alert("‚ùå Fehler: Fassdaten konnten nicht geladen werden.");
                    return;
                }

                // üîπ Pflichtdaten pr√ºfen
                if (!b.actualAlcohol || !b.actualStrength) {
                    const goToEntry = confirm(
                        "‚ùå Dieses Fass kann nicht archiviert werden.\n\n" +
                        "Es fehlen die korrigierten Destillatwerte.\n" +
                        "Ohne tats√§chliche Liter und %vol ist kein Archiv m√∂glich.\n\n" +
                        "Jetzt Werte eintragen?"
                    );
                    if (goToEntry && typeof showBarrelDetails === "function") {
                        showBarrelDetails(id);
                        setTimeout(() => {
                            const el = document.getElementById("actualAlcoholInput");
                            if (el) el.scrollIntoView({ behavior: "smooth", block: "center" });
                        }, 100);
                    }
                    return;
                }

                // -----------------------------------------------------
                //  WARNHINWEIS 
                // -----------------------------------------------------
                const reallyArchive = confirm(
                    "üì¶ Archivieren\n\n" +
                    "Dieses Fass wird geleert und in das Archiv verschoben.\n" +
                    "M√∂chtest du wirklich archivieren?"
                );
                if (!reallyArchive) return;

                // -----------------------------------------------------
                //  DATEN BEREINIGEN
                // -----------------------------------------------------

                // Fruchtname ohne (3,6)
                const fruitClean = (b.fruit || "").replace(/\([^)]*\)/g, "").trim();

                // Brenndatum ‚Äî wenn vorhanden, sonst heutiges Datum
                const burnDate = b.burnDate || new Date().toISOString().split("T")[0];
                const burnNumberField = document.getElementById("barrelBurnNumber");
                const burnNumber = burnNumberField ? burnNumberField.value.trim() : (b.burnNumber || "");


                // Liter & St√§rke (korrigierte Werte!)
                const vol = b.actualAlcohol || 0;
                const alc = b.actualStrength || 0;

                // -----------------------------------------------------
                //  ARCHIV-NAME AUTOMATISCH ERZEUGT
                // -----------------------------------------------------

                // Beispiel: Fass 5 ‚Äì √Ñpfel ‚Äì 2025-11-26
                const archiveName =
                    `${fruitClean} ‚Äì Brand ${burnNumber} vom - ${burnDate}`;

                // -----------------------------------------------------
                //  DATENSATZ BAUEN
                // -----------------------------------------------------
                const protokoll = localStorage.getItem("protocol_" + id) || "";

                const archiveData = {
                    ...b,

                    fruit: fruitClean,
                    burnDate,
                    burnNumber,
                    archivedAt: new Date().toISOString(),

                    // Was wirklich eingelagert werden kann
                    remainingVolume: vol,

                    protokoll,
                    sourceBarrel: id,

                    // wichtige Alkoholwerte
                    actualAlcohol: vol,
                    actualStrength: alc
                };

                // -----------------------------------------------------
                //  ARCHIV SPEICHERN
                // -----------------------------------------------------
                localStorage.setItem("archive_" + archiveName, JSON.stringify(archiveData));

                // -----------------------------------------------------
                //  Fass leeren
                // -----------------------------------------------------
                const empty = {
                    fruit: "",
                    burnDate: "",
                    start: "",
                    days: "",
                    end: "",
                    volume: "",
                    oechsle: "",
                    actualAlcohol: "",
                    actualStrength: ""
                };

                localStorage.setItem("barrel_" + id, JSON.stringify(empty));

                localStorage.removeItem("protocol_" + id);

                alert("‚úÖ Fass " + id + " wurde archiviert.");

                if (typeof loadBarrelList === "function") loadBarrelList();
            }





            // Wird aufgerufen, wenn in der Dropdownliste ein Fass gew√§hlt wird
            function selectBarrelFromDropdown() {
                const sel = document.getElementById("barrelSelectDropdown");
                const id = sel.value;
                if (!id) return;

                // Fassnummer ins Eingabefeld schreiben
                document.getElementById("barrelNumber").value = id;


                // Daten des Fasses laden
                loadBarrelData();
            }

            // =========================================
            // üìã G√§rprotokoll in strukturierte Tabelle umwandeln
            // =========================================
            function formatProtocolTable(protokollData) {
                if (!protokollData || (Array.isArray(protokollData) && protokollData.length === 0)) {
                    return "<em>(kein Protokoll vorhanden)</em>";
                }

                // Wenn das Protokoll als String gespeichert ist ‚Üí in Zeilen zerlegen
                if (typeof protokollData === "string") {
                    try {
                        // Versuch, String als JSON zu parsen
                        const parsed = JSON.parse(protokollData);
                        if (Array.isArray(parsed)) protokollData = parsed;
                    } catch {
                        // bleibt Textformat ‚Üí alte Darstellung
                        return `<pre>${protokollData}</pre>`;
                    }
                }

                // Wenn es kein Array ist ‚Üí zur√ºck
                if (!Array.isArray(protokollData)) return `<pre>${protokollData}</pre>`;

                let html = `
                <table style="border-collapse:collapse;width:100%;margin-top:8px;font-size:0.9em">
                <thead>
                    <tr style="background:#ddd">
                    <th style="border:1px solid #999;padding:4px;">Datum</th>
                    <th style="border:1px solid #999;padding:4px;">Status</th>
                    <th style="border:1px solid #999;padding:4px;">Temperatur (¬∞C)</th>
                    <th style="border:1px solid #999;padding:4px;">pH-Wert</th>
                    <th style="border:1px solid #999;padding:4px;">G√§rverlauf</th>
                    <th style="border:1px solid #999;padding:4px;">Geruch / Bemerkungen</th>
                    <th style="border:1px solid #999;padding:4px;">Notizen</th>
                    </tr>
                </thead>
                <tbody>
                `;

                protokollData.forEach(entry => {
                    html += `
                    <tr>
                    <td style="border:1px solid #999;padding:4px;">${entry.date || ""}</td>
                    <td style="border:1px solid #999;padding:4px;">${entry.status || ""}</td>
                    <td style="border:1px solid #999;padding:4px;text-align:center">${entry.temp || ""}</td>
                    <td style="border:1px solid #999;padding:4px;text-align:center">${entry.ph || ""}</td>
                    <td style="border:1px solid #999;padding:4px;">${entry.status || ""}</td>
                    <td style="border:1px solid #999;padding:4px;">${entry.obs || ""}</td>
                    <td style="border:1px solid #999;padding:4px;">${entry.notes || ""}</td>
                    </tr>`;
                });

                html += "</tbody></table>";
                return html;
            }




            // üì¶ Archivierte Maischef√§sser anzeigen
            function loadArchiveList() {

                const list = document.getElementById("archiveList");
                if (!list) return;
                list.innerHTML = "<h4>üì¶ Archivierte F√§sser:</h4>";

                const keys = Object.keys(localStorage)
                    .filter(k => typeof k === "string" && k.startsWith("archive_"))
                    .sort();

                if (keys.length === 0) {
                    list.innerHTML += "<em>Keine archivierten F√§sser vorhanden.</em>";
                    return;
                }

                keys.forEach(key => {
                    try {
                        const name = key.replace("archive_", "");
                        const data = JSON.parse(localStorage.getItem(key) || "{}");

                        const div = document.createElement("div");
                        div.className = "entry";
                        div.style.background = "#eef2f7";
                        div.style.marginBottom = "10px";
                        div.style.padding = "10px";
                        div.style.borderRadius = "5px";

                        div.innerHTML = `
                                <strong>${name}</strong><br>
                                Frucht: ${data.fruit || "?"}<br>
                                G√§rbeginn: ${data.start || "-"}<br>
                                G√§rende: ${data.end || "-"}<br>
                                Volumen: ${data.volume || "-"} L<br>
                                Alkohol: ${data.actualAlcohol || "-"} L @ ${data.actualStrength || "-"} %<br>
                                <small>Archiviert am: ${new Date(data.archivedAt).toLocaleDateString()}</small><br>
                            `;
                        // üîπ Protokoll als strukturierte Tabelle anzeigen
                        const formattedProtocol = formatProtocolTable(data.protokoll);
                        div.innerHTML += `<div style="margin-top:10px">${formattedProtocol}</div>`;


                        const exportBtn = document.createElement("button");
                        exportBtn.textContent = "üìÑ Anzeigen / Exportieren";
                        exportBtn.addEventListener("click", () => exportArchiveToFile(name, data));
                        const deleteBtn = document.createElement("button");
                        deleteBtn.textContent = "üóëÔ∏è L√∂schen";


                        deleteBtn.addEventListener("click", () => {
                            if (!confirm(
                                "‚ö†Ô∏è Archiv-Eintrag wirklich l√∂schen?\n\n" +
                                `${data.fruit || "Unbekannt"}\n\n` +
                                "Dieser Vorgang kann nicht r√ºckg√§ngig gemacht werden."
                            )) return;

                            localStorage.removeItem(key);

                            // Liste neu laden
                            loadArchiveList();
                        });


                        div.appendChild(exportBtn);
                        div.appendChild(deleteBtn);
                        list.appendChild(div);
                    } catch (err) {
                        console.warn("Fehler beim Anzeigen von Archiv", key, err);
                    }
                });
            }




            function deleteArchive(key) {

                const a = JSON.parse(localStorage.getItem(key) || "{}");
                if (!a) return;

                const label =
                    `${a.fruit || "Unbekannt"} (${a.start || "?"} ‚Üí ${a.end || "?"})`;

                if (!confirm(
                    "‚ö†Ô∏è Archiv-Eintrag l√∂schen?\n\n" +
                    label + "\n\n" +
                    "Dieser Vorgang kann nicht r√ºckg√§ngig gemacht werden."
                )) return;

                localStorage.removeItem(key);

                // Archivliste neu aufbauen
                if (typeof loadArchiveList === "function") {
                    loadArchiveList();
                }

                alert("‚úÖ Archiv-Eintrag wurde gel√∂scht.");
            }



            // üîπ Parst eine Zeile des G√§rprotokolls in einzelne Felder
            function parseProtocolLine(line) {
                let datum = "";
                let temp = "";
                let ph = "";
                let gaerverlauf = "";
                let geruch = "";
                let notiz = "";

                // Datum erkennen (verschiedene Formate)
                const dateMatch = line.match(/^(\d{4}-\d{2}-\d{2}|\d{1,2}\.\d{1,2}\.\d{2,4})/);
                if (dateMatch) {
                    datum = dateMatch[0];
                    line = line.replace(dateMatch[0], "").trim();
                }

                // Temperatur
                const tempMatch = line.match(/(\d+(?:[.,]\d+)?)\s*¬∞?\s*C/i);
                if (tempMatch) {
                    temp = tempMatch[1] + " ¬∞C";
                    line = line.replace(tempMatch[0], "").trim();
                }

                // pH-Wert
                const phMatch = line.match(/pH[^\d]*(\d+(?:[.,]\d+)?)/i);
                if (phMatch) {
                    ph = phMatch[1];
                    line = line.replace(phMatch[0], "").trim();
                }

                // Notiz
                const noteMatch = line.match(/(Notiz|Anmerkung|Hinweis)[:\-]?\s*(.+)/i);
                if (noteMatch) {
                    notiz = noteMatch[2].trim();
                    line = line.replace(noteMatch[0], "").trim();
                }

                // Geruch extrahieren, falls vorhanden
                const smellMatch = line.match(/Geruch[:\-]?\s*([^,;]+)/i);
                if (smellMatch) {
                    geruch = smellMatch[1].trim();
                    line = line.replace(smellMatch[0], "").trim();
                }

                // G√§rverlauf bleibt, was √ºbrig ist
                gaerverlauf = line.replace(/^[,;]+/, "").trim();

                return [datum, temp, ph, gaerverlauf, geruch, notiz];
            }



            // üìÑ Export eines Archivdatensatzes als PDF oder Word (mit echter Tabelle)
            async function exportArchiveToFile(name, data) {
                const choice = confirm("M√∂chtest du als PDF exportieren?");
                if (choice) {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    // Kopfbereich
                    doc.setFontSize(14);
                    doc.text(`Archivierter Brand: ${name}`, 10, 10);
                    doc.setFontSize(10);
                    const info = [
                        `Frucht: ${data.fruit || ""}`,
                        `G√§rbeginn: ${data.start || ""}`,
                        `G√§rende: ${data.end || ""}`,
                        `Volumen: ${data.volume || ""} L`,
                        `Oechsle: ${data.oechsle || ""}`,
                        `Reinalkohol: ${data.actualAlcohol || ""} L @ ${data.actualStrength || ""} %`,
                        `Archiviert am: ${data.archivedAt ? new Date(data.archivedAt).toLocaleString() : ""}`,
                        `Ursprungsfass: ${data.sourceBarrel || ""}`,
                    ];
                    doc.text(info, 10, 25);

                    if (data.protokoll) {
                        let rows = [];
                        let protokollData = data.protokoll;

                        // Falls als Text gespeichert ‚Üí versuchen zu parsen
                        if (typeof protokollData === "string") {
                            try {
                                const parsed = JSON.parse(protokollData);
                                if (Array.isArray(parsed)) protokollData = parsed;
                            } catch {
                                protokollData = [];
                            }
                        }

                        if (Array.isArray(protokollData)) {
                            rows = protokollData.map(p => [
                                p.date || "",
                                p.status || "",
                                p.temp ? `${p.temp} ¬∞C` : "",
                                p.ph || "",
                                p.obs || "",
                                p.notes || ""
                            ]);
                        }

                        if (rows.length > 0) {
                            doc.autoTable({
                                startY: 65,
                                head: [["Datum", "Status", "Temperatur", "pH-Wert", "G√§rverlauf / Geruch / Bemerkungen", "Notizen"]],
                                body: rows,
                                styles: { fontSize: 9, cellPadding: 2 },
                                headStyles: { fillColor: [230, 230, 230] },
                                columnStyles: {
                                    0: { cellWidth: 25 },
                                    1: { cellWidth: 20 },
                                    2: { cellWidth: 20 },
                                    3: { cellWidth: 15 },
                                    4: { cellWidth: 65 },
                                    5: { cellWidth: 35 }
                                },
                                margin: { left: 10, right: 10 },
                                tableWidth: 180,
                            });
                        }
                    }


                    doc.save(`${name}.pdf`);
                    return;
                }
            }




            function deleteBarrel(id) {
                if (!confirm(`Fass "${id}" wirklich l√∂schen?`)) return;
                localStorage.removeItem("barrel_" + id);
                localStorage.removeItem("protocol_" + id);
                loadBarrelList();
                updateBarrelDropdown();
            }

            let currentFassNummer = null;

            function showProtocol(fassNummer, maischeArt) {
                currentFassNummer = fassNummer;
                document.getElementById("detailFassName").innerText = `Fass ${fassNummer} ‚Äì ${maischeArt}`;
                document.getElementById("barrelDetails").style.display = "block";
                loadProtocolEntries(fassNummer);
            }

            function saveProtocolEntry() {
                if (!currentFassNummer) { alert("Kein Fass ausgew√§hlt!"); return; }

                const key = "protocol_" + currentFassNummer;
                const all = JSON.parse(localStorage.getItem(key)) || [];

                const entry = {
                    date: document.getElementById("entryDate").value || new Date().toISOString().split("T")[0],
                    status: document.getElementById("fermentationStatus").value,
                    temp: document.getElementById("temperatureLog").value,
                    ph: document.getElementById("phLog").value,
                    obs: document.getElementById("observationLog").value,
                    notes: document.getElementById("noteLog").value
                };

                all.push(entry);
                localStorage.setItem(key, JSON.stringify(all));

                document.getElementById("entryDate").value = "";
                document.getElementById("temperatureLog").value = "";
                document.getElementById("phLog").value = "";
                document.getElementById("observationLog").value = "";
                document.getElementById("noteLog").value = "";

                loadProtocolEntries(currentFassNummer);
            }

            function loadProtocolEntries(fassNummer) {
                const key = "protocol_" + fassNummer;
                const all = JSON.parse(localStorage.getItem(key)) || [];
                const container = document.getElementById("protocolEntries");
                container.innerHTML = "";

                if (all.length === 0) {
                    container.innerHTML = "<em>Noch keine Eintr√§ge vorhanden.</em>";
                    return;
                }

                all.forEach((e, idx) => {
                    const entryDiv = document.createElement("div");
                    entryDiv.className = "entry";
                    entryDiv.innerHTML = `
                <strong>${e.date}</strong> ‚Äì Status: ${e.status}<br>
                üå°Ô∏è ${e.temp || "-"}<br>
                üß™ ${e.ph || "-"}<br>
                üëÉ ${e.obs || "-"}<br>
                üìù ${e.notes || "-"}<br>
                `;
                    const delBtn = document.createElement("button");
                    delBtn.textContent = "‚ùå L√∂schen";
                    delBtn.addEventListener("click", () => deleteEntry(fassNummer, idx));
                    entryDiv.appendChild(delBtn);
                    container.appendChild(entryDiv);
                });
            }

            function deleteEntry(fassNummer, idx) {
                const key = "protocol_" + fassNummer;
                let all = JSON.parse(localStorage.getItem(key)) || [];
                all.splice(idx, 1);
                localStorage.setItem(key, JSON.stringify(all));
                loadProtocolEntries(fassNummer);
            }

            // ---- Backup / Restore ----
            function exportBackup() {
                const data = {};
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith("barrel_") || key.startsWith("protocol_")) {
                        data[key] = JSON.parse(localStorage.getItem(key));
                    }
                });

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "gaerprotokolle_backup.json";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function importBackup(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = e => {
                    const data = JSON.parse(e.target.result);
                    for (const key in data) {
                        localStorage.setItem(key, JSON.stringify(data[key]));
                    }
                    loadBarrelList();
                };
                reader.readAsText(file);
            }

            function exportBackupAsText() {
                let text = "üìÇ Backup aller F√§sser und Protokolle\n\n";
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith("barrel_")) {
                        const id = key.replace("barrel_", "");
                        const b = JSON.parse(localStorage.getItem(key));
                        text += `Fass ${id} (${b.fruit})\nBeginn: ${b.start}, Ende: ${b.end}\n`;
                        const protos = JSON.parse(localStorage.getItem("protocol_" + id)) || [];
                        protos.forEach(p => {
                            text += `  - ${p.date}: ${p.status}, Temp:${p.temp}, pH:${p.ph}, Geruch:${p.obs}, Notizen:${p.notes}\n`;
                        });
                        text += "\n";
                    }
                });
                alert(text);
            }

            function loadBarrelData() {
                // 1Ô∏è‚É£ Fassnummer aus Eingabefeld oder Dropdown lesen
                let id = document.getElementById("barrelNumber")?.value.trim();

                // Falls das Eingabefeld leer ist, nimm den Wert aus dem Dropdown
                if (!id) {
                    const sel = document.getElementById("barrelSelectDropdown");
                    if (sel && sel.value) id = sel.value;
                }

                // 2Ô∏è‚É£ Wenn immer noch nichts da ist ‚Üí nichts laden
                if (!id) {
                    clearBarrelInputs();
                    return;
                }

                // 3Ô∏è‚É£ Daten aus localStorage holen
                const data = localStorage.getItem("barrel_" + id);
                if (!data) {
                    clearBarrelInputs();
                    return;
                }

                const b = JSON.parse(data);

                // 4Ô∏è‚É£ Eingabefelder bef√ºllen
                document.getElementById("barrelNumber").value = id;
                document.getElementById("barrelFruit").value = b.fruit || "";
                document.getElementById("barrelStart").value = b.start || "";
                document.getElementById("barrelDays").value = b.days || "";
                document.getElementById("barrelVolumeFixed").value = b.volume || "";
                document.getElementById("barrelOechsle").value = b.oechsle || "";
                document.getElementById("barrelActualAlcohol").value = b.actualAlcohol || "";
                document.getElementById("barrelActualStrength").value = b.actualStrength || "";
                // Brenndaten laden
                document.getElementById("barrelBurnDate").value =
                    b.burnDate ? b.burnDate : "";

                document.getElementById("barrelBurnNumber").value =
                    b.burnNumber ? b.burnNumber : "";

                document.getElementById("barrelBurnTime").value =
                    b.burnTimeHours ? b.burnTimeHours : "";

                calculateExpectedAlcohol();
            }

            function clearBarrelInputs() {
                const ids = [
                    "barrelFruit", "barrelStart", "barrelDays", "barrelVolumeFixed",
                    "barrelHeightValue", "barrelOechsle", "barrelActualAlcohol", "barrelActualStrength"
                ];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = "";
                });
                document.getElementById("expectedAlcoholOutput").innerHTML = "";
                // document.getElementById("barrelVolumeCalcOutput").innerHTML = "";
            }


            // ===== Fass-Kalkulation =====
            function initCalcPage() {

                // 1Ô∏è‚É£ Dropdown f√ºr reale + archivierte F√§sser f√ºllen
                fillCalcBarrelSelect();

                // 2Ô∏è‚É£ Ausgew√§hltes Fass laden (falls vorhanden)
                loadCalcFromBarrel();

                // 3Ô∏è‚É£ Alle Ausgabefelder zur√ºcksetzen
                document.getElementById('calcBarrelInfo').innerHTML = '';
                document.getElementById('calcDilutionResult').innerHTML = '';
                document.getElementById('calcRawCostResult').innerHTML = '';
                document.getElementById('calcEnergyLaborResult').innerHTML = '';
                document.getElementById('calcFixedCostResult').innerHTML = '';
                document.getElementById('calcTaxResult').innerHTML = '';
                document.getElementById('calcBottlesResult').innerHTML = '';
                document.getElementById('calcSummary').innerHTML = '';
                document.getElementById('calcActualYieldResult').innerHTML = '';
                document.getElementById('calcActualBottleResult').innerHTML = '';

                // 4Ô∏è‚É£ Literpreise bei Seitenstart aktualisieren
                updateLiterPrices();
            }


            function updateLiterPrices() {
                const b05 = parseFloat(document.getElementById('calcBottle05Price').value) || 0;
                const b07 = parseFloat(document.getElementById('calcBottle07Price').value) || 0;
                const b10 = parseFloat(document.getElementById('calcBottle10Price').value) || 0;
                document.getElementById('literPrice05').innerText = `‚Üí ${(b05 / 0.5).toFixed(2)} ‚Ç¨/L`;
                document.getElementById('literPrice07').innerText = `‚Üí ${(b07 / 0.7).toFixed(2)} ‚Ç¨/L`;
                document.getElementById('literPrice10').innerText = `‚Üí ${(b10 / 1.0).toFixed(2)} ‚Ç¨/L`;
            }

            function loadCalcFromBarrel() {
                const sel = document.getElementById('calcBarrelSelect');
                const key = sel.value;
                const info = document.getElementById('calcBarrelInfo');

                // Anzeigen zur√ºcksetzen
                info.innerHTML = "";
                document.getElementById('calcActualYieldResult').innerHTML = '';
                document.getElementById('calcActualBottleResult').innerHTML = '';
                document.getElementById('calcDilutionResult').innerHTML = '';

                if (!key) {
                    calculateCalc();
                    return;
                }

                // Datensatz laden
                const raw = localStorage.getItem(key);
                if (!raw) {
                    info.innerHTML = "<em>Keine Daten gefunden.</em>";
                    return;
                }

                const b = JSON.parse(raw);

                // --- SICHER: Falls Archiv-Fass keine Dichte hat, Standardwert setzen
                if (!b.density) b.density = 1.20;

                // --- SICHER: Falls keine actual-Werte existieren: 0 statt ""
                const volActual = Number(b.actualAlcohol) || 0;
                const abvActual = Number(b.actualStrength) || 0;

                // Eingabefelder f√ºllen
                document.getElementById("calcActualVolumeL").value = volActual;
                document.getElementById("calcActualAbv").value = abvActual;
                document.getElementById("calcDensity").value = Number(b.density) || 1.20;

                const volText = b.volume ? `${b.volume} L` : "‚Äî";

                const alcPure =
                    (volActual > 0 && abvActual > 0)
                        ? volActual * abvActual / 100
                        : 0;

                // Wenn keine tats√§chlichen Werte ‚Üí Warnung
                if (volActual === 0 || abvActual === 0) {
                    info.innerHTML = `
            <div style="background:#fff3cd; padding:10px; border-radius:6px; border:1px solid #ffeeba;">
                ‚ö†Ô∏è F√ºr dieses Fass liegen noch keine tats√§chlichen Messwerte vor.<br>
                Bitte zuerst Reinalkohol und St√§rke im Bereich 
                <strong>‚ÄûMaischef√§sser und G√§rprotokolle‚Äú</strong> eintragen.
            </div>`;
                    return;
                }

                // Normalanzeige
                info.innerHTML = `
        <strong>${key.startsWith("barrel_") ? "Fass " + key.replace("barrel_", "") : "Archiv-Fass"}</strong><br>
        Maische: ${b.fruit || '‚Äî'}<br>
        Volumen (Maische): ${volText}<br>
        Destillat (tats√§chlich): ${volActual} L @ ${abvActual}% Vol<br>
        Reinalkohol (berechnet): ${alcPure.toFixed(2)} L<br>
    `;

                // ‚ùó Ganz wichtig: Erst jetzt berechnen
                calculateCalc();
            }





            function calculateCalc() {

                // -----------------------------
                // 0. Preise aktualisieren
                // -----------------------------
                updateLiterPrices();

                // -----------------------------
                // 1. Allgemeine Eingaben
                // -----------------------------
                const sel = document.getElementById("calcBarrelSelect");
                const keyRaw = sel ? sel.value : "";

                const targetAbv = parseFloat(document.getElementById("calcTargetAbv").value);
                const density = parseFloat(document.getElementById("calcDensity").value);
                const pricePerKg = parseFloat(document.getElementById("calcRawPricePerKg").value);

                const hours = parseFloat(document.getElementById("calcHours").value) || 0;
                const powerKw = parseFloat(document.getElementById("calcPowerKw").value) || 0;
                const priceKwh = parseFloat(document.getElementById("calcPriceKwh").value) || 0;

                const laborHours = parseFloat(document.getElementById("calcLaborHours").value) || 0;
                const laborRate = parseFloat(document.getElementById("calcLaborRate").value) || 0;

                const stillPrice = parseFloat(document.getElementById("calcStillPrice").value) || 0;
                const stillYears = parseFloat(document.getElementById("calcStillYears").value) || 0;
                const batchesPerYear = parseFloat(document.getElementById("calcBatchesPerYear").value) || 0;

                const b05Cost = parseFloat(document.getElementById("calcBottle05Cost").value) || 0;
                const b05Price = parseFloat(document.getElementById("calcBottle05Price").value) || 0;

                const packaging = parseFloat(document.getElementById("calcPackaging").value) || 0;
                const closures = parseFloat(document.getElementById("calcClosures").value) || 0;
                const labels = parseFloat(document.getElementById("calcLabels").value) || 0;
                const shipping = parseFloat(document.getElementById("calcShipping").value) || 0;

                const TAX_RATE = parseFloat(document.getElementById("calcTaxRate").value) || 10.22;


                // -----------------------------
                // 2. Kein Fass gew√§hlt ‚Üí Ausgabe leeren
                // -----------------------------
                if (!keyRaw) {
                    [
                        "calcDilutionResult", "calcRawCostResult", "calcEnergyLaborResult",
                        "calcFixedCostResult", "calcTaxResult", "calcBottlesResult",
                        "calcSummary", "calcActualYieldResult", "calcActualBottleResult"
                    ].forEach(id => document.getElementById(id).innerHTML = "");
                    return;
                }

                // -----------------------------
                // 3. Fass laden (inkl Archiv)
                // -----------------------------
                let storageKey = keyRaw;
                if (!storageKey.startsWith("barrel_") && !storageKey.startsWith("archive_")) {
                    storageKey = "barrel_" + storageKey;
                }

                const b = JSON.parse(localStorage.getItem(storageKey) || "{}");

                // Brenndauer aus Fassdaten laden
                if (b.burnTimeHours !== undefined && b.burnTimeHours !== "") {
                    const hField = document.getElementById("calcHours");
                    if (hField) hField.value = b.burnTimeHours;
                }

                const mashLiters = parseFloat(b.volume) || NaN;
                const savedVol = parseFloat(b.actualAlcohol) || NaN;
                const savedAbv = parseFloat(b.actualStrength) || NaN;

                // -----------------------------
                // 4. Manuelle Eingaben
                // -----------------------------
                const inputVol = parseFloat(document.getElementById("calcActualVolumeL").value);
                const inputAbv = parseFloat(document.getElementById("calcActualAbv").value);
                const hasActualInput = inputVol > 0 && inputAbv > 0;

                // -----------------------------
                // 5. Reinalkohol AA
                // -----------------------------
                let AA = NaN;
                let sourceNote = "";

                if (hasActualInput) {
                    AA = inputVol * (inputAbv / 100);
                    sourceNote = "Quelle: Tats√§chliche Ausbringung";
                }
                else if (!isNaN(savedVol) && !isNaN(savedAbv)) {
                    AA = savedVol * (savedAbv / 100);
                    sourceNote = "Quelle: Fassdaten";
                }

                // -----------------------------
                // 6. Endvolumen bei Ziel %
                // -----------------------------
                let endVolumeL = NaN, waterAdd = NaN;

                if (!isNaN(AA) && targetAbv > 0) {
                    endVolumeL = AA / (targetAbv / 100);
                    const baseVol = hasActualInput ? inputVol : savedVol;
                    if (!isNaN(baseVol)) waterAdd = endVolumeL - baseVol;
                }

                // -----------------------------
                // 7. Tats√§chliche Darstellung
                // -----------------------------
                if (hasActualInput) {
                    document.getElementById("calcActualYieldResult").innerHTML =
                        `Tats√§chlich: <strong>${inputVol.toFixed(2)} L √ó ${inputAbv.toFixed(1)} % = ${AA.toFixed(2)} L AA</strong><br>
             Endvolumen: <strong>${endVolumeL.toFixed(2)} L</strong><br>
             Wasserzugabe: <strong>${(waterAdd || 0).toFixed(2)} L</strong>
             <div class="tiny">${sourceNote}</div>`;

                    document.getElementById("calcActualBottleResult").innerHTML =
                        `‚âà ${Math.floor(endVolumeL / 0.5)} √ó 0,5 L ¬∑ 
             ${Math.floor(endVolumeL / 0.7)} √ó 0,7 L ¬∑ 
             ${Math.floor(endVolumeL / 1.0)} √ó 1,0 L`;
                }
                else {
                    document.getElementById("calcActualYieldResult").innerHTML = `<em>Optional: Messwerte eingeben.</em>`;
                    document.getElementById("calcActualBottleResult").innerHTML = "";
                }

                // -----------------------------
                // 8. Verd√ºnnungsausgabe
                // -----------------------------
                document.getElementById("calcDilutionResult").innerHTML =
                    (!isNaN(endVolumeL))
                        ? `Endvolumen bei ${targetAbv}%: <strong>${endVolumeL.toFixed(2)} L</strong><div class="tiny">${sourceNote}</div>`
                        : `<em>Bitte Ziel-% und AA-Quelle angeben.</em>`;

                // -----------------------------
                // 9. Rohstoffkosten
                // -----------------------------
                let mashKg = NaN, rawCost = NaN;

                if (!isNaN(mashLiters) && !isNaN(density) && !isNaN(pricePerKg)) {
                    mashKg = mashLiters * density;
                    rawCost = mashKg * pricePerKg;

                    document.getElementById("calcRawCostResult").innerHTML =
                        `Maische: <strong>${mashKg.toFixed(1)} kg</strong><br>
             Rohstoffkosten: <strong>${rawCost.toFixed(2)} ‚Ç¨</strong>`;
                } else {
                    document.getElementById("calcRawCostResult").innerHTML =
                        `<em>Bitte Dichte und ‚Ç¨/kg eingeben.</em>`;
                    rawCost = 0;
                }

                // -----------------------------
                // 10. Energie + Arbeit
                // -----------------------------
                const energyKwh = hours * powerKw;
                const energyCost = energyKwh * priceKwh;
                const laborCost = laborHours * laborRate;

                document.getElementById("calcEnergyLaborResult").innerHTML =
                    `Energie: ${energyKwh.toFixed(1)} kWh ‚Üí <strong>${energyCost.toFixed(2)} ‚Ç¨</strong><br>
                    Arbeit: ${laborHours.toFixed(1)} h √ó ${laborRate.toFixed(2)} ‚Ç¨/h ‚Üí <strong>${laborCost.toFixed(2)} ‚Ç¨</strong>`;

                // -----------------------------
                // 11. Fixkosten
                // -----------------------------
                let fixedPerBatch = 0;

                if (stillPrice > 0 && stillYears > 0 && batchesPerYear > 0) {
                    fixedPerBatch = stillPrice / (stillYears * batchesPerYear);
                    document.getElementById("calcFixedCostResult").innerHTML =
                        `Fixkostenanteil: <strong>${fixedPerBatch.toFixed(2)} ‚Ç¨</strong>`;
                } else {
                    document.getElementById("calcFixedCostResult").innerHTML =
                        `<em>Daten unvollst√§ndig.</em>`;
                }

                // -----------------------------
                // 12. Alkoholsteuer
                // -----------------------------
                const fruitName = b.fruit || "";
                const matched = matchFruitName(fruitName);
                const yieldValue = matched ? fruits.liter[matched] : 0;

                let taxCost = 0;
                let taxHtml = "";

                if (matched && yieldValue > 0 && mashLiters > 0) {
                    const taxAA = (mashLiters * yieldValue) / 100;
                    taxCost = taxAA * TAX_RATE;

                    taxHtml =
                        `<strong>üìú Branntweinsteuer</strong><br>
             Rohstoff: <strong>${matched}</strong><br>
             Maische: <strong>${mashLiters.toFixed(1)} L</strong><br>
             Ausbeutesatz: ${yieldValue} L AA / 100 L<br>
             Steuer-AA: ${taxAA.toFixed(2)} L<br>
             Steuersatz: ${TAX_RATE.toFixed(2)} ‚Ç¨/L AA<br>
             üí∞ <strong>${taxCost.toFixed(2)} ‚Ç¨</strong>`;
                }
                else if (fruitName) {
                    taxHtml = `<em>‚Äû${fruitName}‚Äú hat keinen Ausbeutesatz.</em>`;
                }
                else {
                    taxHtml = `<em>Kein Rohstoff angegeben.</em>`;
                }

                document.getElementById("calcTaxResult").innerHTML = taxHtml;

                // -----------------------------
                // 13. Flaschen 0,5 L
                // -----------------------------
                let bottlesCost = 0, revenue = 0;

                if (!isNaN(endVolumeL)) {
                    const n05 = Math.floor(endVolumeL / 0.5);
                    const costPerBottle = b05Cost + packaging + closures + labels + shipping;

                    bottlesCost = n05 * costPerBottle;
                    revenue = n05 * b05Price;

                    document.getElementById("calcBottlesResult").innerHTML =
                        `0,5 L-Flaschen: <strong>${n05}</strong><br>
             Kosten/Flasche: ${costPerBottle.toFixed(2)} ‚Ç¨<br>
             Gesamtkosten: <strong>${bottlesCost.toFixed(2)} ‚Ç¨</strong><br><br>
            <strong> Erl√∂s: ${revenue.toFixed(2)} ‚Ç¨</strong>`;
                }
                else {
                    document.getElementById("calcBottlesResult").innerHTML =
                        `<em>Bitte Ziel-% und AA-Quelle angeben.</em>`;
                }

                // -----------------------------
                // 14. Gesamtbilanz
                // -----------------------------
                const totalCosts =
                    rawCost + energyCost + laborCost + fixedPerBatch + bottlesCost + taxCost;

                const profit = revenue - totalCosts;

                const perL = (!isNaN(endVolumeL) && endVolumeL > 0) ? profit / endVolumeL : NaN;
                const count05 = Math.floor(endVolumeL / 0.5) || 0;
                const perBottle = count05 > 0 ? profit / count05 : NaN;
                const pricingHint = document.getElementById("pricingHint");


                document.getElementById("calcSummary").innerHTML =
                    `<strong>Kosten√ºbersicht</strong><br>
    Rohstoff: ${rawCost.toFixed(2)} ‚Ç¨<br>
    Energie + Arbeit: ${(energyCost + laborCost).toFixed(2)} ‚Ç¨<br>
    Fixkosten: ${fixedPerBatch.toFixed(2)} ‚Ç¨<br>
    Steuer: ${taxCost.toFixed(2)} ‚Ç¨<br>
    Flaschenkosten: ${bottlesCost.toFixed(2)} ‚Ç¨
    <hr>
    <strong>Gesamtkosten:</strong> ${totalCosts.toFixed(2)} ‚Ç¨<br>
    <strong>Erl√∂s:</strong> ${revenue.toFixed(2)} ‚Ç¨<br>
    <strong>Gewinn:</strong> ${profit.toFixed(2)} ‚Ç¨<br>
    ${!isNaN(perL) ? `‚âà ${perL.toFixed(2)} ‚Ç¨ Gewinn je Liter<br>` : ""}
    ${!isNaN(perBottle) ? `‚âà ${perBottle.toFixed(2)} ‚Ç¨ Gewinn je 0,5-L-Flasche` : ""}
    ${pricingHint}`;

            }






            function fillCalcBarrelSelect() {
                const sel = document.getElementById("calcBarrelSelect");
                sel.innerHTML = ""; // leeren

                // --- Platzhalter ---
                const placeholder = document.createElement("option");
                placeholder.value = "";
                placeholder.textContent = "‚Äî Fass w√§hlen ‚Äî";
                sel.appendChild(placeholder);

                // ============================
                // üõ¢Ô∏è Echte F√§sser
                // ============================
                const barrelKeys = Object.keys(localStorage)
                    .filter(k => k.startsWith("barrel_"));

                barrelKeys.forEach(key => {
                    const b = JSON.parse(localStorage.getItem(key) || "{}");
                    if (!b) return;

                    // ‚ùå AUSBLENDEN, wenn verbraucht
                    if (b.status === "used") return;
                    if (b.remainingLiters !== undefined && b.remainingLiters <= 0) return;

                    const num = key.replace("barrel_", "");

                    const opt = document.createElement("option");
                    opt.value = key;
                    opt.textContent = `Fass ${num} (${b.fruit || "?"})`;
                    sel.appendChild(opt);
                });

                // ============================
                // üì¶ Archiv-F√§sser
                // ============================
                const archives = Object.keys(localStorage)
                    .filter(k => k.startsWith("archive_"));

                const grp = document.createElement("optgroup");
                grp.label = "üì¶ Archiv";

                archives.forEach(key => {
                    const a = JSON.parse(localStorage.getItem(key) || "{}");
                    if (!a) return;

                    // ‚ùå AUSBLENDEN, wenn verbraucht oder leer
                    if (a.status === "used") return;
                    const rest =
                        a.remainingVolume ??
                        a.remainingLiters ??
                        a.actualAlcohol ??
                        0;

                    if (rest <= 0) return;


                    const opt = document.createElement("option");
                    opt.value = key;

                    // kleine Absicherung falls start/end fehlen
                    const start = a.start || "?";
                    const end = a.end || "?";

                    opt.textContent = `${a.fruit || "?"} (${start} ‚Üí ${end})`;
                    grp.appendChild(opt);
                });

                // Nur hinzuf√ºgen wenn noch etwas √ºbrig ist
                if (grp.children.length > 0) {
                    sel.appendChild(grp);
                }
            }


            function openBarrelStorageDialog() {
                const sel = document.getElementById("calcBarrelSelect");
                const key = sel ? sel.value : "";

                if (!key) {
                    alert("Bitte erst ein Fass w√§hlen.");
                    return;
                }

                const b = JSON.parse(localStorage.getItem(key) || "{}");

                if (!b.actualAlcohol || !b.actualStrength) {
                    alert("Bitte korrigierte Menge und korrigierte St√§rke eintragen.");
                    return;
                }

                // Unverd√ºnnte Werte
                const realVol = b.actualAlcohol;
                const realAbv = b.actualStrength;
                const realAA = realVol * (realAbv / 100);

                // Zielwerte aus Kalkulation
                const targetAbv = parseFloat(document.getElementById("calcTargetAbv")?.value) || 0;
                let endVol = 0;
                let waterNeeded = 0;

                if (targetAbv > 0) {
                    endVol = realAA / (targetAbv / 100);
                    waterNeeded = endVol - realVol;
                }

                // Info im Dialog anzeigen
                const info = document.getElementById("barrelStorageInfo");
                info.innerHTML = `
                    <strong>Unverd√ºnnt:</strong> ${realVol.toFixed(2)} L @ ${realAbv.toFixed(1)}% vol<br>
                    <strong>Verd√ºnnt:</strong> ${endVol.toFixed(2)} L @ ${targetAbv.toFixed(1)}% vol<br>
                    <strong>Wasser n√∂tig:</strong> ${waterNeeded.toFixed(2)} L
                `;

                // Lagerbeh√§lterliste f√ºllen
                fillBarrelStorageSelect();

                document.getElementById("barrelStorageDialog").style.display = "block";

            }




            function fillBarrelStorageSelect() {

                const sel = document.getElementById("barrelStorageSelect");
                if (!sel) return;

                sel.innerHTML = '<option value="">‚Äî Beh√§lter w√§hlen ‚Äî</option>';

                const keys = Object.keys(localStorage)
                    .filter(k => k.startsWith("storage_"))
                    .sort();

                keys.forEach(key => {
                    const st = JSON.parse(localStorage.getItem(key) || "{}");
                    if (!st || !st.id) return;

                    const opt = document.createElement("option");
                    opt.value = st.id;
                    opt.textContent = `${st.name || ("Beh√§lter " + st.id)} (${st.capacity || "?"} L)`;

                    sel.appendChild(opt);
                });
            }




            function saveBarrelToStorage(mode) {

                // Sicherheitsabfrage
                const ok = confirm("M√∂chten Sie dieses Fass wirklich in den Lagerbeh√§lter einlagern?\n\nDieser Vorgang kann nicht r√ºckg√§ngig gemacht werden!");
                if (!ok) {
                    return; // Vorgang abbrechen
                }

                const sel = document.getElementById("calcBarrelSelect");
                const key = sel ? sel.value : "";
                const b = JSON.parse(localStorage.getItem(key) || "{}");
                const fruitClean = (b.fruit || "").replace(/\([^)]*\)/g, "").trim();
                const burnDate = b.burnDate || new Date().toISOString().split("T")[0];
                const burnNumber = b.burnNumber || "";

                const storageId = document.getElementById("barrelStorageSelect").value;
                if (!storageId) {
                    alert("Bitte einen Lagerbeh√§lter w√§hlen.");
                    return;
                }

                const storageKey = "storage_" + storageId;
                const st = JSON.parse(localStorage.getItem(storageKey) || "{}");

                if (!st.id) {
                    alert("Lagerbeh√§lter existiert nicht!");
                    return;
                }

                // ------------------------------
                // 1Ô∏è‚É£ Alkoholische Daten
                // ------------------------------
                const realVol = b.actualAlcohol;
                const realAbv = b.actualStrength;
                const realAA = realVol * (realAbv / 100);

                // ------------------------------
                // 2Ô∏è‚É£ Kosten & Preise (wie in saveBarrelAsProduct)
                // ------------------------------
                const summaryText = document.getElementById("calcSummary")?.innerText || "";

                function extractEuro(label) {
                    const idx = summaryText.indexOf(label);
                    if (idx === -1) return NaN;
                    const sub = summaryText.slice(idx + label.length);
                    const m = sub.match(/([0-9]+(?:[.,][0-9]+)?)\s*‚Ç¨/);
                    if (!m) return NaN;
                    return parseFloat(m[1].replace(",", "."));
                }

                const totalCosts = extractEuro("Gesamtkosten:") || 0;
                const costPerLiter = totalCosts / realVol;

                // Benutzerpreise
                const p05 = parseFloat(document.getElementById("calcBottle05Price")?.value);
                const p07 = parseFloat(document.getElementById("calcBottle07Price")?.value);
                const p10 = parseFloat(document.getElementById("calcBottle10Price")?.value);


                const userPrice = {
                    "0.5": isNaN(p05) ? null : p05,
                    "0.7": isNaN(p07) ? null : p07,
                    "1.0": isNaN(p10) ? null : p10
                };

                const mat05 = parseFloat(document.getElementById("barrelBottle05Cost")?.value) || 0;
                const mat07 = parseFloat(document.getElementById("barrelBottle07Cost")?.value) || 0;
                const mat10 = parseFloat(document.getElementById("barrelBottle10Cost")?.value) || 0;

                const packaging = parseFloat(document.getElementById("barrelPackaging")?.value) || 0;
                const closures = parseFloat(document.getElementById("barrelClosures")?.value) || 0;
                const labels = parseFloat(document.getElementById("barrelLabels")?.value) || 0;
                const shipping = parseFloat(document.getElementById("barrelShipping")?.value) || 0;

                const bottleMat05 = mat05 + packaging + closures + labels + shipping;
                const bottleMat07 = mat07 + packaging + closures + labels + shipping;
                const bottleMat10 = mat10 + packaging + closures + labels + shipping;

                const calcPrice = {
                    "0.5": calcBottlePricing(costPerLiter, 0.5, bottleMat05, userPrice["0.5"]),
                    "0.7": calcBottlePricing(costPerLiter, 0.7, bottleMat07, userPrice["0.7"]),
                    "1.0": calcBottlePricing(costPerLiter, 1.0, bottleMat10, userPrice["1.0"])
                };

                const mixComponents = [{
                    fruit: fruitClean,
                    percent: 100
                }];

                // ------------------------------
                // 3Ô∏è‚É£ Verd√ºnnung / Endwerte
                // ------------------------------
                const targetAbv = parseFloat(document.getElementById("calcTargetAbv")?.value) || realAbv;
                const endVol = realAA / (targetAbv / 100);
                const waterNeeded = endVol - realVol;

                let finalVolume, finalStrength;

                const plannedDilution = {
                    realVolume: realVol,
                    realStrength: realAbv,
                    AA: realAA,
                    targetAbv,
                    targetVolume: endVol,
                    waterNeeded: waterNeeded
                };


                if (mode === "diluted") {
                    finalVolume = endVol;
                    finalStrength = targetAbv;
                } else {
                    finalVolume = realVol;
                    finalStrength = realAbv;
                }

                // ------------------------------
                // 4Ô∏è‚É£ Produktname (analog saveBarrelAsProduct)
                // ------------------------------
                let productName = `${fruitClean} ‚Äì Brand `;
                if (burnNumber) productName += ` ${burnNumber} vom ${burnDate}`;
                else productName += `vom ${burnDate}`;
                productName += ` (${finalVolume.toFixed(2)} L @ ${finalStrength.toFixed(1)}% vol)`;

                // ------------------------------
                // 5Ô∏è‚É£ Produktobjekt (wie bei "Produkt anlegen",
                //    aber remainingVolume = 0, status="used")
                // ------------------------------
                const newProduct = {
                    id: "product_" + Date.now(),
                    name: productName,
                    burnDate,
                    burnNumber,
                    volumeL: finalVolume,
                    strength: finalStrength,
                    remainingVolume: 0,      // komplett in Lagerbeh√§lter
                    totalCosts,
                    costPerLiter,
                    userPrice,
                    calcPrice,
                    mixComponents,
                    origin: "product",
                    status: "used",
                    created: new Date().toISOString(),
                    plannedDilution
                };

                const products = JSON.parse(localStorage.getItem("products") || "[]");
                products.push(newProduct);
                localStorage.setItem("products", JSON.stringify(products));

                // ------------------------------
                // 6Ô∏è‚É£ In Lagerbeh√§lter eintragen
                // ------------------------------
                if (!st.contents) st.contents = [];

                st.contents.push({
                    id: "item_" + Date.now(),
                    productId: newProduct.id,
                    source: productName,
                    volume: finalVolume,
                    strength: finalStrength,
                    fruitData: { [fruitClean || "Unbekannt"]: finalVolume },
                    dateAdded: new Date().toISOString().split("T")[0],
                    waterAdded: plannedDilution.waterAdded || 0,
                    plannedDilution
                });

                localStorage.setItem(storageKey, JSON.stringify(st));

                // ------------------------------
                // 7Ô∏è‚É£ Quelle korrekt behandeln
                // ------------------------------

                if (key.startsWith("barrel_")) {

                    // üî• ECHTES FASS ‚Üí leeren, damit es wiederverwendbar ist
                    const emptied = {
                        fruit: "",
                        start: "",
                        days: "",
                        end: "",
                        volume: "",
                        oechsle: "",
                        actualAlcohol: "",
                        actualStrength: "",
                        burnDate: "",
                        burnNumber: "",
                        burnTimeHours: "",
                        status: "used",
                        usedAt: new Date().toISOString(),
                        usedFor: "storage",
                        resultProductId: newProduct.id
                    };

                    localStorage.setItem(key, JSON.stringify(emptied));

                } else if (key.startsWith("archive_")) {

                    // üì¶ ARCHIV ‚Üí NICHT leeren, nur markieren
                    const a = JSON.parse(localStorage.getItem(key) || "{}");

                    a.status = "used";
                    a.usedAt = new Date().toISOString();
                    a.usedFor = "storage";
                    a.resultProductId = newProduct.id;

                    localStorage.setItem(key, JSON.stringify(a));
                }

                // Dialog schlie√üen & UI reset
                closeBarrelStorageDialog();
                if (typeof fillCalcBarrelSelect === "function")
                    fillCalcBarrelSelect();

                alert("Fass wurde erfolgreich eingelagert!");
            }





            function closeBarrelStorageDialog() {
                document.getElementById("barrelStorageDialog").style.display = "none";
            }


            // ==========================================
            //  CHARGE ‚Üí Dialog √∂ffnen
            //  (Modus: 'raw' oder 'diluted')
            // ==========================================
            function openBatchStorageDialog(mode) {
                currentBatchStorageMode = mode || "raw";

                const dialog = document.getElementById("batchStorageDialog");
                const infoDiv = document.getElementById("batchStorageInfo");
                const select = document.getElementById("batchStorageSelect");

                if (!dialog || !infoDiv || !select) return;

                // Aktuelles Chargenergebnis holen
                const res = window.latestBatchResult || {};

                const realVolume = parseFloat(document.getElementById("batchActualVolumeL")?.value) || 0;
                const realStrength = parseFloat(document.getElementById("batchActualAbv")?.value) || 0;
                const targetAbv = res.targetAbv || parseFloat(document.getElementById("batchTargetAbv")?.value) || realStrength || 0;

                let AA = res.AA;
                if (!AA || isNaN(AA) || AA <= 0) {
                    if (realVolume > 0 && realStrength > 0) {
                        AA = realVolume * (realStrength / 100);
                    }
                }

                let endVolumeL = res.endVolumeL;
                if (!endVolumeL || isNaN(endVolumeL) || endVolumeL <= 0) {
                    if (AA > 0 && targetAbv > 0) {
                        endVolumeL = AA / (targetAbv / 100);
                    } else {
                        endVolumeL = realVolume;
                    }
                }

                const waterNeeded = (AA > 0 && targetAbv > 0 && realVolume > 0)
                    ? (AA / (targetAbv / 100) - realVolume)
                    : 0;

                // Info-Text im Dialog
                let modeText = (mode === "diluted")
                    ? "Die Charge wird in Trinkst√§rke eingelagert."
                    : "Die Charge wird als Rohbrand (unverd√ºnnt) eingelagert.";

                infoDiv.innerHTML =
                    `${modeText}<br><br>` +
                    `Gemessene Menge: <strong>${realVolume.toFixed(2)} L @ ${realStrength.toFixed(1)}% vol</strong><br>` +
                    `Zielst√§rke: <strong>${targetAbv.toFixed(1)}% vol</strong><br>` +
                    `Endvolumen bei Zielst√§rke: <strong>${endVolumeL.toFixed(2)} L</strong><br>` +
                    `Ben√∂tigtes Wasser: <strong>${waterNeeded.toFixed(2)} L</strong>`;

                // Lagerbeh√§lter-Dropdown f√ºllen
                select.innerHTML = `<option value="">‚Äî Beh√§lter w√§hlen ‚Äî</option>`;
                for (const key in localStorage) {
                    if (!key.startsWith("storage_")) continue;
                    const st = JSON.parse(localStorage.getItem(key) || "{}");
                    if (!st.id) continue;

                    const current = st.currentVolume || 0;
                    const cap = st.capacity || 0;
                    const label = st.name
                        ? `${st.name} (${current.toFixed(2)} / ${cap.toFixed(2)} L)`
                        : `${st.id} (${current.toFixed(2)} / ${cap.toFixed(2)} L)`;

                    const opt = document.createElement("option");
                    opt.value = st.id;
                    opt.textContent = label;
                    select.appendChild(opt);
                }

                dialog.style.display = "block";
            }




            // ==========================================
            //  CHARGE ‚Üí Dialog schlie√üen
            // ==========================================
            function closeBatchStorageDialog() {
                const dialog = document.getElementById("batchStorageDialog");
                if (dialog) dialog.style.display = "none";
            }



            function saveBatchAsProduct(mode) {

                // Sicherheitsabfrage
                const ok = confirm("M√∂chten Sie diese Charge wirklich als Produkt anlegen?\n\nDieser Vorgang kann nicht r√ºckg√§ngig gemacht werden!");
                if (!ok) {
                    return; // Vorgang abbrechen
                }

                if (saveBatchAsProduct.isRunning) return;
                saveBatchAsProduct.isRunning = true;

                if (!mode) mode = "raw";

                // -----------------------------
                // BASISDATEN
                // -----------------------------
                const res = window.latestBatchResult || {};

                const realVolume = parseFloat(document.getElementById("batchActualVolumeL")?.value) || 0;
                const realStrength = parseFloat(document.getElementById("batchActualAbv")?.value) || 0;
                const targetAbvInput = parseFloat(document.getElementById("batchTargetAbv")?.value) || 0;

                if (!realVolume || !realStrength) {
                    alert("Bitte tats√§chliche Destillatmenge und -st√§rke eingeben.");
                    saveBatchAsProduct.isRunning = false;
                    return;
                }

                let AA = res.AA || (realVolume * (realStrength / 100));

                let targetAbv = res.targetAbv || targetAbvInput || realStrength;
                let endVolumeL = res.endVolumeL || (AA / (targetAbv / 100));

                const waterNeeded = endVolumeL - realVolume;

                // -----------------------------
                // Kosten extrahieren
                // -----------------------------
                const summaryText = document.getElementById("batchSummary")?.innerText || "";

                function extractEuro(label) {
                    const idx = summaryText.indexOf(label);
                    if (idx === -1) return NaN;
                    const sub = summaryText.slice(idx + label.length);
                    const m = sub.match(/([0-9]+(?:[.,][0-9]+)?)\s*‚Ç¨/);
                    if (!m) return NaN;
                    return parseFloat(m[1].replace(",", "."));
                }

                const totalCosts = extractEuro("Gesamtkosten:") || 0;

                let costPerLiter = 0;
                if (mode === "raw") costPerLiter = totalCosts / realVolume;
                else costPerLiter = totalCosts / endVolumeL;

                // Benutzerpreise
                const p05 = parseFloat(document.getElementById("batchBottle05Price")?.value);
                const p07 = parseFloat(document.getElementById("batchBottle07Price")?.value);
                const p10 = parseFloat(document.getElementById("batchBottle10Price")?.value);

                const userPrice = {
                    "0.5": isNaN(p05) ? null : p05,
                    "0.7": isNaN(p07) ? null : p07,
                    "1.0": isNaN(p10) ? null : p10
                };

                const mat05 = parseFloat(document.getElementById("batchBottle05Cost")?.value) || 0;
                const mat07 = parseFloat(document.getElementById("batchBottle07Cost")?.value) || 0;
                const mat10 = parseFloat(document.getElementById("batchBottle10Cost")?.value) || 0;

                const packaging = parseFloat(document.getElementById("batchPackaging")?.value) || 0;
                const closures = parseFloat(document.getElementById("batchClosures")?.value) || 0;
                const labels = parseFloat(document.getElementById("batchLabels")?.value) || 0;
                const shipping = parseFloat(document.getElementById("batchShipping")?.value) || 0;

                const bottleMat05 = mat05 + packaging + closures + labels + shipping;
                const bottleMat07 = mat07 + packaging + closures + labels + shipping;
                const bottleMat10 = mat10 + packaging + closures + labels + shipping;

                const calcPrice = {
                    "0.5": calcBottlePricing(costPerLiter, 0.5, bottleMat05, userPrice["0.5"]),
                    "0.7": calcBottlePricing(costPerLiter, 0.7, bottleMat07, userPrice["0.7"]),
                    "1.0": calcBottlePricing(costPerLiter, 1.0, bottleMat10, userPrice["1.0"])
                };

                // -----------------------------
                // MISCHUNGS-ANTEILE
                // -----------------------------
                const usedBarrels = Array.isArray(res.usedBarrels) ? res.usedBarrels : [];

                const fruitVolumes = {};
                let totalVolForMix = 0;
                let firstFruit = "";

                usedBarrels.forEach(entry => {
                    const key = entry.type === "real" ? "barrel_" + entry.id : entry.id;
                    const b = JSON.parse(localStorage.getItem(key) || "{}");
                    if (!b) return;

                    const raw = b.fruit || "Unbekannt";
                    if (!firstFruit) firstFruit = raw;

                    const clean = raw.replace(/\([^)]*\d[^)]*\)$/g, "").trim();
                    const vol = parseFloat(b.actualAlcohol || b.volume) || 0;

                    fruitVolumes[clean] = (fruitVolumes[clean] || 0) + vol;
                    totalVolForMix += vol;
                });

                let mixComponents = [];
                const fruits = Object.keys(fruitVolumes);

                if (fruits.length <= 1) {
                    const fruit = fruits[0] || firstFruit || "Unbekannt";
                    mixComponents = [{ fruit, percent: 100 }];
                } else {
                    mixComponents = fruits.map(f => ({
                        fruit: f,
                        percent: totalVolForMix > 0
                            ? fruitVolumes[f] / totalVolForMix * 100
                            : 0
                    }));
                }

                // -----------------------------
                // PRODUKTNAME
                // -----------------------------
                const today = new Date().toISOString().split("T")[0];

                let baseName =
                    fruits.length <= 1
                        ? `${firstFruit} ‚Äì Charge vom ${today}`
                        : `Cuv√©e ‚Äì Charge vom ${today}`;

                let finalVolume = (mode === "raw") ? realVolume : endVolumeL;
                let finalStrength = (mode === "raw") ? realStrength : targetAbv;

                const productName =
                    `${baseName} (${finalVolume.toFixed(2)} L @ ${finalStrength.toFixed(1)}% vol)`;

                // -----------------------------
                // Produktobjekt erzeugen
                // -----------------------------
                const product = buildProductObject({
                    name: productName,
                    volumeL: finalVolume,
                    strength: finalStrength,
                    remainingVolume: finalVolume,
                    totalCosts,
                    costPerLiter,
                    userPrice,
                    calcPrice,
                    mixComponents,
                    plannedDilution: {
                        realVolume,
                        realStrength,
                        AA,
                        targetAbv,
                        targetVolume: endVolumeL,
                        waterNeeded
                    },
                    origin: "charge"
                });

                saveProduct(product);

                // ---------------------------------------
                // üîí Quellen (F√§sser / Archive) markieren
                // ---------------------------------------
                usedBarrels.forEach(entry => {

                    const key = entry.type === "real"
                        ? "barrel_" + entry.id
                        : entry.id; // archive_...

                    const src = JSON.parse(localStorage.getItem(key) || "{}");
                    if (!src) return;

                    // üî• echtes Fass ‚Üí leeren
                    if (key.startsWith("barrel_")) {

                        const emptied = {
                            fruit: "",
                            start: "",
                            days: "",
                            end: "",
                            volume: "",
                            oechsle: "",
                            actualAlcohol: "",
                            actualStrength: "",
                            burnDate: "",
                            burnNumber: "",
                            burnTimeHours: "",
                            status: "used",
                            usedAt: new Date().toISOString(),
                            usedFor: "charge",
                            resultProductId: product.id
                        };

                        localStorage.setItem(key, JSON.stringify(emptied));

                    }
                    // üì¶ Archiv ‚Üí NICHT leeren, nur markieren
                    else if (key.startsWith("archive_")) {

                        src.status = "used";
                        src.usedAt = new Date().toISOString();
                        src.usedFor = "charge";
                        src.resultProductId = product.id;

                        localStorage.setItem(key, JSON.stringify(src));
                    }
                });


                alert("Charge wurde als Produkt gespeichert.");
                saveBatchAsProduct.isRunning = false;

                // --- Felder der Chargenkalkulation zur√ºcksetzen ---
                [
                    "batchActualVolumeL",
                    "batchActualAbv",
                    "batchTargetAbv",
                    "batchPackaging",
                    "batchClosures",
                    "batchLabels",
                    "batchShipping",
                    "batchBottle05Cost",
                    "batchBottle07Cost",
                    "batchBottle10Cost",
                    "batchBottle05Price",
                    "batchBottle07Price",
                    "batchBottle10Price"
                ].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = "";
                });

                // Ergebnisse l√∂schen
                [
                    "batchSummary",
                    "batchDilutionResult",
                    "batchBottlesResult"
                ].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = "";
                });

                // Fassliste der Chargenkalkulation neu laden
                if (typeof fillBatchBarrelList === "function") {
                    fillBatchBarrelList();
                }

                if (typeof fillCalcBarrelSelect === "function") {
                    fillCalcBarrelSelect();
                }


                // Auswahl im Dropdown l√∂schen (falls vorhanden)
                const barrelSelect = document.getElementById("batchFruit");
                if (barrelSelect) barrelSelect.value = "";

                // Globale Ergebnisse zur√ºcksetzen
                window.latestBatchResult = null;

            }





            function buildProductObject(data) {
                return {
                    id: "product_" + Date.now(),
                    name: data.name,
                    burnDate: data.burnDate,
                    burnNumber: data.burnNumber,
                    volumeL: data.volumeL,
                    strength: data.strength,
                    remainingVolume: data.remainingVolume,
                    totalCosts: data.totalCosts || null,
                    costPerLiter: data.costPerLiter || null,
                    userPrice: data.userPrice || null,
                    calcPrice: data.calcPrice || null,
                    mixComponents: data.mixComponents || null,
                    origin: "product",
                    status: data.status || null,
                    created: new Date().toISOString(),
                    plannedDilution: data.plannedDilution || null
                };
            }
























            // ===== Chargen-Kalkulation =====
            function initBatchPage() {
                const fruitSel = document.getElementById('batchFruit');
                fruitSel.innerHTML = '';
                for (const name in fruits.liter) {
                    const opt = document.createElement('option'); opt.value = name; opt.text = name; fruitSel.appendChild(opt);
                }

                // ‚≠ê NEU: Fassliste f√ºllen
                fillBatchBarrelList();

                document.getElementById('batchDilutionResult').innerHTML = '';
                document.getElementById('batchRawCostResult').innerHTML = '';
                document.getElementById('batchEnergyLaborResult').innerHTML = '';
                document.getElementById('batchFixedCostResult').innerHTML = '';
                document.getElementById('batchTaxResult').innerHTML = '';
                document.getElementById('batchBottlesResult').innerHTML = '';
                document.getElementById('batchSummary').innerHTML = '';
                document.getElementById('batchActualYieldResult').innerHTML = '';
                document.getElementById('batchActualBottleResult').innerHTML = '';
                updateBatchLiterPrices();
                calculateBatchCalc();
                updateBatchStartButton();

            }


            function fillBatchBarrelList() {
                const box = document.getElementById("batchBarrelList");
                box.innerHTML = "";

                // Container f√ºr Dropdown + Auswahl
                const wrapper = document.createElement("div");
                wrapper.style.display = "flex";
                wrapper.style.flexDirection = "column";
                wrapper.style.gap = "10px";

                // --------------------------------------
                // Dropdown: Reale F√§sser
                // --------------------------------------
                const realSelect = document.createElement("select");
                realSelect.id = "batchRealSelect";
                realSelect.style.width = "100%";
                realSelect.innerHTML = `<option value="">‚Äî Fass ausw√§hlen ‚Äî</option>`;

                // --------------------------------------
                // Dropdown: Archiv-F√§sser
                // --------------------------------------
                const archSelect = document.createElement("select");
                archSelect.id = "batchArchSelect";
                archSelect.style.width = "100%";
                archSelect.innerHTML = `<option value="">‚Äî Archiv-Eintrag ausw√§hlen ‚Äî</option>`;

                // --------------------------------------
                // Auswahlcontainer
                // --------------------------------------
                const selectedBox = document.createElement("div");
                selectedBox.id = "batchSelectedList";
                selectedBox.style.marginTop = "10px";

                // --------------------------------------
                // Reale F√§sser einlesen
                // --------------------------------------
                for (const key in localStorage) {
                    if (!key.startsWith("barrel_")) continue;

                    const id = key.replace("barrel_", "");
                    const b = JSON.parse(localStorage.getItem(key) || "{}");

                    if (b.status === "used") continue;
                    if (!b.actualAlcohol || !b.actualStrength) continue;

                    const opt = document.createElement("option");
                    opt.value = id; // nur die Fass-ID, wie fr√ºher
                    opt.textContent = `Fass ${id} ‚Äì ${b.fruit} (${b.actualAlcohol} L @ ${b.actualStrength}%)`;
                    realSelect.appendChild(opt);
                }

                // --------------------------------------
                // Archiv-Eintr√§ge einlesen
                // --------------------------------------
                for (const key in localStorage) {
                    if (!key.startsWith("archive_")) continue;

                    const b = JSON.parse(localStorage.getItem(key) || "{}");

                    if (b.status === "used") continue;
                    if (b.remainingLiters !== undefined && b.remainingLiters <= 0) continue;
                    if (!b.actualAlcohol || !b.actualStrength) continue;

                    const id = key.replace("archive_", "");

                    const opt = document.createElement("option");

                    // WICHTIG:
                    // value = kompletter archive-Key (wie im alten Code in item.id)
                    opt.value = key;

                    opt.textContent =
                        `Archiv ${id} ‚Äì ${b.fruit} (${b.actualAlcohol} L @ ${b.actualStrength}%)`;

                    archSelect.appendChild(opt);
                }


                // --------------------------------------
                // Auswahl hinzuf√ºgen (real)
                // --------------------------------------
                realSelect.addEventListener("change", () => {
                    const id = realSelect.value;
                    if (!id) return;

                    // type "real", id = z.B. "1"
                    addSelectedItem("real", id);
                    realSelect.value = "";
                });

                // --------------------------------------
                // Auswahl hinzuf√ºgen (archive)
                // --------------------------------------
                archSelect.addEventListener("change", () => {
                    const key = archSelect.value;
                    if (!key) return;

                    // type "archive", id = kompletter Key wie "archive_Birnen ‚Äì Brand 1 vom - 2025-12-10"
                    addSelectedItem("archive", key);
                    archSelect.value = "";
                });

                // --------------------------------------
                // Funktion: Eintrag in Auswahlliste
                // --------------------------------------
                function addSelectedItem(type, id) {
                    // eindeutige ID, zur Sicherheit Type mit hineinnehmen
                    const elemId = "batchSel_" + type + "_" + id;
                    if (document.getElementById(elemId)) return;

                    const div = document.createElement("div");
                    div.id = elemId;
                    div.style.padding = "6px";
                    div.style.border = "1px solid #ccc";
                    div.style.borderRadius = "6px";
                    div.style.marginBottom = "4px";
                    div.style.background = "#f7f7f7";

                    // Text + Entfernen-Button
                    const label = document.createElement("span");
                    label.innerHTML = `<strong>${type === "real" ? "Fass" : "Archiv"}</strong> ${id}`;
                    div.appendChild(label);

                    const btn = document.createElement("button");
                    btn.textContent = "‚úñ";
                    btn.style.float = "right";
                    btn.type = "button";
                    btn.onclick = function () {
                        div.remove();
                        // nach dem Entfernen neu berechnen
                        if (typeof calculateBatchCalc === "function") {
                            calculateBatchCalc();
                        }
                    };
                    div.appendChild(btn);

                    // üö® WICHTIGER TEIL:
                    // "Unsichtbare" Checkbox, damit calculateBatchCalc()
                    // genau dieselbe Struktur sieht wie vorher.
                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.value = id;
                    checkbox.dataset.type = type;
                    checkbox.checked = true;
                    checkbox.style.display = "none";
                    checkbox.onchange = function () {
                        if (typeof calculateBatchCalc === "function") {
                            calculateBatchCalc();
                        }
                    };
                    div.appendChild(checkbox);

                    // (optional) zus√§tzliches Hidden-Input, falls du das irgendwo brauchst
                    const hidden = document.createElement("input");
                    hidden.type = "hidden";
                    hidden.name = "batch_item";
                    hidden.value = id;
                    hidden.dataset.type = type;
                    div.appendChild(hidden);

                    selectedBox.appendChild(div);

                    // direkt nach dem Hinzuf√ºgen berechnen
                    if (typeof calculateBatchCalc === "function") {
                        calculateBatchCalc();
                    }
                }

                // --------------------------------------
                // Alles einbauen
                // --------------------------------------
                wrapper.appendChild(realSelect);
                wrapper.appendChild(archSelect);
                wrapper.appendChild(selectedBox);
                box.appendChild(wrapper);
            }




            function removeBatchBarrel(id) {
                const el = document.getElementById("batchSel_" + id);
                if (el) el.remove();
                calculateBatchCalc();
            }







            function renderBatchMode() {
                const mode = document.querySelector('input[name="batchMode"]:checked').value;
                document.getElementById('batchModeYieldBox').style.display = (mode === 'yield') ? 'block' : 'none';
                document.getElementById('batchModeMeasuredBox').style.display = (mode === 'measured') ? 'block' : 'none';
                calculateBatchCalc();
            }

            function updateBatchLiterPrices() {
                const b05 = parseFloat(document.getElementById('batchBottle05Price').value) || 0;
                const b07 = parseFloat(document.getElementById('batchBottle07Price').value) || 0;
                const b10 = parseFloat(document.getElementById('batchBottle10Price').value) || 0;
                document.getElementById('batchLiterPrice05').innerText = `‚Üí ${(b05 / 0.5).toFixed(2)} ‚Ç¨/L`;
                document.getElementById('batchLiterPrice07').innerText = `‚Üí ${(b07 / 0.7).toFixed(2)} ‚Ç¨/L`;
                document.getElementById('batchLiterPrice10').innerText = `‚Üí ${(b10 / 1.0).toFixed(2)} ‚Ç¨/L`;
            }


            function getSelectedFassValues() {
                const result = {
                    mashLiters: 0,
                    actualVol: 0,
                    actualAA: 0,
                    fruits: new Set()
                };

                const checks = document.querySelectorAll('#batchBarrelList input[type="checkbox"]:checked');

                checks.forEach(cb => {
                    const type = cb.dataset.type;
                    const id = cb.value;
                    const key = (type === "real") ? "barrel_" + id : id;

                    const b = JSON.parse(localStorage.getItem(key) || "{}");

                    // Maischemenge
                    if (b.volume) result.mashLiters += parseFloat(b.volume);

                    // Frucht
                    if (b.fruit) result.fruits.add(b.fruit);

                    // Tats√§chliches Destillat
                    if (b.actualAlcohol && b.actualStrength) {
                        const vol = parseFloat(b.actualAlcohol);
                        const abv = parseFloat(b.actualStrength);
                        result.actualVol += vol;
                        result.actualAA += vol * (abv / 100);
                    }
                });

                return result;
            }



            function matchFruitName(rawFruit) {
                if (!rawFruit) return null;

                const f = rawFruit.trim().toLowerCase();

                // 1) Exakte √úbereinstimmung
                if (fruits.liter[rawFruit]) return rawFruit;

                // 2) Finde Eintrag, der mit dem Rohstoff beginnt
                for (const name in fruits.liter) {
                    if (name.toLowerCase().startsWith(f)) {
                        return name;
                    }
                }

                return null; // nichts gefunden ‚Üí vermutlich kg-basiert
            }





            // ======================================================
            // ===============  KORRIGIERTE FUNKTION  ===============
            // ======================================================
            function calculateBatchCalc() {

                updateBatchLiterPrices();
                const f = getSelectedFassValues();

                // ------------------------------------------
                // 1) F√§sser ‚Üí tats√§chliche Ausbringung √ºbernehmen
                // ------------------------------------------
                if (f.actualVol > 0) {

                    if (!isBatchActualVolUserModified) {
                        document.getElementById("batchActualVolumeL").value = f.actualVol.toFixed(2);
                    }

                    if (!isBatchActualAbvUserModified) {
                        const avgAbv = (f.actualAA / f.actualVol) * 100;
                        document.getElementById("batchActualAbv").value = avgAbv.toFixed(1);
                    }
                }

                // ------------------------------------------
                // 2) Rohstoff Dropdown korrekt setzen
                // ------------------------------------------
                const batchItems = document.querySelectorAll('#batchSelectedList input[name="batch_item"]');
                let selectedFruits = new Set();

                batchItems.forEach(item => {
                    const type = item.dataset.type;
                    const id = item.value;
                    const key = type === "real" ? "barrel_" + id : id;
                    const b = JSON.parse(localStorage.getItem(key) || "{}");
                    if (b.fruit) selectedFruits.add(b.fruit);
                });


                const fruitDropdown = document.getElementById("batchFruit");

                if (selectedFruits.size === 0) {
                    fruitDropdown.disabled = false;
                }
                else if (selectedFruits.size === 1) {
                    const onlyFruit = [...selectedFruits][0];
                    fruitDropdown.disabled = false;

                    if (![...fruitDropdown.options].some(o => o.value === onlyFruit)) {
                        const opt = document.createElement("option");
                        opt.value = onlyFruit;
                        opt.textContent = onlyFruit;
                        fruitDropdown.appendChild(opt);
                    }

                    fruitDropdown.value = onlyFruit;
                }
                else {
                    fruitDropdown.disabled = true;
                    fruitDropdown.innerHTML = `<option>Mehrere Rohstoffe</option>`;
                }

                // ------------------------------------------
                // 3) Eingaben auslesen
                // ------------------------------------------
                const mode = document.querySelector('input[name="batchMode"]:checked')?.value;
                const targetAbv = parseFloat(document.getElementById('batchTargetAbv').value);
                const density = parseFloat(document.getElementById('batchDensity').value);
                const pricePerKg = parseFloat(document.getElementById('batchRawPricePerKg').value);

                const mashLiters = f.mashLiters;
                const totalAA = f.actualAA;
                const totalActualVol = f.actualVol;

                if (mashLiters > 0) {
                    document.getElementById("batchMashLiters").value = mashLiters.toFixed(2);
                    document.getElementById("batchPureAlcohol").value = totalAA.toFixed(2);
                }

                // ------------------------------------------
                // 4) Energie / Arbeit / Fixkosten
                // ------------------------------------------
                const hoursInput = document.getElementById("batchHours");

                // Arbeitszeit ist **immer unabh√§ngig**
                const laborHours = parseFloat(document.getElementById('batchLaborHours').value) || 0;
                const laborRate = parseFloat(document.getElementById('batchLaborRate').value) || 0;
                const laborCost = laborHours * laborRate;

                // Brenndauer summieren ‚Üí nur f√ºr Energie!
                let burnTimeSum = 0;
                batchItems.forEach(item => {
                    const type = item.dataset.type;
                    const id = item.value;
                    const key = type === "real" ? "barrel_" + id : id;
                    const b = JSON.parse(localStorage.getItem(key) || "{}");
                    if (b.burnTimeHours) burnTimeSum += parseFloat(b.burnTimeHours);
                });


                // Brenndauer automatisch f√ºllen, wenn User nicht manuell ge√§ndert hat
                let realHours = parseFloat(hoursInput.value) || 0;

                if (!isBatchHoursUserModified && burnTimeSum > 0) {
                    hoursInput.value = burnTimeSum.toFixed(1);
                    realHours = burnTimeSum;
                }

                const powerKw = parseFloat(document.getElementById('batchPowerKw').value) || 0;
                const priceKwh = parseFloat(document.getElementById('batchPriceKwh').value) || 0;

                const energyKwh = realHours * powerKw;
                const energyCost = energyKwh * priceKwh;

                document.getElementById('batchEnergyLaborResult').innerHTML =
                    `Brenndauer gesamt: <strong>${realHours.toFixed(1)} h</strong><br>
                    Energie: ${energyKwh.toFixed(2)} kWh ‚Üí <strong>${energyCost.toFixed(2)} ‚Ç¨</strong><br>
                    Arbeit: ${laborHours.toFixed(1)} h √ó ${laborRate.toFixed(2)} ‚Ç¨/h ‚Üí <strong>${laborCost.toFixed(2)} ‚Ç¨</strong>`;

                // ------------------------------------------
                // 5) Reinalkohol ‚Äì Priorit√§t
                // ------------------------------------------
                let AA = NaN;
                let infoHtml = "";

                // Prio 1: Fassdaten
                if (totalAA > 0) {
                    AA = totalAA;
                    infoHtml =
                        `Quelle: <strong>Fassdaten</strong><br>
                        Gesamt-Destillat: ${totalActualVol.toFixed(2)} L<br>
                        Gesamt-Reinalkohol: ${totalAA.toFixed(2)} L`;
                }

                // Prio 2: manuelle Eingabe
                const userVol = parseFloat(document.getElementById("batchActualVolumeL").value);
                const userAbv = parseFloat(document.getElementById("batchActualAbv").value);

                if (isNaN(AA) && userVol > 0 && userAbv > 0) {
                    AA = userVol * (userAbv / 100);
                    infoHtml =
                        `Quelle: <strong>Tats√§chliche Ausbringung</strong><br>
             ${userVol.toFixed(2)} L √ó ${userAbv.toFixed(1)} % = <strong>${AA.toFixed(2)} L</strong>`;
                }

                // Prio 3: Ausbeutesatz
                if (isNaN(AA) && mode === "yield" && mashLiters > 0) {
                    const matchedFruit = matchFruitName(fruitDropdown.value);
                    const yieldVal = matchedFruit ? fruits.liter[matchedFruit] : 0;

                    if (yieldVal > 0) {
                        AA = mashLiters * (yieldVal / 100);
                        infoHtml =
                            `Quelle: <strong>Ausbeutesatz</strong><br>
                 ${mashLiters.toFixed(1)} L ¬∑ ${matchedFruit}<br>
                 ${yieldVal} L AA/100 L ‚Üí <strong>${AA.toFixed(2)} L</strong>`;
                    }
                }

                if (isNaN(AA)) {
                    infoHtml = "<em>Bitte Messwerte oder Ausbeutesatz eingeben.</em>";
                }

                // ------------------------------------------
                // 6) Rohstoffkosten
                // ------------------------------------------
                let mashKg = mashLiters * density;
                let rawCost = mashKg * pricePerKg;

                if (isNaN(mashKg) || isNaN(rawCost)) {
                    document.getElementById("batchRawCostResult").innerHTML =
                        `<em>Bitte g√ºltige Dichte und ‚Ç¨/kg eingeben.</em>`;
                    rawCost = 0;
                } else {
                    document.getElementById("batchRawCostResult").innerHTML =
                        `Maische: <strong>${mashKg.toFixed(1)} kg</strong><br>
                        Rohstoffkosten: <strong>${rawCost.toFixed(2)} ‚Ç¨</strong>`;
                }

                // ------------------------------------------
                // 7) Endvolumen bei Ziel-%vol
                // ------------------------------------------
                let endVolumeL = NaN;
                if (!isNaN(AA) && targetAbv > 0) {
                    endVolumeL = AA / (targetAbv / 100);
                }

                document.getElementById("batchDilutionResult").innerHTML =
                    (!isNaN(endVolumeL))
                        ? `${infoHtml}<br><br>Endvolumen bei ${targetAbv}%: <strong>${endVolumeL.toFixed(2)} L</strong>`
                        : `${infoHtml}<br><em>Bitte Ziel-% angeben.</em>`;



                // -------------------------------------------
                // 7a) Geplante Verd√ºnnung anzeigen (NEU)
                // -------------------------------------------
                const plannedDiv = document.getElementById("batchDilutionPlanned");

                if (!isNaN(endVolumeL) && totalActualVol > 0 && userAbv > 0) {

                    const waterPlanned = endVolumeL - totalActualVol;

                    plannedDiv.innerHTML = `
                    <strong>Geplante Verd√ºnnung:</strong><br>
                    Von: ${totalActualVol.toFixed(2)} L @ ${userAbv.toFixed(1)}% vol<br>
                    Auf: ${endVolumeL.toFixed(2)} L @ ${targetAbv.toFixed(1)}% vol<br>
                    Wasserbedarf: <strong>${waterPlanned.toFixed(2)} L</strong>
                `;
                }
                else {
                    plannedDiv.innerHTML = "";
                }


                // ------------------------------------------
                // 8) Alkoholsteuer
                // ------------------------------------------
                const TAX_RATE = parseFloat(document.getElementById("batchTaxRate").value) || 10.22;
                let totalTax = 0;

                let taxHtml = "<strong>üìú Alkoholsteuer</strong><br>";

                function clean(n) { return (n || "").replace(/\s*\([^)]*\)/g, "").trim(); }

                if (selectedFruits.size <= 1 && mode === "yield") {

                    const fruitName = fruitDropdown.value;
                    const cleanFruit = clean(fruitName);

                    let yieldValue = 0;
                    for (const full in fruits.liter) {
                        if (clean(full) === cleanFruit) {
                            yieldValue = fruits.liter[full];
                            break;
                        }
                    }

                    if (yieldValue > 0) {
                        const taxAA = (mashLiters * yieldValue) / 100;
                        totalTax = taxAA * TAX_RATE;

                        taxHtml += `
                Rohstoff: <strong>${fruitName}</strong><br>
                Maischemenge: ${mashLiters.toFixed(1)} L<br>
                Ausbeutesatz: ${yieldValue}<br>
                Steuerpflichtiger AA: ${taxAA.toFixed(2)} L<br>
                ‚Üí <strong>${totalTax.toFixed(2)} ‚Ç¨</strong>`;
                    }
                }
                else {
                    taxHtml = "<strong>üìú Alkoholsteuer (je Fass)</strong><br>";

                    batchItems.forEach(item => {
                        const type = item.dataset.type;
                        const id = item.value;
                        const key = type === "real" ? "barrel_" + id : id;
                        const b = JSON.parse(localStorage.getItem(key) || "{}");


                        const fruit = clean(b.fruit);
                        const vol = parseFloat(b.volume) || 0;

                        let yieldValue = 0;
                        for (const full in fruits.liter) {
                            if (clean(full) === fruit) {
                                yieldValue = fruits.liter[full];
                                break;
                            }
                        }

                        if (!yieldValue) {
                            taxHtml += `${fruit} ‚Äì kein Ausbeutesatz ‚Üí 0 ‚Ç¨<br>`;
                            return;
                        }

                        const taxAA = (vol * yieldValue) / 100;
                        const cost = taxAA * TAX_RATE;
                        totalTax += cost;

                        taxHtml += `${fruit}: ${vol} L ¬∑ Y=${yieldValue} ‚Üí <strong>${cost.toFixed(2)} ‚Ç¨</strong><br>`;
                    });

                    taxHtml += `<br><strong>Gesamt: ${totalTax.toFixed(2)} ‚Ç¨</strong>`;
                }

                document.getElementById("batchTaxResult").innerHTML = taxHtml;

                // ------------------------------------------
                // 9) Flaschen
                // ------------------------------------------
                let bottlesCost = 0;
                let revenue = 0;

                if (!isNaN(endVolumeL)) {
                    const n05 = Math.floor(endVolumeL / 0.5);

                    const costPerBottle =
                        parseFloat(document.getElementById('batchBottle05Cost').value || 0) +
                        parseFloat(document.getElementById('batchPackaging').value || 0) +
                        parseFloat(document.getElementById('batchClosures').value || 0) +
                        parseFloat(document.getElementById('batchLabels').value || 0) +
                        parseFloat(document.getElementById('batchShipping').value || 0);

                    bottlesCost = n05 * costPerBottle;
                    revenue = n05 * (parseFloat(document.getElementById('batchBottle05Price').value) || 0);

                    document.getElementById("batchBottlesResult").innerHTML =
                        `0,5 L Flaschen: <strong>${n05}</strong><br>
                        Kosten pro Flasche: ${costPerBottle.toFixed(2)} ‚Ç¨<br>
                        Gesamtkosten: ${bottlesCost.toFixed(2)} ‚Ç¨<br><br>
                        Erl√∂s: ${revenue.toFixed(2)} ‚Ç¨`;
                }
                else {
                    document.getElementById("batchBottlesResult").innerHTML = `<em>Bitte g√ºltige Eingaben machen.</em>`;
                }

                // ------------------------------------------
                // 10) Fixkosten
                // ------------------------------------------
                let fixedPerBatch = 0;

                const stillPrice = parseFloat(document.getElementById('batchStillPrice').value);
                const stillYears = parseFloat(document.getElementById('batchStillYears').value);
                const batchesPerYear = parseFloat(document.getElementById('batchBatchesPerYear').value);

                if (stillPrice > 0 && stillYears > 0 && batchesPerYear > 0) {
                    fixedPerBatch = stillPrice / (stillYears * batchesPerYear);
                }

                document.getElementById("batchFixedCostResult").innerHTML =
                    `Fixkostenanteil: <strong>${fixedPerBatch.toFixed(2)} ‚Ç¨</strong>`;

                // ------------------------------------------
                // 11) Gesamtkosten & Gewinn
                // ------------------------------------------
                const totalCosts =
                    rawCost +
                    energyCost +
                    laborCost +
                    fixedPerBatch +
                    bottlesCost +
                    totalTax;

                const profit = revenue - totalCosts;

                document.getElementById("batchSummary").innerHTML =
                    `<strong>Kosten√ºbersicht</strong><br>
                    Rohstoffkosten: ${rawCost.toFixed(2)} ‚Ç¨<br>
                    Energie + Arbeit: ${(energyCost + laborCost).toFixed(2)} ‚Ç¨<br>
                    Fixkosten: ${fixedPerBatch.toFixed(2)} ‚Ç¨<br>
                    Alkoholsteuer: ${totalTax.toFixed(2)} ‚Ç¨<br>
                    Flaschenkosten: ${bottlesCost.toFixed(2)} ‚Ç¨<br>
                    <hr>
                    Gesamtkosten: ${totalCosts.toFixed(2)} ‚Ç¨<br><br>
                    Erl√∂s: ${revenue.toFixed(2)} ‚Ç¨<br><br>
                    <strong>Gewinn:</strong> ${profit.toFixed(2)} ‚Ç¨`;

                const batchPricingHint = document.getElementById("batchPricingHint");
                if (batchPricingHint) {
                    batchPricingHint.innerHTML = `
                            <strong>Hinweis zur Erl√∂slogik:</strong><br>
                            Die Chargenkalkulation betrachtet den <strong>Gesamterl√∂s der Charge</strong>,
                            unabh√§ngig von sp√§teren Flaschengr√∂√üen.<br><br>
                            Unterschiede zwischen Gewinn hier und Margen einzelner Flaschen
                            entstehen durch <em>Flaschenkosten, Verpackung und Staffelpreise</em>,
                            die erst bei der Abf√ºll- und Verkaufskalkulation ber√ºcksichtigt werden.
                        `;
                }

                // ------------------------------
                // 12) Ergebnis global speichern
                // ------------------------------
                window.latestBatchResult = {
                    endVolumeL: endVolumeL,
                    targetAbv: targetAbv,
                    AA: AA,
                    mashLiters: mashLiters,
                    rawCost: rawCost,
                    energyCost: energyCost,
                    laborCost: laborCost,
                    fixedPerBatch: fixedPerBatch,
                    totalTax: totalTax,
                    bottlesCost: bottlesCost,
                    revenue: revenue,
                    totalCosts: totalCosts,
                    profit: profit,
                    usedBarrels: Array.from(document.querySelectorAll('#batchSelectedList input[name="batch_item"]'))
                        .map(item => ({
                            type: item.dataset.type,
                            id: item.value
                        })),


                    // ‚≠ê Flaschenpreise
                    pricing: {
                        "0.5": parseFloat(document.getElementById('batchBottle05Price').value) || 0,
                        "0.7": parseFloat(document.getElementById('batchBottle07Price').value) || 0,
                        "1.0": parseFloat(document.getElementById('batchBottle10Price').value) || 0
                    },

                    // F√ºr Namen etc.
                    burnDate: new Date().toLocaleDateString("de-DE"),
                    fruit: fruitDropdown.value
                };

            }



            // üîπ Helfer: Frucht-Mischung + Produktname f√ºr eine Charge berechnen
            function getBatchFruitMixAndName(finalVolume, finalStrength) {
                const batchResult = window.latestBatchResult || {};
                const used = Array.isArray(batchResult.usedBarrels) ? batchResult.usedBarrels : [];

                const fruitVolumes = {};
                let totalVol = 0;

                used.forEach(item => {
                    const type = item.type;
                    const id = item.id;

                    const key = (type === "real")
                        ? "barrel_" + id
                        : id; // bei archive ist id = kompletter Key

                    const b = JSON.parse(localStorage.getItem(key) || "{}");
                    if (!b) return;

                    // Fruchtnamen wie bei den F√§ssern bereinigen
                    const fruitRaw = b.fruit || "Unbekannt";
                    const fruit = fruitRaw.replace(/\([^)]*\)/g, "").trim();

                    // Volumen-Basis f√ºr Mischung:
                    // ‚Ä¢ bevorzugt tats√§chliche Alkoholmenge
                    // ‚Ä¢ sonst Maische-Volumen
                    let v = 0;
                    if (b.actualAlcohol) {
                        v = parseFloat(b.actualAlcohol) || 0;
                    } else if (b.volume) {
                        v = parseFloat(b.volume) || 0;
                    }
                    if (!v || v <= 0) return;

                    if (!fruitVolumes[fruit]) fruitVolumes[fruit] = 0;
                    fruitVolumes[fruit] += v;
                    totalVol += v;
                });

                const fruits = Object.keys(fruitVolumes);

                // Basisname bestimmen
                let baseName;
                if (fruits.length === 1) {
                    baseName = fruits[0];                   // z.B. "√Ñpfel"
                } else if (fruits.length > 1) {
                    baseName = fruits.join(" / ");          // z.B. "√Ñpfel / Birnen"
                } else {
                    baseName = batchResult.fruit || "Obstbrand";
                }

                // Mischanteile als Prozent
                const mixComponents = fruits.map(fruit => {
                    const vol = fruitVolumes[fruit] || 0;
                    const percent = totalVol > 0 ? (vol / totalVol * 100) : 0;
                    return {
                        fruit,
                        percent: Math.round(percent * 10) / 10 // 1 Nachkommastelle
                    };
                });

                // Datumsformat wie auf der Fass-Seite: YYYY-MM-DD
                const today = new Date().toISOString().split("T")[0];

                const productName = `${baseName} ‚Äì Charge vom ${today} (${finalVolume.toFixed(2)} L @ ${finalStrength.toFixed(1)}% vol)`;

                return {
                    productName,
                    mixComponents
                };
            }






            // ===============================================
            // INIT: Charge-Seite f√ºr Whisky
            // ===============================================
            function initBatchPage() {
                const sel = document.getElementById("batchRecipeSelect");
                const info = document.getElementById("batchInfoBox");

                if (!sel) return;

                const allRecipes = recipeLoadAll();

                // Nur Mash-Rezepte anzeigen
                const mashRecipes = allRecipes.filter(r => r.type === "mash");

                // Dropdown leeren
                sel.innerHTML = '<option value="">‚Äî Rezept f√ºr Charge w√§hlen ‚Äî</option>';

                // Dropdown bef√ºllen
                mashRecipes.forEach(r => {
                    const opt = document.createElement("option");
                    opt.value = r.id;
                    opt.textContent = r.name || "(ohne Namen)";
                    sel.appendChild(opt);
                });

                // Info zur√ºcksetzen
                if (info) {
                    info.innerHTML = `<em>Noch keine Charge gestartet.</em>`;
                }
            }



            function batchRenderRecipeInfo(recipe) {
                const info = document.getElementById("batchInfoBox");
                if (!info) return;

                info.innerHTML = `
                    <strong>${recipe.name}</strong><br>
                    <span style="font-size:0.9em; color:#555;">
                        Typ: Maischerezept<br>
                        Gesamtmenge laut Rezept: ${recipe.targetVolume || "‚Äî"}<br>
                        Rohstoffe: ${recipe.ingredients?.length || 0} Positionen
                    </span>
                `;
            }



            // ===============================================
            // Rohstoffe aus Rezept anzeigen (Schritt 5 ‚Äì angepasst an deine Struktur)
            // ===============================================
            function batchRenderMaterialList(recipe) {
                const box = document.getElementById("batchMaterialsBox");
                if (!box) return;

                // Sp√§ter wird hier dein echtes Rohstofflager stehen:
                const materials = JSON.parse(localStorage.getItem("materials") || "[]");

                if (!recipe.ingredients || recipe.ingredients.length === 0) {
                    box.innerHTML = "<em>Keine Rohstoffe im Rezept gefunden.</em>";
                    return;
                }

                let html = `
                    <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                        <tr style="border-bottom:1px solid #ccc;">
                            <th style="text-align:left;">Rohstoff</th>
                            <th style="text-align:right;">Ben√∂tigt (kg)</th>
                            <th style="text-align:right;">Verf√ºgbar (kg)</th>
                            <th style="text-align:right;">Diff</th>
                            <th style="text-align:left;">Status</th>
                        </tr>
                `;

                recipe.ingredients.forEach(ing => {
                    // Mash-Rezept ‚Üí amount = Prozent ‚Üí in kg umrechnen
                    let required = 0;

                    if (recipe.type === "mash") {
                        const percent = Number(ing.amount) || 0;
                        const total = Number(recipe.targetVolume) || 0;
                        required = (percent / 100) * total;
                    } else {
                        // Falls es irgendwann andere Rezepttypen gibt:
                        required = Number(ing.amount) || 0;
                    }



                    // Rohstoff im Lager suchen (nach Name!)
                    const mat = materials.find(m => m.name.toLowerCase() === ing.name.toLowerCase());

                    const available = mat ? mat.remaining : 0;
                    const diff = available - required;

                    let status = "‚úî OK";
                    if (available < required) status = "‚ö† zu wenig vorhanden";

                    html += `
                        <tr style="border-bottom:1px solid #eee;">
                            <td>${ing.name}</td>
                            <td style="text-align:right;">${required.toFixed(2)}</td>
                            <td style="text-align:right;">${available.toFixed(2)}</td>
                            <td style="text-align:right;">${diff.toFixed(2)}</td>
                            <td>${status}</td>
                        </tr>
                    `;
                });

                html += "</table>";

                box.innerHTML = html;
            }


            function materialLoadAll() {
                return JSON.parse(localStorage.getItem("materials") || "[]");
            }

            function materialSaveAll(arr) {
                localStorage.setItem("materials", JSON.stringify(arr));
            }


            function materialAdd() {
                const name = document.getElementById("matName").value.trim();
                const category = document.getElementById("matCategory").value;
                let amount = Number(document.getElementById("matAmount").value);
                const unit = document.getElementById("matUnit").value;
                const price = Number(document.getElementById("matPrice").value);

                if (!name || !amount || amount <= 0) {
                    alert("Bitte Name und Menge eingeben.");
                    return;
                }

                const mats = materialLoadAll();

                // Pr√ºfen, ob Rohstoff bereits existiert
                let existing = mats.find(m => m.name.toLowerCase() === name.toLowerCase());

                if (existing) {
                    existing.remaining += amount;
                    existing.lastUpdated = new Date().toISOString().slice(0, 10);
                } else {
                    mats.push({
                        id: "mat_" + Date.now(),
                        name,
                        category,
                        unit,
                        remaining: amount,
                        pricePerUnit: price || 0,
                        lastUpdated: new Date().toISOString().slice(0, 10)
                    });
                }

                materialSaveAll(mats);
                renderMaterialList();

                // Formular zur√ºcksetzen
                document.getElementById("matName").value = "";
                document.getElementById("matAmount").value = "";
                document.getElementById("matPrice").value = "";
            }




            function renderMaterialList() {

                const list = document.getElementById("materialList");
                const mats = materialLoadAll();

                // Falls leer
                if (!mats.length) {
                    list.innerHTML = "<em>Noch keine Rohstoffe angelegt.</em>";
                    return;
                }

                // ========================
                // Tabelle bauen
                // ========================
                let html = `
                        <div class="table-scroll">
                        <table>
                        <tr style="border-bottom:1px solid #ccc;">
                            <th>Name</th>
                            <th>Kategorie</th>
                            <th style="text-align:right;">Bestand</th>
                            <th style="text-align:right;">Preis/Einheit</th>
                            <th></th>
                        </tr>
                `;

                mats.forEach(m => {

                    const remainingRounded =
                        (m.remaining != null && !isNaN(m.remaining))
                            ? Number(m.remaining).toFixed(1)
                            : "-";

                    html += `
                        <tr style="border-bottom:1px solid #eee;">
                            <td>${m.name}</td>
                            <td>${m.category}</td>
                            <td style="text-align:right;">
                                ${remainingRounded} ${m.unit}
                            </td>

                            <td style="text-align:right;">
                                ${convertToBasePrice(m).toFixed(2)} ‚Ç¨ /
                                ${(m.unit.toLowerCase() === "l" || m.unit.toLowerCase() === "ml") ? "L" : "kg"}
                            </td>

                            <td>
                                <button onclick="materialEdit('${m.id}', this)" style="padding:3px 6px;">‚úè</button>
                                <button onclick="materialDelete('${m.id}')" style="padding:3px 6px;">üóë</button>
                            </td>
                        </tr>
                    `;
                });

                html += `</table>`;


                // ========================
                // Edit-Box anh√§ngen
                // (damit sie IM Container lebt)
                // ========================

                html += `
                    <div id="materialEditBox" style="
                        position:absolute;
                        display:none;
                        background:#f6f6f6;
                        padding:10px 12px;
                        border-radius:10px;
                        width:300px;
                        max-width:90vw;              /* passt sich Handybreite an */
                        box-shadow:0 6px 18px rgba(0,0,0,.25);
                        border:1px solid rgba(0,0,0,.08);
                        z-index:50;
                        font-size:0.95em;
                        line-height:1.2em;           /* wieder normal */
                    ">

                        <h3 style="margin:4px 0 8px 0;">Rohstoff bearbeiten</h3>

                        <label>Name:</label>
                        <input id="editMatName" type="text"
                            style="width:100%; margin:4px 0 8px 0;">

                        <label>Menge:</label>
                        <input id="editMatAmount" type="number" step="0.01"
                            style="width:100%; margin:4px 0 8px 0;">

                        <label>Einheit:</label>
                        <input id="editMatUnit" type="text"
                            style="width:100%; margin:4px 0 8px 0;">

                        <label>Preis pro Einheit (‚Ç¨):</label>
                        <input id="editMatPrice" type="number" step="0.01"
                            style="width:100%; margin:4px 0 10px 0;">

                        <div style="display:flex; gap:6px; justify-content:flex-end;">
                            <button onclick="materialSaveEdit()"
                                style="padding:6px 10px; background:#4caf50; color:white;">
                                Speichern
                            </button>

                            <button onclick="materialCloseEdit()"
                                style="padding:6px 10px; background:#ccc;">
                                Abbrechen
                            </button>
                        </div>

                        <input type="hidden" id="editMatId">
                    </div>
                    `;


                // in Container schreiben
                list.innerHTML = html;
            }




            function materialDelete(id) {
                if (!confirm("Diesen Rohstoff wirklich l√∂schen?")) return;

                let mats = materialLoadAll();
                mats = mats.filter(m => m.id !== id);
                materialSaveAll(mats);
                renderMaterialList();
            }


            function materialEdit(id, el) {

                const box = document.getElementById("materialEditBox");
                const list = document.getElementById("materialList");

                // Werte laden (wie bei dir schon vorhanden)
                const mats = materialLoadAll();
                const mat = mats.find(m => m.id === id);
                if (!mat) return;

                editMatId.value = mat.id;
                editMatName.value = mat.name;
                editMatAmount.value = mat.remaining;
                editMatUnit.value = mat.unit;
                editMatPrice.value = mat.pricePerUnit;

                const r = el.getBoundingClientRect();
                const c = list.getBoundingClientRect();

                let scroller = el.parentElement;
                while (scroller && scroller !== document.body &&
                    !(scroller.scrollHeight > scroller.clientHeight)) {
                    scroller = scroller.parentElement;
                }

                const scrollY =
                    scroller && scroller !== document.body
                        ? scroller.scrollTop
                        : window.scrollY;

                const containerOffset = list.offsetTop;

                const top = (r.bottom - c.top) + scrollY + containerOffset - 200;
                const left = ((list.clientWidth - box.offsetWidth) / 2) - 90;

                box.style.top = top + "px";
                box.style.left = left + "px";
                box.style.display = "block";


            }











            function materialSaveEdit() {
                const id = document.getElementById("editMatId").value;

                let mats = JSON.parse(localStorage.getItem("materials") || "[]");

                mats = mats.map(m => {
                    if (m.id !== id) return m;

                    return {
                        ...m,
                        name: document.getElementById("editMatName").value,
                        remaining: parseFloat(document.getElementById("editMatAmount").value) || 0,
                        unit: document.getElementById("editMatUnit").value,
                        pricePerUnit: parseFloat(document.getElementById("editMatPrice").value) || 0
                    };
                });

                localStorage.setItem("materials", JSON.stringify(mats));

                materialCloseEdit();
                renderMaterialList();   // Tabelle neu rendern
            }



            function materialCloseEdit() {
                const box = document.getElementById("materialEditBox");
                if (box) box.style.display = "none";
            }









            // ===============================================
            // INIT: Neue Seite: Chargen / Produktion
            // ===============================================
            function initBatchProductionPage() {
                batchFillRecipeSelect();

                // Reset der Info-Box
                const info = document.getElementById("batchInfoBox");
                if (info) info.innerHTML = "<em>Noch keine Charge gestartet.</em>";

                // Reset Materialien
                const mats = document.getElementById("batchMaterialsBox");
                if (mats) mats.innerHTML = "<em>Noch kein Rezept ausgew√§hlt.</em>";

                // Optional: Auto-Auswahl
                // document.getElementById("batchRecipeSelect").focus();
            }


            document.getElementById("expenseCategory").addEventListener("change", () => {
                const cat = document.getElementById("expenseCategory").value;
                const text = document.getElementById("expenseDesc");
                const sel = document.getElementById("expenseMaterialSelect");
                const newFields = document.getElementById("newMaterialFields");

                if (cat === "Rohstoffe") {
                    sel.style.display = "block";
                    text.style.display = "none";
                    newFields.style.display = "none";

                    // Dropdown bef√ºllen
                    const mats = materialLoadAll();
                    sel.innerHTML = "";

                    // Option: Neuer Rohstoff
                    let optNew = document.createElement("option");
                    optNew.value = "__new";
                    optNew.textContent = "‚ûï Neuer Rohstoff ‚Ä¶";
                    sel.appendChild(optNew);

                    // Existierende Rohstoffe
                    mats.forEach(m => {
                        const opt = document.createElement("option");
                        opt.value = m.name;
                        opt.textContent = `${m.name} (${m.remaining} ${m.unit})`;
                        sel.appendChild(opt);
                    });

                    // üîß Initialzustand pr√ºfen
                    if (sel.value === "__new") {
                        newFields.style.display = "block";
                    }


                    // Auswahl √ºberwachen
                    sel.addEventListener("change", () => {
                        if (sel.value === "__new") {
                            newFields.style.display = "block";
                        } else {
                            newFields.style.display = "none";
                        }
                    });

                } else {
                    // Keine Rohstoffkategorie
                    sel.style.display = "none";
                    newFields.style.display = "none";
                    text.style.display = "block";
                }
            });


            function fillBatchRecipeSelect() {
                const sel = document.getElementById("batchRecipeSelect");
                if (!sel) return;

                const recipes = recipeLoadAll();
                sel.innerHTML = '<option value="">‚Äî Mash-Rezept w√§hlen ‚Äî</option>';

                recipes
                    .filter(r => r.type === "mash")   // ‚≠ê nur Maische-Rezepte
                    .forEach(r => {
                        const opt = document.createElement("option");
                        opt.value = r.id;
                        opt.textContent = r.name + " (Mash)";
                        sel.appendChild(opt);
                    });
            }







            // =====================================================================================
            // ‚≠ê STARTE EINE NEUE MASH-CHARGE (Whisky, Korn, Rum, etc.)
            // =====================================================================================
            function startMashBatch() {

                // Bestehende Eingaben f√ºr G√§rung & Brand leeren
                if (document.getElementById("batchFermentStart")) {
                    document.getElementById("batchFermentStart").value = "";
                    document.getElementById("batchFermentEnd").value = "";
                    document.getElementById("batchFermentVolume").value = "";
                    document.getElementById("batchFermentNotes").value = "";
                    document.getElementById("batchFermentSummary").innerHTML =
                        "<em>Noch keine G√§rdaten gespeichert.</em>";
                }

                const dDate = document.getElementById("batchDistillDate");
                const dVol = document.getElementById("batchDistillVolume");
                const dStr = document.getElementById("batchDistillStrength");
                const dNotes = document.getElementById("batchDistillNotes");
                const dSummary = document.getElementById("batchDistillSummary");

                if (dDate) dDate.value = "";
                if (dVol) dVol.value = "";
                if (dStr) dStr.value = "";
                if (dNotes) dNotes.value = "";
                if (dSummary) dSummary.innerHTML = "<em>Noch keine Branddaten gespeichert.</em>";


                batchResetUI();


                // Rezept aus Auswahl holen
                const sel = document.getElementById("batchRecipeSelect");
                if (!sel || !sel.value) {
                    alert("Bitte zuerst ein Mash-Rezept ausw√§hlen.");
                    return;
                }

                const recipe = recipeLoadAll().find(r => r.id === sel.value);
                if (!recipe) {
                    alert("Rezept wurde nicht gefunden.");
                    return;
                }

                if (recipe.type !== "mash") {
                    alert("Nur Mash-Rezepte k√∂nnen eingemaischt werden.");
                    return;
                }


                // ---------------------------------------------------------------------
                // 1) Nutzer fragt: Wieviele kg Sch√ºttung diesmal einmaischen?
                // ---------------------------------------------------------------------
                let kg = Number(prompt("Wieviele kg Sch√ºttung m√∂chtest du einmaischen?"));
                if (!kg || kg <= 0) {
                    alert("Ung√ºltige Eingabe. Charge abgebrochen.");
                    return;
                }

                // -----------------------------------------------------------
                // 2) Rezept-Proportionen analysieren (Mash hat KEINE 100%-Pflicht)
                // -----------------------------------------------------------

                // Summe der eingetragenen Teile (z. B. 3 + 1 + 1 + 2 = 7)
                let totalParts = recipe.ingredients.reduce((s, i) => s + i.amount, 0);

                if (!totalParts || totalParts <= 0) {
                    alert("Fehler: Rezept enth√§lt keine g√ºltigen Zutatenwerte.");
                    return;
                }

                // Skalieren auf gew√ºnschte Sch√ºttungsmenge
                let factor = kg / totalParts;

                let scaledIngredients = recipe.ingredients.map(i => ({
                    name: i.name,
                    fraction: i.amount / totalParts,    // Verh√§ltnisanteil
                    amount: i.amount * factor           // tats√§chliche kg
                }));


                renderBatchMaterialsForCharge(scaledIngredients);




                // ---------------------------------------------------------------------
                // 3) Wasserberechnung (Strike + Sparge)
                // ---------------------------------------------------------------------
                const mashWaterRatio = recipe.mashWaterRatio || 3.0;  // L/kg
                const spargeRatio = recipe.spargeRatio || 0.6;        // Anteil von Strike Water

                const strikeWater = mashWaterRatio * kg;
                const spargeWater = strikeWater * spargeRatio;
                const totalWater = strikeWater + spargeWater;





                // ---------------------------------------------------------------------
                // SCHRITT: Rohstoff-Pr√ºfung + Dialog
                // ---------------------------------------------------------------------

                const checkRows = materialCheckBeforeConsume(scaledIngredients);

                showMaterialConfirmDialog(checkRows, answer => {

                    if (answer === "cancel") {
                        alert("Vorgang abgebrochen. Charge wurde nicht erstellt.");
                        return;
                    }

                    if (answer === "yes") {
                        materialConsumeFromBatch(recipe, scaledIngredients);
                    }

                    // Zuerst pr√ºfen, ob ein Laufzettel erzeugt werden soll/muss
                    ensureMashRunSheetExists(
                        recipe, kg, scaledIngredients, strikeWater, spargeWater, totalWater,
                        decision => {

                            if (decision === "continue") {
                                // Jetzt wirklich Charge + Produkt erzeugen
                                completeMashBatchCreation(recipe, kg, scaledIngredients, strikeWater, spargeWater, totalWater);
                            }
                            // "cancel" w√§re m√∂glich bei einer erweiterten Version
                        }
                    );

                });

            }




            function ensureMashRunSheetExists(recipe, kg, scaledIngredients, strikeWater, spargeWater, totalWater, callback) {

                // Pr√ºfen, ob es bereits einen Laufzettel f√ºr diese Rezept-ID und dieses Datum gibt
                const all = JSON.parse(localStorage.getItem("runSheets") || "[]");

                const today = new Date().toISOString().slice(0, 10);

                const exists = all.some(s =>
                    s.type === "mash" &&
                    s.recipeId === recipe.id &&
                    s.date === today
                );

                if (exists) {
                    // schon vorhanden ‚Üí ohne Nachfrage fortfahren
                    callback("continue");
                    return;
                }

                // Wenn keiner existiert ‚Üí Dialog anzeigen
                const msg =
                    "‚ö†Ô∏è F√ºr diese Maische wurde noch kein Laufzettel erzeugt.\n\n" +
                    "M√∂chtest du jetzt einen Laufzettel erstellen?";

                const choice = confirm(msg);
                if (choice) {
                    // Laufzettel erstellen
                    const sheet = createMashRunSheet(recipe, kg, scaledIngredients, strikeWater, spargeWater, totalWater);

                    alert("Laufzettel wurde erzeugt.");
                    callback("continue");
                } else {
                    // Benutzer m√∂chte trotzdem weitermachen
                    callback("continue");
                }
            }




            function createMashRunSheet(recipe, kg, ingredients, strikeWater, spargeWater, totalWater) {

                const sheet = {
                    id: "run_" + Date.now(),
                    date: new Date().toISOString().slice(0, 10),
                    type: "mash",

                    recipeId: recipe.id,
                    recipeName: recipe.name,

                    kgMash: kg,
                    strikeWater,
                    spargeWater,
                    totalWater,

                    ingredients: ingredients.map(i => ({
                        name: i.name,
                        fraction: i.fraction,
                        amount: i.amount
                    })),

                    info: {
                        note: "Mash-Laufzettel automatisch erzeugt"
                    }
                };

                let all = JSON.parse(localStorage.getItem("runSheets") || "[]");
                all.push(sheet);
                localStorage.setItem("runSheets", JSON.stringify(all));

                return sheet;
            }







            function materialCheckAvailability(ingredients) {
                let shortages = [];

                for (let item of ingredients) {
                    let stored = materialGetAmount(item.name); // liest vorhandene Menge im Lager

                    if (stored < item.amount) {
                        shortages.push(`${item.name}: ben√∂tigt ${item.amount} kg, vorhanden ${stored} kg`);
                    }
                }

                return shortages;
            }



            function materialCheckBeforeConsume(rows) {
                const mats = materialLoadAll();
                let result = [];

                rows.forEach(item => {

                    // Needed Menge sauber ermitteln
                    const needed = item.needed ?? item.amount ?? 0;
                    const name = item.name;

                    // Material anhand Name finden
                    const mat = mats.find(m => m.name.toLowerCase() === name.toLowerCase());

                    // Wenn Material NICHT existiert
                    if (!mat) {
                        result.push({
                            name: name,
                            needed: needed,
                            unit: item.unit || "",    // Aroma: g, Mash: kg
                            available: 0,
                            remaining: 0 - needed,
                            status: "missing"
                        });
                        return;
                    }

                    // Material existiert
                    const available = mat.remaining ?? 0;
                    const remaining = available - needed;

                    result.push({
                        name: name,
                        needed: needed,
                        unit: item.unit || mat.unit || "",
                        available: available,
                        remaining: remaining,
                        status: remaining >= 0 ? "ok" : "low"
                    });
                });

                return result;
            }





            function showMaterialConfirmDialog(checkRows, callback) {
                // Alte Box entfernen, falls vorhanden
                const old = document.getElementById("materialConfirmDialog");
                if (old) old.remove();

                const div = document.createElement("div");
                div.id = "materialConfirmDialog";
                div.style.position = "fixed";
                div.style.top = "20%";
                div.style.left = "50%";
                div.style.transform = "translateX(-50%)";
                div.style.padding = "20px";
                div.style.background = "white";
                div.style.border = "2px solid #444";
                div.style.borderRadius = "8px";
                div.style.zIndex = 99999;
                div.style.maxWidth = "400px";
                div.style.boxShadow = "0 0 20px rgba(0,0,0,0.4)";

                let html = `<h3>Rohstoffe aus Lager abbuchen?</h3>
                        <table style="width:100%; border-collapse:collapse; margin-bottom:10px;">
                            <tr>
                                <th align="left">Rohstoff</th>
                                <th align="right">Lager</th>
                                <th align="right">Ben√∂tigt</th>
                                <th align="right">Rest</th>
                            </tr>
                    `;

                checkRows.forEach(r => {
                    html += `
                        <tr style="border-bottom:1px solid #ccc;">
                            <td>${r.name}</td>
                            <td align="right">${r.available.toFixed(2)}</td>
                            <td align="right">${r.needed.toFixed(2)}</td>
                            <td align="right" style="color:${r.remaining < 0 ? 'red' : 'green'};">
                                ${r.remaining.toFixed(2)}
                            </td>
                        </tr>
                    `;
                });

                html += `</table>
                    <div style="display:flex; justify-content:space-between;">
                        <button id="matYes">Ja</button>
                        <button id="matNo">Nein</button>
                        <button id="matCancel">Abbrechen</button>
                    </div>
                `;

                div.innerHTML = html;
                document.body.appendChild(div);

                // Button Events
                document.getElementById("matYes").onclick = () => { div.remove(); callback("yes"); };
                document.getElementById("matNo").onclick = () => { div.remove(); callback("no"); };
                document.getElementById("matCancel").onclick = () => { div.remove(); callback("cancel"); };
            }




            function completeMashBatchCreation(recipe, kg, scaledIngredients, strikeWater, spargeWater, totalWater) {

                // Anzeige aktualisieren
                const box = document.getElementById("batchCostBox");
                if (box) {
                    box.innerHTML = `
                    <strong>Charge gestartet:</strong><br>
                    Rezept: ${recipe.name}<br>
                    Sch√ºttung: ${kg} kg<br>
                    Strike Water: ${strikeWater.toFixed(1)} L<br>
                    Sparge Water: ${spargeWater.toFixed(1)} L<br>
                    Gesamtwasser: ${totalWater.toFixed(1)} L
                `;
                }

                alert(
                    "‚úî Charge wurde erstellt!\n\n" +
                    "Rezept: " + recipe.name + "\n" +
                    "Sch√ºttung: " + kg + " kg\n" +
                    "Strike Water: " + strikeWater.toFixed(1) + " L\n" +
                    "Sparge Water: " + spargeWater.toFixed(1) + " L\n" +
                    "Gesamt: " + totalWater.toFixed(1) + " L\n\n" +
                    "Der Laufzettel wurde gespeichert."
                );

                // Batch speichern
                let batches = batchLoadAll();
                if (!Array.isArray(batches)) batches = [];

                const batch = {
                    id: "batch_" + Date.now(),
                    recipeId: recipe.id,
                    recipeName: recipe.name,
                    created: new Date().toISOString().slice(0, 10),

                    kgMash: kg,
                    strikeWater,
                    spargeWater,
                    totalWater,

                    ingredients: scaledIngredients.map(r => ({
                        name: r.name,
                        fraction: r.fraction,
                        amount: r.amount,
                        unit: "kg"
                    })),

                    fermentation: { startDate: null, endDate: null, temperature: null, attenuation: null, notes: "" },
                    distillation: { date: null, newMakeVolume: null, newMakeStrength: null, notes: "" },

                    caskHistory: [],
                    status: "mashing"
                };

                batches.push(batch);
                batchSaveAll(batches);

                window.currentBatch = batch;

                // Laufzettel speichern
                let sheets = JSON.parse(localStorage.getItem("runSheets") || "[]");
                if (!Array.isArray(sheets)) sheets = [];

                sheets.push({
                    id: "run_" + Date.now(),
                    batchId: batch.id,
                    date: new Date().toISOString().slice(0, 10),
                    recipeId: recipe.id,
                    recipeName: recipe.name,
                    kgMash: kg,
                    strikeWater,
                    spargeWater,
                    totalWater,
                    ingredients: scaledIngredients
                });

                localStorage.setItem("runSheets", JSON.stringify(sheets));
                batchUpdateCostPreview(batch);
                batchFillDropdown();


            }

















            // ===== Init =====
            window.addEventListener("DOMContentLoaded", () => {
                const typeSelect = document.getElementById("type");
                typeSelect.innerHTML = `
                                <option value="liter">Obst (Liter Maische)</option>
                                <option value="kg">Getreide/Kartoffeln (kg)</option>
                            `;
                updateFruits();
                initBarrelPage();
                updateStorageDropdown();
                updateSaleDropdown();
                showSalesList();
                // üî• NEU: Rezept-Modul initialisieren
                initRecipeModule();
                typeSelect.addEventListener("change", theoryUpdateTypeUI);

                // direkt starten
                theoryUpdateTypeUI();
            });

            function theoryUpdateTypeUI() {
                const type = document.getElementById("type").value;

                const oechsleRow = document.getElementById("oechsleRow");
                const oechsleOutput = document.getElementById("expectedAlcoholOutput");
                const comparison = document.getElementById("comparisonOutput");

                if (type === "kg") {
                    // Mehlige Stoffe ‚Üí Oechsle eingeben & Berechnung ausblenden
                    if (oechsleRow) oechsleRow.style.display = "none";
                    if (oechsleOutput) oechsleOutput.style.display = "none";
                    if (comparison) comparison.style.display = "none";
                } else {
                    // Obst ‚Üí Oechsle wieder anzeigen
                    if (oechsleRow) oechsleRow.style.display = "";
                    // Berechnung wird NUR angezeigt, wenn sp√§ter Werte eingegeben werden
                }
            }



            /* ===== üçí Lik√∂rrechner ===== */
            function liqr_calc() {
                // Eingaben holen
                let AlcL = parseFloat(document.getElementById('liqAlcL').value) || 0;
                let AlcAbv = parseFloat(document.getElementById('liqAlcAbv').value) || 0;
                let JuiceL = parseFloat(document.getElementById('liqJuiceL').value) || 0;
                let SugarKg = parseFloat(document.getElementById('liqSugarKg').value) || 0;
                let WaterL = parseFloat(document.getElementById('liqWaterL').value) || 0;

                const TgtAbv = parseFloat(document.getElementById('liqTargetAbv').value);
                const TgtSugar = parseFloat(document.getElementById('liqTargetSugar').value);
                //const kSugar = parseFloat(document.getElementById('liqSugarVolPerKg').value) || 0.62;
                // Volumenfaktor Zucker ‚Äì je nach Invertzucker-Schalter
                let kSugar = parseFloat(document.getElementById('liqSugarVolPerKg').value) || 0.62;
                const invertMode = document.getElementById('liqInvertMode')?.checked;
                if (invertMode) kSugar = 0;   // Excel-Modell: Invertzucker verdr√§ngt Saft, kein Zusatzvolumen

                const mode = document.getElementById('liqSolveMode').value;

                // Hilfsgr√∂√üen
                let AA = AlcL * (AlcAbv / 100); // Reinalkohol L

                // Volumenbeitrag Zucker:
                const Vsugar = SugarKg * kSugar;

                // Je nach Modus berechnen
                if (mode === 'auto') {
                    // Falls beide Ziele gesetzt: simultan l√∂sen
                    if (!isNaN(TgtAbv) && !isNaN(TgtSugar)) {
                        const Vtot = (TgtAbv > 0) ? (AA / (TgtAbv / 100)) : (AlcL + JuiceL + WaterL + Vsugar);
                        const Ms = (TgtSugar * Vtot) / 1000; // kg
                        const Vs = Ms * kSugar;
                        const W = Vtot - AlcL - JuiceL - Vs;
                        SugarKg = Ms; WaterL = W >= 0 ? W : 0;
                    } else if (!isNaN(TgtAbv)) {
                        // Nur %Vol Ziel ‚Üí l√∂se Wasser
                        const Vtot = (TgtAbv > 0) ? (AA / (TgtAbv / 100)) : (AlcL + JuiceL + WaterL + Vsugar);
                        const W = Vtot - AlcL - JuiceL - Vsugar;
                        WaterL = W >= 0 ? W : 0;
                    } else if (!isNaN(TgtSugar)) {
                        // Nur Zuckerziel ‚Üí l√∂se Zucker (bei aktuellem Wasser)
                        // Ms = (G*const)/(1000 - G*k)
                        const constantV = AlcL + JuiceL + WaterL;
                        const denom = (1000 - TgtSugar * kSugar);
                        if (denom > 0) {
                            const Ms = (TgtSugar * constantV) / denom;
                            SugarKg = Ms;
                        }
                    }
                }
                else if (mode === 'water') {
                    if (!isNaN(TgtAbv) && TgtAbv > 0) {
                        const Vtot = AA / (TgtAbv / 100);
                        const W = Vtot - AlcL - JuiceL - (SugarKg * kSugar);
                        WaterL = W >= 0 ? W : 0;
                    }
                }
                else if (mode === 'sugar') {
                    if (!isNaN(TgtSugar)) {
                        const constV = AlcL + JuiceL + WaterL;
                        const denom = (1000 - TgtSugar * kSugar);
                        if (denom > 0) {
                            const Ms = (TgtSugar * constV) / denom;
                            SugarKg = Ms;
                        }
                    }
                }
                else if (mode === 'juice') {
                    if (!isNaN(TgtAbv) && TgtAbv > 0) {
                        const Vtot = AA / (TgtAbv / 100);
                        const J = Vtot - AlcL - WaterL - (SugarKg * kSugar);
                        JuiceL = J >= 0 ? J : 0;
                    }
                }
                else if (mode === 'alcohol') {

                    if (!isNaN(TgtAbv) && TgtAbv > 0) {

                        const Vtot = JuiceL + WaterL + (SugarKg * kSugar);

                        const denom = (AlcAbv - TgtAbv);

                        if (denom > 0) {
                            AlcL = (TgtAbv * Vtot) / denom;
                        }
                    }
                }

                AA = AlcL * (AlcAbv / 100);

                // Endwerte/Ergebnisse berechnen
                const Vs = SugarKg * kSugar;
                const Vtot = AlcL + JuiceL + WaterL + Vs;
                const Abv = Vtot > 0 ? (AA / Vtot * 100) : 0;
                const SugG = Vtot > 0 ? (SugarKg * 1000 / Vtot) : 0;
                const btnWrap = document.getElementById("liqSaveWrap");
                if (btnWrap) btnWrap.style.display = (Vtot > 0 ? "block" : "none");


                const warn = [];
                if (Vtot <= 0) warn.push("Gesamtvolumen ‚â§ 0 L ‚Äì Eingaben pr√ºfen.");
                if (Abv < 0 || Abv > 100) warn.push("Ergebnis-%Vol au√üerhalb 0‚Äì100 %. Eingaben pr√ºfen.");
                if (WaterL < 0) warn.push("Negatives berechnetes Wasser ‚Äì Ziele ggf. nicht erreichbar.");

                document.getElementById('liqAlcL').value = isFinite(AlcL) ? AlcL.toFixed(2) : document.getElementById('liqAlcL').value;
                document.getElementById('liqJuiceL').value = isFinite(JuiceL) ? JuiceL.toFixed(2) : document.getElementById('liqJuiceL').value;
                document.getElementById('liqWaterL').value = isFinite(WaterL) ? WaterL.toFixed(2) : document.getElementById('liqWaterL').value;
                document.getElementById('liqSugarKg').value = isFinite(SugarKg) ? SugarKg.toFixed(3) : document.getElementById('liqSugarKg').value;

                document.getElementById('liqResult').innerHTML =
                    `Reinalkohol: <strong>${AA.toFixed(2)} L</strong><br>
                    Zucker-Volumenbeitrag: <strong>${Vs.toFixed(2)} L</strong> (Faktor ${kSugar.toFixed(2)} L/kg)<br>
                    Gesamtvolumen: <strong>${Vtot.toFixed(2)} L</strong><br>
                    Ergebnis-Alkoholst√§rke: <strong>${Abv.toFixed(2)} % Vol</strong>${!isNaN(TgtAbv) ? ` ¬∑ Ziel: ${TgtAbv}%` : ''}<br>
                    Zuckergehalt: <strong>${SugG.toFixed(0)} g/L</strong>${!isNaN(TgtSugar) ? ` ¬∑ Ziel: ${TgtSugar} g/L` : ''}
                    ${warn.length ? `<div class="tiny muted"><br>Hinweis: ${warn.join(" ")}</div>` : ''}`;


                // --- Materialkosten / Mindestpreis ---

                const costAlc = parseFloat(document.getElementById('liqCostAlcohol').value) || 0;
                const costJuice = parseFloat(document.getElementById('liqCostJuice').value) || 0;
                const costSugar = parseFloat(document.getElementById('liqCostSugar').value) || 0;

                // Kostenanteile
                const matAlc = AlcL * costAlc;
                const matJuice = JuiceL * costJuice;
                const matSugar = SugarKg * costSugar;

                // Gesamte Materialkosten
                const matTotal = matAlc + matJuice + matSugar;

                // Mindestpreis pro Liter
                let minPerL = null;
                if (Vtot > 0) minPerL = matTotal / Vtot;

                // Ausgabe Mindestpreis
                if (!isNaN(minPerL)) {
                    document.getElementById('liqMinPerL').textContent =
                        minPerL.toFixed(2) + " ‚Ç¨ / Liter";
                } else {
                    document.getElementById('liqMinPerL').textContent = "‚Äì";
                }



                // Verkaufspreise automatisch vorbelegen (nur wenn noch leer)
                function setIfEmpty(id, val) {
                    const el = document.getElementById(id);
                    if (!el) return;

                    const num = parseFloat(el.value);

                    // Wenn leer, ung√ºltig oder 0 ‚Üí vorbelegen
                    if (!isFinite(num) || num === 0) {
                        el.value = val.toFixed(2);
                    }
                }


                if (!isNaN(minPerL)) {
                    setIfEmpty('liqPrice05', minPerL * 0.5);
                    setIfEmpty('liqPrice07', minPerL * 0.7);
                    setIfEmpty('liqPrice10', minPerL * 1.0);
                }


                // Flaschen-Kurz√ºberblick
                const n05 = Vtot > 0 ? Math.floor(Vtot / 0.5) : 0;
                const n07 = Vtot > 0 ? Math.floor(Vtot / 0.7) : 0;
                const n10 = Vtot > 0 ? Math.floor(Vtot / 1.0) : 0;
                const rem05 = (Vtot - n05 * 0.5).toFixed(2);
                const rem07 = (Vtot - n07 * 0.7).toFixed(2);
                const rem10 = (Vtot - n10 * 1.0).toFixed(2);

                if (document.getElementById('liqMini')) {
                    document.getElementById('liqMini').innerHTML = `
                    <strong>Flaschen (maximale F√ºllung, ohne Verluste):</strong><br>
                    0,5 L: <strong>${n05}</strong> (Rest ${rem05} L) ¬∑ 
                    0,7 L: <strong>${n07}</strong> (Rest ${rem07} L) ¬∑ 
                    1,0 L: <strong>${n10}</strong> (Rest ${rem10} L)
                `;
                }

                // Mini-Zusammenfassung
                const SugPer100ml = SugG / 10;

                const sum = document.getElementById('liqSummary');
                if (sum) {

                    // üîπ Text wie bisher
                    sum.textContent =
                        `Ergebnis: ${Vtot.toFixed(2)} L Gesamt ¬∑ ${Abv.toFixed(2)} % Vol ¬∑ ${SugG.toFixed(0)} g/L ¬∑ ${SugPer100ml.toFixed(1)} g/100 ml`;

                    // üîπ WICHTIG: Werte f√ºr sp√§tere Verwendung speichern
                    sum.dataset.totalVolume = Vtot.toFixed(2);
                    sum.dataset.abv = Abv.toFixed(2);
                }


                // ---- Erweiterung: Detaillierte Gesamtauswertung ----

                let summaryText = `
                    <strong>üìã Zusammenfassung:</strong><br>
                    Alkohol: <strong>${AlcL.toFixed(2)} L</strong> @ <strong>${AlcAbv.toFixed(1)} % Vol</strong> 
                    ‚Üí Reinalkohol: <strong>${AA.toFixed(2)} L AA</strong><br>
                    Saft: <strong>${JuiceL.toFixed(2)} L</strong> ¬∑ 
                    Zucker: <strong>${SugarKg.toFixed(2)} kg</strong> ¬∑ 
                    Wasser: <strong>${WaterL.toFixed(2)} L</strong><br>
                    <strong>‚û°Ô∏è Gesamtvolumen:</strong> ${Vtot.toFixed(2)} L ¬∑ 
                    <strong>${Abv.toFixed(2)} % Vol</strong> ¬∑ 
                    ${SugG.toFixed(0)} g/L Zucker
                    `;

                // Container pr√ºfen oder erzeugen
                let detDiv = document.getElementById('liqDetails');
                if (!detDiv) {
                    detDiv = document.createElement('div');
                    detDiv.id = 'liqDetails';
                    detDiv.className = 'barrel';
                    const target = document.getElementById('liqSummary');
                    target.insertAdjacentElement('afterend', detDiv);
                }
                detDiv.innerHTML = summaryText;


                // Mindestpreise je Flaschengr√∂√üe anzeigen (links)
                if (!isNaN(minPerL)) {
                    document.getElementById('liqMin05').value = (minPerL * 0.5).toFixed(2);
                    document.getElementById('liqMin07').value = (minPerL * 0.7).toFixed(2);
                    document.getElementById('liqMin10').value = (minPerL * 1.0).toFixed(2);
                }


                function updateProfitRow(minId, priceId, outId) {
                    const min = parseFloat(document.getElementById(minId).value);
                    const price = parseFloat(document.getElementById(priceId).value);
                    const out = document.getElementById(outId);

                    if (!isFinite(min) || !isFinite(price)) {
                        out.textContent = "";
                        return;
                    }

                    const profit = price - min;

                    out.textContent =
                        (profit >= 0 ? "Gewinn: " : "Verlust: ") +
                        profit.toFixed(2) + " ‚Ç¨";

                    out.style.color = profit >= 0 ? "green" : "red";
                }


                ['liqPrice05', 'liqPrice07', 'liqPrice10'].forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;

                    if (!el._liqHooked) {
                        el.addEventListener("input", () => {
                            updateProfitRow('liqMin05', 'liqPrice05', 'liqProfit05');
                            updateProfitRow('liqMin07', 'liqPrice07', 'liqProfit07');
                            updateProfitRow('liqMin10', 'liqPrice10', 'liqProfit10');
                        });
                        el._liqHooked = true;
                    }
                });
            }



            function liq_saveProduct() {

                // Werte holen
                const AlcL = parseFloat(document.getElementById('liqAlcL').value) || 0;
                const AlcAbv = parseFloat(document.getElementById('liqAlcAbv').value) || 0;
                const JuiceL = parseFloat(document.getElementById('liqJuiceL').value) || 0;
                const SugarKg = parseFloat(document.getElementById('liqSugarKg').value) || 0;
                const WaterL = parseFloat(document.getElementById('liqWaterL').value) || 0;

                const strength = parseFloat(document.getElementById('liqTargetAbv').value) || 0;

                // Ergebniswerte
                const Vtot = AlcL + JuiceL + WaterL; // Zucker-Volumen z√§hlst du separat ‚Äì hier wie im Rechner
                const minPerL = parseFloat(
                    (document.getElementById('liqMinPerL').textContent || "0")
                        .replace(",", ".")
                ) || 0;

                // Materialkosten (gesamt)
                const costAlc = parseFloat(document.getElementById('liqCostAlcohol').value) || 0;
                const costJuice = parseFloat(document.getElementById('liqCostJuice').value) || 0;
                const costSugar = parseFloat(document.getElementById('liqCostSugar').value) || 0;

                const totalCosts =
                    AlcL * costAlc +
                    JuiceL * costJuice +
                    SugarKg * costSugar;

                // Mindestpreise je Flasche
                const min05 = minPerL * 0.5;
                const min07 = minPerL * 0.7;
                const min10 = minPerL * 1.0;

                // Nutzerpreise
                const user05 = parseFloat(document.getElementById('liqPrice05').value) || 0;
                const user07 = parseFloat(document.getElementById('liqPrice07').value) || 0;
                const user10 = parseFloat(document.getElementById('liqPrice10').value) || 0;

                // Namen vorschlagen
                const defaultName = `Lik√∂r ‚Äì ${strength}% (${Vtot.toFixed(2)} L)`;
                const name = prompt("Wie soll der Lik√∂r hei√üen?", defaultName);
                if (!name) return;

                // Produktobjekt
                const product = {
                    id: "product_" + Date.now(),
                    origin: "product",
                    type: "liqueur",
                    created: new Date().toISOString(),

                    name,

                    volumeL: Vtot,
                    remainingVolume: Vtot,
                    strength,

                    materials: {
                        alcoholL: AlcL,
                        alcoholAbv: AlcAbv,
                        juiceL: JuiceL,
                        sugarKg: SugarKg,
                        waterL: WaterL
                    },

                    totalCosts,
                    costPerLiter: (Vtot > 0 ? totalCosts / Vtot : 0),

                    calcPrice: {
                        0.5: { min: min05, profit: user05 - min05 },
                        0.7: { min: min07, profit: user07 - min07 },
                        1.0: { min: min10, profit: user10 - min10 }
                    },

                    userPrice: {
                        0.5: user05,
                        0.7: user07,
                        1.0: user10
                    }
                };

                // speichern
                let products = JSON.parse(localStorage.getItem("products") || "[]");
                products.push(product);
                localStorage.setItem("products", JSON.stringify(products));

                alert("Lik√∂r als Produkt gespeichert üëç");
            }






            async function liq_saveAndStore() {

                // --- 1Ô∏è‚É£ Ergebniswerte holen ---
                const Vtot = parseFloat(document.getElementById("liqSummary")?.dataset?.totalVolume || 0);
                const Abv = parseFloat(document.getElementById("liqSummary")?.dataset?.abv || 0);

                if (!Vtot || !Abv) {
                    alert("Bitte zuerst den Lik√∂r berechnen.");
                    return;
                }

                // --- 2Ô∏è‚É£ Materialmengen ---
                const AlcL = parseFloat(document.getElementById('liqAlcL').value) || 0;
                const AlcAbv = parseFloat(document.getElementById('liqAlcAbv').value) || 0;
                const JuiceL = parseFloat(document.getElementById('liqJuiceL').value) || 0;
                const SugarKg = parseFloat(document.getElementById('liqSugarKg').value) || 0;
                const WaterL = parseFloat(document.getElementById('liqWaterL').value) || 0;

                // --- 3Ô∏è‚É£ Materialkosten (wie in der Seite eingegeben) ---
                const costAlc = parseFloat(document.getElementById('liqCostAlcohol').value) || 0;
                const costJuice = parseFloat(document.getElementById('liqCostJuice').value) || 0;
                const costSugar = parseFloat(document.getElementById('liqCostSugar').value) || 0;

                const matAlc = AlcL * costAlc;
                const matJuice = JuiceL * costJuice;
                const matSugar = SugarKg * costSugar;

                const totalCosts = matAlc + matJuice + matSugar;

                const costPerLiter = Vtot > 0 ? totalCosts / Vtot : 0;

                // --- 4Ô∏è‚É£ Verkaufspreise vom UI lesen ---
                const u05 = parseFloat(document.getElementById("liqPrice05")?.value) || 0;
                const u07 = parseFloat(document.getElementById("liqPrice07")?.value) || 0;
                const u10 = parseFloat(document.getElementById("liqPrice10")?.value) || 0;

                // Mindestpreise
                const m05 = costPerLiter * 0.5;
                const m07 = costPerLiter * 0.7;
                const m10 = costPerLiter * 1.0;

                // --- 5Ô∏è‚É£ Produktname ---
                const name = prompt("Wie soll der Lik√∂r hei√üen?", "Zwetschgen-Lik√∂r");
                if (!name) return;

                const fullName = name.trim();



                // --- 6Ô∏è‚É£ Produktobjekt ---
                const product = {
                    id: "product_" + Date.now(),
                    origin: "product",
                    type: "liqueur",
                    created: new Date().toISOString(),

                    name: fullName,
                    strength: Abv,
                    volumeL: Vtot,

                    remainingVolume: 0,   // üëâ alles wird eingelagert

                    materials: {
                        alcoholL: AlcL,
                        alcoholAbv: AlcAbv,
                        juiceL: JuiceL,
                        sugarKg: SugarKg,
                        waterL: WaterL
                    },

                    totalCosts,
                    costPerLiter,

                    calcPrice: {
                        0.5: { min: m05, profit: u05 - m05 },
                        0.7: { min: m07, profit: u07 - m07 },
                        1.0: { min: m10, profit: u10 - m10 }
                    },

                    userPrice: {
                        0.5: u05,
                        0.7: u07,
                        1.0: u10
                    }
                };


                // --- 7Ô∏è‚É£ speichern ---
                const products = JSON.parse(localStorage.getItem("products") || "[]");
                products.push(product);
                localStorage.setItem("products", JSON.stringify(products));


                // --- 8Ô∏è‚É£ jetzt wie bisher: Lagerdialog ---
                liq_openStoreModal(product);
            }





            function liq_openStoreModal(product) {

                const overlay = document.getElementById("liqStoreOverlay");
                const modal = document.getElementById("liqStoreModal");
                const sel = document.getElementById("liqStoreSelect");

                if (!overlay || !modal || !sel) return;

                // Dropdown leeren
                sel.innerHTML = "";

                // Lagerbeh√§lter laden
                const keys = Object.keys(localStorage)
                    .filter(k => k.startsWith("storage_"));

                keys.forEach(k => {
                    const st = JSON.parse(localStorage.getItem(k));
                    if (!st) return;

                    // Zeile bauen
                    const opt = document.createElement("option");
                    opt.value = st.id;
                    opt.textContent =
                        `${st.name} (${st.capacity || 0} L)`;

                    sel.appendChild(opt);
                });

                // Volumen & % anzeigen
                document.getElementById("liqStoreVolume").textContent =
                    product.volumeL.toFixed(2) + " L";

                document.getElementById("liqStoreAbv").textContent =
                    product.strength.toFixed(1);

                // Modal √∂ffnen
                overlay.style.display = "block";
                modal.style.display = "block";

                // Produkt tempor√§r merken
                window._liqPendingProduct = product;
            }


            function liq_closeStoreModal() {
                document.getElementById("liqStoreOverlay").style.display = "none";
                document.getElementById("liqStoreModal").style.display = "none";
                window._liqPendingProduct = null;
            }


            function liq_confirmStore() {

                const prod = window._liqPendingProduct;
                if (!prod) return;

                const storageId = document.getElementById("liqStoreSelect").value;
                if (!storageId) {
                    alert("Bitte Lagerbeh√§lter w√§hlen!");
                    return;
                }

                // Lager holen
                const storage =
                    JSON.parse(localStorage.getItem("storage_" + storageId) || "{}");

                if (!storage.contents) storage.contents = [];

                storage.contents.push({
                    id: "item_" + Date.now(),
                    productId: prod.id,
                    source: prod.name,
                    fruit: "Unbekannt",
                    strength: prod.strength,
                    volume: prod.volumeL,
                    fruitData: { "Unbekannt": prod.volumeL },
                    dateAdded: new Date().toISOString().slice(0, 10)
                });

                // speichern
                localStorage.setItem("storage_" + storageId, JSON.stringify(storage));

                alert("Lik√∂r erfolgreich eingelagert üëç");

                liq_closeStoreModal();
            }




















            /* ===== Initialisierung ===== */
            window.addEventListener("DOMContentLoaded", () => {
                const typeSelect = document.getElementById("type");
                typeSelect.innerHTML = `
                        <option value="liter">Obst (Liter Maische)</option>
                        <option value="kg">Getreide/Kartoffeln (kg)</option>
                    `;
                updateFruits();
                initBarrelPage();
                updateBarrelDropdown();
            });

            let liqr_timer = null;
            function liqr_inputChanged() {
                clearTimeout(liqr_timer);
                liqr_timer = setTimeout(liqr_calc, 400); // 0,4 s nach letzter Eingabe berechnen
            }










            // Berechnung der Temperaturkorrektur
            /* ===========================================================
                OIML-basierte Temperaturkorrektur
                (nutzt eingebettete oimlCSV-Tabelle am Skriptende)
                =========================================================== */



            function calculateCorrection() {

                const alc = parseFloat(document.getElementById("corrMeasuredAlc").value);
                const temp = parseFloat(document.getElementById("corrMeasuredTemp").value);
                const vol = parseFloat(document.getElementById("corrMeasuredVol").value);

                const out = document.getElementById("correctionOutput");

                if (isNaN(alc) || isNaN(temp)) {
                    out.innerHTML = "Bitte Alkoholwert und Temperatur eingeben.";
                    return;
                }

                // üá™üá∫ OIML-basierte Temperaturkorrektur
                // table[] enth√§lt:
                // t = gemessene Temperatur
                // v = gemessener %vol-Wert
                // d = korrigierter %vol bei 20¬∞C
                let best = null;
                let bestDiff = Infinity;

                for (const row of table) {
                    const diff =
                        Math.abs(row.t - temp) * 10 +   // Temperatur ist gewichtiger
                        Math.abs(row.v - alc);

                    if (diff < bestDiff) {
                        bestDiff = diff;
                        best = row;
                    }
                }

                if (!best) {
                    out.innerHTML = "Kein passender Tabellenwert gefunden.";
                    return;
                }

                const alc20 = best.d;

                // üìè Volumenkorrektur auf 20¬∞C (ann√§hernd OIML)
                let vol20 = null;
                if (!isNaN(vol))
                    vol20 = vol * (1 + 0.00096 * (20 - temp));

                // Ausgabe
                let html = `
                    Temperaturkorrigierter Alkoholgehalt bei 20&nbsp;¬∞C:
                    <strong>${alc20.toFixed(2)} % Vol</strong>
                `;

                if (vol20 !== null)
                    html += `<br>Korrigiertes Volumen bei 20&nbsp;¬∞C:
                        <strong>${vol20.toFixed(2)} L</strong>`;

                html += `
                    <p style="font-size:0.9em;color:#555;margin-top:8px;">
                        üîé Grundlage: OIML-Empfehlung R&nbsp;22
                        (Alkoholmeter-Eichung auf 20&nbsp;¬∞C)
                    </p>
                `;

                out.innerHTML = html;
            }




            function autoCorrectMeasuredValues() {
                const alc = parseFloat(document.getElementById("measuredStrength").value);
                const temp = parseFloat(document.getElementById("measuredTemp").value);
                const vol = parseFloat(document.getElementById("measuredVolume").value);

                // Nur rechnen, wenn alle drei Werte eingegeben sind
                if (isNaN(alc) || isNaN(temp) || isNaN(vol)) {
                    return; // Nichts tun
                }

                // ===== Schritt 1: passenden Tabellenwert suchen =====
                let best = null;
                let bestDiff = Infinity;

                for (const row of table) {
                    const diff = Math.abs(row.t - temp) * 10 + Math.abs(row.v - alc);
                    if (diff < bestDiff) {
                        bestDiff = diff;
                        best = row;
                    }
                }

                if (!best) return;

                // korrigierte St√§rke
                const alc20 = best.d;

                // korrigiertes Volumen
                const vol20 = vol * (1 - 0.00096 * (temp - 20));

                // ===== Schritt 2: Werte automatisch √ºbernehmen =====
                const corrStrength = document.getElementById("barrelActualStrength");
                const corrVolume = document.getElementById("barrelActualAlcohol");

                if (corrStrength) corrStrength.value = alc20.toFixed(2);
                if (corrVolume) corrVolume.value = vol20.toFixed(2);
            }



            function applyMeasuredCorrectionForBarrel() {
                const alc = parseFloat(document.getElementById("measuredStrength").value);
                const temp = parseFloat(document.getElementById("measuredTemp").value);
                const vol = parseFloat(document.getElementById("measuredVolume").value);

                if (isNaN(alc) || isNaN(temp) || isNaN(vol)) {
                    alert("Bitte gemessene Menge, Alkoholst√§rke und Temperatur eingeben!");
                    return;
                }

                // ===== Schritt 1: Beste passenden Tabellenwert suchen =====

                let best = null;
                let bestDiff = Infinity;

                for (const row of table) {
                    const diff = Math.abs(row.t - temp) * 10 + Math.abs(row.v - alc);
                    if (diff < bestDiff) {
                        bestDiff = diff;
                        best = row;
                    }
                }

                if (!best) {
                    alert("Kein passender Wert in der Tabelle gefunden!");
                    return;
                }

                // alkoholkorregierte %vol
                const alc20 = best.d;

                // korrigiertes Volumen
                const vol20 = vol * (1 - 0.00096 * (temp - 20));

                // ===== Schritt 2: Ergebnis in die vorhandenen Berechnungsfelder einsetzen =====
                document.getElementById("barrelActualStrength").value = alc20.toFixed(2);
                document.getElementById("barrelActualAlcohol").value = vol20.toFixed(2);

                alert("Die gemessenen Werte wurden korrigiert und in die Fasskalkulation √ºbernommen.");
            }



            function calcAlcoholCorrection(measStrength, measTemp, measVolume) {

                if (isNaN(measStrength) || isNaN(measTemp) || isNaN(measVolume))
                    return null;

                let best = null;
                let bestDiff = Infinity;

                for (const row of table) {
                    const diff = Math.abs(row.t - measTemp) * 10 + Math.abs(row.v - measStrength);
                    if (diff < bestDiff) {
                        bestDiff = diff;
                        best = row;
                    }
                }

                if (!best) return null;

                const correctedStrength = best.d;
                const correctedVolume = measVolume * (1 - 0.00096 * (measTemp - 20));

                return {
                    volume: correctedVolume,
                    strength: correctedStrength
                };
            }




            function distillUpdateCorrection(prefix) {
                const mv = parseFloat(document.getElementById(prefix + "MeasVolume").value);
                const ms = parseFloat(document.getElementById(prefix + "MeasStrength").value);
                const mt = parseFloat(document.getElementById(prefix + "MeasTemp").value);

                const result = calcAlcoholCorrection(ms, mt, mv);
                if (!result) return;

                document.getElementById(prefix + "CorrVolume").value = result.volume.toFixed(2);
                document.getElementById(prefix + "CorrStrength").value = result.strength.toFixed(2);
            }






            function getDensity(vol, temp) {
                const rows = oimlCSV.trim().split("\n").slice(1);
                let best = null;
                let diff = Infinity;

                for (const row of rows) {
                    const [t, v, d] = row.split(",").map(parseFloat);
                    const delta = Math.abs(v - vol) + Math.abs(t - temp);
                    if (delta < diff) {
                        diff = delta;
                        best = d;
                    }
                }
                return best;
            }




            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // üîπ Dichte aus Tabelle (bilinear)
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function interpolateDensity(vol, temp) {
                const tt = Math.min(Math.max(temp, 0), 40);
                const vv = Math.min(Math.max(vol, 20), 93);

                const t0 = Math.floor(tt);
                const t1 = Math.min(40, Math.ceil(tt));
                const v0 = Math.floor(vv);
                const v1 = Math.min(93, Math.ceil(vv));

                // Werte aus Tabelle holen
                const q11 = rho(t0, v0);
                const q21 = rho(t1, v0);
                const q12 = rho(t0, v1);
                const q22 = rho(t1, v1);

                if ([q11, q21, q12, q22].some(isNaN)) return NaN;

                // Bilineare Interpolation (OIML-konform)
                const r1 = q11 + (q21 - q11) * (tt - t0) / (t1 - t0 || 1);
                const r2 = q12 + (q22 - q12) * (tt - t0) / (t1 - t0 || 1);
                return r1 + (r2 - r1) * (vv - v0) / (v1 - v0 || 1);
            }


            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // üîπ Dichtewert in Tabelle finden
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function rho(t, v) {
                const tol = 1e-9;
                const p = table.find(x =>
                    Math.abs(x.t - t) < tol && Math.abs(x.v - v) < tol
                );
                return p ? p.d : NaN;
            }










            // --- Tabellen mit Messwerten ---
            const tableBlau = [20, 25, 30.8, 35.5, 41, 46, 52, 57, 63, 69, 76.5];
            const tableWeiss = [21.8, 24.7, 31, 36, 41.3, 46.5, 53, 57.5, 63.8, 70, 77.7];
            const liters = [30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130];

            // --- Sichtbarkeit umschalten ---
            function showCalculator() {
                const div = document.getElementById("barrelCalc");
                div.style.display = div.style.display === "none" ? "block" : "none";
            }

            // Interpolation
            function calcInterpolate(h, table) {
                for (let i = 0; i < table.length - 1; i++) {
                    if (h >= table[i] && h <= table[i + 1]) {
                        const r = (h - table[i]) / (table[i + 1] - table[i]);
                        return liters[i] + r * (liters[i + 1] - liters[i]);
                    }
                }
                return null;
            }

            // Volumenberechnung
            function calcBarrelVolume() {
                const type = document.getElementById("calcBarrelType").value;
                const height = parseFloat(document.getElementById("calcBarrelHeight").value);
                const output = document.getElementById("calcBarrelOutput");
                if (isNaN(height)) { output.innerHTML = ""; return; }
                const table = type === "blau" ? tableBlau : tableWeiss;
                const vol = calcInterpolate(height, table);
                output.innerHTML = vol
                    ? `‚âà <strong>${vol.toFixed(1)} Liter Maische</strong>`
                    : "‚ùå Wert au√üerhalb des Messbereichs.";
            }


            // === Lagerverwaltung ===

            function updateStorageDropdown() {
                const select = document.getElementById("storageSelect");
                select.innerHTML = '<option value="">‚Äî Beh√§lter w√§hlen ‚Äî</option>';

                const keys = Object.keys(localStorage)
                    .filter(k => k.startsWith("storage_"))
                    .sort();

                if (keys.length === 0) return;

                keys.forEach(k => {
                    const s = JSON.parse(localStorage.getItem(k));
                    if (!s) return;
                    const mix = calcMixture(s);

                    const vol = mix.volume || 0;
                    const abv = mix.strength || 0;

                    const niceVolume =
                        vol <= 0.05 ? "leer" : `${vol.toFixed(1)} L @ ${abv.toFixed(1)} %`;


                    const opt = document.createElement("option");
                    opt.value = s.id;


                    // üü¶ Sch√∂nes Format
                    opt.textContent = `${s.name} (Eingef√ºllt: ${mix.volume.toFixed(1)} L / ${s.capacity || "?"} L)`;


                    // Grau anzeigen, wenn Beh√§lter leer
                    if (vol < 0.05) {
                        opt.style.color = "#888";
                    }
                    select.appendChild(opt);
                });
            }



            // üì¶ Dropdown mit archivierten Destillaten bef√ºllen
            // üîπ Dropdown mit archivierten Destillaten f√ºllen (nur mit Restmenge > 0 L)
            function updateArchiveDropdown() {
                const sel = document.getElementById("archiveSelect");
                if (!sel) return;

                sel.innerHTML = "";

                // Platzhalter
                const ph = document.createElement("option");
                ph.value = "";
                ph.textContent = "‚Äî Destillat w√§hlen ‚Äî";
                sel.appendChild(ph);

                // =============================
                // üì¶ ARCHIV (ehemalige F√§sser)
                // =============================
                const archives = Object.keys(localStorage)
                    .filter(k => k.startsWith("archive_"));

                if (archives.length > 0) {
                    const grpA = document.createElement("optgroup");
                    grpA.label = "üì¶ Archiv";

                    archives.forEach(key => {
                        const data = JSON.parse(localStorage.getItem(key) || "{}");

                        let remaining = null;

                        // zuerst neue Struktur
                        if (!isNaN(parseFloat(data.remainingVolume))) {
                            remaining = parseFloat(data.remainingVolume);
                        }

                        // alte Archive ohne remainingVolume
                        if (remaining === null) {
                            if (!isNaN(parseFloat(data.actualAlcohol))) {
                                remaining = parseFloat(data.actualAlcohol);
                            }
                            else if (!isNaN(parseFloat(data.volume))) {
                                remaining = parseFloat(data.volume);
                            }
                        }

                        // Keine Menge => nicht anzeigen
                        if (!remaining || remaining <= 0) return;

                        const name = key.replace("archive_", "");

                        const opt = document.createElement("option");
                        opt.value = key;
                        opt.textContent =
                            `${name} (${remaining.toFixed(2)} L @ ${(data.actualStrength || data.strength || 0)} %vol)`;

                        grpA.appendChild(opt);
                    });

                    sel.appendChild(grpA);
                }

                // =============================
                // üü¶ PRODUKTE
                // =============================
                const productsRaw = localStorage.getItem("products");
                if (productsRaw) {
                    const list = JSON.parse(productsRaw);
                    const grpP = document.createElement("optgroup");
                    grpP.label = "üü¶ Produkte";

                    list.forEach(p => {
                        const remaining = parseFloat(p.remainingVolume);

                        // Produkte nur anzeigen wenn noch Rest > 0
                        if (isNaN(remaining) || remaining <= 0) return;

                        const opt = document.createElement("option");
                        opt.value = p.id;
                        opt.textContent =
                            `${p.name}`;

                        grpP.appendChild(opt);
                    });

                    if (grpP.children.length > 0) sel.appendChild(grpP);
                }
            }





            // =======================================================
            //   Lagerliste neu laden  (f√ºr pageStorage)
            // =======================================================
            function loadStorage() {

                const select = document.getElementById("storageSelect");
                if (!select) return;

                // Select leeren
                select.innerHTML = `<option value="">‚Äî Beh√§lter w√§hlen ‚Äî</option>`;

                // Alle Storage-Beh√§lter suchen
                const keys = Object.keys(localStorage).filter(k => k.startsWith("storage_"));

                keys.forEach(k => {
                    const s = JSON.parse(localStorage.getItem(k) || "null");
                    if (!s) return;

                    const opt = document.createElement("option");
                    opt.value = s.id || k.replace("storage_", "");
                    opt.textContent = `${s.name || "(ohne Name)"} ‚Äî ${s.capacity || 0} L`;

                    select.appendChild(opt);
                });

                // Falls gerade ein Beh√§lter ausgew√§hlt ist ‚Üí Details neu laden
                if (select.value) {
                    loadStorageDetails();
                }
            }




            function loadStorageDetails() {
                const id = document.getElementById("storageSelect").value;
                if (!id) return;

                const s = JSON.parse(localStorage.getItem("storage_" + id));
                if (!s) return;

                document.getElementById("storageName").value = s.name || "";
                document.getElementById("storageCapacity").value = s.capacity || "";
                document.getElementById("storageLocation").value = s.location || "";

                // Inhalte anzeigen
                showStorageContents(s);
                updateTransferTargetList(s.id);
                document.getElementById("transferSource").textContent = s.name;
            }


            function updateTransferTargetList(currentId) {
                const sel = document.getElementById("transferTarget");
                sel.innerHTML = '<option value="">‚Äî Zielbeh√§lter w√§hlen ‚Äî</option>';

                const keys = Object.keys(localStorage)
                    .filter(k => k.startsWith("storage_"))
                    .sort();

                keys.forEach(k => {
                    const s = JSON.parse(localStorage.getItem(k));
                    if (!s || s.id === currentId) return; // Quelle nicht als Ziel anbieten

                    const mix = calcMixture(s);
                    const vol = mix.volume || 0;
                    const cap = parseFloat(s.capacity) || 0;
                    const free = Math.max(cap - vol, 0);  // freie Kapazit√§t

                    const opt = document.createElement("option");
                    opt.value = s.id;
                    opt.textContent = `${s.name} ‚Äì frei: ${free.toFixed(1)} L (gesamt ${cap} L)`;

                    // Farbliche Warnungen
                    if (free <= 0.2) {
                        opt.style.color = "#cc0000"; // Voll ‚Üí Rot
                    } else if (free < cap * 0.2) {
                        opt.style.color = "#d18f00"; // Fast voll ‚Üí Orange
                    } else {
                        opt.style.color = "#008800"; // Genug Platz ‚Üí Gr√ºn
                    }

                    sel.appendChild(opt);
                });
            }


            // üîç Analyse der Zusammensetzung eines Beh√§lters
            function calcTypeBreakdown(storage) {
                if (!storage || !storage.contents || storage.contents.length === 0) return [];

                const totals = {};
                let totalVol = 0;

                storage.contents.forEach(c => {
                    let vol = parseFloat(c.volume);
                    if (isNaN(vol) || vol === 0) return;

                    // ‚ùå Negative Umsch√ºttungs-Eintr√§ge (z.B. -0,9 L) nicht f√ºr die Prozentrechnung verwenden
                    if (vol < 0) return;

                    // Roh-Label: bevorzugt fruit, sonst source
                    let raw = (c.fruit || c.source || "").trim();
                    if (!raw) raw = "Unbekannt";

                    // üëâ alles mit Prozentangaben rauswerfen (z.B. "51.3%", "100%")
                    raw = raw.replace(/\d[\d.,]*\s*%/g, "");

                    // üëâ "Wasserzugabe" als eigenen Typ stehen lassen
                    // Falls du Wasser in der Zusammenfassung _gar nicht_ sehen willst, kannst du hier:
                    // if (/wasserzugabe/i.test(raw)) return;

                    // üëâ √ºberfl√ºssiges Komma + Rest nach "Wasserzugabe" entfernen:
                    // z.B. "√Ñpfel (3,6) , Wasserzugabe" ‚Üí "√Ñpfel (3,6)"
                    raw = raw.replace(/,\s*Wasserzugabe.*$/i, "");

                    // Leerzeichen bereinigen
                    raw = raw.replace(/\s+/g, " ").trim();
                    if (!raw) raw = "Unbekannt";

                    totals[raw] = (totals[raw] || 0) + vol;
                    totalVol += vol;
                });

                return Object.entries(totals)
                    .filter(([_, v]) => v > 0.0001 && totalVol > 0)
                    .map(([type, v]) => ({
                        type,
                        volume: v,
                        percent: v / totalVol * 100
                    }))
                    .sort((a, b) => b.volume - a.volume); // nach Menge sortiert
            }



            function showStorageContents(storage) {
                const div = document.getElementById("storageContentsList");
                const summary = document.getElementById("storageSummary");

                if (!div || !summary) return;

                if (!storage || !storage.id) {
                    div.innerHTML = "<em>Kein Beh√§lter ausgew√§hlt.</em>";
                    summary.innerHTML = "";
                    return;
                }

                const latest = JSON.parse(localStorage.getItem("storage_" + storage.id) || "null");
                if (!latest || !Array.isArray(latest.contents) || latest.contents.length === 0) {
                    div.innerHTML = "<em>Noch keine Destillate enthalten.</em>";
                    summary.innerHTML = "<em>Keine Daten verf√ºgbar.</em>";

                    const pricingBoxEmpty = document.getElementById("storagePricingInfo");
                    if (pricingBoxEmpty) {
                        pricingBoxEmpty.innerHTML = "<em>Keine Daten f√ºr Kostenberechnung.</em>";
                    }
                    return;
                }

                // üîπ Tabelle aufbauen
                let html = `
        <table style="border-collapse:collapse;width:100%;font-size:0.9em;">
            <tr style="background:#ddd;">
                <th style="width:40%;text-align:left;padding:4px;">Quelle</th>
                <th style="width:15%;text-align:right;padding:4px;">Menge&nbsp;(L)</th>
                <th style="width:10%;text-align:right;padding:4px;">%&nbsp;vol</th>
                <th style="width:20%;text-align:center;padding:4px;">Datum</th>
            </tr>
    `;

                latest.contents.forEach(c => {
                    const src = (c.source || "").replace("archive_", "");
                    const vol = isNaN(parseFloat(c.volume)) ? 0 : parseFloat(c.volume);
                    const str = isNaN(parseFloat(c.strength)) ? 0 : parseFloat(c.strength);

                    const itemId = c.id || "";  // falls alte Eintr√§ge noch keine id haben

                    html += `
            <tr ${itemId ? `onclick="openStorageItemDetails('${itemId}')" style="cursor:pointer;"` : ""}>
                <td style="border-top:1px solid #ccc;padding:4px;">${src}</td>
                <td style="border-top:1px solid #ccc;padding:4px;text-align:right;">${vol.toFixed(2)}</td>
                <td style="border-top:1px solid #ccc;padding:4px;text-align:right;">${str.toFixed(1)}</td>
                <td style="border-top:1px solid #ccc;padding:4px;text-align:center;">${c.dateAdded || ""}</td>
            </tr>
        `;
                });

                html += "</table>";
                div.innerHTML = html;

                // üîπ Gesamtmenge & Durchschnitts-%vol
                const mix = calcMixture(latest);
                let summaryText =
                    `<strong>Gesamtmenge:</strong> ${mix.volume.toFixed(1)} L @ ${mix.strength.toFixed(1)} %vol`;

                // üîπ Fruchtverteilung aus c.fruit + c.volume
                const fruitTotals = {};
                let totalFruitLiters = 0;

                latest.contents.forEach(c => {
                    let vol = parseFloat(c.volume);
                    if (isNaN(vol) || vol <= 0) return;

                    let label = (c.fruit || "").trim();
                    if (!label) return;

                    if (label.includes("%")) {
                        // z. B. "√Ñpfel 30.0%, Birnen 70.0%"
                        label.split(",").forEach(part => {
                            const m = part.trim().match(/^(.+?)\s+([\d.,]+)%$/);
                            if (!m) return;
                            let name = m[1].trim();
                            let pct = parseFloat(m[2].replace(",", ".")) || 0;
                            if (pct <= 0) return;

                            name = name.replace(/\([^)]*\)/g, "").trim();
                            const liters = vol * (pct / 100);
                            fruitTotals[name] = (fruitTotals[name] || 0) + liters;
                            totalFruitLiters += liters;
                        });
                    } else {
                        // Einfache Frucht (z. B. "√Ñpfel (3,6)")
                        let name = label.replace(/\([^)]*\)/g, "").trim();
                        if (!name) name = "Unbekannt";
                        fruitTotals[name] = (fruitTotals[name] || 0) + vol;
                        totalFruitLiters += vol;
                    }
                });

                if (totalFruitLiters > 0 && Object.keys(fruitTotals).length > 0) {
                    summaryText += "<br><br><strong>Fruchtverteilung im Beh√§lter:</strong><ul style='margin-top:4px;'>";
                    Object.entries(fruitTotals)
                        .sort((a, b) => b[1] - a[1])
                        .forEach(([fruit, liters]) => {
                            const percent = (liters / totalFruitLiters) * 100;
                            summaryText += `<li>${fruit}: ${liters.toFixed(2)} L (${percent.toFixed(1)}%)</li>`;
                        });
                    summaryText += "</ul>";
                }

                summary.innerHTML = summaryText;

                // ‚ú® NEU: Kosten-Mix & Kosten bei Trinkst√§rke anzeigen
                const pricingBox = document.getElementById("storagePricingInfo");
                if (pricingBox) {
                    const pricing = calcStoragePricing(latest);

                    if (!pricing || pricing.totalVolume <= 0 || pricing.knownVolume <= 0 || pricing.totalCost <= 0) {
                        pricingBox.innerHTML = "<em>Keine ausreichenden Kalkulationsdaten f√ºr Kostenanzeige vorhanden.</em>";
                    } else {
                        let pricingHtml = `
                <strong>üí∂ Kostenanalyse (intern, nicht verkaufsrelevant)</strong><br>
                Gesamtvolumen (inkl. Wasser): ${pricing.totalVolume.toFixed(2)} L<br>
                Kostenrelevantes Volumen: ${pricing.knownVolume.toFixed(2)} L<br>
                Mischkosten (nur kalkulierte Anteile): 
                <strong>${pricing.costPerLiter.toFixed(2)} ‚Ç¨/L</strong>
            `;

                        if (pricing.waterVolume > 0) {
                            pricingHtml += `<br>Enth√§lt Wasser: ${pricing.waterVolume.toFixed(2)} L (0,00 ‚Ç¨ Kosten)`;
                        }

                        if (pricing.unknownVolume > 0) {
                            pricingHtml += `<br><em>Achtung: ${pricing.unknownVolume.toFixed(2)} L stammen aus nicht kalkulierten Destillaten ‚Äì Kosten & Mindestpreise sind dadurch eher zu niedrig.</em>`;
                        }

                        if (pricing.AA_total > 0 && pricing.dilutedVolume > 0 && pricing.dilutedCostPerLiter > 0) {
                            pricingHtml += `
                    <br><br><strong>üìâ Kosten bei Trinkst√§rke (theoretisch)</strong><br>
                    Zielst√§rke: ${pricing.targetAbv.toFixed(1)} %vol<br>
                    Endvolumen bei Trinkst√§rke: ${pricing.dilutedVolume.toFixed(2)} L<br>
                    ‚Üí Kosten / L bei ${pricing.targetAbv.toFixed(1)} %vol: 
                    <strong>${pricing.dilutedCostPerLiter.toFixed(2)} ‚Ç¨/L</strong><br>
                    Hinweis: Dies ist eine rechnerische Hochrechnung und kein Verkaufspreis.  
                `;
                        }

                        pricingBox.innerHTML = pricingHtml;
                    }
                }
            }



            function openStorageItemDetails(itemId) {
                const storageId = document.getElementById("storageSelect").value;
                if (!storageId) return;

                const s = JSON.parse(localStorage.getItem("storage_" + storageId));
                if (!s || !s.contents) return;

                const item = s.contents.find(c => c.id === itemId);
                if (!item) return;

                const products = JSON.parse(localStorage.getItem("products") || "[]");
                const product = item.productId
                    ? products.find(p => p.id === item.productId)
                    : null;

                let html = "";

                html += `<strong>Quelle:</strong> ${item.source}<br>`;
                html += `<strong>Menge:</strong> ${Number(item.volume || 0).toFixed(2)} L<br>`;
                html += `<strong>St√§rke:</strong> ${Number(item.strength || 0).toFixed(1)} %vol<br>`;
                html += `<strong>Hinzugef√ºgt am:</strong> ${item.dateAdded || "-"}<br><br>`;

                // -----------------------------
                // PRODUKTDETAILS FALLS VORHANDEN
                // -----------------------------
                if (product) {

                    html += `<h4>Produktdetails (Quelle des markierten Eintrags)</h4>`;
                    html += `<strong>Produktname:</strong> ${product.name}<br>`;

                    if (product.burnDate) html += `<strong>Brenndatum:</strong> ${product.burnDate}<br>`;
                    if (product.burnNumber) html += `<strong>Brand-Nr.:</strong> ${product.burnNumber}<br>`;
                    if (product.totalCosts) html += `<strong>Gesamtkosten:</strong> ${product.totalCosts.toFixed(2)} ‚Ç¨<br>`;
                    if (product.costPerLiter) html += `<strong>Kosten/Liter:</strong> ${product.costPerLiter.toFixed(2)} ‚Ç¨<br>`;

                    if (product.waterAdded) {
                        html += `<strong>Hinzugef√ºgtes Wasser:</strong> ${product.waterAdded.toFixed(2)} L<br>`;
                    }

                    // ---------------------------------------
                    // ‚≠ê Geplante Verd√ºnnung robust anzeigen ‚≠ê
                    // ---------------------------------------
                    if (product.plannedDilution) {
                        const p = product.plannedDilution;

                        html += `<br><strong>Geplante Verd√ºnnung:</strong><br>`;

                        // Hilfsfunktion f√ºr sichere Zahlenformatierung
                        function toNum(v) {
                            const n = Number(v);
                            return isNaN(n) ? null : n;
                        }

                        // üîÅ alte & neue Feldnamen zusammenf√ºhren
                        const realVol = toNum(p.realVolume);
                        const realStrength = toNum(p.realStrength);
                        const targetVol = toNum(p.targetVolume != null ? p.targetVolume : p.endVolume);
                        const targetAbv = toNum(p.targetAbv);
                        const water = toNum(p.waterNeeded != null ? p.waterNeeded : p.waterAdded);

                        // 1Ô∏è‚É£ Vollst√§ndige Daten (Fass ODER Charge)
                        if (realVol !== null && realStrength !== null && targetVol !== null && targetAbv !== null && water !== null) {
                            html += `
            Von: ${realVol.toFixed(2)} L @ ${realStrength.toFixed(1)}% vol<br>
            Auf: ${targetVol.toFixed(2)} L @ ${targetAbv.toFixed(1)}% vol<br>
            Wasserbedarf: ${water.toFixed(2)} L<br>
        `;
                        }

                        // 2Ô∏è‚É£ Nur Zielmenge & Wasser (z. B. vereinfachte Charge)
                        else if (targetVol !== null && water !== null) {
                            html += `
            Zielmenge: ${targetVol.toFixed(2)} L${targetAbv !== null ? ` @ ${targetAbv.toFixed(1)}% vol` : ""}<br>
            Ben√∂tigtes Wasser: ${water.toFixed(2)} L<br>
        `;
                        }

                        // 3Ô∏è‚É£ Fallback
                        else {
                            html += `<em>Keine detaillierten Verd√ºnnungsdaten verf√ºgbar.</em>`;
                        }
                    }





                } // ‚ùó Hier schlie√üt der "if(product)"-Block sauber!

                // -----------------------------
                // DETAILS AUSGEBEN
                // -----------------------------
                const detailDiv = document.getElementById("storageItemDetails");
                if (detailDiv) {
                    detailDiv.innerHTML = `<div style="margin-bottom:6px;">${html}</div>`;
                    detailDiv.style.display = "block";
                    detailDiv.scrollIntoView({ behavior: "smooth", block: "center" });
                } else {
                    alert(html.replace(/<br>/g, "\n").replace(/<[^>]+>/g, ""));
                }
            }







            function closeStorageItemDialog() {
                document.getElementById("storageItemDialog").style.display = "none";
            }







            function saveStorage() {
                const id = document.getElementById("storageSelect").value;
                if (!id) return alert("Kein Beh√§lter gew√§hlt!");

                const s = JSON.parse(localStorage.getItem("storage_" + id));
                s.name = document.getElementById("storageName").value.trim();
                s.capacity = parseFloat(document.getElementById("storageCapacity").value);
                s.location = document.getElementById("storageLocation").value.trim();
                localStorage.setItem("storage_" + id, JSON.stringify(s));

                updateStorageDropdown();
                alert("üíæ √Ñnderungen gespeichert!");
            }

            function deleteStorage() {
                const id = document.getElementById("storageSelect").value;
                if (!id) return;
                if (!confirm("Beh√§lter wirklich l√∂schen?")) return;

                localStorage.removeItem("storage_" + id);
                updateStorageDropdown();
                document.getElementById("storageForm").reset;
                document.getElementById("storageContentsList").innerHTML = "";
            }

            function addDistillateFromDropdown() {
                const archiveName = document.getElementById("archiveSelect").value;
                const targetStorageId = document.getElementById("storageSelect").value;
                const volume = parseFloat(document.getElementById("distillateVolume").value);
                const fruit = document.getElementByID("fruit").value;
                if (!archiveName || !targetStorageId || isNaN(volume) || volume <= 0) {
                    alert("Bitte Destillat, Beh√§lter und Menge angeben!");
                    return;
                }

                addDistillate(archiveName, targetStorageId, volume);
            }


            function cancelAddDistillate() {
                const modal = document.getElementById("addDistillateModal");
                const overlay = document.getElementById("modalOverlay");

                if (modal) modal.style.display = "none";
                if (overlay) overlay.style.display = "none";

                currentStorageId = null;
            }




            // üí∂ Kosten-Mix + Kosten bei Trinkst√§rke f√ºr einen Lagerbeh√§lter berechnen
            function calcStoragePricing(storage) {
                if (!storage || !Array.isArray(storage.contents)) {
                    return null;
                }

                const products = JSON.parse(localStorage.getItem("products") || "[]");

                let totalVolume = 0;
                let waterVolume = 0;
                let knownVolume = 0;
                let unknownVolume = 0;
                let totalCost = 0;

                let AA_total = 0;

                storage.contents.forEach(c => {
                    const vol = parseFloat(c.volume) || 0;
                    const str = parseFloat(c.strength) || 0;
                    if (vol <= 0) return;

                    totalVolume += vol;
                    AA_total += vol * (str / 100);

                    if (str <= 0) {
                        waterVolume += vol;
                    }

                    let prod = null;

                    // ====== bestehende Logik: Produkt direkt gefunden? ======
                    if (c.productId) {
                        prod = products.find(p => p.id === c.productId);
                    }

                    if (!prod && c.source) {
                        prod = products.find(p => p.name === c.source);
                    }

                    // ====== FALL A: direktes Produkt mit Kosten ======
                    if (prod && typeof prod.costPerLiter === "number" && prod.costPerLiter > 0) {
                        knownVolume += vol;
                        totalCost += vol * prod.costPerLiter;
                        return;
                    }

                    // ====== üî• NEU: Rezept-Mix mit productRefs auswerten ======
                    if (c.productRefs && typeof c.productRefs === "object") {

                        let mixCost = 0;
                        let hasCost = false;

                        Object.entries(c.productRefs).forEach(([pid, liters]) => {
                            const p = products.find(x => x.id === pid);
                            if (!p || typeof p.costPerLiter !== "number" || p.costPerLiter <= 0) return;

                            mixCost += liters * p.costPerLiter;
                            hasCost = true;
                        });

                        if (hasCost) {
                            totalCost += mixCost;
                            knownVolume += vol;   // Kosten gelten f√ºr gesamten Mix-Eintrag
                            return;
                        }
                    }

                    // ====== FALL B: Keine Kosten gefunden ======
                    unknownVolume += vol;
                });

                let costPerLiter = 0;
                if (knownVolume > 0 && totalCost > 0) {
                    costPerLiter = totalCost / knownVolume;
                }

                // ===== Zielst√§rke bestimmen (bestehende Logik) =====
                let targetAbv = null;

                storage.contents.forEach(c => {
                    const pd = c.plannedDilution;
                    if (
                        pd &&
                        typeof pd.targetAbv === "number" &&
                        !isNaN(pd.targetAbv) &&
                        pd.targetAbv > 0
                    ) {
                        if (targetAbv === null) targetAbv = pd.targetAbv;
                    }
                });

                if (targetAbv === null) targetAbv = 40;

                // ===== Verd√ºnnung berechnen (bestehend) =====
                let dilutedVolume = 0;
                let dilutedCostPerLiter = 0;

                if (AA_total > 0 && targetAbv > 0 && totalCost > 0) {
                    dilutedVolume = AA_total / (targetAbv / 100);
                    dilutedCostPerLiter = totalCost / dilutedVolume;
                }

                return {
                    totalVolume,
                    waterVolume,
                    knownVolume,
                    unknownVolume,
                    totalCost,
                    costPerLiter,
                    AA_total,
                    targetAbv,
                    dilutedVolume,
                    dilutedCostPerLiter
                };
            }










            function calcMixture(storage) {
                if (!storage || typeof storage !== "object") {
                    console.warn("‚ö†Ô∏è calcMixture aufgerufen ohne g√ºltiges Objekt");
                    return { volume: 0, strength: 0 };
                }

                if (!Array.isArray(storage.contents) && !Array.isArray(storage.distillates)) {
                    return { volume: 0, strength: 0 };
                }

                // üß© Rekursion-Schutz
                if (storage._inCalc) {
                    console.warn("‚ö†Ô∏è Rekursive calcMixture erkannt:", storage.name || storage.id);
                    return { volume: 0, strength: 0 };
                }
                storage._inCalc = true;

                // Kombinierte Liste
                const list = (storage.contents || storage.distillates || []).filter(
                    item => item && typeof item === "object" && item !== storage
                );

                if (list.length === 0) {
                    delete storage._inCalc;
                    return { volume: 0, strength: 0 };
                }

                let totalVol = 0;
                let totalAlcohol = 0;

                list.forEach(item => {
                    const vol = parseFloat(item.volume) || 0;
                    const str = parseFloat(item.strength) || 0;
                    totalVol += vol;
                    totalAlcohol += vol * (str / 100);
                });

                const avgStrength = totalVol > 0 ? (totalAlcohol / totalVol) * 100 : 0;
                delete storage._inCalc;

                return { volume: totalVol, strength: avgStrength };
            }


            /***************************************
             * ABF√úLL-KALKULATION (Flaschen)
             ***************************************/

            // Verpackungskosten je Flaschengr√∂√üe
            var packagingCatalog = {
                0.2: {
                    bottle: 0.55,
                    cork: 0.18,
                    label: 0.22,
                    capsule: 0.12,
                    carton: 0.05
                },
                0.5: {
                    bottle: 0.72,
                    cork: 0.22,
                    label: 0.28,
                    capsule: 0.14,
                    carton: 0.07
                },
                0.7: {
                    bottle: 0.85,
                    cork: 0.24,
                    label: 0.32,
                    capsule: 0.16,
                    carton: 0.09
                }
            }

            // 1Ô∏è‚É£ Maximale Flaschenzahl
            function calcMaxBottles(availableVolumeL, bottleSizeL, safetyLossPercent) {

                if (!safetyLossPercent) safetyLossPercent = 0;

                // effektiv verf√ºgbare Menge
                const usableVolume = availableVolumeL * (1 - safetyLossPercent / 100);

                // ‚õëÔ∏è Floating-Point-Fix
                const EPS = 1e-9;

                return Math.floor((usableVolume / bottleSizeL) + EPS);
            }


            // 2Ô∏è‚É£ Fl√ºssigkeitskosten pro Flasche
            function calcLiquidCostPerBottle(costPerLiter, bottleSizeL) {
                return costPerLiter * bottleSizeL
            }

            // 3Ô∏è‚É£ Verpackungskosten pro Flasche
            function calcPackagingCostPerBottle(bottleSizeL) {
                var pack = packagingCatalog[bottleSizeL]

                if (!pack) {
                    alert("Keine Verpackungskosten f√ºr " + bottleSizeL + " L definiert")
                    return 0
                }

                var sum = 0
                for (var key in pack) {
                    sum += pack[key]
                }
                return sum
            }

            // 4Ô∏è‚É£ Mindestpreis pro Flasche
            function calcMinBottlePrice(costPerLiter, bottleSizeL) {
                var liquid =
                    calcLiquidCostPerBottle(costPerLiter, bottleSizeL)

                var packaging =
                    calcPackagingCostPerBottle(bottleSizeL)

                return {
                    liquidCostPerBottle: liquid,
                    packagingCostPerBottle: packaging,
                    minPricePerBottle: liquid + packaging
                }
            }

            // 5Ô∏è‚É£ Zentrale Vorschau-Funktion
            function calcBottlingPreview(
                availableVolumeL,
                costPerLiter,
                bottleSizeL,
                safetyLossPercent
            ) {
                var maxBottles =
                    calcMaxBottles(availableVolumeL, bottleSizeL, safetyLossPercent);

                var filledVolume =
                    maxBottles * bottleSizeL;

                // üîë NUR Fl√ºssigkeit, keine Verpackung
                var liquidCostPerBottle =
                    costPerLiter * bottleSizeL;

                return {
                    bottleSizeL: bottleSizeL,
                    maxBottles: maxBottles,
                    filledVolume: filledVolume,
                    liquidCostPerBottle: liquidCostPerBottle,

                    // explizit 0, damit klar ist: hier passiert nichts
                    packagingCostPerBottle: 0,

                    // semantisch korrekt: kein Verkaufspreis
                    minPricePerBottle: liquidCostPerBottle
                };
            }



            function previewBottling() {
                var TOLERANCE = 0.2; // ¬±0,2 %vol Hinweisgrenze

                function readNumber(id) {
                    var el = document.getElementById(id);
                    if (!el) return NaN;
                    return parseFloat(String(el.value).replace(",", "."));
                }

                // ---------- Abf√ºllmenge
                var takenVolume = readNumber("saleVolume");
                if (!takenVolume || takenVolume <= 0) {
                    alert("Bitte eine g√ºltige Abf√ºllmenge (L) eingeben");
                    return;
                }

                // ---------- Flaschengr√∂√üe
                var bottleSize = readNumber("bottleSizeInput");
                if (!bottleSize || bottleSize <= 0) {
                    alert("Bitte g√ºltige Flaschengr√∂√üe eingeben");
                    return;
                }

                // ---------- Quelle
                var sel = document.getElementById("saleStorage");
                if (!sel || !sel.value) {
                    alert("Bitte zuerst einen Beh√§lter oder ein Fass ausw√§hlen");
                    return;
                }

                var id = sel.value;
                var s = null;
                var sourceType = null;

                if (id.startsWith("cask_")) {
                    // ü•É Fass
                    sourceType = "cask";
                    var casks = JSON.parse(localStorage.getItem("casks") || "[]");
                    s = casks.find(c => c.id === id);

                    if (!s) {
                        alert("Fass nicht gefunden");
                        return;
                    }
                } else {
                    // üõ¢ Lagerbeh√§lter
                    sourceType = "storage";
                    s = JSON.parse(localStorage.getItem("storage_" + id));
                    if (!s) {
                        alert("Lagerbeh√§lter nicht gefunden");
                        return;
                    }
                }

                // ---------- Mischung bestimmen
                var mix = { volume: 0, strength: 0 };

                if (sourceType === "storage") {
                    if (typeof calcMixture !== "function") {
                        alert("calcMixture() nicht verf√ºgbar");
                        return;
                    }
                    mix = calcMixture(s);
                }

                if (sourceType === "cask") {
                    var vol = 0;
                    var aa = 0;
                    (s.fillHistory || []).forEach(function (e) {
                        vol += e.volume || 0;
                        aa += e.AA || 0;
                    });
                    mix.volume = vol;
                    mix.strength = vol > 0 ? (aa / vol) * 100 : 0;
                }

                // ---------- Volumenpr√ºfung
                var availableVol = Math.round(mix.volume * 1000) / 1000;
                var requestedVol = Math.round(takenVolume * 1000) / 1000;

                if (requestedVol > availableVol) {
                    alert(
                        "Nicht gen√ºgend Volumen vorhanden.\n\n" +
                        "Verf√ºgbar: " + availableVol.toFixed(2) + " L\n" +
                        "Gew√ºnscht: " + requestedVol.toFixed(2) + " L"
                    );
                    return;
                }

                // ---------- Referenz-Trinkst√§rke (falls vorhanden)
                var targetStrength = null;

                if (sourceType === "storage" && Array.isArray(s.contents)) {
                    var withPlan = s.contents.find(c =>
                        c && c.plannedDilution &&
                        typeof c.plannedDilution.targetAbv === "number"
                    );
                    if (withPlan) targetStrength = withPlan.plannedDilution.targetAbv;
                }

                var baseStrength = mix.strength;

                // ---------- Hinweis bei Abweichung (KEIN Abbruch!)
                if (
                    targetStrength &&
                    Math.abs(baseStrength - targetStrength) > TOLERANCE
                ) {
                    if (!confirm(
                        "‚ö†Ô∏è Abweichende Trinkst√§rke\n\n" +
                        "Kalkuliert: " + targetStrength.toFixed(1) + " %vol\n" +
                        "Aktuell: " + baseStrength.toFixed(1) + " %vol\n\n" +
                        "Der Mindestpreis wird automatisch angepasst.\n\n" +
                        "OK = Weiter abf√ºllen\n" +
                        "Abbrechen = Abf√ºllung abbrechen"
                    )) {
                        return;
                    }
                }

                // ---------- Preislogik (unver√§ndert)
                var costPerLiterAdjusted = null;

                // A) Lagerbeh√§lter
                if (sourceType === "storage") {
                    if (typeof calcStoragePricing !== "function") {
                        alert("calcStoragePricing() nicht verf√ºgbar");
                        return;
                    }

                    const pricing = calcStoragePricing(s);

                    if (
                        !pricing ||
                        typeof pricing.dilutedCostPerLiter !== "number" ||
                        pricing.dilutedCostPerLiter <= 0
                    ) {
                        alert("Kosten bei Trinkst√§rke konnten nicht berechnet werden");
                        return;
                    }

                    costPerLiterAdjusted = pricing.dilutedCostPerLiter;
                }

                // B) Fass (Whisky)
                if (sourceType === "cask") {
                    const cpl = calcWhiskyCostPerLiterFromCask(s);
                    if (!cpl) {
                        alert("F√ºr dieses Fass sind keine Batch-Kosten hinterlegt.");
                        return;
                    }
                    costPerLiterAdjusted = cpl;
                }

                // ---------- Abf√ºll-Vorschau
                var result = calcBottlingPreview(
                    takenVolume,
                    costPerLiterAdjusted,
                    bottleSize,
                    0 // kein Verlust
                );

                document.getElementById("bottlingPreview").innerHTML =
                    "<b>Abf√ºll-Vorschau</b><br>" +
                    "St√§rke: " + baseStrength.toFixed(1) + " %vol<br>" +
                    (targetStrength ? "Referenz: " + targetStrength.toFixed(1) + " %vol<br>" : "") +
                    "Abf√ºllmenge: " + takenVolume.toFixed(2) + " L<br>" +
                    "Flaschen: " + result.maxBottles + "<br>" +
                    "Fl√ºssigkeitskosten / Flasche: " +
                    result.minPricePerBottle.toFixed(2) + " ‚Ç¨";

                // -------------------------------------------------------------
                // PRODUKTNAME & ST√ÑRKE SAUBER ERMITTELN
                // -------------------------------------------------------------
                const isCask = (sourceType === "cask");
                let resolvedName = shortProductName(s?.name || "");
                let resolvedStrength = baseStrength;

                const products = JSON.parse(localStorage.getItem("products") || "[]");

                // üõ¢ STORAGE ‚Üí Produktname aus productId des ersten Inhalts
                if (!isCask && Array.isArray(s.contents) && s.contents.length) {
                    const firstWithProduct = s.contents.find(c => c && c.productId);
                    if (firstWithProduct && firstWithProduct.productId) {
                        const p = products.find(x => x.id === firstWithProduct.productId);
                        if (p && p.name) {
                            resolvedName = shortProductName(p.name);
                        }
                    }
                }

                // ü•É CASK ‚Üí Name & St√§rke aus der F√ºll-Historie
                if (isCask && Array.isArray(s.fillHistory)) {
                    const lastNamed = [...s.fillHistory].reverse()
                        .find(e => typeof e.recipeName === "string" && e.recipeName.trim() !== "");
                    if (lastNamed) resolvedName = lastNamed.recipeName.trim();

                    const lastStrength = [...s.fillHistory].reverse()
                        .find(e => typeof e.strength === "number");
                    if (lastStrength) resolvedStrength = lastStrength.strength;
                }

                if (!resolvedName) {
                    resolvedName = s && s.name ? s.name : "Unbekanntes Produkt";
                }

                // -------------------------------------------------------------
                // lastBottlingPreview setzen (Basis f√ºr saveBottling)
                // -------------------------------------------------------------
                window.lastBottlingPreview = {
                    sourceType: isCask ? "cask" : "storage",
                    sourceId: s.id,

                    // ‚≠ê‚≠ê‚≠ê WICHTIG: Produkt-Zuordnung ‚≠ê‚≠ê‚≠ê
                    productId: (() => {

                        // 1Ô∏è‚É£ FASS ‚Üí falls verkn√ºpftes Produkt existiert
                        if (isCask && s.productId)
                            return s.productId;

                        // 2Ô∏è‚É£ LAGER mit GENAU 1 Produkt drin
                        if (!isCask && Array.isArray(s.contents) && s.contents.length === 1)
                            return s.contents[0].productId || null;

                        // 3Ô∏è‚É£ sonst KEIN klares Produkt
                        return null;

                    })(),


                    productName: resolvedName,
                    baseStrength: resolvedStrength,
                    targetStrength: targetStrength,
                    takenVolume: takenVolume,
                    bottleSize: result.bottleSizeL,
                    bottleCount: result.maxBottles,
                    filledVolume: result.filledVolume,

                    costPerLiterAdjusted: costPerLiterAdjusted,
                    packagingCostPerBottle: result.packagingCostPerBottle,
                    minPricePerBottle: result.minPricePerBottle,

                    // F√ºr Lagerbeh√§lter: komplette contents als Referenz
                    // F√ºr Fass: Herkunft √ºber Fass-ID / Batch wird sp√§ter in saveBottling sauber gesetzt
                    productRefs: isCask
                        ? []   // beim Speichern aus dem Fass behandeln wir das separat
                        : JSON.parse(JSON.stringify(s.contents || []))
                };

            }






            function renderBottlingsList() {
                var list = document.getElementById("bottlingsList");
                if (!list) return;

                var bottlings =
                    JSON.parse(localStorage.getItem("bottlings") || "[]");

                if (!bottlings.length) {
                    list.innerHTML = "<em>Keine Abf√ºllungen vorhanden.</em>";
                    return;
                }

                var html = "";

                bottlings.forEach(function (b) {
                    var remaining =
                        (typeof b.remainingBottles === "number")
                            ? b.remainingBottles
                            : b.bottleCount;

                    html += `
                    <div style="
                        border:1px solid #ccc;
                        border-radius:8px;
                        padding:10px;
                        margin-bottom:10px;
                        background:#fff;
                    ">
                        <b>${(b.bottleSize * 1000).toFixed(0)} ml</b> ‚Äì
                        ${remaining} / ${b.bottleCount} Flaschen<br>

                        St√§rke: ${b.strength?.toFixed(1) || "?"} %vol<br>
                        Mindestpreis / Flasche: ${b.minPricePerBottle.toFixed(2)} ‚Ç¨<br>
                        Abgef√ºllt am: ${new Date(b.createdAt).toLocaleDateString()}<br>

                        <button onclick="openSellBottling('${b.id}')"
                        style="margin-top:6px;">
                        üí∞ Verkaufen
                        </button>
                    </div>
                    `;
                });

                list.innerHTML = html;
            }



            function openSellBottling(bottlingId) {
                window.currentSellBottlingId = bottlingId;
                showPage("pageSellBottling"); // kommt in C.2
            }



            function renderBottlingsTable() {

                const body = document.getElementById("bottlingsTableBody");
                if (!body) return;

                const bottlings = JSON.parse(localStorage.getItem("bottlings") || "[]");

                if (!bottlings.length) {
                    body.innerHTML =
                        `<tr><td colspan="6"><em>Keine Abf√ºllungen vorhanden.</em></td></tr>`;
                    return;
                }

                body.innerHTML = "";

                bottlings.forEach(b => {
                    const remaining =
                        typeof b.remainingBottles === "number"
                            ? b.remainingBottles
                            : b.bottleCount;

                    if (remaining <= 0) return; // leere Abf√ºllungen ausblenden

                    // St√§rke robust anzeigen
                    const strength =
                        typeof b.strength === "number"
                            ? b.strength.toFixed(1)
                            : (typeof b.targetStrength === "number"
                                ? b.targetStrength.toFixed(1)
                                : "?");

                    const row = document.createElement("tr");
                    row.style.borderBottom = "1px solid #ddd";

                    row.innerHTML = `
                        <td>${b.labelText || "‚Äî"}</td>
                        <td>${b.location || "‚Äî"}</td>
                        <td align="center">${(b.bottleSize * 1000).toFixed(0)} ml</td>
                        <td align="center">${b.baseStrength} %</td>
                        <td align="center">${b.remainingBottles}</td>
                        <td align="right">${b.minPricePerBottle.toFixed(2)}</td>
                        <td align="center">
                            <button onclick="selectBottlingForSale('${b.id}')">üí∞</button>
                        </td>
                    `;

                    body.appendChild(row);
                });
            }


            function selectBottlingForSale(id) {
                window.currentSaleBottlingId = id;
                showPage("sellBottlings");
            }




            function loadSellBottling() {

                const info = document.getElementById("sellBottlingInfo");
                const selectBlock = document.getElementById("sellBottlingSelectBlock");
                const sel = document.getElementById("sellBottlingSelect");

                populateSellBottlingDropdown();

                if (!window.currentSaleBottlingId) {

                    if (selectBlock) selectBlock.style.display = "block";
                    if (sel) {
                        sel.disabled = false;
                        sel.value = "";
                    }

                    if (info) info.innerHTML = "<em>Bitte Abf√ºllung ausw√§hlen.</em>";

                    document.getElementById("sellBottleCount").value = "";
                    document.getElementById("sellPricePerBottle").value = "";
                    document.getElementById("sellExtraCosts").value = "";

                    return;
                }


                const id = window.currentSaleBottlingId;

                if (selectBlock) selectBlock.style.display = "block";
                if (sel) {
                    sel.value = id;
                    sel.disabled = false;
                }

                const bottlings = JSON.parse(localStorage.getItem("bottlings") || "[]");
                const b = bottlings.find(x => x.id === id);
                if (!b) return;


                // üîç Produkt ermitteln
                const products = JSON.parse(localStorage.getItem("products") || "[]");
                let mainProduct = null;

                // 1Ô∏è‚É£ bevorzugt productId
                if (b.productId) {
                    mainProduct = products.find(p => p.id === b.productId);
                }

                // 2Ô∏è‚É£ fallback productRefs
                if (!mainProduct && b.productRefs) {

                    if (Array.isArray(b.productRefs) && b.productRefs.length === 1) {
                        mainProduct = products.find(p => p.id === b.productRefs[0].productId);
                    }

                    else if (!Array.isArray(b.productRefs)) {
                        const ids = Object.keys(b.productRefs);
                        if (ids.length === 1) {
                            mainProduct = products.find(p => p.id === ids[0]);
                        }
                    }
                }


                // üî¢ Flaschengr√∂√üe
                const bottleSizeL = Number(b.bottleSize) || 0;
                const sizeKey = String(bottleSizeL);


                // 1Ô∏è‚É£ Kosten je Liter Trinkst√§rke
                let costPerLiterTS = 0;

                if (typeof b.liquidCostPerLiter === "number") {
                    costPerLiterTS = b.liquidCostPerLiter;
                } else if (mainProduct && typeof mainProduct.costPerLiter === "number") {
                    costPerLiterTS = mainProduct.costPerLiter;
                }


                // 2Ô∏è‚É£ Kosten je Flasche
                const costPerBottleNoGain =
                    (costPerLiterTS && bottleSizeL)
                        ? costPerLiterTS * bottleSizeL
                        : 0;


                // 3Ô∏è‚É£ Mindestpreis
                let minPricePerBottle = 0;

                if (mainProduct?.calcPrice?.[sizeKey]?.min) {
                    minPricePerBottle = mainProduct.calcPrice[sizeKey].min;
                } else if (typeof b.minPricePerBottle === "number") {
                    minPricePerBottle = b.minPricePerBottle;
                }


                // 4Ô∏è‚É£ Geplanter Verkaufspreis (Wunschpreis)
                let plannedPricePerBottle = null;

                if (mainProduct?.userPrice) {

                    // immer String-Key erzeugen
                    const sizeKey = String(bottleSizeL);

                    // --- direkter Treffer ---
                    if (typeof mainProduct.userPrice[sizeKey] === "number") {
                        plannedPricePerBottle = mainProduct.userPrice[sizeKey];
                    }

                    // --- Fallback: n√§chstgr√∂√üere Gr√∂√üe ---
                    else {
                        const possible = Object.keys(mainProduct.userPrice)
                            .map(Number)
                            .filter(v => !isNaN(v))
                            .sort((a, b) => a - b);

                        for (let v of possible) {
                            if (v >= bottleSizeL) {
                                const p = mainProduct.userPrice[String(v)];
                                if (typeof p === "number") {
                                    plannedPricePerBottle = p;
                                    break;
                                }
                            }
                        }
                    }
                }


                const remaining =
                    typeof b.remainingBottles === "number"
                        ? b.remainingBottles
                        : b.bottleCount;

                const strength =
                    typeof b.strength === "number"
                        ? b.strength.toFixed(1)
                        : (b.targetStrength?.toFixed?.(1) || "?");


                // ‚ÑπÔ∏è Anzeige
                if (info) {
                    info.innerHTML = `
            <b>üçæ Produkt</b><br>
            ${b.labelText || "‚Äî"}<br><br>

            <b>Lagerort:</b> ${b.location || "‚Äî"}<br>
            <b>Flasche:</b> ${(bottleSizeL * 1000).toFixed(0)} ml<br>
            <b>St√§rke:</b> ${strength} %vol<br>
            <b>Bestand:</b> ${remaining} Flaschen<br><br>

            <b>Kosten je Liter Trinkst√§rke:</b> ${costPerLiterTS ? costPerLiterTS.toFixed(2) + " ‚Ç¨" : "‚Äì"}<br>
            <b>Kosten je Flasche (ohne Gewinn):</b> ${costPerBottleNoGain ? costPerBottleNoGain.toFixed(2) + " ‚Ç¨" : "‚Äì"}<br>
            <b>Empfohlener Mindestpreis je Flasche:</b> ${minPricePerBottle ? minPricePerBottle.toFixed(2) + " ‚Ç¨" : "‚Äì"}<br>
            <b>Geplanter Verkaufspreis je Flasche:</b> ${plannedPricePerBottle != null ? plannedPricePerBottle.toFixed(2) + " ‚Ç¨" : "‚Äî"}<br>
        `;
                }


                // üí∂ Preis-Vorschlag setzen
                const priceInput = document.getElementById("sellPricePerBottle");

                if (priceInput) {

                    if (plannedPricePerBottle != null) {
                        priceInput.value = plannedPricePerBottle.toFixed(2);
                    }
                    else if (minPricePerBottle) {
                        priceInput.value = minPricePerBottle.toFixed(2);
                    }
                    else if (costPerBottleNoGain) {
                        priceInput.value = costPerBottleNoGain.toFixed(2);
                    }
                    else {
                        priceInput.value = "";
                    }
                }

                document.getElementById("sellBottleCount").value = "";
                document.getElementById("sellExtraCosts").value = "";

                updateSellProfitPreview();
            }





            function shortProductName(name) {

                if (!name) return "Unbekannt";

                let n = name.trim();

                // üîπ Flag sauber deklarieren!
                let isCuvee = false;

                // 1Ô∏è‚É£ Charge erkennen
                if (/charge/i.test(n)) {
                    isCuvee = true;
                }

                // 2Ô∏è‚É£ Klammerzus√§tze entfernen ‚Äì z.B. (3,6)
                n = n.replace(/\(.*?\)/g, "").trim();

                // 3Ô∏è‚É£ Prozent- und Volumenangaben entfernen
                n = n.replace(/‚Äì\s*\d+.*$/i, "").trim();

                // 4Ô∏è‚É£ Brand-/Charge-Zus√§tze entfernen
                n = n.replace(/‚Äì\s*(brand|charge).*$/i, "").trim();

                // 5Ô∏è‚É£ Mehrfach-Leerzeichen fixen
                n = n.replace(/\s+/g, " ").trim();

                // 6Ô∏è‚É£ Charge ‚Üí Cuv√©e
                if (isCuvee) {
                    n = n + " ‚Äì Cuv√©e";
                }

                return n;
            }









            function resetSellBottlingState() {

                // üîπ aktuelle Auswahl zur√ºcksetzen
                window.currentSaleBottlingId = null;

                // üîπ Dropdown freigeben & leeren
                const sel = document.getElementById("sellBottlingSelect");
                if (sel) {
                    sel.disabled = false;
                    sel.value = "";
                }

                // üîπ Eingabefelder leeren
                const c = document.getElementById("sellBottleCount");
                if (c) c.value = "";

                const p = document.getElementById("sellPricePerBottle");
                if (p) p.value = "";

                const e = document.getElementById("sellExtraCosts");
                if (e) e.value = "";


                // üîπ Vorschau zur√ºcksetzen
                const info = document.getElementById("sellPreview");
                if (info) {
                    info.innerHTML = "<em>Bitte Abf√ºllung ausw√§hlen.</em>";
                }
            }





            function saveBottleSale() {

                const draft = buildSaleDraft();
                if (!draft) return;

                finalizeSale(draft);

                // UI wie bisher
                populateSellBottlingDropdown();
                loadSellBottling();

                document.getElementById("sellBottleCount").value = "";
                document.getElementById("sellExtraCosts").value = "";
                updateSellProfitPreview();

                alert("Verkauf gespeichert ‚úîÔ∏è");
            }




            function buildSaleDraft() {

                const bottlings = JSON.parse(localStorage.getItem("bottlings") || "[]");
                const id = window.currentSaleBottlingId;
                const b = bottlings.find(x => x.id === id);

                if (!b) {
                    alert("Abf√ºllung nicht gefunden.");
                    return null;
                }

                const count = parseInt(document.getElementById("sellBottleCount").value, 10);
                const price = parseFloat(document.getElementById("sellPricePerBottle").value);
                const extra = parseFloat(document.getElementById("sellExtraCosts").value) || 0;

                if (!count || count <= 0) {
                    alert("Bitte g√ºltige Flaschenanzahl eingeben.");
                    return null;
                }

                const available =
                    typeof b.remainingBottles === "number"
                        ? b.remainingBottles
                        : b.bottleCount;

                if (count > available) {
                    alert("Nicht gen√ºgend Flaschen auf Lager.");
                    return null;
                }

                // üîπ ENTWURF (noch kein echter Verkauf!)
                return {
                    draft: true,
                    bottlingId: b.id,
                    labelText: b.labelText,
                    location: b.location,
                    bottleSize: b.bottleSize,
                    strength:
                        typeof b.strength === "number"
                            ? b.strength
                            : (typeof b.baseStrength === "number" ? b.baseStrength : null),

                    bottleCount: count,
                    pricePerBottle: price,
                    extraCosts: extra,
                    revenue: count * price,
                    internalCostPerBottle: b.minPricePerBottle,
                    internalCost: count * b.minPricePerBottle,
                    profit: (count * price) - (count * b.minPricePerBottle + extra)
                };
            }




            function finalizeSale(draftSale) {

                const bottlings = JSON.parse(localStorage.getItem("bottlings") || "[]");
                const sales = JSON.parse(localStorage.getItem("sales") || "[]");

                const b = bottlings.find(x => x.id === draftSale.bottlingId);
                if (!b) return null;

                const available =
                    typeof b.remainingBottles === "number"
                        ? b.remainingBottles
                        : b.bottleCount;

                // üü¢ echtes Sale-Objekt erzeugen
                const sale = {
                    ...draftSale,
                    draft: false,
                    id: "sale_" + Date.now(),
                    createdAt: new Date().toISOString(),
                    cancelled: false
                };

                // üîπ Bestand reduzieren
                b.remainingBottles = available - sale.bottleCount;
                if (b.remainingBottles < 0) b.remainingBottles = 0;

                localStorage.setItem("bottlings", JSON.stringify(bottlings));

                // üîπ üëâ NEU: Verkauf IMMER speichern ‚Äî auch ohne Rechnung
                sales.push(sale);
                localStorage.setItem("sales", JSON.stringify(sales));

                return sale;
            }







            function createInvoiceFromSale(saleId) {

                // üîπ Verkauf laden
                const sales = JSON.parse(localStorage.getItem("sales") || "[]");
                const sale = sales.find(s => s.id === saleId);

                if (!sale) {
                    alert("Verkauf nicht gefunden.");
                    return;
                }

                if (sale.cancelled) {
                    alert("Stornierte Verk√§ufe k√∂nnen nicht berechnet werden.");
                    return;
                }

                if (sale.invoiceId) {
                    alert("F√ºr diesen Verkauf wurde bereits eine Rechnung erstellt.");
                    return;
                }

                // üîπ Rechnungsnummer (Jahr + laufend)
                const year = new Date().getFullYear();
                const counterKey = "invoiceCounter_" + year;
                let counter = parseInt(localStorage.getItem(counterKey) || "1", 10);

                const invoiceNumber =
                    year + "-" + String(counter).padStart(3, "0");

                localStorage.setItem(counterKey, String(counter + 1));

                // üîπ Verk√§ufer
                const seller =
                    JSON.parse(localStorage.getItem("sellerProfile") || "{}");

                // üîπ K√§ufer (JETZT NOCH EINFACH)
                const buyerName = prompt("Name des K√§ufers:");
                if (!buyerName) return;

                const buyerAddress = prompt("Adresse des K√§ufers:");
                if (!buyerAddress) return;

                // üîπ Rechnung erzeugen
                const invoice = {
                    id: "invoice_" + Date.now(),
                    invoiceNumber,
                    createdAt: new Date().toISOString(),

                    seller,
                    buyer: {
                        name: buyerName,
                        address: buyerAddress
                    },

                    items: [{
                        description: sale.labelText || "Abf√ºllung",
                        quantity: sale.bottleCount,
                        unitPrice: sale.pricePerBottle,
                        total: sale.bottleCount * sale.pricePerBottle
                    }],

                    totalAmount: sale.bottleCount * sale.pricePerBottle,

                    saleId: sale.id
                };



                // üîπ Rechnung speichern
                const invoices =
                    JSON.parse(localStorage.getItem("invoices") || "[]");
                invoices.push(invoice);
                localStorage.setItem("invoices", JSON.stringify(invoices));

                // üîπ Verkauf markieren
                sale.invoiceId = invoice.id;
                localStorage.setItem("sales", JSON.stringify(sales));

                alert(
                    "Rechnung erstellt ‚úîÔ∏è\n\n" +
                    "Rechnungsnummer: " + invoiceNumber
                );

                createInvoicePDF(invoice);
            }



            function closeInvoiceView() {
                const el = document.getElementById("pageInvoices");
                if (el) el.style.display = "none";
            }



            function createInvoicePDF(invoice) {

                const pageHeight = 297;       // A4 in mm
                const bottomMargin = 25;     // Sicherheitsabstand unten
                const { jsPDF } = window.jspdf;

                const doc = new jsPDF({
                    orientation: "portrait",
                    unit: "mm",
                    format: "a4"
                });

                // Seitenr√§nder
                const marginLeft = 20;
                const marginRight = 190;
                let cursorY = 20;



                // ===== Verk√§ufer =====
                doc.setFont("Helvetica", "normal");
                doc.setFontSize(11);

                const seller = invoice.seller || {};
                const sellerLines = [
                    seller.company || seller.name || "‚Äî",
                    seller.owner || "",
                    seller.street || "",
                    `${seller.zip || ""} ${seller.city || ""}`.trim(),
                    seller.country || ""
                ].filter(Boolean);

                doc.text(sellerLines, marginLeft, cursorY);
                cursorY += sellerLines.length * 5;


                // ===== Rechnungsblock =====
                doc.setFontSize(12);
                doc.text("Rechnung", marginRight, 20, { align: "right" });

                doc.setFontSize(10);
                doc.text(`Rechnungsnummer: ${invoice.invoiceNumber || "‚Äî"}`, marginRight, 30, { align: "right" });
                doc.text(`Datum: ${invoice.createdAt ? new Date(invoice.createdAt).toLocaleDateString() : "‚Äî"}`, marginRight, 36, { align: "right" });


                // ===== K√§ufer =====
                cursorY += 15;
                doc.setFontSize(11);
                doc.text("Rechnung an:", marginLeft, cursorY);
                cursorY += 6;

                doc.setFont("Helvetica", "bold");
                doc.text(String(invoice.buyer?.name || "‚Äî"), marginLeft, cursorY);
                cursorY += 5;

                doc.setFont("Helvetica", "normal");

                // Adresse ZEILENWEISE, NUR STRINGS
                const buyerAddressLines = invoice.buyer
                    ? [
                        invoice.buyer.street,
                        `${invoice.buyer.zip} ${invoice.buyer.city}`,
                        invoice.buyer.country
                    ]
                        .filter(Boolean)          // entfernt undefined / null / ""
                        .map(v => String(v))      // erzwingt String
                    : ["‚Äî"];

                doc.text(buyerAddressLines, marginLeft, cursorY);
                cursorY += buyerAddressLines.length * 5;




                // ===== Trennlinie =====
                cursorY += 10;
                doc.line(marginLeft, cursorY, marginRight, cursorY);


                // ===== Tabelle =====
                cursorY += 10;

                const colPos = marginLeft;
                const colDesc = marginLeft + 10;
                const colQty = marginLeft + 110;
                const colPrice = marginLeft + 130;
                const colTotal = marginRight;

                cursorY = drawTableHeader(cursorY);


                const items = invoice.items || [];


                // ===== Fu√üzeile =====
                const footerY = pageHeight - 15;

                doc.setFontSize(8);
                doc.setFont("Helvetica", "normal");

                // Zeile 1: Name
                const footerLine1 = [
                    seller.company || seller.name,
                    seller.owner
                ].filter(Boolean).join(" ¬∑ ");

                // Zeile 2: Bank
                const footerLine2 = [
                    seller.bank ? `IBAN: ${seller.bank}` : "",
                    //seller.bic ? `BIC: ${seller.bic}` : ""
                ].filter(Boolean).join(" ¬∑ ");

                // Zeile 3: Steuer
                const footerLine3 = [
                    seller.taxNumber ? `Steuernummer: ${seller.taxNumber}` : "",
                    seller.vatId ? `USt-Id: ${seller.vatId}` : ""
                ].filter(Boolean).join(" ¬∑ ");

                const footerLines = [footerLine1, footerLine2, footerLine3].filter(Boolean);

                doc.text(footerLines, marginLeft, footerY);



                function drawTableHeader(y) {
                    doc.setFontSize(10);
                    doc.setFont("Helvetica", "bold");

                    doc.text("Pos", colPos, y);
                    doc.text("Bezeichnung", colDesc, y);
                    doc.text("Menge", colQty, y, { align: "right" });
                    doc.text("Preis", colPrice, y, { align: "right" });
                    doc.text("Summe", colTotal, y, { align: "right" });

                    doc.line(marginLeft, y + 2, marginRight, y + 2);

                    doc.setFont("Helvetica", "normal");

                    return y + 8; // neue Y-Position nach Tabellenkopf
                }


                function drawFooter(pageNo, totalPages) {
                    const footerY = pageHeight - 15;

                    doc.setFontSize(8);
                    doc.setFont("Helvetica", "normal");



                    // Seitenzahl rechts
                    doc.text(
                        `Seite ${pageNo} von ${totalPages}`,
                        marginRight,
                        footerY,
                        { align: "right" }
                    );
                }



                items.forEach((item, index) => {

                    // üî¥ Seitenumbruch pr√ºfen
                    if (cursorY > pageHeight - bottomMargin) {
                        doc.addPage();
                        cursorY = 20; // Startposition neue Seite
                        cursorY = drawTableHeader(cursorY);
                    }

                    doc.text(String(index + 1), colPos, cursorY);
                    doc.text(item.description, colDesc, cursorY);
                    doc.text(item.quantity.toString(), colQty, cursorY, { align: "right" });
                    doc.text(item.unitPrice.toFixed(2) + " ‚Ç¨", colPrice, cursorY, { align: "right" });
                    doc.text(((item.total ?? 0)).toFixed(2) + " ‚Ç¨", colTotal, cursorY, { align: "right" });

                    cursorY += 6;
                });


                // ===== Summen =====
                cursorY += 8;

                const sumLabelX = colPrice;
                const sumValueX = colTotal;

                doc.setFont("Helvetica", "normal");
                doc.setFontSize(10);

                // Netto
                if (invoice.vatMode !== "none") {
                    doc.text("Zwischensumme (netto)", sumLabelX, cursorY, { align: "right" });
                    doc.text(
                        invoice.netAmount.toFixed(2) + " ‚Ç¨",
                        sumValueX,
                        cursorY,
                        { align: "right" }
                    );
                    cursorY += 6;
                }

                // MwSt (nur bei Bruttopreisen)
                if (invoice.seller?.vatMode === "gross") {
                    doc.text(
                        `Umsatzsteuer ${Math.round(invoice.seller.vatRate * 100)} %`,
                        sumLabelX,
                        cursorY,
                        { align: "right" }
                    );
                    doc.text(
                        invoice.vatAmount.toFixed(2) + " ‚Ç¨",
                        sumValueX,
                        cursorY,
                        { align: "right" }
                    );
                    cursorY += 6;
                }


                // Gesamt
                doc.setFont("Helvetica", "bold");
                doc.text("Gesamtbetrag", sumLabelX, cursorY, { align: "right" });
                doc.text(
                    invoice.grossAmount.toFixed(2) + " ‚Ç¨",
                    sumValueX,
                    cursorY,
                    { align: "right" }
                );


                // ===== Steuerhinweis =====
                cursorY += 12;
                doc.setFont("Helvetica", "normal");
                doc.setFontSize(9);

                if (invoice.seller?.vatMode === "none") {
                    doc.text(
                        "Gem√§√ü ¬ß 19 UStG wird keine Umsatzsteuer berechnet.",
                        marginLeft,
                        cursorY
                    );
                }

                if (invoice.seller?.vatMode === "gross") {
                    doc.text(
                        "Der Rechnungsbetrag enth√§lt die gesetzliche Umsatzsteuer.",
                        marginLeft,
                        cursorY
                    );
                }






                // ===== Speichern =====
                const fileName = `Rechnung_${invoice.invoiceNumber || "XXXX"}.pdf`;

                // ===== Fu√üzeile auf alle Seiten =====
                const pageCount = doc.getNumberOfPages();

                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    drawFooter(i, pageCount);
                }


                doc.save(fileName);
            }


            window.downloadInvoicePDF = function () {
                const invoice = createInvoiceFromSale();
                createInvoicePDF(invoice);
            };











            function populateSellBottlingDropdown() {
                const sel = document.getElementById("sellBottlingSelect");
                if (!sel) return;

                const bottlings = JSON.parse(localStorage.getItem("bottlings") || "[]");

                sel.innerHTML = `<option value="">‚Äì bitte w√§hlen ‚Äì</option>`;

                bottlings.forEach(b => {
                    const remaining =
                        typeof b.remainingBottles === "number"
                            ? b.remainingBottles
                            : b.bottleCount;

                    if (remaining <= 0) return;

                    const strength =
                        typeof b.strength === "number"
                            ? b.strength.toFixed(1)
                            : (typeof b.targetStrength === "number"
                                ? b.targetStrength.toFixed(1)
                                : "?");

                    const label =
                        `${b.labelText || "Unbekanntes Produkt"} | ` +
                        `${b.location || "kein Lagerort"} | ` +
                        `${remaining} Fl.`;


                    const opt = document.createElement("option");
                    opt.value = b.id;
                    opt.textContent = label;
                    sel.appendChild(opt);
                });
            }



            function onSellBottlingSelectChange() {
                const sel = document.getElementById("sellBottlingSelect");
                if (!sel || !sel.value) return;

                window.currentSaleBottlingId = sel.value;
                loadSellBottling();
            }





            function updateSellProfitPreview() {

                const preview = document.getElementById("sellProfitPreview");
                if (!preview) return;

                const bottlings = JSON.parse(localStorage.getItem("bottlings") || "[]");
                const id = window.currentSaleBottlingId;
                const b = bottlings.find(x => x.id === id);
                if (!b) {
                    preview.innerHTML = "";
                    return;
                }

                const count = parseInt(document.getElementById("sellBottleCount").value, 10) || 0;
                const price = parseFloat(document.getElementById("sellPricePerBottle").value) || 0;
                const extra = parseFloat(document.getElementById("sellExtraCosts").value) || 0;

                if (count <= 0 || price <= 0) {
                    preview.innerHTML = "";
                    return;
                }

                // üîç Produkt suchen (f√ºr Wunschpreis & Mindestpreis)
                const products = JSON.parse(localStorage.getItem("products") || "[]");
                let product = null;

                if (b.productId) {
                    product = products.find(p => p.id === b.productId);
                }
                if (!product && b.productRefs) {
                    const ids = Object.keys(b.productRefs);
                    if (ids.length === 1)
                        product = products.find(p => p.id === ids[0]);
                }

                const bottleSize = Number(b.bottleSize) || 0;

                // 1Ô∏è‚É£ Kosten je Liter TRINKST√ÑRKE
                const costPerLiter = Number(b.liquidCostPerLiter) || 0;

                // 2Ô∏è‚É£ Kosten je Flasche (ohne Gewinn)
                const costPerBottle = costPerLiter * bottleSize;

                // 3Ô∏è‚É£ Empfohlener Mindestpreis aus Kalkulation
                let minPrice = 0;

                const sizeKey = Number(bottleSize);   // 0.2, 0.5, 0.7, 1.0

                if (
                    product?.calcPrice &&
                    product.calcPrice[sizeKey] &&
                    typeof product.calcPrice[sizeKey].min === "number"
                ) {
                    minPrice = product.calcPrice[sizeKey].min;
                }



                // 4Ô∏è‚É£ Wunschpreis
                let plannedPrice = null;
                if (product?.userPrice?.[bottleSize])
                    plannedPrice = product.userPrice[bottleSize];

                // üí∞ Summen
                const revenue = count * price;
                const internalCost = count * costPerBottle;
                const totalCost = internalCost + extra;
                const profit = revenue - totalCost;

                const color = profit >= 0 ? "green" : "red";

                preview.innerHTML = `
        Umsatz: ${revenue.toFixed(2)} ‚Ç¨<br>
        Interne Kosten: ${internalCost.toFixed(2)} ‚Ç¨<br>
        Zusatzkosten: ${extra.toFixed(2)} ‚Ç¨<br>
        <b style="color:${color}">
            Gewinn / Verlust: ${profit.toFixed(2)} ‚Ç¨
        </b>
        <br><br>
        <u>Preisaufschl√ºsselung:</u><br>
        Kosten je Liter (inkl. Steuer): ${costPerLiter ? costPerLiter.toFixed(2) + " ‚Ç¨" : "‚Äì"}<br>
        Kosten je Flasche (inkl. Flasche): ${costPerBottle ? costPerBottle.toFixed(2) + " ‚Ç¨" : "‚Äì"}<br>
        Empfohlener Mindestpreis: ${(minPrice !== null && !isNaN(minPrice)) ? minPrice.toFixed(2) + " ‚Ç¨" : "‚Äì"}<br>

        ${plannedPrice != null
                        ? "Geplanter Verkaufspreis (Kalkulation): " + plannedPrice.toFixed(2) + " ‚Ç¨"
                        : ""
                    }
    `;
            }




            function renderSalesList() {
                const body = document.getElementById("salesTableBody");
                if (!body) return;

                const stored = localStorage.getItem("sales");
                const sales = stored ? Object.values(JSON.parse(stored)) : [];

                body.innerHTML = "";

                if (sales.length === 0) {
                    body.innerHTML = `
            <tr>
                <td colspan="7"><em>Noch keine Verk√§ufe vorhanden.</em></td>
            </tr>
        `;
                    return;
                }

                sales.forEach(s => {
                    const isCancelled = s.cancelled === true;

                    const row = document.createElement("tr");
                    row.style.opacity = isCancelled ? "0.5" : "1";

                    const displayRevenue = isCancelled ? 0 : s.revenue;
                    const displayProfit = isCancelled ? 0 : Math.round(s.profit * 100) / 100;
                    const profitColor = displayProfit >= 0 ? "green" : "red";

                    row.innerHTML = `
            <td>${new Date(s.createdAt).toLocaleDateString("de-DE")}</td>
            <td>${s.labelText || "‚Äî"}</td>
            <td>${s.location || "‚Äî"}</td>
            <td align="center">${s.bottleCount}</td>
            <td align="right">${s.pricePerBottle.toFixed(2)} ‚Ç¨</td>
            <td align="right">${displayRevenue.toFixed(2)} ‚Ç¨</td>
            <td align="right" style="color:${profitColor}">
                ${displayProfit.toFixed(2)} ‚Ç¨
            </td>
            <td align="center">
                ${isCancelled
                            ? "<strong style='color:#a00;'>STORNIERT</strong>"
                            : s.invoiceId
                                ? "<em>berechnet</em>"
                                : "<em>Barverkauf</em>"
                        }
            </td>
        `;

                    body.appendChild(row);
                });
            }





            function cancelSale(saleId) {

                if (!confirm("Verkauf wirklich stornieren?\n\nDer Bestand wird zur√ºckgebucht.")) {
                    return;
                }

                const sales = JSON.parse(localStorage.getItem("sales") || "[]");
                const sale = sales.find(s => s.id === saleId);

                if (!sale || sale.cancelled) {
                    alert("Verkauf nicht gefunden oder bereits storniert.");
                    return;
                }

                const bottlings = JSON.parse(localStorage.getItem("bottlings") || "[]");
                const b = bottlings.find(x => x.id === sale.bottlingId);

                if (!b) {
                    alert("Zugeh√∂rige Abf√ºllung nicht gefunden.");
                    return;
                }

                // üîÅ Bestand zur√ºckbuchen
                const current =
                    typeof b.remainingBottles === "number"
                        ? b.remainingBottles
                        : b.bottleCount;

                b.remainingBottles = current + sale.bottleCount;

                // üîí Verkauf als storniert markieren
                sale.cancelled = true;
                sale.cancelledAt = new Date().toISOString();

                // üîπ Speichern
                localStorage.setItem("bottlings", JSON.stringify(bottlings));
                localStorage.setItem("sales", JSON.stringify(sales));

                // üîÑ UI aktualisieren
                renderSalesList();

                alert("Verkauf wurde storniert ‚úîÔ∏è");
            }




            function openInvoiceDraft() {

                if (!window.currentInvoiceDraft ||
                    window.currentInvoiceDraft.saleIds.length === 0) {
                    alert("Noch keine Verk√§ufe zur Rechnung hinzugef√ºgt.");
                    return;
                }

                const seller =
                    JSON.parse(localStorage.getItem("sellerProfile") || "{}");

                document.getElementById("invoiceSaleInfo").innerHTML = `
                    <b>üßæ Rechnung (Entwurf)</b><br>
                    Datum: ${new Date().toLocaleDateString()}<br>
                    Verk√§ufer: ${seller.name || "‚Äî"}<br>
                    <em>Rechnungsnummer wird beim Speichern vergeben</em>
                `;

                showPage("createInvoice");
                const search = document.getElementById("invoiceCustomerSearch");
                if (search) search.value = "";

                populateInvoiceCustomerDropdown();
                renderInvoiceDraftList();


            }





            function saveInvoice() {

                // --- Pr√ºfen ---
                if (
                    !window.currentInvoiceDraft ||
                    !Array.isArray(window.currentInvoiceDraft.saleDrafts) ||
                    window.currentInvoiceDraft.saleDrafts.length === 0
                ) {
                    alert("Keine Verk√§ufe auf der Rechnung.");
                    return;
                }

                // --- Verk√§ufer laden ---
                const seller = JSON.parse(localStorage.getItem("sellerProfile") || "{}");

                // --- Rechnungsnummer (Jahr + Z√§hler) ---
                const year = new Date().getFullYear();
                const key = "invoiceCounter_" + year;
                let counter = parseInt(localStorage.getItem(key), 10) || 1;

                const invoiceNumber = year + "-" + String(counter).padStart(3, "0");
                localStorage.setItem(key, String(counter + 1));

                // --- Rechnungspositionen ---
                const items = [];
                let baseAmount = 0; // Summe der Positionen (Ausgangspunkt!)

                window.currentInvoiceDraft.saleDrafts.forEach(draft => {

                    const lineTotal = draft.bottleCount * draft.pricePerBottle;
                    baseAmount += lineTotal;

                    items.push({
                        description: draft.labelText,
                        quantity: draft.bottleCount,
                        unitPrice: draft.pricePerBottle,
                        total: lineTotal
                    });
                });

                // ===== MwSt-Berechnung (JETZT erst!) =====
                const vatMode =
                    seller.vatMode === "gross" ? "gross" :
                        seller.vatMode === "net" ? "net" :
                            "none";

                const vatRate = typeof seller.vatRate === "number" ? seller.vatRate : 0;

                let netAmount = 0;
                let vatAmount = 0;
                let grossAmount = 0;

                if (vatMode === "none") {
                    netAmount = baseAmount;
                    grossAmount = baseAmount;
                    vatAmount = 0;
                }

                if (vatMode === "net") {
                    netAmount = baseAmount;
                    vatAmount = netAmount * vatRate;
                    grossAmount = netAmount + vatAmount;
                }

                if (vatMode === "gross") {
                    grossAmount = baseAmount;
                    netAmount = grossAmount / (1 + vatRate);
                    vatAmount = grossAmount - netAmount;
                }

                // --- Rechnung erzeugen ---
                const invoice = {
                    id: "invoice_" + Date.now(),
                    invoiceNumber,
                    createdAt: new Date().toISOString(),

                    status: "active",
                    cancelledAt: null,
                    cancelReason: "",

                    seller: {
                        ...seller,
                        vatMode,
                        vatRate
                    },

                    buyer: {
                        name: document.getElementById("invBuyerName").value,
                        street: document.getElementById("invBuyerStreet").value,
                        zip: document.getElementById("invBuyerZip").value,
                        city: document.getElementById("invBuyerCity").value,
                        country: document.getElementById("invBuyerCountry").value,
                        phone: document.getElementById("invBuyerPhone").value,
                        email: document.getElementById("invBuyerEmail").value
                    },

                    items,

                    netAmount,
                    vatAmount,
                    grossAmount,
                    totalAmount: grossAmount   // Zahlbetrag
                };

                // --- Rechnung speichern ---
                const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");
                invoices.push(invoice);
                localStorage.setItem("invoices", JSON.stringify(invoices));

                window.currentInvoice = invoice;

                // --- Verk√§ufe FINAL erzeugen ---
                const sales = JSON.parse(localStorage.getItem("sales") || "[]");

                window.currentInvoiceDraft.saleDrafts.forEach(draftSale => {
                    const sale = finalizeSale(draftSale);
                    if (sale) {
                        sale.invoiceId = invoice.id;
                        sales.push(sale);
                    }
                });

                localStorage.setItem("sales", JSON.stringify(sales));

                // --- Entw√ºrfe leeren ---
                window.currentInvoiceDraft = { saleDrafts: [] };
                window.currentSalesDraft = [];

                // --- UI aktualisieren ---
                renderSalesDraftCart();
                populateSellBottlingDropdown();

                alert("Rechnung " + invoiceNumber + " gespeichert ‚úîÔ∏è");

                // ‚úÖ PDF erzeugen
                createInvoicePDF(invoice);
            }



            let currentCustomerId = null;


            function saveCustomer() {

                const customers =
                    JSON.parse(localStorage.getItem("customers") || "[]");

                const customer = {
                    id: currentCustomerId || "cust_" + Date.now(),
                    name: document.getElementById("custName").value,
                    street: document.getElementById("custStreet").value,
                    zip: document.getElementById("custZip").value,
                    city: document.getElementById("custCity").value,
                    country: document.getElementById("custCountry").value,
                    phone: document.getElementById("custPhone").value,
                    email: document.getElementById("custEmail").value
                };

                if (!customer.name) {
                    alert("Name fehlt.");
                    return;
                }

                if (currentCustomerId) {
                    // üîÅ Update
                    const idx = customers.findIndex(c => c.id === currentCustomerId);
                    if (idx !== -1) customers[idx] = customer;
                } else {
                    // ‚ûï Neu
                    customers.push(customer);
                }

                localStorage.setItem("customers", JSON.stringify(customers));

                clearCustomerForm();
                renderCustomersList();
            }





            function clearCustomerForm() {
                currentCustomerId = null;
                ["custName", "custStreet", "custZip", "custCity", "custCountry", "custPhone", "custEmail"]
                    .forEach(id => document.getElementById(id).value = "");
            }




            function renderCustomersList(search = "") {

                const div = document.getElementById("customersList");
                const customers =
                    JSON.parse(localStorage.getItem("customers") || "[]");

                customers.sort((a, b) =>
                    (a.name || "").localeCompare(b.name || "", "de", { sensitivity: "base" })
                );


                const term = search.trim().toLowerCase();

                const filtered = customers.filter(c => {
                    if (!term) return true;
                    return (
                        c.name?.toLowerCase().includes(term) ||
                        c.city?.toLowerCase().includes(term) ||
                        c.email?.toLowerCase().includes(term)
                    );
                });

                if (!filtered.length) {
                    div.innerHTML = "<em>Keine passenden Kunden gefunden.</em>";
                    return;
                }

                let html = "";

                filtered.forEach(c => {
                    html += `
            <div style="
                display:flex;
                align-items:center;
                justify-content:space-between;
                border-bottom:1px solid #ddd;
                padding:6px 4px;
            ">
                <div style="flex:1;">
                    <strong>${c.name}</strong>
                    ${c.city ? `, ${c.city}` : ""}
                </div>

                <div style="display:flex; gap:6px;">
                    <button onclick="editCustomer('${c.id}')">‚úèÔ∏è</button>
                    <button onclick="deleteCustomer('${c.id}')">üóëÔ∏è</button>
                </div>
            </div>
        `;
                });

                div.innerHTML = html;
            }







            function editCustomer(id) {
                const customers =
                    JSON.parse(localStorage.getItem("customers") || "[]");

                const c = customers.find(c => c.id === id);
                if (!c) return;

                currentCustomerId = id;

                document.getElementById("custName").value = c.name || "";
                document.getElementById("custStreet").value = c.street || "";
                document.getElementById("custZip").value = c.zip || "";
                document.getElementById("custCity").value = c.city || "";
                document.getElementById("custCountry").value = c.country || "";
                document.getElementById("custPhone").value = c.phone || "";
                document.getElementById("custEmail").value = c.email || "";
                document.getElementById("custName").focus();

            }



            function deleteCustomer(id) {
                if (!confirm("Kunde wirklich l√∂schen?")) return;

                let customers =
                    JSON.parse(localStorage.getItem("customers") || "[]");

                customers = customers.filter(c => c.id !== id);
                localStorage.setItem("customers", JSON.stringify(customers));

                if (currentCustomerId === id) {
                    clearCustomerForm();
                }

                renderCustomersList();
            }










            function addDraftToCart() {

                if (!Array.isArray(window.currentSalesDraft)) {
                    window.currentSalesDraft = [];
                }

                const draft = buildSaleDraft();
                if (!draft) return;

                window.currentSalesDraft.push(draft);
                renderSalesDraftCart();
            }



            function finalizeCartWithInvoice() {

                if (!window.currentSalesDraft || window.currentSalesDraft.length === 0) {
                    alert("Warenkorb ist leer.");
                    return;
                }

                // üßæ neuen Rechnungs-Entwurf starten
                window.currentInvoiceDraft = {
                    saleDrafts: [...window.currentSalesDraft]   // Kopie!
                };

                // Warenkorb NICHT leeren ‚Äì erst nach Speichern der Rechnung
                showPage("createInvoice");


                populateInvoiceCustomerDropdown();
                renderInvoiceDraftList();
            }



            function populateVatYearSelect() {

                const sel = document.getElementById("vatYearSelect");
                if (!sel) return;

                const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");

                const years = [...new Set(
                    invoices.map(i => new Date(i.createdAt).getFullYear())
                )].sort();

                sel.innerHTML = "";

                years.forEach(y => {
                    const opt = document.createElement("option");
                    opt.value = y;
                    opt.textContent = y;
                    sel.appendChild(opt);
                });

                // aktuelles Jahr vorausw√§hlen
                sel.value = new Date().getFullYear();
            }



            function renderVatOverview() {

                const year = parseInt(document.getElementById("vatYearSelect").value, 10);
                const data = calculateVatOverviewByMonth(year);

                const body = document.getElementById("vatOverviewBody");
                const hint = document.getElementById("vatHint");

                body.innerHTML = "";
                hint.innerHTML = "";

                let yearNetto = 0;
                let yearVat = 0;
                let yearBrutto = 0;

                Object.keys(data)
                    .filter(k => k !== "_meta")
                    .sort()
                    .forEach(monthKey => {

                        let monthNetto = 0;
                        let monthVat = 0;
                        let monthBrutto = 0;

                        Object.entries(data[monthKey]).forEach(([rate, v]) => {

                            monthNetto += v.netto;
                            monthVat += v.vat;
                            monthBrutto += v.brutto;

                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td>${monthKey}</td>
                                <td>${(rate * 100).toFixed(0)} %</td>
                                <td align="right">${v.netto.toFixed(2)}</td>
                                <td align="right">${v.vat.toFixed(2)}</td>
                                <td align="right">${v.brutto.toFixed(2)}</td>
                            `;
                            body.appendChild(row);
                        });

                        // Monatssumme
                        const sumRow = document.createElement("tr");
                        sumRow.style.borderTop = "1px solid #ccc";
                        sumRow.innerHTML = `
                            <td><strong>${monthKey} Summe</strong></td>
                            <td></td>
                            <td align="right"><strong>${monthNetto.toFixed(2)}</strong></td>
                            <td align="right"><strong>${monthVat.toFixed(2)}</strong></td>
                            <td align="right"><strong>${monthBrutto.toFixed(2)}</strong></td>
                        `;
                        body.appendChild(sumRow);

                        yearNetto += monthNetto;
                        yearVat += monthVat;
                        yearBrutto += monthBrutto;
                    });

                // Jahressumme
                const yearRow = document.createElement("tr");
                yearRow.style.borderTop = "2px solid #000";
                yearRow.innerHTML = `
                    <td><strong>Jahr ${year}</strong></td>
                    <td></td>
                    <td align="right"><strong>${yearNetto.toFixed(2)}</strong></td>
                    <td align="right"><strong>${yearVat.toFixed(2)}</strong></td>
                    <td align="right"><strong>${yearBrutto.toFixed(2)}</strong></td>
                `;
                body.appendChild(yearRow);

                // Hinweis Kleinunternehmer
                if (data._meta?.hasVatFreeInvoices) {
                    hint.innerHTML =
                        "‚ÑπÔ∏è Hinweis: Im ausgew√§hlten Zeitraum wurden Ums√§tze ohne Umsatzsteuer erzielt (Kleinunternehmerregelung).";
                }
            }



            function exportVatToExcel() {

                const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");

                if (invoices.length === 0) {
                    alert("Keine Rechnungen f√ºr die Umsatzsteuer-Auswertung vorhanden.");
                    return;
                }

                const rows = [];

                invoices.forEach(inv => {

                    const seller = inv.seller || {};

                    // üîπ MwSt-Modus & Satz holen
                    let rate = parseFloat(seller.vatRate);
                    const mode = seller.vatMode || "none";

                    if (!isFinite(rate)) rate = 0;

                    // üëâ falls 19 statt 0.19 gespeichert
                    if (rate > 1) rate = rate / 100;

                    let net = 0;
                    let vat = 0;
                    let gross = 0;

                    if (mode === "net") {
                        // Preise sind netto
                        net = inv.totalAmount;
                        vat = net * rate;
                        gross = net + vat;

                    } else if (mode === "gross") {
                        // Preise sind brutto
                        gross = inv.totalAmount;
                        net = gross / (1 + rate);
                        vat = gross - net;

                    } else {
                        // Kleinunternehmer / keine MwSt
                        net = inv.totalAmount;
                        vat = 0;
                        gross = inv.totalAmount;
                    }

                    rows.push({
                        Datum: new Date(inv.createdAt).toLocaleDateString("de-DE"),
                        Rechnung: inv.invoiceNumber,
                        MwSt_Satz: (rate * 100).toFixed(0) + " %",
                        Netto: net.toFixed(2),
                        MwSt: vat.toFixed(2),
                        Brutto: gross.toFixed(2)
                    });
                });

                // üìä Excel erzeugen
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(rows);
                XLSX.utils.book_append_sheet(wb, ws, "Umsatzsteuer");

                const today = new Date()
                    .toLocaleDateString("de-DE")
                    .replace(/\./g, "-");

                XLSX.writeFile(wb, `Umsatzsteuer_${today}.xlsx`);

                alert("‚úÖ Umsatzsteuer-Excel wurde erstellt.");
            }



            function exportVatOverviewToExcel() {

                const yearSel = document.getElementById("vatYearSelect");
                const year = parseInt(yearSel?.value, 10) || new Date().getFullYear();

                const data = calculateVatOverviewByMonth(year);

                const rows = [];
                let yearNetto = 0, yearVat = 0, yearBrutto = 0;

                Object.keys(data)
                    .filter(k => k !== "_meta")
                    .sort()
                    .forEach(monthKey => {

                        let monthNetto = 0, monthVat = 0, monthBrutto = 0;

                        Object.entries(data[monthKey]).forEach(([rate, v]) => {

                            rows.push({
                                Monat: monthKey,
                                MwSt_Satz: rate * 100,      // üëà ZAHL
                                Netto: v.netto,             // üëà ZAHL
                                MwSt: v.vat,                // üëà ZAHL
                                Brutto: v.brutto            // üëà ZAHL
                            });

                            monthNetto += v.netto;
                            monthVat += v.vat;
                            monthBrutto += v.brutto;
                        });

                        rows.push({
                            Monat: monthKey + " Summe",
                            MwSt_Satz: "",
                            Netto: monthNetto,
                            MwSt: monthVat,
                            Brutto: monthBrutto
                        });

                        yearNetto += monthNetto;
                        yearVat += monthVat;
                        yearBrutto += monthBrutto;
                    });

                rows.push({
                    Monat: "Jahr " + year,
                    MwSt_Satz: "",
                    Netto: yearNetto,
                    MwSt: yearVat,
                    Brutto: yearBrutto
                });

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(rows);

                // üí° Spalten formatieren (optional, aber sehr sch√∂n)
                ws["!cols"] = [
                    { wch: 12 },
                    { wch: 10 },
                    { wch: 14 },
                    { wch: 14 },
                    { wch: 14 }
                ];

                XLSX.utils.book_append_sheet(wb, ws, "USt √úbersicht");

                const today = new Date().toLocaleDateString("de-DE").replace(/\./g, "-");
                XLSX.writeFile(wb, `Umsatzsteuer_${year}_${today}.xlsx`);

                alert("‚úÖ Umsatzsteuer-Excel wurde erstellt.");
            }



            function toggleMaterialList() {
                const box = document.getElementById("materialList");
                const icon = document.getElementById("materialToggleIcon");

                if (!box) return;

                const isHidden = box.style.display === "none";

                box.style.display = isHidden ? "block" : "none";
                if (icon) icon.textContent = isHidden ? "‚ñº" : "‚ñ∂";
            }





















            // -- Abf√ºllung speichern  ------------
            function saveBottling() {

                if (!window.lastBottlingPreview) {
                    alert("Bitte zuerst eine Abf√ºllung berechnen.");
                    return;
                }

                const b = window.lastBottlingPreview;



                const bottlings = JSON.parse(localStorage.getItem("bottlings") || "[]");

                // -------------------------------------------------
                // 1Ô∏è‚É£ Abf√ºllst√§rke ermitteln
                // -------------------------------------------------
                let finalStrength = null;

                // ü•É Wenn aus Fass ‚Üí immer Fassst√§rke berechnen
                if (b.sourceType === "cask" && b.sourceId) {

                    const casks = JSON.parse(localStorage.getItem("casks") || "[]");
                    const cask = casks.find(x => x.id === b.sourceId);

                    if (cask && Array.isArray(cask.fillHistory)) {

                        let vol = 0;
                        let AA = 0;

                        cask.fillHistory.forEach(e => {
                            if (typeof e.volume === "number") {
                                vol += e.volume;

                                // Falls AA gespeichert ‚Üí nehmen
                                if (typeof e.AA === "number") {
                                    AA += e.AA;
                                }
                                // sonst berechnen
                                else if (typeof e.strength === "number") {
                                    AA += e.volume * (e.strength / 100);
                                }
                            }
                        });

                        if (vol > 0) {
                            finalStrength = (AA / vol) * 100;
                        }
                    }
                }

                // üü¶ sonst normaler Lagerfall
                if (finalStrength == null) {
                    finalStrength =
                        typeof b.targetStrength === "number" ? b.targetStrength :
                            typeof b.baseStrength === "number" ? b.baseStrength :
                                typeof b.strength === "number" ? b.strength :
                                    null;
                }

                // Falls trotzdem nichts da ‚Äî als letzte Rettung 40%
                if (finalStrength == null || isNaN(finalStrength)) {
                    finalStrength = 40;
                }

                // -------------------------------------------------
                // Produktname korrekt bestimmen
                // -------------------------------------------------
                const products = JSON.parse(localStorage.getItem("products") || "[]");

                let realProductName = null;

                // 1Ô∏è‚É£ Wenn in Preview vorhanden ‚Üí immer nehmen
                if (b.productName && b.productName.trim() !== "") {
                    realProductName = b.productName.trim();
                } else {

                    // 2Ô∏è‚É£ sonst pr√ºfen, ob mehrere Produkte beteiligt sind
                    if (Array.isArray(b.productRefs) && b.productRefs.length > 0) {

                        const uniqueProdIds = [...new Set(
                            b.productRefs.map(r => r.productId)
                        )];

                        if (uniqueProdIds.length === 1) {
                            // EIN Produkt ‚Üí Namen aus Produktliste lesen
                            const products = JSON.parse(localStorage.getItem("products") || "[]");
                            const prod = products.find(p => p.id === uniqueProdIds[0]);
                            if (prod?.name) {
                                realProductName = prod.name;
                            }
                        } else {
                            // Mischfall ‚Üí Beh√§ltername verwenden
                            if (b.sourceName) realProductName = b.sourceName;
                        }
                    }
                }

                // 3Ô∏è‚É£ Wenn immer noch nichts ‚Üí minimaler Fallback
                if (!realProductName) {
                    realProductName = "Unbekanntes Produkt";
                }



                // -------------------------------------------------
                // 2Ô∏è‚É£ Bottling-Datensatz anlegen
                // -------------------------------------------------
                const newBottling = {
                    id: "bottling_" + Date.now(),
                    createdAt: new Date().toISOString(),

                    sourceStorageId: b.sourceStorageId,

                    baseStrength: b.baseStrength ?? null,
                    targetStrength: b.targetStrength ?? null,
                    strength: finalStrength,   // ‚ù§Ô∏è jetzt IMMER korrekt

                    bottleSize: b.bottleSize,
                    bottleCount: b.bottleCount,
                    filledVolume: b.filledVolume,

                    location: (document.getElementById("bottlingLocation")?.value || "").trim(),

                    liquidCostPerLiter: b.costPerLiterAdjusted || b.costPerLiter,
                    packagingCostPerBottle: b.packagingCostPerBottle,
                    minPricePerBottle: b.minPricePerBottle,

                    productId: b.productId || null,
                    productRefs: b.productRefs,

                    labelText: [
                        shortProductName(b.productName),
                        finalStrength.toFixed(1) + " % vol",
                        Math.round(b.bottleSize * 1000) + " ml"
                    ].filter(Boolean).join(" ¬∑ "),



                    remainingBottles: b.bottleCount
                };

                bottlings.push(newBottling);

                // -------------------------------------------------
                // 3Ô∏è‚É£ Lager oder Fass abbuchen
                // -------------------------------------------------

                if (b.sourceType === "cask") {

                    const casks = JSON.parse(localStorage.getItem("casks") || "[]");
                    const cask = casks.find(x => x.id === b.sourceId);

                    if (!cask) {
                        alert("‚ùå Fass (Cask) nicht gefunden.");
                        return;
                    }

                    // remainingVolume fallback
                    if (typeof cask.remainingVolume !== "number") {
                        cask.remainingVolume = (cask.fillHistory || [])
                            .filter(e => typeof e.volume === "number")
                            .reduce((sum, e) => sum + e.volume, 0);
                    }

                    if (cask.remainingVolume < b.filledVolume) {
                        alert("‚ùå Nicht genug Inhalt im Fass.");
                        return;
                    }

                    cask.remainingVolume -= b.filledVolume;

                    // Historieneintrag
                    cask.fillHistory.push({
                        id: "bottling_out_" + Date.now(),
                        date: new Date().toISOString().slice(0, 10),
                        type: "bottling_out",
                        volume: -b.filledVolume,
                        strength: finalStrength,
                        AA: -(b.filledVolume * finalStrength / 100),
                        recipeName: b.productName,
                        notes: "Abf√ºllung in Flaschen"
                    });

                    localStorage.setItem("casks", JSON.stringify(casks));

                    newBottling.productRefs = [{
                        productId: cask.batchId || cask.id,
                        volume: b.filledVolume
                    }];

                } else {

                    // Normaler Tank / Lager
                    const booking = consumeForBottling(
                        b.sourceId,
                        b.filledVolume
                    );

                    if (!booking.ok) {
                        alert("‚ùå Lagerabbuchung fehlgeschlagen: " + booking.msg);
                        return;
                    }

                    newBottling.productRefs = booking.productRefs;

                    if (typeof showStorageContents === "function") {

                        // üü¢ aktuelle Storage-ID ermitteln
                        let storageId = b.sourceId;

                        // Falls diese Variable genutzt wird ‚Üí bevorzugen
                        if (window.currentStorage && window.currentStorage.id) {
                            storageId = window.currentStorage.id;
                        }

                        const updated = JSON.parse(localStorage.getItem("storage_" + storageId));

                        // Nur wenn g√ºltig
                        if (updated && updated.id) {
                            showStorageContents(updated);
                        }
                    }

                }

                // -------------------------------------------------
                // 4Ô∏è‚É£ speichern
                // -------------------------------------------------
                localStorage.setItem("bottlings", JSON.stringify(bottlings));

                alert("‚úÖ Abf√ºllung gespeichert (" + newBottling.bottleCount + " Flaschen)");
            }




            function consumeForBottling(storageId, volumeOut) {
                // Lagerbeh√§lter laden
                const key = "storage_" + storageId;
                const s = JSON.parse(localStorage.getItem(key) || "null");

                if (!s || !Array.isArray(s.contents)) {
                    return { ok: false, msg: "Lagerbeh√§lter ung√ºltig." };
                }

                // 1Ô∏è‚É£ Aktuelle Mischung berechnen (Gesamtvolumen & St√§rke)
                if (typeof calcMixture !== "function") {
                    return { ok: false, msg: "calcMixture() nicht verf√ºgbar." };
                }

                const mix = calcMixture(s);   // erwartet dein vorhandenes calcMixture
                const totalVolume = mix.volume || 0;

                if (!totalVolume || totalVolume <= 0) {
                    return { ok: false, msg: "Im Beh√§lter ist kein Destillat mehr vorhanden." };
                }

                // Genug Volumen vorhanden?
                if (volumeOut > totalVolume + 1e-9) {
                    return {
                        ok: false,
                        msg: "Nicht genug Volumen im Lager. Verf√ºgbar: " +
                            totalVolume.toFixed(2) + " L"
                    };
                }

                // 2Ô∏è‚É£ Produkt-Referenzen √ºber alle positiven Inhalte aufsummieren
                const totalRefs = {};   // productId ‚Üí Volumen-Anteil im Beh√§lter (L)

                s.contents.forEach(item => {
                    const vol = Number(item.volume) || 0;
                    if (vol <= 0) return; // negative Zeilen (Abf√ºllungen/Rezept-Entnahmen) ignorieren

                    // Fall A: modernes Schema mit productRefs
                    if (item.productRefs && typeof item.productRefs === "object") {
                        for (const pid in item.productRefs) {
                            if (!Object.prototype.hasOwnProperty.call(item.productRefs, pid)) continue;
                            const v = Number(item.productRefs[pid]) || 0;
                            if (v > 0) {
                                totalRefs[pid] = (totalRefs[pid] || 0) + v;
                            }
                        }
                    }
                    // Fall B: altes Schema mit productId + volume
                    else if (item.productId) {
                        totalRefs[item.productId] =
                            (totalRefs[item.productId] || 0) + vol;
                    }
                });

                // 3Ô∏è‚É£ Anteil f√ºr diese Abf√ºllung bestimmen
                const factor = volumeOut / totalVolume; // z. B. 0.2 L / 10 L = 0.02

                const takenProductRefs = {};
                for (const pid in totalRefs) {
                    if (!Object.prototype.hasOwnProperty.call(totalRefs, pid)) continue;
                    const totalVolForProduct = Number(totalRefs[pid]) || 0;
                    if (totalVolForProduct <= 0) continue;

                    // proportionaler Anteil dieser Abf√ºllung
                    takenProductRefs[pid] = totalVolForProduct * factor;
                }

                // 4Ô∏è‚É£ Log-Eintrag f√ºr die Abf√ºllung erzeugen (negatives Volumen)
                const today = new Date().toISOString().slice(0, 10);

                s.contents.push({
                    id: "bottling_consume_" + Date.now(),
                    source: "Abf√ºllung (Flaschen)",
                    volume: -volumeOut,
                    strength: mix.strength,      // aktuelle Mischung im Beh√§lter
                    dateAdded: today,
                    productRefs: takenProductRefs
                });

                // 5Ô∏è‚É£ Lager speichern
                localStorage.setItem(key, JSON.stringify(s));

                // 6Ô∏è‚É£ R√ºckgabe f√ºr Gewinnanalyse / Rechnungen
                return {
                    ok: true,
                    takenVolume: volumeOut,
                    productRefs: takenProductRefs
                };
            }






            const invoiceGroupState = {};

            function renderInvoicesList() {

                const body = document.getElementById("invoicesTableBody");
                if (!body) return;

                const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");

                body.innerHTML = "";

                if (invoices.length === 0) {
                    body.innerHTML =
                        `<tr><td colspan="5"><em>Noch keine Rechnungen vorhanden.</em></td></tr>`;
                    return;
                }

                // nach Datum sortieren (neueste zuerst)
                invoices.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                let currentGroupKey = "";

                invoices.forEach(inv => {

                    const date = new Date(inv.createdAt);
                    const year = date.getFullYear();
                    const month = date.getMonth() + 1; // 1‚Äì12

                    const groupKey = `${year}-${month}`;
                    const groupLabel = date.toLocaleString("de-DE", {
                        month: "long",
                        year: "numeric"
                    });

                    // üîπ Gruppen-Zeile
                    if (groupKey !== currentGroupKey) {
                        currentGroupKey = groupKey;

                        // Standard: offen, wenn noch unbekannt
                        if (!(groupKey in invoiceGroupState)) {
                            invoiceGroupState[groupKey] = true;
                        }

                        const isOpen = invoiceGroupState[groupKey];

                        const groupRow = document.createElement("tr");
                        groupRow.style.cursor = "pointer";
                        groupRow.innerHTML = `
                <td colspan="5"
                    style="
                        background:#f2f2f2;
                        font-weight:bold;
                        padding:6px;
                        border-top:2px solid #ccc;
                    ">
                    ${isOpen ? "‚ñº" : "‚ñ∂"} ${groupLabel}
                </td>
            `;

                        groupRow.onclick = () => {
                            invoiceGroupState[groupKey] = !invoiceGroupState[groupKey];
                            renderInvoicesList(); // üîÅ neu rendern
                        };

                        body.appendChild(groupRow);
                    }

                    // üîπ Rechnungszeile (nur anzeigen, wenn Gruppe offen)
                    if (!invoiceGroupState[groupKey]) return;

                    const row = document.createElement("tr");
                    row.style.borderBottom = "1px solid #ddd";

                    row.innerHTML = `
            <td>
                ${inv.invoiceNumber}
                ${inv.status === "cancelled"
                            ? '<span style="color:red; font-weight:bold;"> (STORNIERT)</span>'
                            : ''}
            </td>

            <td>${date.toLocaleDateString()}</td>
            <td>${inv.buyer?.name || "‚Äî"}</td>
            <td align="right">${inv.totalAmount.toFixed(2)} ‚Ç¨</td>
            <td align="center">
                <button onclick="openInvoice('${inv.id}')">üëÅÔ∏è</button>
            </td>
        `;

                    body.appendChild(row);
                });
            }







            function downloadCurrentInvoicePDF() {
                if (!window.currentInvoice) {
                    alert("Keine Rechnung geladen.");
                    return;
                }

                createInvoicePDF(window.currentInvoice);
            }





            function openInvoice(invoiceId) {

                const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");
                const inv = invoices.find(i => i.id === invoiceId);
                if (!inv) return;

                let cancelledHtml = "";

                if (inv.status === "cancelled") {
                    cancelledHtml = `
                        <div style="
                            border: 2px solid red;
                            color: red;
                            padding: 10px;
                            margin-bottom: 12px;
                            font-weight: bold;
                        ">
                            ‚ö†Ô∏è RECHNUNG STORNIERT<br>
                            ${inv.cancelledAt ? "Datum: " + new Date(inv.cancelledAt).toLocaleString() + "<br>" : ""}
                            ${inv.cancelReason ? "Grund: " + inv.cancelReason : ""}
                        </div>
                    `;
                }


                // ‚≠ê wichtig f√ºr Drucken
                window.currentInvoice = inv;

                const seller = inv.seller || {};
                const buyer = inv.buyer || {};
                const gross = inv.totalAmount || 0;

                // -------------------------
                // Positionen
                // -------------------------
                let itemsHtml = "<ul>";
                inv.items.forEach(it => {
                    itemsHtml += `
                    <li>
                        ${it.description || it.labelText || "Unbenanntes Produkt"} ‚Äì
                        ${it.quantity} √ó ${it.unitPrice.toFixed(2)} ‚Ç¨
                        = ${it.total.toFixed(2)} ‚Ç¨
                    </li>
                `;
                });
                itemsHtml += "</ul>";

                // -------------------------
                // MwSt / Summen
                // -------------------------
                let totalsHtml = "";

                const vatMode = seller.vatMode;
                const vatRate = typeof seller.vatRate === "number" ? seller.vatRate : 0.19;

                // Kleinunternehmer
                if (vatMode === "none" || !vatMode) {

                    totalsHtml = `
                        <b>Gesamtbetrag:</b> ${gross.toFixed(2)} ‚Ç¨<br>
                        <em>Gem√§√ü ¬ß19 UStG wird keine Umsatzsteuer berechnet.</em>
                    `;

                }

                // Preise zzgl. MwSt (NETTO)
                else if (vatMode === "net") {

                    const vat = gross * vatRate;
                    const total = gross + vat;

                    totalsHtml = `
                        <b>Netto:</b> ${gross.toFixed(2)} ‚Ç¨<br>
                        <b>Umsatzsteuer (${(vatRate * 100).toFixed(0)} %):</b> ${vat.toFixed(2)} ‚Ç¨<br>
                        <b>Gesamtbetrag:</b> ${total.toFixed(2)} ‚Ç¨
                    `;

                }

                // Preise inkl. MwSt (BRUTTO)
                else if (vatMode === "gross") {

                    const net = gross / (1 + vatRate);
                    const vat = gross - net;

                    totalsHtml = `
                        <b>Netto:</b> ${net.toFixed(2)} ‚Ç¨<br>
                        <b>Umsatzsteuer (${(vatRate * 100).toFixed(0)} %):</b> ${vat.toFixed(2)} ‚Ç¨<br>
                        <b>Gesamtbetrag:</b> ${gross.toFixed(2)} ‚Ç¨
                    `;

                }


                // -------------------------
                // Anzeige
                // -------------------------
                document.getElementById("invoiceViewContent").innerHTML = `
                    ${cancelledHtml}
                    
                    <b>Rechnungsnummer:</b> ${inv.invoiceNumber}<br>
                    <b>Datum:</b> ${new Date(inv.createdAt).toLocaleDateString()}<br><br>

                    <b>Verk√§ufer:</b><br>
                    ${seller.name || ""}<br>
                    ${seller.street || ""}<br>
                    ${seller.zip || ""} ${seller.city || ""}<br>
                    ${seller.country || ""}<br><br>

                    <b>K√§ufer:</b><br>
                    ${buyer.name || ""}<br>
                    ${buyer.street || ""}<br>
                    ${buyer.zip || ""} ${buyer.city || ""}<br>
                    ${buyer.phone || ""}<br>
                    ${buyer.email || ""}<br>
                    ${buyer.country || ""}<br><br>

                    <b>Positionen:</b>
                    ${itemsHtml}

                    <br>
                    ${totalsHtml}
                `;

                showPage("invoiceView");
            }




            function renderInvoiceDraftList() {

                const box = document.getElementById("invoiceDraftList");
                if (!box) return;

                const draft = window.currentInvoiceDraft;

                if (!draft || !Array.isArray(draft.saleDrafts) || draft.saleDrafts.length === 0) {
                    box.innerHTML = "<em>Noch keine Positionen auf dieser Rechnung.</em>";
                    return;
                }

                let total = 0;
                let html = "<ul style='margin:0; padding-left:18px;'>";

                draft.saleDrafts.forEach(s => {
                    if (!s) return;

                    const lineTotal = s.bottleCount * s.pricePerBottle;
                    total += lineTotal;

                    html += `
            <li>
                ${s.labelText} ‚Äì
                ${s.bottleCount} √ó ${s.pricePerBottle.toFixed(2)} ‚Ç¨
                = ${lineTotal.toFixed(2)} ‚Ç¨
            </li>
        `;
                });

                html += `
        </ul>
        <strong>Gesamt: ${total.toFixed(2)} ‚Ç¨</strong>
    `;

                box.innerHTML = html;
            }



            function addSaleToInvoice(saleId) {

                // Falls noch kein Rechnungs-Entwurf existiert ‚Üí anlegen
                if (!window.currentInvoiceDraft) {
                    window.currentInvoiceDraft = { saleIds: [] };
                }

                // Doppelte Verk√§ufe verhindern
                if (window.currentInvoiceDraft.saleIds.includes(saleId)) {
                    alert("Dieser Verkauf ist bereits auf der Rechnung.");
                    return;
                }

                // Verkauf merken
                window.currentInvoiceDraft.saleIds.push(saleId);

                // Anzeige aktualisieren (falls Rechnungsseite offen)
                renderInvoiceDraftList();

                alert("Verkauf zur Rechnung hinzugef√ºgt ‚úîÔ∏è");
            }





            function saveSellerProfile() {

                const seller = {
                    name: document.getElementById("sellerName").value,
                    street: document.getElementById("sellerStreet").value,
                    zip: document.getElementById("sellerZip").value,
                    city: document.getElementById("sellerCity").value,
                    country: document.getElementById("sellerCountry").value,
                    vatId: document.getElementById("sellerVatId").value,
                    bank: document.getElementById("sellerBank").value,
                    vatMode: document.getElementById("sellerVatMode").value,
                    vatRate: (() => {
                        const v = parseFloat(document.getElementById("sellerVatRate").value);
                        return isNaN(v) ? 0.19 : v;
                    })()

                };

                localStorage.setItem("sellerProfile", JSON.stringify(seller));

                alert("Verk√§uferprofil gespeichert ‚úîÔ∏è");
            }




            function loadSellerProfile() {

                const seller =
                    JSON.parse(localStorage.getItem("sellerProfile") || "{}");

                document.getElementById("sellerName").value = seller.name || "";
                document.getElementById("sellerStreet").value = seller.street || "";
                document.getElementById("sellerZip").value = seller.zip || "";
                document.getElementById("sellerCity").value = seller.city || "";
                document.getElementById("sellerCountry").value = seller.country || "Deutschland";
                document.getElementById("sellerVatId").value = seller.vatId || "";
                document.getElementById("sellerBank").value = seller.bank || "";

                // ‚≠ê NEU ‚Äì Default: Kleinunternehmer
                document.getElementById("sellerVatMode").value = seller.vatMode || "none";
                document.getElementById("sellerVatRate").value =
                    typeof seller.vatRate === "number" ? seller.vatRate : 0.19;
            }



            function populateInvoiceCustomerDropdown() {

                const sel = document.getElementById("invoiceCustomerSelect");
                if (!sel) return;

                const customers =
                    JSON.parse(localStorage.getItem("customers") || "[]");

                // ‚≠ê Alphabetisch nach Name sortieren
                customers.sort((a, b) =>
                    (a.name || "").localeCompare(b.name || "", "de", { sensitivity: "base" })
                );

                // üîπ global merken f√ºr Filter
                window._invoiceCustomersCache = customers;

                sel.innerHTML = `<option value="">‚Äì Kunde ausw√§hlen ‚Äì</option>`;

                customers.forEach(c => {
                    const opt = document.createElement("option");
                    opt.value = c.id;
                    opt.textContent =
                        `${c.name} ‚Äì ${c.city || ""}`;
                    sel.appendChild(opt);
                });
            }





            function onInvoiceCustomerSelect() {

                const sel = document.getElementById("invoiceCustomerSelect");
                if (!sel || !sel.value) return;

                const customers =
                    JSON.parse(localStorage.getItem("customers") || "[]");

                const c = customers.find(x => x.id === sel.value);
                if (!c) return;

                document.getElementById("invBuyerName").value = c.name || "";
                document.getElementById("invBuyerStreet").value = c.street || "";
                document.getElementById("invBuyerZip").value = c.zip || "";
                document.getElementById("invBuyerCity").value = c.city || "";
                document.getElementById("invBuyerCountry").value = c.country || "";
                document.getElementById("invBuyerPhone").value = c.phone || "";
                document.getElementById("invBuyerEmail").value = c.email || "";
                if (sel) sel.size = 0;

            }



            function saveCustomerFromInvoice() {

                const name = document.getElementById("invBuyerName").value;
                if (!name) {
                    alert("Bitte mindestens einen Namen eingeben.");
                    return;
                }

                const customers =
                    JSON.parse(localStorage.getItem("customers") || "[]");

                const customer = {
                    id: "cust_" + Date.now(),
                    name,
                    street: document.getElementById("invBuyerStreet").value,
                    zip: document.getElementById("invBuyerZip").value,
                    city: document.getElementById("invBuyerCity").value,
                    country: document.getElementById("invBuyerCountry").value,
                    phone: document.getElementById("invBuyerPhone").value,
                    email: document.getElementById("invBuyerEmail").value
                };

                customers.push(customer);
                localStorage.setItem("customers", JSON.stringify(customers));

                alert("Kunde gespeichert ‚úîÔ∏è");

                // Dropdown neu aufbauen und ausw√§hlen
                populateInvoiceCustomerDropdown();

                const sel = document.getElementById("invoiceCustomerSelect");
                if (sel) sel.value = customer.id;
            }



            function filterInvoiceCustomers() {

                const searchInput = document.getElementById("invoiceCustomerSearch");
                const sel = document.getElementById("invoiceCustomerSelect");
                if (!sel || !searchInput) return;

                const search = searchInput.value.toLowerCase().trim();
                const customers = window._invoiceCustomersCache || [];

                sel.innerHTML = `<option value="">‚Äì Kunde ausw√§hlen ‚Äì</option>`;

                let matchCount = 0;

                customers.forEach(c => {

                    // üîç NUR Name + Ort durchsuchen (selbsterkl√§rend!)
                    const haystack =
                        `${c.name} ${c.city || ""}`.toLowerCase();

                    if (!haystack.includes(search)) return;

                    const opt = document.createElement("option");
                    opt.value = c.id;
                    opt.textContent = `${c.name} ‚Äì ${c.city || ""}`;
                    sel.appendChild(opt);
                    matchCount++;
                });

                // üîΩ Dropdown sichtbar machen, aber Fokus NICHT klauen
                if (matchCount > 0 && search.length > 0) {
                    sel.size = Math.min(matchCount + 1, 6);
                } else {
                    sel.size = 0;
                }
            }




            function renderInvoicePrint(invoice) {

                //const seller =
                //JSON.parse(localStorage.getItem("sellerProfile") || "{}");

                const seller = invoice.seller || {};
                const vatMode = seller.vatMode || "none";
                const vatRate = typeof seller.vatRate === "number" ? seller.vatRate : 0.19;

                const gross = invoice.totalAmount || 0;

                let net = gross;
                let vat = 0;
                let total = gross;
                let vatText = "";


                if (vatMode === "none") {

                    vatText = `
                        <em>Gem√§√ü ¬ß19 UStG wird keine Umsatzsteuer berechnet.</em>
                    `;

                }

                else if (vatMode === "net") {

                    vat = net * vatRate;
                    total = net + vat;

                    vatText = `
                        <tr>
                            <td colspan="3" align="right">Zwischensumme (Netto)</td>
                            <td align="right">${net.toFixed(2)} ‚Ç¨</td>
                        </tr>
                        <tr>
                            <td colspan="3" align="right">
                                Umsatzsteuer (${(vatRate * 100).toFixed(0)} %)
                            </td>
                            <td align="right">${vat.toFixed(2)} ‚Ç¨</td>
                        </tr>
                    `;

                }

                else if (vatMode === "gross") {

                    net = gross / (1 + vatRate);
                    vat = gross - net;
                    total = gross;

                    vatText = `
                        <tr>
                            <td colspan="3" align="right">Zwischensumme (Netto)</td>
                            <td align="right">${net.toFixed(2)} ‚Ç¨</td>
                        </tr>
                        <tr>
                            <td colspan="3" align="right">
                                Umsatzsteuer (${(vatRate * 100).toFixed(0)} %)
                            </td>
                            <td align="right">${vat.toFixed(2)} ‚Ç¨</td>
                        </tr>
                    `;

                }

                function cancelCurrentInvoice() {

                    if (!window.currentInvoice) {
                        alert("Keine Rechnung geladen.");
                        return;
                    }

                    if (window.currentInvoice.status === "cancelled") {
                        alert("Diese Rechnung ist bereits storniert.");
                        return;
                    }

                    if (!confirm("Rechnung wirklich stornieren?")) return;

                    const reason = prompt("Storno-Grund (optional):", "") || "";

                    // üî¥ Status setzen
                    window.currentInvoice.status = "cancelled";
                    window.currentInvoice.cancelledAt = new Date().toISOString();
                    window.currentInvoice.cancelReason = reason;

                    // üîÑ Flaschenbestand zur√ºckbuchen
                    const bottlings = JSON.parse(localStorage.getItem("bottlings") || "[]");

                    // üîÑ Zugeh√∂rige Verk√§ufe wirtschaftlich stornieren
                    const sales = JSON.parse(localStorage.getItem("sales") || "[]");

                    sales.forEach(s => {
                        if (s.invoiceId === window.currentInvoice.id && !s.cancelled) {
                            s.cancelled = true;
                            s.cancelledAt = new Date().toISOString();
                        }
                    });

                    localStorage.setItem("sales", JSON.stringify(sales));



                    window.currentInvoice.items.forEach(item => {
                        const bottling = bottlings.find(b => b.labelText === item.description);
                        if (bottling) {
                            bottling.remainingBottles += item.quantity;
                        }
                    });

                    localStorage.setItem("bottlings", JSON.stringify(bottlings));




                    // üíæ Rechnungen speichern
                    const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");
                    const idx = invoices.findIndex(i => i.id === window.currentInvoice.id);
                    if (idx !== -1) {
                        invoices[idx] = window.currentInvoice;
                        localStorage.setItem("invoices", JSON.stringify(invoices));
                    }

                    alert("Rechnung wurde storniert.");

                    openInvoice(window.currentInvoice.id);

                }





                const invoiceNumber =
                    invoice.invoiceNumber ||
                    invoice.number ||
                    "(ohne Nummer)";

                const invoiceDate =
                    invoice.createdAt
                        ? new Date(invoice.createdAt).toLocaleDateString()
                        : new Date().toLocaleDateString();

                document.getElementById("invoicePrintHeader").innerHTML = `
                    <strong>${seller.name || ""}</strong><br>
                    ${seller.street || seller.address || ""}<br>
                    ${(seller.zip || "")} ${(seller.city || "")}<br>
                    ${seller.country || ""}<br><br>

                    <strong>Rechnung Nr.:</strong> ${invoiceNumber}<br>
                    <strong>Datum:</strong> ${invoiceDate}
                `;


                // K√§ufer
                document.getElementById("invoicePrintBuyer").innerHTML = `
                    <strong>Rechnung an:</strong><br>
                    ${invoice.buyer.name}<br>
                    ${invoice.buyer.street}<br>
                    ${invoice.buyer.zip} ${invoice.buyer.city}<br>
                    ${invoice.buyer.country}
                `;

                // Positionen
                const body = document.getElementById("invoicePrintItems");
                body.innerHTML = "";

                invoice.items.forEach(i => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${i.description || i.labelText || "Unbenanntes Produkt"}</td>
                        <td align="right">${i.quantity}</td>
                        <td align="right">${i.unitPrice.toFixed(2)} ‚Ç¨</td>
                        <td align="right">${i.total.toFixed(2)} ‚Ç¨</td>
                    `;
                    body.appendChild(row);
                });

                // Summen
                document.getElementById("invoicePrintTotals").innerHTML = `
                    ${vatText}
                    <tr>
                        <td colspan="3" align="right"><strong>Gesamtbetrag</strong></td>
                        <td align="right"><strong>${total.toFixed(2)} ‚Ç¨</strong></td>
                    </tr>
                `;


            }

            function cancelCurrentInvoice() {

                if (!window.currentInvoice) {
                    alert("Keine Rechnung geladen.");
                    return;
                }

                if (window.currentInvoice.status === "cancelled") {
                    alert("Diese Rechnung ist bereits storniert.");
                    return;
                }

                if (!confirm("Rechnung wirklich stornieren?")) return;

                const reason = prompt("Storno-Grund (optional):", "") || "";

                // üî¥ Status setzen
                window.currentInvoice.status = "cancelled";
                window.currentInvoice.cancelledAt = new Date().toISOString();
                window.currentInvoice.cancelReason = reason;

                // üîÑ Flaschenbestand zur√ºckbuchen
                const bottlings = JSON.parse(localStorage.getItem("bottlings") || "[]");

                window.currentInvoice.items.forEach(item => {
                    const bottling = bottlings.find(b => b.labelText === item.description);
                    if (bottling) {
                        bottling.remainingBottles += item.quantity;
                    }
                });

                localStorage.setItem("bottlings", JSON.stringify(bottlings));

                // üíæ Rechnungen speichern
                const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");
                const idx = invoices.findIndex(i => i.id === window.currentInvoice.id);
                if (idx !== -1) {
                    invoices[idx] = window.currentInvoice;
                    localStorage.setItem("invoices", JSON.stringify(invoices));
                }

                // üîÑ Zugeh√∂rige Verk√§ufe wirtschaftlich stornieren
                const sales = JSON.parse(localStorage.getItem("sales") || "[]");

                let affected = 0;

                sales.forEach(s => {
                    if (String(s.invoiceId) === String(window.currentInvoice.id)) {
                        s.cancelled = true;
                        s.cancelledAt = new Date().toISOString();
                        affected++;
                    }
                });

                localStorage.setItem("sales", JSON.stringify(sales));

                console.log("Stornierte Sales:", affected);

                // üîÑ UI aktualisieren
                renderSalesList();

                alert("Rechnung wurde storniert.");

                // Anzeige neu laden
                openInvoice(window.currentInvoice.id);

            }




            function printCurrentInvoice() {

                let invoice = window.currentInvoice;

                // üîπ Wenn noch nicht gespeichert ‚Üí Entwurf verwenden
                if (!invoice) {
                    invoice = buildInvoiceFromDraft();
                }

                if (!invoice) {
                    alert("Keine Rechnung zum Drucken vorhanden.");
                    return;
                }

                renderInvoicePrint(invoice);
                showPage("invoicePrint");
                window.onafterprint = () => {
                    showPage("invoiceView"); // ‚¨ÖÔ∏è ZUR√úCK
                };
                window.print();


            }




            function buildInvoiceFromDraft() {

                if (!window.currentInvoiceDraft ||
                    window.currentInvoiceDraft.saleIds.length === 0) {
                    return null;
                }

                const sales = JSON.parse(localStorage.getItem("sales") || "[]");
                const seller = JSON.parse(localStorage.getItem("sellerProfile") || "{}");

                // K√§uferdaten aus dem Formular
                const buyer = {
                    name: document.getElementById("invBuyerName")?.value || "",
                    street: document.getElementById("invBuyerStreet")?.value || "",
                    zip: document.getElementById("invBuyerZip")?.value || "",
                    city: document.getElementById("invBuyerCity")?.value || "",
                    country: document.getElementById("invBuyerCountry")?.value || "",
                    phone: document.getElementById("invBuyerPhone")?.value || "",
                    email: document.getElementById("invBuyerEmail")?.value || ""
                };

                let items = [];
                let totalAmount = 0;

                window.currentInvoiceDraft.saleIds.forEach(id => {
                    const s = sales.find(x => x.id === id);
                    if (!s) return;

                    const lineTotal = s.bottleCount * s.pricePerBottle;
                    totalAmount += lineTotal;

                    const description =
                        s.labelText ||
                        `${(s.bottleSize * 1000).toFixed(0)} ml ¬∑ ${s.strength || s.targetStrength || "?"}%`;

                    items.push({
                        description,
                        quantity: s.bottleCount,
                        unitPrice: s.pricePerBottle,
                        total: lineTotal
                    });
                });

                // Entwurf-Rechnung (ohne Nummer)
                return {
                    id: "invoiceDraft_" + Date.now(),
                    invoiceNumber: "(Entwurf)",
                    createdAt: new Date().toISOString(),
                    seller,
                    buyer,
                    items,
                    totalAmount
                };
            }



            function finalizeCartWithoutInvoice() {

                if (!window.currentSalesDraft || window.currentSalesDraft.length === 0) {
                    alert("Warenkorb ist leer.");
                    return;
                }

                // alle Verk√§ufe sofort finalisieren
                window.currentSalesDraft.forEach(draft => {
                    finalizeSale({
                        ...draft,
                        invoiceId: null   // wichtig: kein Rechnungseintrag
                    });
                });

                // Warenkorb leeren
                window.currentSalesDraft = [];
                renderSalesDraftCart();

                alert("Verkauf abgeschlossen ‚úîÔ∏è");
            }






            function renderSalesDraftCart() {

                const body = document.getElementById("salesDraftCartBody");
                if (!body) return;

                body.innerHTML = "";

                if (!window.currentSalesDraft.length) {
                    body.innerHTML = `
                    <tr>
                        <td colspan="7"><em>Warenkorb ist leer.</em></td>
                    </tr>
                `;
                    return;
                }

                window.currentSalesDraft.forEach((s, index) => {

                    // Umsatz & Gewinn neu berechnen

                    // Umsatz
                    s.revenue = s.bottleCount * s.pricePerBottle;

                    // interne Kosten IMMER passend zur Menge neu
                    const cpl = (typeof s.internalCostPerBottle === "number")
                        ? s.internalCostPerBottle
                        : (s.bottleCount > 0 ? (s.internalCost / s.bottleCount) : 0);

                    s.internalCostPerBottle = cpl;
                    s.internalCost = s.bottleCount * cpl;

                    // üîπ EXTRA: Zusatzkosten absichern
                    s.extraCosts = (typeof s.extraCosts === "number") ? s.extraCosts : 0;

                    // Gewinn
                    s.profit = s.revenue - (s.internalCost + s.extraCosts);




                    const row = document.createElement("tr");
                    row.style.borderBottom = "1px solid #ddd";

                    row.innerHTML = `
                        <td>${s.labelText}</td>
                        <td>${s.location || "‚Äî"}</td>

                        <td align="center">
                            <input type="number" min="1" step="1"
                                value="${s.bottleCount}"
                                style="width:60px"
                                onchange="updateDraftCount(${index}, this.value)">
                        </td>

                        <td align="right">
                            <input type="number" step="0.01"
                                value="${s.pricePerBottle.toFixed(2)}"
                                style="width:80px"
                                onchange="updateDraftPrice(${index}, this.value)">
                        </td>

                        <td align="right">
                            ${s.revenue.toFixed(2)} ‚Ç¨
                        </td>

                        <td align="right" style="color:${s.profit >= 0 ? "green" : "red"}">
                            ${s.profit.toFixed(2)} ‚Ç¨
                        </td>

                        <td align="center">
                            <button onclick="removeDraftItem(${index})">‚ùå</button>
                        </td>
                    `;

                    body.appendChild(row);
                });
            }




            function updateDraftCount(index, value) {
                const count = parseInt(value, 10);
                if (!count || count <= 0) return;

                window.currentSalesDraft[index].bottleCount = count;
                renderSalesDraftCart();
            }




            function updateDraftPrice(index, value) {
                const price = parseFloat(value);
                if (isNaN(price) || price < 0) return;

                window.currentSalesDraft[index].pricePerBottle = price;
                renderSalesDraftCart();
            }




            function removeDraftItem(index) {
                window.currentSalesDraft.splice(index, 1);
                renderSalesDraftCart();
            }



            function calcVatFromGross(gross, rate) {
                const net = gross / (1 + rate);
                const vat = gross - net;
                return {
                    net,
                    vat,
                    gross
                };
            }


            function calculateInvoiceVat(invoice) {

                const vatMode = invoice.seller?.vatMode || "none";
                const vatRate = parseFloat(invoice.seller?.vatRate) || 0;

                let netto = 0;
                let vat = 0;
                let brutto = 0;

                if (vatMode === "net") {
                    netto = invoice.totalAmount;
                    vat = netto * vatRate;
                    brutto = netto + vat;
                }
                else if (vatMode === "gross") {
                    brutto = invoice.totalAmount;
                    netto = brutto / (1 + vatRate);
                    vat = brutto - netto;
                }
                else {
                    netto = invoice.totalAmount;
                    brutto = invoice.totalAmount;
                    vat = 0;
                }

                return {
                    netto,
                    vat,
                    brutto
                };
            }




            function calculateVatForMonth(year, month) {

                const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");

                const result = {
                    netto: 0,
                    vat: 0,
                    brutto: 0,
                    count: 0
                };

                invoices.forEach(inv => {
                    const d = new Date(inv.createdAt);

                    if (d.getFullYear() !== year) return;
                    if (d.getMonth() !== month) return;

                    const r = calculateInvoiceVat(inv);

                    result.netto += r.netto;
                    result.vat += r.vat;
                    result.brutto += r.brutto;
                    result.count++;
                });

                return result;
            }




            function calculateVatOverviewByMonth(year) {

                const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");

                const result = {};
                let hasVatFreeInvoices = false;

                invoices
                    .filter(inv => inv.status !== "cancelled")
                    .forEach(inv => {


                        const d = new Date(inv.createdAt);
                        if (d.getFullYear() !== year) return;

                        const seller = inv.seller || {};
                        const vatMode = seller.vatMode || "none";
                        const vatRate = typeof seller.vatRate === "number" ? seller.vatRate : null;

                        // üîπ Kleinunternehmer ‚Üí nur merken, nicht rechnen
                        if (vatMode === "none") {
                            hasVatFreeInvoices = true;
                            return;
                        }

                        if (!vatRate) return;

                        const monthKey =
                            d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0");

                        if (!result[monthKey]) {
                            result[monthKey] = {};
                        }

                        if (!result[monthKey][vatRate]) {
                            result[monthKey][vatRate] = {
                                netto: 0,
                                vat: 0,
                                brutto: 0
                            };
                        }

                        let netto = 0;
                        let vat = 0;
                        let brutto = 0;

                        // Preise zzgl. MwSt (NETTO)
                        if (vatMode === "net") {
                            netto = inv.totalAmount;
                            vat = netto * vatRate;
                            brutto = netto + vat;
                        }

                        // Preise inkl. MwSt (BRUTTO)
                        else if (vatMode === "gross") {
                            brutto = inv.totalAmount;
                            netto = brutto / (1 + vatRate);
                            vat = brutto - netto;
                        }

                        result[monthKey][vatRate].netto += netto;
                        result[monthKey][vatRate].vat += vat;
                        result[monthKey][vatRate].brutto += brutto;
                    });

                result._meta = {
                    hasVatFreeInvoices
                };

                return result;
            }


























            // üîç Ermittelt Frucht / Destillat-Typ aus einem Beh√§lter
            function detectDistillateType(storage) {
                if (!storage || typeof storage !== "object") return "Unbekannt";

                // 1) Direkt am Beh√§lter hinterlegte Frucht
                if (storage.fruit) return storage.fruit;

                // 2) Archiv-spezifisches Feld (falls vorhanden)
                if (storage.archiveFruit) return storage.archiveFruit;

                // 3) In den Inhalten nachsehen (z.B. aus Archiv √ºbernommen)
                if (Array.isArray(storage.contents) && storage.contents.length > 0) {
                    const withFruit = storage.contents.find(c => c && c.fruit);
                    if (withFruit && withFruit.fruit) return withFruit.fruit;
                }

                // 4) Fallback: Produktname
                if (storage.product) return storage.product;

                // 5) Zur Not Beh√§ltername
                if (storage.name) return storage.name;

                return "Unbekannt";
            }




            function transferVolume() {

                const sourceId = document.getElementById("storageSelect").value;
                const targetId = document.getElementById("transferTarget").value;
                const vol = parseFloat(document.getElementById("transferVolume").value);

                // ---------------------------------------------------------
                // BASIC CHECKS
                // ---------------------------------------------------------

                if (!sourceId || !targetId) {
                    alert("Bitte Quelle und Ziel w√§hlen!");
                    return;
                }
                if (sourceId === targetId) {
                    alert("Quelle und Ziel d√ºrfen nicht identisch sein.");
                    return;
                }
                if (isNaN(vol) || vol <= 0) {
                    alert("Bitte g√ºltige Menge eingeben!");
                    return;
                }

                const sourceKey = "storage_" + sourceId;
                const targetKey = "storage_" + targetId;

                const source = JSON.parse(localStorage.getItem(sourceKey) || "null");
                const target = JSON.parse(localStorage.getItem(targetKey) || "null");

                if (!source || !target) {
                    alert("Fehler: Beh√§lterdaten konnten nicht geladen werden.");
                    return;
                }
                if (!Array.isArray(source.contents) || source.contents.length === 0) {
                    alert("Der Quellbeh√§lter ist leer.");
                    return;
                }

                // ---------------------------------------------------------
                // 1Ô∏è‚É£ Gesamtvolumen pr√ºfen
                // ---------------------------------------------------------
                const mixSource = calcMixture(source);
                if (vol > mixSource.volume + 0.0001) {
                    alert("‚ùå Nicht genug Volumen in der Quelle!");
                    return;
                }
                if (mixSource.volume <= 0) {
                    alert("Quelle hat kein sinnvolles Volumen.");
                    return;
                }

                // ---------------------------------------------------------
                // 2Ô∏è‚É£ Fr√ºchte in Quelle & Ziel analysieren
                // ---------------------------------------------------------
                function collectFruitsFromStorage(st) {
                    const set = new Set();
                    if (!st || !Array.isArray(st.contents)) return set;

                    st.contents.forEach(c => {

                        // üëâ fruitData ist K√∂nig
                        if (c.fruitData && typeof c.fruitData === "object") {
                            Object.keys(c.fruitData).forEach(f => {
                                let name = (f || "").replace(/\([^)]*\)/g, "").trim();
                                if (name) set.add(name);
                            });
                        }

                        // üëâ Falls keine fruitData ‚Üí Textfeld "fruit"
                        const label = (c.fruit || "").trim();
                        if (!label) return;

                        if (label.includes("%")) {
                            label.split(",").forEach(part => {
                                const m = part.trim().match(/^(.+?)\s+([\d.,]+)%$/);
                                if (!m) return;

                                let name = m[1].trim();
                                name = name.replace(/\([^)]*\)/g, "").trim();
                                if (name) set.add(name);
                            });
                        } else {
                            let name = label.replace(/\([^)]*\)/g, "").trim();
                            if (name) set.add(name);
                        }
                    });

                    return set;
                }

                const sourceFruits = collectFruitsFromStorage(source);
                const targetFruits = collectFruitsFromStorage(target);

                // ---------------------------------------------------------
                // 3Ô∏è‚É£ Mischwarnung
                // ---------------------------------------------------------
                if (targetFruits.size > 0 && sourceFruits.size > 0) {
                    let mismatch = false;

                    for (let f of sourceFruits) {
                        if (!targetFruits.has(f)) mismatch = true;
                    }

                    if (mismatch) {
                        const ok = confirm(
                            `‚ö†Ô∏è Unterschiedliche Destillate erkannt!\n\n` +
                            `Quelle: ${Array.from(sourceFruits).join(", ") || "‚Äì"}\n` +
                            `Ziel:   ${Array.from(targetFruits).join(", ") || "‚Äì"}\n\n` +
                            `Trotzdem mischen? (z. B. f√ºr Obstler)`
                        );
                        if (!ok) return;
                    }
                }

                // ---------------------------------------------------------
                // 4Ô∏è‚É£ Kapazit√§tspr√ºfung
                // ---------------------------------------------------------
                const mixTarget = calcMixture(target);
                const cap = parseFloat(target.capacity) || 0;
                const newVolTarget = mixTarget.volume + vol;

                if (cap > 0 && newVolTarget > cap + 0.0001) {
                    alert(
                        `‚ùå Der Zielbeh√§lter ist zu klein!\n\n` +
                        `Kapazit√§t: ${cap} L\n` +
                        `Aktuell: ${mixTarget.volume.toFixed(1)} L\n` +
                        `Umsch√ºttung: ${vol.toFixed(1)} L\n\n` +
                        `‚Üí Gesamt: ${newVolTarget.toFixed(1)} L (ZU VIEL!)`
                    );
                    return;
                }

                if (cap > 0 && newVolTarget > cap * 0.9) {
                    const ok = confirm(
                        `‚ö†Ô∏è Der Beh√§lter w√§re zu ${(newVolTarget / cap * 100).toFixed(0)} % gef√ºllt.\n` +
                        `Trotzdem fortfahren?`
                    );
                    if (!ok) return;
                }

                // ---------------------------------------------------------
                // 5Ô∏è‚É£ Verh√§ltnisse berechnen
                // ---------------------------------------------------------
                const takeRatio = vol / mixSource.volume;
                const todayStr = new Date().toISOString().split("T")[0];

                if (!Array.isArray(target.contents)) target.contents = [];

                const movedSummary = [];

                // F√ºr Produkt-Kosten & Fruchtanteile
                const products = JSON.parse(localStorage.getItem("products") || "[]");

                // ---------------------------------------------------------
                // 6Ô∏è‚É£ Quelle iterieren und jeden Eintrag anteilig verschieben
                // ---------------------------------------------------------
                source.contents.forEach(c => {

                    const origVol = parseFloat(c.volume) || 0;
                    if (origVol <= 0) return;

                    const take = origVol * takeRatio;
                    const remain = origVol - take;

                    // =====================================================
                    // EINTRAG ‚Üí ZIELBEH√ÑLTER
                    // =====================================================
                    // üëâ Teil in den Zielbeh√§lter verschieben
                    if (take > 0.0001) {

                        // Deep Copy
                        const clone = JSON.parse(JSON.stringify(c));

                        clone.id = "item_" + Date.now() + "_" + Math.random().toString(36).slice(2, 8);
                        clone.volume = take;

                        // -------------------------------
                        // üß† Fruchtinformationen erzeugen
                        // -------------------------------

                        // 1) FR√úCHTE AUS fruitData
                        let fruitLabel = "";

                        if (clone.fruitData && typeof clone.fruitData === "object") {

                            const fd = clone.fruitData;
                            const totalFD = Object.values(fd).reduce((a, b) => a + b, 0);

                            if (totalFD > 0) {
                                fruitLabel = Object.entries(fd)
                                    .map(([name, liters]) => {
                                        const pct = (liters / totalFD) * 100;
                                        // Klammern entfernen, z.B. (3,6)
                                        name = name.replace(/\([^)]*\)/g, "").trim();
                                        return `${name} ${pct.toFixed(1)}%`;
                                    })
                                    .join(", ");
                            }
                        }

                        // 2) Falls kein fruitData: fallback auf c.fruit
                        if (!fruitLabel && clone.fruit) {
                            fruitLabel = clone.fruit.replace(/\([^)]*\)/g, "").trim();
                        }

                        // 3) Falls immer noch leer ‚Üí Unbekannt
                        if (!fruitLabel) {
                            fruitLabel = "Unbekannt";
                        }

                        clone.fruit = fruitLabel;

                        // -------------------------------
                        // üß† St√§rken & andere Felder
                        // -------------------------------
                        if (clone.fruitData) {
                            // fruitData korrekt skalieren
                            Object.keys(clone.fruitData).forEach(f => {
                                const fv = parseFloat(clone.fruitData[f]) || 0;
                                const scaled = fv * (take / origVol);
                                clone.fruitData[f] = scaled;
                            });
                        }

                        clone.dateAdded = todayStr;

                        clone.source = (c.source
                            ? `Umsch√ºttung von ${source.name} (${c.source})`
                            : `Umsch√ºttung von ${source.name}`);

                        target.contents.push(clone);
                    }


                    // =====================================================
                    // REST IM QUELLBEH√ÑLTER SKALIEREN
                    // =====================================================
                    if (remain <= 0.0001) {
                        c._deleteMe = true;
                    } else {
                        c.volume = remain;

                        if (c.fruitData && typeof c.fruitData === "object") {
                            Object.keys(c.fruitData).forEach(f => {
                                const fv = parseFloat(c.fruitData[f]) || 0;
                                c.fruitData[f] = fv * (remain / origVol);
                            });
                        }
                    }
                });

                // ---------------------------------------------------------
                // 7Ô∏è‚É£ Leere Quell-Eintr√§ge entfernen
                // ---------------------------------------------------------
                source.contents = source.contents.filter(c =>
                    !c._deleteMe && ((parseFloat(c.volume) || 0) > 0.0001)
                );

                // ---------------------------------------------------------
                // 8Ô∏è‚É£ speichern & UI aktualisieren
                // ---------------------------------------------------------
                localStorage.setItem(sourceKey, JSON.stringify(source));
                localStorage.setItem(targetKey, JSON.stringify(target));

                let msg =
                    `‚úÖ ${vol.toFixed(2)} L von ‚Äû${source.name}‚Äú nach ‚Äû${target.name}‚Äú umgesch√ºttet.`;

                if (movedSummary.length > 0) {
                    msg += "\n\nAufgeteilt nach Eintr√§gen:\n";
                    movedSummary.forEach(m => {
                        msg += `‚Ä¢ ${m.fruit || "Mischung"}: ${m.volume.toFixed(2)} L\n`;
                    });
                }

                alert(msg);

                loadStorageDetails(sourceId);
                loadStorageDetails(targetId);
                if (typeof updateStorageDropdown === "function") updateStorageDropdown();
                if (typeof updateTransferTargetList === "function") updateTransferTargetList(sourceId);
                if (typeof updateSaleDropdown === "function") updateSaleDropdown();
            }








            //Wenn verschiedene Destillate eingesch√ºttet wurden
            //wird der prozentuale Anteil berechnet
            function calcTypeBreakdown(storage) {
                if (!storage || !storage.contents || storage.contents.length === 0)
                    return [];

                const groups = {};

                storage.contents.forEach(item => {
                    // üîç Fruchttyp bestimmen (sauberste Reihenfolge)
                    const type =
                        item.fruit ||
                        (item.archiveSource ? item.archiveSource.replace("archive_", "") : null) ||
                        item.source?.replace(/^Umsch√ºttung.*? /, "") ||  // Umsch√ºttung-Texte entfernen
                        item.name ||
                        "Unbekannt";

                    const vol = parseFloat(item.volume) || 0;

                    if (!groups[type]) {
                        groups[type] = { volume: 0 };
                    }
                    groups[type].volume += vol;
                });

                // Gesamtvolumen bestimmen
                const totalVol = Object.values(groups)
                    .reduce((sum, g) => sum + g.volume, 0);

                // Prozentwerte berechnen
                return Object.entries(groups).map(([type, data]) => ({
                    type,
                    volume: data.volume,
                    percent: totalVol > 0 ? (data.volume / totalVol * 100) : 0
                }));
            }





            // üß™ F√ºgt ein archiviertes Destillat in einen Lagerbeh√§lter ein
            function addDistillate(archiveName, targetStorageId, volume) {

                if (!archiveName || !targetStorageId || !volume) {
                    alert("Fehlende Angaben zum Hinzuf√ºgen des Destillats!");
                    return;
                }

                // üîπ Archiv und Beh√§lter laden
                const archive = JSON.parse(localStorage.getItem("archive_" + archiveName) || "null");
                const storage = JSON.parse(localStorage.getItem("storage_" + targetStorageId) || "null");

                if (!archive) {
                    alert("Archiviertes Destillat nicht gefunden!");
                    return;
                }
                if (!storage) {
                    alert("Beh√§lter nicht gefunden!");
                    return;
                }

                const vol = parseFloat(volume);
                const strength = parseFloat(archive.actualStrength) || 0;

                // üî• NEU: fruitData korrekt erzeugen (Basis f√ºr Mischungen!)
                const fruitData = {};
                const fruitName = archive.fruit || "Unbekannt";
                fruitData[fruitName] = vol;  // exakt diese Menge des Destillats

                // üî• Eintrag f√ºr Beh√§lter
                const entry = {
                    source: archiveName,
                    volume: vol,
                    strength: strength,
                    fruitData: fruitData, // NEU & WICHTIG
                    dateAdded: new Date().toISOString().split("T")[0]
                };

                // üîπ An Beh√§lter anh√§ngen
                if (!Array.isArray(storage.contents)) storage.contents = [];
                storage.contents.push(entry);

                // üîπ speichern
                localStorage.setItem("storage_" + targetStorageId, JSON.stringify(storage));

                alert(`‚úÖ ${vol} L "${archiveName}" wurden in ${storage.name} eingef√ºllt.`);

                // üîÑ Beh√§lteranzeige aktualisieren
                if (typeof loadStorageDetails === "function") {
                    loadStorageDetails(targetStorageId);
                }
            }






            // Fenster "Destillat hinzuf√ºgen" √∂ffnen und Dropdown bef√ºllen
            function openAddDistillateModal() {
                updateArchiveDropdown();  // üîπ bef√ºllt das Dropdown mit archivierten Destillaten
                // ‚≠ê Automatisches Vorausf√ºllen aktivieren
                setTimeout(() => {
                    const sel = document.getElementById("archiveSelect");
                    if (sel) sel.addEventListener("change", autoFillArchiveValues);
                }, 50);
                document.getElementById("addDistillateModal").style.display = "block";
                document.getElementById("modalOverlay").style.display = "block";
            }


            function confirmAddDistillate() {

                const archiveSelect = document.getElementById("archiveSelect");
                const volumeInput = document.getElementById("addVolume");
                const strengthInput = document.getElementById("addStrength");
                const storageId = document.getElementById("storageSelect").value;

                if (!archiveSelect || !volumeInput || !storageId) {
                    alert("Bitte Beh√§lter, Destillat und Menge angeben!");
                    return;
                }

                const archiveName = archiveSelect.value;
                const volume = parseFloat(volumeInput.value);
                const strength = parseFloat(strengthInput.value);

                if (!archiveName || isNaN(volume) || volume <= 0) {
                    alert("Bitte g√ºltige Angaben machen!");
                    return;
                }

                // Archiv laden
                const archiveKey = archiveName;
                let data;

                // üîç Produkt?
                if (archiveKey.startsWith("product_")) {
                    const products = JSON.parse(localStorage.getItem("products") || "[]");
                    data = products.find(p => p.id === archiveKey) || {};
                }

                // üì¶ Archiv?
                else {
                    data = JSON.parse(localStorage.getItem(archiveKey) || "{}");
                }


                // verf√ºgbare Menge ermitteln ‚Äì NUR remainingVolume z√§hlt!
                function getAvailableVolume(data) {

                    // 1Ô∏è‚É£ Produkte & neue Archiveintr√§ge:
                    //    remainingVolume ist die einzige g√ºltige Quelle!
                    if (!isNaN(parseFloat(data.remainingVolume))) {
                        return Math.max(0, parseFloat(data.remainingVolume));
                    }

                    // 2Ô∏è‚É£ Alte Archiv-Eintr√§ge (legacy):
                    //    Falls es noch alte Daten hat, die keinen remainingVolume besitzen:
                    if (!isNaN(parseFloat(data.actualAlcohol))) {
                        return Math.max(0, parseFloat(data.actualAlcohol));
                    }

                    if (!isNaN(parseFloat(data.volume))) {
                        return Math.max(0, parseFloat(data.volume));
                    }

                    // 3Ô∏è‚É£ Produkte sollen NIEMALS den vollen Anfangswert (volumeL) liefern!
                    //    Deshalb: KEIN fallback mehr auf volumeL.

                    return 0;
                }


                let available = getAvailableVolume(data, archiveKey);

                // numerisch robust runden
                const volumeNorm = Number(volume.toFixed(2));
                const availableNorm = Number(available.toFixed(2));

                // echte Pr√ºfung
                if (volumeNorm - availableNorm > 0.00001) {
                    alert(`‚ùå Es sind nur ${availableNorm.toFixed(2)} L verf√ºgbar!`);
                    return;
                }

                // Beh√§lter laden
                const storage = JSON.parse(localStorage.getItem("storage_" + storageId) || "{}");
                if (!storage.contents) storage.contents = [];

                // Mischwarnung
                const newFruit = getFruitNameClean(data);
                const targetFruits = new Set();

                storage.contents.forEach(c => {
                    if (c.fruitData) Object.keys(c.fruitData).forEach(f => targetFruits.add(f));
                    else if (c.fruit) targetFruits.add(c.fruit);
                });

                if (targetFruits.size > 0 && !targetFruits.has(newFruit)) {
                    const msg =
                        `‚ö†Ô∏è Unterschiedliche Destillate erkannt!\n\n` +
                        `Beh√§lter enth√§lt bisher: ${Array.from(targetFruits).join(", ") || "Unbekannt"}\n` +
                        `Neues Destillat:         ${newFruit}\n\n` +
                        `Trotzdem hinzuf√ºgen? (z. B. f√ºr Obstler)`;
                    if (!confirm(msg)) return;
                }

                // Kapazit√§tspr√ºfung VOR dem Einf√ºgen
                const capacity = parseFloat(storage.capacity || 0);
                const currentFill = storage.contents.reduce((sum, item) => sum + (parseFloat(item.volume) || 0), 0);
                const newTotal = currentFill + volume;

                if (capacity > 0 && newTotal > capacity) {
                    alert(`‚ùå Der Beh√§lter ist zu klein!\nFassungsverm√∂gen: ${capacity} L\nAktuell enthalten: ${currentFill.toFixed(2)} L`);
                    return;
                }

                if (capacity > 0 && newTotal > capacity * 0.9) {
                    if (!confirm(`‚ö†Ô∏è Der Beh√§lter wird zu ${(newTotal / capacity * 100).toFixed(0)} % gef√ºllt.\nTrotzdem fortfahren?`)) {
                        return;
                    }
                }

                // Archiv reduzieren
                // üî• Verbleibende Menge korrekt reduzieren (Archiv & Produkte)
                const newRemaining = Math.max(available - volume, 0);

                // PRODUKT?
                if (archiveKey.startsWith("product_")) {
                    data.remainingVolume = newRemaining;

                    const products = JSON.parse(localStorage.getItem("products") || "[]");
                    const idx = products.findIndex(p => p.id === data.id);

                    if (idx !== -1) {
                        products[idx].remainingVolume = newRemaining;
                        localStorage.setItem("products", JSON.stringify(products));
                    }

                    // ARCHIV?
                } else {
                    data.remainingVolume = newRemaining;
                    localStorage.setItem(archiveKey, JSON.stringify(data));
                }

                // üîç Wasser- & Verd√ºnnungsinfos aus dem Produkt (falls vorhanden)
                let waterFromProduct = 0;
                let plannedFromProduct = null;

                if (archiveKey.startsWith("product_")) {
                    if (typeof data.waterAdded === "number") {
                        waterFromProduct = data.waterAdded;
                    } else if (data.plannedDilution && typeof data.plannedDilution.waterAdded === "number") {
                        waterFromProduct = data.plannedDilution.waterAdded;
                    }

                    if (data.plannedDilution) {
                        plannedFromProduct = data.plannedDilution;
                    }
                }



                // EINMALIGER Eintrag in den Beh√§lter
                storage.contents.push({
                    id: "item_" + Date.now(),     // üî• eindeutige ID
                    productId: archiveKey.startsWith("product_")   // ‚úÖ falls aus Produkt
                        ? data.id || archiveKey
                        : null,
                    source: data.name || archiveName,
                    fruit: newFruit,
                    volume: volume,
                    strength: strength || data.actualStrength || data.strength || 0,
                    fruitData: { [newFruit]: volume },
                    dateAdded: new Date().toISOString().split("T")[0],
                    // ‚≠ê Wasser- & Verd√ºnnungsinfos
                    waterAdded: waterFromProduct,
                    plannedDilution: plannedFromProduct
                });

                localStorage.setItem("storage_" + storageId, JSON.stringify(storage));
                showStorageContents(storage);

                cancelAddDistillate();
                setTimeout(() => updateArchiveDropdown(), 100);

                const mix = calcMixture(storage);
                alert(
                    `‚úÖ ${volume} L von ‚Äû${archiveName}‚Äú wurden hinzugef√ºgt.\nVerbleibend im Archiv: ${newRemaining.toFixed(2)} L\n\nGesamt im Beh√§lter: ${mix.volume.toFixed(2)} L @ ${mix.strength.toFixed(1)} %vol`
                );
            }



            function autoFillArchiveValues() {
                const archiveKey = document.getElementById("archiveSelect").value;
                if (!archiveKey) return;

                let data;

                // Produkt?
                if (archiveKey.startsWith("product_")) {
                    const products = JSON.parse(localStorage.getItem("products") || "[]");
                    data = products.find(p => p.id === archiveKey) || {};
                }
                // Archiv?
                else {
                    data = JSON.parse(localStorage.getItem(archiveKey) || {});
                }

                // üîç verf√ºgbare Menge
                let available = 0;
                if (!isNaN(parseFloat(data.remainingVolume))) available = parseFloat(data.remainingVolume);
                else if (!isNaN(parseFloat(data.actualAlcohol))) available = parseFloat(data.actualAlcohol);
                else if (!isNaN(parseFloat(data.volume))) available = parseFloat(data.volume);

                // üîç St√§rke ermitteln
                const strength =
                    data.strength ||
                    data.actualStrength ||
                    0;

                // ‚≠ê Felder vorausf√ºllen
                const volInput = document.getElementById("addVolume");
                const strInput = document.getElementById("addStrength");

                if (volInput) volInput.value = available.toFixed(2);
                if (strInput) strInput.value = strength.toFixed(1);
            }





            function getAvailableVolume(data, key) {

                // üü¶ PRODUKT?
                if (key.startsWith("product_")) {

                    // Falls bereits reduziert
                    if (!isNaN(parseFloat(data.remainingVolume))) {
                        return parseFloat(data.remainingVolume);
                    }

                    // Sonst komplette Produktmenge
                    if (!isNaN(parseFloat(data.volumeL))) {
                        return parseFloat(data.volumeL);
                    }

                    return 0;
                }

                // üì¶ ARCHIV-EINTRAG?
                const a = parseFloat(data.remainingVolume);
                const b = parseFloat(data.actualAlcohol);
                const c = parseFloat(data.volume);

                if (!isNaN(a) && a > 0) return a;
                if (!isNaN(b) && b > 0) return b;
                if (!isNaN(c) && c > 0) return c;

                return 0;
            }


            function getFruitNameClean(data) {
                let raw = "Unbekannt";

                // Archiv-Eintrag
                if (data.fruit) {
                    raw = data.fruit;
                }

                // Produkt
                else if (Array.isArray(data.mixComponents) && data.mixComponents.length > 0) {
                    raw = data.mixComponents[0].fruit || "Unbekannt";
                }

                // Klammern entfernen: alles was wie "(...)" aussieht
                return raw.replace(/\([^)]*\)/g, "").trim();
            }







            // üß± --- Modal zum Anlegen neuer Beh√§lter --- 

            function openAddStorageModal() {
                document.getElementById("addStorageModal").style.display = "block";
                document.getElementById("modalOverlay").style.display = "block";
            }

            function closeAddStorageModal() {
                document.getElementById("addStorageModal").style.display = "none";
                document.getElementById("modalOverlay").style.display = "none";
            }

            function saveNewStorage() {
                const name = document.getElementById("newStorageName").value.trim();
                const capacity = parseFloat(document.getElementById("newStorageCapacity").value);
                const location = document.getElementById("newStorageLocation").value.trim();

                if (!name || isNaN(capacity) || capacity <= 0) {
                    alert("Bitte g√ºltige Angaben machen!");
                    return;
                }

                const id = Date.now().toString();
                const storage = {
                    id,
                    name,
                    capacity,
                    location,
                    contents: []
                };

                localStorage.setItem("storage_" + id, JSON.stringify(storage));

                // Dropdowns und Listen aktualisieren
                if (typeof updateStorageDropdown === "function") updateStorageDropdown();
                if (typeof loadStorageList === "function") loadStorageList();

                alert(`‚úÖ Beh√§lter ‚Äû${name}‚Äú erfolgreich angelegt.`);

                closeAddStorageModal();
            }

            function saveAndAddAnother() {
                const name = document.getElementById("newStorageName").value.trim();
                const capacity = parseFloat(document.getElementById("newStorageCapacity").value);
                const location = document.getElementById("newStorageLocation").value.trim();

                if (!name || isNaN(capacity) || capacity <= 0) {
                    alert("Bitte g√ºltige Angaben machen!");
                    return;
                }

                const id = Date.now().toString();
                const storage = {
                    id,
                    name,
                    capacity,
                    location,
                    contents: []
                };

                localStorage.setItem("storage_" + id, JSON.stringify(storage));

                if (typeof updateStorageDropdown === "function") updateStorageDropdown();
                if (typeof loadStorageList === "function") loadStorageList();

                alert(`‚úÖ Beh√§lter ‚Äû${name}‚Äú hinzugef√ºgt. Du kannst sofort den n√§chsten anlegen.`);

                // Eingabefelder leeren f√ºr den n√§chsten Eintrag
                document.getElementById("newStorageName").value = "";
                document.getElementById("newStorageCapacity").value = "";
                document.getElementById("newStorageLocation").value = "";
            }

            function saveAndCloseModal() {
                const name = document.getElementById("newStorageName").value.trim();
                const capacity = parseFloat(document.getElementById("newStorageCapacity").value);
                const location = document.getElementById("newStorageLocation").value.trim();

                if (!name || isNaN(capacity) || capacity <= 0) {
                    alert("Bitte g√ºltige Angaben machen!");
                    return;
                }

                const id = Date.now().toString();
                const storage = {
                    id,
                    name,
                    capacity,
                    location,
                    contents: []
                };

                localStorage.setItem("storage_" + id, JSON.stringify(storage));

                if (typeof updateStorageDropdown === "function") updateStorageDropdown();
                if (typeof loadStorageList === "function") loadStorageList();

                alert(`‚úÖ Beh√§lter ‚Äû${name}‚Äú gespeichert.`);
                closeAddStorageModal();

                const back = sessionStorage.getItem("returnToPage");
                if (back) {
                    sessionStorage.removeItem("returnToPage");
                    sessionStorage.setItem("storageCheckDone", "1");
                    location.href = back;
                }
            }

            //Wasser hinzuf√ºgen
            function openWaterModal() {
                const id = document.getElementById("storageSelect").value;
                if (!id) return alert("Bitte zuerst einen Beh√§lter w√§hlen!");

                const storage = JSON.parse(localStorage.getItem("storage_" + id) || "{}");
                const mix = calcMixture(storage);
                if (mix.volume <= 0) return alert("Beh√§lter ist leer!");

                document.getElementById("targetVolPercent").value = 40;
                document.getElementById("waterCalcResult").innerHTML = "";
                document.getElementById("waterModal").style.display = "block";
                document.getElementById("modalOverlay").style.display = "block";
            }

            function updateWaterCalculation() {
                const input = document.getElementById("targetVolPercent");
                const result = document.getElementById("waterCalcResult");
                if (!input || !result) return;

                const target = parseFloat(input.value);
                if (isNaN(target) || target <= 0) {
                    result.textContent = "";
                    return;
                }

                // Aktuellen Beh√§lter ermitteln
                const id = document.getElementById("storageSelect").value;
                const storage = JSON.parse(localStorage.getItem("storage_" + id) || "{}");
                const mix = calcMixture(storage);

                if (!mix || !mix.volume || !mix.strength || mix.strength <= target) {
                    result.innerHTML = "<em>Bitte eine Zielst√§rke unter der aktuellen St√§rke eingeben.</em>";
                    return;
                }

                const pureAlcohol = mix.volume * (mix.strength / 100);
                const finalVolume = pureAlcohol / (target / 100);
                const waterToAdd = finalVolume - mix.volume;

                result.innerHTML = `
        <strong>Wasserzugabe:</strong> ${waterToAdd.toFixed(2)} L<br>
        <strong>Endvolumen:</strong> ${finalVolume.toFixed(2)} L
    `;
            }


            function cancelWaterModal() {
                document.getElementById("waterModal").style.display = "none";
                document.getElementById("modalOverlay").style.display = "none";
            }

            function confirmAddWater() {
                const id = document.getElementById("storageSelect").value;
                const target = parseFloat(document.getElementById("targetVolPercent").value);
                if (!id || isNaN(target) || target <= 0) return alert("Bitte g√ºltige Zielst√§rke angeben!");

                const storage = JSON.parse(localStorage.getItem("storage_" + id) || "{}");
                const mix = calcMixture(storage);
                if (target >= mix.strength) return alert("Zielst√§rke muss niedriger als aktuelle St√§rke sein!");

                const finalVol = (mix.volume * mix.strength) / target;
                const waterToAdd = finalVol - mix.volume;

                const resultDiv = document.getElementById("waterCalcResult");

                // Kapazit√§tspr√ºfung
                const overfill = storage.capacity && finalVol > storage.capacity;
                if (overfill) {
                    resultDiv.innerHTML = `<b>Wasserzugabe:</b> ${waterToAdd.toFixed(2)} L<br>
            <b>Endvolumen:</b> ${finalVol.toFixed(2)} L<br>
            <span style="color:red;">‚ö†Ô∏è Beh√§lter zu klein!</span>`;
                    return;
                }

                resultDiv.innerHTML = `<b>Wasserzugabe:</b> ${waterToAdd.toFixed(2)} L<br>
        <b>Endvolumen:</b> ${finalVol.toFixed(2)} L`;

                // Sicherheitsabfrage
                if (!confirm(`Soll dem Beh√§lter wirklich ${waterToAdd.toFixed(2)} L Wasser hinzugef√ºgt werden?`))
                    return;

                // Speichern der Verd√ºnnung im Beh√§lter
                if (!storage.contents) storage.contents = [];
                storage.contents.push({
                    source: "Wasserzugabe",
                    volume: waterToAdd,
                    strength: 0,
                    dateAdded: new Date().toISOString().split("T")[0]
                });

                // Aktualisieren der gespeicherten Werte
                localStorage.setItem("storage_" + id, JSON.stringify(storage));

                // Anzeige aktualisieren
                cancelWaterModal();
                loadStorageDetails();
                alert(`‚úÖ ${waterToAdd.toFixed(2)} L Wasser hinzugef√ºgt.\nNeuer Alkoholgehalt: ${target.toFixed(1)} %vol`);
            }









            //=== Verkauf steuern ====
            //Dropdown f√ºllen
            function updateSaleDropdown() {
                const sel = document.getElementById("saleStorage");
                sel.innerHTML = '<option value="">‚Äî Beh√§lter w√§hlen ‚Äî</option>';

                const keys = Object.keys(localStorage)
                    .filter(k => k.startsWith("storage_"))
                    .sort();

                if (keys.length === 0) {
                    const opt = document.createElement("option");
                    opt.value = "";
                    opt.textContent = "Keine Beh√§lter vorhanden";
                    sel.appendChild(opt);
                    return;
                }

                keys.forEach(k => {
                    try {
                        const s = JSON.parse(localStorage.getItem(k) || "{}");

                        if (!s || typeof s !== "object" || (!s.contents && !s.distillates)) {
                            console.warn("‚ö†Ô∏è √úberspringe ung√ºltigen Eintrag:", k);
                            return;
                        }

                        let mix = { volume: 0, strength: 0 };
                        try {
                            if (s && (s.contents || s.distillates)) {
                                mix = calcMixture(s);
                                if (!isFinite(mix.volume) || !isFinite(mix.strength)) {
                                    mix = { volume: 0, strength: 0 };
                                }
                            }
                        } catch (e) {
                            console.warn("‚ö†Ô∏è Fehler in calcMixture f√ºr", s.name, e);
                        }


                        // üîπ Produktnamen aus Archiv √ºbernehmen, falls vorhanden
                        // Versuch: archivierter Brandname oder Frucht oder Produktname
                        let productName = "-";
                        if (s.product) productName = s.product;
                        else if (s.fruit) productName = s.fruit;
                        else if (s.source) productName = s.source;
                        else if (s.archiveSource) productName = s.archiveSource;

                        const opt = document.createElement("option");
                        opt.value = s.id;
                        opt.textContent = `${s.name} ‚Äî ${productName} ‚Äî ${mix.volume.toFixed(1)} L @ ${mix.strength.toFixed(1)} %vol`;

                        sel.appendChild(opt);
                    } catch (err) {
                        console.warn("Fehler beim Lesen von", k, err);
                    }
                });
            }


            //Quelle anzeigen
            function updateSaleSource() {
                const sel = document.getElementById("saleStorage");
                const info = document.getElementById("bottlingInfoBox");
                const targetBlock = document.getElementById("saleTargetStrengthBlock");
                const targetInput = document.getElementById("saleTargetStrength");

                if (!sel || !sel.value) {
                    if (info) info.textContent = "";
                    if (targetBlock) targetBlock.style.display = "none";
                    return;
                }

                const id = sel.value;
                if (targetBlock) targetBlock.style.display = "block";

                // --------------------------------------------------
                // üõ¢ FALL 1: Fass
                // --------------------------------------------------
                if (id.startsWith("cask_")) {
                    const casks = JSON.parse(localStorage.getItem("casks") || "[]");
                    const cask = casks.find(c => c.id === id);

                    if (!cask) {
                        info.textContent = "Fass nicht gefunden.";
                        return;
                    }

                    let vol = 0;
                    let aa = 0;

                    (cask.fillHistory || []).forEach(e => {
                        vol += e.volume || 0;
                        aa += e.AA || 0;
                    });

                    const strength = vol > 0 ? (aa / vol) * 100 : 0;
                    window.currentSaleBaseStrength = strength;

                    info.textContent =
                        `Fassinhalt: ${vol.toFixed(1)} L @ ${strength.toFixed(1)} %vol, Fass: ${cask.name}`;

                    updateSaleDilutionPreview(strength);
                    return;
                }

                // --------------------------------------------------
                // üß¥ FALL 2: Lagerbeh√§lter
                // --------------------------------------------------
                const s = JSON.parse(localStorage.getItem("storage_" + id));
                if (!s) {
                    info.textContent = "Lagerbeh√§lter nicht gefunden.";
                    return;
                }

                if (typeof calcMixture !== "function") {
                    info.textContent = "calcMixture() nicht verf√ºgbar.";
                    return;
                }

                const mix = calcMixture(s);
                const strength = parseFloat(mix.strength) || 0;
                window.currentSaleBaseStrength = strength;

                info.textContent =
                    `Aktuell: ${mix.volume.toFixed(1)} L @ ${strength.toFixed(1)} %vol, Lager: ${s.location}`;

                // Ziel-/Trinkst√§rke aus dem Lagerbeh√§lter ableiten (plannedDilution.targetAbv)
                let targetAbv = null;

                if (Array.isArray(s.contents) && s.contents.length) {
                    // Nimm den ersten Eintrag, der plannedDilution hat
                    const withPlan = s.contents.find(c => c?.plannedDilution?.targetAbv != null);
                    if (withPlan) targetAbv = parseFloat(withPlan.plannedDilution.targetAbv);
                }

                if (targetInput) {
                    targetInput.value = (targetAbv != null && !isNaN(targetAbv)) ? targetAbv : "";
                }


                updateSaleDilutionPreview(strength);
                if (typeof renderSaleCalculation === "function") {
                    renderSaleCalculation();
                }

            }




            function saleToday() {
                return new Date().toISOString().slice(0, 10);
            }

            // --------------------------------------------------
            // üõ¢ Aktuellen Fass-Inhalt berechnen (Vol + AA + %)
            // --------------------------------------------------
            function saleCalcCaskCurrent(cask) {
                let vol = 0;
                let aa = 0;

                (cask.fillHistory || []).forEach(e => {
                    const v = parseFloat(e.volume) || 0;
                    const A = parseFloat(e.AA) || 0;
                    vol += v;
                    aa += A;
                });

                const strength = vol > 0 ? (aa / vol) * 100 : 0;
                return { volume: vol, AA: aa, strength };
            }

            // --------------------------------------------------
            // üõ¢ Verkauf aus Fass buchen (als negativer History-Eintrag)
            // --------------------------------------------------
            function saleConsumeFromCask(caskId, litersOut, noteText) {
                const all = JSON.parse(localStorage.getItem("casks") || "[]");
                const cask = all.find(c => c.id === caskId);
                if (!cask) return { ok: false, msg: "Fass nicht gefunden." };

                if (!cask.fillHistory) cask.fillHistory = [];

                const cur = saleCalcCaskCurrent(cask);
                if (litersOut > cur.volume + 1e-9) {
                    return { ok: false, msg: `Zu wenig im Fass. Verf√ºgbar: ${cur.volume.toFixed(2)} L` };
                }

                // Wir ziehen homogen ab: AA proportional zur aktuellen Fassst√§rke
                const outAA = litersOut * (cur.strength / 100);

                cask.fillHistory.push({
                    id: "sale_out_" + Date.now(),
                    date: saleToday(),
                    batchId: "__sale_out__",
                    recipeName: "Verkauf/Abf√ºllung",
                    volume: -litersOut,
                    strength: cur.strength,
                    AA: -outAA,
                    notes: noteText || "Verkauf/Abf√ºllung"
                });

                // Status automatisch aktualisieren
                const after = saleCalcCaskCurrent(cask);
                cask.status = after.volume > 0.05 ? "in_use" : "empty";

                localStorage.setItem("casks", JSON.stringify(all));
                return { ok: true, cask, before: cur, after };
            }

            // --------------------------------------------------
            // üß¥ Verkauf aus Lagerbeh√§lter buchen (homogene Mischung)
            // --------------------------------------------------
            function saleConsumeFromStorage(storageId, litersOut) {
                const key = "storage_" + storageId;
                const s = JSON.parse(localStorage.getItem(key) || "null");
                if (!s) return { ok: false, msg: "Lagerbeh√§lter nicht gefunden." };

                if (!Array.isArray(s.contents) || s.contents.length === 0) {
                    return { ok: false, msg: "Beh√§lter ist leer." };
                }

                // --------------------------------------------------
                // Aktuellen Zustand bestimmen
                // --------------------------------------------------
                const mix = (typeof calcMixture === "function")
                    ? calcMixture(s)
                    : { volume: 0, strength: 0 };

                const curVol = parseFloat(mix.volume) || 0;
                const curStrength = parseFloat(mix.strength) || 0;

                if (litersOut > curVol + 1e-9) {
                    return {
                        ok: false,
                        msg: `Zu wenig im Beh√§lter. Verf√ºgbar: ${curVol.toFixed(2)} L`
                    };
                }

                // --------------------------------------------------
                // üîë ABSOLUTER ALKOHOL (AA) korrekt berechnen
                // --------------------------------------------------
                const AA_out = litersOut * (curStrength / 100);

                // Gesamt-AA im Beh√§lter
                let totalAA = 0;
                s.contents.forEach(c => {
                    const vol = parseFloat(c.volume) || 0;
                    const strength = parseFloat(c.strength ?? curStrength) || curStrength;
                    c.AA = vol * (strength / 100);
                    totalAA += c.AA;
                });

                if (AA_out > totalAA + 1e-9) {
                    return { ok: false, msg: "Zu wenig Alkohol im Beh√§lter." };
                }

                // --------------------------------------------------
                // üî• Volumen UND AA proportional abbuchen
                // --------------------------------------------------
                s.contents.forEach(c => {
                    const share = c.AA / totalAA;

                    const AA_sub = AA_out * share;
                    const vol_sub = AA_sub / (curStrength / 100);

                    c.AA = Math.max(0, c.AA - AA_sub);
                    c.volume = Math.max(0, (parseFloat(c.volume) || 0) - vol_sub);
                });

                // Leere Eintr√§ge entfernen
                s.contents = s.contents.filter(c => c.volume > 0.0001);

                // Optionales Gesamtvolumen pflegen
                if (typeof s.currentVolume === "number") {
                    s.currentVolume = Math.max(0, s.currentVolume - litersOut);
                }

                // --------------------------------------------------
                // SPEICHERN
                // --------------------------------------------------
                localStorage.setItem(key, JSON.stringify(s));

                // --------------------------------------------------
                // R√ºckgabe: St√§rke BLEIBT stabil
                // --------------------------------------------------
                return {
                    ok: true,
                    storage: s,
                    before: mix,
                    after: {
                        volume: curVol - litersOut,
                        strength: curStrength
                    }
                };
            }







            function updateSaleDilutionPreview(baseStrength) {
                const info = document.getElementById("saleDilutionInfo");
                const target = parseFloat(document.getElementById("saleTargetStrength")?.value);
                const vol = parseFloat(document.getElementById("saleVolume")?.value);

                if (!info) return;

                if (!baseStrength || !vol || vol <= 0 || !target || target >= baseStrength) {
                    info.innerHTML = "<em>Keine Verd√ºnnung notwendig.</em>";
                    window.currentSaleDilutionEndVolume = null; // üëà wichtig
                    return;
                }

                const AA = vol * (baseStrength / 100);
                const finalVol = AA / (target / 100);
                const water = finalVol - vol;

                // ‚úÖ HIER DIE ENTSCHEIDENDE ZEILE
                window.currentSaleDilutionEndVolume = finalVol;

                info.innerHTML = `
                <strong>Verd√ºnnung:</strong><br>
                Ausgangsst√§rke: ${baseStrength.toFixed(1)} %vol<br>
                Zielst√§rke: ${target.toFixed(1)} %vol<br>
                Entnommene Menge: ${vol.toFixed(2)} L<br>
                Wasserzugabe: ${water.toFixed(2)} L<br>
                Endvolumen: ${finalVol.toFixed(2)} L
            `;
            }




            function getSaleCalculation(sourceType, sourceId) {

                const result = {
                    sourceType,
                    sourceId,

                    baseStrength: 0,      // IST-St√§rke im Lager
                    targetStrength: 0,    // Kalkulations-/Referenzst√§rke
                    costPerLiter: 0,      // ‚Ç¨/L bei IST-St√§rke
                    calcPrice: {},
                    userPrice: {},
                    warnings: []
                };

                // ==================================================
                // A) PRODUKT / REZEPT
                // ==================================================
                if (sourceType === "product") {

                    const products = JSON.parse(localStorage.getItem("products") || "[]");
                    const p = products.find(x => x.id === sourceId);
                    if (!p) return null;

                    // ------------------------------
                    // St√§rken
                    // ------------------------------
                    const calcStrength = parseFloat(p.strength) || 0;   // Referenz
                    const istStrength = calcStrength;                  // Produkt = noch kein Lager

                    result.baseStrength = istStrength;
                    result.targetStrength = calcStrength;

                    // ------------------------------
                    // Preise
                    // ------------------------------
                    result.calcPrice = p.calcPrice || {};
                    result.userPrice = p.userPrice || {};

                    // Mindestpreis pro Liter bei Kalkulationsst√§rke
                    const oneLiter = result.calcPrice["1.0"];
                    if (oneLiter?.min && calcStrength > 0) {
                        result.costPerLiter =
                            oneLiter.min * (istStrength / calcStrength);
                    }

                    return result;
                }

                // ==================================================
                // B) LAGERBEH√ÑLTER
                // ==================================================
                if (sourceType === "storage") {

                    const s = JSON.parse(localStorage.getItem("storage_" + sourceId) || "null");
                    if (!s) return null;

                    // ------------------------------
                    // IST-St√§rke aus dem Lager
                    // ------------------------------
                    const mix = (typeof calcMixture === "function")
                        ? calcMixture(s)
                        : { strength: 0 };

                    const istStrength = parseFloat(mix.strength) || 0;
                    result.baseStrength = istStrength;

                    // ------------------------------
                    // Kalkulationsst√§rke (Referenz)
                    // ------------------------------
                    let calcStrength = null;

                    if (Array.isArray(s.contents)) {
                        const withPlan = s.contents.find(c =>
                            c?.plannedDilution &&
                            typeof c.plannedDilution.targetAbv === "number"
                        );
                        if (withPlan) {
                            calcStrength = withPlan.plannedDilution.targetAbv;
                        }
                    }

                    // Fallback: keine geplante Trinkst√§rke
                    if (!calcStrength || calcStrength <= 0) {
                        calcStrength = istStrength;
                    }

                    result.targetStrength = calcStrength;

                    // ------------------------------
                    // Preisermittlung (Mischpreis)
                    // ------------------------------
                    if (typeof saleCalcMixedPricingFromStorage === "function") {

                        const pricing = saleCalcMixedPricingFromStorage(s);
                        const oneLiter = pricing?.sizes?.["1.0"];

                        if (oneLiter?.min && calcStrength > 0) {

                            // üî• DAS ist die entscheidende Zeile
                            result.costPerLiter =
                                oneLiter.min * (istStrength / calcStrength);

                            if (Math.abs(istStrength - calcStrength) > 0.1) {
                                result.warnings.push(
                                    `Abf√ºllung erfolgt mit ${istStrength.toFixed(1)} %vol ` +
                                    `statt kalkulierter ${calcStrength.toFixed(1)} %vol. ` +
                                    `Preis wurde angepasst.`
                                );
                            }
                        }
                    }

                    return result;
                }

                // ==================================================
                // C) FASS (vorerst unver√§ndert)
                // ==================================================
                if (sourceType === "cask") {

                    const casks = JSON.parse(localStorage.getItem("casks") || "[]");
                    const c = casks.find(x => x.id === sourceId);
                    if (!c) return null;

                    let vol = 0;
                    let aa = 0;

                    (c.fillHistory || []).forEach(e => {
                        vol += e.volume || 0;
                        aa += e.AA || 0;
                    });

                    const strength = vol > 0 ? (aa / vol) * 100 : 0;

                    result.baseStrength = strength;
                    result.targetStrength = strength;
                    result.costPerLiter = 0;

                    return result;
                }

                return null;
            }





            function saleLoadProductsMap() {
                const list = JSON.parse(localStorage.getItem("products") || "[]");
                const map = {};
                list.forEach(p => { if (p && p.id) map[p.id] = p; });
                return map;
            }

            function saleGetUserBottlePrice(product, sizeKey) {
                if (!product) return null;

                // Manche Produkte haben userPrice, andere pricing
                const up = product.userPrice || product.userprice || null;
                const pr = product.pricing || product.Pricing || null;

                const v1 = up && up[sizeKey] != null ? Number(up[sizeKey]) : null;
                if (v1 != null && !isNaN(v1)) return v1;

                const v2 = pr && pr[sizeKey] != null ? Number(pr[sizeKey]) : null;
                if (v2 != null && !isNaN(v2)) return v2;

                return null;
            }

            function saleGetMinBottlePrice(product, sizeKey) {
                if (!product) return null;

                // bevorzugt calcPrice[size].min
                const cp = product.calcPrice || product.calcprice || null;
                if (cp && cp[sizeKey] && cp[sizeKey].min != null) {
                    const v = Number(cp[sizeKey].min);
                    return isNaN(v) ? null : v;
                }

                // Fallback: costPerLiter * size (wenn keine calcPrice vorhanden)
                const cpl = Number(product.costPerLiter ?? product.costs?.perLiter ?? product.costs?.per_liter);
                const size = Number(sizeKey);
                if (!isNaN(cpl) && !isNaN(size) && size > 0) return cpl * size;

                return null;
            }



            function saleCalcMixedPricingFromStorage(storage) {
                if (!storage || !Array.isArray(storage.contents) || storage.contents.length === 0) return null;

                const productsMap = saleLoadProductsMap();
                const volByPid = {};

                // Produktmengen im Beh√§lter aufsummieren (pro productId)
                storage.contents.forEach(item => {
                    const v = Number(item.volume) || 0;
                    if (v <= 0) return;

                    // üîπ Fall 1: normales Produkt
                    if (item.productId) {
                        volByPid[item.productId] = (volByPid[item.productId] || 0) + v;
                    }

                    // üîπ Fall 2: Rezeptmix ‚Üí productRefs
                    else if (item.productRefs && typeof item.productRefs === "object") {
                        Object.entries(item.productRefs).forEach(([pid, part]) => {
                            const partVol = v * part; // z. B. 1 L * 0.5
                            volByPid[pid] = (volByPid[pid] || 0) + partVol;
                        });
                    }
                });


                const totalVol = Object.values(volByPid).reduce((a, b) => a + b, 0);
                if (totalVol <= 0) return null;

                const sizes = ["0.5", "0.7", "1.0"];

                // Ergebnis: gewichtete min/user Preise je Flaschengr√∂√üe
                const out = {
                    totalVol,
                    sizes: {},
                    // optional: Debug/Transparenz
                    components: []
                };

                sizes.forEach(sz => {
                    let minSum = 0;
                    let minW = 0;

                    let userSum = 0;
                    let userW = 0;

                    Object.entries(volByPid).forEach(([pid, v]) => {
                        const p = productsMap[pid];
                        if (!p) return;

                        // Mindestpreis
                        const minP = saleGetMinBottlePrice(p, sz);
                        if (minP != null) {
                            minSum += minP * v;
                            minW += v;
                        }

                        // Verkaufspreis (nur wenn hinterlegt)
                        const userP = saleGetUserBottlePrice(p, sz);
                        if (userP != null) {
                            userSum += userP * v;
                            userW += v;
                        }
                    });

                    out.sizes[sz] = {
                        min: minW > 0 ? (minSum / minW) : null,
                        user: userW > 0 ? (userSum / userW) : null
                    };
                });

                // Komponentenliste (optional f√ºrs ‚ÄúWarum?‚Äù sp√§ter)
                Object.entries(volByPid).forEach(([pid, v]) => {
                    const p = productsMap[pid];
                    out.components.push({
                        productId: pid,
                        name: p?.name || "(unbekanntes Produkt)",
                        liters: v
                    });
                });

                return out;
            }







            function renderSaleCalculation() {
                const sel = document.getElementById("saleStorage");
                const box = document.getElementById("saleCalcInfo");
                const table = document.getElementById("saleCalcTable");
                const targetInput = document.getElementById("saleTargetStrength");

                if (!box || !table) return;

                if (!sel || !sel.value) {
                    box.innerHTML = "<em>Bitte Quelle ausw√§hlen.</em>";
                    table.innerHTML = "";
                    return;
                }

                const id = sel.value;

                // aktuell nur Lagerbeh√§lter
                if (id.startsWith("cask_")) {
                    box.innerHTML = "<em>Kalkulation f√ºr F√§sser folgt separat.</em>";
                    table.innerHTML = "";
                    return;
                }

                const storage = JSON.parse(localStorage.getItem("storage_" + id) || "null");
                if (!storage) {
                    box.innerHTML = "<em>Lagerbeh√§lter nicht gefunden.</em>";
                    table.innerHTML = "";
                    return;
                }

                const mixPricing = saleCalcMixedPricingFromStorage(storage);
                if (!mixPricing) {
                    box.innerHTML = "<em>Keine Kalkulationsdaten vorhanden.</em>";
                    table.innerHTML = "";
                    return;
                }

                const baseStrength = parseFloat(window.currentSaleBaseStrength) || 0;
                const targetStrength = parseFloat(targetInput?.value);

                box.innerHTML = `
                    Mischkalkulation aus ${mixPricing.components.length} Komponente(n).<br>
                    Basisst√§rke: ${baseStrength > 0 ? baseStrength.toFixed(1) : "‚Äî"} %vol
                    ${(!isNaN(targetStrength) && targetStrength > 0) ? ` ‚Üí Trinkst√§rke: ${targetStrength.toFixed(1)} %vol` : ""}
                `;

                const sizes = ["0.5", "0.7", "1.0"];
                let html = "";

                sizes.forEach(sz => {
                    const row = mixPricing.sizes[sz] || {};

                    const minRaw = (row.min != null && !isNaN(row.min)) ? Number(row.min) : null;
                    const user = (row.user != null && !isNaN(row.user)) ? Number(row.user) : null;

                    // ‚úÖ Korrekte Umrechnung auf Trinkst√§rke:
                    // Min_trink = Min_unverd√ºnnt * (target/base)
                    let minDrink = null;
                    if (minRaw != null) {
                        if (!isNaN(targetStrength) && targetStrength > 0 && baseStrength > 0) {
                            // Wenn Zielst√§rke h√∂her/gleich als Basisst√§rke: keine Verd√ºnnung ‚Üí gleich lassen
                            if (targetStrength >= baseStrength) minDrink = minRaw;
                            else minDrink = minRaw * (targetStrength / baseStrength);
                        } else {
                            // Wenn keine Zielst√§rke gesetzt: Trinkst√§rke-Min nicht berechenbar
                            minDrink = null;
                        }
                    }

                    // Marge (VK manuell minus Mindestpreis bei Trinkst√§rke)
                    let margin = null;
                    if (user != null && minDrink != null) {
                        margin = user - minDrink;
                    }

                    html += `
                        <tr>
                            <td>${sz} L</td>
                            <td style="text-align:right;">${minRaw != null ? minRaw.toFixed(2) : "‚Äî"}</td>
                            <td style="text-align:right;">${minDrink != null ? minDrink.toFixed(2) : "‚Äî"}</td>
                            <td style="text-align:right;">${user != null ? user.toFixed(2) : "‚Äî"}</td>
                            <td style="text-align:right; ${margin != null && margin < 0 ? "color:#b00;" : ""}">
                                ${margin != null ? margin.toFixed(2) : "‚Äî"}
                            </td>
                        </tr>
                    `;
                });

                table.innerHTML = html;
            }








            function getProductForSaleSource(source) {
                if (!source?.productId) return null;

                const products = JSON.parse(localStorage.getItem("products") || "[]");
                return products.find(p => p.id === source.productId) || null;
            }








            //Verkaufsverlauf speichern
            function recordSale() {
                const sel = document.getElementById("saleStorage");
                const litersOut = parseFloat(document.getElementById("saleVolume")?.value);
                const priceInput = document.getElementById("salePrice");
                const pricePL = parseFloat(priceInput?.value);
                const buyer = (document.getElementById("saleBuyer")?.value || "").trim();

                const targetStrength = parseFloat(document.getElementById("saleTargetStrength")?.value); // optional
                const id = sel?.value;

                if (!id) return alert("Bitte Quelle w√§hlen (Beh√§lter oder Fass).");
                if (isNaN(litersOut) || litersOut <= 0) return alert("Bitte eine g√ºltige Menge (L) eingeben.");

                const isCask = id.startsWith("cask_");
                const today = saleToday();

                // --------------------------------------------------
                // üîé Produkt ermitteln (f√ºr Kalkulation / Preis)
                // --------------------------------------------------
                let product = null;

                if (!isCask) {
                    const storage = JSON.parse(localStorage.getItem("storage_" + id) || "null");
                    const productId = storage?.contents?.[0]?.productId;

                    if (productId) {
                        const products = JSON.parse(localStorage.getItem("products") || "[]");
                        product = products.find(p => p.id === productId);
                    }
                }

                // --------------------------------------------------
                // üí∞ Preislogik
                // --------------------------------------------------
                if (!product) {
                    alert(
                        "F√ºr diese Quelle existiert keine automatische Kalkulation.\n" +
                        "Bitte Preis pro Liter manuell eingeben."
                    );
                    priceInput?.focus();
                    return;
                }

                // Wenn Preis leer / ung√ºltig ‚Üí automatisch vorbelegen
                if (isNaN(pricePL) || pricePL <= 0) {
                    if (product.costPerLiter && product.costPerLiter > 0) {
                        priceInput.value = product.costPerLiter.toFixed(2);
                        alert("Preis pro Liter wurde aus der Kalkulation vorbelegt.");
                        priceInput.focus();
                        return;
                    } else {
                        alert(
                            "F√ºr dieses Produkt ist kein kalkulierter Literpreis vorhanden.\n" +
                            "Bitte Preis manuell eingeben."
                        );
                        priceInput.focus();
                        return;
                    }
                }

                // --------------------------------------------------
                // 1) Quelle abbuchen
                // --------------------------------------------------
                let booking;
                if (isCask) {
                    const note = isNaN(targetStrength)
                        ? "Verkauf / Abf√ºllung"
                        : `Verkauf / Abf√ºllung (Ziel: ${targetStrength}% vol)`;

                    booking = saleConsumeFromCask(id, litersOut, note);
                } else {
                    booking = saleConsumeFromStorage(id, litersOut);
                }

                if (!booking?.ok) {
                    alert("‚ùå " + (booking?.msg || "Abbuchung fehlgeschlagen."));
                    return;
                }

                // --------------------------------------------------
                // 2) Verd√ºnnung (nur protokollieren!)
                // --------------------------------------------------
                let waterAdded = 0;
                let finalVolume = litersOut;

                const beforeStrength = booking.before?.strength || 0;

                if (
                    !isNaN(targetStrength) &&
                    targetStrength > 0 &&
                    targetStrength < beforeStrength
                ) {
                    const outAA = litersOut * (beforeStrength / 100);
                    finalVolume = outAA / (targetStrength / 100);
                    waterAdded = Math.max(0, finalVolume - litersOut);
                }

                // --------------------------------------------------
                // 3) Sale-Eintrag speichern
                // --------------------------------------------------
                const totalPrice = litersOut * pricePL;

                const sale = {
                    id: "sale_" + Date.now(),
                    date: today,

                    sourceType: isCask ? "cask" : "storage",
                    sourceId: id,
                    sourceName: isCask
                        ? (booking.cask?.name || "Fass")
                        : (booking.storage?.name || "Beh√§lter"),

                    soldVolume: litersOut,
                    pricePerLiter: pricePL,
                    totalPrice: totalPrice,
                    buyer: buyer || null,

                    dilution: {
                        targetStrength: (!isNaN(targetStrength) ? targetStrength : null),
                        waterNeeded: waterAdded,
                        finalVolume: finalVolume,
                        baseStrength: beforeStrength
                    }
                };

                const sales = JSON.parse(localStorage.getItem("sales") || "[]");
                sales.push(sale);
                localStorage.setItem("sales", JSON.stringify(sales));

                // --------------------------------------------------
                // 4) UI aktualisieren
                // --------------------------------------------------
                if (typeof updateSaleDropdown === "function") updateSaleDropdown();
                if (typeof updateSaleSource === "function") updateSaleSource();
                if (typeof showSalesList === "function") showSalesList();

                alert(
                    "‚úÖ Verkauf gespeichert.\n\n" +
                    `Menge: ${litersOut.toFixed(2)} L\n` +
                    `Preis/L: ${pricePL.toFixed(2)} ‚Ç¨\n` +
                    `Summe: ${totalPrice.toFixed(2)} ‚Ç¨\n` +
                    (waterAdded > 0
                        ? `\nVerd√ºnnung (Hinweis): +${waterAdded.toFixed(2)} L Wasser ‚Üí ${finalVolume.toFixed(2)} L @ ${targetStrength.toFixed(1)}%`
                        : "")
                );
            }






            function loadSaleSources() {
                const sel = document.getElementById("saleStorage");
                if (!sel) return;

                sel.innerHTML = `<option value="">‚Äî Quelle w√§hlen ‚Äî</option>`;

                // ------------------------------------
                // üß¥ Lagerbeh√§lter
                // ------------------------------------
                Object.keys(localStorage)
                    .filter(k => k.startsWith("storage_"))
                    .forEach(k => {
                        const s = JSON.parse(localStorage.getItem(k));
                        if (!s) return;

                        const opt = document.createElement("option");
                        opt.value = s.id;
                        opt.textContent = `üß¥ Lager: ${s.name}`;
                        sel.appendChild(opt);
                    });

                // ------------------------------------
                // üõ¢ F√§sser
                // ------------------------------------
                const casks = JSON.parse(localStorage.getItem("casks") || "[]");

                casks.forEach(c => {
                    if (c.status === "empty") return; // leere F√§sser nicht verkaufen

                    const opt = document.createElement("option");
                    opt.value = c.id;                 // z. B. "cask_123..."
                    opt.textContent = `üõ¢ Fass: ${c.name}`;
                    sel.appendChild(opt);
                });
            }



            function safeFixed(val, digits = 2) {
                const n = Number(val);
                return isNaN(n) ? "‚Äì" : n.toFixed(digits);
            }




            //Verkaufs√ºbersicht anzeigen
            function showSalesList() {
                const listDiv = document.getElementById("salesList");
                if (!listDiv) return;

                const sales = JSON.parse(localStorage.getItem("sales") || "[]");
                if (sales.length === 0) {
                    listDiv.innerHTML = "<em>Noch keine Verk√§ufe.</em>";
                    return;
                }

                let total = 0;
                let html = "<table style='border-collapse:collapse;width:100%;font-size:0.9em;'>";
                html += "<tr style='background:#ddd'><th>Datum</th><th>Quelle</th><th>Menge (L)</th><th>%vol</th><th>Preis/L (‚Ç¨)</th><th>Gesamt (‚Ç¨)</th><th>K√§ufer</th></tr>";

                sales.forEach(s => {
                    total += Number(s.totalPrice) || 0;
                    html += `<tr>
                    <td>${s.date || "-"}</td>
                    <td>${s.sourceName || "-"}</td>
                    <td style="text-align:right;">${safeFixed(s.soldVolume, 2)}</td>
                    <td style="text-align:right;">
                        ${safeFixed(s.dilution?.targetStrength ?? s.dilution?.baseStrength, 1)} %
                    </td>
                    <td style="text-align:right;">${safeFixed(s.pricePerLiter, 2)} ‚Ç¨</td>
                    <td style="text-align:right;">${safeFixed(s.totalPrice, 2)} ‚Ç¨</td>
                    <td>${s.buyer || "‚Äì"}</td>
                    </tr>`;
                });

                html += `</table><p><strong>Gesamterl√∂s:</strong> ${total.toFixed(2)} ‚Ç¨</p>`;
                listDiv.innerHTML = html;
            }


            //Export zu Excel
            function exportSalesToExcel() {
                const sales = JSON.parse(localStorage.getItem("sales") || "[]");
                if (sales.length === 0) {
                    alert("Keine Verkaufsdaten vorhanden.");
                    return;
                }

                // Daten in ein Array-Format f√ºr Excel bringen
                const rows = [
                    ["Datum", "Quelle", "Menge (L)", "%vol", "Preis/L (‚Ç¨)", "Gesamt (‚Ç¨)", "K√§ufer"]
                ];

                sales.forEach(s => {
                    rows.push([
                        s.date,
                        s.source,
                        s.volume.toFixed(2),
                        s.strength.toFixed(1),
                        s.price.toFixed(2),
                        s.total.toFixed(2),
                        s.buyer || ""
                    ]);
                });

                // Arbeitsblatt und Datei erzeugen
                const ws = XLSX.utils.aoa_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Verk√§ufe");

                // Download ausl√∂sen
                // üìÖ Aktuelles Datum hinzuf√ºgen (Format: YYYY-MM-DD)
                const today = new Date();
                const dateStr = today.toLocaleDateString("de-DE").replace(/\./g, "-"); // ‚Üí "07-11-2025"
                // Datei speichern mit Datum im Namen
                XLSX.writeFile(wb, `Verkaufsdaten_${dateStr}.xlsx`);

                alert("‚úÖ Excel-Datei wurde erstellt!");
            }


            //Ausgaben Funktionen beginnen hier:
            // ============================
            // üíæ AUSGABENVERWALTUNG
            // ============================

            // üîπ Neue Ausgabe speichern
            function saveExpense() {
                const date = document.getElementById("expenseDate").value;
                const cat = document.getElementById("expenseCategory").value;
                const totalCost = Number(document.getElementById("expenseAmount").value);

                if (!date || !cat || !totalCost) {
                    alert("Bitte Datum, Kategorie und Betrag eingeben.");
                    return;
                }

                let desc = document.getElementById("expenseDesc").value;

                // --------------------
                // Rohstoffeinkauf
                // --------------------
                if (cat === "Rohstoffe") {
                    const sel = document.getElementById("expenseMaterialSelect");
                    const choice = sel.value;

                    if (choice === "__new") {
                        // Neuer Rohstoff
                        const name = document.getElementById("newMatName").value.trim();
                        const category = document.getElementById("newMatCategory").value;
                        const unit = document.getElementById("newMatUnit").value;

                        if (!name) {
                            alert("Bitte Namen f√ºr neuen Rohstoff eingeben.");
                            return;
                        }

                        desc = "Rohstoff: " + name;

                        materialAddNewFromExpense(name, category, unit, totalCost);

                    } else {
                        // Existierender Rohstoff
                        desc = "Rohstoff: " + choice;

                        materialAddFromExpense(choice, totalCost);
                    }
                }

                // --------------------
                // Ausgabe speichern
                // --------------------
                const exp = {
                    date,
                    category: cat,
                    desc,
                    amount: totalCost
                };

                const list = JSON.parse(localStorage.getItem("expenses") || "[]");
                list.push(exp);
                localStorage.setItem("expenses", JSON.stringify(list));

                updateExpenseList();
                renderMaterialList();

                alert("Ausgabe gespeichert.");
            }





            function materialAddNewFromExpense(name, category, unit, totalCost) {
                const mats = materialLoadAll();
                const isBaseAlcohol = document.getElementById("newMatIsBaseAlcohol")?.checked || false;
                const strength = Number(document.getElementById("newMatStrength")?.value) || null;


                const qty = Number(prompt("Wie viel wurde eingekauft? (in " + unit + ")"));
                if (!qty || qty <= 0) {
                    alert("Ung√ºltige Menge.");
                    return;
                }

                const pricePerUnit = totalCost / qty;

                mats.push({
                    id: "mat_" + Date.now(),
                    name,
                    category,
                    unit,
                    remaining: qty,
                    pricePerUnit,
                    lastUpdated: new Date().toISOString().slice(0, 10),
                    isBaseAlcohol,
                    strength
                });

                materialSaveAll(mats);
                renderMaterialList();
            }


            function materialConsumeFromBatch(recipe, rows) {
                const mats = materialLoadAll();
                let warnings = [];

                rows.forEach(item => {
                    const needed = item.amount;   // erwartete Menge in kg/g/L
                    const name = item.name;

                    const mat = mats.find(m => m.name.toLowerCase() === name.toLowerCase());
                    if (!mat) {
                        warnings.push(`Rohstoff "${name}" existiert nicht im Lager.`);
                        return;
                    }

                    if (mat.remaining < needed) {
                        warnings.push(
                            `Nicht genug "${name}" im Lager. Ben√∂tigt: ` +
                            `${needed.toFixed(2)} ${mat.unit}, vorhanden: ${mat.remaining.toFixed(2)} ${mat.unit}`
                        );
                    }

                    // Abbuchen (auch wenn es zu wenig gibt)
                    mat.remaining -= needed;
                    if (mat.remaining < 0) mat.remaining = 0;
                    mat.lastUpdated = new Date().toISOString().slice(0, 10);
                });

                materialSaveAll(mats);
                renderMaterialList();

                // ‚ùó Nur zur√ºckgeben, NICHT selbst alerten
                return warnings;
            }





            // üîπ Dropdowns f√ºr Monat & Jahr f√ºllen
            function initExpenseFilters() {
                const monthSel = document.getElementById("filterMonth");
                const yearSel = document.getElementById("filterYear");
                if (!monthSel || !yearSel) return;

                const months = [
                    "Alle", "Januar", "Februar", "M√§rz", "April", "Mai", "Juni",
                    "Juli", "August", "September", "Oktober", "November", "Dezember"
                ];
                monthSel.innerHTML = "";
                months.forEach((m, i) => {
                    const opt = document.createElement("option");
                    opt.value = i; // 0 = Alle, 1 = Jan ‚Ä¶
                    opt.textContent = m;
                    monthSel.appendChild(opt);
                });

                const currentYear = new Date().getFullYear();
                yearSel.innerHTML = "";
                for (let y = currentYear - 3; y <= currentYear + 1; y++) {
                    const opt = document.createElement("option");
                    opt.value = y;
                    opt.textContent = y;
                    if (y === currentYear) opt.selected = true;
                    yearSel.appendChild(opt);
                }
            }


            function materialAddFromExpense(name, totalCost) {
                const mats = materialLoadAll();

                let m = mats.find(x => x.name.toLowerCase() === name.toLowerCase());

                // Falls der Rohstoff NICHT existiert ‚Üí richtige NEU-Anlage verwenden
                if (!m) {
                    console.warn("Rohstoff existiert nicht, leite zu materialAddNewFromExpense weiter!");
                    materialAddNewFromExpense(name, "sonstiges", "kg", totalCost);
                    return;
                }

                // Einheit IMMER anzeigen!
                const qty = Number(prompt(
                    `Wie viel wurde eingekauft? (${m.unit})`
                ));

                if (!qty || qty <= 0) {
                    alert("Ung√ºltige Menge.");
                    return;
                }

                const pricePerUnit = totalCost / qty;

                // Bestand erh√∂hen
                m.remaining += qty;

                // Preis aktualisieren
                m.pricePerUnit = pricePerUnit;

                m.lastUpdated = new Date().toISOString().slice(0, 10);

                materialSaveAll(mats);
                renderMaterialList();
            }

            function materialAutoImportFromRecipes() {
                const mats = materialLoadAll();
                let changed = false;

                // Mash-Rohstoffe
                const mashList = recipeGetMashList ? recipeGetMashList() : [];
                mashList.forEach(name => {
                    if (!mats.some(m => m.name.toLowerCase() === name.toLowerCase())) {
                        mats.push({
                            id: "mat_" + Date.now() + "_" + Math.random(),
                            name,
                            category: "malz",
                            unit: "kg",
                            remaining: 0,
                            pricePerUnit: 0,
                            lastUpdated: new Date().toISOString().slice(0, 10)
                        });
                        changed = true;
                    }
                });

                // Aroma-Rohstoffe
                const aromaList = recipeGetAromaList ? recipeGetAromaList() : [];
                aromaList.forEach(name => {
                    if (!mats.some(m => m.name.toLowerCase() === name.toLowerCase())) {
                        mats.push({
                            id: "mat_" + Date.now() + "_" + Math.random(),
                            name,
                            category: "kraeuter",
                            unit: "g",
                            remaining: 0,
                            pricePerUnit: 0,
                            lastUpdated: new Date().toISOString().slice(0, 10)
                        });
                        changed = true;
                    }
                });

                if (changed) {
                    materialSaveAll(mats);
                }
            }








            // üîπ Ausgabenliste anzeigen (mit Filter)
            function updateExpenseList() {
                const listDiv = document.getElementById("expenseList");
                const month = parseInt(document.getElementById("filterMonth").value);
                const year = parseInt(document.getElementById("filterYear").value);
                const expenses = JSON.parse(localStorage.getItem("expenses") || "[]");

                if (expenses.length === 0) {
                    listDiv.innerHTML = "<em>Noch keine Ausgaben erfasst.</em>";
                    return;
                }

                // Filter anwenden
                const filtered = expenses.filter(e => {
                    const d = new Date(e.date);
                    return (isNaN(year) || d.getFullYear() === year) &&
                        (month === 0 || d.getMonth() + 1 === month);
                });

                if (filtered.length === 0) {
                    listDiv.innerHTML = "<em>Keine Ausgaben im gew√§hlten Zeitraum.</em>";
                    return;
                }

                // Tabelle erstellen
                let total = 0;
                let html = `
        <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
            <tr style="background:#ddd;">
                <th style="text-align:left;">Datum</th>
                <th style="text-align:left;">Kategorie</th>
                <th style="text-align:left;">Beschreibung</th>
                <th style="text-align:right;">Betrag (‚Ç¨)</th>
            </tr>
    `;

                filtered.forEach(e => {
                    total += e.amount;
                    html += `
            <tr>
                <td style="border-top:1px solid #ccc;">${e.date}</td>
                <td style="border-top:1px solid #ccc;">${e.category}</td>
                <td style="border-top:1px solid #ccc;">${e.desc}</td>
                <td style="border-top:1px solid #ccc; text-align:right;">${e.amount.toFixed(2)}</td>
            </tr>
        `;
                });

                html += `
        <tr style="font-weight:bold; background:#f0f0f0;">
            <td colspan="3" style="text-align:right;">Summe:</td>
            <td style="text-align:right;">${total.toFixed(2)} ‚Ç¨</td>
        </tr>
        </table>
    `;
                listDiv.innerHTML = html;
            }

            // üîπ Daten l√∂schen (nach Monat/Jahr)
            function deleteExpenses() {
                const month = parseInt(document.getElementById("filterMonth").value);
                const year = parseInt(document.getElementById("filterYear").value);
                const expenses = JSON.parse(localStorage.getItem("expenses") || "[]");

                if (expenses.length === 0) return alert("Keine Daten vorhanden.");

                if (!confirm(`Soll(en) die Ausgaben f√ºr ${month === 0 ? "alle Monate" : month + ". Monat"} ${year} gel√∂scht werden?`))
                    return;

                const remaining = expenses.filter(e => {
                    const d = new Date(e.date);
                    return (d.getFullYear() !== year) || (month !== 0 && d.getMonth() + 1 !== month);
                });

                localStorage.setItem("expenses", JSON.stringify(remaining));
                updateExpenseList();
                alert("‚úÖ Ausgaben gel√∂scht!");
            }

            // üîπ Echten Excel-Export (XLSX)
            function exportExpensesToExcel() {
                const expenses = JSON.parse(localStorage.getItem("expenses") || "[]");
                if (expenses.length === 0) {
                    alert("Keine Daten zum Exportieren.");
                    return;
                }

                // Excel-Arbeitsblatt vorbereiten
                const wb = XLSX.utils.book_new();
                const wsData = [
                    ["Datum", "Kategorie", "Beschreibung", "Betrag (‚Ç¨)"],
                    ...expenses.map(e => [e.date, e.category, e.desc, e.amount])
                ];
                const ws = XLSX.utils.aoa_to_sheet(wsData);

                // Automatische Spaltenbreite
                const colWidths = [
                    { wch: 12 },
                    { wch: 20 },
                    { wch: 40 },
                    { wch: 12 }
                ];
                ws["!cols"] = colWidths;

                // Arbeitsblatt zum Workbook hinzuf√ºgen
                XLSX.utils.book_append_sheet(wb, ws, "Ausgaben");

                // üìÖ Aktuelles Datum (deutsches Format, aber f√ºr Dateinamen angepasst)
                const today = new Date();
                const dateStr = today.toLocaleDateString("de-DE").replace(/\./g, "-"); // ‚Üí "07-11-2025"

                // Datei speichern mit Datumsstempel
                XLSX.writeFile(wb, `Ausgaben_${dateStr}.xlsx`);

                alert("‚úÖ Excel-Datei mit Datum wurde erstellt!");

            }

            document.addEventListener("DOMContentLoaded", initExpenseFilters);


            // üîπ Filter initialisieren
            function initFinanceFilters() {
                const monthSel = document.getElementById("financeMonth");
                const yearSel = document.getElementById("financeYear");
                if (!monthSel || !yearSel) return;

                const months = [
                    "Alle", "Januar", "Februar", "M√§rz", "April", "Mai", "Juni",
                    "Juli", "August", "September", "Oktober", "November", "Dezember"
                ];

                monthSel.innerHTML = months.map((m, i) =>
                    `<option value="${i}">${m}</option>`).join("");

                const currentYear = new Date().getFullYear();
                let options = `<option value="">Alle</option>`;
                for (let y = currentYear; y >= currentYear - 5; y--) {
                    options += `<option value="${y}">${y}</option>`;
                }
                yearSel.innerHTML = options;
            }

            // üîπ √úbersicht aktualisieren
            function updateFinanceOverview() {

                const monthSel = document.getElementById("financeMonth");
                const yearSel = document.getElementById("financeYear");
                const m = parseInt(monthSel.value);
                const y = parseInt(yearSel.value);

                const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");
                const expenses = JSON.parse(localStorage.getItem("expenses") || "[]");

                // üü¢ NEU: Barverk√§ufe
                const sales = JSON.parse(localStorage.getItem("sales") || "[]")
                    .filter(s => !s.cancelled);

                const filterFn = (entry) => {
                    const d = new Date(entry.createdAt);
                    const mm = d.getMonth() + 1;
                    const yy = d.getFullYear();
                    if (y && yy !== y) return false;
                    if (m && mm !== m) return false;
                    return true;
                };

                const filteredInvoices = invoices.filter(inv =>
                    inv.status !== "cancelled" && filterFn(inv)
                );

                const filteredExpenses = expenses.filter(filterFn);

                // üü¢ NEU: Barverk√§ufe im Zeitraum
                // üëâ Nur Verk√§ufe OHNE Rechnung anzeigen
                const filteredSales = sales.filter(s => !s.invoiceId && filterFn(s));


                // üü¢ Einnahmen aus Rechnungen
                const invoiceRevenue = filteredInvoices.reduce(
                    (a, inv) => a + parseFloat(inv.totalAmount || 0),
                    0
                );

                // üü¢ Einnahmen aus Barverk√§ufen
                const cashRevenue = filteredSales.reduce(
                    (a, s) => a + parseFloat(s.revenue || 0),
                    0
                );

                const sumSales = invoiceRevenue + cashRevenue;

                const sumExpenses = filteredExpenses.reduce(
                    (a, e) => a + parseFloat(e.amount || 0),
                    0
                );

                const balance = sumSales - sumExpenses;

                // üßæ Anzeige
                document.getElementById("financeSummary").innerHTML =
                    `Einnahmen: <strong>${sumSales.toFixed(2)} ‚Ç¨</strong> &nbsp; | &nbsp;
         Ausgaben: <strong>${sumExpenses.toFixed(2)} ‚Ç¨</strong> &nbsp; | &nbsp;
         <span style="color:${balance >= 0 ? 'green' : 'red'};">
            Ergebnis: ${balance.toFixed(2)} ‚Ç¨
         </span>`;

                // üìã Tabelle
                let html = "<h4>Einnahmen</h4>";

                // üü¢ Rechnungen
                html += makeFinanceTable(filteredInvoices, ["Datum", "Quelle", "K√§ufer", "‚Ç¨"], true);

                // üü¢ Barverk√§ufe extra anf√ºgen
                if (filteredSales.length > 0) {
                    html += "<h5>Barverk√§ufe</h5>";
                    html += makeCashSalesTable(filteredSales);
                }

                html += "<h4>Ausgaben</h4>";
                html += makeFinanceTable(filteredExpenses, ["Datum", "Kategorie", "Beschreibung", "‚Ç¨"]);

                document.getElementById("financeTable").innerHTML = html;
            }




            function makeCashSalesTable(list) {

                if (list.length === 0) return "<em>Keine Barverk√§ufe</em>";

                let html = "<table style='width:100%; border-collapse:collapse; font-size:0.9em;'>";

                html += `
        <tr style='background:#eee;'>
            <th style='padding:4px;'>Datum</th>
            <th style='padding:4px;'>Produkt</th>
            <th style='padding:4px;'>Menge</th>
            <th style='padding:4px;'>‚Ç¨</th>
        </tr>
    `;

                list.forEach(s => {
                    html += `
            <tr>
                <td style='border-top:1px solid #ccc; padding:4px;'>
                    ${new Date(s.createdAt).toLocaleDateString()}
                </td>

                <td style='border-top:1px solid #ccc; padding:4px;'>
                    ${s.labelText || "-"}
                </td>

                <td style='border-top:1px solid #ccc; padding:4px;'>
                    ${s.bottleCount || 1}
                </td>

                <td style='border-top:1px solid #ccc; padding:4px; text-align:right;'>
                    ${parseFloat(s.revenue || 0).toFixed(2)}
                </td>
            </tr>
        `;
                });

                html += "</table>";
                return html;
            }





            // üî∏ Hilfsfunktion: Tabelle rendern (f√ºr Einnahmen & Ausgaben)
            function makeFinanceTable(list, headers, isSales = false) {
                if (list.length === 0) return "<em>Keine Eintr√§ge</em>";

                let html = "<table style='width:100%; border-collapse:collapse; font-size:0.9em;'>";
                html += "<tr style='background:#ddd;'>" +
                    headers.map(h => `<th style='padding:4px;'>${h}</th>`).join("") +
                    "</tr>";

                list.forEach(e => {
                    if (isSales) {
                        // üí∞ Einnahmen-Tabelle mit Verkaufssumme
                        html += `<tr>
                            <td style='border-top:1px solid #ccc; padding:4px;'>${new Date(e.createdAt).toLocaleDateString()}</td>
                            <td style='border-top:1px solid #ccc; padding:4px;'>Rechnung ${e.invoiceNumber}</td>
                            <td style='border-top:1px solid #ccc; padding:4px;'>${e.buyer?.name || "-"}</td>
                            <td style='border-top:1px solid #ccc; padding:4px; text-align:right;'>${parseFloat(e.totalAmount || 0).toFixed(2)}</td>
                        </tr>`;
                    } else {
                        // üìâ Ausgaben-Tabelle
                        html += `<tr>
                            <td style='border-top:1px solid #ccc; padding:4px;'>${e.date}</td>
                            <td style='border-top:1px solid #ccc; padding:4px;'>${e.category || "-"}</td>
                            <td style='border-top:1px solid #ccc; padding:4px;'>${e.desc || "-"}</td>
                            <td style='border-top:1px solid #ccc; padding:4px; text-align:right;'>${parseFloat(e.amount || 0).toFixed(2)}</td>
                        </tr>`;
                    }
                });

                html += "</table>";
                return html;
            }


            // üîπ Excel-Export mit Datumsstempel
            function exportFinanceToExcel() {

                const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");
                const expenses = JSON.parse(localStorage.getItem("expenses") || "[]");
                const sales = JSON.parse(localStorage.getItem("sales") || "[]");

                const wb = XLSX.utils.book_new();

                // ==========================
                //   üìä EINNAHMEN
                // ==========================

                // 1Ô∏è‚É£ Rechnungen
                const invoiceRows = invoices
                    .filter(inv => inv.status !== "cancelled")
                    .map(inv => ({
                        Datum: new Date(inv.createdAt).toLocaleDateString("de-DE"),
                        Quelle: "Rechnung " + inv.invoiceNumber,
                        K√§ufer: inv.buyer?.name || "",
                        Produkt: inv.items?.[0]?.description || "",
                        Betrag_EUR: Number(inv.totalAmount || 0)
                    }));

                // 2Ô∏è‚É£ Barverk√§ufe = sales OHNE invoiceId
                const cashRows = sales
                    .filter(s => !s.invoiceId && !s.cancelled)
                    .map(s => ({
                        Datum: new Date(s.createdAt).toLocaleDateString("de-DE"),
                        Quelle: "Barverkauf",
                        K√§ufer: "",
                        Produkt: s.labelText || "",
                        Betrag_EUR: Number(s.revenue || 0)
                    }));

                // 3Ô∏è‚É£ Zusammenf√ºhren
                const incomeRows = [...invoiceRows, ...cashRows];

                const wsIncome = XLSX.utils.json_to_sheet(incomeRows);
                XLSX.utils.book_append_sheet(wb, wsIncome, "Einnahmen");


                // ==========================
                //   üìâ AUSGABEN
                // ==========================

                const wsExpenses = XLSX.utils.json_to_sheet(
                    expenses.map(e => ({
                        Datum: e.date,
                        Kategorie: e.category || "",
                        Beschreibung: e.desc || "",
                        Betrag_EUR: Number(e.amount || 0)
                    }))
                );

                XLSX.utils.book_append_sheet(wb, wsExpenses, "Ausgaben");


                // ==========================
                //   üíæ DATEI SPEICHERN
                // ==========================

                const today = new Date();
                const dateStr = today.toLocaleDateString("de-DE").replace(/\./g, "-");

                XLSX.writeFile(wb, `Finanz√ºbersicht_${dateStr}.xlsx`);

                alert("‚úÖ Excel-Datei 'Finanz√ºbersicht' wurde erfolgreich erstellt!");
            }






            // üì§ Backup exportieren
            function exportBackup() {
                const data = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    data[key] = localStorage.getItem(key);
                }

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
                a.download = `Brennereimanager_G√§rprotokolle_Backup_${timestamp}.json`;
                a.click();
                URL.revokeObjectURL(url);

                alert("‚úÖ Backup wurde als JSON-Datei gespeichert.");
            }

            // üì• Backup importieren
            function importBackup(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data || typeof data !== "object") {
                            alert("‚ùå Ung√ºltige Backup-Datei.");
                            return;
                        }

                        if (!confirm("‚ö†Ô∏è Bestehende Daten werden √ºberschrieben. Fortfahren?")) return;

                        localStorage.clear();
                        for (const [key, value] of Object.entries(data)) {
                            localStorage.setItem(key, value);
                        }

                        alert("‚úÖ Backup erfolgreich importiert! Die App wird neu geladen.");
                        location.reload();
                    } catch (err) {
                        console.error(err);
                        alert("‚ùå Fehler beim Importieren der Backup-Datei.");
                    }
                };
                reader.readAsText(file);
            }

            function normalizeStorageFruitData() {
                const keys = Object.keys(localStorage).filter(k => k.startsWith("storage_"));

                keys.forEach(k => {
                    const s = JSON.parse(localStorage.getItem(k));
                    let changed = false;

                    if (s.contents && Array.isArray(s.contents)) {
                        s.contents.forEach(c => {
                            if (!c.fruitData) {
                                // Falls alte Struktur ‚Üí Frucht extrahieren
                                let fr = (c.fruit || "").trim();

                                // "(3,6)" entfernen
                                fr = fr.replace(/\(\s*\d+[\.,]?\d*\s*\)/g, "").trim();

                                if (fr === "") fr = "Unbekannt";

                                // Neues fruitData-Mapping anlegen (100% des Eintrags)
                                c.fruitData = {};
                                c.fruitData[fr] = parseFloat(c.volume) || 0;

                                changed = true;
                            }
                        });
                    }

                    if (changed) {
                        localStorage.setItem(k, JSON.stringify(s));
                    }
                });
            }


            // =============================================
            //  Rezepte / Mischungen ‚Äì Advanced, ohne Versionierung
            // =============================================

            const RECIPE_KEY = "recipes";
            const RECIPE_BATCH_KEY = "recipeBatches"; // { [recipeId]: [batch, batch, ...] }

            // üîπ Hilfsfunktionen f√ºr LocalStorage
            function recipeLoadAll() {
                try {
                    return JSON.parse(localStorage.getItem(RECIPE_KEY) || "[]");
                } catch (e) {
                    console.warn("‚ö†Ô∏è Konnte Rezepte nicht laden:", e);
                    return [];
                }
            }

            function recipeSaveAll(list) {
                localStorage.setItem(RECIPE_KEY, JSON.stringify(list || []));
            }

            function recipeLoadBatches() {
                try {
                    return JSON.parse(localStorage.getItem(RECIPE_BATCH_KEY) || "{}");
                } catch (e) {
                    console.warn("‚ö†Ô∏è Konnte Batches nicht laden:", e);
                    return {};
                }
            }

            function recipeSaveBatches(map) {
                localStorage.setItem(RECIPE_BATCH_KEY, JSON.stringify(map || {}));
            }

            function recipeToday() {
                return new Date().toISOString().split("T")[0];
            }

            function recipeResetAutocomplete() {
                // alle Autocomplete-Listen schlie√üen
                document.querySelectorAll(".autocomplete-list").forEach(l => l.style.display = "none");
            }

            function recipeUpdateMashWaterVisibility() {
                const type = document.getElementById("recipeType").value;

                const mashRow = document.getElementById("mashWaterRow");
                const targetUnitHint = document.getElementById("recipeTargetUnitHint");

                if (!mashRow || !targetUnitHint) return;

                // --- Mash-Rezept ---
                if (type === "mash") {
                    mashRow.style.display = "block";
                    targetUnitHint.textContent = "Menge in kg Sch√ºttung (optional)";
                }

                // --- Prozent-Rezept ---
                else if (type === "percent") {
                    mashRow.style.display = "none";
                    targetUnitHint.textContent = "Menge in Liter (Prozent-Rezept)";

                    // Mash-Felder leeren
                    const w = document.getElementById("recipeMashWaterRatio");
                    const s = document.getElementById("recipeSpargeRatio");
                    if (w) w.value = "";
                    if (s) s.value = "";
                }

                // --- Aroma-/Gewichtsrezept ---
                else if (type === "aroma") {
                    mashRow.style.display = "none";
                    targetUnitHint.textContent = "Menge (g oder Anteile ‚Äì optional)";

                    // Mash-Felder leeren
                    const w = document.getElementById("recipeMashWaterRatio");
                    const s = document.getElementById("recipeSpargeRatio");
                    if (w) w.value = "";
                    if (s) s.value = "";
                }

                // Optional: Anzeige der berechneten Zutaten resetten
                recipeClearComputedAmounts();
            }




            // =============================================
            //  Initialisierung
            // =============================================
            function initRecipeModule() {
                document.getElementById("recipeType").addEventListener("change", () => {
                    recipeResetAutocomplete();
                    recipeUpdateUnitHeader();
                    recipeClearComputedAmounts();
                    recipeUpdateMashWaterVisibility();
                });

                recipeResetForm();
                recipeRenderList();

                // Batch-Box erst mal ausblenden
                const box = document.getElementById("recipeApplyBox");
                if (box) box.style.display = "none";

                document.getElementById("recipeType").addEventListener("change", () => {
                    const type = document.getElementById("recipeType").value;
                    const box = document.getElementById("recipeApplyBox");
                    const hint = document.getElementById("recipeTypeHint");

                    if (box) box.style.display = "none";
                    if (hint) hint.style.display = "none";

                    // Prozent-Rezept ‚Üí Batch anwenden
                    if (type === "percent") {
                        if (box) box.style.display = "block";
                    }

                    // Aroma-Rezept ‚Üí Hinweis anzeigen
                    else if (type === "aroma") {
                        if (hint) {
                            hint.innerHTML = `
                <strong>Hinweis:</strong><br>
                Dieses Aromarezept beschreibt <em>Verh√§ltnisse und Zusammensetzung</em>.<br>
                Die Anwendung erfolgt in der <strong>Produktions- / Mazerationsseite</strong>.
            `;
                            hint.style.display = "block";
                        }
                    }

                    // Mash-Rezept ‚Üí Hinweis anzeigen
                    else if (type === "mash") {
                        if (hint) {
                            hint.innerHTML = `
                                <strong>Hinweis:</strong><br>
                                Dieses Rezept definiert <em>Zusammensetzung und Prozessparameter</em>.<br>
                                Die Anwendung erfolgt im <strong>Produktionsprozess</strong> (z. B. bei der Maische- oder Ansatzherstellung).
                            `;
                            hint.style.display = "block";
                        }
                    }

                });





                // üîΩ NEU ‚Äì Trigger f√ºr Live-Berechnung
                setupRecipeLiveListeners();

                // Optional: zus√§tzlichen Button "auf Lager anwenden" dynamisch einf√ºgen
                const applyBox = document.getElementById("recipeApplyBox");
                if (applyBox && !document.getElementById("btnApplyRecipeToStorage")) {
                    const btn = document.createElement("button");
                    btn.id = "btnApplyRecipeToStorage";
                    btn.type = "button";
                    btn.textContent = "üçæ Rezept auf Lager anwenden";
                    btn.style.marginBlock = "8px";
                    btn.onclick = recipeApplyToStorage;

                    const refBtn = applyBox.querySelector("button[onclick='recipeComputeBatch()']");
                    if (refBtn && refBtn.parentNode) {
                        refBtn.parentNode.insertBefore(btn, refBtn.nextSibling);
                    } else {
                        applyBox.appendChild(btn);
                    }

                    //document.getElementById("recipeTargetVolume")
                    //.addEventListener("input", recipeRecalculateIngredientLiters);

                    document.getElementById("recipeType")
                        .addEventListener("change", () => {
                            recipeClearComputedAmounts();
                            //recipeRecalculateIngredientLiters();
                        });

                }
                recipeUpdateTypeInfo();
            }

            // =============================================
            //  Formular / Editor
            // =============================================
            function recipeResetForm() {
                document.getElementById("recipeId").value = "";
                document.getElementById("recipeVersion").value = "";
                document.getElementById("recipeName").value = "";
                document.getElementById("recipeDescription").value = "";
                document.getElementById("recipeType").value = "percent";
                document.getElementById("recipeTargetVolume").value = "";
                document.getElementById("recipeTargetStrength").value = "";
                document.getElementById("recipeValidationMessage").textContent = "";
                document.getElementById("recipeApplyBox").style.display = "none";
                document.getElementById("applyBatchResult").innerHTML = "";
                document.getElementById("recipeBatchHistory").innerHTML = "<em>Noch keine Batches gespeichert.</em>";
                document.getElementById("recipeMashWaterRatio").value = "";
                document.getElementById("recipeSpargeRatio").value = ""

                // Mash-Einstellungen zur√ºcksetzen & verstecken
                const mashBox = document.getElementById("mashSettings");
                if (mashBox) mashBox.style.display = "none";
                const mashRatioInput = document.getElementById("recipeMashWaterRatio");
                const mashPercRatio = document.getElementById("recipeSpargeRatio");
                if (mashRatioInput) mashRatioInput.value = "";
                if (mashPercRatio) mashPercRatio.value = "";

                // Zutaten-Tabelle leeren + 2 leere Zeilen
                const tbody = document.getElementById("recipeIngredientsBody");
                tbody.innerHTML = "";
                recipeAddIngredientRow();
                recipeAddIngredientRow();
                recipeUpdateUnitHeader();
                recipeUpdateTypeInfo();
                recipeUpdateMashWaterVisibility();

            }


            function recipeUpdateUnitHeader() {
                recipeClearComputedAmounts();
            }

            function recipeUpdateTypeInfo() {
                const type = document.getElementById("recipeType").value;
                const box = document.getElementById("recipeTypeInfo");
                if (!box) return;

                let html = "";

                if (type === "percent") {
                    html = `
        <strong>Prozent-Rezept:</strong><br>
        F√ºr Mischungen aus vorhandenen Destillaten (z. B. Obstbrand, Geist, Kr√§uterbrand).<br><br>
        ‚Ä¢ Die Anteile m√ºssen <strong>zusammen 100 %</strong> ergeben.<br>
        ‚Ä¢ Zielmenge (L) = Endvolumen der Rohmischung (ohne Wasser).<br>
        ‚Ä¢ Wasserzugabe & Trinkst√§rke werden <strong>automatisch beim Anwenden</strong> berechnet.<br>
        ‚Ä¢ Die Liter-Anteile ergeben sich aus der Zielmenge.
        `;
                }

                else if (type === "aroma") {
                    html = `
        <strong>Aroma-/Gewichtsrezept:</strong><br>
        F√ºr Gin-Botanicals oder Kr√§utermischungen.<br><br>
        ‚Ä¢ Die Anteile sind <strong>Gewichtungen</strong> (z. B. 5 g, 10 g, 1 Teil ‚Ä¶).<br>
        ‚Ä¢ Sie m√ºssen nicht 100 ergeben ‚Äî nur relative Verh√§ltnisse.<br>
        ‚Ä¢ Zielmenge (L) beschreibt die Menge <strong>Tr√§geralkohol</strong>, die aromatisiert wird.<br>
        ‚Ä¢ Die Literangaben unten sind <strong>nur Verh√§ltniswerte</strong>, keine echten Liter.
        `;
                }

                else if (type === "mash") {
                    html = `
        <strong>Mash-/Malzrezept:</strong><br>
        F√ºr Whisky, Korn oder andere Getreidemaischen.<br><br>
        ‚Ä¢ Die Anteile sind <strong>kg-Angaben</strong> der Malzsorten.<br>
        ‚Ä¢ Zielmenge (kg) ist die <strong>Gesamtmalzmenge</strong> der Sch√ºttung.<br>
        ‚Ä¢ Die Liter-Werte unten zeigen die prozentuale Verteilung.<br>
        ‚Ä¢ Wasserzugabe, Stammw√ºrze und G√§rvolumen werden sp√§ter separat berechnet.
        `;
                }

                box.innerHTML = html;
            }




            function recipeComputePreview() {
                const type = document.getElementById("recipeType").value;
                const target = parseFloat(document.getElementById("recipeTargetVolume").value) || 0;

                let unit = "L";
                if (type === "aroma") unit = "g";
                if (type === "mash") unit = "kg";

                // alte Tabelle unten entfernen, falls vorhanden
                let box = document.getElementById("recipePreviewBox");
                if (!box) {
                    box = document.createElement("div");
                    box.id = "recipePreviewBox";
                    box.style.marginTop = "6px";
                    box.style.fontSize = "0.9em";
                    box.style.background = "#f3f4f6";
                    box.style.padding = "6px";
                    box.style.borderRadius = "6px";
                    document.getElementById("recipeIngredients").after(box);
                }

                const rows = Array.from(document.querySelectorAll("#recipeIngredientsBody tr"));
                const parts = rows.map(r => {
                    const inputs = r.querySelectorAll("input");
                    const name = inputs[0].value.trim();
                    const amount = parseFloat(inputs[1].value);
                    return { name, amount };
                }).filter(x => x.name && x.amount > 0);

                if (parts.length === 0 || target <= 0) {
                    box.innerHTML = "<em>Bitte Zielmenge und Anteile eingeben.</em>";
                    return;
                }

                let total = (type === "percent")
                    ? 100
                    : parts.reduce((a, b) => a + b.amount, 0);

                let html = "<strong>Berechnete Mengen:</strong><br><table>";
                parts.forEach(p => {
                    const fraction = (type === "percent") ? p.amount / 100 : p.amount / total;
                    const value = fraction * target;
                    html += `<tr><td>${p.name}</td><td style="text-align:right;">${value.toFixed(2)} ${unit}</td></tr>`;
                });
                html += "</table>";

                box.innerHTML = html;
            }





            function recipeAddIngredientRow(initial) {
                const tbody = document.getElementById("recipeIngredientsBody");
                const tr = document.createElement("tr");

                /* --- SPALTENBREITEN GLOBAL FESTLEGEN --- */
                tr.style.gridTemplateColumns = "55% 25% 20%";

                /* ========== ZUTAT-SPALTE (AUTOCOMPLETE) ========== */
                const nameTd = document.createElement("td");
                nameTd.style.position = "relative";

                const nameInput = document.createElement("input");
                nameInput.type = "text";
                nameInput.className = "ingredientInput";
                nameInput.placeholder = "Zutat ausw√§hlen‚Ä¶";
                nameInput.style.width = "100%";
                nameInput.style.boxSizing = "border-box";

                if (initial && initial.name) nameInput.value = initial.name;

                // Dropdown-Container
                const list = document.createElement("div");
                list.className = "autocomplete-list";
                list.style.display = "none";

                nameTd.appendChild(nameInput);
                nameTd.appendChild(list);

                /* --- NEU: Zutatenquelle abh√§ngig vom Rezept-Typ --- */
                function getIngredientPool() {
                    const type = document.getElementById("recipeType").value;

                    if (type === "percent") return recipeGetAllFruits();
                    if (type === "aroma") return recipeGetAromaList();
                    if (type === "mash") return recipeGetMashList();

                    return [];
                }

                /* --- Dropdown komplett anzeigen --- */
                function showAllItems() {
                    const pool = getIngredientPool();
                    list.innerHTML = "";

                    pool.forEach(item => {
                        const div = document.createElement("div");
                        div.textContent = item;
                        div.onclick = () => {
                            nameInput.value = item;
                            list.style.display = "none";
                        };
                        list.appendChild(div);
                    });

                    list.style.display = pool.length ? "block" : "none";
                }

                /* --- Live-Filter --- */
                nameInput.addEventListener("input", () => {
                    const value = nameInput.value.toLowerCase();
                    const pool = getIngredientPool().filter(x => x.toLowerCase().includes(value));

                    list.innerHTML = "";
                    pool.forEach(item => {
                        const div = document.createElement("div");
                        div.textContent = item;
                        div.onclick = () => {
                            nameInput.value = item;
                            list.style.display = "none";
                        };
                        list.appendChild(div);
                    });

                    list.style.display = pool.length ? "block" : "none";
                });

                /* --- √ñffnen bei Fokus --- */
                nameInput.addEventListener("focus", showAllItems);

                /* --- Schlie√üen bei Klick au√üerhalb --- */
                document.addEventListener("click", e => {
                    if (!nameTd.contains(e.target)) list.style.display = "none";
                });

                /* ========== ANTEIL-SPALTE ========== */
                const amountTd = document.createElement("td");
                amountTd.style.textAlign = "right";

                const amountInput = document.createElement("input");
                amountInput.type = "number";
                amountInput.step = "0.1";
                amountInput.style.width = "70px";

                if (initial && initial.amount != null) amountInput.value = initial.amount;

                amountTd.appendChild(amountInput);

                /* ========== L√ñSCH-SPALTE ========== */
                const actionTd = document.createElement("td");
                actionTd.style.textAlign = "center";

                const delBtn = document.createElement("button");
                delBtn.type = "button";
                delBtn.textContent = "‚úñ";
                delBtn.onclick = () => tbody.removeChild(tr);

                actionTd.appendChild(delBtn);

                /* ========== ZUSAMMENBAU ========== */
                tr.appendChild(nameTd);
                tr.appendChild(amountTd);
                tr.appendChild(actionTd);

                tbody.appendChild(tr);
            }



            function recipeGetAromaList() {
                return [
                    "Wacholderbeeren",
                    "Koriandersamen",
                    "Angelikawurzel",
                    "Veilchenwurzel (Orris Root)",
                    "S√º√üholzwurzel",
                    "Zimt",
                    "Cassia-Rinde",
                    "Kardamom",
                    "Muskatnuss",
                    "Anis",
                    "Fenchel",
                    "K√ºmmel",
                    "Paradiesk√∂rner",
                    "Schwarzer Pfeffer",
                    "Rosa Pfeffer",
                    "Ingwer",
                    "Kurkuma",
                    "Chili",
                    "Zitronenschale",
                    "Orangenschale",
                    "Grapefruitschale",
                    "Limettenschale",
                    "Mandarinenschale",
                    "Apfel",
                    "Birne",
                    "Quitte",
                    "Himbeere",
                    "Brombeere",
                    "Holunderbeere",
                    "Holunderbl√ºte",
                    "Lavendel",
                    "Kamille",
                    "Rosenbl√§tter",
                    "Hibiskus",
                    "Jasmin",
                    "Minze",
                    "Melisse",
                    "Rosmarin",
                    "Thymian",
                    "Basilikum",
                    "Salbei",
                    "Lorbeer",
                    "Olive",
                    "Gurke",
                    "Kaffee",
                    "Kakao",
                    "Gr√ºntee",
                    "Earl Grey Tee",
                    "Algen",
                    "Mandel"
                ];
            }

            function recipeGetMashList() {
                return [
                    "Pilsner Malz",
                    "M√ºnchner Malz",
                    "Wiener Malz",
                    "Pale Ale Malz",
                    "Maris Otter",
                    "Golden Promise",
                    "Distilling Malt",
                    "Weizenmalz hell",
                    "Weizenmalz dunkel",
                    "Roggenmalz",
                    "Hafermalz",
                    "Gerstenmalz unverm√§lzt",
                    "Melanoidinmalz",
                    "CaraHell",
                    "CaraRed",
                    "CaraAmber",
                    "CaraMunich I",
                    "CaraMunich II",
                    "CaraMunich III",
                    "CaraAroma",
                    "Carafa I",
                    "Carafa II",
                    "Carafa III",
                    "Chocolate Malt",
                    "Brown Malt",
                    "Amber Malt",
                    "Black Malt",
                    "Roasted Barley",
                    "Peated Malt",
                    "Special B",
                    "Crystal Light",
                    "Crystal Medium",
                    "Crystal Dark",
                    "Honey Malt",
                    "Biscuit Malt",
                    "Aromatic Malt",
                    "Victory Malt",
                    "Red X",
                    "Acidulated Malt",
                    "Dextrin Malt",
                    "Oat Malt",
                    "Rye Crystal",
                    "Wheat Crystal",
                    "Peated Distilling Malt",
                    "Smoked Malt (Buche)",
                    "Smoked Malt (Eiche)",
                    "Smoked Malt (Torf)",
                    "Melanoidin Light",
                    "Melanoidin Dark",
                    "CaraBohemian"
                ];
            }






            function recipeCollectFromForm() {
                const name = document.getElementById("recipeName").value.trim();
                const desc = document.getElementById("recipeDescription").value.trim();
                const type = document.getElementById("recipeType").value;
                const targetVolume = parseFloat(document.getElementById("recipeTargetVolume").value);
                const targetStrength = parseFloat(document.getElementById("recipeTargetStrength").value);
                const validation = document.getElementById("recipeValidationMessage");

                // -----------------------------
                // Mash-Water + Sparge-Water
                // -----------------------------
                let mashWaterRatio = null;
                let spargeRatio = null;

                if (type === "mash") {
                    const r = parseFloat(document.getElementById("recipeMashWaterRatio").value);
                    mashWaterRatio = isNaN(r) ? null : r;

                    const s = parseFloat(document.getElementById("recipeSpargeRatio").value);
                    // Nutzer gibt 60 ein ‚Üí speichern 0.60
                    spargeRatio = isNaN(s) ? 0.6 : (s / 100);
                }

                // -----------------------------
                // Basis-Validierungen
                // -----------------------------
                if (!name) {
                    validation.textContent = "Bitte einen Rezeptnamen eingeben.";
                    return null;
                }

                // -----------------------------
                // Zutaten einlesen
                // -----------------------------
                const tbody = document.getElementById("recipeIngredientsBody");
                const rows = Array.from(tbody.querySelectorAll("tr"));

                const ingredients = [];
                let sumPercent = 0;

                rows.forEach(tr => {
                    const inputs = tr.querySelectorAll("input");
                    if (inputs.length < 2) return;

                    const inName = inputs[0].value.trim();
                    const inAmount = parseFloat(inputs[1].value);

                    if (!inName || isNaN(inAmount) || inAmount <= 0) return;

                    ingredients.push({
                        name: inName,
                        amount: inAmount
                    });

                    if (type === "percent" || type === "mash") {
                        sumPercent += inAmount;
                    }
                });

                if (ingredients.length === 0) {
                    validation.textContent = "Bitte mindestens eine g√ºltige Zutat eintragen.";
                    return null;
                }

                // -----------------------------
                // Prozent-Validierung NUR f√ºr Obst-/Prozentrezepte
                // -----------------------------
                if (type === "percent") {
                    const diff = Math.abs(sumPercent - 100);
                    if (diff > 0.01) {
                        validation.textContent =
                            `Bei Prozent-Rezepten muss die Summe 100 % ergeben ` +
                            `(aktuell: ${sumPercent.toFixed(1)} %).`;
                        return null;
                    }
                }


                validation.textContent = "";

                // -----------------------------
                // R√ºckgabeobjekt
                // -----------------------------
                const id = document.getElementById("recipeId").value.trim();
                const version = document.getElementById("recipeVersion").value.trim();

                return {
                    id: id || null,
                    name,
                    description: desc,
                    type,
                    targetVolume: isNaN(targetVolume) ? null : targetVolume,
                    targetStrength: isNaN(targetStrength) ? null : targetStrength,
                    mashWaterRatio,
                    spargeRatio,                 // ‚≠ê WICHTIG NEU
                    ingredients,
                    version: version || null
                };
            }



            function recipeSave() {
                const data = recipeCollectFromForm();
                if (!data) return;

                let list = recipeLoadAll();
                let now = recipeToday();

                // SpargeRatio immer absichern (f√ºr Mash n√∂tig)
                if (data.spargeRatio == null || isNaN(data.spargeRatio)) {
                    data.spargeRatio = 0.6;
                }

                // ---------------------------------------------
                // NEUES REZEPT ANLEGEN
                // ---------------------------------------------
                if (!data.id) {
                    const newId = "recipe_" + Date.now();

                    const recipe = {
                        id: newId,
                        name: data.name,
                        description: data.description,
                        type: data.type,
                        ingredients: data.ingredients,
                        mashWaterRatio: data.mashWaterRatio,
                        spargeRatio: data.spargeRatio,
                        version: "1.0",
                        created: now,
                        updated: now
                    };

                    // üî• Nur f√ºr obst & mash Rezepte Target-Werte speichern
                    if (data.type === "fruit" || data.type === "mash") {
                        recipe.targetVolume = data.targetVolume;
                        recipe.targetStrength = data.targetStrength;
                    }

                    list.push(recipe);
                    recipeSaveAll(list);

                    document.getElementById("recipeId").value = newId;
                    document.getElementById("recipeVersion").value = "1.0";

                    alert("‚úÖ Rezept angelegt.");
                    recipeRenderList();
                    return;
                }


                // ---------------------------------------------
                // EXISTIERENDES REZEPT AKTUALISIEREN
                // ---------------------------------------------
                const id = data.id;
                let updated = false;

                list = list.map(r => {
                    if (r.id !== id) return r;

                    let newVersion = "1.0";
                    if (r.version) {
                        const v = parseFloat(r.version);
                        if (!isNaN(v)) newVersion = (v + 0.1).toFixed(1);
                    }

                    const updatedRecipe = {
                        ...r,
                        name: data.name,
                        description: data.description,
                        type: data.type,
                        ingredients: data.ingredients,
                        mashWaterRatio: data.mashWaterRatio,
                        spargeRatio: data.spargeRatio,
                        version: newVersion,
                        updated: now
                    };

                    // üî• Target-Werte nur bei Obst + Maische behalten
                    if (data.type === "fruit" || data.type === "mash") {
                        updatedRecipe.targetVolume = data.targetVolume;
                        updatedRecipe.targetStrength = data.targetStrength;
                    } else {
                        // üî• Aroma ‚Üí Zielwerte l√∂schen, damit kein M√ºll gespeichert wird
                        delete updatedRecipe.targetVolume;
                        delete updatedRecipe.targetStrength;
                    }

                    updated = true;
                    document.getElementById("recipeVersion").value = newVersion;
                    return updatedRecipe;
                });

                if (updated) {
                    recipeSaveAll(list);
                    alert("‚úÖ Rezept aktualisiert.");
                } else {
                    alert("‚ö†Ô∏è Rezept wurde nicht gefunden ‚Äì bitte neu anlegen.");
                }

                recipeRenderList();
            }



            // =============================================
            //  Rezeptliste gruppiert anzeigen
            // =============================================
            function recipeRenderList() {
                const container = document.getElementById("recipeListContainer");
                const list = recipeLoadAll();

                if (!container) return;

                if (!list || list.length === 0) {
                    container.innerHTML = "<em>Noch keine Rezepte gespeichert.</em>";
                    return;
                }

                // -------------------------------
                // Gruppen definieren
                // -------------------------------
                const groups = {
                    percent: {
                        title: "üçé Destillat / Fr√ºchte",
                        color: "#b22222",
                        items: []
                    },
                    aroma: {
                        title: "üåø Botanicals / Aroma",
                        color: "#006400",
                        items: []
                    },
                    mash: {
                        title: "üåæ Maische / Malz / Whisky",
                        color: "#8b4513",
                        items: []
                    },
                    other: {
                        title: "üì¶ Sonstige Rezepte",
                        color: "#555",
                        items: []
                    }
                };

                // -------------------------------
                // Rezepte in Gruppen verteilen
                // -------------------------------
                list.forEach(r => {
                    if (r.type === "percent") groups.percent.items.push(r);
                    else if (r.type === "aroma") groups.aroma.items.push(r);
                    else if (r.type === "mash") groups.mash.items.push(r);
                    else groups.other.items.push(r);
                });

                // -------------------------------
                // HTML f√ºr jede Gruppe erzeugen
                // -------------------------------
                let html = "";

                for (const key in groups) {
                    const g = groups[key];
                    const count = g.items.length;
                    if (count === 0) continue;

                    html += `
                        <div class="accordion-group">
                            <div class="accordion-header" style="color:${g.color};"
                                onclick="toggleAccordion(this)">
                                ${g.title} (${count})
                                <span style="font-size:1.2em;">‚ñ∂Ô∏è</span>
                            </div>

                            <div class="accordion-content">
                    `;


                    // Rezeptkarten einf√ºgen
                    g.items.forEach(r => {
                        const desc = r.description ? r.description : "";
                        const ingShort = (r.ingredients || [])
                            .map(i => i.name + " " + i.amount + ((r.type === "percent" || r.type === "mash") ? "%" : ""))
                            .join(", ");

                        let typeText = "Prozent-Rezept";
                        if (r.type === "aroma") typeText = "Aroma-/Gewichtungsrezept";
                        else if (r.type === "mash") typeText = "Maischerezept";

                        html += `
                            <div style="border:1px solid #ddd; border-radius:6px; padding:8px; margin-bottom:8px;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div>
                                        <strong>${r.name}</strong><br>
                                        <span style="font-size:0.9em; color:#555;">
                                            Typ: ${typeText},
                                            Version: ${r.version || "1.0"}
                                        </span>
                                    </div>
                                    <div style="font-size:0.8em; text-align:right; color:#555;">
                                        Erstellt: ${r.created || "-"}<br>
                                        Ge√§ndert: ${r.updated || "-"}
                                    </div>
                                </div>

                    ${desc ? `<div style="margin-top:4px; font-size:0.9em;">${desc}</div>` : ""}

                                <div style="margin-top:4px; font-size:0.9em;">
                                    <strong>Zutaten:</strong> ${ingShort}
                                </div>

                                <div style="margin-top:6px; display:flex; flex-wrap:wrap; gap:6px;">
                                    <button type="button" onclick="recipeLoadIntoForm('${r.id}')">‚úèÔ∏è Bearbeiten</button>
                                    <button type="button" onclick="recipeDuplicate('${r.id}')">üìÑ Duplizieren</button>
                                    <button type="button" onclick="recipeApplySmart('${r.id}')">
                                        ${r.type === "percent"
                                ? "üß™ Anwenden (Batch)"
                                : "‚û°Ô∏è Zur Produktion"}
                                    </button>
                                    <button type="button" onclick="recipeExportSingle('${r.id}')">üì§ Exportieren</button>
                                    <button type="button" onclick="recipeDelete('${r.id}')">üóëÔ∏è L√∂schen</button>
                                </div>
                            </div>
                        `;
                    });

                    html += `
                            </div> 
                        </div>
                    `;
                }

                container.innerHTML = html;
            }


            function toggleAccordion(header) {
                // Alle anderen Accordion-Bereiche schlie√üen
                document.querySelectorAll('.accordion-content').forEach(c => {
                    if (c !== header.nextElementSibling) {
                        c.style.display = 'none';
                    }
                });

                // Eigene Gruppe umschalten (auf/zu)
                const content = header.nextElementSibling;
                content.style.display = (content.style.display === 'block') ? 'none' : 'block';
            }







            // =============================================
            //  Einzelaktionen
            // =============================================
            function recipeLoadIntoForm(id) {
                const list = recipeLoadAll();
                const r = list.find(x => x.id === id);
                if (!r) {
                    alert("Rezept nicht gefunden.");
                    return;
                }

                document.getElementById("recipeId").value = r.id;
                document.getElementById("recipeVersion").value = r.version || "1.0";
                document.getElementById("recipeName").value = r.name || "";
                document.getElementById("recipeDescription").value = r.description || "";
                document.getElementById("recipeType").value = r.type || "percent";
                recipeUpdateTypeInfo();
                document.getElementById("recipeTargetVolume").value = r.targetVolume || "";
                document.getElementById("recipeTargetStrength").value = r.targetStrength || "";
                document.getElementById("recipeValidationMessage").textContent = "";

                // Mash-Einstellungen setzen
                const mashRatioInput = document.getElementById("recipeMashWaterRatio");
                if (mashRatioInput) mashRatioInput.value = r.mashWaterRatio != null ? r.mashWaterRatio : "";
                recipeUpdateUnitHeader();
                recipeUpdateMashWaterVisibility();

                const tbody = document.getElementById("recipeIngredientsBody");
                tbody.innerHTML = "";
                (r.ingredients || []).forEach(i => {
                    recipeAddIngredientRow({ name: i.name, amount: i.amount });
                });
                if ((r.ingredients || []).length === 0) {
                    recipeAddIngredientRow();
                }

                recipeClearComputedAmounts();

                // Batch-Historie laden
                recipeRenderBatchHistory(r.id);
            }


            function recipeDuplicate(id) {
                const list = recipeLoadAll();
                const r = list.find(x => x.id === id);
                if (!r) return alert("Rezept nicht gefunden.");

                const now = recipeToday();

                const copy = {
                    ...r,
                    id: "recipe_" + Date.now(),
                    name: r.name + " (Kopie)",
                    created: now,
                    updated: now
                };

                list.push(copy);
                recipeSaveAll(list);
                recipeRenderList();
                alert("‚úÖ Rezept dupliziert.");
            }

            function recipeDelete(id) {
                if (!confirm("Soll dieses Rezept wirklich gel√∂scht werden?")) return;
                let list = recipeLoadAll();
                list = list.filter(r => r.id !== id);
                recipeSaveAll(list);

                const batches = recipeLoadBatches();
                if (batches[id]) {
                    delete batches[id];
                    recipeSaveBatches(batches);
                }

                recipeRenderList();
                recipeResetForm();
            }

            // =============================================
            //  Export einzelnes Rezept (JSON)
            // =============================================
            function recipeExportSingle(id) {
                const list = recipeLoadAll();
                const r = list.find(x => x.id === id);
                if (!r) return alert("Rezept nicht gefunden.");

                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(r, null, 2));
                const a = document.createElement("a");
                a.setAttribute("href", dataStr);
                a.setAttribute("download", (r.name || "Rezept") + ".json");
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }

            // =============================================
            //  Batch-Report (theoretisch, ohne Lagerbewegung)
            // =============================================
            function recipeOpenApply(id) {
                const list = recipeLoadAll();
                const r = list.find(x => x.id === id);
                if (!r) return alert("Rezept nicht gefunden.");

                document.getElementById("recipeId").value = r.id;
                const verEl = document.getElementById("recipeVersion");
                if (verEl) verEl.value = "";

                document.getElementById("applyRecipeName").textContent = r.name;
                const verSpan = document.getElementById("applyRecipeVersion");
                if (verSpan) verSpan.textContent = "‚Äì";

                document.getElementById("applyTotalVolume").value = r.targetVolume || "";
                document.getElementById("applyResultStrength").value = r.targetStrength || "";
                document.getElementById("applyBatchResult").innerHTML = "";
                document.getElementById("recipeApplyBox").style.display = "block";

                recipeRenderBatchHistory(r.id);

                setTimeout(() => {
                    const volInput = document.getElementById("applyTotalVolume");
                    if (volInput) {
                        volInput.focus();
                        volInput.select(); // optional, aber sehr angenehm
                    }
                }, 0);

            }



            function recipeApplySmart(recipeId) {

                const recipes = recipeLoadAll();
                const recipe = recipes.find(r => r.id === recipeId);

                if (!recipe) {
                    alert("Rezept nicht gefunden.");
                    return;
                }

                // Prozent-Rezept ‚Üí bestehendes Batch-Verhalten
                if (recipe.type === "percent") {
                    recipeOpenApply(recipeId);
                    return;
                }

                // Aroma-Rezept ‚Üí Produktionsseite (Aroma / Mazeration)
                if (recipe.type === "aroma") {
                    showPage("production"); // falls deine Seite anders hei√üt ‚Üí sag mir den Namen
                    if (typeof selectRecipeForProduction === "function") {
                        selectRecipeForProduction(recipeId);
                    } else {
                        alert("Rezept geladen. Bitte in der Produktionsseite ausw√§hlen.");
                    }
                    return;
                }

                // Maische-Rezept ‚Üí Ansatz / Maische
                if (recipe.type === "mash") {
                    showPage("batches"); // ggf. Seitenname anpassen
                    if (typeof selectRecipeForMash === "function") {
                        selectRecipeForMash(recipeId);
                    } else {
                        alert("Rezept geladen. Bitte im Produktionsprozess ausw√§hlen.");
                    }
                    return;
                }

                alert("Unbekannter Rezepttyp.");
            }



            function recipeComputeBatch() {
                const recipeId = document.getElementById("recipeId").value.trim();
                if (!recipeId) return alert("Bitte zuerst ein Rezept ausw√§hlen / laden.");

                const list = recipeLoadAll();
                const r = list.find(x => x.id === recipeId);
                if (!r) return alert("Rezept nicht gefunden.");

                const type = r.type || "percent";
                const totalVol = parseFloat(document.getElementById("applyTotalVolume").value);
                const resultStrength = parseFloat(document.getElementById("applyResultStrength").value);
                const box = document.getElementById("applyBatchResult");

                if (isNaN(totalVol) || totalVol <= 0) {
                    box.innerHTML = "<span style='color:#b91c1c;'>Bitte eine g√ºltige Gesamtmenge angeben.</span>";
                    return;
                }

                // Einheit / Bezeichnungen pro Typ
                let unitLabel = "L";
                let totalLabel = "Gesamtmenge";
                if (type === "mash") {
                    unitLabel = "kg";
                    totalLabel = "Gesamt-Sch√ºttung";
                } else if (type === "aroma") {
                    unitLabel = ""; // freie Einheit
                    totalLabel = "Gesamtmenge (Einheiten)";
                }

                // Anteile bestimmen
                let totalWeight = 0;
                r.ingredients.forEach(i => totalWeight += i.amount);

                const rows = [];
                r.ingredients.forEach(i => {
                    let fraction = 0;
                    if (type === "percent" || type === "mash") {
                        fraction = i.amount / 100; // Prozent
                    } else {
                        // aroma: Gewichtungsrezept
                        fraction = totalWeight > 0 ? i.amount / totalWeight : 0;
                    }
                    const amount = totalVol * fraction;
                    rows.push({
                        name: i.name,
                        fraction,
                        amount
                    });
                });

                let html = `<strong>Batch-Berechnung f√ºr ${r.name}</strong><br>`;
                html += `${totalLabel}: ${totalVol.toFixed(2)}${unitLabel ? " " + unitLabel : ""}`;

                if (!isNaN(resultStrength)) {
                    if (type === "percent") {
                        html += ` bei ca. ${resultStrength.toFixed(1)} % Vol (Angabe des Anwenders)`;
                    } else if (type === "mash") {
                        html += ` (Zielst√§rke: ${resultStrength.toFixed(1)} % Vol ‚Äì Info, keine Berechnung)`;
                    } else if (type === "aroma") {
                        html += ` (St√§rke optional: ${resultStrength.toFixed(1)} % Vol)`;
                    }
                }

                html += "<br><br><table style='width:100%; border-collapse:collapse; font-size:0.9em;'>";
                html += `<tr style='background:#eee;'>
        <th style='text-align:left;padding:4px;'>Zutat</th>
        <th style='text-align:right;padding:4px;'>Menge${unitLabel ? " (" + unitLabel + ")" : ""}</th>
        <th style='text-align:right;padding:4px;'>Anteil</th>
    </tr>`;

                rows.forEach(rw => {
                    html += `<tr>
            <td style='border-top:1px solid #ccc;padding:4px;'>${rw.name}</td>
            <td style='border-top:1px solid #ccc;padding:4px;text-align:right;'>${rw.amount.toFixed(2)}${unitLabel ? " " + unitLabel : ""}</td>
            <td style='border-top:1px solid #ccc;padding:4px;text-align:right;'>${(rw.fraction * 100).toFixed(1)} %</td>
        </tr>`;
                });

                html += "</table>";

                // üîπ Speziell f√ºr Maischerezepte: Wasser berechnen
                if (type === "mash" && r.mashWaterRatio != null && !isNaN(r.mashWaterRatio)) {
                    const waterLiters = totalVol * r.mashWaterRatio;
                    html += `<br><br><strong>Wasser:</strong> ${waterLiters.toFixed(1)} L bei ${r.mashWaterRatio.toFixed(2)} L/kg Sch√ºttung`;
                }

                box.innerHTML = html;

                // Batch im Verlauf speichern
                const batches = recipeLoadBatches();
                if (!batches[recipeId]) batches[recipeId] = [];

                batches[recipeId].push({
                    date: recipeToday(),
                    totalVolume: totalVol,
                    resultStrength: isNaN(resultStrength) ? null : resultStrength,
                    rows: rows,
                    type: type
                });

                recipeSaveBatches(batches);
                recipeRenderBatchHistory(recipeId);
            }




            function recipeRenderBatchHistory(recipeId) {
                const container = document.getElementById("recipeBatchHistory");
                if (!container) return;

                const batches = recipeLoadBatches();
                const list = batches[recipeId] || [];

                if (!list.length) {
                    container.innerHTML = "<em>Noch keine Batches gespeichert.</em>";
                    return;
                }

                let html = "<strong>Vergangene Batches:</strong><ul style='margin-top:4px; padding-left:16px; font-size:0.9em;'>";
                list.slice().reverse().forEach(b => {
                    html += `<li>
            ${b.date}: ${b.totalVolume.toFixed(2)} L${b.resultStrength ? " @ " + b.resultStrength.toFixed(1) + " % Vol" : ""}
        </li>`;
                });
                html += "</ul>";

                container.innerHTML = html;
            }



            // =============================================
            //  PRODUKTIONS-SEITE (aus Rezept ‚Üí fertiger Brand ‚Üí Lager)
            // =============================================

            let currentProductionRecipe = null;
            let productionInitDone = false;

            // üîπ Seite initialisieren
            function initProductionPage() {
                // nur einmal Event-Listener setzen
                if (!productionInitDone) {
                    const volInput = document.getElementById("prodTotalVolume");
                    if (volInput) {
                        volInput.addEventListener("input", () => {
                            prodUpdateIngredientPreview();
                            prodUpdateMashInfo();
                        });
                    }

                    const drink = document.getElementById("prodDrinkStrength");
                    // NEU: Basisalkohol ‚Äì Live-Kostenberechnung
                    document.getElementById("prodBaseAlcLiters")?.addEventListener("input", prodUpdateBaseAlcoholInfo);
                    document.getElementById("prodBaseAlcPrice")?.addEventListener("input", prodUpdateBaseAlcoholInfo);
                    document.getElementById("prodBaseAlcStrength")?.addEventListener("input", prodUpdateBaseAlcoholInfo);
                    document.getElementById("prodBaseAlcoholSelect")?.addEventListener("change", prodLoadBaseAlcohol);

                    const actV = document.getElementById("prodActualVolume");
                    const actS = document.getElementById("prodActualStrength");
                    if (drink) drink.addEventListener("input", prodUpdateWaterInfo);
                    if (actV) actV.addEventListener("input", prodUpdateWaterInfo);
                    if (actS) actS.addEventListener("input", prodUpdateWaterInfo);

                    if (drink) drink.addEventListener("input", () => {
                        prodUpdateWaterInfo();
                        prodUpdateAromaCost();
                    });
                    if (actV) actV.addEventListener("input", () => {
                        prodUpdateWaterInfo();
                        prodUpdateAromaCost();
                    });
                    if (actS) actS.addEventListener("input", () => {
                        prodUpdateWaterInfo();
                        prodUpdateAromaCost();
                    });


                    // Aroma-Kostenfelder (falls vorhanden)
                    document.getElementById("prodAromaBurnHours")?.addEventListener("input", prodUpdateAromaCost);
                    document.getElementById("prodAromaPowerKw")?.addEventListener("input", prodUpdateAromaCost);
                    document.getElementById("prodAromaEnergyPrice")?.addEventListener("input", prodUpdateAromaCost);

                    document.getElementById("prodAromaWorkHours")?.addEventListener("input", prodUpdateAromaCost);
                    document.getElementById("prodAromaWage")?.addEventListener("input", prodUpdateAromaCost);
                    document.getElementById("prodAromaTaxPerLAA")?.addEventListener("input", prodUpdateAromaCost);
                    document.getElementById("prodAromaStillPrice")?.addEventListener("input", prodUpdateAromaCost);
                    document.getElementById("prodAromaStillYears")?.addEventListener("input", prodUpdateAromaCost);
                    document.getElementById("prodAromaRunsPerYear")?.addEventListener("input", prodUpdateAromaCost);



                    // üîπ NEU: Rezept schon beim Ausw√§hlen laden
                    const prodSel = document.getElementById("prodRecipeSelect");
                    if (prodSel) {
                        prodSel.addEventListener("change", prodLoadSelectedRecipe);
                    }

                    // NEU: Botanical Berechnung ‚Äì live aktualisieren
                    document.getElementById("prodBotTotal")?.addEventListener("input", () => {
                        prodUpdateIngredientPreview();
                        prodUpdateBotanicalCostTable();
                    });

                    document.getElementById("prodBotPerLiter")?.addEventListener("input", () => {
                        prodUpdateIngredientPreview();
                        prodUpdateBotanicalCostTable();
                    });

                    // NEU: Radiobuttons umschalten
                    document.querySelectorAll('input[name="botCalcMode"]').forEach(el => {
                        el.addEventListener("change", () => {
                            const mode = el.value;
                            document.getElementById("botCalcTotalBox").style.display = (mode === "total") ? "block" : "none";
                            document.getElementById("botCalcPerLiterBox").style.display = (mode === "perliter") ? "block" : "none";

                            prodUpdateIngredientPreview();
                            prodUpdateBotanicalCostTable();
                        });
                    });


                    productionInitDone = true;
                }

                currentProductionRecipe = null;
                prodResetUI();
                prodUpdateStorageDropdown();
                prodFillRecipeSelect();
                fillBatchRecipeSelect();   // ‚≠ê Mash-Rezeptliste erg√§nzen
                prodFillBaseAlcoholSelect();

            }



            // üîπ Rezept-Dropdown f√ºllen
            function prodFillRecipeSelect() {
                const sel = document.getElementById("prodRecipeSelect");
                if (!sel) return;

                // Nur Aroma-Rezepte laden
                const recipes = recipeLoadAll().filter(r => r.type === "aroma");

                sel.innerHTML = '<option value="">‚Äî Aroma-Rezept w√§hlen ‚Äî</option>';

                recipes.forEach(r => {
                    const opt = document.createElement("option");
                    opt.value = r.id;

                    let label = r.name || "(ohne Namen)";
                    opt.textContent = label;

                    sel.appendChild(opt);
                });
            }




            // ============================================
            // Robuste Suche in deinem Rohstofflager
            // ============================================
            function findMaterialByName(name) {
                const mats = materialLoadAll();
                if (!mats || !mats.length) return null;

                const target = name.trim().toLowerCase();

                return mats.find(m =>
                    (m.name || "").trim().toLowerCase() === target
                ) || null;
            }





            // ===============================================
            // üîπ Rezept-Dropdown f√ºr Chargen / Mash-Produktion bef√ºllen
            // ===============================================
            function batchFillRecipeSelect() {
                const sel = document.getElementById("batchRecipeSelect");
                if (!sel) return;

                const all = recipeLoadAll();

                // Nur Mash-Rezepte anzeigen
                const mashRecipes = all.filter(r => r.type === "mash");

                sel.innerHTML = '<option value="">‚Äî Rezept f√ºr Charge w√§hlen ‚Äî</option>';

                mashRecipes.forEach(r => {
                    const opt = document.createElement("option");
                    opt.value = r.id;
                    opt.textContent = r.name || "(ohne Namen)";
                    sel.appendChild(opt);
                });
            }





            function renderBatchMaterialsForCharge(ingredients) {
                const box = document.getElementById("batchMaterialsBox");
                if (!box) return;

                if (!ingredients || !ingredients.length) {
                    box.innerHTML = "<em>Keine Rohstoffe f√ºr diese Charge gefunden.</em>";
                    return;
                }

                let html = `
                    <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                        <tr style="border-bottom:1px solid #ccc;">
                            <th style="text-align:left;">Rohstoff</th>
                            <th style="text-align:right;">Menge (f√ºr diese Charge)</th>
                        </tr>
                `;

                ingredients.forEach(i => {
                    html += `
                    <tr style="border-bottom:1px solid #eee;">
                        <td>${i.name}</td>
                        <td style="text-align:right;">${i.amount.toFixed(2)} kg</td>
                    </tr>
                `;
                });

                html += "</table>";
                box.innerHTML = html;
            }



            function batchCalculateRows(recipe) {
                if (!recipe.ingredients) return [];

                return recipe.ingredients.map(ing => ({
                    name: ing.name,
                    amount: ing.amount,      // FIX: richtige Menge in kg/g/L
                    fraction: 0              // wird nicht ben√∂tigt
                }));
            }




            // üîπ Produktions-UI zur√ºcksetzen
            function prodResetUI() {

                // --------------------------------------------------
                // 1) Bisherige Feld-Resets beibehalten
                // --------------------------------------------------
                const info = document.getElementById("prodRecipeInfo");
                const prev = document.getElementById("prodIngredientPreview");
                const total = document.getElementById("prodTotalVolume");
                const targetStr = document.getElementById("prodTargetStrength");
                const actV = document.getElementById("prodActualVolume");
                const actS = document.getElementById("prodActualStrength");
                const drink = document.getElementById("prodDrinkStrength");
                const waterInfo = document.getElementById("prodWaterInfo");

                if (info) info.innerHTML = "<em>Noch kein Rezept ausgew√§hlt.</em>";
                if (prev) prev.innerHTML = "<em>Bitte zuerst ein Rezept ausw√§hlen.</em>";

                if (total) total.value = "";
                if (targetStr) targetStr.value = "";
                if (actS) actS.value = "";
                if (actV) actV.value = "";
                if (drink) drink.value = "";

                if (waterInfo) {
                    waterInfo.innerHTML =
                        "<em>Hinweis: Trage tats√§chliches Volumen, tats√§chliche St√§rke " +
                        "und gew√ºnschte Trink-/Fassst√§rke ein. Die Wassermenge wird berechnet.</em>";
                }

                // --------------------------------------------------
                // 2) NEU ‚Äì Alle Bl√∂cke ausblenden, die erst
                //    bei Rezeptwahl sichtbar werden sollen
                // --------------------------------------------------
                const hideIds = [
                    "prodMashBox",              // Theoretische Produktion (Mash)
                    "prodAromaBotCalcBlock",    // Botanical-Berechnung
                    "prodMacerationBlock",      // Mazeration
                    "prodBaseAlcoholBlock",     // Basisalkohol
                    "prodBotanicalCostBlock",   // Botanical-Kosten
                    "prodAromaProcessBlock",    // Herstellungsart (Destillation / nicht)
                    "prodAromaCreateBlock",     // Produkterzeugung (nicht destilliert)
                    "prodActualDistillBlock",   // Tats√§chlicher Brand & Lager
                    "prodPlannedBlock",          // Geplante Produktion (theoretisch)
                    "prodAromaBottleBlock"
                ];

                hideIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = "none";
                });

                // Reset globalem Rezept
                currentProductionRecipe = null;
            }






            // üîπ Lager-Dropdown f√ºr Produktion
            function prodUpdateStorageDropdown() {
                const sel = document.getElementById("prodStorageSelect");
                if (!sel) return;

                sel.innerHTML = '<option value="">‚Äî Beh√§lter w√§hlen ‚Äî</option>';

                const keys = Object.keys(localStorage)
                    .filter(k => k.startsWith("storage_"))
                    .sort();

                keys.forEach(k => {
                    const s = JSON.parse(localStorage.getItem(k) || "null");
                    if (!s) return;
                    const opt = document.createElement("option");
                    opt.value = s.id;
                    const cap = s.capacity || "?";
                    const loc = s.location || "-";
                    opt.textContent = `${s.name} (${cap} L, ${loc})`;
                    sel.appendChild(opt);
                });
            }

            // üîπ Wenn ein Rezept ausgew√§hlt und ‚ÄûRezept laden‚Äú gedr√ºckt wird
            function prodLoadSelectedRecipe() {

                // ----------------------------------------------------
                // 1) Rezept aus Dropdown lesen
                // ----------------------------------------------------
                const sel = document.getElementById("prodRecipeSelect");
                if (!sel) return;
                if (!sel.value) return;

                const id = sel.value;
                const recipes = recipeLoadAll();
                const recipe = recipes.find(r => r.id === id);

                if (!recipe) {
                    alert("Rezept nicht gefunden.");
                    return;
                }

                // Merken
                currentProductionRecipe = recipe;


                // ----------------------------------------------------
                // 2) Prozent-Rezepte blockieren
                // ----------------------------------------------------
                if (recipe.type === "percent") {
                    alert("Dieses Rezept ist eine Mischung und kann nicht produziert werden.");
                    return;
                }


                // ----------------------------------------------------
                // 3) Aroma-Bl√∂cke ein-/ausblenden
                // ----------------------------------------------------
                const mac = document.getElementById("prodMacerationBlock");
                const base = document.getElementById("prodBaseAlcoholBlock");
                const botc = document.getElementById("prodBotanicalCostBlock");
                const processBlock = document.getElementById("prodAromaProcessBlock");
                const createBlock = document.getElementById("prodAromaCreateBlock");
                const bottleBlock = document.getElementById("prodAromaBottleBlock");
                const planned = document.getElementById("prodPlannedBlock");
                const distillBlock = document.getElementById("prodActualDistillBlock");
                const botCalc = document.getElementById("prodAromaBotCalcBlock");
                const stockOption = document.getElementById("prodAromaStockOptionBlock");


                // Alles Aroma
                if (recipe.type === "aroma") {

                    if (mac) mac.style.display = "block";
                    if (base) base.style.display = "block";
                    if (botc) botc.style.display = "block";
                    if (processBlock) processBlock.style.display = "block";
                    if (createBlock) createBlock.style.display = "none"; // wird von prodUpdateAromaProcess gesteuert
                    if (bottleBlock) bottleBlock.style.display = "none"; // erst sichtbar nach Produktion
                    if (planned) planned.style.display = "block";
                    if (distillBlock) distillBlock.style.display = "none"; // wird sp√§ter ein-/ausgeblendet
                    if (botCalc) botCalc.style.display = "block";
                    if (stockOption) stockOption.style.display = "block";

                    // Aktualisieren
                    prodUpdateBotanicalCostTable();
                    prodUpdateAromaProcess();
                    prodUpdateAromaCost();
                }


                // ==================================================
                // NEU: Preis f√ºr Basisalkohol automatisch aus Lager holen
                // ==================================================
                if (recipe.type === "aroma") {
                    const priceField = document.getElementById("prodBaseAlcPrice");

                    if (typeof findMaterialByName === "function" && priceField) {
                        const neutral = findMaterialByName("Neutralalkohol 96%");
                        if (neutral && (!priceField.value || priceField.value === "")) {
                            priceField.value = neutral.pricePerUnit;
                        }
                    }
                }


                // ----------------------------------------------------
                // 4) Rezept-Info anzeigen
                // ----------------------------------------------------
                const info = document.getElementById("prodRecipeInfo");
                if (info) {
                    info.innerHTML = `
                        <strong>${recipe.name}</strong><br>
                        <span style="font-size:0.9em; color:#555;">
                            Typ: Aroma-Rezept<br>
                            ${recipe.description ? ("Beschreibung: " + recipe.description + "<br>") : ""}
                        </span>
                    `;
                }


                // ----------------------------------------------------
                // 5) Zielmenge / Zielst√§rke NICHT mehr automatisch setzen
                // ----------------------------------------------------
                const total = document.getElementById("prodTotalVolume");
                if (total) total.value = "";

                const targetStr = document.getElementById("prodTargetStrength");
                if (targetStr) targetStr.value = "";

                const drink = document.getElementById("prodDrinkStrength");
                if (drink) drink.value = "";


                // ----------------------------------------------------
                // 6) Vorschau aktualisieren
                // ----------------------------------------------------
                prodUpdateIngredientPreview();
                prodUpdateWaterInfo();
            }








            function prodUpdateAromaProcess() {

                // --- alle relevanten Bl√∂cke holen ---
                const createBlock = document.getElementById("prodAromaCreateBlock");   // fertiges Produkt ohne Brand
                const distillBlock = document.getElementById("prodActualDistillBlock"); // tats√§chlicher Brand & Lagerung
                const storeBlock = document.getElementById("prodAromaStoreBlock");    // Buttons "verd√ºnnt/unverd√ºnnt einlagern"
                const costBlock = document.getElementById("prodAromaCostBlock");     // Fixkosten beim Destillieren
                const bottleBlock = document.getElementById("prodAromaBottleBlock");
                const runSheetBlock = document.getElementById("prodAromaRunSheetBlock");
                const targetStrengthBlock = document.getElementById("prodAromaTargetStrengthBlock");

                // Sicherheit: Wenn etwas fehlt ‚Üí abbrechen
                if (!createBlock || !distillBlock || !storeBlock || !costBlock || !bottleBlock) return;

                // Wenn kein Rezept gew√§hlt wurde ‚Üí alles ausblenden
                if (!currentProductionRecipe || currentProductionRecipe.type !== "aroma") {
                    createBlock.style.display = "none";
                    distillBlock.style.display = "none";
                    storeBlock.style.display = "none";
                    costBlock.style.display = "none";
                    bottleBlock.style.display = "none";
                    targetStrengthBlock.style.display = "none";
                    createBlock.style.display = "none";
                    runSheetBlock.style.display = "none";
                    return;
                }

                // --- AROMA-Prozessmodus holen (Radio-Buttons) ---
                const mode = document.querySelector('input[name="aromaProcess"]:checked')?.value || "distill";

                if (mode === "noDistill") {
                    // ‚û§ Nur mazeriert ‚Äì keine Destillation

                    createBlock.style.display = "block";  // Produkt direkt erzeugen
                    distillBlock.style.display = "none";  // kein Brand
                    storeBlock.style.display = "none";    // nichts ins Lager einlagern bei Mazeration
                    costBlock.style.display = "none";     // keine Fixkosten, keine Brenndauer
                    bottleBlock.style.display = "block";
                    targetStrengthBlock.style.display = "block";
                    runSheetBlock.style.display = "block";

                } else {
                    // ‚û§ Mit Destillation ‚Äì wie Gin, Kr√§uterbrand etc.

                    createBlock.style.display = "none";   // Create-Block ausblenden
                    distillBlock.style.display = "block"; // Brand & Lagerung sichtbar
                    storeBlock.style.display = "block";   // Buttons unverd√ºnnt/verd√ºnnt einlagern sichtbar
                    costBlock.style.display = "block";    // Fixkostenblock sichtbar
                    bottleBlock.style.display = "block";
                    targetStrengthBlock.style.display = "none";
                    runSheetBlock.style.display = "block";
                }

                // -------------------------------------------
                // NEU: Kosten NEU berechnen, egal welcher Modus
                // -------------------------------------------
                if (typeof prodUpdateAromaCost === "function") {
                    prodUpdateAromaCost();
                }

            }






            document.addEventListener("change", e => {
                if (e.target.name === "aromaProcess") {
                    prodUpdateAromaProcess();
                }
            });



            function prodUpdateAromaFinalCalc() {

                const liters = parseFloat(document.getElementById("prodBaseAlcLiters")?.value) || 0;
                const strength = parseFloat(document.getElementById("prodBaseAlcStrength")?.value) || 0;
                const target = parseFloat(document.getElementById("prodAromaFinalStrength")?.value) || 0;

                const infoBox = document.getElementById("prodAromaFinalInfo");

                if (!liters || !strength) {
                    infoBox.innerHTML = "<em>Bitte zuerst Menge und St√§rke des Basisalkohols eingeben.</em>";
                    return;
                }

                if (!target) {
                    infoBox.innerHTML = "<em>Bitte Zielst√§rke eingeben.</em>";
                    return;
                }

                if (target >= strength) {
                    infoBox.innerHTML =
                        "<span style='color:red;'>Die Zielst√§rke muss niedriger als die Alkoholst√§rke sein.</span>";
                    return;
                }

                // Reiner Alkohol
                const AA = liters * strength / 100;

                // Endvolumen
                const finalVol = AA / (target / 100);

                // Wasserbedarf
                const water = finalVol - liters;

                infoBox.innerHTML =
                    `Reiner Alkohol: <strong>${AA.toFixed(2)} L</strong><br>
                    Endvolumen: <strong>${finalVol.toFixed(2)} L</strong><br>
                    Wasserbedarf: <strong>${water.toFixed(2)} L</strong>`;

                // Globale Variablen f√ºr Flaschenkalkulation
                window.currentAromaFinalVolume = finalVol;

                if (window.currentAromaTotalCosts) {
                    window.currentAromaCostPerLiter =
                        window.currentAromaTotalCosts / finalVol;
                }

                if (typeof prodUpdateAromaBottleCalc === "function") {
                    prodUpdateAromaBottleCalc();
                }
            }






            function prodGetBotanicalTotal() {
                if (!currentProductionRecipe || currentProductionRecipe.type !== "aroma") return NaN;

                const mode = document.querySelector('input[name="botCalcMode"]:checked')?.value;

                const baseLiters = parseFloat(document.getElementById("prodBaseAlcLiters")?.value);

                // Modus: Gesamt-Botanicals
                if (mode === "total") {
                    const total = parseFloat(document.getElementById("prodBotTotal")?.value);
                    return (!isNaN(total) && total > 0) ? total : NaN;
                }

                // Modus: g/L
                if (mode === "perliter") {
                    const gpl = parseFloat(document.getElementById("prodBotPerLiter")?.value);
                    if (!isNaN(baseLiters) && baseLiters > 0 &&
                        !isNaN(gpl) && gpl > 0) {
                        return baseLiters * gpl;
                    }
                }

                return NaN;
            }





            // üîπ Vorschau: Zutaten-Mengen f√ºr geplante Gesamtmenge
            function prodUpdateIngredientPreview() {
                const box = document.getElementById("prodIngredientPreview");
                if (!box) return;

                if (!currentProductionRecipe) {
                    box.innerHTML = "<em>Bitte zuerst ein Rezept ausw√§hlen.</em>";
                    return;
                }

                const r = currentProductionRecipe;
                const totalInput = document.getElementById("prodTotalVolume");
                const total = prodGetBotanicalTotal();

                if (isNaN(total) || total <= 0) {
                    box.innerHTML = "<em>Bitte eine g√ºltige geplante Gesamtmenge eingeben.</em>";
                    return;
                }

                if (!r.ingredients || r.ingredients.length === 0) {
                    box.innerHTML = "<em>Dieses Rezept hat keine Zutaten definiert.</em>";
                    return;
                }

                let totalWeight = 0;
                r.ingredients.forEach(i => totalWeight += (parseFloat(i.amount) || 0));

                const rows = [];
                r.ingredients.forEach(i => {
                    const amount = parseFloat(i.amount) || 0;
                    if (amount <= 0) return;

                    let fraction = 0;
                    if (r.type === "percent") {
                        fraction = amount / 100;
                    } else {
                        if (totalWeight <= 0) return;
                        fraction = amount / totalWeight;
                    }

                    const liters = total * fraction;
                    rows.push({
                        name: i.name,
                        fraction,
                        liters
                    });
                });

                if (!rows.length) {
                    box.innerHTML = "<em>Keine g√ºltigen Zutaten im Rezept.</em>";
                    return;
                }

                let html = "<table style='width:100%; border-collapse:collapse; font-size:0.9em;'>";
                html += "<tr style='background:#eee;'>" +
                    "<th style='text-align:left;padding:4px;'>Zutat</th>" +
                    "<th style='text-align:right;padding:4px;'>Menge</th>" +
                    "<th style='text-align:right;padding:4px;'>Anteil</th>" +
                    "</tr>";

                rows.forEach(row => {
                    html += `<tr>
                        <td style='border-top:1px solid #ccc;padding:4px;'>${row.name}</td>
                        <td style='border-top:1px solid #ccc;padding:4px;text-align:right;'>
                            ${row.liters.toFixed(2)} ${r.type === "percent" ? "L (theoretisch)" : "Einheiten"}
                        </td>
                        <td style='border-top:1px solid #ccc;padding:4px;text-align:right;'>
                            ${(row.fraction * 100).toFixed(1)} %
                        </td>
                    </tr>`;
                });

                html += "</table>";

                box.innerHTML = html;
                prodShowHideMashBox();

            }



            //---Umrechnung der Einheiten
            function convertToBasePrice(material) {
                const unit = (material.unit || "").toLowerCase();
                const price = material.pricePerUnit || 0;

                if (unit === "kg") return price;
                if (unit === "g") return price * 1000;
                if (unit === "mg") return price * 1000000;

                if (unit === "l") return price;
                if (unit === "ml") return price * 1000;

                return price;
            }



            // ============================================
            // AROMA / GIN: Botanical-Kosten-Berechnung
            // ============================================
            function prodUpdateBotanicalCostTable() {
                const box = document.getElementById("prodBotanicalCostTable");
                if (!box || !currentProductionRecipe) return;

                // Nur Aroma-Rezepte haben Botanical-Kosten
                if (currentProductionRecipe.type !== "aroma") {
                    box.innerHTML = "";
                    return;
                }

                // Gesamt-Botanicalmenge (aus Gesamt oder g/L)
                const total = prodGetBotanicalTotal();
                if (isNaN(total) || total <= 0) {
                    box.innerHTML = "<em>Bitte eine g√ºltige Botanicals-Menge eingeben.</em>";
                    return;
                }

                const r = currentProductionRecipe;
                if (!r.ingredients || r.ingredients.length === 0) {
                    box.innerHTML = "<em>Dieses Aroma-Rezept hat keine Botanicals.</em>";
                    return;
                }

                // Summe aller Rezeptteile ‚Üí Verh√§ltnis
                let totalUnits = 0;
                r.ingredients.forEach(i => {
                    totalUnits += (parseFloat(i.amount) || 0);
                });

                let html = "<table style='width:100%; border-collapse:collapse; font-size:0.9em;'>";
                html += `
                    <tr style='background:#eee;'>
                        <th style='text-align:left;padding:4px;'>Zutat</th>
                        <th style='text-align:right;padding:4px;'>Menge (g)</th>
                        <th style='text-align:right;padding:4px;'>Preis</th>
                        <th style='text-align:right;padding:4px;'>Kosten (‚Ç¨)</th>
                    </tr>
                `;

                let totalCost = 0;

                r.ingredients.forEach(i => {
                    const units = parseFloat(i.amount) || 0;
                    if (units <= 0) return;

                    const fraction = units / totalUnits;
                    const used = total * fraction;   // Verbrauch in g

                    // Rohstoff im Lager finden
                    const mat = findMaterialByName(i.name);

                    // Preis pro Einheit (‚Ç¨/g, ‚Ç¨/kg, ‚Ç¨/ml oder ‚Ç¨/L)
                    const pricePerUnit = mat?.pricePerUnit || 0;
                    const unit = (mat?.unit || "").toLowerCase();

                    // ------------ Kostenberechnung (IMMER: used(g) √ó ‚Ç¨/g) ------------
                    let cost = 0;
                    if (unit === "g") {
                        cost = used * pricePerUnit;               // ‚Ç¨/g √ó g
                    } else if (unit === "kg") {
                        cost = used * (pricePerUnit / 1000);      // ‚Ç¨/kg ‚Üí ‚Ç¨/g
                    } else if (unit === "ml") {
                        cost = used * pricePerUnit;               // ‚Ç¨/ml √ó ml (falls jemals fl√ºssige Botanicals)
                    } else if (unit === "l") {
                        cost = used * (pricePerUnit / 1000);      // ‚Ç¨/L ‚Üí ‚Ç¨/ml
                    }

                    totalCost += cost;

                    // ------------ Anzeige: Preis pro 1 kg oder pro 1 L ------------
                    let displayPrice = pricePerUnit;
                    let displayUnit = "‚Ç¨/Einheit";

                    if (unit === "g") {
                        displayPrice = pricePerUnit * 1000;   // ‚Ç¨/g ‚Üí ‚Ç¨/kg
                        displayUnit = "‚Ç¨/kg";
                    } else if (unit === "kg") {
                        displayPrice = pricePerUnit;
                        displayUnit = "‚Ç¨/kg";
                    } else if (unit === "ml") {
                        displayPrice = pricePerUnit * 1000;   // ‚Ç¨/ml ‚Üí ‚Ç¨/L
                        displayUnit = "‚Ç¨/L";
                    } else if (unit === "l") {
                        displayPrice = pricePerUnit;
                        displayUnit = "‚Ç¨/L";
                    }

                    // ------------ Tabellenzeile ------------
                    html += `
                        <tr>
                            <td style='border-top:1px solid #ccc;padding:4px;'>${i.name}</td>
                            <td style='border-top:1px solid #ccc;padding:4px; text-align:right;'>${used.toFixed(2)} g</td>
                            <td style='border-top:1px solid #ccc;padding:4px; text-align:right;'>
                                ${displayPrice.toFixed(2)} ${displayUnit}
                            </td>
                            <td style='border-top:1px solid #ccc;padding:4px; text-align:right;'>
                                ${cost.toFixed(2)} ‚Ç¨
                            </td>
                        </tr>
                    `;
                });

                // ------------ Gesamtkosten-Zeile ------------
                html += `
                    <tr style="background:#f8f8f8; font-weight:bold;">
                        <td colspan="3" style="text-align:right;padding:6px;">Gesamtkosten:</td>
                        <td style="text-align:right;padding:6px;">${totalCost.toFixed(2)} ‚Ç¨</td>
                    </tr>
                `;

                html += "</table>";

                box.innerHTML = html;
            }







            // ============================================
            // AROMA / GIN: Basisalkohol ‚Äì Kostenberechnung
            // ============================================
            function prodUpdateBaseAlcoholInfo() {
                const vol = parseFloat(document.getElementById("prodBaseAlcLiters")?.value);
                const price = parseFloat(document.getElementById("prodBaseAlcPrice")?.value);
                const strength = parseFloat(document.getElementById("prodBaseAlcStrength")?.value) || 96;

                const box = document.getElementById("prodBaseAlcInfo");
                if (!box) return;

                // Wenn keine Werte vorhanden ‚Üí Hinweis
                if (isNaN(vol) || vol <= 0 || isNaN(price) || price <= 0) {
                    box.innerHTML = "<em>Bitte Menge und Preis eingeben.</em>";
                    return;
                }

                const cost = vol * price;                   // Gesamtkosten
                const pure = vol * (strength / 100);        // Reiner Alkohol (LAA)
                const pricePerLAA = cost / pure;            // Preis pro LAA

                box.innerHTML =
                    `Reiner Alkohol: ${pure.toFixed(2)} L<br>` +
                    `Gesamtkosten: ${cost.toFixed(2)} ‚Ç¨<br>` +
                    `<strong>${pricePerLAA.toFixed(2)} ‚Ç¨ / L Reinalkohol</strong>`;
            }








            function prodShowHideMashBox() {
                const box = document.getElementById("prodMashBox");
                const planned = document.getElementById("prodPlannedBlock");

                if (!box) return;

                if (!currentProductionRecipe || currentProductionRecipe.type !== "mash") {

                    // Mash ausgeblendet
                    box.style.display = "none";

                    // üîπ Geplante Produktion wieder anzeigen
                    if (planned) planned.style.display = "block";

                } else {

                    // Mash sichtbar
                    box.style.display = "block";
                    prodUpdateMashInfo();

                    // üîπ Geplante Produktion ausblenden
                    if (planned) planned.style.display = "none";
                }
            }





            function prodUpdateMashInfo() {
                const box = document.getElementById("prodMashInfo");
                if (!box) return;

                if (!currentProductionRecipe || currentProductionRecipe.type !== "mash") {
                    box.innerHTML = "";
                    return;
                }

                const r = currentProductionRecipe;

                // Gesamtmenge in kg (Malz-Gesamtmenge)
                const total = parseFloat(document.getElementById("prodTotalVolume")?.value);
                if (isNaN(total) || total <= 0) {
                    box.innerHTML = "<em>Bitte geplante Gesamtmenge eingeben.</em>";
                    return;
                }

                // Wasser-Malz Verh√§ltnis aus dem Rezept
                const ratio = parseFloat(r.mashWaterRatio);
                if (isNaN(ratio) || ratio <= 0) {
                    box.innerHTML = "<em>Im Rezept ist kein Wasser/Malz-Verh√§ltnis definiert.</em>";
                    return;
                }

                const water = total * ratio;     // Liter Wasser
                const mashVolume = water + total; // einfache Sch√§tzung

                box.innerHTML =
                    `<strong>Berechnung:</strong><br><br>
                    Gesamt-Malzmenge: <strong>${total.toFixed(2)} kg</strong><br>
                    Empfohlene Wassermenge: <strong>${water.toFixed(2)} L</strong><br>
                    Gesch√§tztes Maischevolumen: <strong>${mashVolume.toFixed(2)} L</strong><br><br>
                    <span style="font-size:0.85em; color:#666;">
                        Hinweis: Das Maischevolumen kann abh√§ngig vom Malztyp leicht variieren.
                    </span>`;
            }





            // üîπ Wasserzugabe-Info berechnen (nur Anzeige)
            function prodUpdateWaterInfo() {
                const info = document.getElementById("prodWaterInfo");
                if (!info) return;

                const V = parseFloat(document.getElementById("prodActualVolume")?.value);
                const A = parseFloat(document.getElementById("prodActualStrength")?.value);
                const T = parseFloat(document.getElementById("prodDrinkStrength")?.value);

                if (isNaN(V) || isNaN(A) || isNaN(T) || V <= 0 || A <= 0 || T <= 0 || T >= A) {
                    info.innerHTML =
                        "<em>Hinweis: Trage tats√§chliches Volumen, tats√§chliche St√§rke " +
                        "und gew√ºnschte Trinkst√§rke ein, um die Wassermenge zu berechnen.</em>";
                    return;
                }

                const pure = V * A / 100; // Liter reiner Alkohol
                const targetTotal = pure / (T / 100);
                const water = targetTotal - V;

                info.innerHTML =
                    `Reiner Alkohol: ${pure.toFixed(2)} L<br>` +
                    `Ziel: ${targetTotal.toFixed(2)} L @ ${T.toFixed(1)} % Vol<br>` +
                    `<strong>Wasserzugabe:</strong> ${water.toFixed(2)} L (theoretisch)`;
            }



            function prodUpdateAromaCost() {

                if (!currentProductionRecipe || currentProductionRecipe.type !== "aroma") return;

                const summary = document.getElementById("prodAromaCostSummary");
                if (!summary) return;

                // Herstellungsart
                const process = document.querySelector('input[name="aromaProcess"]:checked')?.value || "distill";

                // Eingaben
                const V = parseFloat(document.getElementById("prodActualVolume")?.value) || 0;
                const A = parseFloat(document.getElementById("prodActualStrength")?.value) || 0;
                const T = parseFloat(document.getElementById("prodDrinkStrength")?.value) || 0;

                // Basisalkohol
                const alcLiters = parseFloat(document.getElementById("prodBaseAlcLiters")?.value) || 0;
                const alcStrength = 96;
                const alcPrice = parseFloat(document.getElementById("prodBaseAlcPrice")?.value) || 0;
                const baseAlcoholCost = alcLiters * alcPrice;
                const AA_base = alcLiters * (alcStrength / 100);

                // Botanicals
                const bot = (typeof prodCalculateBotanicalCosts === "function")
                    ? prodCalculateBotanicalCosts()
                    : { total: 0 };
                const botanicalCost = bot.total || 0;

                const rawCost = baseAlcoholCost + botanicalCost;

                // Produktionskosten
                const burnHours = parseFloat(document.getElementById("prodAromaBurnHours")?.value) || 0;
                const powerKw = parseFloat(document.getElementById("prodAromaPowerKw")?.value) || 0;
                const priceKwh = parseFloat(document.getElementById("prodAromaEnergyPrice")?.value) || 0;

                const workHours = parseFloat(document.getElementById("prodAromaWorkHours")?.value) || 0;
                const wage = parseFloat(document.getElementById("prodAromaWage")?.value) || 0;

                const energyCost = burnHours * powerKw * priceKwh;
                const labourCost = workHours * wage;

                // Fixkosten Destille
                const stillPrice = parseFloat(document.getElementById("prodAromaStillPrice")?.value) || 0;
                const stillYears = parseFloat(document.getElementById("prodAromaStillYears")?.value) || 0;
                const runsPerYear = parseFloat(document.getElementById("prodAromaRunsPerYear")?.value) || 0;

                let fixedPerRun = 0;
                if (stillPrice > 0 && stillYears > 0 && runsPerYear > 0) {
                    fixedPerRun = stillPrice / (stillYears * runsPerYear);
                }

                const fixedCost = (process === "distill") ? fixedPerRun : 0;

                const fixedInfo = document.getElementById("prodAromaFixedInfo");
                if (fixedInfo) {
                    if (process === "distill" && fixedPerRun > 0) {
                        fixedInfo.innerHTML =
                            `Fixkostenanteil: <strong>${fixedPerRun.toFixed(2)} ‚Ç¨</strong> pro Brand`;
                    } else if (process === "noDistill") {
                        fixedInfo.innerHTML = "Keine Destillation ‚Üí keine Fixkosten";
                    } else {
                        fixedInfo.innerHTML = "Fixkostenanteil: ‚Äì";
                    }
                }

                // Steuer (nur bei Destillation)
                const taxPerLAA = parseFloat(document.getElementById("prodAromaTaxPerLAA")?.value) || 0;

                let AA = 0;
                let finalVolume = 0;
                let taxCost = 0;

                if (process === "distill") {

                    // --- destillierte Produktion ---
                    if (!V || !A) {
                        summary.innerHTML = "<em>Bitte tats√§chliches Destillat (L) und St√§rke (% Vol) eingeben.</em>";
                        return;
                    }

                    AA = V * (A / 100);

                    if (T > 0 && T < A) {
                        finalVolume = AA / (T / 100);
                    } else {
                        finalVolume = V;
                    }

                    taxCost = AA * taxPerLAA;

                } else {

                    // --- reine Mazeration / Compound Gin ---
                    // Alkohol = Basisalkohol
                    AA = AA_base;

                    if (T > 0) {
                        finalVolume = AA / (T / 100);
                    } else {
                        finalVolume = alcLiters; // ohne Zielst√§rke ‚Üí kein Zusatzwasser
                    }

                    taxCost = 0; // keine Steuer ohne Destillation
                }

                const productionCost = energyCost + labourCost + fixedCost + taxCost;
                const totalCost = rawCost + productionCost;

                const costPerLiter = finalVolume > 0 ? totalCost / finalVolume : 0;

                // Ausgabe
                summary.innerHTML =
                    `<strong>Rohstoffkosten:</strong> ${rawCost.toFixed(2)} ‚Ç¨<br>` +
                    `&nbsp;&nbsp;Basisalkohol: ${baseAlcoholCost.toFixed(2)} ‚Ç¨<br>` +
                    `&nbsp;&nbsp;Botanicals: ${botanicalCost.toFixed(2)} ‚Ç¨<br><br>` +

                    `<strong>Produktionskosten:</strong><br>` +
                    `&nbsp;&nbsp;Energie: ${energyCost.toFixed(2)} ‚Ç¨<br>` +
                    `&nbsp;&nbsp;Arbeit: ${labourCost.toFixed(2)} ‚Ç¨<br>` +
                    `&nbsp;&nbsp;Fixkosten Destille: ${fixedCost.toFixed(2)} ‚Ç¨<br>` +
                    `&nbsp;&nbsp;Steuer: ${taxCost.toFixed(2)} ‚Ç¨<br><br>` +

                    `<strong>Gesamtkosten Charge:</strong> ${totalCost.toFixed(2)} ‚Ç¨<br>` +
                    `<strong>Kosten pro Liter (bei Trinkst√§rke):</strong> ${costPerLiter.toFixed(2)} ‚Ç¨/L<br>` +
                    `<small>(berechnet auf ${finalVolume.toFixed(2)} L)</small>`;

                // Daten f√ºr Verkaufspreise verf√ºgbar machen
                window.currentAromaFinalVolume = finalVolume;
                window.currentAromaTotalCosts = totalCost;
            }








            function prodStoreAromaToStorage(mode) {
                // ‚≠ê SCHRITT 4: Schutz vor Einlagerung ohne Rohstoffpr√ºfung
                if (!window.aromaMaterialCheckDone) {
                    alert("Bitte zuerst einen Laufzettel mit Rohstoffpr√ºfung erstellen, bevor die Charge eingelagert wird.");
                    return;
                }


                if (!currentProductionRecipe || currentProductionRecipe.type !== "aroma") {
                    alert("Kein Aroma-Rezept ausgew√§hlt.");
                    return;
                }

                if (!mode) mode = "raw"; // raw = unverd√ºnnt, diluted = verd√ºnnt

                // --------------------------------------------------------------
                // 1) Eingaben holen
                // --------------------------------------------------------------
                const realVolume = parseFloat(document.getElementById("prodActualVolume")?.value) || 0;
                const realStrength = parseFloat(document.getElementById("prodActualStrength")?.value) || 0;
                const targetStrength = parseFloat(document.getElementById("prodDrinkStrength")?.value) || 0;

                if (!realVolume || !realStrength) {
                    alert("Bitte tats√§chliches Volumen und St√§rke eingeben.");
                    return;
                }

                // --------------------------------------------------------------
                // 2) Alkoholmenge (AA)
                // --------------------------------------------------------------
                const AA = realVolume * (realStrength / 100);

                let finalVolume = realVolume;
                let finalStrength = realStrength;
                let waterNeeded = 0;

                if (mode === "diluted") {
                    if (!targetStrength) {
                        alert("Bitte gew√ºnschte Trinkst√§rke eingeben.");
                        return;
                    }

                    finalVolume = AA / (targetStrength / 100);
                    finalStrength = targetStrength;
                    waterNeeded = finalVolume - realVolume;
                }

                // --------------------------------------------------------------
                // 3) Lagerbeh√§lter w√§hlen
                // --------------------------------------------------------------
                const storageId = document.getElementById("prodStorageSelect")?.value;
                if (!storageId) {
                    alert("Bitte einen Lagerbeh√§lter w√§hlen.");
                    return;
                }

                const storageKey = "storage_" + storageId;
                const st = JSON.parse(localStorage.getItem(storageKey) || "{}");

                if (!st.id) {
                    alert("Lagerbeh√§lter existiert nicht!");
                    return;
                }

                // --------------------------------------------------------------
                // 4) Kosten SICHER berechnen
                // --------------------------------------------------------------
                const alcLiters = parseFloat(document.getElementById("prodBaseAlcLiters")?.value) || 0;
                const alcPrice = parseFloat(document.getElementById("prodBaseAlcPrice")?.value) || 0;

                const botCosts = (typeof prodCalculateBotanicalCosts === "function")
                    ? prodCalculateBotanicalCosts()
                    : { total: 0 };

                const alcoholCost = alcLiters * alcPrice;
                const totalCosts = alcoholCost + botCosts.total;

                const costPerLiter = finalVolume > 0
                    ? totalCosts / finalVolume
                    : 0;

                // kleine Rundungsfunktion
                const r2 = v => Math.round((v + Number.EPSILON) * 100) / 100;


                // --------------------------------------------------------------
                // 5) Flaschenpreise holen
                // --------------------------------------------------------------
                function toNum(v) {
                    const n = parseFloat(v);
                    return isNaN(n) ? null : n;
                }

                // User-Preise aus Tabelle lesen
                const price05 = toNum(document.getElementById("botPrice05")?.value);
                const price07 = toNum(document.getElementById("botPrice07")?.value);
                const price10 = toNum(document.getElementById("botPrice10")?.value);

                // Materialkosten je Flasche (falls genutzt ‚Äî sonst 0)
                const mat05 = parseFloat(document.getElementById("prodBottleMat05")?.value) || 0;
                const mat07 = parseFloat(document.getElementById("prodBottleMat07")?.value) || 0;
                const mat10 = parseFloat(document.getElementById("prodBottleMat10")?.value) || 0;


                // Mindestpreis je Flasche (basierend auf Kosten/Liter)
                function minPrice(volume, mat) {
                    return r2(costPerLiter * volume + mat);
                }

                const calcPrice = {
                    "0.5": {
                        min: minPrice(0.5, mat05),
                        profit: (price05 != null ? r2(price05 - minPrice(0.5, mat05)) : null)
                    },
                    "0.7": {
                        min: minPrice(0.7, mat07),
                        profit: (price07 != null ? r2(price07 - minPrice(0.7, mat07)) : null)
                    },
                    "1.0": {
                        min: minPrice(1.0, mat10),
                        profit: (price10 != null ? r2(price10 - minPrice(1.0, mat10)) : null)
                    }
                };

                const userPrice = {
                    "0.5": price05,
                    "0.7": price07,
                    "1.0": price10
                };


                // --------------------------------------------------------------
                // 6) Produkt- & Quellenname
                // --------------------------------------------------------------
                const today = new Date().toISOString().split("T")[0];
                const recipeName = currentProductionRecipe.name || "Aroma";
                const sourceName = `${recipeName} vom ${today}`;   // ‚Üê GENAU SO WOLLTEST DU ES

                const productName =
                    `${recipeName} ‚Äì Aroma-Charge vom ${today} (${finalVolume.toFixed(2)} L @ ${finalStrength}% vol)`;

                // --------------------------------------------------------------
                // 7) Produktobjekt erstellen
                // --------------------------------------------------------------
                const product = {
                    id: "product_" + Date.now(),
                    name: productName,
                    recipeName: recipeName,
                    source: sourceName,   // ‚Üê Zus√§tzlich gesetzt
                    volumeL: finalVolume,
                    strength: finalStrength,
                    remainingVolume: finalVolume,
                    totalCosts,
                    costPerLiter,
                    userPrice,
                    calcPrice,
                    origin: "aroma",
                    storage: storageId,
                    created: today,


                    process: document.querySelector('input[name="aromaProcess"]:checked')?.value || "no-distill",

                    notes: document.getElementById("prodMacNotes")?.value || "",

                    dilution: {
                        mode,
                        realVolume,
                        realStrength,
                        targetStrength,
                        waterNeeded
                    }
                };

                // Produkt als verbraucht markieren
                product.used = true;
                product.remainingVolume = 0;


                // 8) Rohstoffe abbuchen (falls aktiviert)
                let warnings = [];
                const autoConsume = document.querySelector('input[name="aromaUseStock"]:checked')?.value === "yes";


                if (autoConsume) {

                    // --- Botanicals ausbuchen ---
                    const scaledIngredients = botCosts.items.map(b => ({
                        name: b.name,
                        amount: b.used
                    }));

                    warnings = materialConsumeFromBatch(currentProductionRecipe, scaledIngredients);

                    // --- Basisalkohol ausbuchen ---
                    if (alcLiters > 0) {
                        warnings.push(
                            ...materialConsumeFromBatch(
                                currentProductionRecipe,
                                [{ name: "Neutralalkohol 96%", amount: alcLiters }]
                            )
                        );
                    }
                }

                // Warnung anzeigen, falls etwas knapp ist
                if (warnings.length > 0) {
                    alert("‚ö† Einige Rohstoffe sind knapp:\n\n" + warnings.join("\n"));
                }




                // --------------------------------------------------------------
                // 9) Produkt speichern
                // --------------------------------------------------------------
                const products = JSON.parse(localStorage.getItem("products") || "[]");
                products.push(product);
                localStorage.setItem("products", JSON.stringify(products));

                // --------------------------------------------------------------
                // 10) Lager-Eintrag erzeugen (MIT sourceName!)
                // --------------------------------------------------------------
                if (!st.contents) st.contents = [];

                st.contents.push({
                    id: "item_" + Date.now(),
                    productId: product.id,
                    source: sourceName,          // ‚Üê HIER IST DIE QUELLE F√úR DIE LAGERSEITE
                    volume: finalVolume,
                    strength: finalStrength,
                    dateAdded: today,
                    waterAdded: waterNeeded
                });

                st.currentVolume = (st.currentVolume || 0) + finalVolume;

                localStorage.setItem(storageKey, JSON.stringify(st));

                alert("Aroma-Charge erfolgreich ins Lager eingebucht.");


                prodResetAromaPage();

            }





            function prodUpdateAromaBottleCalc() {

                const finalVol = window.currentAromaFinalVolume || 0;      // Endvolumen in L
                const totalCosts = window.currentAromaTotalCosts || 0;     // Gesamtkosten Charge

                if (finalVol <= 0 || totalCosts <= 0) {
                    console.warn("Fehlende Basisdaten f√ºr Flaschenkalkulation.");
                    return;
                }

                // Materialkosten
                const matBottle = parseFloat(document.getElementById("botMatBottle")?.value) || 0;
                const matClosure = parseFloat(document.getElementById("botMatClosure")?.value) || 0;
                const matLabel = parseFloat(document.getElementById("botMatLabel")?.value) || 0;
                const matPack = parseFloat(document.getElementById("botMatPackage")?.value) || 0;
                const matShip = parseFloat(document.getElementById("botMatShipping")?.value) || 0;

                const materialCost = matBottle + matClosure + matLabel + matPack + matShip;

                function calc(size, idPrice, idMin, idGain, idCount, idRest, idEuroL, idTotalGain) {

                    const vk = parseFloat(document.getElementById(idPrice)?.value);

                    const count = Math.floor(finalVol / size);
                    const rest = finalVol - (count * size);

                    let minPrice = 0;
                    let euroL = 0;
                    let gain = NaN;
                    let totalGain = NaN;

                    if (count > 0) {
                        const share = totalCosts / count;          // Kostenanteil pro Flasche
                        minPrice = materialCost + share;           // Mindestpreis
                        euroL = minPrice / size;

                        if (!isNaN(vk)) {
                            gain = vk - minPrice;                  // Gewinn pro Flasche
                            totalGain = gain * count;              // Gesamter Gewinn
                        }
                    }

                    // Tabellenfelder f√ºllen
                    document.getElementById(idMin).textContent = minPrice.toFixed(2);
                    //document.getElementById(idEuroL).textContent = euroL.toFixed(2);
                    document.getElementById(idCount).textContent = count;
                    document.getElementById(idRest).textContent = rest.toFixed(2);
                    document.getElementById(idGain).textContent = isNaN(gain) ? "‚Äì" : gain.toFixed(2);
                    document.getElementById(idTotalGain).textContent = isNaN(totalGain) ? "‚Äì" : totalGain.toFixed(2);

                    return {
                        min: minPrice,
                        userPrice: isNaN(vk) ? null : vk,
                        gain: isNaN(gain) ? null : gain,
                        totalGain: isNaN(totalGain) ? null : totalGain,
                        count,
                        rest
                    };
                }

                // Aufrufe inkl. neuer Spalten-IDs
                const r05 = calc(
                    0.5, "botPrice05", "botMin05", "botGain05", "botCountL05", "botRestL05", "botEuroL05", "botTotalGain05"
                );

                const r07 = calc(
                    0.7, "botPrice07", "botMin07", "botGain07", "botCountL07", "botRestL07", "botEuroL07", "botTotalGain07"
                );

                const r10 = calc(
                    1.0, "botPrice10", "botMin10", "botGain10", "botCountL10", "botRestL10", "botEuroL10", "botTotalGain10"
                );

                window.currentAromaBottlePrices = {
                    "0.5": r05,
                    "0.7": r07,
                    "1.0": r10
                };
            }



            // --------------------------------------------------------------
            // Neutralalkohol finden
            // --------------------------------------------------------------
            function materialConsumeBaseAlcohol(liters) {

                const materials = JSON.parse(localStorage.getItem("materials") || "[]");

                // Neutralalkohol finden
                const neutral = materials.find(m =>
                    m.name.toLowerCase().includes("neutral") &&
                    m.name.includes("96")
                );

                if (!neutral) {
                    return ["Neutralalkohol 96% nicht im Lager gefunden."];
                }

                // bestand pr√ºfen
                if (neutral.amount < liters) {
                    return [
                        `Neutralalkohol zu knapp: ben√∂tigt ${liters.toFixed(2)} L, ` +
                        `vorhanden ${neutral.amount.toFixed(2)} L`
                    ];
                }

                // Bestand reduzieren
                neutral.amount -= liters;

                // Speichern
                localStorage.setItem("materials", JSON.stringify(materials));

                return [];  // keine Warnungen
            }


            function prodFillBaseAlcoholSelect() {
                const sel = document.getElementById("prodBaseAlcoholSelect");
                if (!sel) return;

                const mats = JSON.parse(localStorage.getItem("materials") || "[]");

                sel.innerHTML = '<option value="">‚Äî Basisalkohol w√§hlen ‚Äî</option>';

                mats
                    .filter(m => m.isBaseAlcohol)
                    .forEach(m => {
                        const opt = document.createElement("option");
                        opt.value = m.id;
                        opt.textContent = `${m.name} (${m.strength || "?"} % Vol)`;
                        sel.appendChild(opt);
                    });
            }



            function prodLoadBaseAlcohol() {
                const sel = document.getElementById("prodBaseAlcoholSelect");
                const id = sel?.value;
                if (!id) return;

                const mats = JSON.parse(localStorage.getItem("materials") || "[]");
                const mat = mats.find(m => m.id === id);
                if (!mat) return;

                // Felder automatisch setzen
                if (document.getElementById("prodBaseAlcStrength"))
                    document.getElementById("prodBaseAlcStrength").value = mat.strength || "";

                if (document.getElementById("prodBaseAlcPrice"))
                    document.getElementById("prodBaseAlcPrice").value = mat.pricePerUnit || "";

                prodUpdateBaseAlcoholInfo();
            }














            // üîπ Tats√§chliches Destillat ins Lager buchen
            function prodStoreBatchToStorage() {
                // ------------------------------------------
                // 0) Sicherstellen, dass ein Laufzettel existiert
                // ------------------------------------------
                if (!ensureMashRunSheetExistsBeforeStorage()) {
                    return; // Einlagerung abbrechen
                }


                if (!currentProductionRecipe) {
                    alert("Bitte zuerst ein Rezept ausw√§hlen.");
                    return;
                }

                const r = currentProductionRecipe;

                const V = parseFloat(document.getElementById("prodActualVolume")?.value);      // tats√§chliche Liter
                const A = parseFloat(document.getElementById("prodActualStrength")?.value);   // tats√§chliche %vol
                const T = parseFloat(document.getElementById("prodDrinkStrength")?.value);    // gew√ºnschte Trink-/Fassst√§rke
                const storageId = document.getElementById("prodStorageSelect")?.value;

                if (isNaN(V) || V <= 0 || isNaN(A) || A <= 0) {
                    alert("Bitte g√ºltige Werte f√ºr tats√§chliches Volumen und tats√§chliche St√§rke eingeben.");
                    return;
                }

                if (!storageId) {
                    alert("Bitte einen Ziel-Lagerbeh√§lter ausw√§hlen.");
                    return;
                }

                // Zielbeh√§lter laden
                const key = "storage_" + storageId;
                const storage = JSON.parse(localStorage.getItem(key) || "null");
                if (!storage) {
                    alert("Zielbeh√§lter nicht gefunden.");
                    return;
                }
                if (!storage.contents) storage.contents = [];

                // üîπ Bisheriger F√ºllstand
                let mix = { volume: 0, strength: 0 };
                if (typeof calcMixture === "function") {
                    const m = calcMixture(storage);
                    if (m && !isNaN(m.volume)) mix = m;
                }

                // üîπ Ziel: ggf. auf Trink-/Fassst√§rke verd√ºnnen
                let finalVolume = V;      // was wirklich ins Fass eingetragen wird
                let finalStrength = A;
                let water = 0;
                let usedTargetStrength = false;

                if (!isNaN(T) && T > 0 && T < A) {
                    const pure = V * A / 100;              // Liter Reinalkohol
                    const targetTotal = pure / (T / 100);  // neues Gesamtvolumen nach Verd√ºnnung
                    water = targetTotal - V;

                    finalVolume = targetTotal;
                    finalStrength = T;
                    usedTargetStrength = true;
                }

                // üîπ Kapazit√§tspr√ºfung (immer auf Basis "finalVolume")
                const cap = parseFloat(storage.capacity) || 0;
                if (cap > 0) {
                    const newTotal = (mix.volume || 0) + finalVolume;

                    if (newTotal > cap + 0.0001) {
                        alert(
                            "‚ùå Der Zielbeh√§lter ist zu klein!\n\n" +
                            `Kapazit√§t: ${cap.toFixed(1)} L\n` +
                            `Aktuell: ${(mix.volume || 0).toFixed(1)} L\n` +
                            `Neuer Eintrag: ${finalVolume.toFixed(1)} L\n\n` +
                            `‚Üí Gesamt: ${newTotal.toFixed(1)} L (ZU VIEL!)`
                        );
                        return;
                    }

                    if (newTotal > cap * 0.9) {
                        const ok = confirm(
                            `‚ö†Ô∏è Der Beh√§lter w√§re zu ${(newTotal / cap * 100).toFixed(0)} % gef√ºllt.\n` +
                            "Trotzdem fortfahren?"
                        );
                        if (!ok) return;
                    }
                }

                // üîπ Komponentenverteilung (fruitData) wie bisher ‚Äì bezogen auf den "rohen Brand" V
                const fruitData = {};
                let totalWeight = 0;
                (r.ingredients || []).forEach(i => totalWeight += (parseFloat(i.amount) || 0));

                (r.ingredients || []).forEach(i => {
                    const amount = parseFloat(i.amount) || 0;
                    if (amount <= 0) return;

                    let fraction = 0;
                    if (r.type === "percent") {
                        fraction = amount / 100;
                    } else {
                        if (totalWeight <= 0) return;
                        fraction = amount / totalWeight;
                    }

                    const liters = V * fraction;  // Beitrag dieser Komponente im Rohbrand
                    const name = i.name || "Komponente";
                    fruitData[name] = (fruitData[name] || 0) + liters;
                });

                const today = (typeof recipeToday === "function")
                    ? recipeToday()
                    : new Date().toISOString().split("T")[0];

                // üîπ Eintrag im Lager: bereits verd√ºnnte Menge & St√§rke
                storage.contents.push({
                    source: `Produktion: ${r.name}`,
                    volume: finalVolume,
                    strength: finalStrength,
                    fruitData: fruitData,
                    dateAdded: today
                });

                localStorage.setItem(key, JSON.stringify(storage));

                // üîπ Sch√∂ne R√ºckmeldung
                let msg =
                    "‚úÖ Produktion gebucht:\n\n" +
                    `${V.toFixed(2)} L @ ${A.toFixed(1)} % Vol (tats√§chlich)\n`;

                if (usedTargetStrength) {
                    const pure = V * A / 100;
                    const targetTotal = finalVolume;
                    msg +=
                        `Verd√ºnnt auf ${finalStrength.toFixed(1)} % Vol:\n` +
                        `‚Üí Neues Volumen im Lager: ${targetTotal.toFixed(2)} L\n` +
                        `‚Üí Wasserzugabe (theoretisch): ${water.toFixed(2)} L\n\n`;
                }

                msg += `Beh√§lter: ${storage.name}`;

                alert(msg);

                function ensureMashRunSheetExistsBeforeStorage() {
                    // gespeichert wird der Laufzettel unter runSheets[]
                    const sheets = JSON.parse(localStorage.getItem("runSheets") || "[]");

                    // aktuelle Batch-ID? (wird im Batch erzeugt)
                    const batchIdEl = document.getElementById("batchId");
                    const batchId = batchIdEl ? batchIdEl.value : null;

                    // Falls keine Batch-ID existiert ‚Üí keine Kontrolle
                    if (!batchId) return true;

                    // Gibt es einen Laufzettel zu dieser Batch?
                    const hasSheet = sheets.some(s => s.batchId === batchId);

                    if (hasSheet) return true;

                    // Kein Laufzettel vorhanden ‚Üí Benutzer fragen
                    const ok = confirm(
                        "‚ö†Ô∏è F√ºr diese Maische wurde noch kein Laufzettel erzeugt.\n\n" +
                        "M√∂chtest du jetzt einen Laufzettel erstellen, bevor du die Charge einlagerst?"
                    );

                    if (!ok) return false;

                    // Nutzer sagt "Ja" ‚Üí automatisch erzeugen
                    if (typeof createMashRunSheetFromCurrent === "function") {
                        const sheet = createMashRunSheetFromCurrent();
                        if (sheet) {
                            openRunSheet(sheet);
                            alert("Laufzettel wurde erstellt.");
                            return true;
                        }
                    }

                    alert("Fehler: Laufzettel konnte nicht erstellt werden.");
                    return false;
                }


                // üîπ Falls Lagerseite offen ist ‚Üí aktualisieren
                if (typeof loadStorageDetails === "function") {
                    const sel = document.getElementById("storageSelect");
                    if (sel && String(sel.value) === String(storage.id)) {
                        loadStorageDetails();
                    }
                }

                // Formularfelder f√ºr tats√§chlichen Brand leeren
                const actV = document.getElementById("prodActualVolume");
                const actS = document.getElementById("prodActualStrength");
                if (actV) actV.value = "";
                if (actS) actS.value = "";
                prodUpdateWaterInfo();
            }



            // ===================================================
            // Aroma Produkt erzeugen
            // ===================================================
            function prodCreateAromaProduct() {

                if (!window.aromaMaterialCheckDone) {
                    alert("Bitte zuerst einen Laufzettel mit Rohstoffpr√ºfung erzeugen, bevor du das Produkt speicherst.");
                    return;
                }

                if (!currentProductionRecipe || currentProductionRecipe.type !== "aroma") {
                    alert("Bitte ein Aroma-Rezept ausw√§hlen.");
                    return;
                }

                const r = currentProductionRecipe;
                const name = r.name;

                const alcLiters = parseFloat(document.getElementById("prodBaseAlcLiters")?.value) || 0;
                const alcStrength = parseFloat(document.getElementById("prodBaseAlcStrength")?.value) || 96;
                const alcPrice = parseFloat(document.getElementById("prodBaseAlcPrice")?.value) || 0;
                const baseAlcoholId = document.getElementById("prodBaseAlcoholSelect")?.value || null;

                if (alcLiters <= 0) {
                    alert("Bitte die Menge des Basisalkohols eingeben.");
                    return;
                }

                const AA = alcLiters * (alcStrength / 100);
                const alcCost = alcLiters * alcPrice;

                const botCosts = prodCalculateBotanicalCosts();
                const totalBotCost = botCosts.total;

                const macStart = document.getElementById("prodMacStart")?.value || null;
                const macEnd = document.getElementById("prodMacEnd")?.value || null;
                const macNotes = document.getElementById("prodMacNotes")?.value || "";

                const process = document.querySelector("input[name='aromaProcess']:checked")?.value || "distill";

                const finalStrength = parseFloat(document.getElementById("prodAromaFinalStrength")?.value) || alcStrength;
                const finalVolume = AA / (finalStrength / 100);
                const waterNeeded = finalVolume - alcLiters;

                // --- KOSTEN ---
                const totalCost = alcCost + totalBotCost;
                const costPerLiter = totalCost / finalVolume;

                // üîπ Hilfsfunktion: sauber runden
                const r2 = v => Math.round((v + Number.EPSILON) * 100) / 100;

                const product = {
                    id: "product_" + Date.now(),
                    name: `${name} ‚Äì Aroma-Charge vom ${new Date().toISOString().slice(0, 10)} (${finalVolume.toFixed(2)} L @ ${finalStrength}% vol)`,
                    type: "aroma",
                    origin: "aroma",
                    process,

                    created: new Date().toISOString(),

                    volumeL: finalVolume,
                    strength: finalStrength,
                    remainingVolume: finalVolume,

                    // ===== BASISALKOHOL =====
                    baseAlcohol: {
                        liters: alcLiters,
                        strength: alcStrength,
                        price: alcPrice,
                        AA,
                        cost: alcCost
                    },

                    // ===== BOTANICALS =====
                    botanicals: botCosts.items,
                    botanicalCost: totalBotCost,

                    // ===== MACERATION =====
                    maceration: {
                        start: macStart,
                        end: macEnd,
                        notes: macNotes
                    },

                    // ===== KOSTEN (alte Struktur bleibt bestehen!) =====
                    costs: {
                        total: r2(totalCost),
                        perLiter: r2(costPerLiter),
                        waterNeeded
                    },

                    // ===== NEU: Standardfelder f√ºr ALLE Module =====
                    totalCosts: r2(totalCost),
                    costPerLiter: r2(costPerLiter),

                    // ===== MINDESTPREISE =====
                    calcPrice: {
                        "0.5": { min: r2(costPerLiter * 0.5), profit: null },
                        "0.7": { min: r2(costPerLiter * 0.7), profit: null },
                        "1.0": { min: r2(costPerLiter * 1.0), profit: null }
                    },

                    // ===== BENUTZERPREISE (leer) =====
                    userPrice: {
                        "0.5": null,
                        "0.7": null,
                        "1.0": null
                    }
                };

                // --- SPEICHERN ---
                const products = JSON.parse(localStorage.getItem("products") || "[]");
                products.push(product);
                localStorage.setItem("products", JSON.stringify(products));

                // --- LAGER ABBUCHEN ---
                if (baseAlcoholId) {
                    const warnings = materialConsumeBaseAlcoholById(baseAlcoholId, alcLiters);
                    if (warnings.length) {
                        alert(warnings.join("\n"));
                        return;
                    }
                }

                prodResetAromaPage();
                alert("Aroma-Produkt erfolgreich gespeichert!");
            }




            function materialConsumeBaseAlcoholById(materialId, liters) {

                const materials = JSON.parse(localStorage.getItem("materials") || "[]");
                const mat = materials.find(m => m.id === materialId);

                if (!mat) {
                    return ["Basisalkohol nicht gefunden."];
                }

                if (mat.remaining < liters) {
                    return [
                        `${mat.name} zu knapp: ben√∂tigt ${liters.toFixed(2)} L, ` +
                        `vorhanden ${mat.remaining.toFixed(2)} L`
                    ];
                }

                mat.remaining -= liters;
                localStorage.setItem("materials", JSON.stringify(materials));
                return [];
            }





            // ==============================================
            // Kalkulation der Botanicalsprodukte
            // ==============================================
            function prodCalculateBotanicalCosts() {

                const r = currentProductionRecipe;
                if (!r || r.type !== "aroma") return { total: 0, items: [] };

                const total = prodGetBotanicalTotal();
                if (!total) return { total: 0, items: [] };

                let sum = 0;
                let list = [];

                const mats = materialLoadAll();

                let totalUnits = 0;
                r.ingredients.forEach(i => totalUnits += parseFloat(i.amount) || 0);

                r.ingredients.forEach(i => {
                    const base = parseFloat(i.amount) || 0;
                    if (base <= 0) return;

                    const frac = base / totalUnits;
                    const used = total * frac;

                    const mat = mats.find(m => m.name.toLowerCase() === i.name.toLowerCase());
                    const price = mat ? (mat.pricePerUnit / (mat.unit === "g" ? 1 : 1)) : 0;

                    const cost = used * price;
                    sum += cost;

                    list.push({
                        name: i.name,
                        used,
                        cost
                    });
                });

                return {
                    total: sum,
                    items: list
                };
            }







            function prodResetAromaPage() {

                currentProductionRecipe = null;

                // Eingabefelder leeren
                const ids = [
                    "prodBaseAlcLiters", "prodBaseAlcStrength", "prodBaseAlcPrice",
                    "prodBotTotal", "prodBotPerLiter", "prodMacStart", "prodMacEnd",
                    "prodMacNotes"
                ];

                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = "";
                });

                // Info-Boxen zur√ºcksetzen
                document.getElementById("prodBaseAlcInfo").innerHTML = "<em>Bitte Menge und Preis eingeben.</em>";
                document.getElementById("prodBotanicalCostTable").innerHTML = "<em>Die Tabelle wird angezeigt, wenn eine geplante Menge eingegeben ist.</em>";

                // Bl√∂cke ausblenden
                [
                    "prodAromaProcessBlock",
                    "prodBaseAlcoholBlock",
                    "prodAromaBotCalcBlock",
                    "prodBotanicalCostBlock",
                    "prodActualDistillBlock",
                    "prodAromaCostBlock",
                    "prodAromaBottleBlock",
                    "prodAromaCreateBlock",
                    "prodAromaStoreBlock",
                    "prodMacerationBlock",
                    "prodAromaTargetStrengthBlock"
                ].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = "none";
                });

                // Rezept-Info zur√ºcksetzen
                document.getElementById("prodRecipeInfo").innerHTML = "<em>Noch kein Rezept ausgew√§hlt.</em>";

                // Dropdown zur√ºcksetzen
                const sel = document.getElementById("prodRecipeSelect");
                if (sel) sel.value = "";

                // ‚≠ê NEU: Rohstoff-Status zur√ºcksetzen
                window.aromaMaterialCheckDone = false;
                window.aromaMaterialsConsumed = false;
            }






            function prodGetScaledIngredients() {
                if (!currentProductionRecipe) return [];

                const r = currentProductionRecipe;
                const total = prodGetBotanicalTotal();   // Gesamtmenge Botanicals

                if (isNaN(total) || total <= 0) return [];

                if (!r.ingredients || r.ingredients.length === 0) return [];

                // Summe der Rezeptmengen f√ºr klassische Aroma-Rezepte
                let totalWeight = 0;
                r.ingredients.forEach(i => totalWeight += (parseFloat(i.amount) || 0));

                const list = [];

                r.ingredients.forEach(i => {
                    const amount = parseFloat(i.amount) || 0;
                    if (amount <= 0) return;

                    let fraction = 0;

                    if (r.type === "percent") {
                        fraction = amount / 100;
                    } else {
                        if (totalWeight <= 0) return;
                        fraction = amount / totalWeight;
                    }

                    const scaled = total * fraction;

                    list.push({
                        name: i.name,
                        amount: scaled,
                        unit: "g"
                    });
                });

                return list;
            }




            function prodCreateAromaRunSheet() {

                if (!currentProductionRecipe) {
                    alert("Bitte zuerst ein Rezept ausw√§hlen.");
                    return;
                }

                const recipe = currentProductionRecipe;

                // 1) Botanicals skalieren
                const scaledIngredients = prodGetScaledIngredients();
                if (!scaledIngredients.length) {
                    alert("Keine g√ºltigen Zutaten; bitte Eingaben pr√ºfen.");
                    return;
                }

                // 2) Basisalkohol einlesen
                const baseLiters = parseFloat(
                    document.getElementById("prodBaseAlcLiters")?.value
                );

                const baseStrength = parseFloat(
                    document.getElementById("prodBaseAlcStrength")?.value
                );

                // Zielst√§rke optional ‚Üí wenn leer, Basisst√§rke verwenden
                let finalStrength = parseFloat(
                    document.getElementById("prodAromaFinalStrength")?.value
                );

                if (isNaN(finalStrength)) {
                    finalStrength = baseStrength;
                }


                if (
                    isNaN(baseLiters) || baseLiters <= 0 ||
                    isNaN(baseStrength) || baseStrength <= 0 ||
                    isNaN(finalStrength) || finalStrength <= 0
                ) {
                    alert("Bitte Menge und St√§rke des Alkohols korrekt eingeben.");
                    return;
                }

                const process = document.querySelector("input[name='aromaProcess']:checked")?.value;

                let waterNeeded = null;
                let waterInfo = null;

                if (process === "noDistill") {
                    const LAA = baseLiters * (baseStrength / 100);
                    const totalVol = LAA / (finalStrength / 100);
                    waterNeeded = totalVol - baseLiters;
                    waterInfo = "Wasserbedarf f√ºr Mazeration (Compound-Herstellung)";
                }

                const totalBotWeight = scaledIngredients.reduce((s, i) => s + i.amount, 0);

                // 3) Rohstoffpr√ºfung vorbereiten
                const checkRows = materialCheckBeforeConsume(
                    scaledIngredients.map(i => ({
                        name: i.name,
                        needed: i.amount,     // g
                        unit: i.unit || "g",
                        category: "kraeuter"
                    }))
                );

                // 4) Dialog anzeigen
                showMaterialConfirmDialog(checkRows, answer => {

                    if (answer === "cancel") {
                        alert("Vorgang abgebrochen.");
                        window.aromaMaterialCheckDone = false;
                        window.aromaMaterialsConsumed = false;
                        return;
                    }

                    if (answer === "yes") {
                        materialConsumeFromBatch("aroma", scaledIngredients);
                        window.aromaMaterialsConsumed = true;   // ‚≠ê Rohstoffe wurden tats√§chlich abgebucht
                        window.aromaMaterialCheckDone = true;   // ‚≠ê Pr√ºfung abgeschlossen
                    }

                    if (answer === "no") {
                        // keine automatische Abbuchung, aber Pr√ºfung wurde durchgef√ºhrt
                        window.aromaMaterialsConsumed = false;
                        window.aromaMaterialCheckDone = true;
                    }

                    const sheet = createAromaRunSheet(
                        recipe,
                        scaledIngredients,
                        baseLiters,
                        {
                            baseAlcohol_l: baseLiters,
                            baseAlcohol_strength: baseStrength,
                            finalStrength: finalStrength,
                            totalBotanicalWeight: totalBotWeight,
                            waterNeeded: waterNeeded,
                            waterInfo: waterInfo,
                            process: process
                        }
                    );

                    openRunSheet(sheet);
                });

            }




            function createAromaRunSheet(recipe, scaledIngredients, baseLiters, extraInfo = {}) {

                const sheet = {
                    id: "run_" + Date.now(),
                    date: new Date().toISOString().slice(0, 10),

                    type: "aroma",

                    recipeId: recipe.id,
                    recipeName: recipe.name,

                    // Zutatenliste f√ºr den Ansatz
                    items: scaledIngredients.map(i => ({
                        name: i.name,
                        amount: i.amount,
                        unit: i.unit || "g"
                    })),

                    // Basisinfos √ºber den Ansatz (flexibel erweiterbar)
                    info: {
                        baseAlcohol_l: extraInfo.baseAlcohol_l ?? baseLiters,
                        baseAlcohol_strength: extraInfo.baseAlcohol_strength ?? null,
                        finalStrength: extraInfo.finalStrength ?? null,
                        totalBotanicalWeight: extraInfo.totalBotanicalWeight ?? null,
                        waterNeeded: extraInfo.waterNeeded ?? null,
                        waterInfo: extraInfo.waterInfo ?? null,
                        process: extraInfo.process ?? null
                    }
                };

                // Laufzettel-Speicher einlesen
                let all = JSON.parse(localStorage.getItem("runSheets") || "[]");
                if (!Array.isArray(all)) all = [];

                // Laufzettel speichern
                all.push(sheet);
                localStorage.setItem("runSheets", JSON.stringify(all));

                return sheet;
            }



            function loadRunSheetList() {
                const box = document.getElementById("runSheetList");
                if (!box) return;

                const all = JSON.parse(localStorage.getItem("runSheets") || "[]");

                if (!all.length) {
                    box.innerHTML = "<em>Noch keine Laufzettel vorhanden.</em>";
                    return;
                }

                // Neueste zuerst
                all.sort((a, b) => (b.date || "").localeCompare(a.date || ""));

                let html = `
                    <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                        <tr style="background:#eee;">
                            <th style="padding:6px; text-align:left;">Datum</th>
                            <th style="padding:6px; text-align:left;">Kategorie</th>
                            <th style="padding:6px; text-align:left;">Rezeptname</th>
                            <th style="padding:6px; text-align:center;">Aktion</th>
                        </tr>
                `;

                all.forEach(s => {
                    html += `
                        <tr>
                            <td style="border-top:1px solid #ccc; padding:6px;">${s.date || "-"}</td>
                            <td style="border-top:1px solid #ccc; padding:6px;">${s.type || "-"}</td>
                            <td style="border-top:1px solid #ccc; padding:6px;">${s.recipeName || "-"}</td>
                            <td style="border-top:1px solid #ccc; padding:6px; text-align:center;">
                                <button onclick="openRunSheetById('${s.id}')">√ñffnen</button>
                                <button onclick="deleteRunSheet('${s.id}')" style="margin-left:6px; color:red;">
                                    L√∂schen
                                </button>
                            </td>
                        </tr>
                    `;
                });

                html += "</table>";

                box.innerHTML = html;
            }




            function openRunSheetById(id) {
                const all = JSON.parse(localStorage.getItem("runSheets") || "[]");
                const sheet = all.find(s => s.id === id);

                if (!sheet) {
                    alert("Laufzettel nicht gefunden.");
                    return;
                }

                openRunSheet(sheet);
            }




            function deleteRunSheet(id) {
                if (!confirm("Soll dieser Laufzettel wirklich gel√∂scht werden?")) {
                    return;
                }

                let list = JSON.parse(localStorage.getItem("runSheets") || "[]");

                list = list.filter(s => s.id !== id);

                localStorage.setItem("runSheets", JSON.stringify(list));

                // Tabelle neu laden
                if (typeof loadRunSheetList === "function") {
                    loadRunSheetList();
                }

                alert("Laufzettel wurde gel√∂scht.");
            }




            function calcCurrentStrength(storage) {

                if (!storage || !Array.isArray(storage.contents))
                    return 0;

                let totalVol = 0;
                let totalAA = 0;

                storage.contents.forEach(e => {

                    const vol = Number(e.volume) || 0;
                    if (vol <= 0) return;

                    // AA bevorzugen
                    let aa = Number(e.AA);

                    // falls AA fehlt -> aus strength berechnen
                    if (isNaN(aa)) {
                        aa = vol * ((Number(e.strength) || 0) / 100);
                    }

                    totalVol += vol;
                    totalAA += aa;
                });

                if (totalVol <= 0) return 0;

                return (totalAA / totalVol) * 100;
            }










            // ===================================================
            //  Rezept wirklich auf Lager anwenden (Advanced)
            // ===================================================
            function recipeApplyToStorage() {
                const planBox = document.getElementById("applyStoragePlan");

                const recipeId = document.getElementById("recipeId").value.trim();
                if (!recipeId) {
                    alert("Bitte zuerst ein Rezept ausw√§hlen / laden.");
                    if (planBox) planBox.innerHTML = "";
                    return;
                }

                const list = recipeLoadAll();
                const recipe = list.find(x => x.id === recipeId);
                if (!recipe) {
                    alert("Rezept nicht gefunden.");
                    if (planBox) planBox.innerHTML = "";
                    return;
                }

                // Zielgesamtmenge aus dem Feld "Geplante Gesamtmenge (L)"
                const totalVol = parseFloat(document.getElementById("applyTotalVolume").value);
                if (isNaN(totalVol) || totalVol <= 0) {
                    alert("Bitte eine g√ºltige Gesamtmenge angeben (oben im Batch-Block).");
                    if (planBox) planBox.innerHTML = "";
                    return;
                }

                // 1) Anteile bestimmen: wie viele Liter pro Zutat?
                let totalWeight = 0;
                recipe.ingredients.forEach(i => totalWeight += i.amount);

                const needs = recipe.ingredients.map(i => {
                    let frac;
                    if (recipe.type === "percent") {
                        frac = i.amount / 100;
                    } else {
                        // aroma/mash: nach Gewichtung
                        frac = totalWeight > 0 ? (i.amount / totalWeight) : 0;
                    }
                    return {
                        fruit: i.name,
                        liters: totalVol * frac
                    };
                }).filter(n => n.liters > 0.0001);

                if (!needs.length) {
                    alert("Dieses Rezept hat keine verwertbaren Zutaten.");
                    if (planBox) planBox.innerHTML = "";
                    return;
                }

                // 2) Lager analysieren ‚Äì nur "reine" Eintr√§ge verwenden, wie bisher
                const storageKeys = Object.keys(localStorage).filter(k => k.startsWith("storage_"));
                const storages = storageKeys
                    .map(k => JSON.parse(localStorage.getItem(k)))
                    .filter(Boolean);

                if (!storages.length) {
                    alert("‚ùå Es sind noch keine Lagerbeh√§lter angelegt.");
                    if (planBox) planBox.innerHTML = "";
                    return;
                }

                const sources = []; // {storageId, storageName, fruit, available, strength}

                function cleanFruitName(label) {
                    return (label || "").replace(/\([^)]*\)/g, "").trim();
                }

                storages.forEach(st => {
                    if (!st.contents || !Array.isArray(st.contents)) return;

                    st.contents.forEach(c => {
                        const vol = parseFloat(c.volume) || 0;
                        const str = parseFloat(c.strength) || 0;
                        if (vol <= 0 || str <= 0) return; // Wasser oder Unsinn ignorieren

                        // a) Neue Struktur mit fruitData
                        if (c.fruitData && typeof c.fruitData === "object") {

                            const fruits = Object.keys(c.fruitData);

                            // Nur reine Fruchtbeh√§lter
                            if (fruits.length === 1) {

                                const fKey = fruits[0];

                                const totalVol = Number(c.volume) || 0;
                                if (totalVol <= 0.0001) return;

                                // *** ABSOLUTER ALKOHOL ***
                                const AA = totalVol * (Number(c.strength) || 0) / 100;

                                sources.push({
                                    storageId: st.id,
                                    storageName: st.name,
                                    fruit: cleanFruitName(fKey),

                                    available: totalVol,          // ‚Üê echtes Lager-Volumen
                                    AA,                           // ‚Üê absoluter Alkohol
                                    productId: c.productId
                                });
                            }
                        }



                        // b) Alte Struktur: fruit + volume, ohne Prozent-Mix
                        else if (c.fruit && !c.fruit.includes("%")) {
                            const f = cleanFruitName(c.fruit);
                            if (!f) return;
                            sources.push({
                                storageId: st.id,
                                storageName: st.name,
                                fruit: f,
                                available: vol,
                                strength: str
                            });
                        }
                    });
                });

                if (!sources.length) {
                    alert("‚ùå Es sind keine passenden Destillate im Lager (mit Fruchtangaben) vorhanden.");
                    if (planBox) planBox.innerHTML = "";
                    return;
                }

                // 3) Pr√ºfen, ob insgesamt genug vorhanden ist (wie bisher)
                const missing = [];
                needs.forEach(n => {
                    console.log("== NEED ==", n);
                    console.log("== SOURCES ==", sources);

                    const totalAvail = sources
                        .filter(s => s.fruit === n.fruit)
                        .reduce((a, b) => a + b.available, 0);

                    if (totalAvail + 0.0001 < n.liters) {
                        missing.push(
                            `${n.fruit}: ben√∂tigt ${n.liters.toFixed(2)} L, vorhanden: ${totalAvail.toFixed(2)} L`
                        );
                    }
                });

                if (missing.length > 0) {
                    alert("‚ùå Mischung NICHT m√∂glich ‚Äì folgende Mengen fehlen:\n\n" + missing.join("\n"));
                    if (planBox) planBox.innerHTML = "";
                    return;
                }

                // 4) Optionen pro Frucht: welche Beh√§lter k√∂nnen JEWEILS komplett tragen?
                const optionsByFruitMap = {}; // fruit -> { storageId -> aggInfo }

                sources.forEach(s => {
                    if (!optionsByFruitMap[s.fruit]) optionsByFruitMap[s.fruit] = {};
                    const bucket = optionsByFruitMap[s.fruit];
                    if (!bucket[s.storageId]) {
                        bucket[s.storageId] = {
                            storageId: s.storageId,
                            storageName: s.storageName,
                            volume: 0,
                            alcoholLiters: 0
                        };
                    }
                    bucket[s.storageId].volume += s.available;
                    bucket[s.storageId].alcoholLiters += s.available * (s.strength / 100);
                });

                const optionsByFruit = {}; // fruit -> [{storageId, storageName, available, strength}]
                Object.keys(optionsByFruitMap).forEach(fruit => {
                    const arr = Object.values(optionsByFruitMap[fruit]).map(o => {
                        const avgStrength = o.volume > 0 ? (o.alcoholLiters / o.volume) * 100 : 0;
                        return {
                            storageId: o.storageId,
                            storageName: o.storageName,
                            available: o.volume,
                            strength: avgStrength
                        };
                    });
                    optionsByFruit[fruit] = arr;
                });

                // 5) Sicherstellen, dass es f√ºr jede Frucht MINDESTENS einen Beh√§lter gibt,
                //    der die gesamte ben√∂tigte Menge alleine liefern kann (unser ‚Äû1-Beh√§lter-pro-Frucht‚Äú-Konzept)
                const lackingSingleTank = [];
                needs.forEach(n => {
                    const candidates = (optionsByFruit[n.fruit] || []).filter(
                        o => o.available + 0.0001 >= n.liters
                    );
                    if (candidates.length === 0) {
                        const totalAvail = sources
                            .filter(s => s.fruit === n.fruit)
                            .reduce((a, b) => a + b.available, 0);
                        lackingSingleTank.push(
                            `${n.fruit}: Rezept verlangt ${n.liters.toFixed(2)} L,\n` +
                            `kein einzelner Beh√§lter hat genug (maximal pro Beh√§lter: ${totalAvail.toFixed(2)} L gesamt).`
                        );
                    }
                });

                if (lackingSingleTank.length > 0) {
                    alert(
                        "‚ùå Rezept kann nur mit Aufteilen auf mehrere Beh√§lter erf√ºllt werden.\n" +
                        "Wir erlauben aktuell: pro Frucht genau EIN Beh√§lter.\n\n" +
                        lackingSingleTank.join("\n\n")
                    );
                    if (planBox) planBox.innerHTML = "";
                    return;
                }

                // 6) Kontext f√ºr den 2. Schritt merken
                window.currentRecipeApplyCtx = {
                    recipeId,
                    recipe,
                    totalVol,
                    needs,
                    sources,
                    optionsByFruit
                };

                // 7) Sch√∂ne Tabelle mit Auswahl pro Frucht anzeigen
                if (!planBox) {
                    alert("Plan berechnet ‚Äì aber kein Ausgabe-Element #applyStoragePlan gefunden.");
                    return;
                }

                let html = `<strong>Rezept auf Lager anwenden ‚Äì Schritt 1/2</strong><br>
                    Geplante Gesamtmenge: ${totalVol.toFixed(2)} L<br><br>
                    W√§hle f√ºr jede Zutat einen Lagerbeh√§lter, aus dem entnommen werden soll:
                    <br><br>
                    <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                        <tr style="background:#eee;">
                            <th style="text-align:left; padding:4px;">Frucht</th>
                            <th style="text-align:right; padding:4px;">Ben√∂tigt (L)</th>
                            <th style="text-align:left; padding:4px;">Quelle w√§hlen</th>
                        </tr>
                `;

                needs.forEach((n, index) => {
                    const candidates = (optionsByFruit[n.fruit] || []).filter(
                        o => o.available + 0.0001 >= n.liters
                    );

                    html += `<tr>
                        <td style="border-top:1px solid #ccc; padding:4px;">${n.fruit}</td>
                        <td style="border-top:1px solid #ccc; padding:4px; text-align:right;">
                            ${n.liters.toFixed(2)} L
                        </td>
                        <td style="border-top:1px solid #ccc; padding:4px;">`;

                    if (!candidates.length) {

                        html += `<span style="color:#b91c1c;">Keine passende Quelle</span>`;

                    } else {

                        html += `<select id="recipeAlloc_${index}" data-fruit="${n.fruit}" style="width:100%;">`;

                        candidates.forEach(c => {

                            // --- Original-Lager lesen ---
                            const key = "storage_" + c.storageId;
                            const st = JSON.parse(localStorage.getItem(key) || "null");

                            // aktuelles Volumen bestimmen
                            let totalVol = 0;
                            if (st && Array.isArray(st.contents)) {
                                st.contents.forEach(e => totalVol += Number(e.volume) || 0);
                            }

                            // %vol korrekt berechnen
                            const abv = calcCurrentStrength(st);

                            html += `
                                <option value="${c.storageId}">
                                    ${c.storageName} ‚Äì ${totalVol.toFixed(2)} L @ ${abv.toFixed(1)} %vol
                                </option>
                            `;
                        });

                        html += `</select>`;
                    }

                    html += `</td></tr>`;
                });

                html += `</table>
                        <br>
                        <button type="button" onclick="recipeApplyToStorageConfirm()" style="width:100%; margin-top:4px;">
                            ‚úÖ Mischung jetzt ins Lager buchen
                        </button>
                        <div style="font-size:0.8em; color:#555; margin-top:4px;">
                            Hinweis: Pro Frucht wird genau ein Beh√§lter verwendet. 
                            Wasser wird <strong>nicht</strong> automatisch zugegeben ‚Äì die geplante Verd√ºnnung siehst du sp√§ter
                            in der Chargen-/Lageransicht.
                        </div>
                    `;


                planBox.innerHTML = html;
            }




            function recipeApplyToStorageConfirm() {
                const ctx = window.currentRecipeApplyCtx;
                if (!ctx) {
                    alert('Bitte zuerst "Rezept auf Lager anwenden" ausf√ºhren.');
                    return;
                }

                const { recipe, needs, sources, totalVol } = ctx;

                // Auswahl pro Frucht einsammeln
                const selectedByFruit = {};
                const missingSelection = [];

                needs.forEach((n, index) => {
                    const sel = document.getElementById("recipeAlloc_" + index);
                    if (!sel || !sel.value) {
                        missingSelection.push(n.fruit);
                    } else {
                        selectedByFruit[n.fruit] = sel.value; // storageId
                    }
                });

                if (missingSelection.length > 0) {
                    alert(
                        "Bitte f√ºr alle Zutaten einen Lagerbeh√§lter w√§hlen:\n\n" +
                        missingSelection.join(", ")
                    );
                    return;
                }

                // Zielbeh√§lter ausw√§hlen (wie bisher)
                const storageKeys = Object.keys(localStorage).filter(k => k.startsWith("storage_"));
                const storages = storageKeys
                    .map(k => JSON.parse(localStorage.getItem(k)))
                    .filter(Boolean);

                if (!storages.length) {
                    alert("‚ùå Es sind noch keine Lagerbeh√§lter angelegt.");
                    return;
                }

                // vorhandene Funktion weiterverwenden
                openStorageSelectModal(storages, selectedStorage => {
                    try {
                        applyRecipeToSelectedStorage(
                            selectedStorage,
                            recipe,
                            needs,
                            // Kopie der Sources, damit wir available anpassen d√ºrfen
                            JSON.parse(JSON.stringify(sources)),
                            totalVol,
                            selectedByFruit
                        );

                        // Plan danach zur√ºcksetzen
                        window.currentRecipeApplyCtx = null;
                        const planBox = document.getElementById("applyStoragePlan");
                        if (planBox) planBox.innerHTML = "";
                    } catch (e) {
                        alert("Fehler beim Anwenden des Rezepts:\n" + (e.message || e));
                    }
                });
            }




            function applyRecipeToSelectedStorage(
                target,
                recipe,
                needs,
                sources,
                totalVol,
                selectedByFruit
            ) {
                selectedByFruit = selectedByFruit || {};

                const withdrawals = [];

                // ================================
                // 1) Entnahmen je Frucht bestimmen
                // ================================
                needs.forEach(n => {
                    let remaining = n.liters;

                    sources
                        .filter(s => s.fruit === n.fruit)
                        .forEach(s => {
                            if (remaining <= 0) return;

                            // --- Original-Lager abrufen ---
                            const key = "storage_" + s.storageId;
                            const st = JSON.parse(localStorage.getItem(key) || "null");
                            if (!st || !Array.isArray(st.contents)) return;

                            // === reale AA & Volumen wie in caskTransfer() ===
                            let totalVol = 0;
                            let totalAA = 0;

                            st.contents.forEach(e => {
                                const vol = Number(e.volume) || 0;
                                const aa = Number(e.AA) || (vol * ((Number(e.strength) || 0) / 100));

                                totalVol += vol;
                                totalAA += aa;
                            });

                            if (totalVol <= 0) return;

                            const realStrength = (totalAA / totalVol) * 100;

                            // --- m√∂gliche Abgabemenge ---
                            const avail = totalVol;
                            const take = Math.min(avail, remaining);
                            if (take <= 0) return;

                            const AA = take * (realStrength / 100);

                            withdrawals.push({
                                storageId: s.storageId,
                                productId: s.productId || null,
                                fruit: n.fruit,
                                take,
                                AA,
                                strength: realStrength
                            });

                            console.log("ADD WITHDRAWAL", withdrawals[withdrawals.length - 1]);

                            remaining -= take;
                        });

                    if (remaining > 0.0001) {
                        alert(`‚ùå Nicht genug ${n.fruit} verf√ºgbar.`);
                        throw new Error("Mengenfehler im Rezept");
                    }
                });

                if (!withdrawals.length) {
                    alert("‚ùå Keine g√ºltigen Entnahmen ermittelt.");
                    return;
                }

                // ================================
                // 2) Mischung berechnen
                // ================================
                const pureVolume = withdrawals.reduce((s, w) => s + w.take, 0);
                const pureAlcohol = withdrawals.reduce((s, w) => s + (w.AA || 0), 0);

                const mixStrength = pureAlcohol / pureVolume * 100;

                const targetStrength = parseFloat(recipe.targetStrength) || 40;
                const finalVolume = pureAlcohol / (targetStrength / 100);
                const waterNeeded = Math.max(0, finalVolume - pureVolume);


                // ================================
                // 3) Quelllager ABBUCHEN ‚Äì proportional + Entnahme-Datensatz
                // ================================
                withdrawals.forEach(w => {

                    const key = "storage_" + w.storageId;
                    const st = JSON.parse(localStorage.getItem(key) || "null");
                    if (!st || !Array.isArray(st.contents)) return;

                    const date = new Date().toISOString().slice(0, 10);

                    let remaining = w.take;

                    // --- Gesamtvolumen im Beh√§lter
                    let totalVol = 0;
                    st.contents.forEach(e => totalVol += Number(e.volume) || 0);

                    if (totalVol <= 0) return;

                    // --- proportional abbuchen
                    st.contents.forEach(e => {
                        if (remaining <= 0) return;

                        let vol = Number(e.volume) || 0;
                        if (vol <= 0) return;

                        const ratio = vol / totalVol;
                        const part = Math.min(remaining, w.take * ratio);

                        e.volume = vol - part;

                        if (typeof e.AA === "number") {
                            e.AA = e.AA - (e.AA * (part / vol));
                        }

                        remaining -= part;
                    });

                    // --- leere entfernen
                    st.contents = st.contents.filter(e => (Number(e.volume) || 0) > 0.0001);


                    // ======================
                    // 3b) ENTNAHME ALS NEUER TABELLENEINTRAG
                    // ======================
                    st.contents.push({
                        id: "withdrawal_" + Date.now(),
                        source: `Rezept: ${recipe.name}`,
                        volume: -w.take,
                        strength: w.strength,
                        AA: -(w.AA || 0),
                        dateAdded: date
                    });


                    // --- Status aktualisieren
                    let sum = 0;
                    st.contents.forEach(e => sum += Number(e.volume) || 0);
                    st.status = (sum > 0.05) ? "in_use" : "empty";

                    localStorage.setItem(key, JSON.stringify(st));
                });





                // 4) Produkt-Referenzen sammeln
                const productRefs = {};
                withdrawals.forEach(w => {
                    if (!w.productId) return;
                    productRefs[w.productId] =
                        (productRefs[w.productId] || 0) + w.take;
                });

                // 5) Zielbeh√§lter bef√ºllen
                if (!Array.isArray(target.contents)) target.contents = [];

                const today = new Date().toISOString().slice(0, 10);

                const plannedDilution = {
                    realVolume: pureVolume,
                    realStrength: mixStrength,
                    AA: pureAlcohol,
                    targetAbv: targetStrength,
                    targetVolume: finalVolume,
                    waterNeeded
                };

                target.contents.push({
                    id: "item_" + Date.now(),
                    source: `Rezept: ${recipe.name}`,
                    volume: pureVolume,
                    strength: mixStrength,
                    productRefs,
                    dateAdded: today,
                    waterAdded: 0,
                    plannedDilution
                });

                localStorage.setItem("storage_" + target.id, JSON.stringify(target));

                // 6) Produkt anlegen (Kostenkette)
                const products = JSON.parse(localStorage.getItem("products") || "[]");

                let totalCosts = 0;
                Object.entries(productRefs).forEach(([pid, liters]) => {
                    const p = products.find(x => x.id === pid);
                    if (p && typeof p.costPerLiter === "number") {
                        totalCosts += liters * p.costPerLiter;
                    }
                });

                const costPerLiter =
                    finalVolume > 0 ? totalCosts / finalVolume : 0;

                const recipeProduct = {
                    id: "product_" + Date.now(),
                    name: "Rezeptmix ‚Äì " + recipe.name,
                    origin: "recipe",

                    volumeL: finalVolume,
                    strength: targetStrength,

                    totalCosts,
                    costPerLiter,
                    productRefs,

                    userPrice: { "0.5": null, "0.7": null, "1.0": null },

                    calcPrice: {
                        "0.5": { min: costPerLiter * 0.5, profit: null },
                        "0.7": { min: costPerLiter * 0.7, profit: null },
                        "1.0": { min: costPerLiter * 1.0, profit: null }
                    },

                    remainingVolume: finalVolume,
                    plannedDilution
                };

                products.push(recipeProduct);
                localStorage.setItem("products", JSON.stringify(products));

                alert("‚úÖ Rezeptmix korrekt erzeugt (mit Produkt-Herkunft & Kostenkette).");
            }







            function isMashSheet(s) {
                return s.kgMash !== undefined && s.strikeWater !== undefined;
            }

            function isAromaSheet(sheet) {
                return sheet.type === "aroma";
            }


            function isPercentSheet(s) {
                return s.type === "percent";
            }







            function renderRunSheetMash(sheet) {
                const html = `
                <html>
                <head>
                    <title>Laufzettel ‚Äì ${sheet.recipeName}</title>
                    <style>
                        body { font-family: Arial; padding:20px; line-height:1.4; }
                        h2 { margin-top:0; }
                        table { width:100%; border-collapse: collapse; margin-top:10px; }
                        th, td { border:1px solid #ccc; padding:6px; }
                        th { background:#f0f0f0; }
                    </style>
                </head>
                <body>

                    <h2>Laufzettel ‚Äì ${sheet.recipeName}</h2>

                    <p><strong>Datum:</strong> ${sheet.date}</p>
                    <p><strong>Sch√ºttung:</strong> ${sheet.kgMash} kg</p>

                    <h3>Wassermengen</h3>
                    <p>
                        Strike Water: ${sheet.strikeWater.toFixed(2)} L<br>
                        Sparge Water: ${sheet.spargeWater.toFixed(2)} L<br>
                        Gesamt: ${sheet.totalWater.toFixed(2)} L
                    </p>

                    <h3>Rohstoffe</h3>
                    <div class="table-scroll">
                    <table>
                        <tr><th>Name</th><th>Fraktion</th><th>Menge (kg)</th></tr>
                        ${sheet.ingredients
                        .map(i => `
                                <tr>
                                    <td>${i.name}</td>
                                    <td>${(i.fraction * 100).toFixed(1)}%</td>
                                    <td>${i.amount.toFixed(2)}</td>
                                </tr>
                            `).join("")}
                    </table>
                    </div>

                    <p style="margin-top:30px; font-size:0.8em; color:#666;">
                        Laufzettel automatisch erstellt am ${new Date().toLocaleString()}
                    </p>

                </body>
                </html>
                `;

                const w = window.open("", "_blank");
                w.document.write(html);
                w.document.close();
            }



            // -------------------------------------------------------
            // Gemeinsame Einstiegspunkt-Funktion f√ºr ALLE Laufzettel
            // -------------------------------------------------------
            function openRunSheet(sheet) {

                if (!sheet) {
                    alert("Laufzettel ist leer oder ung√ºltig.");
                    return;
                }



                // 1) Maisch / Whisky?
                if (isMashSheet(sheet)) {
                    renderRunSheetMash(sheet);
                    return;
                }

                // 2) Aroma?
                if (isAromaSheet(sheet)) {
                    renderRunSheetAroma(sheet);
                    return;
                }

                // 3) Percent / Obst?
                if (isPercentSheet(sheet)) {
                    renderRunSheetPercent(sheet);
                    return;
                }

                alert("Unbekannter Laufzetteltyp ‚Äì Format wurde nicht erkannt.");
            }




            function openWhiskyRunSheet() {
                // Pr√ºfen, ob eine Charge geladen ist
                const current = window.currentBatch;
                if (!current) {
                    alert("Bitte zuerst eine Charge laden.");
                    return;
                }

                // Laufzettel laden
                let all = JSON.parse(localStorage.getItem("runSheets") || "[]");
                if (!Array.isArray(all)) all = [];

                if (all.length === 0) {
                    alert("Es existiert noch kein Laufzettel.");
                    return;
                }

                // 1Ô∏è‚É£ EXAKTER Match √ºber batchId (neue Laufzettel)
                let sheet = all.find(s => s.batchId === current.id);

                // 2Ô∏è‚É£ Fallback f√ºr alte Laufzettel ohne batchId (falls vorhanden)
                if (!sheet) {
                    sheet =
                        all.find(s =>
                            s.recipeId === current.recipeId &&
                            Math.abs((s.kgMash || 0) - (current.kgMash || 0)) < 0.001 &&
                            s.date === current.created
                        )
                        || all.find(s => s.recipeId === current.recipeId);
                }

                if (!sheet) {
                    alert("Kein Laufzettel f√ºr diese Charge gefunden.");
                    return;
                }


                // Einheitliche Darstellung aller Laufzettel
                openRunSheet(sheet);
            }



            function renderRunSheetAroma(sheet) {

                const html = `
                    <html>
                    <head>
                        <title>Laufzettel ‚Äì ${sheet.recipeName}</title>
                        <style>
                            body { font-family: Arial; padding:20px; line-height:1.4; }
                            h2 { margin-top:0; }
                            table { width:100%; border-collapse: collapse; margin-top:10px; }
                            th, td { border:1px solid #ccc; padding:6px; }
                            th { background:#f0f0f0; }
                        </style>
                    </head>
                    <body>

                        <h2>Laufzettel ‚Äì ${sheet.recipeName}</h2>

                        <p><strong>Datum:</strong> ${sheet.date}</p>

                        <h3>Botanicals</h3>
                        <div class="table-scroll">
                        <table>
                            <tr><th>Name</th><th>Menge</th></tr>
                            ${sheet.items
                        .map(i => `
                                    <tr>
                                        <td>${i.name}</td>
                                        <td>${i.amount.toFixed(2)} ${i.unit}</td>
                                    </tr>
                                `).join("")
                    }
                        </table>
                        </div>

                        <h3>Basisalkohol</h3>
                        <p>
                            ${sheet.info.baseAlcohol_l} L @ ${sheet.info.baseAlcohol_strength}% vol
                        </p>

                        ${sheet.info.process === "noDistill"
                        ? `
                                <h3>Wasserbedarf</h3>
                                <p>
                                    ${sheet.info.waterNeeded.toFixed(2)} L<br>
                                    <small>${sheet.info.waterInfo || ""}</small>
                                </p>
                            `
                        : ""
                    }

                        <p style="margin-top:30px; font-size:0.8em; color:#666;">
                            Laufzettel automatisch erstellt am ${new Date().toLocaleString()}
                        </p>

                    </body>
                    </html>
                    `;

                const w = window.open("", "_blank");
                w.document.write(html);
                w.document.close();
            }




            function createPercentRunSheet(recipe, target, withdrawals, info) {

                const sheet = {
                    id: "run_" + Date.now(),
                    type: "percent",
                    date: new Date().toISOString().slice(0, 10),

                    recipeId: recipe.id || null,
                    recipeName: recipe.name || "(Unbenannt)",

                    target: {
                        id: target.id,
                        name: target.name
                    },

                    // Einzelne Entnahmen exakt wie bei Variante A
                    items: withdrawals.map(w => ({
                        fruit: w.fruit,
                        storageId: w.storageId,
                        storageName: w.storageName,
                        take: w.take,
                        strength: w.strength
                    })),

                    info: {
                        pureTotalVolume: info.pureTotalVolume,
                        pureAlcohol: info.pureAlcohol,
                        mixStrength: info.mixStrength,
                        targetStrength: info.targetStrength,
                        finalVolume: info.finalVolume,
                        waterNeeded: info.waterNeeded
                    }
                };

                // In runSheets speichern
                let all = JSON.parse(localStorage.getItem("runSheets") || "[]");
                if (!Array.isArray(all)) all = [];

                all.push(sheet);
                localStorage.setItem("runSheets", JSON.stringify(all));

                return sheet;
            }




            function renderRunSheetPercent(sheet) {

                const html = `
                <html>
                <head>
                    <title>Laufzettel ‚Äì ${sheet.recipeName}</title>
                    <style>
                        body { font-family: Arial; padding:20px; line-height:1.4; }
                        table { width:100%; border-collapse: collapse; margin-top:10px; }
                        th, td { border:1px solid #ccc; padding:6px; }
                        th { background:#f0f0f0; }
                    </style>
                </head>
                <body>

                    <h2>Laufzettel ‚Äì ${sheet.recipeName}</h2>
                    <p><strong>Zielbeh√§lter:</strong> ${sheet.target.name}</p>
                    <p><strong>Datum:</strong> ${sheet.date}</p>

                    <h3>Entnahmen</h3>
                    <div class="table-scroll">
                    <table>
                        <tr>
                            <th>Frucht</th>
                            <th>Beh√§lter</th>
                            <th>Menge (L)</th>
                            <th>St√§rke</th>
                        </tr>
                        ${sheet.items.map(i => `
                            <tr>
                                <td>${i.fruit}</td>
                                <td>${i.storageName}</td>
                                <td>${i.take.toFixed(2)}</td>
                                <td>${i.strength.toFixed(1)}%</td>
                            </tr>
                        `).join("")}
                    </table>
                    </div>

                    <h3>Berechnung</h3>
                    <p>
                        Reines Destillatvolumen: ${sheet.info.pureTotalVolume.toFixed(2)} L <br>
                        Mischst√§rke: ${sheet.info.mixStrength.toFixed(1)} % vol<br>
                        Zielst√§rke: ${sheet.info.targetStrength.toFixed(1)} % vol<br>
                        Endvolumen: ${sheet.info.finalVolume.toFixed(2)} L<br>
                        Wasserzugabe: ${sheet.info.waterNeeded.toFixed(2)} L
                    </p>

                </body>
                </html>
                `;

                const w = window.open("", "_blank");
                w.document.write(html);
                w.document.close();
            }




















            function openStorageSelectModal(storages, callback) {
                const modal = document.getElementById("storageSelectModal");
                const listDiv = document.getElementById("storageSelectList");
                modal.style.display = "flex";
                listDiv.innerHTML = "";

                storages.forEach(st => {
                    const btn = document.createElement("button");
                    btn.textContent = `${st.name} (${st.capacity} L)`;
                    btn.style.display = "block";
                    btn.style.width = "100%";
                    btn.style.margin = "5px 0";
                    btn.onclick = () => {
                        modal.style.display = "none";
                        callback(st);
                    };
                    listDiv.appendChild(btn);
                });
            }


            function closeStorageSelectModal() {
                document.getElementById("storageSelectModal").style.display = "none";
            }



            function recipeGetAllFruits() {
                const result = new Set();
                const allowed = new Set();

                // =====================================
                // 0) Whitelist aus Zolltabelle erstellen
                //    (fruits.liter oder window.fruits.liter)
                // =====================================
                const fruitSource =
                    (typeof window !== "undefined" && window.fruits && window.fruits.liter)
                        ? window.fruits.liter
                        : (typeof fruits !== "undefined" && fruits.liter)
                            ? fruits.liter
                            : null;

                if (fruitSource) {
                    Object.keys(fruitSource).forEach(name => {
                        const clean = name.replace(/\s*\([^)]*\)/g, "").trim();
                        if (clean) {
                            allowed.add(clean);
                            result.add(clean); // Basisliste f√ºrs Dropdown
                        }
                    });
                } else {
                    console.warn("KEIN fruits.liter gefunden!");
                }

                // Hilfsfunktion: nur zul√§ssige Obstnamen √ºbernehmen
                function addIfAllowed(raw) {
                    if (!raw) return;
                    const clean = raw.replace(/\s*\([^)]*\)/g, "").trim();
                    if (allowed.has(clean)) {
                        result.add(clean);
                    }
                }

                // ===========================
                // 1) Archive durchsuchen
                // ===========================
                Object.keys(localStorage)
                    .filter(k => k.startsWith("archive_"))
                    .forEach(k => {
                        try {
                            const a = JSON.parse(localStorage.getItem(k));
                            if (a?.fruit) addIfAllowed(a.fruit);
                        } catch { }
                    });

                // ===========================
                // 2) Storage durchsuchen
                // ===========================
                Object.keys(localStorage)
                    .filter(k => k.startsWith("storage_"))
                    .forEach(k => {
                        try {
                            const s = JSON.parse(localStorage.getItem(k));
                            if (!s?.contents) return;

                            s.contents.forEach(c => {
                                if (c.fruitData) {
                                    Object.keys(c.fruitData).forEach(f => addIfAllowed(f));
                                } else if (c.fruit) {
                                    addIfAllowed(c.fruit);
                                }
                            });
                        } catch { }
                    });

                return Array.from(result).sort((a, b) => a.localeCompare(b, "de"));
            }






            function setupRecipeLiveListeners() {
                const targetInput = document.getElementById("recipeTargetVolume");
                if (targetInput) {
                    targetInput.addEventListener("input", recipeComputePreview);
                }

                const recipeType = document.getElementById("recipeType");
                if (recipeType) {
                    recipeType.addEventListener("change", () => {
                        recipeUpdateTypeInfo();         // Infobox aktualisieren
                        recipeClearComputedAmounts();   // alte Liter l√∂schen
                        recipeComputePreview();         // neu berechnen (falls Zielmenge gesetzt)
                    });
                }


                // üîπ globaler Input-Listener f√ºr Zutaten
                document.addEventListener("input", e => {
                    if (e.target.classList.contains("ingredientInput")) {
                        recipeComputePreview();
                    }
                    if (e.target.type === "number" &&
                        e.target.closest("#recipeIngredientsBody")) {
                        recipeComputePreview();
                    }
                });
            }

            function recipeClearComputedAmounts() {
                const tbody = document.getElementById("recipeIngredientsBody");
                if (!tbody) return;

                tbody.querySelectorAll("tr").forEach(tr => {
                    const el = tr.querySelector(".computedLiters");
                    if (el) el.textContent = "";   // oder "0.00 L", wie du willst
                });
            }

            function toggleRecipeList() {
                const list = document.getElementById("recipeList");
                const btn = document.getElementById("toggleRecipeListBtn");

                if (!list || !btn) return;

                if (list.style.display === "none" || list.style.display === "") {
                    list.style.display = "block";
                    btn.textContent = "üìö Gespeicherte Rezepte ausblenden";
                } else {
                    list.style.display = "none";
                    btn.textContent = "üìö Gespeicherte Rezepte anzeigen";
                }
            }


            function recipeGetAllowedIngredients() {
                const type = document.getElementById("recipeType")?.value || "percent";

                // --- 1) Destillat-Mix (Percent-Rezept) -------------------------
                if (type === "percent") {
                    // Nur Fr√ºchte aus Lagerbeh√§ltern zur√ºckgeben
                    const fruits = new Set();

                    Object.keys(localStorage)
                        .filter(k => k.startsWith("storage_"))
                        .forEach(k => {
                            const s = JSON.parse(localStorage.getItem(k) || "{}");
                            if (!s.contents) return;

                            s.contents.forEach(c => {
                                if (c.fruitData) {
                                    Object.keys(c.fruitData).forEach(f => fruits.add(f));
                                } else if (c.fruit) {
                                    fruits.add(c.fruit);
                                }
                            });
                        });

                    return Array.from(fruits).sort();
                }

                // --- 2) Aroma/Gin-Rezept ---------------------------------------
                if (type === "aroma") {
                    // Botanicals: freie Eingabe erlaubt
                    // aber Autocomplete basierend auf bisherigen Botanical-Namen
                    const list = new Set();

                    const recipes = recipeLoadAll();
                    recipes.forEach(r => {
                        if (r.type === "aroma" && r.ingredients) {
                            r.ingredients.forEach(i => list.add(i.name));
                        }
                    });

                    return Array.from(list).sort();
                }

                // --- 3) Mash/Whisky-Rezept -------------------------------------
                if (type === "mash") {
                    // Vorab definierte Malze/Getreidesorten
                    return [
                        "Pilsener Malz",
                        "M√ºnchner Malz",
                        "Wiener Malz",
                        "Rauchmalz",
                        "Cara Red",
                        "Weizenmalz",
                        "Gerstenmalz",
                        "Hafermalz",
                        "Maisflocken",
                        "Roggenmalz"
                    ];
                }

                // Fallback
                return [];
            }


            function cleanFruitName(str) {
                return (str || "").replace(/\s*\([^)]*\)\s*/g, "").trim();
            }





            function saveBatchToStorage() {

                // Sicherheitsabfrage
                const ok = confirm("M√∂chten Sie diese Charge wirklich in den Lagerbeh√§lter einlagern?\n\nDieser Vorgang kann nicht r√ºckg√§ngig gemacht werden!");
                if (!ok) {
                    return; // Vorgang abbrechen
                }
                const mode = currentBatchStorageMode || "raw";

                const res = window.latestBatchResult || {};

                const realVolume = parseFloat(document.getElementById("batchActualVolumeL")?.value) || 0;
                const realStrength = parseFloat(document.getElementById("batchActualAbv")?.value) || 0;
                const targetAbvInput = parseFloat(document.getElementById("batchTargetAbv")?.value) || 0;

                if (!realVolume || !realStrength) {
                    alert("Bitte tats√§chliche Destillatmenge und -st√§rke eingeben.");
                    return;
                }

                let AA = res.AA;
                if (!AA || isNaN(AA) || AA <= 0) {
                    AA = realVolume * (realStrength / 100);
                }

                let targetAbv = res.targetAbv || targetAbvInput || realStrength;
                let endVolumeL = res.endVolumeL;

                if (!endVolumeL || isNaN(endVolumeL) || endVolumeL <= 0) {
                    if (AA > 0 && targetAbv > 0) {
                        endVolumeL = AA / (targetAbv / 100);
                    } else {
                        endVolumeL = realVolume;
                    }
                }

                const waterNeeded = (AA > 0 && targetAbv > 0 && realVolume > 0)
                    ? (AA / (targetAbv / 100) - realVolume)
                    : 0;

                // Lagerbeh√§lter
                const storageId = document.getElementById("batchStorageSelect")?.value;
                if (!storageId) {
                    alert("Bitte einen Lagerbeh√§lter w√§hlen.");
                    return;
                }

                const storageKey = "storage_" + storageId;
                const st = JSON.parse(localStorage.getItem(storageKey) || "{}");
                if (!st.id) {
                    alert("Lagerbeh√§lter existiert nicht!");
                    return;
                }

                // --------------------------------
                // Kosten & Preise (wie oben)
                // --------------------------------
                const summaryText = document.getElementById("batchSummary")?.innerText || "";

                function extractEuro(label, text) {
                    const idx = text.indexOf(label);
                    if (idx === -1) return NaN;
                    const sub = text.slice(idx + label.length);
                    const m = sub.match(/([0-9]+(?:[.,][0-9]+)?)\s*‚Ç¨/);
                    if (!m) return NaN;
                    return parseFloat(m[1].replace(",", "."));
                }

                const totalCosts = extractEuro("Gesamtkosten:", summaryText) || 0;
                let costPerLiter = 0;
                if (realVolume > 0) {
                    costPerLiter = totalCosts / realVolume;
                } else if (endVolumeL > 0) {
                    costPerLiter = totalCosts / endVolumeL;
                }

                const p05 = parseFloat(document.getElementById("batchBottle05Price")?.value);
                const p07 = parseFloat(document.getElementById("batchBottle07Price")?.value);
                const p10 = parseFloat(document.getElementById("batchBottle10Price")?.value);

                const userPrice = {
                    "0.5": isNaN(p05) ? null : p05,
                    "0.7": isNaN(p07) ? null : p07,
                    "1.0": isNaN(p10) ? null : p10
                };

                const mat05 = parseFloat(document.getElementById("batchBottle05Cost")?.value) || 0;
                const mat07 = parseFloat(document.getElementById("batchBottle07Cost")?.value) || 0;
                const mat10 = parseFloat(document.getElementById("batchBottle10Cost")?.value) || 0;

                const packaging = parseFloat(document.getElementById("batchPackaging")?.value) || 0;
                const closures = parseFloat(document.getElementById("batchClosures")?.value) || 0;
                const labels = parseFloat(document.getElementById("batchLabels")?.value) || 0;
                const shipping = parseFloat(document.getElementById("batchShipping")?.value) || 0;

                const bottleMat05 = mat05 + packaging + closures + labels + shipping;
                const bottleMat07 = mat07 + packaging + closures + labels + shipping;
                const bottleMat10 = mat10 + packaging + closures + labels + shipping;

                const calcPrice = {
                    "0.5": calcBottlePricing(costPerLiter, 0.5, bottleMat05, userPrice["0.5"]),
                    "0.7": calcBottlePricing(costPerLiter, 0.7, bottleMat07, userPrice["0.7"]),
                    "1.0": calcBottlePricing(costPerLiter, 1.0, bottleMat10, userPrice["1.0"])
                };

                // MixComponents wie oben
                const fruitVolumes = {};
                let totalVolForMix = 0;
                let firstFruitDisplay = "";
                const usedBarrels = Array.isArray(res.usedBarrels) ? res.usedBarrels : [];

                usedBarrels.forEach(entry => {
                    const type = entry.type;
                    const id = entry.id;
                    const key = (type === "real") ? ("barrel_" + id) : id;

                    const b = JSON.parse(localStorage.getItem(key) || "{}");
                    if (!b) return;

                    const rawFruit = b.fruit || "Unbekannt";
                    if (!firstFruitDisplay) firstFruitDisplay = rawFruit;

                    const cleanFruit = rawFruit.replace(/\([^)]*\d[^)]*\)$/g, "").trim();
                    const vol = parseFloat(b.actualAlcohol || b.volume) || 0;

                    if (!fruitVolumes[cleanFruit]) fruitVolumes[cleanFruit] = 0;
                    fruitVolumes[cleanFruit] += vol;
                    totalVolForMix += vol;
                });

                let mixComponents = [];
                const fruitNames = Object.keys(fruitVolumes);

                if (fruitNames.length === 0) {
                    const dropdown = document.getElementById("batchFruit");
                    const fruit = dropdown?.value || "Unbekannt";
                    mixComponents = [{ fruit, percent: 100 }];
                    firstFruitDisplay = fruit;
                } else if (fruitNames.length === 1) {
                    const f = fruitNames[0];
                    mixComponents = [{ fruit: f, percent: 100 }];
                } else {
                    mixComponents = fruitNames.map(f => ({
                        fruit: f,
                        percent: totalVolForMix > 0 ? (fruitVolumes[f] / totalVolForMix * 100) : 0
                    }));
                }

                const today = new Date().toISOString().split("T")[0];

                let baseName;
                if (fruitNames.length <= 1) {
                    const display = firstFruitDisplay || fruitNames[0] || "Charge";
                    baseName = `${display} ‚Äì Charge vom ${today}`;
                } else {
                    baseName = `Cuv√©e ‚Äì Charge vom ${today}`;
                }

                // Verd√ºnnung / Endwerte
                let finalVolume, finalStrength;
                const plannedDilution = {
                    realVolume,
                    realStrength,
                    AA,
                    targetAbv,
                    targetVolume: endVolumeL,
                    waterNeeded
                };

                if (mode === "diluted") {
                    finalVolume = endVolumeL;
                    finalStrength = targetAbv;
                } else {
                    finalVolume = realVolume;
                    finalStrength = realStrength;
                }

                const productName =
                    `${baseName} (${finalVolume.toFixed(2)} L @ ${finalStrength.toFixed(1)}% vol)`;

                // Produktobjekt wie beim Fass-Lagern: sofort ‚Äûused‚Äú, remainingVolume=0
                const newProduct = {
                    id: "product_" + Date.now(),
                    name: productName,
                    volumeL: finalVolume,
                    strength: finalStrength,
                    remainingVolume: 0,
                    totalCosts,
                    costPerLiter,
                    userPrice,
                    calcPrice,
                    mixComponents,
                    origin: "product",
                    status: "used",
                    created: new Date().toISOString(),
                    plannedDilution
                };

                const products = JSON.parse(localStorage.getItem("products") || "[]");
                products.push(newProduct);
                localStorage.setItem("products", JSON.stringify(products));

                // in Lagerbeh√§lter eintragen
                if (!st.contents) st.contents = [];

                st.contents.push({
                    id: "item_" + Date.now(),
                    productId: newProduct.id,
                    source: productName,
                    volume: finalVolume,
                    strength: finalStrength,
                    fruitData: { [firstFruitDisplay || "Unbekannt"]: finalVolume },
                    dateAdded: new Date().toISOString().split("T")[0],
                    waterAdded: (mode === "diluted") ? waterNeeded : 0,
                    plannedDilution
                });

                // currentVolume aktualisieren (falls genutzt)
                if (typeof st.currentVolume === "number") {
                    st.currentVolume += finalVolume;
                }

                localStorage.setItem(storageKey, JSON.stringify(st));

                // verwendete F√§sser/Archive auf used setzen
                // verwendete F√§sser / Archive korrekt weiterverarbeiten
                usedBarrels.forEach(entry => {
                    const type = entry.type;
                    const id = entry.id;

                    // üëâ ECHTES FASS
                    if (type === "real") {

                        const key = "barrel_" + id;
                        const b = JSON.parse(localStorage.getItem(key) || "{}");

                        if (!b) return;

                        // üßπ Fass zur√ºcksetzen (wieder leer!)
                        b.status = "empty";
                        b.actualAlcohol = null;
                        b.actualStrength = null;
                        b.burnDate = null;
                        b.burnNumber = null;
                        b.burnTimeHours = null;
                        b.remainingVolume = 0;
                        b.oechsle = null;
                        b.fruit = null;
                        b.start = null;
                        b.days = null;
                        b.volume = null;


                        localStorage.setItem(key, JSON.stringify(b));
                    }

                    // üëâ ARCHIV-EINTRAG (z. B. Fass wurde schon archiviert)
                    else if (type === "archive") {

                        const key = id;
                        const a = JSON.parse(localStorage.getItem(key) || "{}");

                        if (!a) return;

                        a.status = "used";
                        a.remainingVolume = 0;

                        localStorage.setItem(key, JSON.stringify(a));
                    }
                });


                if (typeof fillBatchBarrelList === "function") {
                    fillBatchBarrelList();
                }

                closeBatchStorageDialog();
                alert("Charge wurde in den Lagerbeh√§lter eingelagert.");


                // --- Felder der Chargenkalkulation zur√ºcksetzen ---
                [
                    "batchActualVolumeL",
                    "batchActualAbv",
                    "batchTargetAbv",
                    "batchPackaging",
                    "batchClosures",
                    "batchLabels",
                    "batchShipping",
                    "batchBottle05Cost",
                    "batchBottle07Cost",
                    "batchBottle10Cost",
                    "batchBottle05Price",
                    "batchBottle07Price",
                    "batchBottle10Price"
                ].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = "";
                });

                // Ergebnisse l√∂schen
                [
                    "batchSummary",
                    "batchDilutionResult",
                    "batchBottlesResult"
                ].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = "";
                });

                // Fassliste der Chargenkalkulation neu laden
                if (typeof fillBatchBarrelList === "function") {
                    fillBatchBarrelList();
                }

                // Auswahl im Dropdown l√∂schen (falls vorhanden)
                const barrelSelect = document.getElementById("batchFruit");
                if (barrelSelect) barrelSelect.value = "";

                // Globale Ergebnisse zur√ºcksetzen
                window.latestBatchResult = null;

            }




            // ===========================================================
            // üåü Gemeinsames Datenmodell f√ºr fertige Produkte
            // ===========================================================

            // Speichert ein fertiges Produkt (egal ob aus Fass oder Charge)
            function saveProduct(product) {
                if (!product || !product.id) {
                    console.error("saveProduct: Ung√ºltiges Produktobjekt", product);
                    return;
                }

                const raw = localStorage.getItem("products");
                const list = raw ? JSON.parse(raw) : [];

                // Produkt anh√§ngen
                list.push(product);

                // Speichern
                localStorage.setItem("products", JSON.stringify(list));

            }


            // Erzeugt ein korrekt formatiertes Produktobjekt
            // Erzeugt ein korrekt formatiertes Produktobjekt ‚Äì EINHEITLICH f√ºr Fass & Charge
            function createProduct({
                name,
                volumeL,
                strength,
                remainingVolume = null,

                // Kosten
                totalCosts = 0,
                costPerLiter = 0,

                // Preisinfos
                userPrice = {},
                calcPrice = {},

                // Herkunft
                origin = "unknown",      // "barrel" oder "charge"
                barrelId = null,
                chargeId = null,

                // Fruchtdaten / Mischung
                mixComponents = [],
                fruitData = null,

                // Geplante Verd√ºnnung (wird ben√∂tigt!)
                plannedDilution = null,

                // Brenn-Infos (optional)
                burnDate = null,
                burnNumber = null
            }) {

                return {
                    id: "product_" + Date.now(),
                    created: new Date().toISOString(),

                    // Basisdaten
                    name,
                    volumeL: Number(volumeL) || 0,
                    strength: Number(strength) || 0,
                    remainingVolume: (remainingVolume != null ? remainingVolume : (Number(volumeL) || 0)),

                    // Kosten
                    totalCosts: Number(totalCosts) || 0,
                    costPerLiter: Number(costPerLiter) || 0,

                    // Benutzerpreise
                    userPrice: {
                        "0.5": userPrice["0.5"] ?? null,
                        "0.7": userPrice["0.7"] ?? null,
                        "1.0": userPrice["1.0"] ?? null
                    },

                    // Kalkulationspreise
                    calcPrice: {
                        "0.5": calcPrice["0.5"] || { min: 0, profit: 0 },
                        "0.7": calcPrice["0.7"] || { min: 0, profit: 0 },
                        "1.0": calcPrice["1.0"] || { min: 0, profit: 0 }
                    },

                    // Herstellung / Herkunft
                    origin,
                    barrelId,
                    chargeId,

                    // Frucht-Infos
                    mixComponents,
                    fruitData,

                    // geplante Verd√ºnnung ‚Üí **DER ENTSCHEIDENDE PUNKT!**
                    plannedDilution: plannedDilution ? {
                        realVolume: Number(plannedDilution.realVolume) || 0,
                        realStrength: Number(plannedDilution.realStrength) || 0,
                        AA: Number(plannedDilution.AA) || 0,
                        targetAbv: Number(plannedDilution.targetAbv) || 0,
                        targetVolume: Number(plannedDilution.targetVolume) || 0,
                        waterNeeded: Number(plannedDilution.waterNeeded) || 0
                    } : null,

                    // Brenninfos
                    burnDate,
                    burnNumber
                };
            }



            // Berechnet Minimalpreis + Profit f√ºr eine Flaschengr√∂√üe
            function calcBottlePricing(costPerLiter, bottleSize, bottleMaterialCost, userPrice) {
                const liters = bottleSize;
                const cost = liters * costPerLiter + bottleMaterialCost;

                return {
                    min: cost,                       // Mindestpreis
                    profit: userPrice ? (userPrice - cost) : 0  // Gewinn (falls Benutzerpreis existiert)
                };
            }


            function saveBarrelAsProduct(mode) {

                // Sicherheitsabfrage
                const ok = confirm("M√∂chten Sie dieses Fass wirklich als Produkt anlegen?\n\nDieser Vorgang kann nicht r√ºckg√§ngig gemacht werden!");
                if (!ok) {
                    return; // Vorgang abbrechen
                }

                // Schutz vor doppeltem Aufruf (verhindert doppelte Produkte)
                if (saveBarrelAsProduct.isRunning) return;
                saveBarrelAsProduct.isRunning = true;

                const sel = document.getElementById("calcBarrelSelect");
                const key = sel ? sel.value : "";
                const barrelId = key.replace("barrel_", "").replace("archive_", "");

                if (!key) {
                    alert("Bitte zuerst ein Fass w√§hlen.");
                    saveBarrelAsProduct.isRunning = false;
                    return;
                }

                const b = JSON.parse(localStorage.getItem(key) || "{}");

                if (!b.actualAlcohol || !b.actualStrength) {
                    alert("Bitte korrigierte Menge und korrigierte St√§rke eintragen.");
                    saveBarrelAsProduct.isRunning = false;
                    return;
                }

                // ---------------------------------------
                // 1Ô∏è‚É£ Alkoholische Daten
                // ---------------------------------------
                const volumeL = b.actualAlcohol;
                const strength = b.actualStrength;
                const AA = volumeL * (strength / 100);

                // ---------------------------------------
                // 2Ô∏è‚É£ Kosten aus Kalkulation
                // ---------------------------------------
                const summaryText = document.getElementById("calcSummary")?.innerText || "";

                function extractEuro(label) {
                    const idx = summaryText.indexOf(label);
                    if (idx === -1) return NaN;
                    const sub = summaryText.slice(idx + label.length);
                    const m = sub.match(/([0-9]+(?:[.,][0-9]+)?)\s*‚Ç¨/);
                    if (!m) return NaN;
                    return parseFloat(m[1].replace(",", "."));
                }

                const totalCosts = extractEuro("Gesamtkosten:") || 0;
                const costPerLiter = totalCosts / volumeL;

                // ---------------------------------------
                // 3Ô∏è‚É£ Benutzerpreise
                // ---------------------------------------
                const p05 = parseFloat(document.getElementById("calcBottle05Price")?.value);
                const p07 = parseFloat(document.getElementById("calcBottle07Price")?.value);
                const p10 = parseFloat(document.getElementById("calcBottle10Price")?.value);

                const userPrice = {
                    "0.5": isNaN(p05) ? null : p05,
                    "0.7": isNaN(p07) ? null : p07,
                    "1.0": isNaN(p10) ? null : p10
                };

                const mat05 = parseFloat(document.getElementById("calcBottle05Cost")?.value) || 0;
                const mat07 = parseFloat(document.getElementById("calcBottle07Cost")?.value) || 0;
                const mat10 = parseFloat(document.getElementById("calcBottle10Cost")?.value) || 0;

                // --- Verpackungs-, Etiketten- und Versandkosten (Fasskalkulation) ---
                const packaging = parseFloat(document.getElementById("calcPackaging")?.value) || 0;
                const closures = parseFloat(document.getElementById("calcClosures")?.value) || 0;
                const labels = parseFloat(document.getElementById("calcLabels")?.value) || 0;
                const shipping = parseFloat(document.getElementById("calcShipping")?.value) || 0;


                const bottleMat05 = mat05 + packaging + closures + labels + shipping;
                const bottleMat07 = mat07 + packaging + closures + labels + shipping;
                const bottleMat10 = mat10 + packaging + closures + labels + shipping;

                const calcPrice = {
                    "0.5": calcBottlePricing(costPerLiter, 0.5, bottleMat05, userPrice["0.5"]),
                    "0.7": calcBottlePricing(costPerLiter, 0.7, bottleMat07, userPrice["0.7"]),
                    "1.0": calcBottlePricing(costPerLiter, 1.0, bottleMat10, userPrice["1.0"])
                };

                // ---------------------------------------
                // 4Ô∏è‚É£ Basis f√ºr Produktname (sauber formatiert)
                // ---------------------------------------
                const fruitClean = (b.fruit || "").replace(/\([^)]*\d[^)]*\)$/g, "").trim();

                const burnDate =
                    (document.getElementById("barrelBurnDate")?.value) ||
                    b.burnDate ||
                    new Date().toISOString().split("T")[0];

                // ISO ‚Üí deutsches Datum
                const burnDateDisplay = burnDate.includes("-")
                    ? burnDate.split("-").reverse().join(".")
                    : burnDate;

                const burnNumber =
                    (document.getElementById("barrelBurnNumber")?.value) ||
                    b.burnNumber ||
                    "";

                // sauberer Basisname
                let productNameBase = `${fruitClean} ‚Äì Brand`;
                if (burnNumber) {
                    productNameBase += ` ${burnNumber} vom ${burnDateDisplay}`;
                } else {
                    productNameBase += ` vom ${burnDateDisplay}`;
                }

                // ---------------------------------------
                // 5Ô∏è‚É£ Verd√ºnnt / Unverd√ºnnt vorberechnen
                // ---------------------------------------
                const targetAbv = parseFloat(document.getElementById("calcTargetAbv")?.value) || strength;

                const endVolumeL =
                    targetAbv > 0 ? (AA / (targetAbv / 100)) : volumeL;

                const waterNeeded = endVolumeL - volumeL;

                // ---------------------------------------
                // 6Ô∏è‚É£ finalVolume / finalStrength aus mode
                // ---------------------------------------
                let finalVolume = 0;
                let finalStrength = 0;

                const plannedDilution = {
                    realVolume: volumeL,
                    realStrength: strength,
                    AA,
                    targetAbv,
                    targetVolume: endVolumeL,
                    waterNeeded
                };

                if (mode === "diluted") {
                    finalVolume = endVolumeL;
                    finalStrength = targetAbv;
                } else if (mode === "raw") {
                    finalVolume = volumeL;
                    finalStrength = strength;
                } else {
                    alert("Fehler: Speichermodus ist ung√ºltig.");
                    saveBarrelAsProduct.isRunning = false;
                    return;
                }

                // ---------------------------------------
                // 7Ô∏è‚É£ Produktname komplett
                // ---------------------------------------
                const productName =
                    `${productNameBase} (${finalVolume.toFixed(2)} L @ ${finalStrength.toFixed(1)}% vol)`;

                // ---------------------------------------
                // 8Ô∏è‚É£ Duplikatpr√ºfung
                // ---------------------------------------
                const products = JSON.parse(localStorage.getItem("products") || "[]");
                const existing = products.find(p => p.name === productName);

                if (existing) {

                    // ‚ûú Quelle trotzdem korrekt markieren!
                    if (key.startsWith("barrel_")) {

                        const emptied = {
                            fruit: "",
                            start: "",
                            days: "",
                            end: "",
                            volume: "",
                            oechsle: "",
                            actualAlcohol: "",
                            actualStrength: "",
                            burnDate: "",
                            burnNumber: "",
                            burnTimeHours: "",
                            status: "used",
                            usedAt: new Date().toISOString(),
                            usedFor: "product",
                            resultProductId: existing.id
                        };

                        localStorage.setItem(key, JSON.stringify(emptied));

                    } else if (key.startsWith("archive_")) {

                        const a = JSON.parse(localStorage.getItem(key) || "{}");
                        a.status = "used";
                        a.usedAt = new Date().toISOString();
                        a.usedFor = "product";
                        a.resultProductId = existing.id;

                        localStorage.setItem(key, JSON.stringify(a));
                    }

                    if (typeof fillCalcBarrelSelect === "function")
                        fillCalcBarrelSelect();

                    alert("Dieses Fass wurde bereits als Produkt gespeichert.\nQuelle wurde korrekt markiert.");

                    saveBarrelAsProduct.isRunning = false;
                    return;
                }


                // ---------------------------------------
                // 9Ô∏è‚É£ Produkt erstellen
                // ---------------------------------------
                const product = buildProductObject({
                    name: productName,
                    burnDate,
                    burnNumber,
                    volumeL: finalVolume,
                    strength: finalStrength,
                    remainingVolume: finalVolume,
                    totalCosts,
                    costPerLiter,
                    userPrice,
                    calcPrice,
                    mixComponents: [{
                        fruit: fruitClean,
                        percent: 100
                    }],
                    plannedDilution
                });

                saveProduct(product);
                window.lastCreatedProduct = product;

                // ------------------------------
                // 7Ô∏è‚É£ Quelle korrekt behandeln
                // ------------------------------

                if (key.startsWith("barrel_")) {

                    // üî• ECHTES FASS ‚Üí leeren, damit es wiederverwendbar ist
                    const emptied = {
                        fruit: "",
                        start: "",
                        days: "",
                        end: "",
                        volume: "",
                        oechsle: "",
                        actualAlcohol: "",
                        actualStrength: "",
                        burnDate: "",
                        burnNumber: "",
                        burnTimeHours: "",
                        status: "used",
                        usedAt: new Date().toISOString(),
                        usedFor: "storage",
                        resultProductId: product.id
                    };

                    localStorage.setItem(key, JSON.stringify(emptied));

                } else if (key.startsWith("archive_")) {

                    // üì¶ ARCHIV ‚Üí NICHT leeren, nur markieren
                    const a = JSON.parse(localStorage.getItem(key) || "{}");

                    a.status = "used";
                    a.usedAt = new Date().toISOString();
                    a.usedFor = "storage";
                    a.resultProductId = product.id;

                    localStorage.setItem(key, JSON.stringify(a));
                }


                if (typeof fillCalcBarrelSelect === "function")
                    fillCalcBarrelSelect();

                if (sel) sel.value = "";

                [
                    "calcActualYieldResult",
                    "calcActualBottleResult",
                    "calcDilutionResult",
                    "calcRawCostResult",
                    "calcEnergyLaborResult",
                    "calcFixedCostResult",
                    "calcTaxResult",
                    "calcBottlesResult",
                    "calcSummary"
                ].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = "";
                });

                alert("Produkt wurde gespeichert!");

                saveBarrelAsProduct.isRunning = false;
            }







            function clearBarrelInputs() {
                const ids = [
                    "actualAlcoholInput",
                    "actualStrengthInput",
                    "barrelBurnDate",
                    "barrelBurnNumber",
                    "barrelBurnTime"
                ];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = "";
                });
            }




            function loadProducts() {
                const raw = localStorage.getItem("products");
                return raw ? JSON.parse(raw) : [];
            }




            function prodStartBatchFromRecipe() {
                const sel = document.getElementById("prodRecipeSelect");
                if (!sel || !sel.value) {
                    alert("Bitte zuerst ein Mash-Rezept ausw√§hlen.");
                    return;
                }

                const recipeId = sel.value;

                // Rezept-ID in localStorage hinterlegen
                localStorage.setItem("currentMashRecipeId", recipeId);

                // Direkt auf die neue Seite wechseln
                showPage("mashBatch");
            }










            function toggleBatchProductOptions() {
                const box = document.getElementById("batchProductOptions");
                const info = document.getElementById("batchProductInfo");
                const res = window.latestBatchResult || {};

                const realVol = parseFloat(document.getElementById("batchActualVolumeL")?.value) || 0;
                const realAbv = parseFloat(document.getElementById("batchActualAbv")?.value) || 0;

                const endVol = res.endVolumeL || (res.AA ? res.AA / (res.targetAbv / 100) : realVol);
                const targetAbv = res.targetAbv || realAbv;
                const water = endVol - realVol;

                info.innerHTML = `
                    <strong>Unverd√ºnnt:</strong> ${realVol.toFixed(2)} L @ ${realAbv.toFixed(1)}% vol<br>
                    <strong>Verd√ºnnt:</strong> ${endVol.toFixed(2)} L @ ${targetAbv.toFixed(1)}% vol
                    (Wasserbedarf: ${water.toFixed(2)} L)
                `;

                box.style.display = (box.style.display === "none") ? "block" : "none";
            }


            function toggleBarrelProductOptions() {
                const box = document.getElementById("barrelProductOptions");
                const info = document.getElementById("barrelProductInfo");

                const sel = document.getElementById("calcBarrelSelect");
                const key = sel ? sel.value : "";
                const b = JSON.parse(localStorage.getItem(key) || "{}");

                const realVol = parseFloat(b.actualAlcohol) || 0;
                const realAbv = parseFloat(b.actualStrength) || 0;

                const AA = realVol * (realAbv / 100);

                // Ziel-%vol aus Eingabefeld
                const targetAbv = parseFloat(document.getElementById("calcTargetAbv")?.value) || realAbv;

                // Verd√ºnntes Endvolumen
                let endVol = realVol;
                if (AA > 0 && targetAbv > 0) {
                    endVol = AA / (targetAbv / 100);
                }

                const water = endVol - realVol;

                // Info wie bei Charge
                info.innerHTML = `
                    <strong>Unverd√ºnnt:</strong> ${realVol.toFixed(2)} L @ ${realAbv.toFixed(1)}% vol<br>
                    <strong>Verd√ºnnt:</strong> ${endVol.toFixed(2)} L @ ${targetAbv.toFixed(1)}% vol
                    (Wasserbedarf: ${water.toFixed(2)} L)
                `;

                // ein/aus
                box.style.display = (box.style.display === "none") ? "block" : "none";
            }








            // ===============================================
            // INIT PAGE
            // ===============================================
            function initCaskPage() {
                caskResetForm();
                caskRenderList();
                document.getElementById("caskTastingList").innerHTML = "";
                document.getElementById("caskTastingCurrent").innerHTML =
                    "<em>Bitte zuerst ein Fass ausw√§hlen.</em>";
            }



            // ===============================================
            // SAVE CASK
            // ===============================================
            function caskSaveFromForm() {
                const id = document.getElementById("caskId").value.trim();
                const name = document.getElementById("caskName").value.trim();
                const volume = parseFloat(document.getElementById("caskVolume").value);

                const prevFill = document.getElementById("caskPreviousFill").value.trim();
                const coop = document.getElementById("caskCooperage").value.trim();
                const datePurchased = document.getElementById("caskDatePurchased").value.trim();
                const price = parseFloat(document.getElementById("caskPurchaseCost").value);
                const status = document.getElementById("caskStatus").value;
                const notes = document.getElementById("caskNotes").value.trim();
                const msg = document.getElementById("caskFormMessage");

                // ============================
                // 1) Holzart & Toasting sauber holen
                // ============================
                let wood = document.getElementById("caskWood").value.trim();
                let toast = document.getElementById("caskToast").value.trim();


                // ============================
                // 2) Validation
                // ============================
                if (!name) {
                    msg.textContent = "Bitte einen Fassnamen eingeben.";
                    return;
                }
                if (!volume || volume <= 0) {
                    msg.textContent = "Bitte Fassvolumen korrekt eingeben.";
                    return;
                }
                msg.textContent = "";

                // ============================
                // 3) Casks laden
                // ============================
                const all = caskLoadAll();

                let c = null;

                if (id) {
                    // ---- Update bestehendes Fass ----
                    const index = all.findIndex(x => x.id === id);
                    if (index === -1) return;

                    c = all[index];

                    c.name = name;
                    c.volume = volume;
                    c.wood = wood;
                    c.toast = toast;
                    c.previousFill = prevFill;
                    c.cooperage = coop;
                    c.datePurchased = datePurchased;
                    c.purchaseCost = isNaN(price) ? null : price;
                    c.status = status;
                    c.notes = notes;

                } else {
                    // ---- Neues Fass ----
                    c = {
                        id: "cask_" + Date.now(),
                        name,
                        volume,
                        wood,
                        toast,
                        previousFill: prevFill,
                        cooperage: coop,
                        datePurchased,
                        purchaseCost: isNaN(price) ? null : price,
                        status,
                        notes,
                        fillHistory: [],
                        tastings: []
                    };

                    all.push(c);
                }

                // ============================
                // 4) Speichern & UI
                // ============================
                caskSaveAll(all);

                alert("Fass gespeichert!");
                caskResetForm();
                caskRenderList();
            }





            // ===============================================
            // Fass-Formular zur√ºcksetzen
            // ===============================================
            function caskResetForm() {
                // Versteckte ID
                const idField = document.getElementById("caskId");
                if (idField) idField.value = "";

                const name = document.getElementById("caskName");
                if (name) name.value = "";

                const vol = document.getElementById("caskVolume");
                if (vol) vol.value = "";

                const wood = document.getElementById("caskWood");
                if (wood) wood.value = "";

                const toast = document.getElementById("caskToast");
                if (toast) toast.value = "";

                const prev = document.getElementById("caskPreviousFill");
                if (prev) prev.value = "";

                const coop = document.getElementById("caskCooperage");
                if (coop) coop.value = "";

                const dateP = document.getElementById("caskDatePurchased");
                if (dateP) dateP.value = "";

                const cost = document.getElementById("caskPurchaseCost");
                if (cost) cost.value = "";

                const status = document.getElementById("caskStatus");
                if (status) status.value = "empty";

                const notes = document.getElementById("caskNotes");
                if (notes) notes.value = "";

                const msg = document.getElementById("caskFormMessage");
                if (msg) msg.textContent = "";

                // Tasting-Bereich zur√ºcksetzen (falls vorhanden)
                const tastWrapper = document.getElementById("caskTastingFormWrapper");
                if (tastWrapper) tastWrapper.style.display = "none";

                const tastCurrent = document.getElementById("caskTastingCurrent");
                if (tastCurrent) {
                    tastCurrent.innerHTML = "<em>Bitte zuerst ein Fass in der Liste ausw√§hlen.</em>";
                }

                const tastList = document.getElementById("caskTastingList");
                if (tastList) tastList.innerHTML = "";

                // F√ºll-Historie zur√ºcksetzen
                const fillBox = document.getElementById("caskFillHistoryBox");
                if (fillBox) {
                    fillBox.innerHTML = "<em>Noch keine Bef√ºllungen dokumentiert.</em>";
                }

                // Meldung im F√ºll-Bereich
                const fillMsg = document.getElementById("caskFillMessage");
                if (fillMsg) fillMsg.textContent = "";

                // Transfer-Formular zur√ºcksetzen
                const transferMsg = document.getElementById("caskTransferMessage");
                if (transferMsg) transferMsg.textContent = "";

                const transferVol = document.getElementById("caskTransferVolume");
                if (transferVol) transferVol.value = "";

                const transferNotes = document.getElementById("caskTransferNotes");
                if (transferNotes) transferNotes.value = "";

                const transferTarget = document.getElementById("caskTransferTarget");
                if (transferTarget) transferTarget.value = "";

                // Optional: Statusanzeige-Box (falls du sie schon hast)
                const statusDisplay = document.getElementById("caskStatusDisplay");
                if (statusDisplay) {
                    statusDisplay.innerHTML = "";
                }
            }





            // ===============================================
            // RENDER CASK LIST
            // ===============================================
            function caskRenderList() {
                const list = caskLoadAll();
                const box = document.getElementById("caskList");
                if (!list.length) {
                    box.innerHTML = "<em>Noch keine F√§sser angelegt.</em>";
                    return;
                }

                let html = "<table style='width:100%; border-collapse:collapse; font-size:0.9em;'>";
                html += "<tr style='background:#eee;'><th>Name</th><th>Vol.</th><th>Holz</th><th>Status</th><th></th></tr>";

                list.forEach(c => {
                    html += `
                        <tr style="border-bottom:1px solid #ddd;">
                            <td>${c.name}</td>
                            <td>${c.volume} L</td>
                            <td>${c.wood || "-"}</td>
                            <td>
                    <span style="
                        padding:3px 6px;
                        border-radius:4px;
                        background:${CASK_STATUS_MAP[c.status]?.color || '#ccc'};
                        color:white;
                        font-weight:bold;
                        font-size:0.8em;
                    ">
                        ${CASK_STATUS_MAP[c.status]?.text || c.status}
                    </span>
                </td>

                    <td><button onclick="caskSelect('${c.id}')">üîç √ñffnen</button></td>
                </tr>`;
                });

                html += "</table>";
                box.innerHTML = html;
            }




            /// ===============================================
            // SELECT CASK
            // ===============================================
            function caskSelect(id) {
                const all = caskLoadAll();
                const c = all.find(x => x.id === id);
                if (!c) return;

                // --------------------------------------------------
                // BASIS-FORMULARFELDER
                // --------------------------------------------------
                document.getElementById("caskId").value = c.id;
                document.getElementById("caskName").value = c.name || "";
                document.getElementById("caskVolume").value = c.volume || "";
                document.getElementById("caskPreviousFill").value = c.previousFill || "";
                document.getElementById("caskCooperage").value = c.cooperage || "";
                document.getElementById("caskDatePurchased").value = c.datePurchased || "";
                document.getElementById("caskPurchaseCost").value = c.purchaseCost || "";
                document.getElementById("caskNotes").value = c.notes || "";

                // --------------------------------------------------
                // STATUS
                // --------------------------------------------------
                document.getElementById("caskStatus").value = c.status || "empty";

                const sbox = document.getElementById("caskStatusDisplay");
                if (sbox && typeof CASK_STATUS_MAP !== "undefined") {
                    const s = CASK_STATUS_MAP[c.status];
                    sbox.innerHTML = `
                        <span style="
                            padding:4px 8px;
                            border-radius:4px;
                            background:${s?.color || '#777'};
                            color:white;
                            font-weight:bold;
                        ">
                            ${s?.text || c.status}
                        </span>
                    `;
                }

                // --------------------------------------------------
                // HOLZART & TOASTING (einfaches Dropdown, keine Freitextfelder!)
                // --------------------------------------------------
                document.getElementById("caskWood").value = c.wood || "";
                document.getElementById("caskToast").value = c.toast || "";

                // --------------------------------------------------
                // SENSORIK
                // --------------------------------------------------
                document.getElementById("caskTastingFormWrapper").style.display = "block";
                caskRenderTastingHeader(c);
                caskRenderTastings(c);

                // --------------------------------------------------
                // F√úLLEN & TRANSFER
                // --------------------------------------------------
                caskFillInitFor(c);
                caskRenderFillHistory(c);
                caskInitTransferForm(c);
            }





            function caskInitTransferForm(sourceCask) {
                const wrap = document.getElementById("caskTransferWrapper");
                const sel = document.getElementById("caskTransferTarget");
                if (!wrap || !sel) return;

                const casks = caskLoadAll();
                sel.innerHTML = `<option value="">‚Äî Ziel-Fass w√§hlen ‚Äî</option>`;

                casks.forEach(c => {
                    if (c.id === sourceCask.id) return; // sich selbst nicht als Ziel zulassen

                    const opt = document.createElement("option");
                    opt.value = c.id;
                    opt.textContent = `${c.name} (${c.volume} L, ${c.wood || "?"})`;
                    sel.appendChild(opt);
                });

                wrap.style.display = "block";
            }




            function caskTransfer() {
                const sourceId = document.getElementById("caskId").value;
                const targetId = document.getElementById("caskTransferTarget").value;

                const vol = parseFloat(document.getElementById("caskTransferVolume").value.replace(",", "."));

                const notes = document.getElementById("caskTransferNotes").value.trim();

                const msg = document.getElementById("caskTransferMessage");

                if (!sourceId) { msg.textContent = "Kein Quellfass ausgew√§hlt."; return; }
                if (!targetId) { msg.textContent = "Bitte Ziel-Fass w√§hlen."; return; }
                if (!vol || vol <= 0) { msg.textContent = "Ung√ºltige Menge."; return; }

                const casks = caskLoadAll();
                const src = casks.find(x => x.id === sourceId);
                const dst = casks.find(x => x.id === targetId);

                if (!src || !dst) {
                    msg.textContent = "F√§sser nicht gefunden.";
                    return;
                }

                // --------------------------
                // 1) St√§rke nur aus echten Destillaten
                // --------------------------
                const realDist = src.fillHistory.filter(e => e.batchId !== "__water__");

                if (realDist.length === 0) {
                    msg.textContent = "Im Quellfass befindet sich kein Destillat.";
                    return;
                }

                let totalVol = 0;
                let totalAA = 0;

                realDist.forEach(e => {
                    totalVol += e.volume;
                    totalAA += e.AA;
                });

                const EPS = 0.0001;

                if (vol > totalVol + EPS) {
                    msg.textContent = "Nicht genug Destillat zum Umsch√ºtten.";
                    return;
                }


                const avgStrength = (totalAA / totalVol) * 100;
                const AA = vol * (avgStrength / 100);

                // --------------------------
                // 2) √úberf√ºllpr√ºfung im Ziel-Fass
                // --------------------------
                let dstVol = 0;
                dst.fillHistory.forEach(e => dstVol += e.volume);

                if (dst.volume && dstVol + vol > dst.volume) {
                    if (!confirm(
                        `Warnung: Das Zielfass w√§re √ºberf√ºllt!\n` +
                        `Aktuell: ${dstVol.toFixed(1)} L\n` +
                        `+ Transfer: ${vol.toFixed(1)} L\n` +
                        `= ${(dstVol + vol).toFixed(1)} L (Fassvolumen: ${dst.volume} L)\n\n` +
                        `Trotzdem fortfahren?`
                    )) { return; }
                }

                const date = new Date().toISOString().slice(0, 10);

                // --------------------------
                // 3) AUS dem Quellfass
                // --------------------------
                src.fillHistory.push({
                    id: "transfer_out_" + Date.now(),
                    date,
                    batchId: "__transfer_out__",
                    recipeName: `Umsch√ºttung nach ${dst.name}`,
                    volume: -vol,
                    strength: avgStrength,
                    AA: -AA,
                    notes: notes || `Umsch√ºttung nach ${dst.name}`
                });
                // --- Status des Quellfasses aktualisieren ---
                let srcTotalAfter = 0;
                src.fillHistory.forEach(e => {
                    srcTotalAfter += e.volume || 0;
                });

                if (srcTotalAfter > 0.05) {
                    src.status = "in_use";
                } else {
                    src.status = "empty";
                }


                // --------------------------
                // 4) IN das Zielfass (KORRIGIERT)
                // --------------------------

                // üîë Alle echten Batch-Eintr√§ge aus dem Quellfass
                const sourceBatches = src.fillHistory.filter(e =>
                    e.batchId &&
                    e.batchId !== "__water__" &&
                    e.batchId !== "__transfer_out__" &&
                    e.volume > 0
                );

                // Gesamtvolumen dieser Batches
                let srcBatchVol = 0;
                sourceBatches.forEach(e => srcBatchVol += e.volume);

                // Batch-Anteile proportional √ºbertragen
                sourceBatches.forEach(e => {
                    const ratio = e.volume / srcBatchVol;
                    const partVol = vol * ratio;
                    const partAA = AA * ratio;

                    // üîë Herkunft aus dem Quellfass ermitteln (erste echte Charge)
                    const sourceEntry = realDist[0];   // bereits oben berechnet

                    dst.fillHistory.push({
                        id: "transfer_in_" + Date.now() + "_" + sourceEntry.batchId,
                        date,
                        batchId: sourceEntry.batchId,          // üî• weitervererben
                        recipeName: sourceEntry.recipeName || null, // üî• weitervererben
                        sourceContainerId: sourceId,
                        sourceContainerType: "cask",

                        volume: partVol,
                        strength: avgStrength,
                        AA: partAA,

                        notes: notes || `Umsch√ºttung aus ${src.name}`
                    });

                });

                // --------------------------
                // 4b) Status des Ziel-Fasses setzen
                // --------------------------
                let dstTotal = 0;
                dst.fillHistory.forEach(e => dstTotal += (e.volume || 0));

                if (dstTotal > 0.05) {
                    dst.status = "in_use";
                } else {
                    dst.status = "empty";
                }



                // --------------------------
                // 5) Speichern
                // --------------------------
                caskSaveAll(casks);
                caskRenderList();
                caskSelect(sourceId);   // zeigt Quellfass mit aktualisierten Daten


                alert("Umsch√ºtten erfolgreich durchgef√ºhrt.");

                // Wenn Quellfass noch sichtbar ist:
                caskRenderFillHistory(src);

                // Falls Zielfass ge√∂ffnet ist, aktualisieren:
                if (document.getElementById("caskId").value === targetId) {
                    caskRenderFillHistory(dst);
                }

                msg.textContent = "";
            }








            // ===============================================
            // FILL: Dropdown mit Batches f√ºllen
            // ===============================================
            function caskFillInitFor(cask) {
                const wrapper = document.getElementById("caskFillWrapper");
                if (!wrapper) return;

                const sel = document.getElementById("caskFillBatchSelect");
                if (!sel) return;

                // ‚ùó Nur noch gefilterte Batches verwenden
                const batches = batchLoadAll ? batchLoadAll() : [];

                sel.innerHTML = `<option value="">‚Äî Charge w√§hlen ‚Äî</option>`;

                batches.forEach(b => {
                    // nur destillierte Chargen zulassen
                    if (!b.distillation || !b.distillation.newMakeVolume) return;

                    // Restmengen pr√ºfen ‚Äì falls 0 ‚Üí ohnehin schon rausgefiltert
                    if (b.remainingVolume <= 0.01) return;

                    const labelParts = [];

                    if (b.recipeName) labelParts.push(b.recipeName);
                    if (b.distillation?.date) labelParts.push(b.distillation.date);

                    const restVol =
                        Number(b.remainingVolume ??
                            b.distillation?.newMakeVolume ??
                            b.distillation?.volume ??
                            0);

                    const restStrength =
                        Number(b.distillation?.newMakeStrength ??
                            b.distillation?.strength ??
                            0);

                    labelParts.push(
                        `Rest: ${restVol.toFixed(1)} L @ ${restStrength.toFixed(1)} %`
                    );


                    const opt = document.createElement("option");
                    opt.value = b.id;
                    opt.textContent = labelParts.join(" ‚Äì ");
                    sel.appendChild(opt);
                });

                wrapper.style.display = "block";

                const msg = document.getElementById("caskFillMessage");
                if (msg) msg.textContent = "";
            }











            // ===============================================
            // ADD TASTING
            // ===============================================
            function caskAddTasting() {
                const id = document.getElementById("caskId").value;
                if (!id) {
                    alert("Bitte zuerst ein Fass ausw√§hlen.");
                    return;
                }

                const all = caskLoadAll();
                const c = all.find(x => x.id === id);
                if (!c) return;

                const t = {
                    id: "taste_" + Date.now(),
                    date: document.getElementById("tastDate").value,
                    strengthSampled: parseFloat(document.getElementById("tastStrength").value) || null,
                    color: document.getElementById("tastColor").value,
                    score: parseInt(document.getElementById("tastScore").value) || null,
                    nose: document.getElementById("tastNose").value.trim(),
                    palate: document.getElementById("tastPalate").value.trim(),
                    finish: document.getElementById("tastFinish").value.trim(),
                    notes: document.getElementById("tastNotes").value.trim()
                };

                if (!t.date) {
                    alert("Bitte ein Datum f√ºr die Fassprobe eingeben.");
                    return;
                }

                c.tastings.push(t);
                caskSaveAll(all);
                caskRenderTastings(c);

                alert("Fassprobe gespeichert!");
            }




            // ===============================================
            // RENDER TASTINGS
            // ===============================================
            function caskRenderTastings(cask) {
                const box = document.getElementById("caskTastingList");

                if (!cask.tastings || cask.tastings.length === 0) {
                    box.innerHTML = "<em>Noch keine Fassproben eingetragen.</em>";
                    return;
                }

                let html = "<h4>Bisherige Fassproben</h4>";
                cask.tastings
                    .sort((a, b) => (a.date > b.date ? -1 : 1))
                    .forEach(t => {
                        html += `
                <div style="border-bottom:1px solid #ddd; padding:6px 0;">
                    <strong>${t.date}</strong> ‚Äì St√§rke: ${t.strengthSampled || "‚Äì"} % Vol<br>
                    Farbe: ${t.color || "‚Äì"}, Bewertung: ${t.score || "‚Äì"}<br>
                    Nase: ${t.nose || "‚Äì"}<br>
                    Gaumen: ${t.palate || "‚Äì"}<br>
                    Finish: ${t.finish || "‚Äì"}<br>
                    <em>${t.notes || ""}</em>
                </div>
            `;
                    });

                box.innerHTML = html;
            }



            function caskRenderTastingHeader(cask) {
                const header = document.getElementById("caskTastingCurrent");
                if (!header) return;

                header.innerHTML = `
                    <strong>Sensorik f√ºr Fass:</strong> ${cask.name || "(ohne Name)"}<br>
                    <span style="font-size:0.85em; color:#666;">
                        Holz: ${cask.wood || "-"}, Toasting: ${cask.toast || "-"}, Vorbelegung: ${cask.previousFill || "-"}
                    </span>
                `;
            }



            function toggleSensorikHelp() {
                const box = document.getElementById('sensorikHelp');
                box.style.display = (box.style.display === 'none' ? 'block' : 'none');
            }


            function toggleFieldHelp(id) {
                const el = document.getElementById(id);
                el.style.display = (el.style.display === 'none' ? 'block' : 'none');
            }





            function printCaskTastings() {

                const caskId = document.getElementById("caskId").value;
                if (!caskId) {
                    alert("Kein Fass ausgew√§hlt.");
                    return;
                }

                const casks = JSON.parse(localStorage.getItem("casks") || "[]");
                const cask = casks.find(c => c.id === caskId);

                if (!cask) {
                    alert("Fass nicht gefunden.");
                    return;
                }

                const tastings = cask.tastings || [];

                if (tastings.length === 0) {
                    alert("F√ºr dieses Fass sind keine Fassproben gespeichert.");
                    return;
                }

                // Sortieren: neueste oben
                tastings.sort((a, b) => (b.date || "").localeCompare(a.date || ""));

                // ------- Druckinhalt erzeugen -------
                let html = `
                    <html>
                    <head>
                        <title>Fassproben ‚Äì ${cask.name}</title>
                        <style>
                            body { 
                                font-family: Arial, Helvetica, sans-serif; 
                                padding: 20px; 
                            }
                            h1 { 
                                border-bottom: 2px solid #c28b47;
                                padding-bottom:5px;
                            }
                            .sample {
                                margin-top: 15px;
                                padding: 12px;
                                border: 1px solid #ccc;
                                border-radius: 8px;
                            }
                            .label { font-weight:bold; }
                            .notes { font-style:italic; color:#555; margin-top:5px; }
                        </style>
                    </head>
                    <body>

                        <h1>Fassproben ‚Äì ${cask.name}</h1>

                        <p>
                            Holz: ${cask.wood || "-"}<br>
                            Toasting: ${cask.toast || "-"}<br>
                            Volumen: ${cask.volume || "-"}<br>
                            Vorbelegt mit: ${cask.previousFill || "-"}<br>
                            Gekauft von: ${cask.cooperage || "-"}<br> 
                            Fasskosten: ${cask.purchaseCost != null ? cask.purchaseCost + " ‚Ç¨" : "-"}<br>
                            Notiz zum Fass: ${cask.notes || "-"} L
                        </p>

                        <hr>
                `;

                tastings.forEach(t => {
                    html += `
                        <div class="sample">
                            <div><span class="label">Datum:</span> ${t.date || "-"}</div>
                            <div><span class="label">St√§rke:</span> ${t.strengthSampled ?? "-"} % vol</div>
                            <div><span class="label">Farbe:</span> ${t.color || "-"}</div>
                            <div><span class="label">Bewertung:</span> ${t.score ?? "-"} / 100</div>
                            <br>
                            <div><span class="label">Nase:</span> ${t.nose || "-"}</div>
                            <div><span class="label">Gaumen:</span> ${t.palate || "-"}</div>
                            <div><span class="label">Finish:</span> ${t.finish || "-"}</div>
                            <div class="notes">${t.notes || ""}</div>
                        </div>
                    `;
                });

                html += `
                    </body>
                    </html>
                `;

                // ---- Neues Fenster zum Drucken √∂ffnen ----
                const w = window.open("", "_blank");
                w.document.write(html);
                w.document.close();
                w.print();
            }







            function caskOnBatchSelected() {
                const batchId = document.getElementById("caskFillBatchSelect").value;

                const volField = document.getElementById("caskFillVolume");
                const alcField = document.getElementById("caskFillStrength");
                const notesField = document.getElementById("caskFillNotes");

                // Felder zur√ºcksetzen
                volField.value = "";
                alcField.value = "";
                // Notes lassen wir bewusst bestehen

                if (!batchId) return;

                const batches = batchLoadAll ? batchLoadAll() : [];


                const b = batches.find(x => x.id === batchId);
                if (!b) return;

                // -----------------------------
                // Restmengen initialisieren falls n√∂tig
                // -----------------------------
                if (b.remainingVolume == null) {
                    const baseVol = b.distillation?.newMakeVolume || 0;
                    const baseAlc = b.distillation?.newMakeStrength || 0;

                    b.remainingVolume = baseVol;
                    b.remainingAA = baseVol * (baseAlc / 100);

                    batchSaveAll(batches);
                }

                // -----------------------------
                // üî• KORREKTE VORAUSF√úLLUNG:
                // Restmenge, nicht Gesamtmenge!
                // -----------------------------
                volField.value = b.remainingVolume.toFixed(2);

                // Alkoholst√§rke = Brandst√§rke
                alcField.value = b.distillation?.newMakeStrength || "";
            }






            // ===============================================
            // F√ºllhistorie pro Fass anzeigen
            // ===============================================
            function caskRenderFillHistory(cask) {
                const box = document.getElementById("caskFillHistoryBox");
                if (!box) return;

                if (!cask.fillHistory || cask.fillHistory.length === 0) {
                    box.innerHTML = "<em>Noch keine Eintr√§ge.</em>";
                    return;
                }

                let rows = "";
                let totalVol = 0;
                let totalAA = 0;

                cask.fillHistory.forEach(entry => {
                    const aa = entry.volume * (entry.strength / 100);
                    totalVol += entry.volume;
                    totalAA += aa;

                    rows += `
            <tr>
                <td>
                    ${entry.recipeName
                            ? entry.recipeName
                            : (entry.batchId ? "Charge " + entry.batchId : "Wasserzugabe")}
                    ${entry.notes ? `<div style='font-size:0.8em; color:#666;'>Notizen: ${entry.notes}</div>` : ""}
                </td>

                <td>${entry.volume.toFixed(2)} L</td>
                <td>${entry.strength.toFixed(1)} %</td>
                <td>${entry.date}</td>
            </tr>
        `;
                });

                const avgStrength = totalVol > 0 ? (totalAA / totalVol) * 100 : 0;

                box.innerHTML = `
        <h4>F√ºllhistorie</h4>
        <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
            <tr style="background:#eee;">
                <th>Quelle</th>
                <th>Menge (L)</th>
                <th>%vol</th>
                <th>Datum</th>
            </tr>
            ${rows}
        </table>

        <div style="margin-top:8px; padding:6px; background:#f4f4f4; border:1px solid #ddd;">
            <strong>Gesamtvolumen:</strong> ${totalVol.toFixed(2)} L<br>
            <strong>Durchschnittliche St√§rke:</strong> ${avgStrength.toFixed(1)} %vol<br>
            <strong>Gesamt-AA:</strong> ${totalAA.toFixed(2)} L AA
        </div>
    `;
            }






            // ===============================================
            // Batch in ausgew√§hltes Fass einf√ºllen
            // ===============================================
            function caskFillBatch() {
                const caskId = document.getElementById("caskId").value;
                const batchId = document.getElementById("caskFillBatchSelect").value;

                const vol = parseFloat(document.getElementById("caskFillVolume").value);
                const alc = parseFloat(document.getElementById("caskFillStrength").value);
                const notes = document.getElementById("caskFillNotes").value.trim();

                const msg = document.getElementById("caskFillMessage");

                if (!caskId) {
                    msg.textContent = "Bitte zuerst ein Fass ausw√§hlen.";
                    return;
                }

                if (!batchId) {
                    msg.textContent = "Bitte eine Charge ausw√§hlen.";
                    return;
                }

                if (!vol || vol <= 0) {
                    msg.textContent = "Ung√ºltiges Volumen.";
                    return;
                }

                if (!alc || alc < 0) {
                    msg.textContent = "Ung√ºltige St√§rke.";
                    return;
                }

                const isWater = (batchId === "__water__");

                // -----------------------
                // F√§sser laden
                // -----------------------
                const casks = caskLoadAll();
                const c = casks.find(x => x.id === caskId);
                if (!c) {
                    msg.textContent = "Fass nicht gefunden.";
                    return;
                }

                // -----------------------
                // Batch laden (falls nicht Wasserzugabe)
                // -----------------------
                const batches = batchLoadAll ? batchLoadAll() : [];
                let b = null;

                if (!isWater) {
                    b = batches.find(x => x.id === batchId);
                    if (!b) {
                        msg.textContent = "Charge nicht gefunden.";
                        return;
                    }

                    // Initialisiere Restmengen bei Bedarf
                    if (b.remainingVolume == null) {
                        const baseVol = b.distillation?.newMakeVolume || 0;
                        const baseAlc = b.distillation?.newMakeStrength || 0;
                        b.remainingVolume = baseVol;
                        b.remainingAA = baseVol * (baseAlc / 100);
                    }
                }

                // Optional: Fasswarnung
                if (c.volume && vol > c.volume) {
                    if (!confirm("Hinweis: Die F√ºllmenge ist gr√∂√üer als das Fassvolumen. Trotzdem fortfahren?")) {
                        return;
                    }
                }


                // ------------------------------------------
                // √úberf√ºll-Schutz (echter Fass√ºberlauf-Check)
                // ------------------------------------------
                const alreadyInCask = (c.fillHistory || []).reduce((sum, e) => sum + (e.volume || 0), 0);
                const projectedTotal = alreadyInCask + vol;

                if (c.volume && projectedTotal > c.volume + 0.01) {
                    msg.textContent =
                        `√úberf√ºllung! Das Fass fasst nur ${c.volume} L,`
                        + ` aber nach dieser F√ºllung w√§ren ${projectedTotal.toFixed(2)} L enthalten.`;
                    return;
                }


                // -----------------------
                // 1) Eintrag f√ºrs Fass
                // -----------------------
                const entryDate = new Date().toISOString().slice(0, 10);

                const entry = {
                    id: "fill_" + Date.now(),
                    date: entryDate,
                    batchId: isWater ? null : batchId,
                    source: isWater ? "water" : "batch",
                    recipeName: isWater ? "Wasserzugabe" : (b.recipeName || null),
                    volume: vol,
                    strength: alc,
                    AA: vol * (alc / 100),
                    notes: notes
                };

                if (!Array.isArray(c.fillHistory)) c.fillHistory = [];
                c.fillHistory.push(entry);

                // -----------------------------------------------
                // STATUS AUTOMATISCH SETZEN anhand der F√ºllh√∂he
                // -----------------------------------------------
                let currentVol = c.fillHistory.reduce((s, e) => s + e.volume, 0);

                if (currentVol > 0.05) {
                    c.status = "in_use";
                } else {
                    c.status = "empty";
                }


                // Fass speichern
                const updatedCasks = casks.map(x => x.id === c.id ? c : x);
                caskSaveAll(updatedCasks);

                // -----------------------
                // 2) Charge aktualisieren (nur wenn Batch!)
                // -----------------------
                if (!isWater) {
                    if (!Array.isArray(b.caskHistory)) b.caskHistory = [];

                    b.caskHistory.push({
                        date: entryDate,
                        caskId: c.id,
                        volume: vol,
                        strength: alc,
                        notes: notes
                    });

                    // Rest abziehen
                    b.remainingVolume -= vol;
                    b.remainingAA -= (vol * (alc / 100));

                    if (b.remainingVolume < 0.05) {
                        b.remainingVolume = 0;
                        b.remainingAA = 0;
                        b.status = "empty";
                    } else {
                        b.status = "aging";
                    }

                    const updatedBatches = batches.map(x => x.id === b.id ? b : x);
                    if (typeof batchSaveAll === "function") {
                        batchSaveAll(updatedBatches);
                    }
                }

                // -----------------------
                // UI aktualisieren
                // -----------------------
                msg.textContent = "";
                alert(isWater ? "Wasserzugabe gespeichert!" : "Charge wurde in das Fass eingetragen.");

                caskRenderFillHistory(c);

                // Dropdown nach Wasser/Batch-Entnahme aktualisieren
                caskFillInitFor(c);
                caskRenderList();

                // Eingaben leeren
                document.getElementById("caskFillVolume").value = "";
                document.getElementById("caskFillStrength").value = "";
            }











            // ===============================================
            // BATCH STORAGE
            // ===============================================
            function batchLoadAll() {
                try {
                    return JSON.parse(localStorage.getItem("batches")) || [];
                } catch (e) {
                    console.error("Fehler beim Laden der Batches:", e);
                    return [];
                }
            }


            // Aktive Charge ermitteln: der letzte Eintrag in der Batch-Liste
            function batchGetActive() {
                const all = batchLoadAll();
                if (!all || all.length === 0) return null;
                // vorerst: letzte erzeugte Charge = aktiv
                return all[all.length - 1];
            }


            // ===============================================
            // G√§rdaten f√ºr aktuelle Charge speichern
            // ===============================================
            function batchSaveFermentation() {

                if (!window.currentBatch || !window.currentBatch.id) {
                    alert("Es wurde noch keine Charge geladen.");
                    return;
                }

                const start = document.getElementById("batchFermentStart")?.value || null;
                const end = document.getElementById("batchFermentEnd")?.value || null;
                const vol = parseFloat(document.getElementById("batchFermentVolume")?.value);
                const notes = document.getElementById("batchFermentNotes")?.value.trim() || "";

                if (!start) {
                    alert("Bitte mindestens ein G√§rbeginn-Datum eingeben.");
                    return;
                }

                if (isNaN(vol) || vol <= 0) {
                    alert("Bitte ein g√ºltiges Gesamtvolumen der Maische (L) eingeben.");
                    return;
                }

                // üîπ ALLE Chargen laden
                const all = batchLoadAll();

                // üîπ DIESE Charge suchen
                const batch = all.find(b => b.id === window.currentBatch.id);
                if (!batch) {
                    alert("Charge nicht gefunden.");
                    return;
                }

                // üîπ fermentation sicher initialisieren
                batch.fermentation = {
                    startDate: start,
                    endDate: end,
                    totalVolume: vol,
                    temperature: batch.fermentation?.temperature ?? null,
                    attenuation: batch.fermentation?.attenuation ?? null,
                    notes: notes
                };

                // üîπ Status setzen
                if (!batch.status || batch.status === "mashing") {
                    batch.status = "fermenting";
                }

                // üîπ Persistieren
                batchSaveAll(all);

                // üîπ UI aktualisieren
                const box = document.getElementById("batchFermentSummary");
                if (box) {
                    box.innerHTML = `
                    <strong>G√§rdaten gespeichert:</strong><br>
                    Beginn: ${start}<br>
                    Ende: ${end || "‚Äì"}<br>
                    Gesamtvolumen: ${vol.toFixed(1)} L<br>
                    Notizen: ${notes || "<em>keine</em>"}
                `;
                }

                alert("G√§rdaten f√ºr diese Charge wurden gespeichert.");
            }



            function toggleInfo(id) {
                const el = document.getElementById(id);
                if (!el) return;
                el.style.display = (el.style.display === "none" || el.style.display === "") ? "block" : "none";
            }





            function initMashBatchPage() {
                const storedId = localStorage.getItem("currentMashRecipeId");
                if (!storedId) return;

                const recipe = recipeLoadAll().find(r => r.id === storedId);

                if (!recipe) {
                    console.warn("Rezept nicht gefunden:", storedId);
                    return;
                }

                window.currentMashRecipe = recipe;
                renderMashBatchRecipe(recipe);
                renderMashBatchIngredients(recipe.ingredients);
            }



            function renderMashBatchRecipe(recipe) {
                const box = document.getElementById("mashBatchRecipeBox");
                if (!box) return;

                box.innerHTML = `
                    <strong>Rezept:</strong> ${recipe.name}<br>
                    <span style="font-size:0.85em;color:#555;">
                        ${recipe.description || ""}
                    </span>
                `;
            }



            function renderMashBatchIngredients(ingredients) {
                const div = document.getElementById("mashBatchIngredientsTable");
                if (!div) return;

                let html = `
                    <table style="width:100%; border-collapse:collapse;">
                        <tr style="background:#eee;">
                            <th>Name</th>
                            <th>Rezept-%</th>
                        </tr>
                `;

                ingredients.forEach(i => {
                    html += `
                        <tr>
                            <td>${i.name}</td>
                            <td>${i.amount}%</td>
                        </tr>
                    `;
                });

                html += "</table>";
                div.innerHTML = html;
            }


            function caskAdjustToCaskStrength() {
                const caskId = document.getElementById("caskId").value;
                if (!caskId) {
                    alert("Bitte zuerst ein Fass ausw√§hlen.");
                    return;
                }

                const casks = caskLoadAll();
                const c = casks.find(x => x.id === caskId);
                if (!c || !c.fillHistory || c.fillHistory.length === 0) {
                    alert("Keine F√ºllung vorhanden.");
                    return;
                }

                // Gesamtvolumen & AA berechnen
                let totalVol = 0;
                let totalAA = 0;

                c.fillHistory.forEach(e => {
                    totalVol += e.volume;
                    totalAA += e.volume * (e.strength / 100);
                });

                const currentStrength = totalVol > 0 ? (totalAA / totalVol) * 100 : 0;

                // üîπ 1) Zielst√§rke aus Eingabefeld holen ‚Äì kein prompt mehr!
                let target = parseFloat(document.getElementById("caskTargetStrength").value);
                if (!target || target <= 0) {
                    alert("Bitte g√ºltige Zielfassst√§rke eingeben.");
                    return;
                }

                // üîπ 2) Berechnen, wieviel Wasser n√∂tig ist
                const neededTotalVolume = totalAA / (target / 100);
                const waterNeeded = neededTotalVolume - totalVol;

                if (waterNeeded <= 0) {
                    alert("Die gew√ºnschte St√§rke ist h√∂her als die aktuelle. Verd√ºnnung nicht m√∂glich.");
                    return;
                }

                // üîπ 3) Fass-√úberf√ºllung pr√ºfen
                if (c.volume && (totalVol + waterNeeded) > c.volume) {
                    const over = (totalVol + waterNeeded) - c.volume;

                    if (!confirm(
                        `Warnung: Das Fass w√§re nach der Verd√ºnnung √ºberf√ºllt.\n\n` +
                        `Ben√∂tigtes Wasser: ${waterNeeded.toFixed(2)} L\n` +
                        `√úberf√ºllung: ${over.toFixed(2)} L\n\n` +
                        `Trotzdem fortfahren?`
                    )) {
                        return;
                    }
                }

                // üîπ 4) Wasserzugabe als F√ºllevent speichern
                const entry = {
                    id: "water_" + Date.now(),
                    date: new Date().toISOString().slice(0, 10),
                    batchId: null,
                    recipeName: null,
                    volume: waterNeeded,
                    strength: 0,
                    AA: 0,
                    notes: `Automatische Verd√ºnnung auf ${target}%vol`
                };

                c.fillHistory.push(entry);
                caskSaveAll(casks);

                const msg = document.getElementById("caskAdjustMessage");
                if (msg) {
                    msg.textContent =
                        `${waterNeeded.toFixed(2)} L Wasser hinzugef√ºgt ‚Üí neue St√§rke ca. ${target}%vol`;
                }

                caskRenderFillHistory(c);
            }















            // ===============================================
            // Branddaten (Destillat) f√ºr aktuelle Charge speichern
            // ===============================================
            function batchSaveDistillation() {
                if (!currentBatch || !currentBatch.id) {
                    alert("Keine Charge geladen.");
                    return;
                }

                // --- Basisdaten ---
                const date = document.getElementById("mashDistillDate").value;
                const duration = parseFloat(document.getElementById("mashDistillDurationHours").value);
                const method = document.getElementById("batchDistillMethod").value;
                const notes = document.getElementById("batchDistillNotes").value.trim();

                // --- Korrigierte Werte (Endbrand) ---
                const corrVol = parseFloat(document.getElementById("fineCorrVolume").value);
                const corrAbv = parseFloat(document.getElementById("fineCorrStrength").value);

                if (isNaN(corrVol) || isNaN(corrAbv)) {
                    alert("Bitte korrigierte Werte f√ºr Menge und %vol eingeben.");
                    return;
                }

                // --- Alkoholmenge (AA) ---
                const AA = corrVol * (corrAbv / 100);

                // --- Charge laden ---
                const batches = batchLoadAll();
                const b = batches.find(x => x.id === currentBatch.id);
                if (!b) {
                    alert("Charge nicht gefunden!");
                    return;
                }

                // --- Destillation speichern ---
                b.distillation = {
                    date,
                    method,
                    duration,
                    newMakeVolume: corrVol,
                    newMakeStrength: corrAbv,
                    AA,
                    notes
                };

                b.status = "distilled";

                // =====================================================
                // üßÆ NEU: Kosten der Charge BERECHNEN & SPEICHERN
                // =====================================================

                // 1) Rohstoffkosten
                const materials = materialLoadAll();
                let matTotal = 0;
                let matItems = [];

                (b.ingredients || []).forEach(i => {
                    const mat = materials.find(m => m.name.toLowerCase() === i.name.toLowerCase());
                    if (!mat || !mat.price) return;

                    const cost = i.amount * mat.price;
                    matTotal += cost;

                    matItems.push({
                        name: i.name,
                        amount: i.amount,
                        unit: mat.unit,
                        price: mat.price,
                        cost
                    });
                });

                // 2) Energie
                const energyRate = parseFloat(document.getElementById("mashEnergyRate")?.value) || 0;
                const energyHours = duration || 0;
                const energyCost = energyRate * energyHours;

                // 3) Arbeit
                const laborHours = parseFloat(document.getElementById("mashLaborHours")?.value) || 0;
                const laborRate = parseFloat(document.getElementById("mashLaborRate")?.value) || 0;
                const laborCost = laborHours * laborRate;

                // 4) Gesamt
                const totalCost = matTotal + energyCost + laborCost;

                // 5) Kennzahlen
                const perKgMash = b.kgMash > 0 ? totalCost / b.kgMash : 0;
                const perLAA = AA > 0 ? totalCost / AA : 0;
                const perLNewMake = corrVol > 0 ? totalCost / corrVol : 0;

                // 6) IM BATCH SPEICHERN (entscheidend!)
                b.costs = {
                    materials: {
                        total: matTotal,
                        items: matItems
                    },
                    energy: {
                        hours: energyHours,
                        rate: energyRate,
                        cost: energyCost
                    },
                    labor: {
                        hours: laborHours,
                        rate: laborRate,
                        cost: laborCost
                    },
                    total: totalCost,
                    metrics: {
                        perKgMash,
                        perLAA,
                        perLNewMake
                    },
                    calculatedAt: new Date().toISOString()
                };

                // =====================================================
                // üîí JETZT erst speichern
                // =====================================================
                batchSaveAll(batches);

                // üîπ Anzeige aktualisieren (bestehende Logik)
                if (typeof batchUpdateCostPreview === "function") {
                    batchUpdateCostPreview(b);
                }

                // üîπ Zusammenfassung
                document.getElementById("batchDistillSummary").innerHTML = `
                    <strong>Destillation gespeichert:</strong><br>
                    ${corrVol.toFixed(2)} L @ ${corrAbv.toFixed(1)} %vol<br>
                    Alkohol: ${AA.toFixed(2)} L AA<br>
                    Verfahren: ${method}<br>
                    Datum: ${date}
                `;

                // üîπ Kosten nach Destillation aktualisieren & speichern
                if (typeof batchUpdateCostPreview === "function") {
                    batchUpdateCostPreview(b);
                }


                alert("Destillation gespeichert!");
            }








            function batchSaveAll(list) {
                localStorage.setItem("batches", JSON.stringify(list));
            }




            // ===============================================
            // BATCH ERSTELLEN (Whisky, Rum, Korn, Mash)
            // ===============================================
            function batchCreate(recipe, rows, mashWeight, strikeWater, spargeWater) {

                const all = batchLoadAll();

                const batch = {
                    id: "batch_" + Date.now(),
                    recipeId: recipe.id,
                    recipeName: recipe.name,
                    created: new Date().toISOString().slice(0, 10),

                    mashWeight,
                    strikeWater,
                    spargeWater,
                    mashWaterTotal: strikeWater + (spargeWater || 0),

                    materials: rows.map(r => ({
                        name: r.name,
                        amount: r.amount,
                        unit: "kg",
                        costPerUnit: r.costPerUnit ?? null
                    })),

                    fermentation: {
                        startDate: null,
                        endDate: null,
                        temperature: null,
                        attenuation: null,
                        notes: ""
                    },

                    distillation: {
                        date: null,
                        newMakeVolume: null,
                        newMakeStrength: null,
                        notes: ""
                    },

                    caskHistory: [],

                    status: "mashing"
                };

                all.push(batch);
                batchSaveAll(all);

                return batch;
            }



            // ============================================
            // Reifef√§sser (Casks): localStorage Management
            // ============================================

            // Alle Casks laden
            function caskLoadAll() {
                try {
                    return JSON.parse(localStorage.getItem("casks")) || [];
                } catch (e) {
                    console.error("Fehler beim Laden der Casks:", e);
                    return [];
                }
            }

            // Alle Casks speichern
            function caskSaveAll(list) {
                localStorage.setItem("casks", JSON.stringify(list));
            }

            // Neues Cask anlegen
            function caskCreate(data) {
                const list = caskLoadAll();

                const newCask = {
                    id: "cask_" + Date.now(),
                    name: data.name || "Unbenanntes Fass",
                    type: data.type || "unknown",      // sherry, bourbon, wine, rum, ...
                    wood: data.wood || "oak",
                    toastLevel: data.toast || "none",
                    capacity: Number(data.capacity) || 0,
                    currentFill: 0,
                    status: "empty",                   // empty | in_use | resting | finished
                    fillHistory: [],
                    sensorNotes: [],                  // Aromaproben & j√§hrliche Sensorik
                    created: new Date().toISOString().slice(0, 10)
                };

                list.push(newCask);
                caskSaveAll(list);

                return newCask;
            }

            // Einzelnes Cask laden
            function caskGetById(id) {
                return caskLoadAll().find(c => c.id === id) || null;
            }

            // Direktes Speichern eines ver√§nderten Casks
            function caskUpdate(cask) {
                const casks = JSON.parse(localStorage.getItem("casks") || "[]");
                const idx = casks.findIndex(c => c.id === cask.id);
                if (idx === -1) return;

                // üîë GANZES OBJEKT zur√ºckschreiben
                casks[idx] = cask;

                localStorage.setItem("casks", JSON.stringify(casks));
            }





            // =========================================================
            // Batch in Fass f√ºllen
            // =========================================================
            function caskFillFromBatch(batchId, caskId, volumeL, notes = "") {

                const batches = batchLoadAll();
                const batch = batches.find(b => b.id === batchId);
                if (!batch) {
                    alert("Batch nicht gefunden!");
                    return false;
                }

                const cask = caskGetById(caskId);
                if (!cask) {
                    alert("Fass nicht gefunden!");
                    return false;
                }

                volumeL = Number(volumeL);
                if (!volumeL || volumeL <= 0) {
                    alert("Ung√ºltige F√ºllmenge.");
                    return false;
                }

                // Kapazit√§t pr√ºfen
                if (cask.currentFill + volumeL > cask.capacity) {
                    alert("‚ö† Fass√ºberf√ºllung! So viel passt nicht hinein.");
                    return false;
                }

                // ==================================================
                // üîë NEU: BatchRefs initialisieren & AA berechnen
                // ==================================================
                if (!cask.batchRefs) {
                    cask.batchRefs = {};
                }

                // AA-Menge berechnen (absoluter Alkohol)
                const strength = batch.distillation?.newMakeStrength || batch.newMakeStrength || 0;
                const AA = volumeL * (strength / 100);

                // Batch-Herkunft im Fass sichern
                cask.batchRefs[batch.id] =
                    (cask.batchRefs[batch.id] || 0) + AA;

                // ----------------------
                // 1) Fass-F√ºllhistorie
                // ----------------------
                cask.fillHistory.push({
                    date: new Date().toISOString().slice(0, 10),
                    batchId: batch.id,
                    volume: volumeL,
                    strength: strength,
                    AA: AA,
                    notes
                });

                cask.currentFill += volumeL;
                cask.status = "in_use";

                caskUpdate(cask);

                // ----------------------
                // 2) Batch-Historie erg√§nzen
                // ----------------------
                batch.caskHistory = batch.caskHistory || [];

                batch.caskHistory.push({
                    date: new Date().toISOString().slice(0, 10),
                    caskId: cask.id,
                    volume: volumeL,
                    strength: strength,
                    notes
                });

                batch.status = "aging";

                batchSaveAll(batches);

                return true;
            }




            function batchFillDropdown() {
                const sel = document.getElementById("batchSelectExisting");
                if (!sel) return;

                const list = batchGetSelectableForEditing();

                sel.innerHTML = '<option value="">‚Äî Charge ausw√§hlen ‚Äî</option>';

                list.forEach(b => {
                    const opt = document.createElement("option");
                    opt.value = b.id;
                    opt.textContent = `${b.recipeName} (${b.kgMash} kg, ${b.created})`;
                    sel.appendChild(opt);
                });

                // ‚≠êÔ∏è Wichtig: Batch-ID speichern, sobald Nutzer etwas ausw√§hlt
                sel.addEventListener("change", () => {
                    window.currentBatchId = sel.value || null;
                    // console.log("Aktuelle Batch-ID:", window.currentBatchId);
                });
            }




            function batchGetSelectableForEditing() {
                const all = batchLoadAll ? batchLoadAll() : [];

                return all.filter(b => {
                    if (!b) return false;

                    // ‚ùå Fertige/archivierte Chargen NICHT anzeigen
                    const exclude = ["archived", "empty", "finished"];
                    if (exclude.includes(b.status)) return false;

                    // ‚ùå Wenn ein Restvolumen-Feld existiert und leer ist ‚Üí auch ausblenden
                    if (b.remainingVolume !== undefined && b.remainingVolume <= 0.01) return false;

                    // ‚úîÔ∏è Alle anderen "aktiven" Chargen (mashing, fermenting, distilled) anzeigen
                    return true;
                });
            }




            function batchLoadSelected() {
                const sel = document.getElementById("batchSelectExisting");
                if (!sel) return;

                // Beim Laden der Seite oder wenn Option zur√ºck auf leer ‚Üí leise abbrechen
                if (!sel.value) return;

                const list = batchLoadAll();
                const batch = list.find(b => b.id === sel.value);

                // Wenn keine Charge gefunden wurde ‚Üí leise abbrechen (kein Alert!)
                if (!batch) return;


                // In die globale Variable laden (wie beim Erstellen)
                window.currentBatch = batch;
                window.currentBatchId = batch.id;
                window.currentMashRecipe = recipeLoadAll().find(r => r.id === batch.recipeId);

                // UI-Updates starten:
                renderBatchSummary(batch);
                renderBatchMaterials(batch.ingredients);
                renderBatchFermentation(batch);
                renderBatchDistillation(batch);

                // üîπ Brenndaten in Eingabefelder zur√ºckschreiben
                if (batch.distillation) {
                    const d = batch.distillation;

                    const set = (id, val) => {
                        const el = document.getElementById(id);
                        if (el && val != null) el.value = val;
                    };

                    set("mashDistillDate", d.date);
                    set("mashDistillDurationHours", d.duration);
                    set("batchDistillMethod", d.method);
                    set("batchDistillNotes", d.notes);

                    set("fineCorrVolume", d.newMakeVolume);
                    set("fineCorrStrength", d.newMakeStrength);
                }


                // üîπ Kostenfelder laden (falls vorhanden)
                if (batch.costs) {
                    const set = (id, val) => {
                        const el = document.getElementById(id);
                        if (el && val != null) el.value = val;
                    };

                    set("mashEnergyRate", batch.costs.energy?.rate);
                    set("mashLaborHours", batch.costs.labor?.hours);
                    set("mashLaborRate", batch.costs.labor?.rate);
                }



                const info = document.getElementById("batchLoadInfo");
                info.innerHTML = `
                    <strong>Geladene Charge:</strong><br>
                    Rezept: ${batch.recipeName}<br>
                    Sch√ºttung: ${batch.kgMash} kg<br>
                    Status: ${batch.status}<br>
                    Erstellt: ${batch.created}
                `;

                updateBatchStartButton();

                // üîπ Kosten√ºbersicht sofort anzeigen
                if (typeof batchUpdateCostPreview === "function") {
                    batchUpdateCostPreview(batch);
                }

            }



            function renderBatchSummary(batch) {
                const box = document.getElementById("batchInfoBox");
                if (!box) return;
                box.innerHTML = `
                    <strong>Charge:</strong> ${batch.recipeName}<br>
                    Sch√ºttung: ${batch.kgMash} kg<br>
                    Strike: ${batch.strikeWater.toFixed(1)} L<br>
                    Sparge: ${batch.spargeWater.toFixed(1)} L<br>
                    Gesamtwasser: ${batch.totalWater.toFixed(1)} L<br>
                    Status: ${batch.status}
                `;
            }




            function renderBatchMaterials(ingredients) {
                const box = document.getElementById("batchMaterialsBox");
                if (!box) return;

                let html = `
                    <table style="width:100%; border-collapse:collapse;">
                        <tr style="background:#eee;">
                            <th>Rohstoff</th>
                            <th>Menge (kg)</th>
                        </tr>
                `;

                ingredients.forEach(i => {
                    html += `
                <tr>
                    <td>${i.name}</td>
                    <td>${i.amount.toFixed(2)}</td>
                </tr>`;
                });

                html += "</table>";

                box.innerHTML = html;
            }




            function renderBatchFermentation(batch) {
                const f = batch.fermentation || {};

                const startEl = document.getElementById("batchFermentStart");
                const endEl = document.getElementById("batchFermentEnd");
                const volEl = document.getElementById("batchFermentVolume");
                const notesEl = document.getElementById("batchFermentNotes");
                const summary = document.getElementById("batchFermentSummary");

                // Eingabefelder setzen (oder leeren)
                if (startEl) startEl.value = f.startDate || "";
                if (endEl) endEl.value = f.endDate || "";
                if (volEl) volEl.value = (f.totalVolume != null ? f.totalVolume : "");
                if (notesEl) notesEl.value = f.notes || "";

                if (!summary) return;

                if (!f.startDate) {
                    summary.innerHTML = "<em>Noch keine G√§rdaten gespeichert.</em>";
                    return;
                }

                summary.innerHTML = `
                    <strong>G√§rung:</strong><br>
                    Beginn: ${f.startDate}<br>
                    Ende: ${f.endDate || "‚Äì"}<br>
                    Gesamtvolumen: ${f.totalVolume != null ? f.totalVolume.toFixed(1) + " L" : "‚Äì"
                    }<br>
                    Notizen: ${f.notes && f.notes.trim() ? f.notes : "<em>keine</em>"}
                `;
            }





            function renderBatchDistillation(batch) {
                const d = batch.distillation || {};

                const dateEl = document.getElementById("batchDistillDate");
                const volEl = document.getElementById("batchDistillVolume");
                const alcEl = document.getElementById("batchDistillStrength");
                const notesEl = document.getElementById("batchDistillNotes");
                const summary = document.getElementById("batchDistillSummary");

                // Eingabefelder setzen (oder leeren)
                if (dateEl) dateEl.value = d.date || "";
                if (volEl) volEl.value = (d.newMakeVolume != null ? d.newMakeVolume : "");
                if (alcEl) alcEl.value = (d.newMakeStrength != null ? d.newMakeStrength : "");
                if (notesEl) notesEl.value = d.notes || "";

                if (!summary) return;

                if (!d.date) {
                    summary.innerHTML = "<em>Noch keine Branddaten gespeichert.</em>";
                    return;
                }

                summary.innerHTML = `
                    <strong>Branddaten:</strong><br>
                    Datum: ${d.date}<br>
                    Destillat: ${d.newMakeVolume != null ? d.newMakeVolume.toFixed(1) + " L" : "‚Äì"
                    } bei ${d.newMakeStrength != null ? d.newMakeStrength.toFixed(1) + " %vol" : "‚Äì"
                    }<br>
                    Notizen: ${d.notes && d.notes.trim() ? d.notes : "<em>keine</em>"}
                `;
            }





            function updateBatchStartButton() {
                const btn = document.getElementById("batchStartBtn");
                if (!btn) return;

                if (window.currentBatch) {
                    btn.textContent = "üîÅ Neue Charge anlegen";
                } else if (window.currentMashRecipe) {
                    btn.textContent = "‚ûï Charge aus diesem Rezept starten";
                } else {
                    btn.textContent = "‚ûï Neue Charge anlegen";
                }
            }









            function batchResetUI() {

                // ---------- G√ÑRUNG ----------
                const fStart = document.getElementById("batchFermentStart");
                const fEnd = document.getElementById("batchFermentEnd");
                const fVol = document.getElementById("batchFermentVolume");
                const fNotes = document.getElementById("batchFermentNotes");
                const fSum = document.getElementById("batchFermentSummary");

                if (fStart) fStart.value = "";
                if (fEnd) fEnd.value = "";
                if (fVol) fVol.value = "";
                if (fNotes) fNotes.value = "";
                if (fSum) fSum.innerHTML = "<em>Noch keine G√§rdaten gespeichert.</em>";

                // ---------- BRAND ----------
                const dDate = document.getElementById("batchDistillDate");
                const dVol = document.getElementById("batchDistillVolume");
                const dStr = document.getElementById("batchDistillStrength");
                const dNotes = document.getElementById("batchDistillNotes");
                const dSum = document.getElementById("batchDistillSummary");

                if (dDate) dDate.value = "";
                if (dVol) dVol.value = "";
                if (dStr) dStr.value = "";
                if (dNotes) dNotes.value = "";
                if (dSum) dSum.innerHTML = "<em>Noch keine Branddaten gespeichert.</em>";
            }




            function batchLoadIntoUI(batch) {

                // Rohstoffe (falls vorhanden)
                if (batch.ingredients && batch.ingredients.length > 0) {
                    renderBatchMaterialsForCharge(batch.ingredients);
                }

                // InfoBox aktualisieren
                const box = document.getElementById("batchInfoBox");
                if (box) {
                    box.innerHTML = `
                        <strong>Charge geladen:</strong><br>
                        Rezept: ${batch.recipeName}<br>
                        Sch√ºttung: ${batch.kgMash} kg<br>
                        Strike Water: ${batch.strikeWater.toFixed(1)} L<br>
                        Sparge Water: ${batch.spargeWater.toFixed(1)} L<br>
                        Gesamtwasser: ${batch.totalWater.toFixed(1)} L
                    `;
                }

                // G√§rdaten
                if (batch.fermentation) {
                    document.getElementById("batchFermentStart").value = batch.fermentation.startDate || "";
                    document.getElementById("batchFermentEnd").value = batch.fermentation.endDate || "";
                    document.getElementById("batchFermentVolume").value = batch.fermentation.volume || "";
                    document.getElementById("batchFermentNotes").value = batch.fermentation.notes || "";
                }

                // Branddaten
                if (batch.distillation) {
                    document.getElementById("batchDistillDate").value = batch.distillation.date || "";
                    document.getElementById("batchDistillVolume").value = batch.distillation.newMakeVolume || "";
                    document.getElementById("batchDistillStrength").value = batch.distillation.newMakeStrength || "";
                    document.getElementById("batchDistillNotes").value = batch.distillation.notes || "";
                }
            }



            function batchUpdateCostPreview(batch) {
                if (!batch || !Array.isArray(batch.ingredients)) return;

                // =================================================
                // 1) Rohstoffkosten (Sch√ºttung)
                // =================================================
                const materials = materialLoadAll();
                let materialTotal = 0;
                let materialRows = [];

                batch.ingredients.forEach(i => {
                    const amount = parseFloat(i.amount) || 0;
                    if (amount <= 0) return;

                    const mat = materials.find(
                        m => m.name.toLowerCase() === i.name.toLowerCase()
                    );

                    let pricePerKg = 0;
                    if (mat) {
                        if (!isNaN(mat.pricePerKg)) pricePerKg = mat.pricePerKg;
                        else if (!isNaN(mat.pricePerUnit)) pricePerKg = mat.pricePerUnit;
                        else if (!isNaN(mat.price)) pricePerKg = mat.price;
                    }

                    const cost = amount * pricePerKg;
                    materialTotal += cost;

                    materialRows.push(
                        `${i.name}: ${amount.toFixed(2)} kg √ó ${pricePerKg.toFixed(2)} ‚Ç¨ = ${cost.toFixed(2)} ‚Ç¨`
                    );
                });

                // =================================================
                // 2) Energiekosten
                // =================================================
                const energyRate =
                    parseFloat(document.getElementById("mashEnergyRate")?.value) || 0;

                const energyHours =
                    batch.distillation?.duration ||
                    parseFloat(document.getElementById("mashDistillDurationHours")?.value) ||
                    0;

                const energyCost = energyRate * energyHours;

                // =================================================
                // 3) Arbeitskosten
                // =================================================
                const laborHours =
                    parseFloat(document.getElementById("mashLaborHours")?.value) || 0;

                const laborRate =
                    parseFloat(document.getElementById("mashLaborRate")?.value) || 0;

                const laborCost = laborHours * laborRate;

                // =================================================
                // 4) Gesamtkosten
                // =================================================
                const totalCost = materialTotal + energyCost + laborCost;

                // =================================================
                // 5) Kennzahlen
                // =================================================
                const kgMash = parseFloat(batch.kgMash) || 0;
                const costPerKgMash = kgMash > 0 ? totalCost / kgMash : 0;

                let AA = batch.distillation?.AA || 0;
                let costPerLAA = AA > 0 ? totalCost / AA : 0;

                let nmVol = batch.distillation?.newMakeVolume || 0;
                let costPerLNewMake = nmVol > 0 ? totalCost / nmVol : 0;

                // =================================================
                // 6) Kosten IN DER CHARGE speichern (WICHTIG)
                // =================================================
                batch.costs = {
                    materials: materialTotal,

                    energy: {
                        rate: energyRate,
                        hours: energyHours,
                        cost: energyCost
                    },

                    labor: {
                        hours: laborHours,
                        rate: laborRate,
                        cost: laborCost
                    },

                    total: totalCost,

                    metrics: {
                        perKgMash: costPerKgMash,
                        perLAA: costPerLAA,
                        perLNewMake: costPerLNewMake
                    }
                };

                const all = batchLoadAll();
                const idx = all.findIndex(b => b.id === batch.id);
                if (idx >= 0) {
                    all[idx] = batch;
                    batchSaveAll(all);
                }

                // =================================================
                // 7) Anzeige
                // =================================================
                const box = document.getElementById("batchCostBox");
                if (!box) return;

                box.innerHTML = `
                    <strong>Rohstoffe:</strong><br>
                    ${materialRows.join("<br>")}
                    <br>‚Üí ${materialTotal.toFixed(2)} ‚Ç¨<br><br>

                    <strong>Energie:</strong>
                    ${energyHours.toFixed(2)} h √ó ${energyRate.toFixed(2)} ‚Ç¨ = ${energyCost.toFixed(2)} ‚Ç¨<br>

                    <strong>Arbeit:</strong>
                    ${laborHours.toFixed(2)} h √ó ${laborRate.toFixed(2)} ‚Ç¨ = ${laborCost.toFixed(2)} ‚Ç¨<br><br>

                    <strong>Gesamt:</strong> ${totalCost.toFixed(2)} ‚Ç¨<br><br>

                   <strong>Kennzahlen:</strong><br>

                    ${kgMash ? `
                    ‚Ä¢ ${costPerKgMash.toFixed(2)} ‚Ç¨ / kg Sch√ºttung
                    <span class="info-icon" onclick="toggleInfo('info_perKg_${batch.id}')">‚ìò</span>
                    <div id="info_perKg_${batch.id}" class="metric-help">
                        Kosten pro kg Sch√ºttung (Rohstoffe + Energie + Arbeit). Gut zum Vergleich verschiedener Rezepte.
                    </div><br>
                    ` : ""}

                    ${AA ? `
                    ‚Ä¢ ${costPerLAA.toFixed(2)} ‚Ç¨ / L AA
                    <span class="info-icon" onclick="toggleInfo('info_perAA_${batch.id}')">‚ìò</span>
                    <div id="info_perAA_${batch.id}" class="metric-help">
                        Kosten pro Liter Reinalkohol (100%). Wichtigste Vergleichsgr√∂√üe ‚Äì unabh√§ngig von St√§rke oder Verd√ºnnung.
                    </div><br>
                    ` : ""}

                    ${costPerLNewMake ? `
                    ‚Ä¢ ${costPerLNewMake.toFixed(2)} ‚Ç¨ / L New Make
                    <span class="info-icon" onclick="toggleInfo('info_perNM_${batch.id}')">‚ìò</span>
                    <div id="info_perNM_${batch.id}" class="metric-help">
                        Kosten pro Liter New Make in der aktuellen St√§rke. N√ºtzlich f√ºr Fassbef√ºllung und Lagerbewertung.
                    </div><br>
                    ` : ""}

                `;
            }






            // =========================================
            // ü™Ω Angel's Share manuell verbuchen
            // =========================================
            function caskAddAngelsShare() {
                const caskId = document.getElementById("caskId").value;
                if (!caskId) {
                    alert("Bitte zuerst ein Fass ausw√§hlen.");
                    return;
                }

                const casks = caskLoadAll();
                const c = casks.find(x => x.id === caskId);
                if (!c) {
                    alert("Fass nicht gefunden.");
                    return;
                }

                // --- Menge abfragen ---
                let loss = prompt("Wieviel Liter sind verdunstet? (z. B. 2.5)");
                if (!loss) return;

                loss = parseFloat(loss);
                if (isNaN(loss) || loss <= 0) {
                    alert("Ung√ºltige Menge.");
                    return;
                }

                // --- St√§rke optional abfragen ---
                let strength = prompt(
                    "Gesch√§tzte aktuelle St√§rke (%vol)?\n" +
                    "(Leer lassen, wenn unbekannt ‚Äì dann bleibt St√§rke unver√§ndert.)"
                );

                let parsedStrength = null;
                if (strength && !isNaN(parseFloat(strength))) {
                    parsedStrength = parseFloat(strength);
                }

                // Aktuelles Gesamt-AA berechnen
                let totalVol = 0;
                let totalAA = 0;

                c.fillHistory.forEach(e => {
                    totalVol += e.volume;
                    totalAA += e.volume * (e.strength / 100);
                });

                // Wenn St√§rke NICHT angegeben wurde ‚Üí berechne sie
                if (parsedStrength === null) {
                    parsedStrength = totalVol > 0 ? (totalAA / totalVol) * 100 : 0;
                }

                const AA_loss = loss * (parsedStrength / 100);
                const date = new Date().toISOString().slice(0, 10);

                // Negativen Eintrag erzeugen
                c.fillHistory.push({
                    id: "angel_" + Date.now(),
                    date,
                    batchId: null,
                    recipeName: null,
                    volume: -loss,
                    strength: parsedStrength,
                    AA: -AA_loss,
                    notes: "Angel‚Äôs Share / Verdunstungsverlust"
                });

                // Zustand speichern
                caskSaveAll(casks);

                alert(`Angel's Share eingetragen:\n-${loss} L @ ${parsedStrength.toFixed(1)} %vol`);

                // UI aktualisieren
                caskRenderFillHistory(c);
            }





            function saveFinalDistillationResult(volume, strength, date, duration) {
                currentBatch.distillation = {
                    date,
                    durationHours: duration,
                    newMakeVolume: volume,
                    newMakeStrength: strength
                };

                batchSaveAll(batchLoadAll());
                renderBatchDistillation(currentBatch);
            }



            function calcWhiskyCostPerLiterFromCask(cask) {
                if (!cask || !Array.isArray(cask.fillHistory)) return null;

                // 1) Alle echten Batch-IDs aus dem Fass einsammeln (Wasser/Transfers ignorieren)
                var batchIds = [];
                for (var i = 0; i < cask.fillHistory.length; i++) {
                    var e = cask.fillHistory[i];
                    if (e && typeof e.batchId === "string" && e.batchId.startsWith("batch_")) {
                        if (!batchIds.includes(e.batchId)) batchIds.push(e.batchId);
                    }
                }

                if (batchIds.length === 0) return null;

                // 2) Batch-Daten laden
                var batches = (typeof batchLoadAll === "function")
                    ? batchLoadAll()
                    : JSON.parse(localStorage.getItem("batches") || "[]");

                // ==================================================
                // 3) AKTUELLE Fass-St√§rke berechnen (inkl. Wasser/Transfers)
                // ==================================================
                var curVol = 0;
                var curAA = 0;

                for (var j = 0; j < cask.fillHistory.length; j++) {
                    var x = cask.fillHistory[j];
                    if (!x) continue;

                    var v = Number(x.volume);
                    if (!isFinite(v)) continue;

                    // Volumen immer bilanzieren (auch Wasser und Transfers)
                    curVol += v;

                    // AA bilanzieren:
                    // - wenn AA vorhanden: nehmen
                    // - sonst fallback: aus strength*volume (falls strength da ist)
                    var aaVal = Number(x.AA);
                    if (isFinite(aaVal)) {
                        curAA += aaVal;
                    } else {
                        var st = Number(x.strength);
                        if (isFinite(st)) {
                            curAA += v * (st / 100);
                        }
                    }
                }

                if (curVol <= 0 || curAA <= 0) return null;

                var strength = (curAA / curVol) * 100; // ‚úÖ aktuelle St√§rke im Fass
                if (!isFinite(strength) || strength <= 0) return null;

                // ==================================================
                // 4) Kosten pro LAA (gewichteter Durchschnitt nach AA-Anteil je Batch)
                // ==================================================
                var aaByBatch = {};
                for (var k = 0; k < cask.fillHistory.length; k++) {
                    var r = cask.fillHistory[k];
                    if (r && typeof r.batchId === "string" && r.batchId.startsWith("batch_")) {
                        aaByBatch[r.batchId] = (aaByBatch[r.batchId] || 0) + (Number(r.AA) || 0);
                    }
                }

                var totalCost = 0;
                var totalAAForCost = 0;

                for (var bid in aaByBatch) {
                    var aaPart = aaByBatch[bid] || 0;
                    if (aaPart <= 0) continue;

                    var b = batches.find(function (bb) { return bb.id === bid; });
                    var perLAA = b?.metrics?.perLAA || b?.costs?.metrics?.perLAA;

                    if (!perLAA || perLAA <= 0) return null;

                    totalCost += perLAA * aaPart;
                    totalAAForCost += aaPart;
                }

                if (totalAAForCost <= 0) return null;

                var avgPerLAA = totalCost / totalAAForCost;

                // ==================================================
                // 5) ‚Ç¨/L bei AKTUELLER St√§rke im Fass
                // ==================================================
                var costPerLiter = avgPerLAA * (strength / 100);

                if (!isFinite(costPerLiter) || costPerLiter <= 0) return null;
                return costPerLiter;
            }




            // ==================================================
            // Gewinnermittlung beginnt hier
            // ==================================================

            function gaInitFilters() {

                const products = JSON.parse(localStorage.getItem("products") || "[]");
                const bottlings = JSON.parse(localStorage.getItem("bottlings") || "[]");
                const sales = JSON.parse(localStorage.getItem("sales") || "[]");

                const prodSel = document.getElementById("gaProductFilter");
                if (!prodSel) return;

                prodSel.innerHTML = `<option value="">Alle</option>`;

                const usedProducts = new Map();

                sales
                    .filter(s => !s.cancelled)
                    .forEach(s => {

                        const b = s.bottlingId
                            ? bottlings.find(x => x.id === s.bottlingId)
                            : null;

                        // üîπ Fall A ‚Äî echtes Produkt
                        if (b && b.productRefs) {

                            const ids = Object.keys(b.productRefs);
                            if (ids.length === 1) {
                                const pid = ids[0];
                                const p = products.find(x => x.id === pid);
                                if (p) {
                                    usedProducts.set(pid, p.name);
                                    return;
                                }
                            }
                        }

                        // üîπ Fall B ‚Äî Rezept-Abf√ºllung
                        if (b) {
                            usedProducts.set(b.id, b.labelText || "Unbekanntes Produkt");
                            return;
                        }

                        // üîπ Fall C ‚Äî nur Verkaufslabel vorhanden
                        if (s.labelText) {
                            usedProducts.set("sale_" + s.id, s.labelText);
                        }
                    });

                // Dropdown bef√ºllen
                [...usedProducts.entries()]
                    .sort((a, b) => a[1].localeCompare(b[1]))
                    .forEach(([id, name]) => {
                        const opt = document.createElement("option");
                        opt.value = id;
                        opt.textContent = name;
                        prodSel.appendChild(opt);
                    });


                // Lagerorte
                const locations = [...new Set(
                    bottlings.map(b => b.location).filter(Boolean)
                )];

                const locSel = document.getElementById("gaLocationFilter");
                locSel.innerHTML = `<option value="">Alle</option>`;

                locations.forEach(l => {
                    const opt = document.createElement("option");
                    opt.value = l;
                    opt.textContent = l;
                    locSel.appendChild(opt);
                });

                // Zeitraum setzen
                const now = new Date();
                document.getElementById("gaDateFrom").value = `${now.getFullYear()}-01-01`;
                document.getElementById("gaDateTo").value = now.toISOString().slice(0, 10);
            }









            function gaRunAnalysis() {
                console.clear();
                console.log("=== GA START ===");

                const from = document.getElementById("gaDateFrom").value;
                const to = document.getElementById("gaDateTo").value;
                const productId = document.getElementById("gaProductFilter").value;
                const size = document.getElementById("gaSizeFilter").value;
                const location = document.getElementById("gaLocationFilter").value;

                const sales = JSON.parse(localStorage.getItem("sales") || "[]");
                const bottlings = JSON.parse(localStorage.getItem("bottlings") || "[]");
                const products = JSON.parse(localStorage.getItem("products") || "[]");

                // Verk√§ufe nach Zeitraum filtern
                const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");

                const filtered = sales.filter(s => {

                    // 1Ô∏è‚É£ explizit stornierte Verk√§ufe ignorieren
                    if (s.cancelled) return false;

                    // 2Ô∏è‚É£ wenn Rechnung existiert ‚Üí Storno pr√ºfen
                    if (s.invoiceId) {
                        const inv = invoices.find(i => i.id === s.invoiceId);
                        if (inv && inv.status === "cancelled") return false;
                    }

                    // 3Ô∏è‚É£ Datum ermitteln
                    const d = gaGetSaleDate(s);
                    if (!d) return false;

                    // 4Ô∏è‚É£ Zeitraum anwenden
                    return (!from || d >= from) &&
                        (!to || d <= to);
                });


                // Verk√§ufe mit Produktdaten anreichern
                const enriched = filtered.map(s => {

                    const b = s.bottlingId
                        ? bottlings.find(x => x.id === s.bottlingId)
                        : null;

                    let prodId = null;
                    let prodName = "Unbekanntes Produkt";

                    // üîπ Fall A ‚Äî echtes Produkt √ºber productRefs
                    if (b && b.productRefs) {

                        const ids = Object.keys(b.productRefs);
                        if (ids.length === 1) {

                            prodId = ids[0];

                            const p = products.find(x => x.id === prodId);
                            if (p) prodName = p.name;
                        }
                    }

                    // üîπ Fall B ‚Äî Rezept-Abf√ºllung
                    if (!prodId && b) {
                        prodId = b.id;
                        prodName = b.labelText || "Unbekanntes Produkt";
                    }

                    // üîπ Fall C ‚Äî alter/undefinierter Verkauf ‚Üí gleiche ID wie im Dropdown!
                    if (!prodId) {
                        prodId = "sale_" + s.id;
                        prodName = s.labelText || "Unbekanntes Produkt";
                    }


                    const sizeFromLabel = gaExtractBottleSizeFromLabel(s.labelText);

                    return {
                        productId: prodId,
                        productName: prodName,
                        strength: b?.strength || b?.targetStrength || 0,
                        // üî• Priorit√§t:
                        // 1Ô∏è‚É£ echte Flaschengr√∂√üe aus Bottling
                        // 2Ô∏è‚É£ sonst aus Label lesen
                        // 3Ô∏è‚É£ sonst null
                        bottleSize: (typeof b?.bottleSize === "number")
                            ? b.bottleSize
                            : sizeFromLabel,
                        location: b?.location || "",
                        count: s.bottleCount || 0,
                        pricePerBottle: s.pricePerBottle || 0,
                        costPerBottle: s.internalCostPerBottle || 0,
                        extra: s.extraCosts || 0
                    };

                });


                // Filter anwenden
                const final = enriched.filter(e =>
                    (!productId || e.productId === productId) &&
                    (!size || (e.bottleSize && e.bottleSize == size)) &&
                    (!location || e.location === location)
                );

                gaBuildResult(final);
            }




            function gaExtractBottleSizeFromLabel(label) {
                if (!label) return null;

                const m = label.match(/([0-9]+)\s*ml/i);
                if (!m) return null;

                return Number(m[1]) / 1000; // ml ‚Üí Liter
            }







            function gaBuildResult(items) {

                const box = document.getElementById("gaResult");

                if (!items.length) {
                    box.innerHTML = "<em>Keine Daten im Zeitraum.</em>";
                    return;
                }

                const groups = {};

                items.forEach(e => {

                    const key = `${e.productName}|${e.strength}|${e.bottleSize}`;

                    if (!groups[key]) {
                        groups[key] = {
                            productName: e.productName,
                            strength: e.strength,
                            bottleSize: e.bottleSize,
                            sales: 0,
                            revenue: 0,
                            cost: 0,
                            profit: 0
                        };
                    }

                    groups[key].sales += e.count;
                    groups[key].revenue += e.count * e.pricePerBottle;
                    groups[key].cost += e.count * e.costPerBottle + e.extra;
                    groups[key].profit = groups[key].revenue - groups[key].cost;
                });

                const rows = Object.values(groups);

                let total = rows.reduce((t, r) => ({
                    sales: t.sales + r.sales,
                    revenue: t.revenue + r.revenue,
                    cost: t.cost + r.cost,
                    profit: t.profit + r.profit
                }), { sales: 0, revenue: 0, cost: 0, profit: 0 });

                let html = `
                <table style="width:100%; border-collapse:collapse;">
                    <tr style="background:#eee;">
                        <th>Produkt</th>
                        <th>%vol</th>
                        <th>Gr√∂√üe</th>
                        <th>Verk√§ufe</th>
                        <th>Umsatz (‚Ç¨)</th>
                        <th>Kosten (‚Ç¨)</th>
                        <th>Gewinn (‚Ç¨)</th>
                        <th>Gewinn / Flasche (‚Ç¨)</th>
                    </tr>
                `;

                rows.forEach(r => {
                    html += `
                    <tr>
                        <td>${r.productName}</td>
                        <td align="right">${r.strength.toFixed(1)}</td>
                        <td align="right">${(r.bottleSize * 1000).toFixed(0)} ml</td>
                        <td align="right">${r.sales}</td>
                        <td align="right">${r.revenue.toFixed(2)}</td>
                        <td align="right">${r.cost.toFixed(2)}</td>
                        <td align="right" style="color:${r.profit >= 0 ? 'green' : 'red'}">${r.profit.toFixed(2)}</td>
                        <td align="right">${(r.profit / r.sales).toFixed(2)}</td>
                    </tr>`;
                });

                html += `
                    <tr style="background:#ddd; font-weight:bold;">
                        <td>GESAMT</td>
                        <td></td><td></td>
                        <td align="right">${total.sales}</td>
                        <td align="right">${total.revenue.toFixed(2)}</td>
                        <td align="right">${total.cost.toFixed(2)}</td>
                        <td align="right" style="color:${total.profit >= 0 ? 'green' : 'red'}">${total.profit.toFixed(2)}</td>
                        <td align="right">${(total.profit / total.sales).toFixed(2)}</td>
                    </tr>
                </table>
                `;

                box.innerHTML = html;
            }


            function gaGetSaleDate(sale) {

                // 1Ô∏è‚É£ explizites Tagesdatum vorhanden?
                if (sale.date) return sale.date;

                // 2Ô∏è‚É£ sonst createdAt verwenden
                if (sale.createdAt)
                    return sale.createdAt.split("T")[0];   // Datum-Teil extrahieren

                // 3Ô∏è‚É£ Sicherer Fallback
                return null;
            }













































            // ===== Startinitialisierung nach Laden der Seite =====
            const typeSelect = document.getElementById("type");
            if (typeSelect) {
                typeSelect.innerHTML = `
            <option value="liter">Obst (Liter Maische)</option>
            <option value="kg">Getreide/Kartoffeln (kg)</option>
        `;
                updateFruits();
            }

            if (typeof initBarrelPage === "function") initBarrelPage();
            if (typeof updateBarrelDropdown === "function") updateBarrelDropdown();

            // ===== Globale Sichtbarkeit f√ºr Buttons =====
            window.calculate = calculate;
            window.calculateDilution = calculateDilution;
            window.calculateCorrection = calculateCorrection;
            window.updateFruits = updateFruits;

            // ===== Globale Sichtbarkeit f√ºr HTML-Aufrufe =====
            window.calculate = calculate;
            window.calculateDilution = calculateDilution;
            window.calculateCorrection = calculateCorrection;
            window.updateFruits = updateFruits;
            window.selectBarrelFromDropdown = selectBarrelFromDropdown;
            window.saveBarrel = saveBarrel;
            window.deleteBarrel = deleteBarrel;
            window.showProtocol = showProtocol;
            window.saveProtocolEntry = saveProtocolEntry;
            window.deleteEntry = deleteEntry;
            window.exportBackup = exportBackup;
            window.importBackup = importBackup;
            window.exportBackupAsText = exportBackupAsText;
            window.calculateBarrelVolume = calcBarrelVolume;
            window.showCalculator = showCalculator;
            window.liqr_calc = liqr_calc;


            // ===== Globale Sichtbarkeit f√ºr alle HTML-Aufrufe =====
            window.calculate = calculate;
            window.calculateDilution = calculateDilution;
            window.calculateCorrection = calculateCorrection;
            window.updateFruits = updateFruits;
            window.selectBarrelFromDropdown = selectBarrelFromDropdown;
            window.saveBarrel = saveBarrel;
            window.deleteBarrel = deleteBarrel;
            window.showProtocol = showProtocol;
            window.saveProtocolEntry = saveProtocolEntry;
            window.deleteEntry = deleteEntry;
            window.exportBackup = exportBackup;
            window.importBackup = importBackup;
            window.exportBackupAsText = exportBackupAsText;
            window.calculateBarrelVolume = calcBarrelVolume;
            window.showCalculator = showCalculator;
            window.liqr_calc = liqr_calc;
            window.loadCalcFromBarrel = loadCalcFromBarrel; // üëà neu hinzugef√ºgt
            window.calculateCalc = calculateCalc;
            window.calculateBatchCalc = calculateBatchCalc;
            window.liqr_inputChanged = liqr_inputChanged;
            window.calcBarrelVolume = calcBarrelVolume;
            ;

        </script>


        <!-- üíß Modal: Wasserzugabe / Verd√ºnnung -->
        <div id="waterModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
        background:#fff;
        border-radius:12px;
        padding:20px;
        width:300px;
        box-shadow:0 4px 12px rgba(0, 0, 0, 0.3);
        z-index:2000;
        ">

            <h3>Verd√ºnnung auf Trinkst√§rke</h3>
            <label for="targetVolPercent">Ziel-%vol:</label>
            <input type="number" id="targetVolPercent" placeholder="z. B. 40" oninput="updateWaterCalculation()"
                style="width:100%; margin-bottom:10px;">


            <div id="waterCalcResult" style="margin-bottom:10px; font-size:0.9em; color:#333;"></div>
            <div style="text-align:right;"><button onclick="confirmAddWater()">‚úÖ Wasser hinzuf√ºgen</button><button
                    onclick="cancelWaterModal()">Abbrechen</button></div>
        </div>





        <script>
            const oimlCSV = `
    temperature,vol_percent,alc20
    0,13.5,16.8
    0,14.0,17.5
    0,14.5,18.2
    0,15.0,19.0
    0,15.5,19.8
    0,16.0,20.6
    0,16.5,21.3
    0,17.0,22.1
    0,17.5,22.9
    0,18.0,23.7
    0,18.5,24.4
    0,19.0,25.2
    0,19.5,25.9
    0,20.0,26.6
    0,20.5,27.4
    0,21.0,28.0
    0,21.5,28.7
    0,22.0,29.4
    0,22.5,30.0
    0,23.0,30.7
    0,23.5,31.3
    0,24.0,31.9
    0,24.5,32.5
    0,25.0,33.1
    0,25.5,33.6
    0,26.0,34.2
    0,26.5,34.8
    0,27.0,35.3
    0,27.5,35.8
    0,28.0,36.4
    0,28.5,36.9
    0,29.0,37.4
    0,29.5,37.9
    0,30.0,38.4
    0,30.5,38.9
    0,31.0,39.4
    0,31.5,39.9
    0,32.0,40.4
    0,32.5,40.8
    0,33.0,41.3
    0,33.5,41.8
    0,34.0,42.3
    0,34.5,42.7
    0,35.0,43.2
    0,35.5,43.7
    0,36.0,44.2
    0,36.5,44.6
    0,37.0,45.1
    0,37.5,45.6
    0,38.0,46.0
    0,38.5,46.5
    0,39.0,46.9
    0,39.5,47.4
    0,40.0,47.9
    0,40.5,48.3
    0,41.0,48.8
    0,41.5,49.3
    0,42.0,49.7
    0,42.5,50.2
    0,43.0,50.7
    0,43.5,51.1
    0,44.0,51.6
    0,44.5,52.0
    0,45.0,52.5
    0,45.5,53.0
    0,46.0,53.4
    0,46.5,53.9
    0,47.0,54.4
    0,47.5,54.9
    0,48.0,55.3
    0,48.5,55.8
    0,49.0,56.3
    0,49.5,56.7
    0,50.0,57.2
    0,50.5,57.7
    0,51.0,58.1
    0,51.5,58.6
    0,52.0,59.1
    0,52.5,59.6
    0,53.0,60.0
    0,53.5,60.5
    0,54.0,61.0
    0,54.5,61.5
    0,55.0,61.9
    0,55.5,62.4
    0,56.0,62.9
    0,56.5,63.4
    0,57.0,63.9
    0,57.5,64.3
    0,58.0,64.8
    0,58.5,65.3
    0,59.0,65.8
    0,59.5,66.2
    0,60.0,66.7
    0,60.5,67.2
    0,61.0,67.7
    0,61.5,68.1
    0,62.0,68.6
    0,62.5,69.1
    0,63.0,69.6
    0,63.5,70.1
    0,64.0,70.5
    0,64.5,71.0
    0,65.0,71.5
    0,65.5,72.0
    0,66.0,72.4
    0,66.5,72.9
    0,67.0,73.4
    0,67.5,73.9
    0,68.0,74.3
    0,68.5,74.8
    0,69.0,75.3
    0,69.5,75.8
    0,70.0,76.3
    0,70.5,76.7
    0,71.0,77.2
    0,71.5,77.7
    0,72.0,78.2
    0,72.5,78.6
    0,73.0,79.1
    0,73.5,79.6
    0,74.0,80.0
    0,74.5,80.5
    0,75.0,81.0
    0,75.5,81.5
    0,76.0,81.9
    0,76.5,82.4
    0,77.0,82.9
    0,77.5,83.3
    0,78.0,83.8
    0,78.5,84.3
    0,79.0,84.8
    0,79.5,85.2
    0,80.0,85.7
    0,80.5,86.2
    0,81.0,86.6
    0,81.5,87.1
    0,82.0,87.5
    0,82.5,88.0
    0,83.0,88.5
    0,83.5,88.9
    0,84.0,89.4
    0,84.5,89.8
    0,85.0,90.3
    0,85.5,90.7
    0,86.0,91.2
    0,86.5,91.6
    0,87.0,92.1
    0,87.5,92.5
    0,88.0,93.0
    0,88.5,93.4
    0,89.0,93.8
    0,89.5,94.3
    0,90.0,94.7
    0,90.5,95.1
    0,91.0,95.6
    0,91.5,96.0
    0,92.0,96.4
    0,92.5,96.8
    0,93.0,97.3
    0,93.5,97.7
    0,94.0,98.1
    1,13.5,16.7
    1,14.0,17.4
    1,14.5,18.1
    1,15.0,18.9
    1,15.5,19.6
    1,16.0,20.4
    1,16.5,21.1
    1,17.0,21.9
    1,17.5,22.6
    1,18.0,23.4
    1,18.5,24.1
    1,19.0,24.8
    1,19.5,25.6
    1,20.0,26.3
    1,20.5,27.0
    1,21.0,27.6
    1,21.5,28.3
    1,22.0,29.0
    1,22.5,29.6
    1,23.0,30.2
    1,23.5,30.9
    1,24.0,31.5
    1,24.5,32.0
    1,25.0,32.6
    1,25.5,33.2
    1,26.0,33.8
    1,26.5,34.3
    1,27.0,34.9
    1,27.5,35.4
    1,28.0,35.9
    1,28.5,36.4
    1,29.0,36.9
    1,29.5,37.5
    1,30.0,38.0
    1,30.5,38.5
    1,31.0,39.0
    1,31.5,39.4
    1,32.0,39.9
    1,32.5,40.4
    1,33.0,40.9
    1,33.5,41.4
    1,34.0,41.9
    1,34.5,42.3
    1,35.0,42.8
    1,35.5,43.3
    1,36.0,43.8
    1,36.5,44.2
    1,37.0,44.7
    1,37.5,45.2
    1,38.0,45.6
    1,38.5,46.1
    1,39.0,46.6
    1,39.5,47.0
    1,40.0,47.5
    1,40.5,48.0
    1,41.0,48.4
    1,41.5,48.9
    1,42.0,49.3
    1,42.5,49.8
    1,43.0,50.3
    1,43.5,50.7
    1,44.0,51.2
    1,44.5,51.7
    1,45.0,52.2
    1,45.5,52.6
    1,46.0,53.1
    1,46.5,53.6
    1,47.0,54.0
    1,47.5,54.5
    1,48.0,55.0
    1,48.5,55.4
    1,49.0,55.9
    1,49.5,56.4
    1,50.0,56.9
    1,50.5,57.3
    1,51.0,57.8
    1,51.5,58.3
    1,52.0,58.8
    1,52.5,59.2
    1,53.0,59.7
    1,53.5,60.2
    1,54.0,60.7
    1,54.5,61.1
    1,55.0,61.6
    1,55.5,62.1
    1,56.0,62.6
    1,56.5,63.0
    1,57.0,63.5
    1,57.5,64.0
    1,58.0,64.5
    1,58.5,65.0
    1,59.0,65.4
    1,59.5,65.9
    1,60.0,66.4
    1,60.5,66.9
    1,61.0,67.4
    1,61.5,67.8
    1,62.0,68.3
    1,62.5,68.8
    1,63.0,69.3
    1,63.5,69.7
    1,64.0,70.2
    1,64.5,70.7
    1,65.0,71.2
    1,65.5,71.7
    1,66.0,72.1
    1,66.5,72.6
    1,67.0,73.1
    1,67.5,73.6
    1,68.0,74.0
    1,68.5,74.5
    1,69.0,75.0
    1,69.5,75.5
    1,70.0,76.0
    1,70.5,76.4
    1,71.0,76.9
    1,71.5,77.4
    1,72.0,77.9
    1,72.5,78.3
    1,73.0,78.8
    1,73.5,79.3
    1,74.0,79.8
    1,74.5,80.2
    1,75.0,80.7
    1,75.5,81.2
    1,76.0,81.7
    1,76.5,82.1
    1,77.0,82.6
    1,77.5,83.1
    1,78.0,83.5
    1,78.5,84.0
    1,79.0,84.5
    1,79.5,85.0
    1,80.0,85.4
    1,80.5,85.9
    1,81.0,86.4
    1,81.5,86.8
    1,82.0,87.3
    1,82.5,87.7
    1,83.0,88.2
    1,83.5,88.7
    1,84.0,89.1
    1,84.5,89.6
    1,85.0,90.0
    1,85.5,90.5
    1,86.0,90.9
    1,86.5,91.4
    1,87.0,91.8
    1,87.5,92.3
    1,88.0,92.7
    1,88.5,93.2
    1,89.0,93.6
    1,89.5,94.1
    1,90.0,94.5
    1,90.5,94.9
    1,91.0,95.4
    1,91.5,95.8
    1,92.0,96.2
    1,92.5,96.6
    1,93.0,97.1
    1,93.5,97.5
    1,94.0,97.9
    2,13.5,16.6
    2,14.0,17.3
    2,14.5,18.0
    2,15.0,18.7
    2,15.5,19.4
    2,16.0,20.2
    2,16.5,20.9
    2,17.0,21.6
    2,17.5,22.3
    2,18.0,23.1
    2,18.5,23.8
    2,19.0,24.5
    2,19.5,25.2
    2,20.0,25.9
    2,20.5,26.6
    2,21.0,27.2
    2,21.5,27.9
    2,22.0,28.6
    2,22.5,29.2
    2,23.0,29.8
    2,23.5,30.4
    2,24.0,31.0
    2,24.5,31.6
    2,25.0,32.2
    2,25.5,32.8
    2,26.0,33.3
    2,26.5,33.9
    2,27.0,34.4
    2,27.5,34.9
    2,28.0,35.5
    2,28.5,36.0
    2,29.0,36.5
    2,29.5,37.0
    2,30.0,37.5
    2,30.5,38.0
    2,31.0,38.5
    2,31.5,39.0
    2,32.0,39.5
    2,32.5,40.0
    2,33.0,40.5
    2,33.5,41.0
    2,34.0,41.4
    2,34.5,41.9
    2,35.0,42.4
    2,35.5,42.9
    2,36.0,43.3
    2,36.5,43.8
    2,37.0,44.3
    2,37.5,44.8
    2,38.0,45.2
    2,38.5,45.7
    2,39.0,46.2
    2,39.5,46.6
    2,40.0,47.1
    2,40.5,47.6
    2,41.0,48.0
    2,41.5,48.5
    2,42.0,49.0
    2,42.5,49.4
    2,43.0,49.9
    2,43.5,50.4
    2,44.0,50.8
    2,44.5,51.3
    2,45.0,51.8
    2,45.5,52.3
    2,46.0,52.7
    2,46.5,53.2
    2,47.0,53.7
    2,47.5,54.1
    2,48.0,54.6
    2,48.5,55.1
    2,49.0,55.6
    2,49.5,56.0
    2,50.0,56.5
    2,50.5,57.0
    2,51.0,57.5
    2,51.5,57.9
    2,52.0,58.4
    2,52.5,58.9
    2,53.0,59.4
    2,53.5,59.8
    2,54.0,60.3
    2,54.5,60.8
    2,55.0,61.3
    2,55.5,61.8
    2,56.0,62.2
    2,56.5,62.7
    2,57.0,63.2
    2,57.5,63.7
    2,58.0,64.1
    2,58.5,64.6
    2,59.0,65.1
    2,59.5,65.6
    2,60.0,66.1
    2,60.5,66.5
    2,61.0,67.0
    2,61.5,67.5
    2,62.0,68.0
    2,62.5,68.5
    2,63.0,68.9
    2,63.5,69.4
    2,64.0,69.9
    2,64.5,70.4
    2,65.0,70.9
    2,65.5,71.3
    2,66.0,71.8
    2,66.5,72.3
    2,67.0,72.8
    2,67.5,73.3
    2,68.0,73.7
    2,68.5,74.2
    2,69.0,74.7
    2,69.5,75.2
    2,70.0,75.6
    2,70.5,76.1
    2,71.0,76.6
    2,71.5,77.1
    2,72.0,77.6
    2,72.5,78.0
    2,73.0,78.5
    2,73.5,79.0
    2,74.0,79.5
    2,74.5,79.9
    2,75.0,80.4
    2,75.5,80.9
    2,76.0,81.4
    2,76.5,81.8
    2,77.0,82.3
    2,77.5,82.8
    2,78.0,83.3
    2,78.5,83.7
    2,79.0,84.2
    2,79.5,84.7
    2,80.0,85.1
    2,80.5,85.6
    2,81.0,86.1
    2,81.5,86.6
    2,82.0,87.0
    2,82.5,87.5
    2,83.0,87.9
    2,83.5,88.4
    2,84.0,88.9
    2,84.5,89.3
    2,85.0,89.8
    2,85.5,90.2
    2,86.0,90.7
    2,86.5,91.2
    2,87.0,91.6
    2,87.5,92.1
    2,88.0,92.5
    2,88.5,92.9
    2,89.0,93.4
    2,89.5,93.8
    2,90.0,94.3
    2,90.5,94.7
    2,91.0,95.1
    2,91.5,95.6
    2,92.0,96.0
    2,92.5,96.4
    2,93.0,96.9
    2,93.5,97.3
    2,94.0,97.7
    3,13.5,16.5
    3,14.0,17.2
    3,14.5,17.8
    3,15.0,18.5
    3,15.5,19.2
    3,16.0,20.0
    3,16.5,20.7
    3,17.0,21.4
    3,17.5,22.1
    3,18.0,22.8
    3,18.5,23.5
    3,19.0,24.2
    3,19.5,24.9
    3,20.0,25.5
    3,20.5,26.2
    3,21.0,26.9
    3,21.5,27.5
    3,22.0,28.1
    3,22.5,28.8
    3,23.0,29.4
    3,23.5,30.0
    3,24.0,30.6
    3,24.5,31.2
    3,25.0,31.7
    3,25.5,32.3
    3,26.0,32.9
    3,26.5,33.4
    3,27.0,34.0
    3,27.5,34.5
    3,28.0,35.0
    3,28.5,35.6
    3,29.0,36.1
    3,29.5,36.6
    3,30.0,37.1
    3,30.5,37.6
    3,31.0,38.1
    3,31.5,38.6
    3,32.0,39.1
    3,32.5,39.6
    3,33.0,40.1
    3,33.5,40.5
    3,34.0,41.0
    3,34.5,41.5
    3,35.0,42.0
    3,35.5,42.5
    3,36.0,42.9
    3,36.5,43.4
    3,37.0,43.9
    3,37.5,44.4
    3,38.0,44.8
    3,38.5,45.3
    3,39.0,45.8
    3,39.5,46.2
    3,40.0,46.7
    3,40.5,47.2
    3,41.0,47.7
    3,41.5,48.1
    3,42.0,48.6
    3,42.5,49.1
    3,43.0,49.5
    3,43.5,50.0
    3,44.0,50.5
    3,44.5,50.9
    3,45.0,51.4
    3,45.5,51.9
    3,46.0,52.4
    3,46.5,52.8
    3,47.0,53.3
    3,47.5,53.8
    3,48.0,54.3
    3,48.5,54.7
    3,49.0,55.2
    3,49.5,55.7
    3,50.0,56.2
    3,50.5,56.6
    3,51.0,57.1
    3,51.5,57.6
    3,52.0,58.1
    3,52.5,58.5
    3,53.0,59.0
    3,53.5,59.5
    3,54.0,60.0
    3,54.5,60.5
    3,55.0,60.9
    3,55.5,61.4
    3,56.0,61.9
    3,56.5,62.4
    3,57.0,62.9
    3,57.5,63.3
    3,58.0,63.8
    3,58.5,64.3
    3,59.0,64.8
    3,59.5,65.3
    3,60.0,65.7
    3,60.5,66.2
    3,61.0,66.7
    3,61.5,67.2
    3,62.0,67.7
    3,62.5,68.1
    3,63.0,68.6
    3,63.5,69.1
    3,64.0,69.6
    3,64.5,70.1
    3,65.0,70.5
    3,65.5,71.0
    3,66.0,71.5
    3,66.5,72.0
    3,67.0,72.5
    3,67.5,72.9
    3,68.0,73.4
    3,68.5,73.9
    3,69.0,74.4
    3,69.5,74.9
    3,70.0,75.3
    3,70.5,75.8
    3,71.0,76.3
    3,71.5,76.8
    3,72.0,77.3
    3,72.5,77.7
    3,73.0,78.2
    3,73.5,78.7
    3,74.0,79.2
    3,74.5,79.7
    3,75.0,80.1
    3,75.5,80.6
    3,76.0,81.1
    3,76.5,81.6
    3,77.0,82.0
    3,77.5,82.5
    3,78.0,83.0
    3,78.5,83.5
    3,79.0,83.9
    3,79.5,84.4
    3,80.0,84.9
    3,80.5,85.3
    3,81.0,85.8
    3,81.5,86.3
    3,82.0,86.8
    3,82.5,87.2
    3,83.0,87.7
    3,83.5,88.2
    3,84.0,88.6
    3,84.5,89.1
    3,85.0,89.5
    3,85.5,90.0
    3,86.0,90.5
    3,86.5,90.9
    3,87.0,91.4
    3,87.5,91.8
    3,88.0,92.3
    3,88.5,92.7
    3,89.0,93.2
    3,89.5,93.6
    3,90.0,94.1
    3,90.5,94.5
    3,91.0,94.9
    3,91.5,95.4
    3,92.0,95.8
    3,92.5,96.2
    3,93.0,96.7
    3,93.5,97.1
    3,94.0,97.5
    4,13.5,16.4
    4,14.0,17.0
    4,14.5,17.7
    4,15.0,18.4
    4,15.5,19.1
    4,16.0,19.7
    4,16.5,20.4
    4,17.0,21.1
    4,17.5,21.8
    4,18.0,22.5
    4,18.5,23.2
    4,19.0,23.8
    4,19.5,24.5
    4,20.0,25.2
    4,20.5,25.8
    4,21.0,26.5
    4,21.5,27.1
    4,22.0,27.7
    4,22.5,28.4
    4,23.0,29.0
    4,23.5,29.6
    4,24.0,30.2
    4,24.5,30.7
    4,25.0,31.3
    4,25.5,31.9
    4,26.0,32.4
    4,26.5,33.0
    4,27.0,33.5
    4,27.5,34.1
    4,28.0,34.6
    4,28.5,35.1
    4,29.0,35.6
    4,29.5,36.2
    4,30.0,36.7
    4,30.5,37.2
    4,31.0,37.7
    4,31.5,38.2
    4,32.0,38.7
    4,32.5,39.2
    4,33.0,39.6
    4,33.5,40.1
    4,34.0,40.6
    4,34.5,41.1
    4,35.0,41.6
    4,35.5,42.1
    4,36.0,42.5
    4,36.5,43.0
    4,37.0,43.5
    4,37.5,44.0
    4,38.0,44.4
    4,38.5,44.9
    4,39.0,45.4
    4,39.5,45.9
    4,40.0,46.3
    4,40.5,46.8
    4,41.0,47.3
    4,41.5,47.7
    4,42.0,48.2
    4,42.5,48.7
    4,43.0,49.2
    4,43.5,49.6
    4,44.0,50.1
    4,44.5,50.6
    4,45.0,51.1
    4,45.5,51.5
    4,46.0,52.0
    4,46.5,52.5
    4,47.0,52.9
    4,47.5,53.4
    4,48.0,53.9
    4,48.5,54.4
    4,49.0,54.9
    4,49.5,55.3
    4,50.0,55.8
    4,50.5,56.3
    4,51.0,56.8
    4,51.5,57.2
    4,52.0,57.7
    4,52.5,58.2
    4,53.0,58.7
    4,53.5,59.2
    4,54.0,59.6
    4,54.5,60.1
    4,55.0,60.6
    4,55.5,61.1
    4,56.0,61.6
    4,56.5,62.0
    4,57.0,62.5
    4,57.5,63.0
    4,58.0,63.5
    4,58.5,64.0
    4,59.0,64.4
    4,59.5,64.9
    4,60.0,65.4
    4,60.5,65.9
    4,61.0,66.4
    4,61.5,66.9
    4,62.0,67.3
    4,62.5,67.8
    4,63.0,68.3
    4,63.5,68.8
    4,64.0,69.3
    4,64.5,69.8
    4,65.0,70.2
    4,65.5,70.7
    4,66.0,71.2
    4,66.5,71.7
    4,67.0,72.2
    4,67.5,72.6
    4,68.0,73.1
    4,68.5,73.6
    4,69.0,74.1
    4,69.5,74.6
    4,70.0,75.0
    4,70.5,75.5
    4,71.0,76.0
    4,71.5,76.5
    4,72.0,77.0
    4,72.5,77.4
    4,73.0,77.9
    4,73.5,78.4
    4,74.0,78.9
    4,74.5,79.4
    4,75.0,79.8
    4,75.5,80.3
    4,76.0,80.8
    4,76.5,81.3
    4,77.0,81.7
    4,77.5,82.2
    4,78.0,82.7
    4,78.5,83.2
    4,79.0,83.7
    4,79.5,84.1
    4,80.0,84.6
    4,80.5,85.1
    4,81.0,85.5
    4,81.5,86.0
    4,82.0,86.5
    4,82.5,87.0
    4,83.0,87.4
    4,83.5,87.9
    4,84.0,88.4
    4,84.5,88.8
    4,85.0,89.3
    4,85.5,89.7
    4,86.0,90.2
    4,86.5,90.7
    4,87.0,91.1
    4,87.5,91.6
    4,88.0,92.0
    4,88.5,92.5
    4,89.0,92.9
    4,89.5,93.4
    4,90.0,93.8
    4,90.5,94.3
    4,91.0,94.7
    4,91.5,95.2
    4,92.0,95.6
    4,92.5,96.0
    4,93.0,96.5
    4,93.5,96.9
    4,94.0,97.3
    5,13.5,16.2
    5,14.0,16.9
    5,14.5,17.5
    5,15.0,18.2
    5,15.5,18.9
    5,16.0,19.5
    5,16.5,20.2
    5,17.0,20.9
    5,17.5,21.5
    5,18.0,22.2
    5,18.5,22.9
    5,19.0,23.5
    5,19.5,24.2
    5,20.0,24.8
    5,20.5,25.5
    5,21.0,26.1
    5,21.5,26.7
    5,22.0,27.3
    5,22.5,28.0
    5,23.0,28.6
    5,23.5,29.2
    5,24.0,29.7
    5,24.5,30.3
    5,25.0,30.9
    5,25.5,31.4
    5,26.0,32.0
    5,26.5,32.6
    5,27.0,33.1
    5,27.5,33.6
    5,28.0,34.2
    5,28.5,34.7
    5,29.0,35.2
    5,29.5,35.7
    5,30.0,36.2
    5,30.5,36.7
    5,31.0,37.2
    5,31.5,37.7
    5,32.0,38.2
    5,32.5,38.7
    5,33.0,39.2
    5,33.5,39.7
    5,34.0,40.2
    5,34.5,40.7
    5,35.0,41.2
    5,35.5,41.6
    5,36.0,42.1
    5,36.5,42.6
    5,37.0,43.1
    5,37.5,43.6
    5,38.0,44.0
    5,38.5,44.5
    5,39.0,45.0
    5,39.5,45.5
    5,40.0,45.9
    5,40.5,46.4
    5,41.0,46.9
    5,41.5,47.4
    5,42.0,47.8
    5,42.5,48.3
    5,43.0,48.8
    5,43.5,49.3
    5,44.0,49.7
    5,44.5,50.2
    5,45.0,50.7
    5,45.5,51.2
    5,46.0,51.6
    5,46.5,52.1
    5,47.0,52.6
    5,47.5,53.1
    5,48.0,53.5
    5,48.5,54.0
    5,49.0,54.5
    5,49.5,55.0
    5,50.0,55.5
    5,50.5,55.9
    5,51.0,56.4
    5,51.5,56.9
    5,52.0,57.4
    5,52.5,57.9
    5,53.0,58.3
    5,53.5,58.8
    5,54.0,59.3
    5,54.5,59.8
    5,55.0,60.3
    5,55.5,60.7
    5,56.0,61.2
    5,56.5,61.7
    5,57.0,62.2
    5,57.5,62.7
    5,58.0,63.2
    5,58.5,63.6
    5,59.0,64.1
    5,59.5,64.6
    5,60.0,65.1
    5,60.5,65.6
    5,61.0,66.1
    5,61.5,66.5
    5,62.0,67.0
    5,62.5,67.5
    5,63.0,68.0
    5,63.5,68.5
    5,64.0,68.9
    5,64.5,69.4
    5,65.0,69.9
    5,65.5,70.4
    5,66.0,70.9
    5,66.5,71.4
    5,67.0,71.8
    5,67.5,72.3
    5,68.0,72.8
    5,68.5,73.3
    5,69.0,73.8
    5,69.5,74.3
    5,70.0,74.7
    5,70.5,75.2
    5,71.0,75.7
    5,71.5,76.2
    5,72.0,76.7
    5,72.5,77.1
    5,73.0,77.6
    5,73.5,78.1
    5,74.0,78.6
    5,74.5,79.1
    5,75.0,79.5
    5,75.5,80.0
    5,76.0,80.5
    5,76.5,81.0
    5,77.0,81.5
    5,77.5,81.9
    5,78.0,82.4
    5,78.5,82.9
    5,79.0,83.4
    5,79.5,83.8
    5,80.0,84.3
    5,80.5,84.8
    5,81.0,85.3
    5,81.5,85.7
    5,82.0,86.2
    5,82.5,86.7
    5,83.0,87.2
    5,83.5,87.6
    5,84.0,88.1
    5,84.5,88.6
    5,85.0,89.0
    5,85.5,89.5
    5,86.0,90.0
    5,86.5,90.4
    5,87.0,90.9
    5,87.5,91.3
    5,88.0,91.8
    5,88.5,92.3
    5,89.0,92.7
    5,89.5,93.2
    5,90.0,93.6
    5,90.5,94.1
    5,91.0,94.5
    5,91.5,94.9
    5,92.0,95.4
    5,92.5,95.8
    5,93.0,96.3
    5,93.5,96.7
    5,94.0,97.1
    6,13.5,16.1
    6,14.0,16.7
    6,14.5,17.4
    6,15.0,18.0
    6,15.5,18.7
    6,16.0,19.3
    6,16.5,20.0
    6,17.0,20.6
    6,17.5,21.3
    6,18.0,21.9
    6,18.5,22.6
    6,19.0,23.2
    6,19.5,23.9
    6,20.0,24.5
    6,20.5,25.1
    6,21.0,25.7
    6,21.5,26.4
    6,22.0,27.0
    6,22.5,27.6
    6,23.0,28.2
    6,23.5,28.7
    6,24.0,29.3
    6,24.5,29.9
    6,25.0,30.5
    6,25.5,31.0
    6,26.0,31.6
    6,26.5,32.1
    6,27.0,32.7
    6,27.5,33.2
    6,28.0,33.7
    6,28.5,34.3
    6,29.0,34.8
    6,29.5,35.3
    6,30.0,35.8
    6,30.5,36.3
    6,31.0,36.8
    6,31.5,37.3
    6,32.0,37.8
    6,32.5,38.3
    6,33.0,38.8
    6,33.5,39.3
    6,34.0,39.8
    6,34.5,40.3
    6,35.0,40.8
    6,35.5,41.2
    6,36.0,41.7
    6,36.5,42.2
    6,37.0,42.7
    6,37.5,43.2
    6,38.0,43.6
    6,38.5,44.1
    6,39.0,44.6
    6,39.5,45.1
    6,40.0,45.5
    6,40.5,46.0
    6,41.0,46.5
    6,41.5,47.0
    6,42.0,47.5
    6,42.5,47.9
    6,43.0,48.4
    6,43.5,48.9
    6,44.0,49.4
    6,44.5,49.8
    6,45.0,50.3
    6,45.5,50.8
    6,46.0,51.3
    6,46.5,51.7
    6,47.0,52.2
    6,47.5,52.7
    6,48.0,53.2
    6,48.5,53.7
    6,49.0,54.1
    6,49.5,54.6
    6,50.0,55.1
    6,50.5,55.6
    6,51.0,56.1
    6,51.5,56.5
    6,52.0,57.0
    6,52.5,57.5
    6,53.0,58.0
    6,53.5,58.5
    6,54.0,59.0
    6,54.5,59.4
    6,55.0,59.9
    6,55.5,60.4
    6,56.0,60.9
    6,56.5,61.4
    6,57.0,61.9
    6,57.5,62.3
    6,58.0,62.8
    6,58.5,63.3
    6,59.0,63.8
    6,59.5,64.3
    6,60.0,64.8
    6,60.5,65.2
    6,61.0,65.7
    6,61.5,66.2
    6,62.0,66.7
    6,62.5,67.2
    6,63.0,67.7
    6,63.5,68.1
    6,64.0,68.6
    6,64.5,69.1
    6,65.0,69.6
    6,65.5,70.1
    6,66.0,70.6
    6,66.5,71.0
    6,67.0,71.5
    6,67.5,72.0
    6,68.0,72.5
    6,68.5,73.0
    6,69.0,73.5
    6,69.5,73.9
    6,70.0,74.4
    6,70.5,74.9
    6,71.0,75.4
    6,71.5,75.9
    6,72.0,76.4
    6,72.5,76.8
    6,73.0,77.3
    6,73.5,77.8
    6,74.0,78.3
    6,74.5,78.8
    6,75.0,79.3
    6,75.5,79.7
    6,76.0,80.2
    6,76.5,80.7
    6,77.0,81.2
    6,77.5,81.7
    6,78.0,82.1
    6,78.5,82.6
    6,79.0,83.1
    6,79.5,83.6
    6,80.0,84.0
    6,80.5,84.5
    6,81.0,85.0
    6,81.5,85.5
    6,82.0,85.9
    6,82.5,86.4
    6,83.0,86.9
    6,83.5,87.4
    6,84.0,87.8
    6,84.5,88.3
    6,85.0,88.8
    6,85.5,89.2
    6,86.0,89.7
    6,86.5,90.2
    6,87.0,90.6
    6,87.5,91.1
    6,88.0,91.6
    6,88.5,92.0
    6,89.0,92.5
    6,89.5,92.9
    6,90.0,93.4
    6,90.5,93.8
    6,91.0,94.3
    6,91.5,94.7
    6,92.0,95.2
    6,92.5,95.6
    6,93.0,96.1
    6,93.5,96.5
    6,94.0,97.0
    7,13.5,16.0
    7,14.0,16.6
    7,14.5,17.2
    7,15.0,17.8
    7,15.5,18.5
    7,16.0,19.1
    7,16.5,19.7
    7,17.0,20.4
    7,17.5,21.0
    7,18.0,21.6
    7,18.5,22.3
    7,19.0,22.9
    7,19.5,23.5
    7,20.0,24.1
    7,20.5,24.8
    7,21.0,25.4
    7,21.5,26.0
    7,22.0,26.6
    7,22.5,27.2
    7,23.0,27.8
    7,23.5,28.3
    7,24.0,28.9
    7,24.5,29.5
    7,25.0,30.0
    7,25.5,30.6
    7,26.0,31.2
    7,26.5,31.7
    7,27.0,32.2
    7,27.5,32.8
    7,28.0,33.3
    7,28.5,33.8
    7,29.0,34.3
    7,29.5,34.9
    7,30.0,35.4
    7,30.5,35.9
    7,31.0,36.4
    7,31.5,36.9
    7,32.0,37.4
    7,32.5,37.9
    7,33.0,38.4
    7,33.5,38.9
    7,34.0,39.4
    7,34.5,39.9
    7,35.0,40.3
    7,35.5,40.8
    7,36.0,41.3
    7,36.5,41.8
    7,37.0,42.3
    7,37.5,42.8
    7,38.0,43.2
    7,38.5,43.7
    7,39.0,44.2
    7,39.5,44.7
    7,40.0,45.2
    7,40.5,45.6
    7,41.0,46.1
    7,41.5,46.6
    7,42.0,47.1
    7,42.5,47.5
    7,43.0,48.0
    7,43.5,48.5
    7,44.0,49.0
    7,44.5,49.5
    7,45.0,49.9
    7,45.5,50.4
    7,46.0,50.9
    7,46.5,51.4
    7,47.0,51.9
    7,47.5,52.3
    7,48.0,52.8
    7,48.5,53.3
    7,49.0,53.8
    7,49.5,54.3
    7,50.0,54.7
    7,50.5,55.2
    7,51.0,55.7
    7,51.5,56.2
    7,52.0,56.7
    7,52.5,57.2
    7,53.0,57.6
    7,53.5,58.1
    7,54.0,58.6
    7,54.5,59.1
    7,55.0,59.6
    7,55.5,60.1
    7,56.0,60.5
    7,56.5,61.0
    7,57.0,61.5
    7,57.5,62.0
    7,58.0,62.5
    7,58.5,63.0
    7,59.0,63.5
    7,59.5,63.9
    7,60.0,64.4
    7,60.5,64.9
    7,61.0,65.4
    7,61.5,65.9
    7,62.0,66.4
    7,62.5,66.9
    7,63.0,67.3
    7,63.5,67.8
    7,64.0,68.3
    7,64.5,68.8
    7,65.0,69.3
    7,65.5,69.8
    7,66.0,70.2
    7,66.5,70.7
    7,67.0,71.2
    7,67.5,71.7
    7,68.0,72.2
    7,68.5,72.7
    7,69.0,73.2
    7,69.5,73.6
    7,70.0,74.1
    7,70.5,74.6
    7,71.0,75.1
    7,71.5,75.6
    7,72.0,76.1
    7,72.5,76.5
    7,73.0,77.0
    7,73.5,77.5
    7,74.0,78.0
    7,74.5,78.5
    7,75.0,79.0
    7,75.5,79.4
    7,76.0,79.9
    7,76.5,80.4
    7,77.0,80.9
    7,77.5,81.4
    7,78.0,81.8
    7,78.5,82.3
    7,79.0,82.8
    7,79.5,83.3
    7,80.0,83.8
    7,80.5,84.2
    7,81.0,84.7
    7,81.5,85.2
    7,82.0,85.7
    7,82.5,86.2
    7,83.0,86.6
    7,83.5,87.1
    7,84.0,87.6
    7,84.5,88.0
    7,85.0,88.5
    7,85.5,89.0
    7,86.0,89.5
    7,86.5,89.9
    7,87.0,90.4
    7,87.5,90.9
    7,88.0,91.3
    7,88.5,91.8
    7,89.0,92.2
    7,89.5,92.7
    7,90.0,93.2
    7,90.5,93.6
    7,91.0,94.1
    7,91.5,94.5
    7,92.0,95.0
    7,92.5,95.4
    7,93.0,95.9
    7,93.5,96.3
    7,94.0,96.8
    8,13.5,15.8
    8,14.0,16.4
    8,14.5,17.0
    8,15.0,17.6
    8,15.5,18.3
    8,16.0,18.9
    8,16.5,19.5
    8,17.0,20.1
    8,17.5,20.7
    8,18.0,21.4
    8,18.5,22.0
    8,19.0,22.6
    8,19.5,23.2
    8,20.0,23.8
    8,20.5,24.4
    8,21.0,25.0
    8,21.5,25.6
    8,22.0,26.2
    8,22.5,26.8
    8,23.0,27.4
    8,23.5,27.9
    8,24.0,28.5
    8,24.5,29.1
    8,25.0,29.6
    8,25.5,30.2
    8,26.0,30.7
    8,26.5,31.3
    8,27.0,31.8
    8,27.5,32.3
    8,28.0,32.9
    8,28.5,33.4
    8,29.0,33.9
    8,29.5,34.4
    8,30.0,34.9
    8,30.5,35.5
    8,31.0,36.0
    8,31.5,36.5
    8,32.0,37.0
    8,32.5,37.5
    8,33.0,38.0
    8,33.5,38.5
    8,34.0,38.9
    8,34.5,39.4
    8,35.0,39.9
    8,35.5,40.4
    8,36.0,40.9
    8,36.5,41.4
    8,37.0,41.9
    8,37.5,42.4
    8,38.0,42.8
    8,38.5,43.3
    8,39.0,43.8
    8,39.5,44.3
    8,40.0,44.8
    8,40.5,45.2
    8,41.0,45.7
    8,41.5,46.2
    8,42.0,46.7
    8,42.5,47.2
    8,43.0,47.6
    8,43.5,48.1
    8,44.0,48.6
    8,44.5,49.1
    8,45.0,49.6
    8,45.5,50.0
    8,46.0,50.5
    8,46.5,51.0
    8,47.0,51.5
    8,47.5,52.0
    8,48.0,52.5
    8,48.5,52.9
    8,49.0,53.4
    8,49.5,53.9
    8,50.0,54.4
    8,50.5,54.9
    8,51.0,55.4
    8,51.5,55.8
    8,52.0,56.3
    8,52.5,56.8
    8,53.0,57.3
    8,53.5,57.8
    8,54.0,58.3
    8,54.5,58.7
    8,55.0,59.2
    8,55.5,59.7
    8,56.0,60.2
    8,56.5,60.7
    8,57.0,61.2
    8,57.5,61.7
    8,58.0,62.1
    8,58.5,62.6
    8,59.0,63.1
    8,59.5,63.6
    8,60.0,64.1
    8,60.5,64.6
    8,61.0,65.1
    8,61.5,65.6
    8,62.0,66.0
    8,62.5,66.5
    8,63.0,67.0
    8,63.5,67.5
    8,64.0,68.0
    8,64.5,68.5
    8,65.0,69.0
    8,65.5,69.4
    8,66.0,69.9
    8,66.5,70.4
    8,67.0,70.9
    8,67.5,71.4
    8,68.0,71.9
    8,68.5,72.4
    8,69.0,72.8
    8,69.5,73.3
    8,70.0,73.8
    8,70.5,74.3
    8,71.0,74.8
    8,71.5,75.3
    8,72.0,75.8
    8,72.5,76.2
    8,73.0,76.7
    8,73.5,77.2
    8,74.0,77.7
    8,74.5,78.2
    8,75.0,78.7
    8,75.5,79.1
    8,76.0,79.6
    8,76.5,80.1
    8,77.0,80.6
    8,77.5,81.1
    8,78.0,81.6
    8,78.5,82.0
    8,79.0,82.5
    8,79.5,83.0
    8,80.0,83.5
    8,80.5,84.0
    8,81.0,84.4
    8,81.5,84.9
    8,82.0,85.4
    8,82.5,85.9
    8,83.0,86.4
    8,83.5,86.8
    8,84.0,87.3
    8,84.5,87.8
    8,85.0,88.3
    8,85.5,88.7
    8,86.0,89.2
    8,86.5,89.7
    8,87.0,90.1
    8,87.5,90.6
    8,88.0,91.1
    8,88.5,91.5
    8,89.0,92.0
    8,89.5,92.5
    8,90.0,92.9
    8,90.5,93.4
    8,91.0,93.8
    8,91.5,94.3
    8,92.0,94.8
    8,92.5,95.2
    8,93.0,95.7
    8,93.5,96.1
    8,94.0,96.6
    9,13.5,15.6
    9,14.0,16.2
    9,14.5,16.8
    9,15.0,17.4
    9,15.5,18.0
    9,16.0,18.7
    9,16.5,19.3
    9,17.0,19.9
    9,17.5,20.5
    9,18.0,21.1
    9,18.5,21.7
    9,19.0,22.3
    9,19.5,22.9
    9,20.0,23.5
    9,20.5,24.1
    9,21.0,24.7
    9,21.5,25.3
    9,22.0,25.8
    9,22.5,26.4
    9,23.0,27.0
    9,23.5,27.6
    9,24.0,28.1
    9,24.5,28.7
    9,25.0,29.2
    9,25.5,29.8
    9,26.0,30.3
    9,26.5,30.9
    9,27.0,31.4
    9,27.5,31.9
    9,28.0,32.5
    9,28.5,33.0
    9,29.0,33.5
    9,29.5,34.0
    9,30.0,34.5
    9,30.5,35.0
    9,31.0,35.5
    9,31.5,36.0
    9,32.0,36.5
    9,32.5,37.0
    9,33.0,37.5
    9,33.5,38.0
    9,34.0,38.5
    9,34.5,39.0
    9,35.0,39.5
    9,35.5,40.0
    9,36.0,40.5
    9,36.5,41.0
    9,37.0,41.5
    9,37.5,42.0
    9,38.0,42.4
    9,38.5,42.9
    9,39.0,43.4
    9,39.5,43.9
    9,40.0,44.4
    9,40.5,44.9
    9,41.0,45.3
    9,41.5,45.8
    9,42.0,46.3
    9,42.5,46.8
    9,43.0,47.3
    9,43.5,47.7
    9,44.0,48.2
    9,44.5,48.7
    9,45.0,49.2
    9,45.5,49.7
    9,46.0,50.2
    9,46.5,50.6
    9,47.0,51.1
    9,47.5,51.6
    9,48.0,52.1
    9,48.5,52.6
    9,49.0,53.1
    9,49.5,53.5
    9,50.0,54.0
    9,50.5,54.5
    9,51.0,55.0
    9,51.5,55.5
    9,52.0,56.0
    9,52.5,56.5
    9,53.0,56.9
    9,53.5,57.4
    9,54.0,57.9
    9,54.5,58.4
    9,55.0,58.9
    9,55.5,59.4
    9,56.0,59.9
    9,56.5,60.3
    9,57.0,60.8
    9,57.5,61.3
    9,58.0,61.8
    9,58.5,62.3
    9,59.0,62.8
    9,59.5,63.3
    9,60.0,63.8
    9,60.5,64.2
    9,61.0,64.7
    9,61.5,65.2
    9,62.0,65.7
    9,62.5,66.2
    9,63.0,66.7
    9,63.5,67.2
    9,64.0,67.7
    9,64.5,68.1
    9,65.0,68.6
    9,65.5,69.1
    9,66.0,69.6
    9,66.5,70.1
    9,67.0,70.6
    9,67.5,71.1
    9,68.0,71.6
    9,68.5,72.0
    9,69.0,72.5
    9,69.5,73.0
    9,70.0,73.5
    9,70.5,74.0
    9,71.0,74.5
    9,71.5,75.0
    9,72.0,75.4
    9,72.5,75.9
    9,73.0,76.4
    9,73.5,76.9
    9,74.0,77.4
    9,74.5,77.9
    9,75.0,78.4
    9,75.5,78.8
    9,76.0,79.3
    9,76.5,79.8
    9,77.0,80.3
    9,77.5,80.8
    9,78.0,81.3
    9,78.5,81.8
    9,79.0,82.2
    9,79.5,82.7
    9,80.0,83.2
    9,80.5,83.7
    9,81.0,84.2
    9,81.5,84.6
    9,82.0,85.1
    9,82.5,85.6
    9,83.0,86.1
    9,83.5,86.6
    9,84.0,87.0
    9,84.5,87.5
    9,85.0,88.0
    9,85.5,88.5
    9,86.0,88.9
    9,86.5,89.4
    9,87.0,89.9
    9,87.5,90.4
    9,88.0,90.8
    9,88.5,91.3
    9,89.0,91.8
    9,89.5,92.2
    9,90.0,92.7
    9,90.5,93.2
    9,91.0,93.6
    9,91.5,94.1
    9,92.0,94.5
    9,92.5,95.0
    9,93.0,95.5
    9,93.5,95.9
    9,94.0,96.4
    10,13.5,15.5
    10,14.0,16.1
    10,14.5,16.7
    10,15.0,17.2
    10,15.5,17.8
    10,16.0,18.4
    10,16.5,19.0
    10,17.0,19.6
    10,17.5,20.2
    10,18.0,20.8
    10,18.5,21.4
    10,19.0,22.0
    10,19.5,22.6
    10,20.0,23.2
    10,20.5,23.7
    10,21.0,24.3
    10,21.5,24.9
    10,22.0,25.5
    10,22.5,26.0
    10,23.0,26.6
    10,23.5,27.2
    10,24.0,27.7
    10,24.5,28.3
    10,25.0,28.8
    10,25.5,29.4
    10,26.0,29.9
    10,26.5,30.4
    10,27.0,31.0
    10,27.5,31.5
    10,28.0,32.0
    10,28.5,32.6
    10,29.0,33.1
    10,29.5,33.6
    10,30.0,34.1
    10,30.5,34.6
    10,31.0,35.1
    10,31.5,35.6
    10,32.0,36.1
    10,32.5,36.6
    10,33.0,37.1
    10,33.5,37.6
    10,34.0,38.1
    10,34.5,38.6
    10,35.0,39.1
    10,35.5,39.6
    10,36.0,40.1
    10,36.5,40.6
    10,37.0,41.1
    10,37.5,41.5
    10,38.0,42.0
    10,38.5,42.5
    10,39.0,43.0
    10,39.5,43.5
    10,40.0,44.0
    10,40.5,44.5
    10,41.0,44.9
    10,41.5,45.4
    10,42.0,45.9
    10,42.5,46.4
    10,43.0,46.9
    10,43.5,47.4
    10,44.0,47.9
    10,44.5,48.3
    10,45.0,48.8
    10,45.5,49.3
    10,46.0,49.8
    10,46.5,50.3
    10,47.0,50.8
    10,47.5,51.2
    10,48.0,51.7
    10,48.5,52.2
    10,49.0,52.7
    10,49.5,53.2
    10,50.0,53.7
    10,50.5,54.2
    10,51.0,54.6
    10,51.5,55.1
    10,52.0,55.6
    10,52.5,56.1
    10,53.0,56.6
    10,53.5,57.1
    10,54.0,57.6
    10,54.5,58.1
    10,55.0,58.5
    10,55.5,59.0
    10,56.0,59.5
    10,56.5,60.0
    10,57.0,60.5
    10,57.5,61.0
    10,58.0,61.5
    10,58.5,62.0
    10,59.0,62.4
    10,59.5,62.9
    10,60.0,63.4
    10,60.5,63.9
    10,61.0,64.4
    10,61.5,64.9
    10,62.0,65.4
    10,62.5,65.9
    10,63.0,66.4
    10,63.5,66.8
    10,64.0,67.3
    10,64.5,67.8
    10,65.0,68.3
    10,65.5,68.8
    10,66.0,69.3
    10,66.5,69.8
    10,67.0,70.3
    10,67.5,70.8
    10,68.0,71.2
    10,68.5,71.7
    10,69.0,72.2
    10,69.5,72.7
    10,70.0,73.2
    10,70.5,73.7
    10,71.0,74.2
    10,71.5,74.7
    10,72.0,75.1
    10,72.5,75.6
    10,73.0,76.1
    10,73.5,76.6
    10,74.0,77.1
    10,74.5,77.6
    10,75.0,78.1
    10,75.5,78.5
    10,76.0,79.0
    10,76.5,79.5
    10,77.0,80.0
    10,77.5,80.5
    10,78.0,81.0
    10,78.5,81.5
    10,79.0,81.9
    10,79.5,82.4
    10,80.0,82.9
    10,80.5,83.4
    10,81.0,83.9
    10,81.5,84.4
    10,82.0,84.9
    10,82.5,85.3
    10,83.0,85.8
    10,83.5,86.3
    10,84.0,86.8
    10,84.5,87.3
    10,85.0,87.7
    10,85.5,88.2
    10,86.0,88.7
    10,86.5,89.2
    10,87.0,89.6
    10,87.5,90.1
    10,88.0,90.6
    10,88.5,91.1
    10,89.0,91.5
    10,89.5,92.0
    10,90.0,92.5
    10,90.5,92.9
    10,91.0,93.4
    10,91.5,93.9
    10,92.0,94.3
    10,92.5,94.8
    10,93.0,95.2
    10,93.5,95.7
    10,94.0,96.2
    11,13.5,15.3
    11,14.0,15.9
    11,14.5,16.5
    11,15.0,17.0
    11,15.5,17.6
    11,16.0,18.2
    11,16.5,18.8
    11,17.0,19.4
    11,17.5,19.9
    11,18.0,20.5
    11,18.5,21.1
    11,19.0,21.7
    11,19.5,22.3
    11,20.0,22.8
    11,20.5,23.4
    11,21.0,24.0
    11,21.5,24.5
    11,22.0,25.1
    11,22.5,25.7
    11,23.0,26.2
    11,23.5,26.8
    11,24.0,27.3
    11,24.5,27.9
    11,25.0,28.4
    11,25.5,29.0
    11,26.0,29.5
    11,26.5,30.0
    11,27.0,30.6
    11,27.5,31.1
    11,28.0,31.6
    11,28.5,32.1
    11,29.0,32.7
    11,29.5,33.2
    11,30.0,33.7
    11,30.5,34.2
    11,31.0,34.7
    11,31.5,35.2
    11,32.0,35.7
    11,32.5,36.2
    11,33.0,36.7
    11,33.5,37.2
    11,34.0,37.7
    11,34.5,38.2
    11,35.0,38.7
    11,35.5,39.2
    11,36.0,39.7
    11,36.5,40.2
    11,37.0,40.7
    11,37.5,41.1
    11,38.0,41.6
    11,38.5,42.1
    11,39.0,42.6
    11,39.5,43.1
    11,40.0,43.6
    11,40.5,44.1
    11,41.0,44.6
    11,41.5,45.0
    11,42.0,45.5
    11,42.5,46.0
    11,43.0,46.5
    11,43.5,47.0
    11,44.0,47.5
    11,44.5,48.0
    11,45.0,48.4
    11,45.5,48.9
    11,46.0,49.4
    11,46.5,49.9
    11,47.0,50.4
    11,47.5,50.9
    11,48.0,51.4
    11,48.5,51.8
    11,49.0,52.3
    11,49.5,52.8
    11,50.0,53.3
    11,50.5,53.8
    11,51.0,54.3
    11,51.5,54.8
    11,52.0,55.3
    11,52.5,55.7
    11,53.0,56.2
    11,53.5,56.7
    11,54.0,57.2
    11,54.5,57.7
    11,55.0,58.2
    11,55.5,58.7
    11,56.0,59.2
    11,56.5,59.7
    11,57.0,60.1
    11,57.5,60.6
    11,58.0,61.1
    11,58.5,61.6
    11,59.0,62.1
    11,59.5,62.6
    11,60.0,63.1
    11,60.5,63.6
    11,61.0,64.1
    11,61.5,64.6
    11,62.0,65.0
    11,62.5,65.5
    11,63.0,66.0
    11,63.5,66.5
    11,64.0,67.0
    11,64.5,67.5
    11,65.0,68.0
    11,65.5,68.5
    11,66.0,69.0
    11,66.5,69.5
    11,67.0,69.9
    11,67.5,70.4
    11,68.0,70.9
    11,68.5,71.4
    11,69.0,71.9
    11,69.5,72.4
    11,70.0,72.9
    11,70.5,73.4
    11,71.0,73.9
    11,71.5,74.3
    11,72.0,74.8
    11,72.5,75.3
    11,73.0,75.8
    11,73.5,76.3
    11,74.0,76.8
    11,74.5,77.3
    11,75.0,77.8
    11,75.5,78.3
    11,76.0,78.7
    11,76.5,79.2
    11,77.0,79.7
    11,77.5,80.2
    11,78.0,80.7
    11,78.5,81.2
    11,79.0,81.7
    11,79.5,82.1
    11,80.0,82.6
    11,80.5,83.1
    11,81.0,83.6
    11,81.5,84.1
    11,82.0,84.6
    11,82.5,85.1
    11,83.0,85.5
    11,83.5,86.0
    11,84.0,86.5
    11,84.5,87.0
    11,85.0,87.5
    11,85.5,87.9
    11,86.0,88.4
    11,86.5,88.9
    11,87.0,89.4
    11,87.5,89.9
    11,88.0,90.3
    11,88.5,90.8
    11,89.0,91.3
    11,89.5,91.7
    11,90.0,92.2
    11,90.5,92.7
    11,91.0,93.2
    11,91.5,93.6
    11,92.0,94.1
    11,92.5,94.6
    11,93.0,95.0
    11,93.5,95.5
    11,94.0,96.0
    12,13.5,15.1
    12,14.0,15.7
    12,14.5,16.3
    12,15.0,16.8
    12,15.5,17.4
    12,16.0,18.0
    12,16.5,18.5
    12,17.0,19.1
    12,17.5,19.7
    12,18.0,20.2
    12,18.5,20.8
    12,19.0,21.4
    12,19.5,22.0
    12,20.0,22.5
    12,20.5,23.1
    12,21.0,23.6
    12,21.5,24.2
    12,22.0,24.8
    12,22.5,25.3
    12,23.0,25.9
    12,23.5,26.4
    12,24.0,27.0
    12,24.5,27.5
    12,25.0,28.0
    12,25.5,28.6
    12,26.0,29.1
    12,26.5,29.6
    12,27.0,30.2
    12,27.5,30.7
    12,28.0,31.2
    12,28.5,31.7
    12,29.0,32.2
    12,29.5,32.8
    12,30.0,33.3
    12,30.5,33.8
    12,31.0,34.3
    12,31.5,34.8
    12,32.0,35.3
    12,32.5,35.8
    12,33.0,36.3
    12,33.5,36.8
    12,34.0,37.3
    12,34.5,37.8
    12,35.0,38.3
    12,35.5,38.8
    12,36.0,39.3
    12,36.5,39.8
    12,37.0,40.2
    12,37.5,40.7
    12,38.0,41.2
    12,38.5,41.7
    12,39.0,42.2
    12,39.5,42.7
    12,40.0,43.2
    12,40.5,43.7
    12,41.0,44.2
    12,41.5,44.7
    12,42.0,45.1
    12,42.5,45.6
    12,43.0,46.1
    12,43.5,46.6
    12,44.0,47.1
    12,44.5,47.6
    12,45.0,48.1
    12,45.5,48.6
    12,46.0,49.0
    12,46.5,49.5
    12,47.0,50.0
    12,47.5,50.5
    12,48.0,51.0
    12,48.5,51.5
    12,49.0,52.0
    12,49.5,52.5
    12,50.0,52.9
    12,50.5,53.4
    12,51.0,53.9
    12,51.5,54.4
    12,52.0,54.9
    12,52.5,55.4
    12,53.0,55.9
    12,53.5,56.4
    12,54.0,56.9
    12,54.5,57.4
    12,55.0,57.8
    12,55.5,58.3
    12,56.0,58.8
    12,56.5,59.3
    12,57.0,59.8
    12,57.5,60.3
    12,58.0,60.8
    12,58.5,61.3
    12,59.0,61.8
    12,59.5,62.3
    12,60.0,62.7
    12,60.5,63.2
    12,61.0,63.7
    12,61.5,64.2
    12,62.0,64.7
    12,62.5,65.2
    12,63.0,65.7
    12,63.5,66.2
    12,64.0,66.7
    12,64.5,67.2
    12,65.0,67.7
    12,65.5,68.1
    12,66.0,68.6
    12,66.5,69.1
    12,67.0,69.6
    12,67.5,70.1
    12,68.0,70.6
    12,68.5,71.1
    12,69.0,71.6
    12,69.5,72.1
    12,70.0,72.6
    12,70.5,73.1
    12,71.0,73.5
    12,71.5,74.0
    12,72.0,74.5
    12,72.5,75.0
    12,73.0,75.5
    12,73.5,76.0
    12,74.0,76.5
    12,74.5,77.0
    12,75.0,77.5
    12,75.5,78.0
    12,76.0,78.4
    12,76.5,78.9
    12,77.0,79.4
    12,77.5,79.9
    12,78.0,80.4
    12,78.5,80.9
    12,79.0,81.4
    12,79.5,81.9
    12,80.0,82.3
    12,80.5,82.8
    12,81.0,83.3
    12,81.5,83.8
    12,82.0,84.3
    12,82.5,84.8
    12,83.0,85.3
    12,83.5,85.7
    12,84.0,86.2
    12,84.5,86.7
    12,85.0,87.2
    12,85.5,87.7
    12,86.0,88.2
    12,86.5,88.6
    12,87.0,89.1
    12,87.5,89.6
    12,88.0,90.1
    12,88.5,90.6
    12,89.0,91.0
    12,89.5,91.5
    12,90.0,92.0
    12,90.5,92.5
    12,91.0,92.9
    12,91.5,93.4
    12,92.0,93.9
    12,92.5,94.3
    12,93.0,94.8
    12,93.5,95.3
    12,94.0,95.7
    13,13.5,14.9
    13,14.0,15.5
    13,14.5,16.1
    13,15.0,16.6
    13,15.5,17.2
    13,16.0,17.7
    13,16.5,18.3
    13,17.0,18.8
    13,17.5,19.4
    13,18.0,20.0
    13,18.5,20.5
    13,19.0,21.1
    13,19.5,21.6
    13,20.0,22.2
    13,20.5,22.8
    13,21.0,23.3
    13,21.5,23.9
    13,22.0,24.4
    13,22.5,25.0
    13,23.0,25.5
    13,23.5,26.0
    13,24.0,26.6
    13,24.5,27.1
    13,25.0,27.6
    13,25.5,28.2
    13,26.0,28.7
    13,26.5,29.2
    13,27.0,29.8
    13,27.5,30.3
    13,28.0,30.8
    13,28.5,31.3
    13,29.0,31.8
    13,29.5,32.3
    13,30.0,32.9
    13,30.5,33.4
    13,31.0,33.9
    13,31.5,34.4
    13,32.0,34.9
    13,32.5,35.4
    13,33.0,35.9
    13,33.5,36.4
    13,34.0,36.9
    13,34.5,37.4
    13,35.0,37.9
    13,35.5,38.4
    13,36.0,38.9
    13,36.5,39.4
    13,37.0,39.8
    13,37.5,40.3
    13,38.0,40.8
    13,38.5,41.3
    13,39.0,41.8
    13,39.5,42.3
    13,40.0,42.8
    13,40.5,43.3
    13,41.0,43.8
    13,41.5,44.3
    13,42.0,44.7
    13,42.5,45.2
    13,43.0,45.7
    13,43.5,46.2
    13,44.0,46.7
    13,44.5,47.2
    13,45.0,47.7
    13,45.5,48.2
    13,46.0,48.7
    13,46.5,49.2
    13,47.0,49.6
    13,47.5,50.1
    13,48.0,50.6
    13,48.5,51.1
    13,49.0,51.6
    13,49.5,52.1
    13,50.0,52.6
    13,50.5,53.1
    13,51.0,53.6
    13,51.5,54.1
    13,52.0,54.5
    13,52.5,55.0
    13,53.0,55.5
    13,53.5,56.0
    13,54.0,56.5
    13,54.5,57.0
    13,55.0,57.5
    13,55.5,58.0
    13,56.0,58.5
    13,56.5,59.0
    13,57.0,59.5
    13,57.5,60.0
    13,58.0,60.4
    13,58.5,60.9
    13,59.0,61.4
    13,59.5,61.9
    13,60.0,62.4
    13,60.5,62.9
    13,61.0,63.4
    13,61.5,63.9
    13,62.0,64.4
    13,62.5,64.9
    13,63.0,65.4
    13,63.5,65.9
    13,64.0,66.3
    13,64.5,66.8
    13,65.0,67.3
    13,65.5,67.8
    13,66.0,68.3
    13,66.5,68.8
    13,67.0,69.3
    13,67.5,69.8
    13,68.0,70.3
    13,68.5,70.8
    13,69.0,71.3
    13,69.5,71.8
    13,70.0,72.2
    13,70.5,72.7
    13,71.0,73.2
    13,71.5,73.7
    13,72.0,74.2
    13,72.5,74.7
    13,73.0,75.2
    13,73.5,75.7
    13,74.0,76.2
    13,74.5,76.7
    13,75.0,77.2
    13,75.5,77.6
    13,76.0,78.1
    13,76.5,78.6
    13,77.0,79.1
    13,77.5,79.6
    13,78.0,80.1
    13,78.5,80.6
    13,79.0,81.1
    13,79.5,81.6
    13,80.0,82.1
    13,80.5,82.5
    13,81.0,83.0
    13,81.5,83.5
    13,82.0,84.0
    13,82.5,84.5
    13,83.0,85.0
    13,83.5,85.5
    13,84.0,86.0
    13,84.5,86.4
    13,85.0,86.9
    13,85.5,87.4
    13,86.0,87.9
    13,86.5,88.4
    13,87.0,88.9
    13,87.5,89.3
    13,88.0,89.8
    13,88.5,90.3
    13,89.0,90.8
    13,89.5,91.3
    13,90.0,91.7
    13,90.5,92.2
    13,91.0,92.7
    13,91.5,93.2
    13,92.0,93.6
    13,92.5,94.1
    13,93.0,94.6
    13,93.5,95.1
    13,94.0,95.5
    14,13.5,14.7
    14,14.0,15.3
    14,14.5,15.8
    14,15.0,16.4
    14,15.5,16.9
    14,16.0,17.5
    14,16.5,18.0
    14,17.0,18.6
    14,17.5,19.1
    14,18.0,19.7
    14,18.5,20.2
    14,19.0,20.8
    14,19.5,21.3
    14,20.0,21.9
    14,20.5,22.4
    14,21.0,23.0
    14,21.5,23.5
    14,22.0,24.1
    14,22.5,24.6
    14,23.0,25.1
    14,23.5,25.7
    14,24.0,26.2
    14,24.5,26.7
    14,25.0,27.3
    14,25.5,27.8
    14,26.0,28.3
    14,26.5,28.8
    14,27.0,29.4
    14,27.5,29.9
    14,28.0,30.4
    14,28.5,30.9
    14,29.0,31.4
    14,29.5,31.9
    14,30.0,32.4
    14,30.5,32.9
    14,31.0,33.5
    14,31.5,34.0
    14,32.0,34.5
    14,32.5,35.0
    14,33.0,35.5
    14,33.5,36.0
    14,34.0,36.5
    14,34.5,37.0
    14,35.0,37.5
    14,35.5,38.0
    14,36.0,38.4
    14,36.5,38.9
    14,37.0,39.4
    14,37.5,39.9
    14,38.0,40.4
    14,38.5,40.9
    14,39.0,41.4
    14,39.5,41.9
    14,40.0,42.4
    14,40.5,42.9
    14,41.0,43.4
    14,41.5,43.9
    14,42.0,44.4
    14,42.5,44.9
    14,43.0,45.3
    14,43.5,45.8
    14,44.0,46.3
    14,44.5,46.8
    14,45.0,47.3
    14,45.5,47.8
    14,46.0,48.3
    14,46.5,48.8
    14,47.0,49.3
    14,47.5,49.8
    14,48.0,50.3
    14,48.5,50.7
    14,49.0,51.2
    14,49.5,51.7
    14,50.0,52.2
    14,50.5,52.7
    14,51.0,53.2
    14,51.5,53.7
    14,52.0,54.2
    14,52.5,54.7
    14,53.0,55.2
    14,53.5,55.7
    14,54.0,56.2
    14,54.5,56.6
    14,55.0,57.1
    14,55.5,57.6
    14,56.0,58.1
    14,56.5,58.6
    14,57.0,59.1
    14,57.5,59.6
    14,58.0,60.1
    14,58.5,60.6
    14,59.0,61.1
    14,59.5,61.6
    14,60.0,62.1
    14,60.5,62.6
    14,61.0,63.1
    14,61.5,63.5
    14,62.0,64.0
    14,62.5,64.5
    14,63.0,65.0
    14,63.5,65.5
    14,64.0,66.0
    14,64.5,66.5
    14,65.0,67.0
    14,65.5,67.5
    14,66.0,68.0
    14,66.5,68.5
    14,67.0,69.0
    14,67.5,69.5
    14,68.0,70.0
    14,68.5,70.5
    14,69.0,70.9
    14,69.5,71.4
    14,70.0,71.9
    14,70.5,72.4
    14,71.0,72.9
    14,71.5,73.4
    14,72.0,73.9
    14,72.5,74.4
    14,73.0,74.9
    14,73.5,75.4
    14,74.0,75.9
    14,74.5,76.4
    14,75.0,76.9
    14,75.5,77.3
    14,76.0,77.8
    14,76.5,78.3
    14,77.0,78.8
    14,77.5,79.3
    14,78.0,79.8
    14,78.5,80.3
    14,79.0,80.8
    14,79.5,81.3
    14,80.0,81.8
    14,80.5,82.3
    14,81.0,82.7
    14,81.5,83.2
    14,82.0,83.7
    14,82.5,84.2
    14,83.0,84.7
    14,83.5,85.2
    14,84.0,85.7
    14,84.5,86.2
    14,85.0,86.7
    14,85.5,87.1
    14,86.0,87.6
    14,86.5,88.1
    14,87.0,88.6
    14,87.5,89.1
    14,88.0,89.6
    14,88.5,90.1
    14,89.0,90.5
    14,89.5,91.0
    14,90.0,91.5
    14,90.5,92.0
    14,91.0,92.5
    14,91.5,92.9
    14,92.0,93.4
    14,92.5,93.9
    14,93.0,94.4
    14,93.5,94.8
    14,94.0,95.3
    15,13.5,14.6
    15,14.0,15.1
    15,14.5,15.6
    15,15.0,16.2
    15,15.5,16.7
    15,16.0,17.2
    15,16.5,17.8
    15,17.0,18.3
    15,17.5,18.9
    15,18.0,19.4
    15,18.5,19.9
    15,19.0,20.5
    15,19.5,21.0
    15,20.0,21.6
    15,20.5,22.1
    15,21.0,22.6
    15,21.5,23.2
    15,22.0,23.7
    15,22.5,24.2
    15,23.0,24.8
    15,23.5,25.3
    15,24.0,25.8
    15,24.5,26.4
    15,25.0,26.9
    15,25.5,27.4
    15,26.0,27.9
    15,26.5,28.4
    15,27.0,29.0
    15,27.5,29.5
    15,28.0,30.0
    15,28.5,30.5
    15,29.0,31.0
    15,29.5,31.5
    15,30.0,32.0
    15,30.5,32.5
    15,31.0,33.0
    15,31.5,33.5
    15,32.0,34.0
    15,32.5,34.5
    15,33.0,35.1
    15,33.5,35.6
    15,34.0,36.0
    15,34.5,36.5
    15,35.0,37.0
    15,35.5,37.5
    15,36.0,38.0
    15,36.5,38.5
    15,37.0,39.0
    15,37.5,39.5
    15,38.0,40.0
    15,38.5,40.5
    15,39.0,41.0
    15,39.5,41.5
    15,40.0,42.0
    15,40.5,42.5
    15,41.0,43.0
    15,41.5,43.5
    15,42.0,44.0
    15,42.5,44.5
    15,43.0,45.0
    15,43.5,45.4
    15,44.0,45.9
    15,44.5,46.4
    15,45.0,46.9
    15,45.5,47.4
    15,46.0,47.9
    15,46.5,48.4
    15,47.0,48.9
    15,47.5,49.4
    15,48.0,49.9
    15,48.5,50.4
    15,49.0,50.9
    15,49.5,51.4
    15,50.0,51.9
    15,50.5,52.3
    15,51.0,52.8
    15,51.5,53.3
    15,52.0,53.8
    15,52.5,54.3
    15,53.0,54.8
    15,53.5,55.3
    15,54.0,55.8
    15,54.5,56.3
    15,55.0,56.8
    15,55.5,57.3
    15,56.0,57.8
    15,56.5,58.3
    15,57.0,58.8
    15,57.5,59.3
    15,58.0,59.8
    15,58.5,60.2
    15,59.0,60.7
    15,59.5,61.2
    15,60.0,61.7
    15,60.5,62.2
    15,61.0,62.7
    15,61.5,63.2
    15,62.0,63.7
    15,62.5,64.2
    15,63.0,64.7
    15,63.5,65.2
    15,64.0,65.7
    15,64.5,66.2
    15,65.0,66.7
    15,65.5,67.2
    15,66.0,67.7
    15,66.5,68.2
    15,67.0,68.6
    15,67.5,69.1
    15,68.0,69.6
    15,68.5,70.1
    15,69.0,70.6
    15,69.5,71.1
    15,70.0,71.6
    15,70.5,72.1
    15,71.0,72.6
    15,71.5,73.1
    15,72.0,73.6
    15,72.5,74.1
    15,73.0,74.6
    15,73.5,75.1
    15,74.0,75.6
    15,74.5,76.1
    15,75.0,76.5
    15,75.5,77.0
    15,76.0,77.5
    15,76.5,78.0
    15,77.0,78.5
    15,77.5,79.0
    15,78.0,79.5
    15,78.5,80.0
    15,79.0,80.5
    15,79.5,81.0
    15,80.0,81.5
    15,80.5,82.0
    15,81.0,82.5
    15,81.5,83.0
    15,82.0,83.4
    15,82.5,83.9
    15,83.0,84.4
    15,83.5,84.9
    15,84.0,85.4
    15,84.5,85.9
    15,85.0,86.4
    15,85.5,86.9
    15,86.0,87.4
    15,86.5,87.9
    15,87.0,88.3
    15,87.5,88.8
    15,88.0,89.3
    15,88.5,89.8
    15,89.0,90.3
    15,89.5,90.8
    15,90.0,91.3
    15,90.5,91.7
    15,91.0,92.2
    15,91.5,92.7
    15,92.0,93.2
    15,92.5,93.7
    15,93.0,94.1
    15,93.5,94.6
    15,94.0,95.1
    16,13.5,14.4
    16,14.0,14.9
    16,14.5,15.4
    16,15.0,15.9
    16,15.5,16.5
    16,16.0,17.0
    16,16.5,17.5
    16,17.0,18.1
    16,17.5,18.6
    16,18.0,19.1
    16,18.5,19.7
    16,19.0,20.2
    16,19.5,20.7
    16,20.0,21.3
    16,20.5,21.8
    16,21.0,22.3
    16,21.5,22.8
    16,22.0,23.4
    16,22.5,23.9
    16,23.0,24.4
    16,23.5,24.9
    16,24.0,25.5
    16,24.5,26.0
    16,25.0,26.5
    16,25.5,27.0
    16,26.0,27.5
    16,26.5,28.0
    16,27.0,28.6
    16,27.5,29.1
    16,28.0,29.6
    16,28.5,30.1
    16,29.0,30.6
    16,29.5,31.1
    16,30.0,31.6
    16,30.5,32.1
    16,31.0,32.6
    16,31.5,33.1
    16,32.0,33.6
    16,32.5,34.1
    16,33.0,34.6
    16,33.5,35.1
    16,34.0,35.6
    16,34.5,36.1
    16,35.0,36.6
    16,35.5,37.1
    16,36.0,37.6
    16,36.5,38.1
    16,37.0,38.6
    16,37.5,39.1
    16,38.0,39.6
    16,38.5,40.1
    16,39.0,40.6
    16,39.5,41.1
    16,40.0,41.6
    16,40.5,42.1
    16,41.0,42.6
    16,41.5,43.1
    16,42.0,43.6
    16,42.5,44.1
    16,43.0,44.6
    16,43.5,45.1
    16,44.0,45.6
    16,44.5,46.0
    16,45.0,46.5
    16,45.5,47.0
    16,46.0,47.5
    16,46.5,48.0
    16,47.0,48.5
    16,47.5,49.0
    16,48.0,49.5
    16,48.5,50.0
    16,49.0,50.5
    16,49.5,51.0
    16,50.0,51.5
    16,50.5,52.0
    16,51.0,52.5
    16,51.5,53.0
    16,52.0,53.5
    16,52.5,54.0
    16,53.0,54.5
    16,53.5,54.9
    16,54.0,55.4
    16,54.5,55.9
    16,55.0,56.4
    16,55.5,56.9
    16,56.0,57.4
    16,56.5,57.9
    16,57.0,58.4
    16,57.5,58.9
    16,58.0,59.4
    16,58.5,59.9
    16,59.0,60.4
    16,59.5,60.9
    16,60.0,61.4
    16,60.5,61.9
    16,61.0,62.4
    16,61.5,62.9
    16,62.0,63.4
    16,62.5,63.9
    16,63.0,64.4
    16,63.5,64.9
    16,64.0,65.3
    16,64.5,65.8
    16,65.0,66.3
    16,65.5,66.8
    16,66.0,67.3
    16,66.5,67.8
    16,67.0,68.3
    16,67.5,68.8
    16,68.0,69.3
    16,68.5,69.8
    16,69.0,70.3
    16,69.5,70.8
    16,70.0,71.3
    16,70.5,71.8
    16,71.0,72.3
    16,71.5,72.8
    16,72.0,73.3
    16,72.5,73.8
    16,73.0,74.3
    16,73.5,74.8
    16,74.0,75.3
    16,74.5,75.7
    16,75.0,76.2
    16,75.5,76.7
    16,76.0,77.2
    16,76.5,77.7
    16,77.0,78.2
    16,77.5,78.7
    16,78.0,79.2
    16,78.5,79.7
    16,79.0,80.2
    16,79.5,80.7
    16,80.0,81.2
    16,80.5,81.7
    16,81.0,82.2
    16,81.5,82.7
    16,82.0,83.2
    16,82.5,83.7
    16,83.0,84.1
    16,83.5,84.6
    16,84.0,85.1
    16,84.5,85.6
    16,85.0,86.1
    16,85.5,86.6
    16,86.0,87.1
    16,86.5,87.6
    16,87.0,88.1
    16,87.5,88.6
    16,88.0,89.1
    16,88.5,89.5
    16,89.0,90.0
    16,89.5,90.5
    16,90.0,91.0
    16,90.5,91.5
    16,91.0,92.0
    16,91.5,92.5
    16,92.0,93.0
    16,92.5,93.4
    16,93.0,93.9
    16,93.5,94.4
    16,94.0,94.9
    17,13.5,14.1
    17,14.0,14.7
    17,14.5,15.2
    17,15.0,15.7
    17,15.5,16.2
    17,16.0,16.8
    17,16.5,17.3
    17,17.0,17.8
    17,17.5,18.3
    17,18.0,18.8
    17,18.5,19.4
    17,19.0,19.9
    17,19.5,20.4
    17,20.0,20.9
    17,20.5,21.5
    17,21.0,22.0
    17,21.5,22.5
    17,22.0,23.0
    17,22.5,23.5
    17,23.0,24.1
    17,23.5,24.6
    17,24.0,25.1
    17,24.5,25.6
    17,25.0,26.1
    17,25.5,26.6
    17,26.0,27.1
    17,26.5,27.7
    17,27.0,28.2
    17,27.5,28.7
    17,28.0,29.2
    17,28.5,29.7
    17,29.0,30.2
    17,29.5,30.7
    17,30.0,31.2
    17,30.5,31.7
    17,31.0,32.2
    17,31.5,32.7
    17,32.0,33.2
    17,32.5,33.7
    17,33.0,34.2
    17,33.5,34.7
    17,34.0,35.2
    17,34.5,35.7
    17,35.0,36.2
    17,35.5,36.7
    17,36.0,37.2
    17,36.5,37.7
    17,37.0,38.2
    17,37.5,38.7
    17,38.0,39.2
    17,38.5,39.7
    17,39.0,40.2
    17,39.5,40.7
    17,40.0,41.2
    17,40.5,41.7
    17,41.0,42.2
    17,41.5,42.7
    17,42.0,43.2
    17,42.5,43.7
    17,43.0,44.2
    17,43.5,44.7
    17,44.0,45.2
    17,44.5,45.7
    17,45.0,46.2
    17,45.5,46.7
    17,46.0,47.1
    17,46.5,47.6
    17,47.0,48.1
    17,47.5,48.6
    17,48.0,49.1
    17,48.5,49.6
    17,49.0,50.1
    17,49.5,50.6
    17,50.0,51.1
    17,50.5,51.6
    17,51.0,52.1
    17,51.5,52.6
    17,52.0,53.1
    17,52.5,53.6
    17,53.0,54.1
    17,53.5,54.6
    17,54.0,55.1
    17,54.5,55.6
    17,55.0,56.1
    17,55.5,56.6
    17,56.0,57.1
    17,56.5,57.6
    17,57.0,58.1
    17,57.5,58.6
    17,58.0,59.1
    17,58.5,59.6
    17,59.0,60.0
    17,59.5,60.5
    17,60.0,61.0
    17,60.5,61.5
    17,61.0,62.0
    17,61.5,62.5
    17,62.0,63.0
    17,62.5,63.5
    17,63.0,64.0
    17,63.5,64.5
    17,64.0,65.0
    17,64.5,65.5
    17,65.0,66.0
    17,65.5,66.5
    17,66.0,67.0
    17,66.5,67.5
    17,67.0,68.0
    17,67.5,68.5
    17,68.0,69.0
    17,68.5,69.5
    17,69.0,70.0
    17,69.5,70.5
    17,70.0,71.0
    17,70.5,71.5
    17,71.0,72.0
    17,71.5,72.5
    17,72.0,73.0
    17,72.5,73.5
    17,73.0,73.9
    17,73.5,74.4
    17,74.0,74.9
    17,74.5,75.4
    17,75.0,75.9
    17,75.5,76.4
    17,76.0,76.9
    17,76.5,77.4
    17,77.0,77.9
    17,77.5,78.4
    17,78.0,78.9
    17,78.5,79.4
    17,79.0,79.9
    17,79.5,80.4
    17,80.0,80.9
    17,80.5,81.4
    17,81.0,81.9
    17,81.5,82.4
    17,82.0,82.9
    17,82.5,83.4
    17,83.0,83.9
    17,83.5,84.4
    17,84.0,84.8
    17,84.5,85.3
    17,85.0,85.8
    17,85.5,86.3
    17,86.0,86.8
    17,86.5,87.3
    17,87.0,87.8
    17,87.5,88.3
    17,88.0,88.8
    17,88.5,89.3
    17,89.0,89.8
    17,89.5,90.3
    17,90.0,90.8
    17,90.5,91.2
    17,91.0,91.7
    17,91.5,92.2
    17,92.0,92.7
    17,92.5,93.2
    17,93.0,93.7
    17,93.5,94.2
    17,94.0,94.7
    18,13.5,13.9
    18,14.0,14.4
    18,14.5,15.0
    18,15.0,15.5
    18,15.5,16.0
    18,16.0,16.5
    18,16.5,17.0
    18,17.0,17.5
    18,17.5,18.1
    18,18.0,18.6
    18,18.5,19.1
    18,19.0,19.6
    18,19.5,20.1
    18,20.0,20.6
    18,20.5,21.1
    18,21.0,21.7
    18,21.5,22.2
    18,22.0,22.7
    18,22.5,23.2
    18,23.0,23.7
    18,23.5,24.2
    18,24.0,24.7
    18,24.5,25.2
    18,25.0,25.7
    18,25.5,26.3
    18,26.0,26.8
    18,26.5,27.3
    18,27.0,27.8
    18,27.5,28.3
    18,28.0,28.8
    18,28.5,29.3
    18,29.0,29.8
    18,29.5,30.3
    18,30.0,30.8
    18,30.5,31.3
    18,31.0,31.8
    18,31.5,32.3
    18,32.0,32.8
    18,32.5,33.3
    18,33.0,33.8
    18,33.5,34.3
    18,34.0,34.8
    18,34.5,35.3
    18,35.0,35.8
    18,35.5,36.3
    18,36.0,36.8
    18,36.5,37.3
    18,37.0,37.8
    18,37.5,38.3
    18,38.0,38.8
    18,38.5,39.3
    18,39.0,39.8
    18,39.5,40.3
    18,40.0,40.8
    18,40.5,41.3
    18,41.0,41.8
    18,41.5,42.3
    18,42.0,42.8
    18,42.5,43.3
    18,43.0,43.8
    18,43.5,44.3
    18,44.0,44.8
    18,44.5,45.3
    18,45.0,45.8
    18,45.5,46.3
    18,46.0,46.8
    18,46.5,47.3
    18,47.0,47.8
    18,47.5,48.3
    18,48.0,48.8
    18,48.5,49.3
    18,49.0,49.7
    18,49.5,50.2
    18,50.0,50.7
    18,50.5,51.2
    18,51.0,51.7
    18,51.5,52.2
    18,52.0,52.7
    18,52.5,53.2
    18,53.0,53.7
    18,53.5,54.2
    18,54.0,54.7
    18,54.5,55.2
    18,55.0,55.7
    18,55.5,56.2
    18,56.0,56.7
    18,56.5,57.2
    18,57.0,57.7
    18,57.5,58.2
    18,58.0,58.7
    18,58.5,59.2
    18,59.0,59.7
    18,59.5,60.2
    18,60.0,60.7
    18,60.5,61.2
    18,61.0,61.7
    18,61.5,62.2
    18,62.0,62.7
    18,62.5,63.2
    18,63.0,63.7
    18,63.5,64.2
    18,64.0,64.7
    18,64.5,65.2
    18,65.0,65.7
    18,65.5,66.2
    18,66.0,66.7
    18,66.5,67.2
    18,67.0,67.7
    18,67.5,68.2
    18,68.0,68.7
    18,68.5,69.2
    18,69.0,69.7
    18,69.5,70.2
    18,70.0,70.6
    18,70.5,71.1
    18,71.0,71.6
    18,71.5,72.1
    18,72.0,72.6
    18,72.5,73.1
    18,73.0,73.6
    18,73.5,74.1
    18,74.0,74.6
    18,74.5,75.1
    18,75.0,75.6
    18,75.5,76.1
    18,76.0,76.6
    18,76.5,77.1
    18,77.0,77.6
    18,77.5,78.1
    18,78.0,78.6
    18,78.5,79.1
    18,79.0,79.6
    18,79.5,80.1
    18,80.0,80.6
    18,80.5,81.1
    18,81.0,81.6
    18,81.5,82.1
    18,82.0,82.6
    18,82.5,83.1
    18,83.0,83.6
    18,83.5,84.1
    18,84.0,84.6
    18,84.5,85.1
    18,85.0,85.6
    18,85.5,86.1
    18,86.0,86.6
    18,86.5,87.0
    18,87.0,87.5
    18,87.5,88.0
    18,88.0,88.5
    18,88.5,89.0
    18,89.0,89.5
    18,89.5,90.0
    18,90.0,90.5
    18,90.5,91.0
    18,91.0,91.5
    18,91.5,92.0
    18,92.0,92.5
    18,92.5,93.0
    18,93.0,93.5
    18,93.5,94.0
    18,94.0,94.4
    19,13.5,13.7
    19,14.0,14.2
    19,14.5,14.7
    19,15.0,15.2
    19,15.5,15.7
    19,16.0,16.3
    19,16.5,16.8
    19,17.0,17.3
    19,17.5,17.8
    19,18.0,18.3
    19,18.5,18.8
    19,19.0,19.3
    19,19.5,19.8
    19,20.0,20.3
    19,20.5,20.8
    19,21.0,21.3
    19,21.5,21.8
    19,22.0,22.3
    19,22.5,22.8
    19,23.0,23.4
    19,23.5,23.9
    19,24.0,24.4
    19,24.5,24.9
    19,25.0,25.4
    19,25.5,25.9
    19,26.0,26.4
    19,26.5,26.9
    19,27.0,27.4
    19,27.5,27.9
    19,28.0,28.4
    19,28.5,28.9
    19,29.0,29.4
    19,29.5,29.9
    19,30.0,30.4
    19,30.5,30.9
    19,31.0,31.4
    19,31.5,31.9
    19,32.0,32.4
    19,32.5,32.9
    19,33.0,33.4
    19,33.5,33.9
    19,34.0,34.4
    19,34.5,34.9
    19,35.0,35.4
    19,35.5,35.9
    19,36.0,36.4
    19,36.5,36.9
    19,37.0,37.4
    19,37.5,37.9
    19,38.0,38.4
    19,38.5,38.9
    19,39.0,39.4
    19,39.5,39.9
    19,40.0,40.4
    19,40.5,40.9
    19,41.0,41.4
    19,41.5,41.9
    19,42.0,42.4
    19,42.5,42.9
    19,43.0,43.4
    19,43.5,43.9
    19,44.0,44.4
    19,44.5,44.9
    19,45.0,45.4
    19,45.5,45.9
    19,46.0,46.4
    19,46.5,46.9
    19,47.0,47.4
    19,47.5,47.9
    19,48.0,48.4
    19,48.5,48.9
    19,49.0,49.4
    19,49.5,49.9
    19,50.0,50.4
    19,50.5,50.9
    19,51.0,51.4
    19,51.5,51.9
    19,52.0,52.4
    19,52.5,52.9
    19,53.0,53.4
    19,53.5,53.9
    19,54.0,54.4
    19,54.5,54.9
    19,55.0,55.4
    19,55.5,55.9
    19,56.0,56.4
    19,56.5,56.9
    19,57.0,57.4
    19,57.5,57.9
    19,58.0,58.4
    19,58.5,58.9
    19,59.0,59.4
    19,59.5,59.8
    19,60.0,60.3
    19,60.5,60.8
    19,61.0,61.3
    19,61.5,61.8
    19,62.0,62.3
    19,62.5,62.8
    19,63.0,63.3
    19,63.5,63.8
    19,64.0,64.3
    19,64.5,64.8
    19,65.0,65.3
    19,65.5,65.8
    19,66.0,66.3
    19,66.5,66.8
    19,67.0,67.3
    19,67.5,67.8
    19,68.0,68.3
    19,68.5,68.8
    19,69.0,69.3
    19,69.5,69.8
    19,70.0,70.3
    19,70.5,70.8
    19,71.0,71.3
    19,71.5,71.8
    19,72.0,72.3
    19,72.5,72.8
    19,73.0,73.3
    19,73.5,73.8
    19,74.0,74.3
    19,74.5,74.8
    19,75.0,75.3
    19,75.5,75.8
    19,76.0,76.3
    19,76.5,76.8
    19,77.0,77.3
    19,77.5,77.8
    19,78.0,78.3
    19,78.5,78.8
    19,79.0,79.3
    19,79.5,79.8
    19,80.0,80.3
    19,80.5,80.8
    19,81.0,81.3
    19,81.5,81.8
    19,82.0,82.3
    19,82.5,82.8
    19,83.0,83.3
    19,83.5,83.8
    19,84.0,84.3
    19,84.5,84.8
    19,85.0,85.3
    19,85.5,85.8
    19,86.0,86.3
    19,86.5,86.8
    19,87.0,87.3
    19,87.5,87.8
    19,88.0,88.3
    19,88.5,88.8
    19,89.0,89.3
    19,89.5,89.8
    19,90.0,90.3
    19,90.5,90.8
    19,91.0,91.2
    19,91.5,91.7
    19,92.0,92.2
    19,92.5,92.7
    19,93.0,93.2
    19,93.5,93.7
    19,94.0,94.2
    20,13.5,13.5
    20,14.0,14.0
    20,14.5,14.5
    20,15.0,15.0
    20,15.5,15.5
    20,16.0,16.0
    20,16.5,16.5
    20,17.0,17.0
    20,17.5,17.5
    20,18.0,18.0
    20,18.5,18.5
    20,19.0,19.0
    20,19.5,19.5
    20,20.0,20.0
    20,20.5,20.5
    20,21.0,21.0
    20,21.5,21.5
    20,22.0,22.0
    20,22.5,22.5
    20,23.0,23.0
    20,23.5,23.5
    20,24.0,24.0
    20,24.5,24.5
    20,25.0,25.0
    20,25.5,25.5
    20,26.0,26.0
    20,26.5,26.5
    20,27.0,27.0
    20,27.5,27.5
    20,28.0,28.0
    20,28.5,28.5
    20,29.0,29.0
    20,29.5,29.5
    20,30.0,30.0
    20,30.5,30.5
    20,31.0,31.0
    20,31.5,31.5
    20,32.0,32.0
    20,32.5,32.5
    20,33.0,33.0
    20,33.5,33.5
    20,34.0,34.0
    20,34.5,34.5
    20,35.0,35.0
    20,35.5,35.5
    20,36.0,36.0
    20,36.5,36.5
    20,37.0,37.0
    20,37.5,37.5
    20,38.0,38.0
    20,38.5,38.5
    20,39.0,39.0
    20,39.5,39.5
    20,40.0,40.0
    20,40.5,40.5
    20,41.0,41.0
    20,41.5,41.5
    20,42.0,42.0
    20,42.5,42.5
    20,43.0,43.0
    20,43.5,43.5
    20,44.0,44.0
    20,44.5,44.5
    20,45.0,45.0
    20,45.5,45.5
    20,46.0,46.0
    20,46.5,46.5
    20,47.0,47.0
    20,47.5,47.5
    20,48.0,48.0
    20,48.5,48.5
    20,49.0,49.0
    20,49.5,49.5
    20,50.0,50.0
    20,50.5,50.5
    20,51.0,51.0
    20,51.5,51.5
    20,52.0,52.0
    20,52.5,52.5
    20,53.0,53.0
    20,53.5,53.5
    20,54.0,54.0
    20,54.5,54.5
    20,55.0,55.0
    20,55.5,55.5
    20,56.0,56.0
    20,56.5,56.5
    20,57.0,57.0
    20,57.5,57.5
    20,58.0,58.0
    20,58.5,58.5
    20,59.0,59.0
    20,59.5,59.5
    20,60.0,60.0
    20,60.5,60.5
    20,61.0,61.0
    20,61.5,61.5
    20,62.0,62.0
    20,62.5,62.5
    20,63.0,63.0
    20,63.5,63.5
    20,64.0,64.0
    20,64.5,64.5
    20,65.0,65.0
    20,65.5,65.5
    20,66.0,66.0
    20,66.5,66.5
    20,67.0,67.0
    20,67.5,67.5
    20,68.0,68.0
    20,68.5,68.5
    20,69.0,69.0
    20,69.5,69.5
    20,70.0,70.0
    20,70.5,70.5
    20,71.0,71.0
    20,71.5,71.5
    20,72.0,72.0
    20,72.5,72.5
    20,73.0,73.0
    20,73.5,73.5
    20,74.0,74.0
    20,74.5,74.5
    20,75.0,75.0
    20,75.5,75.5
    20,76.0,76.0
    20,76.5,76.5
    20,77.0,77.0
    20,77.5,77.5
    20,78.0,78.0
    20,78.5,78.5
    20,79.0,79.0
    20,79.5,79.5
    20,80.0,80.0
    20,80.5,80.5
    20,81.0,81.0
    20,81.5,81.5
    20,82.0,82.0
    20,82.5,82.5
    20,83.0,83.0
    20,83.5,83.5
    20,84.0,84.0
    20,84.5,84.5
    20,85.0,85.0
    20,85.5,85.5
    20,86.0,86.0
    20,86.5,86.5
    20,87.0,87.0
    20,87.5,87.5
    20,88.0,88.0
    20,88.5,88.5
    20,89.0,89.0
    20,89.5,89.5
    20,90.0,90.0
    20,90.5,90.5
    20,91.0,91.0
    20,91.5,91.5
    20,92.0,92.0
    20,92.5,92.5
    20,93.0,93.0
    20,93.5,93.5
    20,94.0,94.0
    21,13.5,13.3
    21,14.0,13.8
    21,14.5,14.3
    21,15.0,14.8
    21,15.5,15.3
    21,16.0,15.7
    21,16.5,16.2
    21,17.0,16.7
    21,17.5,17.2
    21,18.0,17.7
    21,18.5,18.2
    21,19.0,18.7
    21,19.5,19.2
    21,20.0,19.7
    21,20.5,20.2
    21,21.0,20.7
    21,21.5,21.2
    21,22.0,21.7
    21,22.5,22.2
    21,23.0,22.7
    21,23.5,23.1
    21,24.0,23.6
    21,24.5,24.1
    21,25.0,24.6
    21,25.5,25.1
    21,26.0,25.6
    21,26.5,26.1
    21,27.0,26.6
    21,27.5,27.1
    21,28.0,27.6
    21,28.5,28.1
    21,29.0,28.6
    21,29.5,29.1
    21,30.0,29.6
    21,30.5,30.1
    21,31.0,30.6
    21,31.5,31.1
    21,32.0,31.6
    21,32.5,32.1
    21,33.0,32.6
    21,33.5,33.1
    21,34.0,33.6
    21,34.5,34.1
    21,35.0,34.6
    21,35.5,35.1
    21,36.0,35.6
    21,36.5,36.1
    21,37.0,36.6
    21,37.5,37.1
    21,38.0,37.6
    21,38.5,38.1
    21,39.0,38.6
    21,39.5,39.1
    21,40.0,39.6
    21,40.5,40.1
    21,41.0,40.6
    21,41.5,41.1
    21,42.0,41.6
    21,42.5,42.1
    21,43.0,42.6
    21,43.5,43.1
    21,44.0,43.6
    21,44.5,44.1
    21,45.0,44.6
    21,45.5,45.1
    21,46.0,45.6
    21,46.5,46.1
    21,47.0,46.6
    21,47.5,47.1
    21,48.0,47.6
    21,48.5,48.1
    21,49.0,48.6
    21,49.5,49.1
    21,50.0,49.6
    21,50.5,50.1
    21,51.0,50.6
    21,51.5,51.1
    21,52.0,51.6
    21,52.5,52.1
    21,53.0,52.6
    21,53.5,53.1
    21,54.0,53.6
    21,54.5,54.1
    21,55.0,54.6
    21,55.5,55.1
    21,56.0,55.6
    21,56.5,56.1
    21,57.0,56.6
    21,57.5,57.1
    21,58.0,57.6
    21,58.5,58.1
    21,59.0,58.6
    21,59.5,59.1
    21,60.0,59.7
    21,60.5,60.2
    21,61.0,60.7
    21,61.5,61.2
    21,62.0,61.7
    21,62.5,62.2
    21,63.0,62.7
    21,63.5,63.2
    21,64.0,63.7
    21,64.5,64.2
    21,65.0,64.7
    21,65.5,65.2
    21,66.0,65.7
    21,66.5,66.2
    21,67.0,66.7
    21,67.5,67.2
    21,68.0,67.7
    21,68.5,68.2
    21,69.0,68.7
    21,69.5,69.2
    21,70.0,69.7
    21,70.5,70.2
    21,71.0,70.7
    21,71.5,71.2
    21,72.0,71.7
    21,72.5,72.2
    21,73.0,72.7
    21,73.5,73.2
    21,74.0,73.7
    21,74.5,74.2
    21,75.0,74.7
    21,75.5,75.2
    21,76.0,75.7
    21,76.5,76.2
    21,77.0,76.7
    21,77.5,77.2
    21,78.0,77.7
    21,78.5,78.2
    21,79.0,78.7
    21,79.5,79.2
    21,80.0,79.7
    21,80.5,80.2
    21,81.0,80.7
    21,81.5,81.2
    21,82.0,81.7
    21,82.5,82.2
    21,83.0,82.7
    21,83.5,83.2
    21,84.0,83.7
    21,84.5,84.2
    21,85.0,84.7
    21,85.5,85.2
    21,86.0,85.7
    21,86.5,86.2
    21,87.0,86.7
    21,87.5,87.2
    21,88.0,87.7
    21,88.5,88.2
    21,89.0,88.7
    21,89.5,89.2
    21,90.0,89.7
    21,90.5,90.2
    21,91.0,90.7
    21,91.5,91.3
    21,92.0,91.8
    21,92.5,92.3
    21,93.0,92.8
    21,93.5,93.3
    21,94.0,93.8
    22,13.5,13.0
    22,14.0,13.5
    22,14.5,14.0
    22,15.0,14.5
    22,15.5,15.0
    22,16.0,15.5
    22,16.5,16.0
    22,17.0,16.5
    22,17.5,16.9
    22,18.0,17.4
    22,18.5,17.9
    22,19.0,18.4
    22,19.5,18.9
    22,20.0,19.4
    22,20.5,19.9
    22,21.0,20.4
    22,21.5,20.8
    22,22.0,21.3
    22,22.5,21.8
    22,23.0,22.3
    22,23.5,22.8
    22,24.0,23.3
    22,24.5,23.8
    22,25.0,24.3
    22,25.5,24.8
    22,26.0,25.2
    22,26.5,25.7
    22,27.0,26.2
    22,27.5,26.7
    22,28.0,27.2
    22,28.5,27.7
    22,29.0,28.2
    22,29.5,28.7
    22,30.0,29.2
    22,30.5,29.7
    22,31.0,30.2
    22,31.5,30.7
    22,32.0,31.2
    22,32.5,31.7
    22,33.0,32.2
    22,33.5,32.7
    22,34.0,33.2
    22,34.5,33.7
    22,35.0,34.2
    22,35.5,34.7
    22,36.0,35.2
    22,36.5,35.7
    22,37.0,36.2
    22,37.5,36.7
    22,38.0,37.2
    22,38.5,37.7
    22,39.0,38.2
    22,39.5,38.7
    22,40.0,39.2
    22,40.5,39.7
    22,41.0,40.2
    22,41.5,40.7
    22,42.0,41.2
    22,42.5,41.7
    22,43.0,42.2
    22,43.5,42.7
    22,44.0,43.2
    22,44.5,43.7
    22,45.0,44.2
    22,45.5,44.7
    22,46.0,45.2
    22,46.5,45.7
    22,47.0,46.2
    22,47.5,46.7
    22,48.0,47.2
    22,48.5,47.7
    22,49.0,48.2
    22,49.5,48.7
    22,50.0,49.3
    22,50.5,49.8
    22,51.0,50.3
    22,51.5,50.8
    22,52.0,51.3
    22,52.5,51.8
    22,53.0,52.3
    22,53.5,52.8
    22,54.0,53.3
    22,54.5,53.8
    22,55.0,54.3
    22,55.5,54.8
    22,56.0,55.3
    22,56.5,55.8
    22,57.0,56.3
    22,57.5,56.8
    22,58.0,57.3
    22,58.5,57.8
    22,59.0,58.3
    22,59.5,58.8
    22,60.0,59.3
    22,60.5,59.8
    22,61.0,60.3
    22,61.5,60.8
    22,62.0,61.3
    22,62.5,61.8
    22,63.0,62.3
    22,63.5,62.8
    22,64.0,63.3
    22,64.5,63.8
    22,65.0,64.3
    22,65.5,64.8
    22,66.0,65.3
    22,66.5,65.8
    22,67.0,66.3
    22,67.5,66.8
    22,68.0,67.3
    22,68.5,67.8
    22,69.0,68.3
    22,69.5,68.8
    22,70.0,69.3
    22,70.5,69.8
    22,71.0,70.4
    22,71.5,70.9
    22,72.0,71.4
    22,72.5,71.9
    22,73.0,72.4
    22,73.5,72.9
    22,74.0,73.4
    22,74.5,73.9
    22,75.0,74.4
    22,75.5,74.9
    22,76.0,75.4
    22,76.5,75.9
    22,77.0,76.4
    22,77.5,76.9
    22,78.0,77.4
    22,78.5,77.9
    22,79.0,78.4
    22,79.5,78.9
    22,80.0,79.4
    22,80.5,79.9
    22,81.0,80.4
    22,81.5,80.9
    22,82.0,81.4
    22,82.5,81.9
    22,83.0,82.4
    22,83.5,82.9
    22,84.0,83.4
    22,84.5,83.9
    22,85.0,84.4
    22,85.5,84.9
    22,86.0,85.4
    22,86.5,85.9
    22,87.0,86.5
    22,87.5,87.0
    22,88.0,87.5
    22,88.5,88.0
    22,89.0,88.5
    22,89.5,89.0
    22,90.0,89.5
    22,90.5,90.0
    22,91.0,90.5
    22,91.5,91.0
    22,92.0,91.5
    22,92.5,92.0
    22,93.0,92.5
    22,93.5,93.0
    22,94.0,93.5
    23,13.5,12.8
    23,14.0,13.3
    23,14.5,13.8
    23,15.0,14.3
    23,15.5,14.7
    23,16.0,15.2
    23,16.5,15.7
    23,17.0,16.2
    23,17.5,16.7
    23,18.0,17.1
    23,18.5,17.6
    23,19.0,18.1
    23,19.5,18.6
    23,20.0,19.1
    23,20.5,19.5
    23,21.0,20.0
    23,21.5,20.5
    23,22.0,21.0
    23,22.5,21.5
    23,23.0,22.0
    23,23.5,22.4
    23,24.0,22.9
    23,24.5,23.4
    23,25.0,23.9
    23,25.5,24.4
    23,26.0,24.9
    23,26.5,25.4
    23,27.0,25.9
    23,27.5,26.3
    23,28.0,26.8
    23,28.5,27.3
    23,29.0,27.8
    23,29.5,28.3
    23,30.0,28.8
    23,30.5,29.3
    23,31.0,29.8
    23,31.5,30.3
    23,32.0,30.8
    23,32.5,31.3
    23,33.0,31.8
    23,33.5,32.3
    23,34.0,32.8
    23,34.5,33.3
    23,35.0,33.8
    23,35.5,34.3
    23,36.0,34.8
    23,36.5,35.3
    23,37.0,35.8
    23,37.5,36.3
    23,38.0,36.8
    23,38.5,37.3
    23,39.0,37.8
    23,39.5,38.3
    23,40.0,38.8
    23,40.5,39.3
    23,41.0,39.8
    23,41.5,40.3
    23,42.0,40.8
    23,42.5,41.3
    23,43.0,41.8
    23,43.5,42.3
    23,44.0,42.8
    23,44.5,43.3
    23,45.0,43.8
    23,45.5,44.3
    23,46.0,44.8
    23,46.5,45.3
    23,47.0,45.9
    23,47.5,46.4
    23,48.0,46.9
    23,48.5,47.4
    23,49.0,47.9
    23,49.5,48.4
    23,50.0,48.9
    23,50.5,49.4
    23,51.0,49.9
    23,51.5,50.4
    23,52.0,50.9
    23,52.5,51.4
    23,53.0,51.9
    23,53.5,52.4
    23,54.0,52.9
    23,54.5,53.4
    23,55.0,53.9
    23,55.5,54.4
    23,56.0,54.9
    23,56.5,55.4
    23,57.0,55.9
    23,57.5,56.4
    23,58.0,56.9
    23,58.5,57.4
    23,59.0,57.9
    23,59.5,58.4
    23,60.0,58.9
    23,60.5,59.5
    23,61.0,60.0
    23,61.5,60.5
    23,62.0,61.0
    23,62.5,61.5
    23,63.0,62.0
    23,63.5,62.5
    23,64.0,63.0
    23,64.5,63.5
    23,65.0,64.0
    23,65.5,64.5
    23,66.0,65.0
    23,66.5,65.5
    23,67.0,66.0
    23,67.5,66.5
    23,68.0,67.0
    23,68.5,67.5
    23,69.0,68.0
    23,69.5,68.5
    23,70.0,69.0
    23,70.5,69.5
    23,71.0,70.0
    23,71.5,70.5
    23,72.0,71.0
    23,72.5,71.5
    23,73.0,72.0
    23,73.5,72.5
    23,74.0,73.0
    23,74.5,73.6
    23,75.0,74.1
    23,75.5,74.6
    23,76.0,75.1
    23,76.5,75.6
    23,77.0,76.1
    23,77.5,76.6
    23,78.0,77.1
    23,78.5,77.6
    23,79.0,78.1
    23,79.5,78.6
    23,80.0,79.1
    23,80.5,79.6
    23,81.0,80.1
    23,81.5,80.6
    23,82.0,81.1
    23,82.5,81.6
    23,83.0,82.1
    23,83.5,82.6
    23,84.0,83.1
    23,84.5,83.6
    23,85.0,84.1
    23,85.5,84.7
    23,86.0,85.2
    23,86.5,85.7
    23,87.0,86.2
    23,87.5,86.7
    23,88.0,87.2
    23,88.5,87.7
    23,89.0,88.2
    23,89.5,88.7
    23,90.0,89.2
    23,90.5,89.7
    23,91.0,90.2
    23,91.5,90.8
    23,92.0,91.3
    23,92.5,91.8
    23,93.0,92.3
    23,93.5,92.8
    23,94.0,93.3
    24,13.5,12.6
    24,14.0,13.1
    24,14.5,13.5
    24,15.0,14.0
    24,15.5,14.5
    24,16.0,15.0
    24,16.5,15.4
    24,17.0,15.9
    24,17.5,16.4
    24,18.0,16.9
    24,18.5,17.3
    24,19.0,17.8
    24,19.5,18.3
    24,20.0,18.8
    24,20.5,19.2
    24,21.0,19.7
    24,21.5,20.2
    24,22.0,20.7
    24,22.5,21.1
    24,23.0,21.6
    24,23.5,22.1
    24,24.0,22.6
    24,24.5,23.1
    24,25.0,23.5
    24,25.5,24.0
    24,26.0,24.5
    24,26.5,25.0
    24,27.0,25.5
    24,27.5,26.0
    24,28.0,26.4
    24,28.5,26.9
    24,29.0,27.4
    24,29.5,27.9
    24,30.0,28.4
    24,30.5,28.9
    24,31.0,29.4
    24,31.5,29.9
    24,32.0,30.4
    24,32.5,30.9
    24,33.0,31.4
    24,33.5,31.9
    24,34.0,32.4
    24,34.5,32.9
    24,35.0,33.4
    24,35.5,33.9
    24,36.0,34.4
    24,36.5,34.9
    24,37.0,35.4
    24,37.5,35.9
    24,38.0,36.4
    24,38.5,36.9
    24,39.0,37.4
    24,39.5,37.9
    24,40.0,38.4
    24,40.5,38.9
    24,41.0,39.4
    24,41.5,39.9
    24,42.0,40.4
    24,42.5,40.9
    24,43.0,41.4
    24,43.5,41.9
    24,44.0,42.4
    24,44.5,42.9
    24,45.0,43.4
    24,45.5,44.0
    24,46.0,44.5
    24,46.5,45.0
    24,47.0,45.5
    24,47.5,46.0
    24,48.0,46.5
    24,48.5,47.0
    24,49.0,47.5
    24,49.5,48.0
    24,50.0,48.5
    24,50.5,49.0
    24,51.0,49.5
    24,51.5,50.0
    24,52.0,50.5
    24,52.5,51.0
    24,53.0,51.5
    24,53.5,52.0
    24,54.0,52.5
    24,54.5,53.0
    24,55.0,53.5
    24,55.5,54.1
    24,56.0,54.6
    24,56.5,55.1
    24,57.0,55.6
    24,57.5,56.1
    24,58.0,56.6
    24,58.5,57.1
    24,59.0,57.6
    24,59.5,58.1
    24,60.0,58.6
    24,60.5,59.1
    24,61.0,59.6
    24,61.5,60.1
    24,62.0,60.6
    24,62.5,61.1
    24,63.0,61.6
    24,63.5,62.1
    24,64.0,62.6
    24,64.5,63.1
    24,65.0,63.6
    24,65.5,64.1
    24,66.0,64.6
    24,66.5,65.2
    24,67.0,65.7
    24,67.5,66.2
    24,68.0,66.7
    24,68.5,67.2
    24,69.0,67.7
    24,69.5,68.2
    24,70.0,68.7
    24,70.5,69.2
    24,71.0,69.7
    24,71.5,70.2
    24,72.0,70.7
    24,72.5,71.2
    24,73.0,71.7
    24,73.5,72.2
    24,74.0,72.7
    24,74.5,73.2
    24,75.0,73.7
    24,75.5,74.2
    24,76.0,74.7
    24,76.5,75.3
    24,77.0,75.8
    24,77.5,76.3
    24,78.0,76.8
    24,78.5,77.3
    24,79.0,77.8
    24,79.5,78.3
    24,80.0,78.8
    24,80.5,79.3
    24,81.0,79.8
    24,81.5,80.3
    24,82.0,80.8
    24,82.5,81.3
    24,83.0,81.8
    24,83.5,82.3
    24,84.0,82.8
    24,84.5,83.4
    24,85.0,83.9
    24,85.5,84.4
    24,86.0,84.9
    24,86.5,85.4
    24,87.0,85.9
    24,87.5,86.4
    24,88.0,86.9
    24,88.5,87.4
    24,89.0,87.9
    24,89.5,88.4
    24,90.0,89.0
    24,90.5,89.5
    24,91.0,90.0
    24,91.5,90.5
    24,92.0,91.0
    24,92.5,91.5
    24,93.0,92.0
    24,93.5,92.6
    24,94.0,93.1
    25,13.5,12.3
    25,14.0,12.8
    25,14.5,13.3
    25,15.0,13.8
    25,15.5,14.2
    25,16.0,14.7
    25,16.5,15.2
    25,17.0,15.6
    25,17.5,16.1
    25,18.0,16.6
    25,18.5,17.0
    25,19.0,17.5
    25,19.5,18.0
    25,20.0,18.4
    25,20.5,18.9
    25,21.0,19.4
    25,21.5,19.9
    25,22.0,20.3
    25,22.5,20.8
    25,23.0,21.3
    25,23.5,21.7
    25,24.0,22.2
    25,24.5,22.7
    25,25.0,23.2
    25,25.5,23.7
    25,26.0,24.1
    25,26.5,24.6
    25,27.0,25.1
    25,27.5,25.6
    25,28.0,26.1
    25,28.5,26.5
    25,29.0,27.0
    25,29.5,27.5
    25,30.0,28.0
    25,30.5,28.5
    25,31.0,29.0
    25,31.5,29.5
    25,32.0,30.0
    25,32.5,30.5
    25,33.0,31.0
    25,33.5,31.5
    25,34.0,32.0
    25,34.5,32.5
    25,35.0,33.0
    25,35.5,33.5
    25,36.0,34.0
    25,36.5,34.5
    25,37.0,35.0
    25,37.5,35.5
    25,38.0,36.0
    25,38.5,36.5
    25,39.0,37.0
    25,39.5,37.5
    25,40.0,38.0
    25,40.5,38.5
    25,41.0,39.0
    25,41.5,39.5
    25,42.0,40.0
    25,42.5,40.5
    25,43.0,41.0
    25,43.5,41.5
    25,44.0,42.0
    25,44.5,42.5
    25,45.0,43.1
    25,45.5,43.6
    25,46.0,44.1
    25,46.5,44.6
    25,47.0,45.1
    25,47.5,45.6
    25,48.0,46.1
    25,48.5,46.6
    25,49.0,47.1
    25,49.5,47.6
    25,50.0,48.1
    25,50.5,48.6
    25,51.0,49.1
    25,51.5,49.6
    25,52.0,50.1
    25,52.5,50.7
    25,53.0,51.2
    25,53.5,51.7
    25,54.0,52.2
    25,54.5,52.7
    25,55.0,53.2
    25,55.5,53.7
    25,56.0,54.2
    25,56.5,54.7
    25,57.0,55.2
    25,57.5,55.7
    25,58.0,56.2
    25,58.5,56.7
    25,59.0,57.2
    25,59.5,57.7
    25,60.0,58.2
    25,60.5,58.7
    25,61.0,59.2
    25,61.5,59.8
    25,62.0,60.3
    25,62.5,60.8
    25,63.0,61.3
    25,63.5,61.8
    25,64.0,62.3
    25,64.5,62.8
    25,65.0,63.3
    25,65.5,63.8
    25,66.0,64.3
    25,66.5,64.8
    25,67.0,65.3
    25,67.5,65.8
    25,68.0,66.3
    25,68.5,66.8
    25,69.0,67.3
    25,69.5,67.8
    25,70.0,68.4
    25,70.5,68.9
    25,71.0,69.4
    25,71.5,69.9
    25,72.0,70.4
    25,72.5,70.9
    25,73.0,71.4
    25,73.5,71.9
    25,74.0,72.4
    25,74.5,72.9
    25,75.0,73.4
    25,75.5,73.9
    25,76.0,74.4
    25,76.5,74.9
    25,77.0,75.4
    25,77.5,76.0
    25,78.0,76.5
    25,78.5,77.0
    25,79.0,77.5
    25,79.5,78.0
    25,80.0,78.5
    25,80.5,79.0
    25,81.0,79.5
    25,81.5,80.0
    25,82.0,80.5
    25,82.5,81.0
    25,83.0,81.5
    25,83.5,82.0
    25,84.0,82.6
    25,84.5,83.1
    25,85.0,83.6
    25,85.5,84.1
    25,86.0,84.6
    25,86.5,85.1
    25,87.0,85.6
    25,87.5,86.1
    25,88.0,86.6
    25,88.5,87.2
    25,89.0,87.7
    25,89.5,88.2
    25,90.0,88.7
    25,90.5,89.2
    25,91.0,89.7
    25,91.5,90.2
    25,92.0,90.8
    25,92.5,91.3
    25,93.0,91.8
    25,93.5,92.3
    25,94.0,92.8
    26,13.5,12.1
    26,14.0,12.6
    26,14.5,13.0
    26,15.0,13.5
    26,15.5,14.0
    26,16.0,14.4
    26,16.5,14.9
    26,17.0,15.4
    26,17.5,15.8
    26,18.0,16.3
    26,18.5,16.7
    26,19.0,17.2
    26,19.5,17.7
    26,20.0,18.1
    26,20.5,18.6
    26,21.0,19.1
    26,21.5,19.5
    26,22.0,20.0
    26,22.5,20.5
    26,23.0,20.9
    26,23.5,21.4
    26,24.0,21.9
    26,24.5,22.3
    26,25.0,22.8
    26,25.5,23.3
    26,26.0,23.8
    26,26.5,24.2
    26,27.0,24.7
    26,27.5,25.2
    26,28.0,25.7
    26,28.5,26.2
    26,29.0,26.6
    26,29.5,27.1
    26,30.0,27.6
    26,30.5,28.1
    26,31.0,28.6
    26,31.5,29.1
    26,32.0,29.6
    26,32.5,30.1
    26,33.0,30.6
    26,33.5,31.1
    26,34.0,31.6
    26,34.5,32.1
    26,35.0,32.6
    26,35.5,33.1
    26,36.0,33.6
    26,36.5,34.1
    26,37.0,34.6
    26,37.5,35.1
    26,38.0,35.6
    26,38.5,36.1
    26,39.0,36.6
    26,39.5,37.1
    26,40.0,37.6
    26,40.5,38.1
    26,41.0,38.6
    26,41.5,39.1
    26,42.0,39.6
    26,42.5,40.1
    26,43.0,40.6
    26,43.5,41.1
    26,44.0,41.6
    26,44.5,42.2
    26,45.0,42.7
    26,45.5,43.2
    26,46.0,43.7
    26,46.5,44.2
    26,47.0,44.7
    26,47.5,45.2
    26,48.0,45.7
    26,48.5,46.2
    26,49.0,46.7
    26,49.5,47.2
    26,50.0,47.7
    26,50.5,48.3
    26,51.0,48.8
    26,51.5,49.3
    26,52.0,49.8
    26,52.5,50.3
    26,53.0,50.8
    26,53.5,51.3
    26,54.0,51.8
    26,54.5,52.3
    26,55.0,52.8
    26,55.5,53.3
    26,56.0,53.8
    26,56.5,54.3
    26,57.0,54.8
    26,57.5,55.3
    26,58.0,55.9
    26,58.5,56.4
    26,59.0,56.9
    26,59.5,57.4
    26,60.0,57.9
    26,60.5,58.4
    26,61.0,58.9
    26,61.5,59.4
    26,62.0,59.9
    26,62.5,60.4
    26,63.0,60.9
    26,63.5,61.4
    26,64.0,61.9
    26,64.5,62.4
    26,65.0,62.9
    26,65.5,63.5
    26,66.0,64.0
    26,66.5,64.5
    26,67.0,65.0
    26,67.5,65.5
    26,68.0,66.0
    26,68.5,66.5
    26,69.0,67.0
    26,69.5,67.5
    26,70.0,68.0
    26,70.5,68.5
    26,71.0,69.0
    26,71.5,69.5
    26,72.0,70.0
    26,72.5,70.6
    26,73.0,71.1
    26,73.5,71.6
    26,74.0,72.1
    26,74.5,72.6
    26,75.0,73.1
    26,75.5,73.6
    26,76.0,74.1
    26,76.5,74.6
    26,77.0,75.1
    26,77.5,75.6
    26,78.0,76.1
    26,78.5,76.7
    26,79.0,77.2
    26,79.5,77.7
    26,80.0,78.2
    26,80.5,78.7
    26,81.0,79.2
    26,81.5,79.7
    26,82.0,80.2
    26,82.5,80.7
    26,83.0,81.2
    26,83.5,81.7
    26,84.0,82.3
    26,84.5,82.8
    26,85.0,83.3
    26,85.5,83.8
    26,86.0,84.3
    26,86.5,84.8
    26,87.0,85.3
    26,87.5,85.8
    26,88.0,86.4
    26,88.5,86.9
    26,89.0,87.4
    26,89.5,87.9
    26,90.0,88.4
    26,90.5,88.9
    26,91.0,89.5
    26,91.5,90.0
    26,92.0,90.5
    26,92.5,91.0
    26,93.0,91.5
    26,93.5,92.1
    26,94.0,92.6
    27,13.5,11.9
    27,14.0,12.3
    27,14.5,12.8
    27,15.0,13.2
    27,15.5,13.7
    27,16.0,14.2
    27,16.5,14.6
    27,17.0,15.1
    27,17.5,15.5
    27,18.0,16.0
    27,18.5,16.4
    27,19.0,16.9
    27,19.5,17.4
    27,20.0,17.8
    27,20.5,18.3
    27,21.0,18.7
    27,21.5,19.2
    27,22.0,19.7
    27,22.5,20.1
    27,23.0,20.6
    27,23.5,21.0
    27,24.0,21.5
    27,24.5,22.0
    27,25.0,22.5
    27,25.5,22.9
    27,26.0,23.4
    27,26.5,23.9
    27,27.0,24.3
    27,27.5,24.8
    27,28.0,25.3
    27,28.5,25.8
    27,29.0,26.3
    27,29.5,26.7
    27,30.0,27.2
    27,30.5,27.7
    27,31.0,28.2
    27,31.5,28.7
    27,32.0,29.2
    27,32.5,29.7
    27,33.0,30.2
    27,33.5,30.7
    27,34.0,31.2
    27,34.5,31.7
    27,35.0,32.2
    27,35.5,32.7
    27,36.0,33.2
    27,36.5,33.7
    27,37.0,34.2
    27,37.5,34.7
    27,38.0,35.2
    27,38.5,35.7
    27,39.0,36.2
    27,39.5,36.7
    27,40.0,37.2
    27,40.5,37.7
    27,41.0,38.2
    27,41.5,38.7
    27,42.0,39.2
    27,42.5,39.7
    27,43.0,40.2
    27,43.5,40.7
    27,44.0,41.3
    27,44.5,41.8
    27,45.0,42.3
    27,45.5,42.8
    27,46.0,43.3
    27,46.5,43.8
    27,47.0,44.3
    27,47.5,44.8
    27,48.0,45.3
    27,48.5,45.8
    27,49.0,46.3
    27,49.5,46.9
    27,50.0,47.4
    27,50.5,47.9
    27,51.0,48.4
    27,51.5,48.9
    27,52.0,49.4
    27,52.5,49.9
    27,53.0,50.4
    27,53.5,50.9
    27,54.0,51.4
    27,54.5,51.9
    27,55.0,52.4
    27,55.5,53.0
    27,56.0,53.5
    27,56.5,54.0
    27,57.0,54.5
    27,57.5,55.0
    27,58.0,55.5
    27,58.5,56.0
    27,59.0,56.5
    27,59.5,57.0
    27,60.0,57.5
    27,60.5,58.0
    27,61.0,58.5
    27,61.5,59.0
    27,62.0,59.6
    27,62.5,60.1
    27,63.0,60.6
    27,63.5,61.1
    27,64.0,61.6
    27,64.5,62.1
    27,65.0,62.6
    27,65.5,63.1
    27,66.0,63.6
    27,66.5,64.1
    27,67.0,64.6
    27,67.5,65.1
    27,68.0,65.6
    27,68.5,66.2
    27,69.0,66.7
    27,69.5,67.2
    27,70.0,67.7
    27,70.5,68.2
    27,71.0,68.7
    27,71.5,69.2
    27,72.0,69.7
    27,72.5,70.2
    27,73.0,70.7
    27,73.5,71.2
    27,74.0,71.8
    27,74.5,72.3
    27,75.0,72.8
    27,75.5,73.3
    27,76.0,73.8
    27,76.5,74.3
    27,77.0,74.8
    27,77.5,75.3
    27,78.0,75.8
    27,78.5,76.3
    27,79.0,76.9
    27,79.5,77.4
    27,80.0,77.9
    27,80.5,78.4
    27,81.0,78.9
    27,81.5,79.4
    27,82.0,79.9
    27,82.5,80.4
    27,83.0,80.9
    27,83.5,81.4
    27,84.0,82.0
    27,84.5,82.5
    27,85.0,83.0
    27,85.5,83.5
    27,86.0,84.0
    27,86.5,84.5
    27,87.0,85.0
    27,87.5,85.6
    27,88.0,86.1
    27,88.5,86.6
    27,89.0,87.1
    27,89.5,87.6
    27,90.0,88.2
    27,90.5,88.7
    27,91.0,89.2
    27,91.5,89.7
    27,92.0,90.2
    27,92.5,90.8
    27,93.0,91.3
    27,93.5,91.8
    27,94.0,92.4
    28,13.5,11.6
    28,14.0,12.1
    28,14.5,12.5
    28,15.0,13.0
    28,15.5,13.4
    28,16.0,13.9
    28,16.5,14.3
    28,17.0,14.8
    28,17.5,15.2
    28,18.0,15.7
    28,18.5,16.1
    28,19.0,16.6
    28,19.5,17.1
    28,20.0,17.5
    28,20.5,18.0
    28,21.0,18.4
    28,21.5,18.9
    28,22.0,19.3
    28,22.5,19.8
    28,23.0,20.2
    28,23.5,20.7
    28,24.0,21.2
    28,24.5,21.6
    28,25.0,22.1
    28,25.5,22.6
    28,26.0,23.0
    28,26.5,23.5
    28,27.0,24.0
    28,27.5,24.4
    28,28.0,24.9
    28,28.5,25.4
    28,29.0,25.9
    28,29.5,26.4
    28,30.0,26.8
    28,30.5,27.3
    28,31.0,27.8
    28,31.5,28.3
    28,32.0,28.8
    28,32.5,29.3
    28,33.0,29.8
    28,33.5,30.3
    28,34.0,30.8
    28,34.5,31.3
    28,35.0,31.7
    28,35.5,32.2
    28,36.0,32.7
    28,36.5,33.2
    28,37.0,33.8
    28,37.5,34.3
    28,38.0,34.8
    28,38.5,35.3
    28,39.0,35.8
    28,39.5,36.3
    28,40.0,36.8
    28,40.5,37.3
    28,41.0,37.8
    28,41.5,38.3
    28,42.0,38.8
    28,42.5,39.3
    28,43.0,39.8
    28,43.5,40.3
    28,44.0,40.9
    28,44.5,41.4
    28,45.0,41.9
    28,45.5,42.4
    28,46.0,42.9
    28,46.5,43.4
    28,47.0,43.9
    28,47.5,44.4
    28,48.0,44.9
    28,48.5,45.5
    28,49.0,46.0
    28,49.5,46.5
    28,50.0,47.0
    28,50.5,47.5
    28,51.0,48.0
    28,51.5,48.5
    28,52.0,49.0
    28,52.5,49.5
    28,53.0,50.0
    28,53.5,50.6
    28,54.0,51.1
    28,54.5,51.6
    28,55.0,52.1
    28,55.5,52.6
    28,56.0,53.1
    28,56.5,53.6
    28,57.0,54.1
    28,57.5,54.6
    28,58.0,55.1
    28,58.5,55.6
    28,59.0,56.1
    28,59.5,56.7
    28,60.0,57.2
    28,60.5,57.7
    28,61.0,58.2
    28,61.5,58.7
    28,62.0,59.2
    28,62.5,59.7
    28,63.0,60.2
    28,63.5,60.7
    28,64.0,61.2
    28,64.5,61.7
    28,65.0,62.3
    28,65.5,62.8
    28,66.0,63.3
    28,66.5,63.8
    28,67.0,64.3
    28,67.5,64.8
    28,68.0,65.3
    28,68.5,65.8
    28,69.0,66.3
    28,69.5,66.8
    28,70.0,67.3
    28,70.5,67.9
    28,71.0,68.4
    28,71.5,68.9
    28,72.0,69.4
    28,72.5,69.9
    28,73.0,70.4
    28,73.5,70.9
    28,74.0,71.4
    28,74.5,71.9
    28,75.0,72.5
    28,75.5,73.0
    28,76.0,73.5
    28,76.5,74.0
    28,77.0,74.5
    28,77.5,75.0
    28,78.0,75.5
    28,78.5,76.0
    28,79.0,76.5
    28,79.5,77.1
    28,80.0,77.6
    28,80.5,78.1
    28,81.0,78.6
    28,81.5,79.1
    28,82.0,79.6
    28,82.5,80.1
    28,83.0,80.6
    28,83.5,81.2
    28,84.0,81.7
    28,84.5,82.2
    28,85.0,82.7
    28,85.5,83.2
    28,86.0,83.7
    28,86.5,84.2
    28,87.0,84.8
    28,87.5,85.3
    28,88.0,85.8
    28,88.5,86.3
    28,89.0,86.8
    28,89.5,87.4
    28,90.0,87.9
    28,90.5,88.4
    28,91.0,88.9
    28,91.5,89.5
    28,92.0,90.0
    28,92.5,90.5
    28,93.0,91.0
    28,93.5,91.6
    28,94.0,92.1
    29,13.5,11.4
    29,14.0,11.8
    29,14.5,12.3
    29,15.0,12.7
    29,15.5,13.2
    29,16.0,13.6
    29,16.5,14.1
    29,17.0,14.5
    29,17.5,15.0
    29,18.0,15.4
    29,18.5,15.8
    29,19.0,16.3
    29,19.5,16.7
    29,20.0,17.2
    29,20.5,17.6
    29,21.0,18.1
    29,21.5,18.5
    29,22.0,19.0
    29,22.5,19.4
    29,23.0,19.9
    29,23.5,20.4
    29,24.0,20.8
    29,24.5,21.3
    29,25.0,21.7
    29,25.5,22.2
    29,26.0,22.7
    29,26.5,23.1
    29,27.0,23.6
    29,27.5,24.1
    29,28.0,24.5
    29,28.5,25.0
    29,29.0,25.5
    29,29.5,26.0
    29,30.0,26.4
    29,30.5,26.9
    29,31.0,27.4
    29,31.5,27.9
    29,32.0,28.4
    29,32.5,28.9
    29,33.0,29.4
    29,33.5,29.9
    29,34.0,30.4
    29,34.5,30.8
    29,35.0,31.3
    29,35.5,31.8
    29,36.0,32.3
    29,36.5,32.8
    29,37.0,33.3
    29,37.5,33.8
    29,38.0,34.4
    29,38.5,34.9
    29,39.0,35.4
    29,39.5,35.9
    29,40.0,36.4
    29,40.5,36.9
    29,41.0,37.4
    29,41.5,37.9
    29,42.0,38.4
    29,42.5,38.9
    29,43.0,39.4
    29,43.5,39.9
    29,44.0,40.5
    29,44.5,41.0
    29,45.0,41.5
    29,45.5,42.0
    29,46.0,42.5
    29,46.5,43.0
    29,47.0,43.5
    29,47.5,44.0
    29,48.0,44.6
    29,48.5,45.1
    29,49.0,45.6
    29,49.5,46.1
    29,50.0,46.6
    29,50.5,47.1
    29,51.0,47.6
    29,51.5,48.1
    29,52.0,48.6
    29,52.5,49.2
    29,53.0,49.7
    29,53.5,50.2
    29,54.0,50.7
    29,54.5,51.2
    29,55.0,51.7
    29,55.5,52.2
    29,56.0,52.7
    29,56.5,53.2
    29,57.0,53.7
    29,57.5,54.3
    29,58.0,54.8
    29,58.5,55.3
    29,59.0,55.8
    29,59.5,56.3
    29,60.0,56.8
    29,60.5,57.3
    29,61.0,57.8
    29,61.5,58.3
    29,62.0,58.8
    29,62.5,59.4
    29,63.0,59.9
    29,63.5,60.4
    29,64.0,60.9
    29,64.5,61.4
    29,65.0,61.9
    29,65.5,62.4
    29,66.0,62.9
    29,66.5,63.4
    29,67.0,63.9
    29,67.5,64.5
    29,68.0,65.0
    29,68.5,65.5
    29,69.0,66.0
    29,69.5,66.5
    29,70.0,67.0
    29,70.5,67.5
    29,71.0,68.0
    29,71.5,68.5
    29,72.0,69.1
    29,72.5,69.6
    29,73.0,70.1
    29,73.5,70.6
    29,74.0,71.1
    29,74.5,71.6
    29,75.0,72.1
    29,75.5,72.6
    29,76.0,73.1
    29,76.5,73.7
    29,77.0,74.2
    29,77.5,74.7
    29,78.0,75.2
    29,78.5,75.7
    29,79.0,76.2
    29,79.5,76.7
    29,80.0,77.3
    29,80.5,77.8
    29,81.0,78.3
    29,81.5,78.8
    29,82.0,79.3
    29,82.5,79.8
    29,83.0,80.3
    29,83.5,80.9
    29,84.0,81.4
    29,84.5,81.9
    29,85.0,82.4
    29,85.5,82.9
    29,86.0,83.4
    29,86.5,84.0
    29,87.0,84.5
    29,87.5,85.0
    29,88.0,85.5
    29,88.5,86.0
    29,89.0,86.6
    29,89.5,87.1
    29,90.0,87.6
    29,90.5,88.1
    29,91.0,88.7
    29,91.5,89.2
    29,92.0,89.7
    29,92.5,90.3
    29,93.0,90.8
    29,93.5,91.3
    29,94.0,91.9
    30,13.5,11.1
    30,14.0,11.6
    30,14.5,12.0
    30,15.0,12.4
    30,15.5,12.9
    30,16.0,13.3
    30,16.5,13.8
    30,17.0,14.2
    30,17.5,14.7
    30,18.0,15.1
    30,18.5,15.5
    30,19.0,16.0
    30,19.5,16.4
    30,20.0,16.9
    30,20.5,17.3
    30,21.0,17.8
    30,21.5,18.2
    30,22.0,18.7
    30,22.5,19.1
    30,23.0,19.6
    30,23.5,20.0
    30,24.0,20.5
    30,24.5,20.9
    30,25.0,21.4
    30,25.5,21.8
    30,26.0,22.3
    30,26.5,22.8
    30,27.0,23.2
    30,27.5,23.7
    30,28.0,24.2
    30,28.5,24.6
    30,29.0,25.1
    30,29.5,25.6
    30,30.0,26.1
    30,30.5,26.5
    30,31.0,27.0
    30,31.5,27.5
    30,32.0,28.0
    30,32.5,28.5
    30,33.0,29.0
    30,33.5,29.5
    30,34.0,29.9
    30,34.5,30.4
    30,35.0,30.9
    30,35.5,31.4
    30,36.0,31.9
    30,36.5,32.4
    30,37.0,32.9
    30,37.5,33.4
    30,38.0,33.9
    30,38.5,34.5
    30,39.0,35.0
    30,39.5,35.5
    30,40.0,36.0
    30,40.5,36.5
    30,41.0,37.0
    30,41.5,37.5
    30,42.0,38.0
    30,42.5,38.5
    30,43.0,39.0
    30,43.5,39.6
    30,44.0,40.1
    30,44.5,40.6
    30,45.0,41.1
    30,45.5,41.6
    30,46.0,42.1
    30,46.5,42.6
    30,47.0,43.1
    30,47.5,43.7
    30,48.0,44.2
    30,48.5,44.7
    30,49.0,45.2
    30,49.5,45.7
    30,50.0,46.2
    30,50.5,46.7
    30,51.0,47.2
    30,51.5,47.8
    30,52.0,48.3
    30,52.5,48.8
    30,53.0,49.3
    30,53.5,49.8
    30,54.0,50.3
    30,54.5,50.8
    30,55.0,51.3
    30,55.5,51.9
    30,56.0,52.4
    30,56.5,52.9
    30,57.0,53.4
    30,57.5,53.9
    30,58.0,54.4
    30,58.5,54.9
    30,59.0,55.4
    30,59.5,55.9
    30,60.0,56.4
    30,60.5,57.0
    30,61.0,57.5
    30,61.5,58.0
    30,62.0,58.5
    30,62.5,59.0
    30,63.0,59.5
    30,63.5,60.0
    30,64.0,60.5
    30,64.5,61.0
    30,65.0,61.6
    30,65.5,62.1
    30,66.0,62.6
    30,66.5,63.1
    30,67.0,63.6
    30,67.5,64.1
    30,68.0,64.6
    30,68.5,65.1
    30,69.0,65.6
    30,69.5,66.2
    30,70.0,66.7
    30,70.5,67.2
    30,71.0,67.7
    30,71.5,68.2
    30,72.0,68.7
    30,72.5,69.2
    30,73.0,69.7
    30,73.5,70.3
    30,74.0,70.8
    30,74.5,71.3
    30,75.0,71.8
    30,75.5,72.3
    30,76.0,72.8
    30,76.5,73.3
    30,77.0,73.9
    30,77.5,74.4
    30,78.0,74.9
    30,78.5,75.4
    30,79.0,75.9
    30,79.5,76.4
    30,80.0,76.9
    30,80.5,77.5
    30,81.0,78.0
    30,81.5,78.5
    30,82.0,79.0
    30,82.5,79.5
    30,83.0,80.0
    30,83.5,80.5
    30,84.0,81.1
    30,84.5,81.6
    30,85.0,82.1
    30,85.5,82.6
    30,86.0,83.1
    30,86.5,83.7
    30,87.0,84.2
    30,87.5,84.7
    30,88.0,85.2
    30,88.5,85.8
    30,89.0,86.3
    30,89.5,86.8
    30,90.0,87.3
    30,90.5,87.9
    30,91.0,88.4
    30,91.5,88.9
    30,92.0,89.5
    30,92.5,90.0
    30,93.0,90.5
    30,93.5,91.1
    30,94.0,91.6
    31,13.5,10.8
    31,14.0,11.3
    31,14.5,11.7
    31,15.0,12.2
    31,15.5,12.6
    31,16.0,13.1
    31,16.5,13.5
    31,17.0,13.9
    31,17.5,14.4
    31,18.0,14.8
    31,18.5,15.3
    31,19.0,15.7
    31,19.5,16.1
    31,20.0,16.6
    31,20.5,17.0
    31,21.0,17.4
    31,21.5,17.9
    31,22.0,18.3
    31,22.5,18.8
    31,23.0,19.2
    31,23.5,19.7
    31,24.0,20.1
    31,24.5,20.6
    31,25.0,21.0
    31,25.5,21.5
    31,26.0,21.9
    31,26.5,22.4
    31,27.0,22.9
    31,27.5,23.3
    31,28.0,23.8
    31,28.5,24.2
    31,29.0,24.7
    31,29.5,25.2
    31,30.0,25.7
    31,30.5,26.1
    31,31.0,26.6
    31,31.5,27.1
    31,32.0,27.6
    31,32.5,28.1
    31,33.0,28.6
    31,33.5,29.1
    31,34.0,29.5
    31,34.5,30.0
    31,35.0,30.5
    31,35.5,31.0
    31,36.0,31.5
    31,36.5,32.0
    31,37.0,32.5
    31,37.5,33.0
    31,38.0,33.5
    31,38.5,34.0
    31,39.0,34.6
    31,39.5,35.1
    31,40.0,35.6
    31,40.5,36.1
    31,41.0,36.6
    31,41.5,37.1
    31,42.0,37.6
    31,42.5,38.1
    31,43.0,38.6
    31,43.5,39.2
    31,44.0,39.7
    31,44.5,40.2
    31,45.0,40.7
    31,45.5,41.2
    31,46.0,41.7
    31,46.5,42.2
    31,47.0,42.7
    31,47.5,43.3
    31,48.0,43.8
    31,48.5,44.3
    31,49.0,44.8
    31,49.5,45.3
    31,50.0,45.8
    31,50.5,46.3
    31,51.0,46.9
    31,51.5,47.4
    31,52.0,47.9
    31,52.5,48.4
    31,53.0,48.9
    31,53.5,49.4
    31,54.0,49.9
    31,54.5,50.5
    31,55.0,51.0
    31,55.5,51.5
    31,56.0,52.0
    31,56.5,52.5
    31,57.0,53.0
    31,57.5,53.5
    31,58.0,54.0
    31,58.5,54.6
    31,59.0,55.1
    31,59.5,55.6
    31,60.0,56.1
    31,60.5,56.6
    31,61.0,57.1
    31,61.5,57.6
    31,62.0,58.1
    31,62.5,58.6
    31,63.0,59.2
    31,63.5,59.7
    31,64.0,60.2
    31,64.5,60.7
    31,65.0,61.2
    31,65.5,61.7
    31,66.0,62.2
    31,66.5,62.7
    31,67.0,63.3
    31,67.5,63.8
    31,68.0,64.3
    31,68.5,64.8
    31,69.0,65.3
    31,69.5,65.8
    31,70.0,66.3
    31,70.5,66.8
    31,71.0,67.4
    31,71.5,67.9
    31,72.0,68.4
    31,72.5,68.9
    31,73.0,69.4
    31,73.5,69.9
    31,74.0,70.4
    31,74.5,71.0
    31,75.0,71.5
    31,75.5,72.0
    31,76.0,72.5
    31,76.5,73.0
    31,77.0,73.5
    31,77.5,74.0
    31,78.0,74.6
    31,78.5,75.1
    31,79.0,75.6
    31,79.5,76.1
    31,80.0,76.6
    31,80.5,77.1
    31,81.0,77.7
    31,81.5,78.2
    31,82.0,78.7
    31,82.5,79.2
    31,83.0,79.7
    31,83.5,80.2
    31,84.0,80.8
    31,84.5,81.3
    31,85.0,81.8
    31,85.5,82.3
    31,86.0,82.8
    31,86.5,83.4
    31,87.0,83.9
    31,87.5,84.4
    31,88.0,84.9
    31,88.5,85.5
    31,89.0,86.0
    31,89.5,86.5
    31,90.0,87.1
    31,90.5,87.6
    31,91.0,88.1
    31,91.5,88.7
    31,92.0,89.2
    31,92.5,89.7
    31,93.0,90.3
    31,93.5,90.8
    31,94.0,91.4
    32,13.5,10.6
    32,14.0,11.0
    32,14.5,11.5
    32,15.0,11.9
    32,15.5,12.3
    32,16.0,12.8
    32,16.5,13.2
    32,17.0,13.6
    32,17.5,14.1
    32,18.0,14.5
    32,18.5,14.9
    32,19.0,15.4
    32,19.5,15.8
    32,20.0,16.3
    32,20.5,16.7
    32,21.0,17.1
    32,21.5,17.6
    32,22.0,18.0
    32,22.5,18.4
    32,23.0,18.9
    32,23.5,19.3
    32,24.0,19.8
    32,24.5,20.2
    32,25.0,20.7
    32,25.5,21.1
    32,26.0,21.6
    32,26.5,22.0
    32,27.0,22.5
    32,27.5,22.9
    32,28.0,23.4
    32,28.5,23.9
    32,29.0,24.3
    32,29.5,24.8
    32,30.0,25.3
    32,30.5,25.8
    32,31.0,26.2
    32,31.5,26.7
    32,32.0,27.2
    32,32.5,27.7
    32,33.0,28.2
    32,33.5,28.7
    32,34.0,29.1
    32,34.5,29.6
    32,35.0,30.1
    32,35.5,30.6
    32,36.0,31.1
    32,36.5,31.6
    32,37.0,32.1
    32,37.5,32.6
    32,38.0,33.1
    32,38.5,33.6
    32,39.0,34.1
    32,39.5,34.7
    32,40.0,35.2
    32,40.5,35.7
    32,41.0,36.2
    32,41.5,36.7
    32,42.0,37.2
    32,42.5,37.7
    32,43.0,38.2
    32,43.5,38.8
    32,44.0,39.3
    32,44.5,39.8
    32,45.0,40.3
    32,45.5,40.8
    32,46.0,41.3
    32,46.5,41.8
    32,47.0,42.4
    32,47.5,42.9
    32,48.0,43.4
    32,48.5,43.9
    32,49.0,44.4
    32,49.5,44.9
    32,50.0,45.5
    32,50.5,46.0
    32,51.0,46.5
    32,51.5,47.0
    32,52.0,47.5
    32,52.5,48.0
    32,53.0,48.5
    32,53.5,49.1
    32,54.0,49.6
    32,54.5,50.1
    32,55.0,50.6
    32,55.5,51.1
    32,56.0,51.6
    32,56.5,52.1
    32,57.0,52.6
    32,57.5,53.2
    32,58.0,53.7
    32,58.5,54.2
    32,59.0,54.7
    32,59.5,55.2
    32,60.0,55.7
    32,60.5,56.2
    32,61.0,56.7
    32,61.5,57.3
    32,62.0,57.8
    32,62.5,58.3
    32,63.0,58.8
    32,63.5,59.3
    32,64.0,59.8
    32,64.5,60.3
    32,65.0,60.8
    32,65.5,61.4
    32,66.0,61.9
    32,66.5,62.4
    32,67.0,62.9
    32,67.5,63.4
    32,68.0,63.9
    32,68.5,64.4
    32,69.0,65.0
    32,69.5,65.5
    32,70.0,66.0
    32,70.5,66.5
    32,71.0,67.0
    32,71.5,67.5
    32,72.0,68.0
    32,72.5,68.6
    32,73.0,69.1
    32,73.5,69.6
    32,74.0,70.1
    32,74.5,70.6
    32,75.0,71.1
    32,75.5,71.7
    32,76.0,72.2
    32,76.5,72.7
    32,77.0,73.2
    32,77.5,73.7
    32,78.0,74.2
    32,78.5,74.8
    32,79.0,75.3
    32,79.5,75.8
    32,80.0,76.3
    32,80.5,76.8
    32,81.0,77.3
    32,81.5,77.9
    32,82.0,78.4
    32,82.5,78.9
    32,83.0,79.4
    32,83.5,79.9
    32,84.0,80.5
    32,84.5,81.0
    32,85.0,81.5
    32,85.5,82.0
    32,86.0,82.6
    32,86.5,83.1
    32,87.0,83.6
    32,87.5,84.1
    32,88.0,84.7
    32,88.5,85.2
    32,89.0,85.7
    32,89.5,86.2
    32,90.0,86.8
    32,90.5,87.3
    32,91.0,87.8
    32,91.5,88.4
    32,92.0,88.9
    32,92.5,89.5
    32,93.0,90.0
    32,93.5,90.6
    32,94.0,91.1
    33,13.5,10.3
    33,14.0,10.8
    33,14.5,11.2
    33,15.0,11.6
    33,15.5,12.1
    33,16.0,12.5
    33,16.5,12.9
    33,17.0,13.4
    33,17.5,13.8
    33,18.0,14.2
    33,18.5,14.6
    33,19.0,15.1
    33,19.5,15.5
    33,20.0,15.9
    33,20.5,16.4
    33,21.0,16.8
    33,21.5,17.2
    33,22.0,17.7
    33,22.5,18.1
    33,23.0,18.5
    33,23.5,19.0
    33,24.0,19.4
    33,24.5,19.9
    33,25.0,20.3
    33,25.5,20.8
    33,26.0,21.2
    33,26.5,21.7
    33,27.0,22.1
    33,27.5,22.6
    33,28.0,23.0
    33,28.5,23.5
    33,29.0,24.0
    33,29.5,24.4
    33,30.0,24.9
    33,30.5,25.4
    33,31.0,25.8
    33,31.5,26.3
    33,32.0,26.8
    33,32.5,27.3
    33,33.0,27.8
    33,33.5,28.3
    33,34.0,28.7
    33,34.5,29.2
    33,35.0,29.7
    33,35.5,30.2
    33,36.0,30.7
    33,36.5,31.2
    33,37.0,31.7
    33,37.5,32.2
    33,38.0,32.7
    33,38.5,33.2
    33,39.0,33.7
    33,39.5,34.3
    33,40.0,34.8
    33,40.5,35.3
    33,41.0,35.8
    33,41.5,36.3
    33,42.0,36.8
    33,42.5,37.3
    33,43.0,37.8
    33,43.5,38.4
    33,44.0,38.9
    33,44.5,39.4
    33,45.0,39.9
    33,45.5,40.4
    33,46.0,40.9
    33,46.5,41.4
    33,47.0,42.0
    33,47.5,42.5
    33,48.0,43.0
    33,48.5,43.5
    33,49.0,44.0
    33,49.5,44.5
    33,50.0,45.1
    33,50.5,45.6
    33,51.0,46.1
    33,51.5,46.6
    33,52.0,47.1
    33,52.5,47.6
    33,53.0,48.2
    33,53.5,48.7
    33,54.0,49.2
    33,54.5,49.7
    33,55.0,50.2
    33,55.5,50.7
    33,56.0,51.3
    33,56.5,51.8
    33,57.0,52.3
    33,57.5,52.8
    33,58.0,53.3
    33,58.5,53.8
    33,59.0,54.3
    33,59.5,54.8
    33,60.0,55.4
    33,60.5,55.9
    33,61.0,56.4
    33,61.5,56.9
    33,62.0,57.4
    33,62.5,57.9
    33,63.0,58.4
    33,63.5,59.0
    33,64.0,59.5
    33,64.5,60.0
    33,65.0,60.5
    33,65.5,61.0
    33,66.0,61.5
    33,66.5,62.0
    33,67.0,62.6
    33,67.5,63.1
    33,68.0,63.6
    33,68.5,64.1
    33,69.0,64.6
    33,69.5,65.1
    33,70.0,65.6
    33,70.5,66.2
    33,71.0,66.7
    33,71.5,67.2
    33,72.0,67.7
    33,72.5,68.2
    33,73.0,68.7
    33,73.5,69.3
    33,74.0,69.8
    33,74.5,70.3
    33,75.0,70.8
    33,75.5,71.3
    33,76.0,71.8
    33,76.5,72.4
    33,77.0,72.9
    33,77.5,73.4
    33,78.0,73.9
    33,78.5,74.4
    33,79.0,75.0
    33,79.5,75.5
    33,80.0,76.0
    33,80.5,76.5
    33,81.0,77.0
    33,81.5,77.6
    33,82.0,78.1
    33,82.5,78.6
    33,83.0,79.1
    33,83.5,79.6
    33,84.0,80.2
    33,84.5,80.7
    33,85.0,81.2
    33,85.5,81.7
    33,86.0,82.3
    33,86.5,82.8
    33,87.0,83.3
    33,87.5,83.8
    33,88.0,84.4
    33,88.5,84.9
    33,89.0,85.4
    33,89.5,86.0
    33,90.0,86.5
    33,90.5,87.0
    33,91.0,87.6
    33,91.5,88.1
    33,92.0,88.7
    33,92.5,89.2
    33,93.0,89.7
    33,93.5,90.3
    33,94.0,90.8
    34,13.5,10.1
    34,14.0,10.5
    34,14.5,10.9
    34,15.0,11.4
    34,15.5,11.8
    34,16.0,12.2
    34,16.5,12.6
    34,17.0,13.1
    34,17.5,13.5
    34,18.0,13.9
    34,18.5,14.3
    34,19.0,14.8
    34,19.5,15.2
    34,20.0,15.6
    34,20.5,16.1
    34,21.0,16.5
    34,21.5,16.9
    34,22.0,17.3
    34,22.5,17.8
    34,23.0,18.2
    34,23.5,18.6
    34,24.0,19.1
    34,24.5,19.5
    34,25.0,20.0
    34,25.5,20.4
    34,26.0,20.9
    34,26.5,21.3
    34,27.0,21.8
    34,27.5,22.2
    34,28.0,22.7
    34,28.5,23.1
    34,29.0,23.6
    34,29.5,24.0
    34,30.0,24.5
    34,30.5,25.0
    34,31.0,25.5
    34,31.5,25.9
    34,32.0,26.4
    34,32.5,26.9
    34,33.0,27.4
    34,33.5,27.9
    34,34.0,28.3
    34,34.5,28.8
    34,35.0,29.3
    34,35.5,29.8
    34,36.0,30.3
    34,36.5,30.8
    34,37.0,31.3
    34,37.5,31.8
    34,38.0,32.3
    34,38.5,32.8
    34,39.0,33.3
    34,39.5,33.8
    34,40.0,34.4
    34,40.5,34.9
    34,41.0,35.4
    34,41.5,35.9
    34,42.0,36.4
    34,42.5,36.9
    34,43.0,37.4
    34,43.5,38.0
    34,44.0,38.5
    34,44.5,39.0
    34,45.0,39.5
    34,45.5,40.0
    34,46.0,40.5
    34,46.5,41.1
    34,47.0,41.6
    34,47.5,42.1
    34,48.0,42.6
    34,48.5,43.1
    34,49.0,43.6
    34,49.5,44.2
    34,50.0,44.7
    34,50.5,45.2
    34,51.0,45.7
    34,51.5,46.2
    34,52.0,46.7
    34,52.5,47.3
    34,53.0,47.8
    34,53.5,48.3
    34,54.0,48.8
    34,54.5,49.3
    34,55.0,49.8
    34,55.5,50.4
    34,56.0,50.9
    34,56.5,51.4
    34,57.0,51.9
    34,57.5,52.4
    34,58.0,52.9
    34,58.5,53.5
    34,59.0,54.0
    34,59.5,54.5
    34,60.0,55.0
    34,60.5,55.5
    34,61.0,56.0
    34,61.5,56.5
    34,62.0,57.1
    34,62.5,57.6
    34,63.0,58.1
    34,63.5,58.6
    34,64.0,59.1
    34,64.5,59.6
    34,65.0,60.1
    34,65.5,60.7
    34,66.0,61.2
    34,66.5,61.7
    34,67.0,62.2
    34,67.5,62.7
    34,68.0,63.2
    34,68.5,63.7
    34,69.0,64.3
    34,69.5,64.8
    34,70.0,65.3
    34,70.5,65.8
    34,71.0,66.3
    34,71.5,66.8
    34,72.0,67.4
    34,72.5,67.9
    34,73.0,68.4
    34,73.5,68.9
    34,74.0,69.4
    34,74.5,70.0
    34,75.0,70.5
    34,75.5,71.0
    34,76.0,71.5
    34,76.5,72.0
    34,77.0,72.6
    34,77.5,73.1
    34,78.0,73.6
    34,78.5,74.1
    34,79.0,74.6
    34,79.5,75.2
    34,80.0,75.7
    34,80.5,76.2
    34,81.0,76.7
    34,81.5,77.2
    34,82.0,77.8
    34,82.5,78.3
    34,83.0,78.8
    34,83.5,79.3
    34,84.0,79.9
    34,84.5,80.4
    34,85.0,80.9
    34,85.5,81.4
    34,86.0,82.0
    34,86.5,82.5
    34,87.0,83.0
    34,87.5,83.5
    34,88.0,84.1
    34,88.5,84.6
    34,89.0,85.1
    34,89.5,85.7
    34,90.0,86.2
    34,90.5,86.7
    34,91.0,87.3
    34,91.5,87.8
    34,92.0,88.4
    34,92.5,88.9
    34,93.0,89.5
    34,93.5,90.0
    34,94.0,90.6
    35,13.5,9.8
    35,14.0,10.2
    35,14.5,10.6
    35,15.0,11.1
    35,15.5,11.5
    35,16.0,11.9
    35,16.5,12.4
    35,17.0,12.8
    35,17.5,13.2
    35,18.0,13.6
    35,18.5,14.0
    35,19.0,14.5
    35,19.5,14.9
    35,20.0,15.3
    35,20.5,15.7
    35,21.0,16.2
    35,21.5,16.6
    35,22.0,17.0
    35,22.5,17.4
    35,23.0,17.9
    35,23.5,18.3
    35,24.0,18.7
    35,24.5,19.2
    35,25.0,19.6
    35,25.5,20.1
    35,26.0,20.5
    35,26.5,20.9
    35,27.0,21.4
    35,27.5,21.8
    35,28.0,22.3
    35,28.5,22.7
    35,29.0,23.2
    35,29.5,23.7
    35,30.0,24.1
    35,30.5,24.6
    35,31.0,25.1
    35,31.5,25.5
    35,32.0,26.0
    35,32.5,26.5
    35,33.0,27.0
    35,33.5,27.5
    35,34.0,27.9
    35,34.5,28.4
    35,35.0,28.9
    35,35.5,29.4
    35,36.0,29.9
    35,36.5,30.4
    35,37.0,30.9
    35,37.5,31.4
    35,38.0,31.9
    35,38.5,32.4
    35,39.0,32.9
    35,39.5,33.4
    35,40.0,33.9
    35,40.5,34.5
    35,41.0,35.0
    35,41.5,35.5
    35,42.0,36.0
    35,42.5,36.5
    35,43.0,37.0
    35,43.5,37.5
    35,44.0,38.1
    35,44.5,38.6
    35,45.0,39.1
    35,45.5,39.6
    35,46.0,40.1
    35,46.5,40.7
    35,47.0,41.2
    35,47.5,41.7
    35,48.0,42.2
    35,48.5,42.7
    35,49.0,43.3
    35,49.5,43.8
    35,50.0,44.3
    35,50.5,44.8
    35,51.0,45.3
    35,51.5,45.8
    35,52.0,46.4
    35,52.5,46.9
    35,53.0,47.4
    35,53.5,47.9
    35,54.0,48.4
    35,54.5,49.0
    35,55.0,49.5
    35,55.5,50.0
    35,56.0,50.5
    35,56.5,51.0
    35,57.0,51.5
    35,57.5,52.1
    35,58.0,52.6
    35,58.5,53.1
    35,59.0,53.6
    35,59.5,54.1
    35,60.0,54.6
    35,60.5,55.1
    35,61.0,55.7
    35,61.5,56.2
    35,62.0,56.7
    35,62.5,57.2
    35,63.0,57.7
    35,63.5,58.2
    35,64.0,58.8
    35,64.5,59.3
    35,65.0,59.8
    35,65.5,60.3
    35,66.0,60.8
    35,66.5,61.3
    35,67.0,61.8
    35,67.5,62.4
    35,68.0,62.9
    35,68.5,63.4
    35,69.0,63.9
    35,69.5,64.4
    35,70.0,65.0
    35,70.5,65.5
    35,71.0,66.0
    35,71.5,66.5
    35,72.0,67.0
    35,72.5,67.5
    35,73.0,68.1
    35,73.5,68.6
    35,74.0,69.1
    35,74.5,69.6
    35,75.0,70.1
    35,75.5,70.7
    35,76.0,71.2
    35,76.5,71.7
    35,77.0,72.2
    35,77.5,72.7
    35,78.0,73.3
    35,78.5,73.8
    35,79.0,74.3
    35,79.5,74.8
    35,80.0,75.4
    35,80.5,75.9
    35,81.0,76.4
    35,81.5,76.9
    35,82.0,77.4
    35,82.5,78.0
    35,83.0,78.5
    35,83.5,79.0
    35,84.0,79.5
    35,84.5,80.1
    35,85.0,80.6
    35,85.5,81.1
    35,86.0,81.7
    35,86.5,82.2
    35,87.0,82.7
    35,87.5,83.2
    35,88.0,83.8
    35,88.5,84.3
    35,89.0,84.8
    35,89.5,85.4
    35,90.0,85.9
    35,90.5,86.5
    35,91.0,87.0
    35,91.5,87.6
    35,92.0,88.1
    35,92.5,88.7
    35,93.0,89.2
    35,93.5,89.8
    35,94.0,90.3
    `;





            // üî¢ Rechnungsnummern-Z√§hler pro Jahr ‚Äì einmalig initialisieren
            const currentYear = new Date().getFullYear();
            const invoiceCounterKey = "invoiceCounter_" + currentYear;

            if (!localStorage.getItem(invoiceCounterKey)) {
                localStorage.setItem(invoiceCounterKey, "1");
            }



        </script>

        <script>
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // üîπ CSV-Parser
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function parseOIML(csv) {
                return csv.trim().split("\n").slice(1).map(r => {
                    const [t, v, d] = r.split(",");
                    return { t: +t, v: +v, d: +d };
                });
            }



            let table = parseOIML(oimlCSV);
        </script>


        <!-- === Modal f√ºr Beh√§lterauswahl === -->
        <div id="storageSelectModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:2000;">
            <div style="background:white; padding:20px; border-radius:8px; width:350px; max-height:80%; overflow:auto;">
                <h3>Beh√§lter ausw√§hlen</h3>
                <div id="storageSelectList"></div>
                <button onclick="closeStorageSelectModal()" style="margin-top:10px;">Abbrechen</button>
            </div>
        </div>

        <script>
            /*document.querySelectorAll("input, select, textarea").forEach(el => {
                el.addEventListener("focus", () => {
                    setTimeout(() => {
                        el.scrollIntoView({ behavior: "smooth", block: "center" });
                    }, 300);
                });
            });*/
        </script>




        <script src="jspdf.umd.min.js"></script>
        <script src="invoicePdf.js"></script>


        <script>
            function findStorageCheckBox() {
                const ids = [
                    'barrelStorageCheckBox',
                    'batchStorageCheckBox',
                    'storageCheckBox',
                    'storageAromaCheckBox'
                ];

                for (const id of ids) {
                    const el = document.getElementById(id);

                    // ‚úî existiert
                    // ‚úî ist sichtbar (offsetParent != null)
                    if (el && el.offsetParent !== null) {
                        return el;
                    }
                }

                return null;
            }


            function showStorageCheckBox(containerId) {

                const box =
                    document.querySelector(`#${containerId} #storageCheckBox`) ||
                    document.querySelector(`#${containerId} #barrelStorageCheckBox`) ||
                    document.querySelector(`#${containerId} #batchStorageCheckBox`) ||
                    document.querySelector(`#${containerId} #storageAromaCheckBox`);

                if (!box) return;

                const key = box.id + "_done";

                if (sessionStorage.getItem(key) === "1") return;

                box.style.display = "block";
            }


            function confirmStorageCheck(ok) {

                const box = findStorageCheckBox();
                if (!box) return;

                const key = box.id + '_done';

                if (ok) {
                    sessionStorage.setItem(key, '1');
                    box.style.display = 'none';
                    return;
                }

                sessionStorage.setItem(key, '1');

                // Deine Navigation:
                showPage('storage');
            }

        </script>
</body>

</html>
